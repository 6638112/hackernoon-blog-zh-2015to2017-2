<html>
<head>
<title>Preventing race conditions in Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">防止Docker中的竞争情况</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/preventing-race-conditions-in-docker-781854121ed3?source=collection_archive---------9-----------------------#2017-10-22">https://medium.com/hackernoon/preventing-race-conditions-in-docker-781854121ed3?source=collection_archive---------9-----------------------#2017-10-22</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/556298c3201dd7cf1afa6af97331cfc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*c3royGmZIGvMcbMx-8us6A.jpeg"/></div></figure><p id="739c" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">用<strong class="ja hv">Compose</strong>&amp;<strong class="ja hv">Docker</strong>很容易得到竞态条件。举个例子，如果你有一个通用的模式，当你的应用服务器依赖于数据库时，但是由于数据库服务器没有时间配置它自己，而应用程序已经启动了，它就不能连接它。</p><p id="7b0d" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">带有<strong class="ja hv">NodeJS</strong>app&amp;T13】MySQL的竞争条件示例:</p><figure class="jw jx jy jz fq iv"><div class="bz el l di"><div class="ka kb l"/></div></figure><p id="f78f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">为了构建应用程序容器，我使用了下面的<strong class="ja hv"> Dockerfile </strong>:</p><figure class="jw jx jy jz fq iv"><div class="bz el l di"><div class="ka kb l"/></div></figure><p id="cc3a" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">为了部署堆栈，我使用了<strong class="ja hv"> docker-compose </strong></p><figure class="jw jx jy jz fq iv"><div class="bz el l di"><div class="ka kb l"/></div></figure><p id="1b7b" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">让我们构建图像:</p><blockquote class="kc kd ke"><p id="0fe7" class="iy iz kf ja b jb jc jd je jf jg jh ji kg jk jl jm kh jo jp jq ki js jt ju jv hn dt translated">docker-撰写构建</p></blockquote><figure class="jw jx jy jz fq iv fe ff paragraph-image"><div class="fe ff kj"><img src="../Images/5ddc83292a78c1ec28626ff7a7bed67a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/0*_IN-8b8mG88xuQR_."/></div></figure><p id="4b85" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">然后，创建容器:</p><blockquote class="kc kd ke"><p id="d2ee" class="iy iz kf ja b jb jc jd je jf jg jh ji kg jk jl jm kh jo jp jq ki js jt ju jv hn dt translated">docker-撰写向上-d</p></blockquote><figure class="jw jx jy jz fq iv fe ff paragraph-image"><div class="fe ff kk"><img src="../Images/1083de61d3eeae44f2921a014430adf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:704/0*x9J6WCvfP99obrAL."/></div></figure><p id="0d5a" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">让我们看看状态:</p><blockquote class="kc kd ke"><p id="2743" class="iy iz kf ja b jb jc jd je jf jg jh ji kg jk jl jm kh jo jp jq ki js jt ju jv hn dt translated">docker-撰写ps</p></blockquote><figure class="jw jx jy jz fq iv fe ff paragraph-image"><div class="fe ff kl"><img src="../Images/25936141181982ed2d8980667e9cb171.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*btsQqbm0BVt6gqz9."/></div></figure><p id="5c44" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">应用程序无法启动，让我们看看为什么？</p><blockquote class="kc kd ke"><p id="9ecf" class="iy iz kf ja b jb jc jd je jf jg jh ji kg jk jl jm kh jo jp jq ki js jt ju jv hn dt translated">docker-撰写日志-关闭应用程序</p></blockquote><figure class="jw jx jy jz fq iv fe ff paragraph-image"><div class="fe ff kl"><img src="../Images/71365cadc98a019e2739cc8a5a0ccc7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*S_bRNGqRVCKtyOdN."/></div></figure><p id="d42e" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv">竞况！</strong>应用程序容器出现在数据库之前，并试图连接到<strong class="ja hv"> MySQL </strong>数据库，但由于数据库连接错误而失败。为了避免这种情况，有许多解决方案:</p><ul class=""><li id="3b20" class="km kn hu ja b jb jc jf jg jj ko jn kp jr kq jv kr ks kt ku dt translated">在代码中添加一种机制，在开始连接数据库之前等待数据库启动和设置</li><li id="8027" class="km kn hu ja b jb kv jf kw jj kx jn ky jr kz jv kr ks kt ku dt translated">使用<em class="kf">重启</em>策略— <a class="ae la" href="https://docs.docker.com/engine/admin/start-containers-automatically/" rel="noopener ugc nofollow" target="_blank"> Docker文档</a></li><li id="818d" class="km kn hu ja b jb kv jf kw jj kx jn ky jr kz jv kr ks kt ku dt translated">握住容器，直到数据库启动并运行</li></ul><p id="6057" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我将使用第三个解决方案，一个名为<a class="ae la" href="https://github.com/jwilder/dockerize" rel="noopener ugc nofollow" target="_blank"> Dockerize </a>的开源工具，这个工具的优点是它可以非常快速地查看套接字的打开情况，直到它打开，然后启动web应用程序。</p><p id="4fad" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">注意:Dockerize使您能够等待特定协议上的服务(<code class="eh lb lc ld le b">file</code>、<code class="eh lb lc ld le b">tcp</code>、<code class="eh lb lc ld le b">tcp4</code>、<code class="eh lb lc ld le b">tcp6</code>、<code class="eh lb lc ld le b">http</code>、<code class="eh lb lc ld le b">https</code>和<code class="eh lb lc ld le b">unix</code>)</p><p id="21db" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">所以只需更新<strong class="ja hv"> Dockerfile </strong>来安装<strong class="ja hv"> Dockerize </strong>:</p><figure class="jw jx jy jz fq iv"><div class="bz el l di"><div class="ka kb l"/></div></figure><p id="3f97" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">然后，构建新的映像:</p><figure class="jw jx jy jz fq iv fe ff paragraph-image"><div class="fe ff kl"><img src="../Images/78fcab7cf012e05ba22917e23ec42bc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*TwOeaesk-7W0gkgw."/></div></figure><blockquote class="kc kd ke"><p id="e574" class="iy iz kf ja b jb jc jd je jf jg jh ji kg jk jl jm kh jo jp jq ki js jt ju jv hn dt translated">docker-撰写向上-d</p><p id="577c" class="iy iz kf ja b jb jc jd je jf jg jh ji kg jk jl jm kh jo jp jq ki js jt ju jv hn dt translated">docker-撰写ps</p></blockquote><figure class="jw jx jy jz fq iv fe ff paragraph-image"><div class="fe ff kl"><img src="../Images/2fbefce55e335d14595f7b036965d92e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*MfYUEQIsEjzqbPAs."/></div></figure><blockquote class="kc kd ke"><p id="a109" class="iy iz kf ja b jb jc jd je jf jg jh ji kg jk jl jm kh jo jp jq ki js jt ju jv hn dt translated">docker-撰写日志-关闭应用程序</p></blockquote><figure class="jw jx jy jz fq iv fe ff paragraph-image"><div class="fe ff kl"><img src="../Images/18a5aad72612e5eaabe27c374d2ec66b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*D-xgN2gWsN1EH3fX."/></div></figure><p id="f172" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">它在❤工作</p></div></div>    
</body>
</html>