<html>
<head>
<title>How to create an interactive vote swing viewer in D3 (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在D3中创建交互式投票摇摆查看器(第2部分)</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-create-an-interactive-vote-swing-viewer-in-d3-part-2-fd6ac625930a?source=collection_archive---------11-----------------------#2017-05-23">https://medium.com/hackernoon/how-to-create-an-interactive-vote-swing-viewer-in-d3-part-2-fd6ac625930a?source=collection_archive---------11-----------------------#2017-05-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/8b343b12c1b0819782d7f30ed2a36657.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QKtdv7V-afGoB8Ol3m2lqg.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">My interactive party swing tool, now with added hex map</figcaption></figure><p id="7dbd" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在我之前的<a class="ae ke" rel="noopener" href="/@puntofisso/how-to-create-an-interactive-vote-swing-viewer-in-d3-a6bbd4c96b6f">帖子</a>中，我讲述了如何使用D3为即将到来的大选创建一个工党/保守党摇摆观众。这是一个相当简单的，不是特别高性能的，但有用的工具，可以很容易地重新适应任何其他有意义的两党摇摆的选举。</p><p id="d63a" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我的“开放数据兄弟”杰米·威特拿起它，用它创建了一个非常好的地图可视化——将挥杆从2轴堆叠视图移动到地理视图。去<a class="ae ke" href="http://propolis.io/dataviz/swingmap/swingmap.htm" rel="noopener ugc nofollow" target="_blank">的网站</a>看看杰米的互动地图。我花了一些时间玩杰米的地图，因为它真的很好。但是每一个地理可视化都伴随着一个问题:它夸大了低人口地区的影响。</p><p id="3271" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">有很多方法可以解决这个问题，幸运的是，英国开放数据社区的另一个中坚力量——利兹的ODI node提供了一个方法。他们开发了<a class="ae ke" href="https://odileeds.org/blog/2017-05-08-mapping-election-with-hexes" rel="noopener ugc nofollow" target="_blank">一个开发六边形地图</a>的简单标准，这是一种可视化网格的方式，节点可以比正方形或长方形更自由地放置。十六进制地图是一个非常强大的工具，它允许笛卡尔网格的简单性，同时以类似于地理的方式放置信息。</p><p id="6f4c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">感谢Oli Hawkins开发的<a class="ae ke" href="https://github.com/olihawkins/d3-hexjson" rel="noopener ugc nofollow" target="_blank"> d3-hexjson库</a>，十六进制地图很容易与d3一起使用。这是最终的结果，以及我是如何做到的:</p><figure class="kg kh ki kj fq iv fe ff paragraph-image"><div class="fe ff kf"><img src="../Images/011565d64dc123c8bbce4e6ec349b11c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*3WgOOdzahiycNAGaW3uCMA.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">650 constituencies in a hex map</figcaption></figure><h1 id="0cde" class="kk kl hu bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">十六进制地图是如何工作的</h1><p id="7a49" class="pw-post-body-paragraph jg jh hu ji b jj li jl jm jn lj jp jq jr lk jt ju jv ll jx jy jz lm kb kc kd hn dt translated">十六进制映射基本上是一种标准，它以指定的方式将数据放在JSON文件中。您可以指定节点，给它们一个名称、一些属性，并将它们放在网格上。完整的解释可以在<a class="ae ke" href="https://odileeds.org/projects/hexmaps/hexjson.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到。对于这篇文章，只要说我使用了ODI Leeds制作的<a class="ae ke" href="https://github.com/odileeds/hexmaps/blob/gh-pages/maps/constituencies.hexjson" rel="noopener ugc nofollow" target="_blank">选区十六进制地图</a>就足够了，看起来像这样:</p><pre class="kg kh ki kj fq ln lo lp lq aw lr dt"><span id="3aa6" class="ls kl hu lo b fv lt lu l lv lw">...</span><span id="6c86" class="ls kl hu lo b fv lx lu l lv lw">"E14000530":{"n":"Aldershot","q":-3,"r":-11,"a":"SE","u":"UKJ","p":72430}, </span><span id="8942" class="ls kl hu lo b fv lx lu l lv lw">"E14000531":{"n":"Aldridge-Brownhills","q":-3,"r":-1,"a":"WM","u":"UKG","p":60215}, </span><span id="0f10" class="ls kl hu lo b fv lx lu l lv lw">"E14000532":{"n":"Altrincham and Sale West","q":-7,"r":3,"a":"NW","u":"UKD","p":71511},  </span><span id="1db4" class="ls kl hu lo b fv lx lu l lv lw">"E14000533":{"n":"Amber Valley","q":0,"r":2,"a":"EM","u":"UKF","p":69510},  </span><span id="c3ed" class="ls kl hu lo b fv lx lu l lv lw">"E14000534":{"n":"Arundel and South Downs","q":0,"r":-15,"a":"SE","u":"UKJ","p":77242},<br/>...</span></pre><p id="187d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">基本上，每个constituent都是一个JSON对象，由constituency ID标识，其属性类似于对象中的名称。</p><h1 id="899e" class="kk kl hu bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">我的数据需要一些审查</h1><p id="302a" class="pw-post-body-paragraph jg jh hu ji b jj li jl jm jn lj jp jq jr lk jt ju jv ll jx jy jz lm kb kc kd hn dt translated">如果你看了我之前的帖子，你会发现JSON摘录的选区数据是这样的:</p><pre class="kg kh ki kj fq ln lo lp lq aw lr dt"><span id="7ace" class="ls kl hu lo b fv lt lu l lv lw">,<br/>{<br/>      "name": "Morley and Outwood",<br/>      "majority": "0.87",<br/>      "winner": "Conservative"<br/>},<br/>{<br/>      "name": "Halifax",<br/>      "majority": "0.98",<br/>      "winner": "Labour"<br/>},</span></pre><p id="5f04" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在这样的数据中，有一个潜在的问题:如果我们想要将我的数据链接到上面的constituencies JSON，我们需要依赖于选区名称实际上是相同的。但是使用名字并不是一个明智的做法，所以我决定再次从BES电子表格中提取并包含社群ID。上一篇博文解释了如何做到这一点，最终结果是这样的:</p><pre class="kg kh ki kj fq ln lo lp lq aw lr dt"><span id="c97f" class="ls kl hu lo b fv lt lu l lv lw">...,<br/>{<br/>      "name": "Morley and Outwood",<br/>      "id": "E14000826",<br/>      "majority": "0.87",<br/>      "winner": "Conservative"<br/>},<br/>{<br/>      "name": "Halifax",<br/>      "id": "E14000723",<br/>      "majority": "0.98",<br/>      "winner": "Labour"<br/>},<br/>{<br/>      "name": "Wirral West",<br/>      "id": "E14001044",<br/>      "majority": "1",<br/>      "winner": "Labour"<br/>},<br/>...</span></pre><h1 id="e46d" class="kk kl hu bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">一个简单的逻辑演练</h1><p id="396c" class="pw-post-body-paragraph jg jh hu ji b jj li jl jm jn lj jp jq jr lk jt ju jv ll jx jy jz lm kb kc kd hn dt translated">如果我们需要绘制成千上万个节点，那么保持这种极其幼稚的逻辑是行不通的。由于懒惰并且必须处理少于650个节点，我会让事情变得非常简单。简而言之:</p><ol class=""><li id="3667" class="ly lz hu ji b jj jk jn jo jr ma jv mb jz mc kd md me mf mg dt translated">在每次调用paint _ constituencies()时，我将在应用swing后存储一个包含选区节点所有颜色的对象—因此工党持有的是浅红色，保守党持有的是淡蓝色，而gains分别是深红色和深蓝色</li><li id="34e5" class="ly lz hu ji b jj mh jn mi jr mj jv mk jz ml kd md me mf mg dt translated">我将把这个对象传递给一个绘制十六进制地图的函数，并通过选区ID查询这个对象，获得决定颜色的选区状态。</li></ol><p id="edd1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">就是这样，简单、快速(而且非常低效——但我们可能会在以后的博客文章中讨论这个问题)。</p><h1 id="bf76" class="kk kl hu bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">在我们开始之前，让我们调整html</h1><p id="7c59" class="pw-post-body-paragraph jg jh hu ji b jj li jl jm jn lj jp jq jr lk jt ju jv ll jx jy jz lm kb kc kd hn dt translated">尽管样式超出了本文的范围，但我还是要补充一点，我希望十六进制地图就在swing查看器的右边，所以我将包含两个小部件的两个div放在一行中，并使用Bootstrap的类来确保它们或多或少对齐:</p><pre class="kg kh ki kj fq ln lo lp lq aw lr dt"><span id="ec7d" class="ls kl hu lo b fv lt lu l lv lw">&lt;div class="row"&gt;<br/> &lt;div class="col-md-8" id="graph"&gt;&lt;/div&gt;<br/> &lt;div class="col-md-4" id="vis"&gt;&lt;/div&gt;<br/>&lt;/div&gt;</span></pre><p id="bd22" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">剩下的就很容易了。</p><h1 id="bcf6" class="kk kl hu bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">创建“赢家”对象</h1><p id="7a90" class="pw-post-body-paragraph jg jh hu ji b jj li jl jm jn lj jp jq jr lk jt ju jv ll jx jy jz lm kb kc kd hn dt translated">你还记得我们有一个函数叫做paint _ constituencies()？该函数为原始swing查看器中的节点分配颜色。除了我们希望将每个选区的状态存储在一个数组中之外，逻辑基本相同。我们不存储颜色，而是存储结果，作为这些值中的一个:LAB，CON，LABhold，CONhold。</p><p id="91d0" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在函数的开始定义一个对象</p><pre class="kg kh ki kj fq ln lo lp lq aw lr dt"><span id="db82" class="ls kl hu lo b fv lt lu l lv lw">var winners_object = {};</span></pre><p id="393c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然后，让我们修改设置颜色填充的功能。你会记得这个函数基本上检查了挥杆的状态，并在评估状态为保持或增益后给节点分配了一种颜色。我们所需要做的就是把这个推理加入到我们上面的对象中:</p><pre class="kg kh ki kj fq ln lo lp lq aw lr dt"><span id="8178" class="ls kl hu lo b fv lt lu l lv lw">rectangles.style(“fill”, function(d) {<br/> var returnColor;<br/><strong class="lo hv"> var cid = d['id'];</strong><br/> if (d['winner'] === "Labour")<br/> {<br/>  if (swing*2 &gt; +d['majority']) {<br/>  seats_gained++;<br/>  returnColor = "#0000ff";<br/><strong class="lo hv">  winners_object[cid] = "CON";</strong><br/>  } else {<br/>  returnColor = "#f08080";<br/><strong class="lo hv">  winners_object[cid] = "LABhold";</strong><br/>  }<br/> } else if (d['winner'] === "Conservative")<br/> {<br/> if (-swing*2 &gt; +d['majority']) {<br/>  seats_gained++;<br/>  returnColor = "#ff0000";<br/><strong class="lo hv">  winners_object[cid] = "LAB";</strong><br/>  } else {<br/>  returnColor = "#87cefa";<br/><strong class="lo hv">  winners_object[cid] = "CONhold";</strong><br/> }<br/>}</span></pre><p id="d4bd" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我用粗体突出显示了添加的行。如您所见，逻辑没有改变，我们使用选区ID (cid)作为索引。</p><p id="e437" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如前所述，我们将这个对象传递给一个绘制十六进制地图的函数。让我们给它一个名字，在下一节我们将看到它是如何工作的。在paint _ constituencies()的最后添加这一行:</p><pre class="kg kh ki kj fq ln lo lp lq aw lr dt"><span id="3294" class="ls kl hu lo b fv lt lu l lv lw">do_hex(winners_object);</span></pre><h1 id="8cce" class="kk kl hu bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">绘制十六进制地图</h1><p id="1907" class="pw-post-body-paragraph jg jh hu ji b jj li jl jm jn lj jp jq jr lk jt ju jv ll jx jy jz lm kb kc kd hn dt translated">实际的十六进制地图绘制是由奥利的地图非常简单。我们所做的就是加载constituencies JSON，并设置每个元素。这与我们之前设置矩形的属性非常相似:内嵌函数允许您一次性直接处理六边形，就像您正在枚举它们一样。</p><p id="8729" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们的do_hex()函数的基本形状如下:</p><pre class="kg kh ki kj fq ln lo lp lq aw lr dt"><span id="2a87" class="ls kl hu lo b fv lt lu l lv lw">d3.select("#vis").selectAll("*").remove();<br/>d3.json("maps/constituencies.hexjson", function(error, hexjson) {<br/>  // do something<br/>}</span></pre><p id="7cc0" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">正如我们之前所做的，我们调用remove()，因为我们每次移动滑块都要从头开始重画十六进制地图。d3.json块的内容基本上允许我们将json作为一个对象来操作。我们需要做的第一件事是实例化svg元素。为此，我们还可以添加一些额外的配置属性，例如向svg地图添加边距，但是为了简单起见，我们做了四件事:</p><ol class=""><li id="a141" class="ly lz hu ji b jj jk jn jo jr ma jv mb jz mc kd md me mf mg dt translated">添加svg块</li><li id="e3cc" class="ly lz hu ji b jj mh jn mi jr mj jv mk jz ml kd md me mf mg dt translated">使用Oli的库渲染六边形</li><li id="23e1" class="ly lz hu ji b jj mh jn mi jr mj jv mk jz ml kd md me mf mg dt translated">将我们的数据绑定到六边形</li><li id="0bfb" class="ly lz hu ji b jj mh jn mi jr mj jv mk jz ml kd md me mf mg dt translated">设计六边形。</li></ol><p id="e304" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">让我们一次看一个步骤。首先，正如我们在上一篇文章中看到的，添加svg块是一个简单的操作:</p><pre class="kg kh ki kj fq ln lo lp lq aw lr dt"><span id="988f" class="ls kl hu lo b fv lt lu l lv lw">var svg = d3<br/> .select("#vis")<br/> .append("svg")<br/> .append("g");</span></pre><p id="d1a2" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这里我们还添加了一个“g”元素，因为我们将对子元素进行分组。我建议您在调用该函数后，查看开发人员工具中的elements视图。</p><p id="f0cb" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">其次，渲染是一行代码:</p><pre class="kg kh ki kj fq ln lo lp lq aw lr dt"><span id="96da" class="ls kl hu lo b fv lt lu l lv lw">var hexes = d3.renderHexJSON(hexjson, width, height);</span></pre><p id="4c20" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这给了我们一个变量中的六进制数，我们现在可以将它传递给绑定函数:</p><pre class="kg kh ki kj fq ln lo lp lq aw lr dt"><span id="1a3c" class="ls kl hu lo b fv lt lu l lv lw">var hexmap = svg<br/>      .selectAll("g")<br/>      .data(hexes)<br/>      .enter()<br/>      .append("g")<br/>      .attr("transform", function(hex) {<br/>        return "translate(" + hex.x + "," + hex.y + ")";<br/>      });</span></pre><p id="6612" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">为了保持整洁，您可以删除对。attr() —我经常把所有的样式放在一起，所有的结构放在一起，等等。接下来，我们需要样式六边形，所以我们可以使用hexmap变量，做一个基于函数的样式，就像我们对矩形做的那样:</p><pre class="kg kh ki kj fq ln lo lp lq aw lr dt"><span id="f7c6" class="ls kl hu lo b fv lt lu l lv lw">hexmap<br/> .append("polygon")<br/> .attr("points", function(hex) {return hex.points;})<br/> .attr("stroke", "white")<br/> .attr("stroke-width", "2")<br/> .attr("fill", function(hex) {<br/>   var party = winners[hex.key];<br/>   var colour = "#000000";<br/>   if (party === "LAB")<br/>     colour = "#ff0000";<br/>   else if (party === "CON")<br/>     colour = "#0000ff";<br/>   else if (party === "LABhold")<br/>     colour = "#f08080"<br/>   else if (party === "CONhold")<br/>     colour = "#87cefa";<br/>   return colour;<br/> });</span></pre><p id="acb8" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这里重要的一点是看我们如何识别一个六边形:我们使用hex.key，它是我们上面设置的对象的键；在这种情况下，关键是选区ID。我们使用ID来查询winners对象，并获取该选区的状态，然后用它来设置颜色。</p><h1 id="7503" class="kk kl hu bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">搞定了！</h1><p id="83ba" class="pw-post-body-paragraph jg jh hu ji b jj li jl jm jn lj jp jq jr lk jt ju jv ll jx jy jz lm kb kc kd hn dt translated">接下来呢？嗯，正如我所说的，这不是特别有效。我们实际上不需要遍历这两个数组，因为我们可以合并它们；此外，我们可以找到一种方法来避免每次都重新绘制地图和swing viewer。敬请期待；-)</p><div class="kg kh ki kj fq ab cb"><figure class="mm iv mn mo mp mq mr paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mm iv mn mo mp mq mr paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mm iv mn mo mp mq mr paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="ms mt mu"><p id="f922" class="jg jh mv ji b jj jk jl jm jn jo jp jq mw js jt ju mx jw jx jy my ka kb kc kd hn dt translated"><a class="ae ke" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ke" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ke" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae ke" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jg jh mv ji b jj jk jl jm jn jo jp jq mw js jt ju mx jw jx jy my ka kb kc kd hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ke" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ke" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kg kh ki kj fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mz"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>