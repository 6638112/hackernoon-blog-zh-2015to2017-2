# 远程 DOM 又名虚拟虚拟 DOM

> 原文：<https://medium.com/hackernoon/remote-dom-aka-virtual-virtual-dom-479c6d88de54>

浏览器中的信任是一件要么全有要么全无的事情，你要么在主 UI 线程上的主文档中运行一段 JavaScript，访问 DOM 的每个全局或任何部分，要么在一个隔离的环境中运行它要么在 iframe 中被限制在一个小矩形框中，要么在 WebWorker 中根本不能直接影响 UI。

我想要更多，使用多个 iframes 会使网站变慢，它迫使浏览器多次解析/编译/评估相同的 JavaScript 源，并使你的 UI 包含在这些小盒子里…

我希望能够编写 React 组件，运行它们而不必信任它们的代码，并让它们绘制到同一个 DOM。我找到了一个不错的开源库 [react-worker-dom](https://github.com/web-perf/react-worker-dom) ，并开始对它进行修补。

React-Worker-DOM 是对 React 的一个重大修改，由两个互补的部分组成。一个是您实际的 React 代码所在的位置，在这里，应该接触 DOM 的每一行都被修改了，因此它最终会将来自 WebWorker 的消息发送回主框架。另一半，解释这些消息，将它们应用到 DOM &监听事件，以相反的方向将它们发送回来。

该项目的重点是通过 WebWorker 在不同的线程中运行大部分代码的性能优势，它工作得非常好。虽然它不支持我需要的一些功能，如可插拔传输层和多租户，但这些功能相对容易添加，我甚至努力将代码移植到较新的 React 0.14，以了解跟上较新的 React 版本有多难。

我几乎可以说服自己这个解决方案已经足够好了，但是当一个朋友真的问我它是否足够好到可以用在生产中时，我犹豫了，它很复杂，修复其中的 bug 很困难，要把它移植到 React a mornight 的新版本中。我知道使用它意味着让自己不断努力去维护一些不可维护的东西…

很久以前我就发现，当事情变得困难时，通常意味着我做错了。必须有一种更理智的方式来获得我们需要的利益，而不要不断地耗费我的时间和快乐。很多软件工程都是关于学习在不同的拼图块之间画出边界线，手头的任务有什么独特之处，什么应该被重用，什么应该被抛弃。

我走了很长一段路，试图找到解决问题的替代方法，然后我突然想到了这个问题。我需要一些对聚合填充或修补更稳定的东西，而 React 是一个移动太快的目标，我必须从等式中删除 React。只留下浏览器 DOM API 本身，React 几乎只写 DOM 而不做任何读取，我所要做的就是提供一个 facade，提供 React 期望的一小组浏览器 API，我可以获得所有的好处，而无需修改 React 的一行代码，因此 [Remote-DOM](https://github.com/wix/remote-dom) 诞生了。

Remote-DOM 是一个很小的库，只有不到 1k 行代码，分为远程和本地两部分。远程部分向其他库提供浏览器外观、虚拟窗口和文档，让它们使用它们知道并期望浏览器提供的 API，如 document . createelement window . addevent listener 等，而没有任何实际的 DOM，并将这些命令作为 JSONs 发送回本地部分。库的本地部分解释 JSON，并真正创建 DOM 节点和添加事件侦听器，当事件发生时，它会将其信息作为 JSON 发送回远程端，要连接它们，您需要做的只是为它们提供一种相互通信的方法。

这种方法的一个显著限制是，因为通信总线是异步的，所以有些事情不能透明地完成，不能读取 DOM 节点的 offsetHeight 并期望它的值在那里，也不能在事件循环中响应事件，为了减轻这一点，我添加了一个新的本地调用概念，这是一个在库的本地 DOM 端定义的动词小字典，可以从远程端调用。例如，这允许您在移动 safari 中点击播放视频，而浏览器不会播放视频，除非它在事件循环中被触发。

那么你能用它做什么呢？通过从主 UI 线程中移除 React 来获得性能，构建真正分布式的广告网络，除了远程 dom 库之外，不需要在浏览器中运行任何代码，因此可以流畅地连接到许多广告提供商， 或者可能只是可能创造 React 的下一个进化步骤——使用 React 的服务器端渲染是很棒的，但是在 HTML 加载和所有客户端代码完全准备好之间的时间里，你有一个不响应用户事件的静态网站，如果我们改变它，使服务器使用 remote-dom 渲染并继续处理用户交互直到客户端准备好，这时客户端将获得 redux 存储的快照并切换到处理事件本身……但这是另一篇文章的故事； )

不管怎样，它已经发布了，而且是开源的(感谢 [Wix](https://github.com/wix) )，玩得开心。

> [黑客中午](http://bit.ly/Hackernoon)是黑客如何开始他们的下午。我们是 [@AMI](http://bit.ly/atAMIatAMI) 家庭的一员。我们现在[接受投稿](http://bit.ly/hackernoonsubmission)，并乐意[讨论广告&赞助](mailto:partners@amipublications.com)机会。
> 
> 要了解更多信息，请[阅读我们的“关于”页面](https://goo.gl/4ofytp)、[在脸书上点赞/给我们发消息](http://bit.ly/HackernoonFB)，或者简单地说， [tweet/DM @HackerNoon。](https://goo.gl/k7XYbx)
> 
> 如果你喜欢这个故事，我们推荐你阅读我们的[最新科技故事](http://bit.ly/hackernoonlatestt)和[趋势科技故事](https://hackernoon.com/trending)。直到下一次，不要把世界的现实想当然！