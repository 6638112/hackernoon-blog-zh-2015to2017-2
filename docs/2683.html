<html>
<head>
<title>How Elm Ports Work, With a Picture (just one)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Elm端口如何工作，附图片(仅一张)</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-elm-ports-work-with-a-picture-just-one-25144ba43cdd?source=collection_archive---------0-----------------------#2017-02-11">https://medium.com/hackernoon/how-elm-ports-work-with-a-picture-just-one-25144ba43cdd?source=collection_archive---------0-----------------------#2017-02-11</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="83b5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://hackernoon.com/tagged/elm" rel="noopener ugc nofollow" target="_blank"> Elm </a> ports是与<a class="ae jp" href="https://hackernoon.com/tagged/javascript" rel="noopener ugc nofollow" target="_blank"> JavaScript </a>交互的主要方式之一。然而，我觉得我需要告诉你，如果你可以逃脱，你应该只使用旗帜。标志传递一些初始值给Elm，这无疑是最简单的方法。然而，如果你想要更多的来回通信端口的方式。</p><h1 id="552a" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">高级概述</h1><p id="6965" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">首先，这是图片:</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff kt"><img src="../Images/937518a1fd602fbc687e5ef84d38e272.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4QNG3QrtceCWlEtqO1nneQ.png"/></div></div></figure><p id="b4e9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">端口基本上是发布-订阅模式(也称为观察者模式)。<strong class="it hv">端口是Elm和JavaScript </strong>之间的连接管道。</p><p id="5995" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每个端口只有一个方向。不是Elm -&gt;JavaScript就是JavaScript -&gt; Elm。所以自然地，如果你想要双向交流，你只需要做两个。</p><h1 id="4d34" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated"><strong class="ak">制作端口</strong></h1><h2 id="edb0" class="lf jr hu bd js lg lh li jw lj lk ll ka jc lm ln ke jg lo lp ki jk lq lr km ls dt translated">一些设置</h2><p id="3d40" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">如果你打算继续做下去，请遵循这些步骤(或者也许<a class="ae jp" href="https://github.com/justgage/complete-elm-port-example" rel="noopener ugc nofollow" target="_blank">只要看看代码</a>)</p><p id="babd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">步骤1: </strong>用完整的<code class="eh lt lu lv lw b">Html.program</code>建立一个<code class="eh lt lu lv lw b">Main.elm</code>文件</p><p id="528c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">第二步:一个<code class="eh lt lu lv lw b">.js</code>文件，暂时可以为空</p><p id="c161" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">第三步:</strong>一个<code class="eh lt lu lv lw b">index.html</code>文件，包括<code class="eh lt lu lv lw b">elm.js</code>(编译的elm文件)和<code class="eh lt lu lv lw b">whatever.js</code>文件，后者包含你想要交互的代码。</p><h2 id="65e5" class="lf jr hu bd js lg lh li jw lj lk ll ka jc lm ln ke jg lo lp ki jk lq lr km ls dt translated">从Elm到JavaScript</h2><p id="4d56" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">在模块的开头加上一个<code class="eh lt lu lv lw b">port</code>来注释模块</p><ol class=""><li id="b79a" class="lx ly hu it b iu iv iy iz jc lz jg ma jk mb jo mc md me mf dt translated">创建一个到JavaScript<em class="mg"/>的端口<em class="mg">，其类型签名如下</em></li></ol><pre class="ku kv kw kx fq mh lw mi mj aw mk dt"><span id="bf09" class="lf jr hu lw b fv ml mm l mn mo">port <strong class="lw hv">toJs</strong> : String -&gt; Cmd msg</span></pre><p id="ffd5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将<em class="mg">创建一个名为<code class="eh lt lu lv lw b">toJs</code>的函数</em>，该函数创建<code class="eh lt lu lv lw b">Cmd</code> s(命令)。如果你记得你可以在<code class="eh lt lu lv lw b">update</code>函数中返回<code class="eh lt lu lv lw b">Cmd</code>作为元组的第二部分！就这么办吧。</p><pre class="ku kv kw kx fq mh lw mi mj aw mk dt"><span id="7285" class="lf jr hu lw b fv ml mm l mn mo">update msg model =<br/>    case msg of</span><span id="4467" class="lf jr hu lw b fv mp mm l mn mo">         SendToJs str -&gt;<br/>            ( model, <strong class="lw hv">toJs</strong> <em class="mg">str</em> )</span></pre><p id="959a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将神奇地把<code class="eh lt lu lv lw b"><em class="mg">str</em></code>发送到JavaScript的土地！只对订阅它的人开放。要订阅它，您需要:</p><pre class="ku kv kw kx fq mh lw mi mj aw mk dt"><span id="8f7c" class="lf jr hu lw b fv ml mm l mn mo">var node = document.getElementById('view');<br/>var app = Elm.Main.embed(node);</span><span id="0e57" class="lf jr hu lw b fv mp mm l mn mo">// receive something from Elm<br/><strong class="lw hv">app.ports.toJs.subscribe</strong>(function (<em class="mg">str</em>) {<br/>  console.log("got from Elm:", <em class="mg">str</em>);<br/>});</span></pre><h2 id="f1ff" class="lf jr hu bd js lg lh li jw lj lk ll ka jc lm ln ke jg lo lp ki jk lq lr km ls dt translated">从JavaScript到Elm</h2><p id="45b8" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">在JS土地上你<strong class="it hv"> <em class="mg">通过端口上的<code class="eh lt lu lv lw b">send</code>方法发送</em> </strong>的东西。像这样:</p><pre class="ku kv kw kx fq mh lw mi mj aw mk dt"><span id="53ef" class="lf jr hu lw b fv ml mm l mn mo">var node = document.getElementById('view');<br/>var app = Elm.Main.embed(node);<br/>app.ports.<strong class="lw hv">toElm.send</strong>("undefined is not a function");</span></pre><p id="96bb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">自然JS说是习惯用语。</p><p id="0586" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以我们定义了一个新的端口:</p><pre class="ku kv kw kx fq mh lw mi mj aw mk dt"><span id="6393" class="lf jr hu lw b fv ml mm l mn mo">port toElm : (String -&gt; msg) -&gt; Sub msg</span></pre><p id="b30d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就创建了一个函数，<em class="mg">接受一个函数</em>，这个函数可以将JS发送的字符串转换成一个<code class="eh lt lu lv lw b">Msg</code>(也可以是两者兼容的任何值)这个函数返回一个<code class="eh lt lu lv lw b">Sub</code>而不是一个<code class="eh lt lu lv lw b">Cmd</code>，所以我们需要在Elm中为<strong class="it hv">订阅</strong>:</p><pre class="ku kv kw kx fq mh lw mi mj aw mk dt"><span id="2d24" class="lf jr hu lw b fv ml mm l mn mo">subscriptions : Model -&gt; Sub Msg<br/>subscriptions model =<br/>    toElm UpdateStr</span></pre><p id="e01e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">基本上这是说:</p><blockquote class="mq mr ms"><p id="77d2" class="ir is mg it b iu iv iw ix iy iz ja jb mt jd je jf mu jh ji jj mv jl jm jn jo hn dt translated"><em class="hu">每当JS通过</em> <code class="eh lt lu lv lw b"><em class="hu">toElm</em></code> <em class="hu">端口向我发送东西时，就向</em> <code class="eh lt lu lv lw b"><em class="hu">update</em></code> <em class="hu">函数发送</em> <code class="eh lt lu lv lw b"><em class="hu">UpdateStr</em></code> <em class="hu">消息。</em></p></blockquote><p id="c5cc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们可以像处理update函数中的其他函数一样处理这个<code class="eh lt lu lv lw b">Msg</code>:</p><pre class="ku kv kw kx fq mh lw mi mj aw mk dt"><span id="ab0d" class="lf jr hu lw b fv ml mm l mn mo">update msg model =<br/>    case msg of<br/>        UpdateStr str -&gt;<br/>            ( { model | message = str }, Cmd.none )</span></pre><p id="8051" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">基本上我只是把JS给我的字符串存储到我的模型的一部分。</p><h1 id="d7e6" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated"><strong class="ak">🚨警告:运行时异常提前！<strong class="ak">🚨</strong></strong></h1><p id="13d9" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">虽然我使用了<code class="eh lt lu lv lw b">String</code>来保持简单，但这是<strong class="it hv">危险的</strong>。</p><p id="e34b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果JavaScript(以其无限的智慧)决定发送一个不是字符串的东西(比如null、undefined、NaN、rubber duck、a function等等)。)然后<strong class="it hv"> Elm将抛出一个运行时异常并停止它的运行循环</strong>。</p><p id="f4fb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这意味着Elm将不能接受任何输入或以任何方式响应。<em class="mg">死了。</em></p><p id="5ab0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使你的elm代码<em class="mg">再次防弹的方法</em>改为将端口的类型改为<code class="eh lt lu lv lw b">Value</code>。这意味着你必须写一个Json。它的解码器。这样，如果JS决定给你发送一个错误的值，它只会返回一个<code class="eh lt lu lv lw b">Err </code>而不是抛出一个异常。</p><p id="d963" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请参见此处的<a class="ae jp" href="https://github.com/justgage/complete-elm-port-example/commit/b7bdec196e20b441fd524546dc07ae51b464a3f8" rel="noopener ugc nofollow" target="_blank">差异</a></p><pre class="ku kv kw kx fq mh lw mi mj aw mk dt"><span id="ef48" class="lf jr hu lw b fv ml mm l mn mo">import Json.Encode exposing (Value)<br/>import Json.Decode as Decode</span><span id="1e48" class="lf jr hu lw b fv mp mm l mn mo">-- Farther down in the file.... --</span><span id="eba7" class="lf jr hu lw b fv mp mm l mn mo">port toElm : (<strong class="lw hv">Value</strong> -&gt; msg) -&gt; Sub msg</span><span id="da4a" class="lf jr hu lw b fv mp mm l mn mo">-- SUBSCRIPTIONS</span><span id="c1ed" class="lf jr hu lw b fv mp mm l mn mo">subscriptions : Model -&gt; Sub Msg<br/>subscriptions model =<br/>    toElm (<strong class="lw hv">decodeValue</strong>)</span><span id="ae1d" class="lf jr hu lw b fv mp mm l mn mo">decodeValue : Value -&gt; Msg<br/>decodeValue x =<br/>    let<br/>        result =<br/>            <strong class="lw hv">Decode.decodeValue Decode.string x</strong><br/>    in<br/>        case result of<br/>            Ok string -&gt;<br/>                UpdateStr string</span><span id="71b1" class="lf jr hu lw b fv mp mm l mn mo">            Err _ -&gt; <br/>                UpdateStr "Silly JavaScript, you can't kill me!"</span></pre><h1 id="af01" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">就是这样！</h1><p id="9d03" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">图片又来了:</p><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff kt"><img src="../Images/937518a1fd602fbc687e5ef84d38e272.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4QNG3QrtceCWlEtqO1nneQ.png"/></div></div></figure><p id="5a6b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里有一个工作回购的链接:<a class="ae jp" href="https://github.com/justgage/complete-elm-port-example" rel="noopener ugc nofollow" target="_blank">https://github.com/justgage/complete-elm-port-example</a></p><div class="ku kv kw kx fq ab cb"><figure class="mw ky mx my mz na nb paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mw ky mx my mz na nb paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mw ky mx my mz na nb paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mq mr ms"><p id="f922" class="ir is mg it b iu iv iw ix iy iz ja jb mt jd je jf mu jh ji jj mv jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is mg it b iu iv iw ix iy iz ja jb mt jd je jf mu jh ji jj mv jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="ku kv kw kx fq ky fe ff paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="fe ff nc"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="ku kv kw kx fq ky"><div class="bz el l di"><div class="nd ne l"/></div></figure></div></div>    
</body>
</html>