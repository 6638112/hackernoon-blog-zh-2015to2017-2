<html>
<head>
<title>/deploy your system with Slack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">/使用Slack部署您的系统</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/deploy-your-system-with-slack-8cc1fdd2489f?source=collection_archive---------0-----------------------#2015-08-06">https://medium.com/hackernoon/deploy-your-system-with-slack-8cc1fdd2489f?source=collection_archive---------0-----------------------#2015-08-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/746dcfe31599c1186176fa1f5fe85a4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/1*dd9GjIiz9tk9V2HSpSd93g.png"/></div></figure><p id="6a24" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们在Penny 的两人团队每天部署超过五次。因为我们很小，我们缺少大多数成熟系统所拥有的安全措施，比如广泛的测试和特性分支。事实上，我们直接向master提交，并使用CI对master运行我们的一些端到端测试。我们的目标不是捕捉所有的bug或者测试我们所有的代码，而是用最少的努力保持高稳定性。对于我们的产品来说，投资复杂的工具链或者坚持100%的测试覆盖率是适得其反的。</p><p id="455d" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">因此，快速轻松地部署比平时更加重要。通过更积极地部署来弥补更少的安全措施听起来可能不太直观，但这实际上比不频繁地部署要好得多，因为它加速了编写和测试代码之间的反馈循环——毕竟，您的代码将一直在生产环境中运行。如果出现错误，您将在编写代码后立即知道，而不是在以后进行其他工作时进行部署。它还减少了遇到bug时要搜索的提交集，因为任何bug都可能是由最近部署的一两个提交引起的。尽管小型和大型团队的具体工作流程可能有所不同，但是拥有一个简单的部署总是一个优势，因为它消除了<a class="ae jw" href="https://hackernoon.com/tagged/development" rel="noopener ugc nofollow" target="_blank">开发</a>的摩擦。</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff jx"><img src="../Images/af96955d87e58365f92be73c40f43e01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/1*kS4IkxLm670A0A4oSY7Onw.png"/></div></figure><p id="5e4b" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们已经使用Slack的<a class="ae jw" href="https://api.slack.com/slash-commands" rel="noopener ugc nofollow" target="_blank">定制命令集成</a>实现了我们的部署系统。<a class="ae jw" href="https://hackernoon.com/tagged/slack" rel="noopener ugc nofollow" target="_blank"> Slack </a>是一个让部署变得容易的绝妙渠道，因为它总是开放的，易于使用，并且不需要构建一个带有按钮的仪表板。您甚至可以将结果发布回Slack，在那里它们会被自动记录。我们是这样做的:</p><h2 id="1950" class="kc kd hu bd ke kf kg kh ki kj kk kl km jj kn ko kp jn kq kr ks jr kt ku kv kw dt translated">1.配置斜线命令</h2><p id="a480" class="pw-post-body-paragraph iy iz hu ja b jb kx jd je jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv hn dt translated"><a class="ae jw" href="https://my.slack.com/services/new/slash-commands/" rel="noopener ugc nofollow" target="_blank">到这里为/deploy </a>配置斜线命令。您将需要一个可公开访问的HTTP(S)端点，这将取决于您的系统是如何配置的。您还将收到一个令牌，Slack使用它向您验证自己，这样随机的人就不能调用您的部署端点。</p><h2 id="d7af" class="kc kd hu bd ke kf kg kh ki kj kk kl km jj kn ko kp jn kq kr ks jr kt ku kv kw dt translated">2.创建HTTP端点</h2><p id="36c1" class="pw-post-body-paragraph iy iz hu ja b jb kx jd je jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv hn dt translated">这将取决于您的系统和设置。我们在机架上运行Sinatra，所以我们在部署路线上安装了一个监听器。</p><pre class="jy jz ka kb fq lc ld le lf aw lg dt"><span id="4cf6" class="kc kd hu ld b fv lh li l lj lk">class DeployListener  <br/>  def call(env)<br/>    begin<br/>      req = Rack::Request.new(env)<br/>      if req.params['token'] != '&lt;Slack token from configuration&gt;'<br/>        raise 'Not allowed.'<br/>      end<br/><br/>      # Deploy code goes here.<br/>      # For a Ruby deployment, it may be as easy as system('git pull &amp;&amp; bundle install &amp;&amp; &lt;restart webserver&gt;')<br/><br/>      [200, {}, 'Deploy started.']<br/>    rescue StandardError =&gt; e<br/>      [500, {}, e.inspect]<br/>    end<br/>  end<br/>end<br/><br/>map '/api/deploy' do  <br/>  run DeployListener.new<br/>end</span></pre><p id="6526" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">所以我们Slack的端点是<a class="ae jw" href="https://%3Cserver%3E/api/deploy." rel="noopener ugc nofollow" target="_blank">https://&lt;server&gt;/API/deploy。</a></p><h2 id="ef80" class="kc kd hu bd ke kf kg kh ki kj kk kl km jj kn ko kp jn kq kr ks jr kt ku kv kw dt translated">3.运行您的部署</h2><p id="068e" class="pw-post-body-paragraph iy iz hu ja b jb kx jd je jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv hn dt translated">此时，您将向您的侦听器添加部署代码，或者如果您已经编写了部署脚本，则从侦听器中调用它。这里有一个问题:如果您在与系统代码的其余部分相同的进程中运行监听器，并在部署期间重新启动系统，您可能会意外地让监听器终止它自己的进程，从而阻止它自己重新启动。我们通过分叉流程并在子流程中运行部署脚本来解决这个问题。当孩子重启系统时，父代会被杀死重启，通常不会影响到孩子。然后孩子会安静的退出。</p><p id="a658" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们的最终整合:</p><pre class="jy jz ka kb fq lc ld le lf aw lg dt"><span id="1939" class="kc kd hu ld b fv lh li l lj lk">class DeployListener  <br/>  def call(env)<br/>    begin<br/>      req = Rack::Request.new(env)<br/>      if req.params['token'] != '&lt;Slack token from configuration&gt;'        raise 'Not allowed.'<br/>      end<br/><br/>      fork do<br/>        system('(cd /home/ubuntu/penny &amp;&amp; ruby deploy.rb) &gt;&gt; /home/ubuntu/slack-deploy.log 2&gt;&amp;1')<br/>      end<br/><br/>      [200, {}, 'Deploy started.']<br/>    rescue StandardError =&gt; e<br/>      [500, {}, e.inspect]<br/>    end<br/>  end<br/>end<br/><br/>map '/api/deploy' do  <br/>  run DeployListener.new<br/>end</span></pre><p id="92e7" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">其中deploy.rb是我们的自定义部署脚本。请注意，如果通过shell运行，您的部署脚本可能会工作，但是如果在侦听器进程的上下文中运行，可能会出错，因为它有不同的路径和环境。将输出通过管道传输到文件对于调试此问题非常有用。</p><h2 id="5032" class="kc kd hu bd ke kf kg kh ki kj kk kl km jj kn ko kp jn kq kr ks jr kt ku kv kw dt translated">4.利润</h2><p id="bae4" class="pw-post-body-paragraph iy iz hu ja b jb kx jd je jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv hn dt translated">这种集成是原始的，有点粗糙，但是它做了我们需要它做的事情。作为一个两人团队，我们渴望像这样的工作放大工具，以简化我们的工作并更快地移动。更不用说你可以从你的手机上<strong class="ja hv">部署，这已经帮我们省了好几次了。如果你对我们正在部署的东西感兴趣，请点击<a class="ae jw" href="https://www.pennyapp.io/?utm_medium=Medium&amp;utm_source=Deploy Your System With Slack&amp;utm_campaign=bottom" rel="noopener ugc nofollow" target="_blank">这里</a>来看看:)</strong></p><div class="jy jz ka kb fq ab cb"><figure class="ll iv lm ln lo lp lq paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="ll iv lm ln lo lp lq paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="ll iv lm ln lo lp lq paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="lr ls lt"><p id="f922" class="iy iz lu ja b jb jc jd je jf jg jh ji lv jk jl jm lw jo jp jq lx js jt ju jv hn dt translated"><a class="ae jw" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jw" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jw" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jw" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="iy iz lu ja b jb jc jd je jf jg jh ji lv jk jl jm lw jo jp jq lx js jt ju jv hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jw" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jw" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jy jz ka kb fq iv fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff ly"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="lz ma l"/></div></figure></div></div>    
</body>
</html>