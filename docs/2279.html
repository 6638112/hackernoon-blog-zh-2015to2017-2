<html>
<head>
<title>Installing a DIY Bare Metal GPU cluster for Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为Kubernetes安装DIY裸机GPU集群</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/installing-a-diy-bare-metal-gpu-cluster-for-kubernetes-364200254187?source=collection_archive---------5-----------------------#2017-01-17">https://medium.com/hackernoon/installing-a-diy-bare-metal-gpu-cluster-for-kubernetes-364200254187?source=collection_archive---------5-----------------------#2017-01-17</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="9af5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我不知道你是否见过来自<a class="ae jp" href="http://www.ubuntu.com" rel="noopener ugc nofollow" target="_blank"> Canonical </a>的橙色盒子</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/fd32010a5405ea96d986e5dc14f00030.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*DucW1y7rSIjGHK1CKhdcNA.jpeg"/></div></figure><p id="e13b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这些机器真的很棒。它们包含10个英特尔nuc，外加第11个用于<a class="ae jp" href="https://hackernoon.com/tagged/management" rel="noopener ugc nofollow" target="_blank">管理层</a>。它们被用作大型软件栈的演示工具，比如OpenStack、Hadoop，当然还有Kubernetes。</p><p id="aa70" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它们可以从<a class="ae jp" href="http://cluster.engineering/ubuntu-orangebox-v4-fully-configured/" rel="noopener ugc nofollow" target="_blank"> TranquilPC </a>免费获得，所以如果你是一个研发团队，或者只是想在家里拥有一个整洁的小集群，我鼓励你去看看。</p><p id="c0dc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，尽管他们拥有巨大的品质，但他们缺乏深度学习极客所珍视的关键工具:<a class="ae jp" href="https://developer.nvidia.com/cuda-gpus" rel="noopener ugc nofollow" target="_blank">GPU</a>！！</p><p id="90e6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这篇博客/教程中，我们将学习如何构建、安装和配置一个使用类似架构的DIY GPU集群。我们从硬件选择和实验开始，然后深入研究裸机管理系统<a class="ae jp" href="http://maas.io" rel="noopener ugc nofollow" target="_blank"> MAAS </a>(金属即服务)。最后，我们看看如何在Ubuntu上部署Kubernetes，添加CUDA支持，并在集群中启用它。</p></div><div class="ab cl jy jz hc ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hn ho hp hq hr"><h1 id="26c5" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">硬件:为英特尔NUCs添加成熟的GPU？</h1><p id="0a68" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">当你看到它们时，很难说出如何将普通的GPU卡插入到英特尔NUCs的微小外形中。然而，他们有一个m2 NGFF港。这实际上是一个PCI-e 4x端口，只是外形不同。</p><p id="cfb7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">而且，还有把M.2转换成PCI-e 4x的<a class="ae jp" href="https://www.amazon.com/gp/product/B0182NRGYO/ref=pd_sbs_147_4?ie=UTF8&amp;pd_rd_i=B0182NRGYO&amp;pd_rd_r=7132S1GSAF2RZKMY56AA&amp;pd_rd_w=WgCgh&amp;pd_rd_wg=BAWWT&amp;psc=1&amp;refRID=7132S1GSAF2RZKMY56AA" rel="noopener ugc nofollow" target="_blank">这个</a>和把PCI-e 4x转换成16x的<a class="ae jp" href="https://www.amazon.com/Express-PCI-E-Female-Riser-Cable/dp/B00CJE0KJ6/ref=sr_1_1?s=pc&amp;ie=UTF8&amp;qid=1478253899&amp;sr=1-1&amp;keywords=pci+4x+to+16x" rel="noopener ugc nofollow" target="_blank">那个</a>。</p><p id="3044" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以…理论上，我们<strong class="it hv">可以</strong>将GPU连接到英特尔nuc。让我们试试吧！！</p></div><div class="ab cl jy jz hc ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hn ho hp hq hr"><h1 id="aa8d" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">POC:第一节点</h1><p id="9f72" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">让我们从简单的单节点英特尔NUC开始，看看我们是否能让GPU与之配合工作。</p><p id="a622" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我已经有了一辆上一代的NUC和一辆老镭龙7870，我不得不买了</p><ul class=""><li id="b8a5" class="li lj hu it b iu iv iy iz jc lk jg ll jk lm jo ln lo lp lq dt translated">为GPU供电的PSU:为此，我发现<a class="ae jp" href="http://www.corsair.com/en/ax1500i-digital-atx-power-supply-1500-watt-fully-modular-psu" rel="noopener ugc nofollow" target="_blank"> Corsair AX1500i </a>是市场上最划算的交易，能够为多达10个GPU供电！！如果我想用更多的节点来扩展它，这再好不过了。</li><li id="f5eb" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated">适配器:<br/> - <a class="ae jp" href="https://www.amazon.com/gp/product/B0182NRGYO/ref=pd_sbs_147_4?ie=UTF8&amp;pd_rd_i=B0182NRGYO&amp;pd_rd_r=7132S1GSAF2RZKMY56AA&amp;pd_rd_w=WgCgh&amp;pd_rd_wg=BAWWT&amp;psc=1&amp;refRID=7132S1GSAF2RZKMY56AA" rel="noopener ugc nofollow" target="_blank"> M.2转PCI-e 4x</a>-<a class="ae jp" href="https://www.amazon.com/Express-PCI-E-Female-Riser-Cable/dp/B00CJE0KJ6/ref=sr_1_1?s=pc&amp;ie=UTF8&amp;qid=1478253899&amp;sr=1-1&amp;keywords=pci+4x+to+16x" rel="noopener ugc nofollow" target="_blank">转接卡4x - &gt; 16x </a></li><li id="06bb" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated"><a class="ae jp" href="http://www.instructables.com/id/How-to-power-up-an-ATX-Power-Supply-without-a-PC/" rel="noopener ugc nofollow" target="_blank">黑掉</a>激活PSU上的电源，而无需将其连接到“真正的”主板上。感谢Michael Iatrou (@iatrou)给我指明了方向。</li><li id="2a32" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated">很明显是屏幕、键盘、电缆…</li></ul><p id="8345" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">把所有东西插在一起，然后…</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff lw"><img src="../Images/f86392ddd2c045803b1f7615d24fc1a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:812/format:webp/1*y0TX9mGXT1adoCZC-xk5qA.jpeg"/></div></figure><p id="3e76" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它还活着！运行速度为4x的附加GPU的Ubuntu启动屏幕</p><p id="d46c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此时，我们已经证明这是可能的，是时候开始构建一个真正的集群了。</p></div><div class="ab cl jy jz hc ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hn ho hp hq hr"><h1 id="ba96" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">添加小兄弟</h1><p id="127c" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">让我们构建一个包含2个管理节点和4个GPU计算人员的6节点集群。</p><h2 id="ce87" class="lx kg hu bd kh ly lz ma kl mb mc md kp jc me mf kt jg mg mh kx jk mi mj lb mk dt translated">材料清单</h2><p id="f7ac" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">对于每个工人，您需要:</p><ul class=""><li id="e3da" class="li lj hu it b iu iv iy iz jc lk jg ll jk lm jo ln lo lp lq dt translated"><a class="ae jp" href="https://www.amazon.es/gp/product/B018Q0GN60/ref=oh_aui_detailpage_o01_s00?ie=UTF8&amp;psc=1" rel="noopener ugc nofollow" target="_blank">英特尔NUC6i5RYH </a>在性能方面是一个不错的选择，但它没有英特尔AMT，因此您将无法激活完全自动化的操作。如果您想做一些更接近橙色盒子的事情，实现电源循环的完全自动化，您需要购买较旧的NUC5i5MYHE，这是唯一一款采用博锐技术的参考产品(除了主板本身)。更多信息<a class="ae jp" href="http://www.intel.com/content/www/us/en/nuc/nuc-comparison.html" rel="noopener ugc nofollow" target="_blank">点击此处</a>。</li><li id="29c0" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated">RAM: <a class="ae jp" href="https://www.amazon.es/gp/product/B017UC3O76/ref=oh_aui_detailpage_o02_s00?ie=UTF8&amp;psc=1" rel="noopener ugc nofollow" target="_blank">海盗船的32GB DDR4】</a></li><li id="dde3" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated">固态硬盘:<a class="ae jp" href="https://www.amazon.es/gp/product/B00M8ABFX6/ref=oh_aui_detailpage_o02_s00?ie=UTF8&amp;psc=1" rel="noopener ugc nofollow" target="_blank"> 500GB闪迪Ultra II </a></li><li id="7fee" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated">显卡:<a class="ae jp" href="https://www.amazon.es/gp/product/B01IPFN7UQ/ref=oh_aui_detailpage_o06_s00?ie=UTF8&amp;psc=1" rel="noopener ugc nofollow" target="_blank"> nVidia GTX1060 6GB </a></li><li id="38fc" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated">适配器:与之前相同，还有<a class="ae jp" href="https://www.amazon.es/hembra-adaptador-extensi%C3%B3n-cuprof%C3%B3sforo-Flexible/dp/B00UBUCES0/ref=sr_1_cc_2?s=aps&amp;ie=UTF8&amp;qid=1478276213&amp;sr=1-2-catcorr&amp;keywords=pci+4x+extender" rel="noopener ugc nofollow" target="_blank"> 4x延长器</a></li></ul><p id="0546" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于管理节点，是上述nuc的2倍，但没有GPU，使用更小的SSD。</p><p id="6a27" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在是整体组件:</p><ul class=""><li id="2730" class="li lj hu it b iu iv iy iz jc lk jg ll jk lm jo ln lo lp lq dt translated">PSU:海盗船AX1500i</li><li id="853e" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated">开关<a class="ae jp" href="https://www.amazon.es/Netgear-GS108PE-300EUS-ProSAFE-Ethernet-garant%C3%ADa/dp/B00LMXBOG8/ref=sr_1_20?s=computers&amp;ie=UTF8&amp;qid=1478268416&amp;sr=1-20&amp;keywords=8+puertos+gigabit" rel="noopener ugc nofollow" target="_blank">网件GS108PE </a>。你可以拿一个低端开关，我有一个可用的就是这样。我在网络方面没有做任何稀奇古怪的事情。</li><li id="b108" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated">raspberry Pi:32GB micro SD的任何2或3版本</li><li id="2251" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated">间隔器</li><li id="5d97" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated"><a class="ae jp" href="https://www.amazon.es/gp/product/B00NB3E2N4/ref=oh_aui_detailpage_o06_s00?ie=UTF8&amp;psc=1" rel="noopener ugc nofollow" target="_blank"> ATX PSU开关</a></li></ul><p id="54eb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">仅供参考，这是一个昂贵的设置，但AWS的g2实例的投资回报率约为每个节点20天…</p></div><div class="ab cl jy jz hc ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hn ho hp hq hr"><h2 id="6da7" class="lx kg hu bd kh ly lz ma kl mb mc md kp jc me mf kt jg mg mh kx jk mi mj lb mk dt translated">执行</h2><p id="db01" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">如果盒子里放不下，就把盒子拿走。所以首先要把NUC的主板取出来。使用3毫米厚的PVC板和垫片，我们可以有一个漂亮的布局。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff ml"><img src="../Images/933de6b4e1daba621fe9834c51a3ce45.png" data-original-src="https://miro.medium.com/v2/resize:fit:290/format:webp/1*zR4_VyTUDz5748DXlE5agA.jpeg"/></div><figcaption class="mm mn fg fe ff mo mp bd b be z ek">GPU view</figcaption></figure><p id="8e16" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在PVC的一侧，我们连接了GPU，因此电源连接器在底部可见，PCI-e端口只是稍微高出边缘。孔是2.8毫米，以便M3垫片通过，但你需要拧他们一点点，他们不会移动。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff ml"><img src="../Images/66e1d68e79c29d8f0a5be488b219e4c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:290/format:webp/1*-nk9lcfrKApKAYGc8eRtlA.jpeg"/></div><figcaption class="mm mn fg fe ff mo mp bd b be z ek">Intel NUC view</figcaption></figure><p id="ced5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">另一方面，我们为SSD和NUC钻了固定孔，以便PCI-e riser电缆在GPU的PCI-e端口前面对齐。你还需要在固态硬盘的金属支架上钻一点孔。</p><p id="227d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正如你在图片上看到的，我们把立管放在PEC和NUC之间，这样看起来更好</p></div><div class="ab cl jy jz hc ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hn ho hp hq hr"><p id="370e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们对每个节点重复操作4次。然后使用我们的50毫米M3六角，我们用3个螺丝将它们连接在每个“刀片”之间，将所有东西都预订到网络上，然后…tadaaaaaa！！</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff mq"><img src="../Images/0a4ae9e27e7f4ceb973aca834208cf78.png" data-original-src="https://miro.medium.com/v2/resize:fit:904/format:webp/1*pnJ-HCAQZucPc5_5W4H41w.jpeg"/></div><figcaption class="mm mn fg fe ff mo mp bd b be z ek">Close up view from the NUC side</figcaption></figure><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff ml"><img src="../Images/4301c3ff7dc122a50d675776c3047e32.png" data-original-src="https://miro.medium.com/v2/resize:fit:290/format:webp/1*zfGTgqz_AOXhp2OvQn3VtA.jpeg"/></div><figcaption class="mm mn fg fe ff mo mp bd b be z ek">From the GPU side</figcaption></figure></div><div class="ab cl jy jz hc ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hn ho hp hq hr"><h1 id="b625" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">软件:集群的安装</h1><p id="7cd9" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">赋予集群生命需要在软件方面做大量的工作。</p><p id="1a57" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们将利用强大的管理工具，而不是手动流程。这将使我们能够在未来重新规划我们的集群。</p><p id="b7e8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">管理金属本身的工具是<a class="ae jp" href="http://maas.io" rel="noopener ugc nofollow" target="_blank"> MAAS </a>(金属即服务)。它是由Canonical开发的，用于管理裸机服务器群，并且已经驱动了Ubuntu Orange Box。</p><p id="3e1e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后为了进行部署，我们将使用Canonical的建模工具<a class="ae jp" href="https://jujucharms.com" rel="noopener ugc nofollow" target="_blank"> Juju </a>，它有用于部署Kubernetes 的<a class="ae jp" href="https://www.ubuntu.com/cloud/kubernetes" rel="noopener ugc nofollow" target="_blank">规范发行版的包。</a></p></div><div class="ab cl jy jz hc ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hn ho hp hq hr"><h1 id="572a" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">裸机配置:安装MAAS</h1><p id="53e2" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">首先，我们需要在Raspberry Pi 2上安装MAAS。</p><p id="1320" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于其余部分，我们将假设您已经准备好:</p><ul class=""><li id="3553" class="li lj hu it b iu iv iy iz jc lk jg ll jk lm jo ln lo lp lq dt translated">安装了Ubuntu Server 16.04的Raspberry Pi 2或3</li><li id="73ed" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated">连接到与互联网相连的网络的板载以太网端口，并进行配置</li><li id="d62a" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated">额外的USB转以太网适配器，连接到我们的集群交换机</li></ul><h2 id="f8b3" class="lx kg hu bd kh ly lz ma kl mb mc md kp jc me mf kt jg mg mh kx jk mi mj lb mk dt translated">网络安装程序</h2><p id="ff3b" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">默认的Ubuntu镜像不会自动安装USB适配器。首先，我们将查询ifconfig以查看除eth0接口之外的eth1(或其他名称):</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="2896" class="lx kg hu ms b fv mw mx l my mz">$ /sbin/ifconfig -a<br/>eth0 Link encap:Ethernet HWaddr b8:27:eb:4e:48:c6 <br/> inet addr:192.168.1.138 Bcast:192.168.1.255 Mask:255.255.255.0<br/> inet6 addr: fe80::ba27:ebff:fe4e:48c6/64 Scope:Link<br/> UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1<br/> RX packets:150573 errors:0 dropped:0 overruns:0 frame:0<br/> TX packets:39702 errors:0 dropped:0 overruns:0 carrier:0<br/> collisions:0 txqueuelen:1000 <br/> RX bytes:217430968 (217.4 MB) TX bytes:3450423 (3.4 MB)</span><span id="6954" class="lx kg hu ms b fv na mx l my mz">eth1 Link encap:Ethernet HWaddr 00:0e:c6:c2:e6:82 <br/> BROADCAST MULTICAST MTU:1500 Metric:1<br/> RX packets:0 errors:0 dropped:0 overruns:0 frame:0<br/> TX packets:0 errors:0 dropped:0 overruns:0 carrier:0<br/> collisions:0 txqueuelen:1000 <br/> RX bytes:0 (0.0 B) TX bytes:0 (0.0 B)</span></pre><p id="5c67" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们现在可以用编辑<strong class="it hv">/etc/network/interfaces . d/et h1 . CFG</strong></p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="5d5a" class="lx kg hu ms b fv mw mx l my mz"># hwaddress 00:0e:c6:c2:e6:82<br/>auto eth1<br/>iface eth1 inet static<br/> address 192.168.23.1<br/> netmask 255.255.255.0</span></pre><p id="23f4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后用以下命令启动eth1</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="4613" class="lx kg hu ms b fv mw mx l my mz">$ sudo ifup eth1</span></pre><p id="c298" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们有了第二个接口设置。</p><h2 id="7b30" class="lx kg hu bd kh ly lz ma kl mb mc md kp jc me mf kt jg mg mh kx jk mi mj lb mk dt translated">基础安装</h2><p id="9a28" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">让我们首先安装需求:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="251d" class="lx kg hu ms b fv mw mx l my mz">$ sudo apt update &amp;&amp; sudo apt upgrade -yqq<br/>$ sudo apt install -yqq — no-install-recommends \<br/>   maas \<br/>   bzr \<br/>   isc-dhcp-server \<br/>   wakeonlan \<br/>   amtterm \<br/>   wsmancli \<br/>   juju \<br/>   zram-config</span></pre><p id="8794" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们利用这个机会来修复非常烦人的Perl Locales bug，它几乎影响了周围的每个Rapsberry Pi:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="df6c" class="lx kg hu ms b fv mw mx l my mz">$ sudo locale-gen en_US.UTF-8</span></pre><p id="6dfb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，让我们激活zram，通过在<strong class="it hv"> /etc/rc.local </strong>中添加以下内容，将我们的ram虚拟增加1GB</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="6015" class="lx kg hu ms b fv mw mx l my mz">modprobe zram &amp;&amp; \<br/> echo $((1024*1024*1024)) | tee /sys/block/zram0/disksize &amp;&amp; \<br/> mkswap /dev/zram0 &amp;&amp; \<br/> swapon -p 10 /dev/zram0 &amp;&amp; \<br/> exit 0</span></pre><p id="f7af" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">并通过以下方式立即激活</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="06ac" class="lx kg hu ms b fv mw mx l my mz">$ sudo modprobe zram &amp;&amp; \<br/> echo $((1024*1024*1024)) | sudo tee /sys/block/zram0/disksize &amp;&amp; \<br/> sudo mkswap /dev/zram0 &amp;&amp; \<br/> sudo swapon -p 10 /dev/zram0</span></pre><h2 id="fb21" class="lx kg hu bd kh ly lz ma kl mb mc md kp jc me mf kt jg mg mh kx jk mi mj lb mk dt translated">DHCP配置</h2><p id="73a5" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">DHCP将由MAAS直接处理，所以我们不必处理它。然而，它配置默认设置的方式是相当残酷的，所以你可能想调整一下。下面是一个<strong class="it hv"> /etc/dhcp/dhcpd.conf </strong>文件，这个文件可以工作，但是有点花哨</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="21e8" class="lx kg hu ms b fv mw mx l my mz">authoritative;<br/>ddns-update-style none;<br/>log-facility local7;</span><span id="17d2" class="lx kg hu ms b fv na mx l my mz">option subnet-mask 255.255.255.0;<br/>option broadcast-address 192.168.23.255;<br/>option routers 192.168.23.1;<br/>option domain-name-servers 192.168.23.1;<br/>option domain-name “maas”;<br/>default-lease-time 600;<br/>max-lease-time 7200;</span><span id="f210" class="lx kg hu ms b fv na mx l my mz">subnet 192.168.23.0 netmask 255.255.255.0 {<br/> range 192.168.23.10 192.168.23.49;</span><span id="57bf" class="lx kg hu ms b fv na mx l my mz">host node00 {<br/> hardware ethernet B8:AE:ED:7A:B6:92;<br/> fixed-address 192.168.23.10;<br/> }</span><span id="4679" class="lx kg hu ms b fv na mx l my mz">... ...<br/>}</span></pre><p id="a6a7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们还需要告诉dhcpd只为eth1上的请求提供服务，以防止流入我们的其他网络。我们通过编辑<strong class="it hv">/etc/default/isc-DHCP-server</strong>中的接口选项来做到这一点</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="ee95" class="lx kg hu ms b fv mw mx l my mz"># On what interfaces should the DHCP server (dhcpd) serve DHCP requests?<br/># Separate multiple interfaces with spaces, e.g. “eth0 eth1”.<br/>INTERFACES=”eth1"</span></pre><p id="7e55" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，我们用</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="945a" class="lx kg hu ms b fv mw mx l my mz">$ sudo systemctl restart isc-dhcp-server.service</span></pre><h2 id="9378" class="lx kg hu bd kh ly lz ma kl mb mc md kp jc me mf kt jg mg mh kx jk mi mj lb mk dt translated">简单的路由器配置</h2><p id="ce92" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">在我们的设置中，Raspberry Pi是网络的争用点。虽然MAAS默认提供DNS和DHCP，但它并不作为网关运行。因此，我们的节点很可能最终看不到互联网，这显然是我们不希望的。</p><p id="0298" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，我们在sysctl中激活IP转发:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="ecd8" class="lx kg hu ms b fv mw mx l my mz">sudo touch /etc/sysctl.d/99-maas.conf<br/>echo “net.ipv4.ip_forward=1” | sudo tee /etc/sysctl.d/99-maas.conf<br/>sudo sh -c “echo 1 &gt; /proc/sys/net/ipv4/ip_forward”</span></pre><p id="4158" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，我们需要链接eth0和eth1接口，以允许它们之间的流量</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="d109" class="lx kg hu ms b fv mw mx l my mz">$ sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE<br/>$ sudo iptables -A FORWARD -i eth0 -o eth1 -m state — state RELATED,ESTABLISHED -j ACCEPT<br/>$ sudo iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT</span></pre><p id="089f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好了，现在我们有流量通过，我们可以通过在局域网接口上插入任何东西并尝试ping某个互联网网站来测试流量。</p><p id="f8db" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们保存它是为了让它在重启后仍然存在</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="e757" class="lx kg hu ms b fv mw mx l my mz">sudo sh -c “iptables-save &gt; /etc/iptables.ipv4.nat”</span></pre><p id="f3c8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">并将这一行添加到/etc/network/interfaces . d/et h1 . conf中</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="926d" class="lx kg hu ms b fv mw mx l my mz">up iptables-restore &lt; /etc/iptables.ipv4.nat</span></pre><h1 id="8ec9" class="kf kg hu bd kh ki nb kk kl km nc ko kp kq nd ks kt ku ne kw kx ky nf la lb lc dt translated">配置MAAS</h1><h2 id="cd81" class="lx kg hu bd kh ly lz ma kl mb mc md kp jc me mf kt jg mg mh kx jk mi mj lb mk dt translated">先决条件</h2><p id="e21f" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">首先创建您的管理用户:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="a7b5" class="lx kg hu ms b fv mw mx l my mz">$ sudo maas createadmin — username=admin — <a class="ae jp" href="mailto:email=it@madeden.com" rel="noopener ugc nofollow" target="_blank">email=it@madeden.com</a></span></pre><p id="54b7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，让我们访问我们的API密钥，并从CLI登录:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="1dd8" class="lx kg hu ms b fv mw mx l my mz">$ sudo maas-region apikey — username=admin</span></pre><p id="ad90" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有了这个命令的结果，只要做:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="f2c8" class="lx kg hu ms b fv mw mx l my mz">$ # maas login &lt;profile-name&gt; &lt;hostname&gt; &lt;key&gt;<br/>$ maas login admin <a class="ae jp" href="http://localhost/MAAS/api/2.0" rel="noopener ugc nofollow" target="_blank">http://localhost/MAAS/api/2.0</a> &lt;key&gt;</span></pre><p id="100c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">或者你可以只输入一个命令:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="7d98" class="lx kg hu ms b fv mw mx l my mz">$ sudo maas-region apikey — username=admin | \<br/> maas login admin <a class="ae jp" href="http://localhost/MAAS/api/2.0" rel="noopener ugc nofollow" target="_blank">http://localhost/MAAS/api/2.0</a> -</span></pre><p id="425e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，通过GUI，在网络选项卡中，我们重命名我们的<strong class="it hv">结构</strong>，以匹配LAN、WAN和WLAN。</p><p id="6c87" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后我们进入局域网，通过<strong class="it hv">采取行动</strong>按钮，我们在上面启用DHCP。</p><p id="a559" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们唯一要做的就是启动节点一次。它们将由MAAS直接处理，并在几分钟后出现在GUI中。</p><p id="5f2a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它们将有一个随机的名称，没有任何配置。</p><p id="feaf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，我们将重新命名它们。为了方便起见，在我们的实验中，我们将使用node00和node01作为第一个非gpu节点，然后node02到04作为GPU节点。</p><p id="2a8e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">命名后，我们还将</p><p id="d095" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">*标记它们**仅gpu * *用于2个第一管理节点<br/> *标记它们**gpu**用于4个工作节点。<br/> *将电源方式设置为**手动* *</p><p id="0adc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后我们有类似的东西</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="fe ff ng"><img src="../Images/dc80761a8d4e7b53792029f33c21df5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nqnuuigHgEKvSGAI54H3OQ.png"/></div></div></figure><h2 id="5860" class="lx kg hu bd kh ly lz ma kl mb mc md kp jc me mf kt jg mg mh kx jk mi mj lb mk dt translated">调试节点</h2><p id="6ae0" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">这就是乐趣的开始。我们需要“委托节点”，换句话说，记录关于它们的信息(硬盘驱动器，CPU计数…)</p><p id="4001" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">MAAS中有一个<a class="ae jp" href="https://bugs.launchpad.net/maas/+bug/1604962" rel="noopener ugc nofollow" target="_blank"> bug </a>阻碍了系统的部署。查看注释#14，并通过编辑<strong class="it hv">/etc/Maas/preseeds/curtin _ user data</strong>来应用它。在重新启动部分添加一个延迟，使其看起来像:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="29e7" class="lx kg hu ms b fv mw mx l my mz">power_state:<br/> mode: reboot<br/> delay: 30</span></pre><p id="bffa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，我们通过<strong class="it hv">采取行动</strong>按钮进行调试，并选择<strong class="it hv">调试</strong>，并取消选中所有其他3个选项。在此之后，我们手动为每个节点通电，MAAS将完成剩下的工作，包括在流程结束时关闭它们。用户界面将看起来像这样:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="fe ff nl"><img src="../Images/70b799c0f6bec3fd68b5b72c3d26ba43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NlHZ2xposX77GnlpNupNQQ.png"/></div></div><figcaption class="mm mn fg fe ff mo mp bd b be z ek">MAAS commissioning nodes</figcaption></figure><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="fe ff nm"><img src="../Images/827aebe4d4bf8e1ff32f80e28351f084.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L1RKAp5cxwv8eI8vrXBWrw.png"/></div></div><figcaption class="mm mn fg fe ff mo mp bd b be z ek">MAAS from New To Commissioned</figcaption></figure><p id="0787" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当调试成功时，我们会看到HDD大小、nb内核和已填充内存的所有值，并且节点也变为<strong class="it hv">就绪</strong></p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="fe ff nn"><img src="../Images/9797b4b55f13b5741a7ef5f0c7ce4ceb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C9bGu03OAYgjlRHcCwpLEA.png"/></div></div><figcaption class="mm mn fg fe ff mo mp bd b be z ek">MAAS Logs at commissiionning</figcaption></figure></div><div class="ab cl jy jz hc ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hn ho hp hq hr"><h1 id="1820" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">使用Juju部署</h1><h2 id="a43a" class="lx kg hu bd kh ly lz ma kl mb mc md kp jc me mf kt jg mg mh kx jk mi mj lb mk dt translated">引导环境</h2><p id="945b" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">我们首先要做的是把Juju和MAAS联系起来。我们为作为提供者的MAAS创建一个配置文件<strong class="it hv"> maas-juju.yaml </strong>，内容为:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="39a4" class="lx kg hu ms b fv mw mx l my mz">maas:<br/> type: maas<br/> auth-types: [oauth1]<br/> endpoint: http://&lt;MAAS_IP&gt;/MAAS</span></pre><p id="a216" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将MAAS_IP地址理解为Juju与MAAS交互的地址，包括部署的节点。因此，您可以在我们的设置中使用eth1 (192.168.23.1)</p><p id="c21d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可以在<a class="ae jp" href="https://jujucharms.com/docs/devel/clouds-maas" rel="noopener ugc nofollow" target="_blank">这一页</a>找到更多细节</p><p id="b8cf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后我们需要告诉Juju使用MAAS:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="1cd9" class="lx kg hu ms b fv mw mx l my mz">$ juju add-cloud maas maas-juju.yaml<br/>$ juju add-credential maas</span></pre><p id="81b8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Juju需要<strong class="it hv">引导</strong>启动第一个控制节点，该节点将托管Juju控制器、初始数据库和各种其他需求。这个节点是我们有两个管理节点的原因。第二个会是我们的k8s主。</p><p id="d4d5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们的设置中，我们的节点只有手动电源，因为2.0版的MAAS中删除了WoL。这意味着我们需要触发引导，等待分配节点，然后手动启动它。</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="dc7e" class="lx kg hu ms b fv mw mx l my mz">$ juju bootstrap maas-controller maas<br/>Creating Juju controller “maas-controller” on maas<br/>Bootstrapping model “controller”<br/>Starting new instance for initial controller<br/>Launching instance # This is where we start the node manually<br/>WARNING no architecture was specified, acquiring an arbitrary node<br/> — 4y3h8w<br/>Installing Juju agent on bootstrap instance<br/>Preparing for Juju GUI 2.2.2 release installation<br/>Waiting for address<br/>Attempting to connect to 192.168.23.2:22<br/>Logging to /var/log/cloud-init-output.log on remote host<br/>Running apt-get update<br/>Running apt-get upgrade<br/>Installing package: curl<br/>Installing package: cpu-checker<br/>Installing package: bridge-utils<br/>Installing package: cloud-utils<br/>Installing package: tmux<br/>Fetching tools: curl -sSfw ‘tools from %{url_effective} downloaded: HTTP %{http_code}; time %{time_total}s; size %{size_download} bytes; speed %{speed_download} bytes/s ‘ — retry 10 -o $bin/tools.tar.gz &lt;[<a class="ae jp" href="https://streams.canonical.com/juju/tools/agent/2.0-beta15/juju-2.0-beta15-xenial-amd64.tgz" rel="noopener ugc nofollow" target="_blank">https://streams.canonical.com/juju/tools/agent/2.0-beta15/juju-2.0-beta15-xenial-amd64.tgz</a>]&gt;<br/>Bootstrapping Juju machine agent<br/>Starting Juju machine agent (jujud-machine-0)<br/>Bootstrap agent installed<br/>Bootstrap complete, maas-controller now available.</span></pre><p id="9daa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">和MAAS GUI:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="fe ff nn"><img src="../Images/080609a5fcdf7cf291b3c954dc972263.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aqIXiw5bhPv21VImXP54WQ.png"/></div></div></figure><h2 id="447e" class="lx kg hu bd kh ly lz ma kl mb mc md kp jc me mf kt jg mg mh kx jk mi mj lb mk dt translated">初始捆绑包部署</h2><p id="9436" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">我们部署下面的包文件<strong class="it hv"> k8s.yaml </strong>:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="5a7e" class="lx kg hu ms b fv mw mx l my mz">series: xenial<br/>services:<br/> “kubernetes-master”:<br/> charm: “cs:~containers/kubernetes-master-6”<br/> num_units: 1<br/> to:<br/> — “0”<br/> expose: true<br/> annotations:<br/> “gui-x”: “800”<br/> “gui-y”: “850”<br/> constraints: tags=cpu-only<br/> flannel:<br/> charm: “cs:~containers/flannel-5”<br/> annotations:<br/> “gui-x”: “450”<br/> “gui-y”: “750”<br/> easyrsa:<br/> charm: “cs:~containers/easyrsa-3”<br/> num_units: 1<br/> to:<br/> — “0”<br/> annotations:<br/> “gui-x”: “450”<br/> “gui-y”: “550”<br/> “kubernetes-worker”:<br/> charm: “cs:~containers/kubernetes-worker-8”<br/> num_units: 1<br/> to:<br/> — “1”<br/> expose: true<br/> annotations:<br/> “gui-x”: “100”<br/> “gui-y”: “850”<br/> constraints: tags=gpu<br/> etcd:<br/> charm: “cs:~containers/etcd-14”<br/> num_units: 1<br/> to:<br/> — “0”<br/> annotations:<br/> “gui-x”: “800”<br/> “gui-y”: “550”<br/>relations:<br/> — — “kubernetes-master:kube-api-endpoint”<br/> — “kubernetes-worker:kube-api-endpoint”<br/> — — “kubernetes-master:cluster-dns”<br/> — “kubernetes-worker:kube-dns”<br/> — — “kubernetes-master:certificates”<br/> — “easyrsa:client”<br/> — — “kubernetes-master:etcd”<br/> — “etcd:db”<br/> — — “kubernetes-master:sdn-plugin”<br/> — “flannel:host”<br/> — — “kubernetes-worker:certificates”<br/> — “easyrsa:client”<br/> — — “kubernetes-worker:sdn-plugin”<br/> — “flannel:host”<br/> — — “flannel:etcd”<br/> — “etcd:db”<br/>machines:<br/> “0”:<br/> series: xenial<br/> “1”:<br/> series: xenial</span></pre><p id="4813" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们可以看到，我们对节点进行了约束，强制MAAS为工作节点选择GPU节点，为主节点选择CPU节点。我们传递命令</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="69e5" class="lx kg hu ms b fv mw mx l my mz">$ juju deploy k8s.yaml</span></pre><p id="bfd6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就是这样。这是让k8s正常运行所需的唯一命令！</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="417d" class="lx kg hu ms b fv mw mx l my mz">added charm cs:~containers/easyrsa-3<br/>application easyrsa deployed (charm cs:~containers/easyrsa-3 with the series “xenial” defined by the bundle)<br/>added resource easyrsa<br/>annotations set for application easyrsa<br/>added charm cs:~containers/etcd-14<br/>application etcd deployed (charm cs:~containers/etcd-14 with the series “xenial” defined by the bundle)<br/>annotations set for application etcd<br/>added charm cs:~containers/flannel-5<br/>application flannel deployed (charm cs:~containers/flannel-5 with the series “xenial” defined by the bundle)<br/>added resource flannel<br/>annotations set for application flannel<br/>added charm cs:~containers/kubernetes-master-6<br/>application kubernetes-master deployed (charm cs:~containers/kubernetes-master-6 with the series “xenial” defined by the bundle)<br/>added resource kubernetes<br/>application kubernetes-master exposed<br/>annotations set for application kubernetes-master<br/>added charm cs:~containers/kubernetes-worker-8<br/>application kubernetes-worker deployed (charm cs:~containers/kubernetes-worker-8 with the series “xenial” defined by the bundle)<br/>added resource kubernetes<br/>application kubernetes-worker exposed<br/>annotations set for application kubernetes-worker<br/>created new machine 0 for holding easyrsa, etcd and kubernetes-master units<br/>created new machine 1 for holding kubernetes-worker unit<br/>related kubernetes-master:kube-api-endpoint and kubernetes-worker:kube-api-endpoint<br/>related kubernetes-master:cluster-dns and kubernetes-worker:kube-dns<br/>related kubernetes-master:certificates and easyrsa:client<br/>related kubernetes-master:etcd and etcd:db<br/>related kubernetes-master:sdn-plugin and flannel:host<br/>related kubernetes-worker:certificates and easyrsa:client<br/>related kubernetes-worker:sdn-plugin and flannel:host<br/>related flannel:etcd and etcd:db<br/>added easyrsa/0 unit to machine 0<br/>added etcd/0 unit to machine 0<br/>added kubernetes-master/0 unit to machine 0<br/>added kubernetes-worker/0 unit to machine 1<br/>deployment of bundle “k8s.yaml” completed</span></pre><p id="2c34" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在GUI中翻译为:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="fe ff no"><img src="../Images/aa14c50baf9a821adf7dd8e719870e8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ErRrnUfmzFX2s7ivdTbBGg.png"/></div></div></figure><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="f8f4" class="lx kg hu ms b fv mw mx l my mz">$ juju status<br/>MODEL CONTROLLER CLOUD/REGION VERSION<br/>default maas-controller maas 2.0-beta15</span><span id="8da3" class="lx kg hu ms b fv na mx l my mz">APP VERSION STATUS EXPOSED ORIGIN CHARM REV OS<br/>easyrsa 3.0.1 active false jujucharms easyrsa 3 ubuntu<br/>etcd 2.2.5 active false jujucharms etcd 14 ubuntu<br/>flannel 0.6.1 false jujucharms flannel 5 ubuntu<br/>kubernetes-master 1.4.5 active true jujucharms kubernetes-master 6 ubuntu<br/>kubernetes-worker active true jujucharms kubernetes-worker 8 ubuntu</span><span id="8102" class="lx kg hu ms b fv na mx l my mz">RELATION PROVIDES CONSUMES TYPE<br/>certificates easyrsa kubernetes-master regular<br/>certificates easyrsa kubernetes-worker regular<br/>cluster etcd etcd peer<br/>etcd etcd flannel regular<br/>etcd etcd kubernetes-master regular<br/>sdn-plugin flannel kubernetes-master regular<br/>sdn-plugin flannel kubernetes-worker regular<br/>host kubernetes-master flannel subordinate<br/>kube-dns kubernetes-master kubernetes-worker regular<br/>host kubernetes-worker flannel subordinate</span><span id="9ce6" class="lx kg hu ms b fv na mx l my mz">UNIT WORKLOAD AGENT MACHINE PUBLIC-ADDRESS PORTS MESSAGE<br/>easyrsa/0 active idle 0 192.168.23.3 Certificate Authority connected.<br/>etcd/0 active idle 0 192.168.23.3 2379/tcp Healthy with 1 known peers. (leader)<br/>kubernetes-master/0 active idle 0 192.168.23.3 6443/tcp Kubernetes master running.<br/> flannel/0 active idle 192.168.23.3 Flannel subnet 10.1.57.1/24<br/>kubernetes-worker/0 active idle 1 192.168.23.4 80/tcp,443/tcp Kubernetes worker running.<br/> flannel/1 active idle 192.168.23.4 Flannel subnet 10.1.67.1/24<br/>kubernetes-worker/1 active executing 2 192.168.23.5 (install) Container runtime available.<br/>kubernetes-worker/2 unknown allocating 3 192.168.23.7 Waiting for agent initialization to finish<br/>kubernetes-worker/3 unknown allocating 4 192.168.23.6 Waiting for agent initialization to finish</span><span id="4b5d" class="lx kg hu ms b fv na mx l my mz">MACHINE STATE DNS INS-ID SERIES AZ<br/>0 started 192.168.23.3 4y3h8x xenial default<br/>1 started 192.168.23.4 4y3h8y xenial default<br/>2 started 192.168.23.5 4y3ha3 xenial default<br/>3 pending 192.168.23.7 4y3ha6 xenial default<br/>4 pending 192.168.23.6 4y3ha4 xenial default</span></pre><p id="2254" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">或者</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="fe ff nn"><img src="../Images/1d1706f99a1110ceb1793d897b2cc720.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xC2d8RpYf44-DHLeJahyZw.png"/></div></div></figure><p id="cf23" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在流程结束时，我们有:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="3b9a" class="lx kg hu ms b fv mw mx l my mz">$ juju status<br/>MODEL CONTROLLER CLOUD/REGION VERSION<br/>default maas-controller maas 2.0-beta15</span><span id="42e6" class="lx kg hu ms b fv na mx l my mz">APP VERSION STATUS EXPOSED ORIGIN CHARM REV OS<br/>cuda false local cuda 0 ubuntu<br/>easyrsa 3.0.1 active false jujucharms easyrsa 3 ubuntu<br/>etcd 2.2.5 active false jujucharms etcd 14 ubuntu<br/>flannel 0.6.1 false jujucharms flannel 5 ubuntu<br/>kubernetes-master 1.4.5 active true jujucharms kubernetes-master 6 ubuntu<br/>kubernetes-worker 1.4.5 active true jujucharms kubernetes-worker 8 ubuntu</span><span id="7a05" class="lx kg hu ms b fv na mx l my mz">RELATION PROVIDES CONSUMES TYPE<br/>certificates easyrsa kubernetes-master regular<br/>certificates easyrsa kubernetes-worker regular<br/>cluster etcd etcd peer<br/>etcd etcd flannel regular<br/>etcd etcd kubernetes-master regular<br/>sdn-plugin flannel kubernetes-master regular<br/>sdn-plugin flannel kubernetes-worker regular<br/>host kubernetes-master flannel subordinate<br/>kube-dns kubernetes-master kubernetes-worker regular<br/>host kubernetes-worker flannel subordinate</span><span id="eb2c" class="lx kg hu ms b fv na mx l my mz">UNIT WORKLOAD AGENT MACHINE PUBLIC-ADDRESS PORTS MESSAGE<br/>easyrsa/0 active idle 0 192.168.23.3 Certificate Authority connected.<br/>etcd/0 active idle 0 192.168.23.3 2379/tcp Healthy with 1 known peers. (leader)<br/>kubernetes-master/0 active idle 0 192.168.23.3 6443/tcp Kubernetes master running.<br/> flannel/0 active idle 192.168.23.3 Flannel subnet 10.1.57.1/24<br/>kubernetes-worker/0 active idle 1 192.168.23.4 80/tcp,443/tcp Kubernetes worker running.<br/> flannel/1 active idle 192.168.23.4 Flannel subnet 10.1.67.1/24<br/>kubernetes-worker/1 active idle 2 192.168.23.5 80/tcp,443/tcp Kubernetes worker running.<br/> flannel/2 active idle 192.168.23.5 Flannel subnet 10.1.100.1/24<br/>kubernetes-worker/2 active idle 3 192.168.23.7 80/tcp,443/tcp Kubernetes worker running.<br/> flannel/3 active idle 192.168.23.7 Flannel subnet 10.1.14.1/24<br/>kubernetes-worker/3 active idle 4 192.168.23.6 80/tcp,443/tcp Kubernetes worker running.<br/> flannel/4 active idle 192.168.23.6 Flannel subnet 10.1.83.1/24</span><span id="68a9" class="lx kg hu ms b fv na mx l my mz">MACHINE STATE DNS INS-ID SERIES AZ<br/>0 started 192.168.23.3 4y3h8x xenial default<br/>1 started 192.168.23.4 4y3h8y xenial default<br/>2 started 192.168.23.5 4y3ha3 xenial default<br/>3 started 192.168.23.7 4y3ha6 xenial default<br/>4 started 192.168.23.6 4y3ha4 xenial default</span></pre><p id="fcdb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们现在需要kubectl来查询集群。我们需要把这个k8s问题和Hypriot OS的方法联系起来</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="262a" class="lx kg hu ms b fv mw mx l my mz">$ curl -s <a class="ae jp" href="https://packages.cloud.google.com/apt/doc/apt-key.gpg" rel="noopener ugc nofollow" target="_blank">https://packages.cloud.google.com/apt/doc/apt-key.gpg</a> | apt-key add -<br/>$ cat &lt;&lt;EOF &gt; /etc/apt/sources.list.d/kubernetes.list<br/>deb <a class="ae jp" href="http://apt.kubernetes.io/" rel="noopener ugc nofollow" target="_blank">http://apt.kubernetes.io/</a> kubernetes-xenial main<br/>EOF<br/>$ apt-get update<br/>$ apt-get install -y kubectl</span><span id="96fd" class="lx kg hu ms b fv na mx l my mz">$ kubectl get nodes — show-labels<br/>NAME STATUS AGE LABELS<br/>node02 Ready 1h beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=node02<br/>node03 Ready 1h beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=node03<br/>node04 Ready 57m beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=node04<br/>node05 Ready 58m beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=node05</span></pre><h2 id="1eec" class="lx kg hu bd kh ly lz ma kl mb mc md kp jc me mf kt jg mg mh kx jk mi mj lb mk dt translated">添加CUDA</h2><p id="27bb" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">CUDA还没有正式的魅力，所以我写了一个hacky bash脚本让它工作，你可以在<a class="ae jp" href="https://github.com/SaMnCo/layer-nvidia-cuda" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到</p><p id="2f2d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要建立魅力，你需要一台x86计算机，而不是Rpi。你将需要juju，魅力和魅力工具安装在那里，然后运行</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="d8da" class="lx kg hu ms b fv mw mx l my mz">$ export JUJU_REPOSITORY=${HOME}/charms<br/>$ export LAYER_PATH=${JUJU_REPOSITORY}/layers<br/>$ export INTERFACE_PATH=${JUJU_REPOSITORY}/interfaces</span><span id="0ae7" class="lx kg hu ms b fv na mx l my mz">$ cd ${LAYER_PATH}<br/>$ git clone <a class="ae jp" href="https://github.com/SaMnCo/layer-nvidia-cuda" rel="noopener ugc nofollow" target="_blank">https://github.com/SaMnCo/layer-nvidia-cuda</a> cuda<br/>$ cd juju-layer-cuda<br/>$ charm build</span></pre><p id="2627" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将在JUJU_REPOSITORY中创建一个名为<strong class="it hv"> builds </strong>的新文件夹，并在那里创建另一个名为cuda的文件夹。只需将它scp到你家<strong class="it hv"> charms </strong>子文件夹中的树莓Pi中。</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="6678" class="lx kg hu ms b fv mw mx l my mz">$ scp ${JUJU_REPOSITORY}/builds/cuda ${USER}<a class="ae jp" href="http://twitter.com/raspberrypi" rel="noopener ugc nofollow" target="_blank">@raspberrypi</a>:/home/${USER}/charms/cuda<br/>$ git clone <a class="ae jp" href="https://github.com/SaMnCo/layer-nvidia-cuda" rel="noopener ugc nofollow" target="_blank">https://github.com/SaMnCo/layer-nvidia-cuda</a> cuda<br/>$ cd juju-layer-cuda<br/>$ charm build</span></pre><p id="a4b8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">来展示我们刚刚创造的魅力，</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="518a" class="lx kg hu ms b fv mw mx l my mz">$ juju deploy — series xenial $HOME/charms/cuda<br/>$ juju add-relation cuda kubernetes-worker</span></pre><p id="733f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将需要一些时间(CUDA下载千兆字节的代码和二进制文件…)，但最终我们会</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="f1e0" class="lx kg hu ms b fv mw mx l my mz">$ juju status<br/>MODEL CONTROLLER CLOUD/REGION VERSION<br/>default maas-controller maas 2.0-beta15</span><span id="a838" class="lx kg hu ms b fv na mx l my mz">APP VERSION STATUS EXPOSED ORIGIN CHARM REV OS<br/>cuda false local cuda 0 ubuntu<br/>easyrsa 3.0.1 active false jujucharms easyrsa 3 ubuntu<br/>etcd 2.2.5 active false jujucharms etcd 14 ubuntu<br/>flannel 0.6.1 false jujucharms flannel 5 ubuntu<br/>kubernetes-master 1.4.5 active true jujucharms kubernetes-master 6 ubuntu<br/>kubernetes-worker 1.4.5 active true jujucharms kubernetes-worker 8 ubuntu</span><span id="e803" class="lx kg hu ms b fv na mx l my mz">RELATION PROVIDES CONSUMES TYPE<br/>juju-info cuda kubernetes-worker regular<br/>certificates easyrsa kubernetes-master regular<br/>certificates easyrsa kubernetes-worker regular<br/>cluster etcd etcd peer<br/>etcd etcd flannel regular<br/>etcd etcd kubernetes-master regular<br/>sdn-plugin flannel kubernetes-master regular<br/>sdn-plugin flannel kubernetes-worker regular<br/>host kubernetes-master flannel subordinate<br/>kube-dns kubernetes-master kubernetes-worker regular<br/>juju-info kubernetes-worker cuda subordinate<br/>host kubernetes-worker flannel subordinate</span><span id="5144" class="lx kg hu ms b fv na mx l my mz">UNIT WORKLOAD AGENT MACHINE PUBLIC-ADDRESS PORTS MESSAGE<br/>easyrsa/0 active idle 0 192.168.23.3 Certificate Authority connected.<br/>etcd/0 active idle 0 192.168.23.3 2379/tcp Healthy with 1 known peers. (leader)<br/>kubernetes-master/0 active idle 0 192.168.23.3 6443/tcp Kubernetes master running.<br/> flannel/0 active idle 192.168.23.3 Flannel subnet 10.1.57.1/24<br/>kubernetes-worker/0 active idle 1 192.168.23.4 80/tcp,443/tcp Kubernetes worker running.<br/> cuda/2 active idle 192.168.23.4 CUDA installed and available<br/> flannel/1 active idle 192.168.23.4 Flannel subnet 10.1.67.1/24<br/>kubernetes-worker/1 active idle 2 192.168.23.5 80/tcp,443/tcp Kubernetes worker running.<br/> cuda/0 active idle 192.168.23.5 CUDA installed and available<br/> flannel/2 active idle 192.168.23.5 Flannel subnet 10.1.100.1/24<br/>kubernetes-worker/2 active idle 3 192.168.23.7 80/tcp,443/tcp Kubernetes worker running.<br/> cuda/3 active idle 192.168.23.7 CUDA installed and available<br/> flannel/3 active idle 192.168.23.7 Flannel subnet 10.1.14.1/24<br/>kubernetes-worker/3 active idle 4 192.168.23.6 80/tcp,443/tcp Kubernetes worker running.<br/> cuda/1 active idle 192.168.23.6 CUDA installed and available<br/> flannel/4 active idle 192.168.23.6 Flannel subnet 10.1.83.1/24</span><span id="1cef" class="lx kg hu ms b fv na mx l my mz">MACHINE STATE DNS INS-ID SERIES AZ<br/>0 started 192.168.23.3 4y3h8x xenial default<br/>1 started 192.168.23.4 4y3h8y xenial default<br/>2 started 192.168.23.5 4y3ha3 xenial default<br/>3 started 192.168.23.7 4y3ha6 xenial default<br/>4 started 192.168.23.6 4y3ha4 xenial default</span></pre><p id="0840" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">太棒了，我们现在有了<strong class="it hv"> CUDERNETES </strong>！</p><p id="0297" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们可以在每个GPU节点上单独连接并运行</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="2747" class="lx kg hu ms b fv mw mx l my mz">$ sudo nvidia-smi <br/>Wed Nov 9 06:06:44 2016 <br/>+ — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -+<br/>| NVIDIA-SMI 367.57 Driver Version: 367.57 |<br/>| — — — — — — — — — — — — — — — -+ — — — — — — — — — — — + — — — — — — — — — — — +<br/>| GPU Name Persistence-M| Bus-Id Disp.A | Volatile Uncorr. ECC |<br/>| Fan Temp Perf Pwr:Usage/Cap| Memory-Usage | GPU-Util Compute M. |<br/>|===============================+======================+======================|<br/>| 0 GeForce GTX 106… Off | 0000:02:00.0 Off | N/A |<br/>| 28% 31C P0 27W / 120W | 0MiB / 6072MiB | 0% Default |<br/>+ — — — — — — — — — — — — — — — -+ — — — — — — — — — — — + — — — — — — — — — — — +<br/> <br/>+ — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -+<br/>| Processes: GPU Memory |<br/>| GPU PID Type Process name Usage |<br/>|=============================================================================|<br/>| No running processes found |<br/>+ — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -+</span></pre><p id="1329" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">干得好！！</p><h1 id="5bbc" class="kf kg hu bd kh ki nb kk kl km nc ko kp kq nd ks kt ku ne kw kx ky nf la lb lc dt translated">在Kubernetes中启用CUDA</h1><p id="ae02" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">默认情况下，当在workers上启动API服务器和Kubelet时，CDK不会激活GPU。我们需要手动完成这项工作(尽管这在路线图上)</p><h2 id="6f3f" class="lx kg hu bd kh ly lz ma kl mb mc md kp jc me mf kt jg mg mh kx jk mi mj lb mk dt translated">主更新</h2><p id="2411" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">在主节点上，更新<strong class="it hv">/etc/default/kube-API server</strong>以添加:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="0400" class="lx kg hu ms b fv mw mx l my mz"># Security Context<br/>KUBE_ALLOW_PRIV=” — allow-privileged=true”</span></pre><p id="a709" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后通过以下方式重新启动API服务</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="e20b" class="lx kg hu ms b fv mw mx l my mz">$ sudo systemctl restart kube-apiserver</span></pre><p id="ec2a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以现在Kube API将接受运行特权容器的请求，这是GPU工作负载所需要的。</p><h2 id="2834" class="lx kg hu bd kh ly lz ma kl mb mc md kp jc me mf kt jg mg mh kx jk mi mj lb mk dt translated">工作节点</h2><p id="46e7" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">在每个worker上，<strong class="it hv"> /etc/default/kubelet </strong>来添加GPU标签，所以看起来像:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="a6c8" class="lx kg hu ms b fv mw mx l my mz"># Security Context<br/>KUBE_ALLOW_PRIV=” — allow-privileged=true”</span><span id="5ecf" class="lx kg hu ms b fv na mx l my mz"># Add your own!<br/>KUBELET_ARGS=” — experimental-nvidia-gpus=1 — require-kubeconfig — kubeconfig=/srv/kubernetes/config — cluster-dns=10.1.0.10 — cluster-domain=cluster.local”</span></pre><p id="93be" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后通过以下方式重新启动服务</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="8e52" class="lx kg hu ms b fv mw mx l my mz">$ sudo systemctl restart kubelet</span></pre><h1 id="ad51" class="kf kg hu bd kh ki nb kk kl km nc ko kp kq nd ks kt ku ne kw kx ky nf la lb lc dt translated">测试设置</h1><p id="4a1f" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">现在我们已经在k8s中启用了CUDA GPUs，让我们测试一下是否一切正常。我们采取了一个非常简单的工作，只是从一个pod运行nvidia-smi，并在成功时退出。</p><p id="ed51" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">工作定义是</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="23a0" class="lx kg hu ms b fv mw mx l my mz">apiVersion: batch/v1<br/>kind: Job<br/>metadata:<br/> name: nvidia-smi<br/> labels:<br/> name: nvidia-smi<br/>spec:<br/> template:<br/> metadata:<br/> labels:<br/> name: nvidia-smi<br/> spec:<br/> containers:<br/> — name: nvidia-smi<br/> image: nvidia/cuda<br/> command: [ “nvidia-smi” ]<br/> imagePullPolicy: IfNotPresent<br/> securityContext:<br/> privileged: true<br/> resources:<br/> requests:<br/> alpha.kubernetes.io/nvidia-gpu: 1 <br/> limits:<br/> alpha.kubernetes.io/nvidia-gpu: 1 <br/> volumeMounts:<br/> — mountPath: /dev/nvidia0<br/> name: nvidia0<br/> — mountPath: /dev/nvidiactl<br/> name: nvidiactl<br/> — mountPath: /dev/nvidia-uvm<br/> name: nvidia-uvm<br/> — mountPath: /usr/local/nvidia/bin<br/> name: bin<br/> — mountPath: /usr/lib/nvidia<br/> name: lib<br/> volumes:<br/> — name: nvidia0<br/> hostPath: <br/> path: /dev/nvidia0<br/> — name: nvidiactl<br/> hostPath: <br/> path: /dev/nvidiactl<br/> — name: nvidia-uvm<br/> hostPath: <br/> path: /dev/nvidia-uvm<br/> — name: bin<br/> hostPath: <br/> path: /usr/lib/nvidia-367/bin<br/> — name: lib<br/> hostPath: <br/> path: /usr/lib/nvidia-367<br/> restartPolicy: Never</span></pre><p id="d292" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有趣的是</p><ul class=""><li id="8e15" class="li lj hu it b iu iv iy iz jc lk jg ll jk lm jo ln lo lp lq dt translated">我们没有nvidia-docker提供的抽象，所以我们必须手动指定char设备的挂载点</li><li id="a164" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated">我们还需要共享驱动程序和libs文件夹</li><li id="3384" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated">在资源中，我们必须用1个GPU来请求和限制资源</li><li id="943d" class="li lj hu it b iu lr iy ls jc lt jg lu jk lv jo ln lo lp lq dt translated">容器必须在特权下运行</li></ul><p id="aa78" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果我们运行这个:</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="680c" class="lx kg hu ms b fv mw mx l my mz">$ kubectl create -f nvidia-smi-job.yaml<br/>$ # Wait for a few seconds so the cluster can download and run the container<br/>$ kubectl get pods -a -o wide<br/>NAME READY STATUS RESTARTS AGE IP NODE<br/>default-http-backend-8lyre 1/1 Running 0 11h 10.1.67.2 node02<br/>nginx-ingress-controller-bjplg 1/1 Running 1 10h 10.1.83.2 node04<br/>nginx-ingress-controller-etalt 0/1 Pending 0 6m &lt;none&gt; <br/>nginx-ingress-controller-q2eiz 1/1 Running 0 10h 10.1.14.2 node05<br/>nginx-ingress-controller-ulsbp 1/1 Running 0 11h 10.1.67.3 node02<br/>nvidia-smi-xjl6y 0/1 Completed 0 5m 10.1.14.3 node05</span></pre><p id="5401" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们看到最后一个容器已经运行并完成。让我们看看运行的输出</p><pre class="jr js jt ju fq mr ms mt mu aw mv dt"><span id="4a56" class="lx kg hu ms b fv mw mx l my mz">$ kubectl logs nvidia-smi-xjl6y<br/>Wed Nov 9 07:52:42 2016 <br/>+ — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -+<br/>| NVIDIA-SMI 367.57 Driver Version: 367.57 |<br/>| — — — — — — — — — — — — — — — -+ — — — — — — — — — — — + — — — — — — — — — — — +<br/>| GPU Name Persistence-M| Bus-Id Disp.A | Volatile Uncorr. ECC |<br/>| Fan Temp Perf Pwr:Usage/Cap| Memory-Usage | GPU-Util Compute M. |<br/>|===============================+======================+======================|<br/>| 0 GeForce GTX 106… Off | 0000:02:00.0 Off | N/A |<br/>| 28% 33C P0 29W / 120W | 0MiB / 6072MiB | 0% Default |<br/>+ — — — — — — — — — — — — — — — -+ — — — — — — — — — — — + — — — — — — — — — — — +<br/> <br/>+ — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -+<br/>| Processes: GPU Memory |<br/>| GPU PID Type Process name Usage |<br/>|=============================================================================|<br/>| No running processes found |<br/>+ — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — — -+</span></pre><p id="e37d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">完美，我们有相同的结果，就像我们从主机上运行nvidia-smi一样，这意味着我们都很好地操作GPU！</p></div><div class="ab cl jy jz hc ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hn ho hp hq hr"><h1 id="860a" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">结论</h1><p id="3a23" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">那么，我们在这里取得了什么成就呢？Kubernetes是最通用的集装箱管理系统。它还与Tensorflow共享一些基因，tensor flow本身经常以向外扩展的方式演示为容器。</p><p id="df60" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过大规模添加GPU来加快深度学习工作量是很自然的事情。这个穷人GPU集群是一个例子，说明了如果R&amp;D的一个小团队想要尝试多节点可扩展性，他们可以做些什么。</p><p id="1b01" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们还有第二个好处。你注意到k8s的部署在这里是完全自动化的(除了GPU包含)，这要感谢Juju和CDK背后的团队。嗯，Juju背后的社区创造了许多魅力，并且有大量可以大规模部署的横向扩展应用程序，如Hadoop、Kafka、Spark、Elasticsearch (…)。</p><p id="ad84" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最终，投资只是MAAS和几个命令。Juju在R&amp;D的投资回报率是几天的事。</p><h1 id="ec77" class="kf kg hu bd kh ki nb kk kl km nc ko kp kq nd ks kt ku ne kw kx ky nf la lb lc dt translated">谢谢</h1><p id="7bf7" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">非常感谢Canonical的Marco Ceppi、Chuck Butler和Matt Bruzek对CDK的出色工作，以及对我(众多)问题的回应。</p><div class="jr js jt ju fq ab cb"><figure class="np jv nq nr ns nt nu paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="np jv nq nr ns nt nu paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="np jv nq nr ns nt nu paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="nv nw nx"><p id="f922" class="ir is ny it b iu iv iw ix iy iz ja jb nz jd je jf oa jh ji jj ob jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is ny it b iu iv iw ix iy iz ja jb nz jd je jf oa jh ji jj ob jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="fe ff oc"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="od oe l"/></div></figure></div></div>    
</body>
</html>