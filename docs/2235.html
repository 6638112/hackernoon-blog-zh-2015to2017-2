<html>
<head>
<title>Execute millions of SQL statements in milliseconds in the browser with WebAssembly and Web Workers.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用WebAssembly和Web Workers在浏览器中以毫秒为单位执行数百万条SQL语句。</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/execute-millions-of-sql-statements-in-milliseconds-in-the-browser-with-webassembly-and-web-workers-3e0b25c3f1a6?source=collection_archive---------2-----------------------#2017-01-14">https://medium.com/hackernoon/execute-millions-of-sql-statements-in-milliseconds-in-the-browser-with-webassembly-and-web-workers-3e0b25c3f1a6?source=collection_archive---------2-----------------------#2017-01-14</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="990c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是一个相当长的标题，但希望它能引起你的注意！</p><p id="73ec" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我一直着迷于在<a class="ae jp" href="https://hackernoon.com/tagged/browser" rel="noopener ugc nofollow" target="_blank">浏览器</a>中，HTML和<a class="ae jp" href="https://hackernoon.com/tagged/javascript" rel="noopener ugc nofollow" target="_blank"> JavaScript </a>能实现什么。浏览器供应商在JavaScript性能方面所做的惊人工作是不可思议的。随着Chrome V8、微软Chakra、Mozilla SpiderMonkey和苹果JavaScriptCore的每一次迭代，JavaScript性能都缩小了与原生代码执行的差距。</p><p id="a06c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">web assembly(【http://webassembly.org/】T4)是最新的创新，让我们离在浏览器中执行真正的本地代码又近了一步。我想看看我们已经走了多远，所以我拼凑了一个测试真实代码库的例子，在这个例子中，是Sqlite数据库—<a class="ae jp" href="http://sqlite.org/" rel="noopener ugc nofollow" target="_blank">http://sqlite.org/</a>。在我的测试中，我使用了这里找到的Emscripten编译版SQLite—<a class="ae jp" href="https://github.com/kripken/sql.js/" rel="noopener ugc nofollow" target="_blank">https://github.com/kripken/sql.js/</a>。</p><p id="dd0e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我的测试使用的是最新版本的Chrome Canary，下面的标志设置为enabled:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="5c4d" class="jz ka hu jv b fv kb kc l kd ke">chrome://flags/#enable-webassembly</span></pre><p id="bb8b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我的测试机器是一台戴尔XPS台式机，配备:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="193e" class="jz ka hu jv b fv kb kc l kd ke">Processor Intel(R) Core(TM) i7–4770 CPU @ 3.40GHz, 3401 Mhz, 4 Core(s), 8 Logical Processor(s)</span><span id="5807" class="jz ka hu jv b fv kf kc l kd ke">24 Gigs of RAM<br/>256 SSD Drive</span></pre><p id="ccc1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我创建了2个文件，主要的index.html</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="34b6" class="jz ka hu jv b fv kb kc l kd ke">&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;WebAssembly Test&lt;/title&gt;<br/>&lt;script&gt;</span><span id="9942" class="jz ka hu jv b fv kf kc l kd ke">var aListeners = [];<br/> var results=[];<br/> var times=[];<br/> var workers=[];<br/> <br/> //load up our workers<br/> for(var i=0;i&lt;8;i++){<br/>  workers[i]=new Worker("worker.js");<br/>  workers[i].onmessage = function (oEvent) {<br/>   if (aListeners[oEvent.data.id]) { aListeners[oEvent.data.id](oEvent.data.evaluated,this); }<br/>   delete aListeners[oEvent.data.id];<br/>    };<br/> }</span><span id="33c8" class="jz ka hu jv b fv kf kc l kd ke">function getRandomWorker(arr) {<br/>  return arr[Math.floor(Math.random()*arr.length)];<br/> }<br/> <br/> var asyncEval = (function () {<br/>   return function (worker, sCode, fListener) {<br/>  aListeners.push(fListener || null);<br/>  worker.postMessage({<br/>    "id": aListeners.length - 1,<br/>    "code": sCode<br/>  });<br/>   };</span><span id="a2b0" class="jz ka hu jv b fv kf kc l kd ke">})();</span><span id="2517" class="jz ka hu jv b fv kf kc l kd ke">//Our test function<br/> function test(numReq,code) {<br/>  console.time("Total_Elapsed");<br/>  times=[];<br/>  results=[];<br/>  times.push((new Date()).valueOf());<br/>  var num=numReq || 10000;<br/>  for(var i=0;i&lt;num;i++) {<br/>     asyncEval(getRandomWorker(workers),code || "Date()", function (result,worker) {<br/>   times.push((new Date()).valueOf());<br/>   results.push(result);<br/>   if(results.length==num) {<br/>    console.timeEnd("Total_Elapsed");<br/>    console.log("Processing Time for all workers: "+(parseInt(times[times.length-1])-parseInt(times[0])).toString()+"ms");<br/>    var numRequests=results.length*parseInt(results[0].split(": ")[1]);<br/>    console.log("Total sql statements processed: "+numRequests);<br/>   }<br/>  });<br/>  };<br/>  return "Executing test ...";<br/>}<br/>&lt;/script&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>Press F12 to view console<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="b93b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">和Web Worker脚本worker.js</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="371c" class="jz ka hu jv b fv kb kc l kd ke">importScripts("sql.js");</span><span id="4555" class="jz ka hu jv b fv kf kc l kd ke">//Init sqlite database<br/>var db = new SQL.Database();</span><span id="47c7" class="jz ka hu jv b fv kf kc l kd ke">//Our test function<br/>var run_sql=function(numReq,sql) {<br/> var n=numReq || 10000;<br/> var results=[];<br/> var elapsed=0;<br/> var stmt = db.prepare(sql || "select datetime() as dt;");<br/> <br/> var start = (new Date()).getTime(); <br/> for(var i=0;i&lt;n;i++) {<br/>  var rows = stmt.getAsObject({});<br/>  results.push(rows);<br/>  if(results.length==n) {<br/>      var end = (new Date()).getTime();<br/>   elapsed="Elapsed sql statement:"+(end-start).toString()+" ms #Rows: "+results.length.toString();<br/>  }<br/> }<br/> stmt.free();<br/> <br/> return elapsed;<br/>}</span><span id="be7f" class="jz ka hu jv b fv kf kc l kd ke">//Run code to init JIT compilation<br/>run_sql();</span><span id="46ce" class="jz ka hu jv b fv kf kc l kd ke">//Message Handler<br/>onmessage = function (oEvent) {<br/> postMessage({<br/>  "id": oEvent.data.id,<br/>  "evaluated": process(oEvent.data.code) <br/> });<br/>}</span><span id="342b" class="jz ka hu jv b fv kf kc l kd ke">function process(code) {<br/> var result=null;<br/> try {<br/>  result=eval(code);<br/>  <br/> }<br/> catch(e)<br/> {<br/>  result = "Error: "+e.message;<br/> }<br/> return result;<br/>}</span></pre><p id="6e0c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要运行测试，您需要在一个web服务器上托管三个文件，<strong class="it hv"> <em class="kg">、worker.js和sql.js </em> </strong>。我在我的Window的机器上使用IIS，但是任何操作系统上的任何静态web服务器都可以。</p><p id="3ccc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当您第一次加载index.html时，您会得到一条简单的消息，告诉您在浏览器中访问开发工具。在我的机器上，它看起来像这样</p><figure class="jq jr js jt fq ki fe ff paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="fe ff kh"><img src="../Images/3f39ff383aca1cd2086fbec6ac89482f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k6hBa2igu7hH7B2T7vzfWw.png"/></div></div></figure><p id="0d6a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你会注意到的第一件事是Chrome的工作人员负责将sql.js转换成WebAssembly。所有这些如何工作的细节超出了本文的范围，但是您可以在这里找到更多信息:</p><p id="9973" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://github.com/kripken/sql.js" rel="noopener ugc nofollow" target="_blank">https://github.com/kripken/sql.js</a></p><p id="a22c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">还有这里</p><div class="kp kq fm fo kr ks"><a href="http://webassembly.org/getting-started/developers-guide/" rel="noopener  ugc nofollow" target="_blank"><div class="kt ab ej"><div class="ku ab kv cl cj kw"><h2 class="bd hv fv z el kx eo ep ky er et ht dt translated">开发者指南- WebAssembly</h2><div class="kz l"><h3 class="bd b fv z el kx eo ep ky er et ek translated">为了编译成WebAssembly，我们现在需要从源代码编译LLVM。需要以下工具作为…</h3></div><div class="la l"><p class="bd b gc z el kx eo ep ky er et ek translated">webassembly.org</p></div></div></div></a></div><p id="005d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了运行我们的第一个测试，我们在开发人员控制台中键入以下内容:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="e485" class="jz ka hu jv b fv kb kc l kd ke">test(1,"run_sql(1000,'select datetime() as dt;')")</span></pre><p id="7384" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将执行SQL语句<strong class="it hv"><em class="kg">‘select datetime()as dt；’</em> </strong>在一个Web Worker内循环1000次。我的机器上的结果如下:</p><figure class="jq jr js jt fq ki fe ff paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="fe ff kh"><img src="../Images/9b8b9c378ee493c6238d9c84f9d470f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fZek6RtlJ1FIy2S9vpNMmA.png"/></div></div></figure><p id="62bc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以我们在8.29毫秒内处理了1000个SQL请求。</p><p id="cbc3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们在一个web worker中尝试10，000个SQL请求:</p><figure class="jq jr js jt fq ki fe ff paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="fe ff kh"><img src="../Images/28440c72c4f22b35b58fcfc5d9909e0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ctU9dvFo7vq_EKTMAS_nVw.png"/></div></div></figure><p id="b20c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，我们在67毫秒内处理了10，000个SQL请求。因为我的机器上有8个内核，所以我配置了8个web worker，所以让我们在这些web worker之间再次运行测试:</p><figure class="jq jr js jt fq ki fe ff paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="fe ff kh"><img src="../Images/30c5d99763b3dbe921325940c4c1285d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UMvGV91qvnzCuraE9A46zw.png"/></div></div></figure><p id="6d8a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，使用web workers，我们可以在大约一半的时间内处理10，000个SQL请求。</p><p id="d018" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">100，000个SQL请求怎么样:</p><figure class="jq jr js jt fq ki fe ff paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="fe ff kh"><img src="../Images/dffe7ae01a7bb3ca0da38580a3eda139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y4L8ffVxjQwlhK5DXpcI0g.png"/></div></div></figure><p id="3d15" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不算太坏，100，000个SQL请求用了大约211毫秒。</p><p id="fe78" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">文章的标题谈到在几秒钟内处理数百万个SQL请求，所以让我们对1，000，000个SQL请求进行测试:</p><figure class="jq jr js jt fq ki fe ff paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="fe ff kh"><img src="../Images/24b9464660576cbebf1b8390a2691932.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*882qxyfqd-91xPSrAOXaZw.png"/></div></div></figure><p id="b43e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我的机器上，需要</p><h1 id="d45b" class="lb ka hu bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">~ <strong class="ak"> 2秒钟运行一百万条SQL select语句！</strong></h1><p id="e74b" class="pw-post-body-paragraph ir is hu it b iu ly iw ix iy lz ja jb jc ma je jf jg mb ji jj jk mc jm jn jo hn dt translated">数据库插入怎么样？以下代码将一百万条记录插入SQL表中:</p><figure class="jq jr js jt fq ki fe ff paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="fe ff md"><img src="../Images/b371278d365ac15afef164ce99f01e3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zG6V24zeXm2XAPc4zirC4A.png"/></div></div></figure><p id="c1a5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以…</p><h1 id="c8c7" class="lb ka hu bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">在一个表中插入一百万行大约需要2.2秒</h1><p id="df8c" class="pw-post-body-paragraph ir is hu it b iu ly iw ix iy lz ja jb jc ma je jf jg mb ji jj jk mc jm jn jo hn dt translated">这真是令人印象深刻，而WebAssembly才刚刚起步。</p><p id="52a0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">显然，这些测试非常简单，根据您的SQL应用程序的性质，您的结果可能会有所不同。然而，它确实说明了我们在浏览器中的原始JavaScript性能方面取得了多大的进步。</p><p id="4626" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我很想听到你的反馈，所以请向你的关注者推荐这篇文章:-)</p><div class="jq jr js jt fq ab cb"><figure class="me ki mf mg mh mi mj paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="me ki mf mg mh mi mj paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="me ki mf mg mh mi mj paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mk ml mm"><p id="f922" class="ir is kg it b iu iv iw ix iy iz ja jb mn jd je jf mo jh ji jj mp jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is kg it b iu iv iw ix iy iz ja jb mn jd je jf mo jh ji jj mp jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jq jr js jt fq ki fe ff paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="fe ff mq"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="jq jr js jt fq ki"><div class="bz el l di"><div class="mr ms l"/></div></figure></div></div>    
</body>
</html>