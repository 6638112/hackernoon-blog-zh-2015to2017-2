<html>
<head>
<title>Node.js streams in action</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js流的作用</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/node-js-streams-in-action-1495c22fafec?source=collection_archive---------15-----------------------#2017-04-17">https://medium.com/hackernoon/node-js-streams-in-action-1495c22fafec?source=collection_archive---------15-----------------------#2017-04-17</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="0971" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本文展示了如何将<a class="ae jp" href="https://hackernoon.com/tagged/nodejs" rel="noopener ugc nofollow" target="_blank"> Node.js </a> <a class="ae jp" href="https://nodejs.org/api/stream.html" rel="noopener ugc nofollow" target="_blank"> Stream </a>和一点反应式<a class="ae jp" href="https://hackernoon.com/tagged/programming" rel="noopener ugc nofollow" target="_blank">编程</a>应用到一个真实的(tm)问题中。这篇文章旨在高度实用，面向中级读者。我有意省略了一些基本的解释。如果你错过了什么，试着检查一下<a class="ae jp" href="https://nodejs.org/api/stream.html" rel="noopener ugc nofollow" target="_blank"> API文档</a>或者它的复述(例如:<a class="ae jp" href="https://github.com/substack/stream-handbook" rel="noopener ugc nofollow" target="_blank">这个</a>)</p><p id="f1cd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以，让我们从问题描述开始。我们需要实现一个简单的web scraper，它从一些REST API获取所有数据，以某种方式处理数据并插入到我们的数据库中。为了简单起见，我省略了关于实际数据库和REST API的细节(在现实生活中，它是一些旅行费用聚合网站和Pg数据库的API)</p><p id="6e32" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">假设我们有两个函数(IO模拟器函数的代码，另一个商品代码是<a class="ae jp" href="https://gist.github.com/kharandziuk/e823707bf71fba9a4cdf944216773f58" rel="noopener ugc nofollow" target="_blank">，这里是</a>):</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="jv jw l"/></div></figure><p id="87d8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于本文，我们将忽略可能出现的错误。也许我会在下一篇文章中描述它。</p><p id="8001" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对数据处理也有一些要求。假设我们需要删除id中包含数字3的所有项目。我们需要用当前时间戳扩展id包含数字9的所有条目(例如:<code class="eh jx jy jz ka b">{id: 9} -&gt; {id: 9, timestamp: 1490571732068}</code>)。这些需求很傻，但与真实的web抓取器中出现的真实需求相似</p><p id="31f4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">是时候动手了！一些简单的实现可能是这样的:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="jv jw l"/></div></figure><p id="ce21" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这样的代码有什么问题？</p><ol class=""><li id="9e57" class="kb kc hu it b iu iv iy iz jc kd jg ke jk kf jo kg kh ki kj dt translated">乍一看，很难理解这些代码是干什么的。我们可以用一些注释来改进它，但是最好在代码中表明我们在一个地方读取，在另一个地方编写。</li><li id="c2ed" class="kb kc hu it b iu kk iy kl jc km jg kn jk ko jo kg kh ki kj dt translated">太具体了。很难编写一些逻辑来处理这些值。我们如何将处理逻辑从I/O逻辑中分离出来？</li><li id="ec8f" class="kb kc hu it b iu kk iy kl jc km jg kn jk ko jo kg kh ki kj dt translated">它不是有效的。我们的生产者一直等到消费者使用一部分数据，而不是缓冲一部分数据并一次写入所有数据。</li></ol><p id="9223" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，您可能已经猜到有一种更好的方法来解决节点流的这个问题。让我们把问题分成三部分:输入、输出和处理。</p><p id="e492" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，我们的可读流可以是这样的:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="jv jw l"/></div></figure><p id="5f0b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">看起来有点重，但这是一个标准接口。作为一个数据块，我们将使用一个包含一千个条目的列表。这里重要的事情是<code class="eh jx jy jz ka b">objectMode: true</code>——我们想要操作对象而不是二进制数据。</p><p id="891f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在是输出部分。我们需要实现可写的流。大概是这样的:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="jv jw l"/></div></figure><p id="a71f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里有一些重要的信息:</p><ol class=""><li id="af43" class="kb kc hu it b iu iv iy iz jc kd jg ke jk kf jo kg kh ki kj dt translated"><code class="eh jx jy jz ka b">objectMode</code> —我们想要操作对象</li><li id="03d4" class="kb kc hu it b iu kk iy kl jc km jg kn jk ko jo kg kh ki kj dt translated"><code class="eh jx jy jz ka b">highWaterMark</code> —我们的缓冲区的大小…以对象为单位。你应该小心使用它，因为数量和字节的实际大小之间没有直接的联系。在我们的例子中，一个对象是一个有一定大小的列表</li><li id="cb47" class="kb kc hu it b iu kk iy kl jc km jg kn jk ko jo kg kh ki kj dt translated"><code class="eh jx jy jz ka b">_writev</code> —“解释”它应该如何一次从一个缓冲区写入多个块。</li></ol><p id="cb51" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们可以把它们联系起来:</p><p id="3555" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://gist.github.com/9e3174a05adb55a5fbb750b5e972bc0e" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/9e3174a05adb55a5fbb750b5e972bc0e</a></p><p id="9fe3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我看来，代码不需要任何注释。我们显示数据流，隐藏实现的细节，直到你问。而且，它绝对有效:</p><ol class=""><li id="4213" class="kb kc hu it b iu iv iy iz jc kd jg ke jk kf jo kg kh ki kj dt translated">它不会阻塞事件循环</li><li id="751d" class="kb kc hu it b iu kk iy kl jc km jg kn jk ko jo kg kh ki kj dt translated">它广泛使用标准库原语。它们应该是有效的</li><li id="7166" class="kb kc hu it b iu kk iy kl jc km jg kn jk ko jo kg kh ki kj dt translated">它使用缓冲和背压</li></ol><p id="937b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于甜点，我们将实现数据处理。我们可以手动实现一个转换流，但是这并不有趣。我们将使用一个名为<a class="ae jp" href="http://highlandjs.org/" rel="noopener ugc nofollow" target="_blank"> Highland.js </a>的库，它使我们能够使用众所周知的函数式编程原语(。过滤器，。地图等。)随着我们的溪流。其实Highland.js比just大很多。地图和。过滤器但我不想静音的文章范围。因此，转换看起来像这样:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="jv jw l"/></div></figure><p id="a1bd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">与简单的JS列表非常相似。我们需要<code class="eh jx jy jz ka b">.flatten()</code>和<code class="eh jx jy jz ka b">.batchWithTimeOrCount(100, 1000)</code>，因为我们的流操作的是项目列表，而不是单个项目。</p><p id="8b46" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以，就这些了。希望这篇文章能给你一些学习Node Stream和Highland.js的动力</p><blockquote class="kp kq kr"><p id="b0e1" class="ir is ks it b iu iv iw ix iy iz ja jb kt jd je jf ku jh ji jj kv jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是阿妹家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="dca4" class="ir is ks it b iu iv iw ix iy iz ja jb kt jd je jf ku jh ji jj kv jl jm jn jo hn dt translated">要了解更多信息，<a class="ae jp" href="https://goo.gl/4ofytp" rel="noopener ugc nofollow" target="_blank">请阅读我们的“关于”页面</a> , <a class="ae jp" href="http://bit.ly/HackernoonFB" rel="noopener ugc nofollow" target="_blank">喜欢/在脸书给我们发消息</a>，或者简单地，<a class="ae jp" href="https://goo.gl/k7XYbx" rel="noopener ugc nofollow" target="_blank">发推文/DM @HackerNoon。</a></p><p id="708a" class="ir is ks it b iu iv iw ix iy iz ja jb kt jd je jf ku jh ji jj kv jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="kw jw l"/></div></figure></div></div>    
</body>
</html>