<html>
<head>
<title>Leaked “malware” OutlawCountry review</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">泄露的“恶意软件”超出国家审查范围</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/leaked-malware-outlawcountry-review-db14caf3c79e?source=collection_archive---------16-----------------------#2017-07-05">https://medium.com/hackernoon/leaked-malware-outlawcountry-review-db14caf3c79e?source=collection_archive---------16-----------------------#2017-07-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="9821" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本周，有一个来自某个安全机构的所谓“T1”泄漏报告，它被称为OC(outlawccountry)，我不知道它是否应该被称为恶意软件，因为公平地说，它真的不需要利用任何东西。</p><p id="7753" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">OC，它应该将您的一些或所有流量路由到一个特定的端点，但是问题是这个“<strong class="it hv">恶意软件</strong>”是预先打包在一个内核对象中的。<strong class="it hv"> ko </strong>)，一个内核模块！！</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/605c8b8ff48f1babc1efa8b5b4d20913.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ny7wGqUkP-NH6BGQreGIvg.png"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">oc kernel module</figcaption></figure><p id="f1f1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这有点令人难以置信，所以他们当然可以从内核模块、路由、iptables规则等做任何你想做的事情……但是为什么是内核模块呢？</p><p id="3017" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">嗯，我觉得这是一个很好的预打包和丢弃它的方法，但我也觉得这可能会失败，这取决于内核版本和编译标志等。</p><p id="259f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">所以我决定“重新创建”这个“恶意软件”可能在做什么。</strong></p><h2 id="b407" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated">OC详细信息:</h2><p id="064b" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">正如我们已经提到的，这是一个内核模块，理论上它创建了一个新的iptables“<strong class="it hv">表</strong>”。现在这不是一个新的链或新的规则或任何类似的东西，这是一个新的"<strong class="it hv">表</strong>"如过滤器、nat或mangle:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff lf"><img src="../Images/c98567bda1501785d4275419c634978c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dy4O-_FhmDbrhewMAQynYQ.png"/></div></div></figure><p id="6f22" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就是表“<strong class="it hv"> dpxvke8h18 </strong>”的名称，所以要查看这些规则，您需要执行以下操作:</p><pre class="jq jr js jt fq lg lh li lj aw lk dt"><span id="a09e" class="kf kg hu lh b fv ll lm l ln lo">iptables -nvL  -t dpxvke8h18 // iptables -S -t dpxvke8h18</span></pre><p id="7aac" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以我的一部分想法是把它放在一个不同的表中，对于一个管理员来说，知道这个表的存在，并且可能不会去查找这个表的附加规则，这有点困难。</p><h2 id="2a85" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated"><strong class="ak">表</strong>:</h2><p id="2891" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">内核iptables表是在编译时创建的，通常作为模块出现，例如，如果我们选择“mangle ”:</p><div class="lp lq fm fo lr ls"><a href="https://github.com/torvalds/linux/blob/master/net/ipv4/netfilter/iptable_mangle.c" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab ej"><div class="lu ab lv cl cj lw"><h2 class="bd hv fv z el lx eo ep ly er et ht dt translated">torvalds/linux</h2><div class="lz l"><h3 class="bd b fv z el lx eo ep ly er et ek translated">linux - Linux内核源代码树</h3></div><div class="ma l"><p class="bd b gc z el lx eo ep ly er et ek translated">github.com</p></div></div><div class="mb l"><div class="mc l md me mf mb mg jz ls"/></div></div></a></div><p id="89fd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">文件<strong class="it hv"> iptable_mangle.c </strong>，它本身就是一个内核模块:</p><div class="lp lq fm fo lr ls"><a href="https://github.com/torvalds/linux/blob/master/net/ipv4/netfilter/iptable_mangle.c#L154" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab ej"><div class="lu ab lv cl cj lw"><h2 class="bd hv fv z el lx eo ep ly er et ht dt translated">torvalds/linux</h2><div class="lz l"><h3 class="bd b fv z el lx eo ep ly er et ek translated">linux - Linux内核源代码树</h3></div><div class="ma l"><p class="bd b gc z el lx eo ep ly er et ek translated">github.com</p></div></div><div class="mb l"><div class="mh l md me mf mb mg jz ls"/></div></div></a></div><pre class="jq jr js jt fq lg lh li lj aw lk dt"><span id="9c5c" class="kf kg hu lh b fv ll lm l ln lo">module_init(iptable_mangle_init);<br/>module_exit(iptable_mangle_fini);</span></pre><p id="b7a4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">模块化有一个init和一个exit函数，这两个函数在exmaple的<strong class="it hv"> insmod/modprobe </strong>和rmmod上被调用。</p><p id="3e2e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> iptable_mangle </strong>在大多数系统中都是加载的，所以如果您这样做了:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mi"><img src="../Images/bc35ddf98f8b15dd71d14419ca05aae1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k5ybknfxnqfethkb3Dsvbg.png"/></div></div></figure><h2 id="a666" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated"><strong class="ak">新建表格:</strong></h2><p id="96ab" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">所以我真的不知道是否有办法从userland做到这一点，但是为了复制OC正在做的事情，我从<strong class="it hv">中复制了大部分数据，并更改了几个名字:</strong></p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mj mk l"/></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">nf_foobar.c</figcaption></figure><p id="a82e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，代码是不言自明的，即使您对内核开发一无所知，以下是最重要的函数:</p><pre class="jq jr js jt fq lg lh li lj aw lk dt"><span id="ac00" class="kf kg hu lh b fv ll lm l ln lo">repl = ipt_alloc_initial_table(&amp;packet_mangler);                               ret = ipt_register_table(net, &amp;packet_mangler, repl);</span></pre><p id="7ee3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们对表赋值，然后注册，记住struct net是"<strong class="it hv">网络</strong>/T30】命名空间 / <strong class="it hv">堆栈</strong>"我们附加了这个规则(init_net)。</p><div class="lp lq fm fo lr ls"><a href="https://hackernoon.com/the-network-stack-153c92e35b26" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab ej"><div class="lu ab lv cl cj lw"><h2 class="bd hv fv z el lx eo ep ly er et ht dt translated">网络堆栈</h2><div class="lz l"><h3 class="bd b fv z el lx eo ep ly er et ek translated">如果您一直在阅读关于Linux命名空间的文章/书籍，您可能会遇到各种各样的问题……</h3></div><div class="ma l"><p class="bd b gc z el lx eo ep ly er et ek translated">hackernoon.com</p></div></div><div class="mb l"><div class="ml l md me mf mb mg jz ls"/></div></div></a></div><p id="ba6f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以继续扩展它，并向它添加规则等，但我不会在本文中这样做。</p><h2 id="0479" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated">编译nf_foobar:</h2><p id="50a7" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">我正在创建一个makefile，它可以编译成. o文件。当然，当他们把这个放到powned服务器上时，他们并没有在适当的地方编译它们，可能只是把。ko并像加载winmodem的驱动程序一样加载它:)</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mj mk l"/></div></figure><h2 id="a59e" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated">加载并测试它:</h2><p id="2299" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">这就是没有mod的情况:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mm"><img src="../Images/622636b13e47157fbfb31b94170e45b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7cTOvWDTNbTmhU6bP7kdwQ.png"/></div></div></figure><p id="98c8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">很有道理，这也表明桌子是。ko，我们来编译和insmod:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mn"><img src="../Images/fce7f2e8200ba8cb3ff7fd43dae713b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sks2dRCVqAjykB3RERNjYQ.png"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">compiling my specific table</figcaption></figure><p id="ca38" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">预计会出现一些警告:)</p><pre class="jq jr js jt fq lg lh li lj aw lk dt"><span id="bf76" class="kf kg hu lh b fv ll lm l ln lo">insmod nf_foobar.ko</span></pre><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mo"><img src="../Images/920fe4b90a9db9898654e8c34e06ee25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BLKxQ02OS7HradTd2vTPZg.png"/></div></div></figure><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mp"><img src="../Images/b21f37a34c914111b7401ba09641cfa0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mjaVexSDM3L9lmtCG7dJGQ.png"/></div></div></figure><p id="ae6d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好了，好了，现在我们需要看看iptables中的表是否存在:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mq"><img src="../Images/1317db4d29e24ec9ab9efce86fa7ba68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XPlXxsR2IV5PqxCj_1-KfA.png"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">foobar table</figcaption></figure><p id="46f5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">很好，现在我们有了一个新的iptables“表”,您可以在其中添加规则，就像nat、mangle或filter一样。</p><p id="293e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，当您删除模块时，您可以避免取消注册表，这样在模块卸载后，表仍保留在那里；)</p><h2 id="e56b" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated">最后注释:</h2><p id="7372" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">就这样，我想我卑微的200名粉丝的问题是，你认为他们为什么决定使用这种交通工具。<strong class="it hv"> ko </strong>)而不是nft，或者不要给table mangle添加规则之类的东西，我也会考虑的。</p><p id="2534" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">谢谢大家！</p><div class="jq jr js jt fq ab cb"><figure class="mr ju ms mt mu mv mw paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mr ju ms mt mu mv mw paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mr ju ms mt mu mv mw paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mx my mz"><p id="f922" class="ir is na it b iu iv iw ix iy iz ja jb nb jd je jf nc jh ji jj nd jl jm jn jo hn dt translated"><a class="ae ne" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ne" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ne" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ne" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is na it b iu iv iw ix iy iz ja jb nb jd je jf nc jh ji jj nd jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ne" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ne" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff nf"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>