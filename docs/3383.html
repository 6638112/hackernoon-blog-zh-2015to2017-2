<html>
<head>
<title>How to query JSONB, beginner sheet cheat</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何查询JSONB，初学sheet cheat</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-query-jsonb-beginner-sheet-cheat-4da3aa5082a3?source=collection_archive---------0-----------------------#2017-03-30">https://medium.com/hackernoon/how-to-query-jsonb-beginner-sheet-cheat-4da3aa5082a3?source=collection_archive---------0-----------------------#2017-03-30</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="48a9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">假设我们必须在PostgreSQL 9.5+数据库上查询一个带有<code class="eh jp jq jr js b">metadata</code> JSONB列的<code class="eh jp jq jr js b">user</code>表。</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="fe ff jt"><img src="../Images/32e2c5d971bc54da8c28851ef1271f5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kq1n6Yv-YUxJAL6P45PMcQ.jpeg"/></div></div></figure><h2 id="e9f7" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated">1.按第一级属性的值选择项目(#1路)</h2><p id="57c0" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">您可以使用<code class="eh jp jq jr js b">metadata</code>上的<code class="eh jp jq jr js b">@&gt;</code>操作符进行查询。该操作符可以将部分JSON字符串与JSONB列进行比较。是<em class="lf">围堵</em>操作员。对于这种情况，您可能需要在<code class="eh jp jq jr js b">metadata</code>列中添加一个杜松子酒索引。</p><pre class="ju jv jw jx fq lg js lh li aw lj dt"><span id="b086" class="kf kg hu js b fv lk ll l lm ln">SELECT * FROM users WHERE metadata @&gt; '{"country": "Peru"}'; </span></pre><h2 id="4dc5" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated">2.按第一级属性的值选择项目(#2路)</h2><p id="9602" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated"><code class="eh jp jq jr js b">-&gt;&gt;</code>操作符以文本形式获取一个JSON对象字段。如果您想要查询JSONB列中的简单字段，请使用它。您可以在<code class="eh jp jq jr js b">metadata-&gt;&gt;'country'</code>上添加一个B树索引。</p><pre class="ju jv jw jx fq lg js lh li aw lj dt"><span id="ebe3" class="kf kg hu js b fv lk ll l lm ln">SELECT * FROM users WHERE metadata-&gt;&gt;'country' = 'Peru';</span></pre><h2 id="d9fe" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated">3.选择项目属性值</h2><p id="6140" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">再次，<code class="eh jp jq jr js b">-&gt;&gt;</code>操作符以文本形式获取一个JSON对象字段。直接在<code class="eh jp jq jr js b">SELECT</code>里用就行了。</p><pre class="ju jv jw jx fq lg js lh li aw lj dt"><span id="dd2e" class="kf kg hu js b fv lk ll l lm ln">SELECT metadata-&gt;&gt;'country' FROM users;</span></pre><h2 id="378b" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated">4.仅选择具有特定属性的项目</h2><p id="3c00" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">您可以将<code class="eh jp jq jr js b">-&gt;&gt;</code>操作符与您在文本上使用的经典操作符一起使用:<code class="eh jp jq jr js b">=</code>、<code class="eh jp jq jr js b">&lt;&gt;</code>、<code class="eh jp jq jr js b">IS NULL</code>等。不要忘记用B树索引来索引<code class="eh jp jq jr js b">metadata-&gt;&gt;'country'</code>。</p><pre class="ju jv jw jx fq lg js lh li aw lj dt"><span id="2333" class="kf kg hu js b fv lk ll l lm ln">SELECT * FROM users WHERE metadata-&gt;&gt;'country' IS NOT NULL;</span></pre><h2 id="74d2" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated">5.按嵌套属性的值选择项目</h2><p id="3471" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">您可以同时使用<code class="eh jp jq jr js b">@&gt;</code>或<code class="eh jp jq jr js b">-&gt;&gt;</code>，就像第一级属性一样。根据自己的选择添加一个索引。</p><pre class="ju jv jw jx fq lg js lh li aw lj dt"><span id="5df0" class="kf kg hu js b fv lk ll l lm ln">SELECT * FROM users WHERE metadata-&gt;'company'-&gt;&gt;'name' = "Mozilla";</span><span id="ff08" class="kf kg hu js b fv lo ll l lm ln">SELECT * <br/>  FROM users <br/>  WHERE metadata @&gt; '{"company":{"name": "Mozilla"}}';</span></pre><h2 id="7b81" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated">6.通过数组中的属性值选择项目</h2><p id="cbd3" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">记住<code class="eh jp jq jr js b">@&gt;</code>操作符检查JSONB列中的包含，您可以通过将<code class="eh jp jq jr js b">{"x":["a"]}</code>传递给<code class="eh jp jq jr js b">WHERE</code>子句来查询类似于<code class="eh jp jq jr js b">{"x": ["a", "b", "c"]"}</code>的数组:</p><pre class="ju jv jw jx fq lg js lh li aw lj dt"><span id="194b" class="kf kg hu js b fv lk ll l lm ln">SELECT * FROM users WHERE metadata @&gt; '{"companies": ["Mozilla"]}';</span></pre><h2 id="fb29" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated">7.属性上的IN运算符</h2><p id="6a41" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">有时，我们可能需要选择JSONB列中的属性与一组可能的值匹配的项目。</p><pre class="ju jv jw jx fq lg js lh li aw lj dt"><span id="22c6" class="kf kg hu js b fv lk ll l lm ln">SELECT * FROM users <br/>  WHERE metadata-&gt;&gt;'countries' IN ('Chad', 'Japan');</span></pre><h2 id="f1cf" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated">8.插入整个对象</h2><p id="48e5" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">照常使用<code class="eh jp jq jr js b">UPDATE ... SET</code>，将整个对象作为JSON传递。</p><pre class="ju jv jw jx fq lg js lh li aw lj dt"><span id="9c60" class="kf kg hu js b fv lk ll l lm ln">UPDATE users SET metadata = '{"country": "India"}';</span></pre><h2 id="3635" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated">9.更新或插入属性</h2><p id="eff7" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">使用<code class="eh jp jq jr js b">||</code>操作符将实际数据与新数据连接起来。它将更新或插入值。</p><pre class="ju jv jw jx fq lg js lh li aw lj dt"><span id="3d38" class="kf kg hu js b fv lk ll l lm ln">UPDATE users SET metadata = metadata || '{"country": "Egypt"}';</span></pre><h2 id="b35c" class="kf kg hu bd kh ki kj kk kl km kn ko kp jc kq kr ks jg kt ku kv jk kw kx ky kz dt translated">10.移除属性</h2><p id="144e" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">操作员<code class="eh jp jq jr js b">-</code>从对象上取下钥匙。</p><pre class="ju jv jw jx fq lg js lh li aw lj dt"><span id="3f04" class="kf kg hu js b fv lk ll l lm ln">UPDATE users SET metadata = metadata - 'country';</span></pre><h1 id="ff79" class="lp kg hu bd kh lq lr ls kl lt lu lv kp lw lx ly ks lz ma mb kv mc md me ky mf dt translated">最后一个音符</h1><p id="52ac" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">对JSONB对象的查询几乎和经典的SQL查询一样简单。我在这里只贴了几个例子，关于对我来说最常见的用例。这是给我的一个提示，我希望它也能帮助其他人。</p><p id="113d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以阅读PostgreSQL文档，其中有更多的示例和更精确的解释:</p><div class="mg mh fm fo mi mj"><a href="https://www.postgresql.org/docs/9.6/static/functions-json.html" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab ej"><div class="ml ab mm cl cj mn"><h2 class="bd hv fv z el mo eo ep mp er et ht dt translated">PostgreSQL:文档:9.6: JSON函数和操作符</h2><div class="mq l"><h3 class="bd b fv z el mo eo ep mp er et ek translated">注意:对于json和jsonb类型，这些操作符有并行的变体。字段/元素/路径…</h3></div><div class="mr l"><p class="bd b gc z el mo eo ep mp er et ek translated">www.postgresql.org</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx kd mj"/></div></div></a></div><div class="mg mh fm fo mi mj"><a href="https://www.postgresql.org/docs/9.6/static/datatype-json.html" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab ej"><div class="ml ab mm cl cj mn"><h2 class="bd hv fv z el mo eo ep mp er et ht dt translated">PostgreSQL:文档:9.6: JSON类型</h2><div class="mq l"><h3 class="bd b fv z el mo eo ep mp er et ek translated">PostgreSQL只允许每个数据库使用一种字符集编码。因此，JSON类型不可能…</h3></div><div class="mr l"><p class="bd b gc z el mo eo ep mp er et ek translated">www.postgresql.org</p></div></div><div class="ms l"><div class="my l mu mv mw ms mx kd mj"/></div></div></a></div><p id="c00f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请随时提出建议、反馈和批评。我很乐意了解更多。</p><p id="e1d5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">感谢<a class="mz na gr" href="https://medium.com/u/adfa6e96ed77?source=post_page-----4da3aa5082a3--------------------------------" rel="noopener" target="_blank">艾米莉·施耐德</a>(再次)的点评。</p><figure class="ju jv jw jx fq jy"><div class="bz el l di"><div class="nb nc l"/></div></figure></div></div>    
</body>
</html>