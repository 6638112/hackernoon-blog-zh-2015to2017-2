<html>
<head>
<title>Building a compass web app</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建指南针网络应用程序</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/building-a-compass-web-app-c79fec31e080?source=collection_archive---------10-----------------------#2017-12-25">https://medium.com/hackernoon/building-a-compass-web-app-c79fec31e080?source=collection_archive---------10-----------------------#2017-12-25</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="38be" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我已经开始了一个项目，试图使用磁力计来检测用户的行为，所以为了开始了解如何使用它们，我制作了一个简单的指南针。</p><h2 id="448c" class="jp jq hu bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj dt translated">步骤1 —原始磁力计数据:</h2><p id="12ef" class="pw-post-body-paragraph ir is hu it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hn dt translated">使用iPhone上的<em class="kp"> PowerSense </em>应用程序，我记录了不同罗盘方向和设备方位下的三轴磁力计读数。将设备限制在水平面上，可获得以下(非常有希望的)读数:</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div class="fe ff kq"><img src="../Images/d032460dd0491b3276368c57cc5fc786.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*10ki3q1QbkCyho-aiBFM_w.png"/></div><figcaption class="ky kz fg fe ff la lb bd b be z ek">X &amp; Y magnetometer readings at different headings</figcaption></figure><p id="40bd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">除了从x轴被逆转，这些点是非常有用的给我们一个罗盘航向！转换成球形坐标是为了使输出更有用:</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff lc"><img src="../Images/241df65c4e9f83b70fc273e8bcf1af37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QcqVS8pUWXQxqaDrt6n-lw.png"/></div></div><figcaption class="ky kz fg fe ff la lb bd b be z ek">From Maths Stack Exchange</figcaption></figure><p id="8957" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">由于3D空间中磁场矢量的幅度随着器件方向的改变而保持不变，因此在这种应用中可以忽略r值。在水平面上，由于z轴读数恒定，rho值也是恒定的，因此现在也忽略不计。θ的计算公式如下:</p><pre class="kr ks kt ku fq lh li lj lk aw ll dt"><span id="660a" class="jp jq hu li b fv lm ln l lo lp">def direction(vec): <br/>    #vec = [x,y,z] from imported data</span><span id="be24" class="jp jq hu li b fv lq ln l lo lp">    x = -vec[0] #negate x<br/>    y = vec[1]<br/>    z = vec[2]<br/>    if y &gt; 0 and x &gt; 0:        #if in Q1<br/>        theta = math.atan(x/y)<br/>    elif y &lt; 0:                #if in Q2 or Q3<br/>        theta = math.atan(x/y) + math.pi<br/>    else:                      #if in Q4<br/>        theta = math.atan(x/y) + math.pi*2<br/>    return theta</span></pre><p id="b901" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这给了我们一个与记录数据的角度一致的方向！现在所需要的就是从移动设备上获取磁力计数据。</p><h2 id="206b" class="jp jq hu bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj dt translated">第二步——意识到iPhones不会向网络应用程序提供原始磁力计数据……</h2><p id="1a98" class="pw-post-body-paragraph ir is hu it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hn dt translated">或许应该先检查一下这部分。哦好吧。</p><h2 id="097b" class="jp jq hu bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj dt translated">步骤3 —探索设备定向活动的奇妙之处</h2><p id="66a6" class="pw-post-body-paragraph ir is hu it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hn dt translated">deviceorientation允许网站收集设备如何被握持的数据，这些数据在3个不同的轴上报告:</p><p id="d76b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> alpha </strong> —绕z轴旋转，从0度到360度</p><p id="39d2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> beta </strong> —绕x轴旋转，从-180度到180度</p><p id="3785" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> gamma </strong> —绕y轴旋转，从-90度到90度</p><p id="77bf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">需要注意的是，在iOS和Android设备之间，这些信息的指定方式略有不同。在chrome 50之前，Android设备会将alpha报告为一个'<em class="kp">绝对</em>值，在地球表面的参考系中是常数。这意味着alpha = 0对应于指向正北的设备，这非常方便。如磁力计数据所示，旋转方向相反。这可以通过取<em class="kp">航向= 360-α</em>来解决</p><pre class="kr ks kt ku fq lh li lj lk aw ll dt"><span id="d952" class="jp jq hu li b fv lm ln l lo lp">function deviceOrientationListener(event) {<br/>  var alpha    = event.alpha; //z axis rotation [0,360)<br/>  var beta     = event.beta; //x axis rotation [-180, 180]<br/>  var gamma    = event.gamma; //y axis rotation [-90, 90]<br/>  var heading  = 360 - alpha; //heading [0, 360)<br/>}</span><span id="328f" class="jp jq hu li b fv lq ln l lo lp">if(window.DeviceOrientationEvent){ //Check if device is compatible<br/>      window.addEventListener("deviceorientation", deviceOrientationListener);<br/>    }</span></pre><p id="2f60" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，现在Android已经走上了iOS的道路，将alpha报告为一个'<em class="kp">相对</em>'值，其中0被定义为页面加载时设备的方向。这使得它作为指南针的用处大大降低了…</p><p id="a25f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">幸运的是，隐藏在谷歌开发者页面深处的是一个解决方案！有些设备仍然会通过event.webkitCompassHeading以罗盘航向的形式报告绝对alpha值。应用程序检查设备是否会报告该值，如果是，则使用该值。否则，使用相对alpha值来显示页面，只是不指向北方。</p><pre class="kr ks kt ku fq lh li lj lk aw ll dt"><span id="334e" class="jp jq hu li b fv lm ln l lo lp">...<br/>if (typeof event.webkitCompassHeading !== "undefined") {<br/>        alpha = event.webkitCompassHeading; //iOS non-standard<br/>        var heading = alpha<br/>        document.getElementById("heading").innerHTML = heading.toFixed([0]);<br/>      }<br/>      else {<br/>        alert("Your device is reporting relative alpha values, so this compass won't point north! ");<br/>        var heading = 360 - alpha; //heading [0, 360)<br/>        document.getElementById("heading").innerHTML = heading.toFixed([0]);<br/>      }<br/>...</span><span id="ece8" class="jp jq hu li b fv lq ln l lo lp">if (window.DeviceOrientationAbsoluteEvent) {<br/>      window.addEventListener("DeviceOrientationAbsoluteEvent", deviceOrientationListener);<br/>    } // If not, check if the device sends any orientation data<br/>    else if(window.DeviceOrientationEvent){<br/>      window.addEventListener("deviceorientation", deviceOrientationListener);<br/>    } // Send an alert if the device isn't compatible<br/>    else {<br/>      alert("Sorry, try again on a compatible mobile device!");<br/>    }</span></pre><p id="f82a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所有的代码都在页面底部给出。</p><p id="a13d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">指南针可以在<a class="ae lr" href="http://www.grantholtes.com/compass.html" rel="noopener ugc nofollow" target="_blank">这里</a>测试，但是如果你的设备不工作，看看下面:</p><figure class="kr ks kt ku fq kv fe ff paragraph-image"><div class="fe ff ls"><img src="../Images/b704c7dfa34731a98fcc00d98da5236c.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/1*5sNK3Vme1egytyy3Gjyhmg.gif"/></div><figcaption class="ky kz fg fe ff la lb bd b be z ek">The compass in action</figcaption></figure><pre class="kr ks kt ku fq lh li lj lk aw ll dt"><span id="8132" class="jp jq hu li b fv lm ln l lo lp">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>  &lt;head&gt;<br/>    &lt;style&gt;<br/>    p {<br/>      font-family: verdana;<br/>      font-size: 400px;<br/>      color: #FFFFFF;<br/>    }<br/>    &lt;/style&gt;</span><span id="6cb2" class="jp jq hu li b fv lq ln l lo lp">    &lt;title&gt;Compass&lt;/title&gt;</span><span id="fc79" class="jp jq hu li b fv lq ln l lo lp">    &lt;script&gt;<br/>    // Get event data<br/>    function deviceOrientationListener(event) {<br/>      var alpha    = event.alpha; //z axis rotation [0,360)<br/>      var beta     = event.beta; //x axis rotation [-180, 180]<br/>      var gamma    = event.gamma; //y axis rotation [-90, 90]</span><span id="10c9" class="jp jq hu li b fv lq ln l lo lp">      //Check if absolute values have been sent<br/>      if (typeof event.webkitCompassHeading !== "undefined") {<br/>        alpha = event.webkitCompassHeading; //iOS non-standard<br/>        var heading = alpha<br/>        document.getElementById("heading").innerHTML = heading.toFixed([0]);<br/>      }<br/>      else {<br/>        alert("Your device is reporting relative alpha values, so this compass won't point north :(");<br/>        var heading = 360 - alpha; //heading [0, 360)<br/>        document.getElementById("heading").innerHTML = heading.toFixed([0]);<br/>      }<br/>      <br/>      // Change backgroud colour based on heading<br/>      // Green for North and South, black otherwise<br/>      if (heading &gt; 359 || heading &lt; 1) { //Allow +- 1 degree<br/>        document.body.style.backgroundColor = "green";<br/>        document.getElementById("heading").innerHTML = "N"; // North<br/>      }<br/>      else if (heading &gt; 179 &amp;&amp; heading &lt; 181){ //Allow +- 1 degree<br/>        document.body.style.backgroundColor = "green";<br/>        document.getElementById("heading").innerHTML = "S"; // South<br/>      } <br/>      else { // Otherwise, use near black<br/>        document.body.style.backgroundColor = "#161616";<br/>      }<br/>    }<br/>    <br/>    // Check if device can provide absolute orientation data<br/>    if (window.DeviceOrientationAbsoluteEvent) {<br/>      window.addEventListener("DeviceOrientationAbsoluteEvent", deviceOrientationListener);<br/>    } // If not, check if the device sends any orientation data<br/>    else if(window.DeviceOrientationEvent){<br/>      window.addEventListener("deviceorientation", deviceOrientationListener);<br/>    } // Send an alert if the device isn't compatible<br/>    else {<br/>      alert("Sorry, try again on a compatible mobile device!");<br/>    }<br/>    &lt;/script&gt;<br/>  &lt;/head&gt;</span><span id="bbaf" class="jp jq hu li b fv lq ln l lo lp">  &lt;body&gt;<br/>    &lt;br&gt;&lt;br&gt;<br/>    &lt;p id="heading" style="text-align:center"&gt;&lt;/p&gt;<br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre></div></div>    
</body>
</html>