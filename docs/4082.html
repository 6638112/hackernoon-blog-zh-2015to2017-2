<html>
<head>
<title>Hands On Mobile API Security: Get Rid of Client Secrets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">移动API安全性实践:消除客户端秘密</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/hands-on-mobile-api-security-get-rid-of-client-secrets-a79f111b6844?source=collection_archive---------2-----------------------#2017-05-11">https://medium.com/hackernoon/hands-on-mobile-api-security-get-rid-of-client-secrets-a79f111b6844?source=collection_archive---------2-----------------------#2017-05-11</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="4363" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">引入API密钥代理以提高移动安全性</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/ea123f549deb41dd88ab8d0af7450e5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4lm9DP6Xyb8PLJsL."/></div></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek"><strong class="bd jz">UGC 12591: The Fastest Rotating Galaxy Known [Image Credit: </strong><a class="ae ka" href="http://www.nasa.gov/" rel="noopener ugc nofollow" target="_blank">NASA</a>, <a class="ae ka" href="http://www.esa.int/" rel="noopener ugc nofollow" target="_blank">ESA</a>, <a class="ae ka" href="https://www.nasa.gov/mission_pages/hubble/story/index.html" rel="noopener ugc nofollow" target="_blank">Hubble</a>]</figcaption></figure><p id="24f7" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">API密钥和其他隐藏在移动应用程序中的秘密是移动不安全的一个常见来源。你可以<a class="ae ka" href="https://hackernoon.com/they-reverse-engineered-16k-apps-heres-what-we-d-fix-67e9eeceefb5" rel="noopener ugc nofollow" target="_blank">做得更好</a>。</p><p id="1e3f" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">在本教程中，您将使用一个简单的照片客户端，它使用API键来访问<a class="ae ka" href="https://apod.nasa.gov/" rel="noopener ugc nofollow" target="_blank"> NASA每日图片服务</a>。在客户端和图片服务之间引入API代理将消除在客户端存储和保护API密钥的需要。除了提高安全性之外，这种方法还在可管理性和可伸缩性方面提供了一些好处。</p><p id="4c02" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">在本教程中，您将修改一个Android客户端和Node.js代理服务器。出于演示目的，Android客户端仿真和节点服务器可以在一台笔记本电脑上一起运行。</p><p id="d0a7" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">我假设您对Android有一些非常基本的了解，并且能够阅读Java和Javascript。所有代码都已提供，所以即使您在这些环境中的经验有限，也应该能够理解。</p><h1 id="bd52" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">Astropiks移动应用程序</h1><p id="d4e3" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">Astropiks移动应用程序是一个相对简单的联网Android客户端，有两个主屏幕。初始屏幕显示了NASA近期每日一图的图库。点击一幅图像，会出现一个包含完整图像及其描述的详细屏幕。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff lu"><img src="../Images/2ad43c9aee91a3021db28d541192d06f.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*k-S01hDonp3WlyqjkzTuzw.png"/></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">Gallery and Detail Screens</figcaption></figure><p id="b927" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">该应用程序使用<a class="ae ka" href="https://api.nasa.gov/api.html#apod" rel="noopener ugc nofollow" target="_blank"> NASA的每日图片API </a>来检索图像和描述。要访问该服务，API需要一个注册的API密钥，该密钥最初存储在客户端应用程序中。</p><h1 id="32c1" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">为什么要添加API代理？</h1><p id="0b2c" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">任何复杂性的应用程序都将通过其公共API大量使用多个第三方服务，这意味着处理和保护许多秘密的API密钥。秘密应该是保密的。不幸的是，对于一个保存在移动应用程序上的秘密来说，问题不在于它是否会被窃取，而在于它会在什么时候被窃取，以及需要付出多大的努力。</p><p id="ad52" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">通过在客户端应用和其第三方服务之间引入API密钥代理服务器，我们可以将不安全的移动客户端中的API密钥移除，并将它们放在更安全的代理服务器上。我们还添加了一个证明服务来建立客户机和新代理服务器之间的信任。在<a class="ae ka" href="https://hackernoon.com/mobile-api-security-techniques-682a5da4fe10" rel="noopener ugc nofollow" target="_blank">移动API安全文章</a>中详细讨论了这种方法。</p><p id="e57c" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">我们将使用NASA服务作为一个API的例子，它通常是从移动客户端应用程序调用的。我们在客户端和服务之间增加了额外的一跳，但它确实提供了显著的好处。既然我们已经从客户那里移除了这个秘密，它就不会再被偷走了。</p><p id="86f0" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">如果秘密由于某种原因被泄露，可以在代理服务器上用新的秘密替换它。从可管理性的角度来看，由于秘密不再在客户端，所以可以做出提高安全性的决定，而不需要对客户端的安装基础进行任何更改。</p><p id="2c87" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">代理服务本身是<a class="ae ka" href="http://stackoverflow.com/questions/5539823/what-are-the-benefits-of-a-stateless-web-application" rel="noopener ugc nofollow" target="_blank">无状态的</a>，这带来了负载平衡、故障恢复和其他可伸缩性的好处。通过在客户端和代理服务器之间建立信任，证明服务提供了一个快速拒绝过滤器，以在实际的API服务器增加负担之前丢弃无效的流量。当多个API服务通过同一个服务器代理时，这些好处会增加。</p><h1 id="c7b3" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">初步设置</h1><p id="faf9" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">要开始，您需要下载教程源代码，获得一些密钥，并确保您的开发工具已准备就绪。本教程应该可以在windows、mac或linux环境下正常运行。</p><h2 id="fac5" class="lv ky hu bd kz lw lx ly ld lz ma mb lh kk mc md lj ko me mf ll ks mg mh ln mi dt translated">1.下载API代理教程源代码</h2><p id="9e07" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">所有教程源代码都可以在github上找到。在终端或命令窗口中，切换到存储教程的目录，并克隆这个公共git存储库:</p><pre class="jk jl jm jn fq mj mk ml mm aw mn dt"><span id="9c00" class="lv ky hu mk b fv mo mp l mq mr">tutorials$ git clone <a class="ae ka" href="https://github.com/approov/hands-on-api-proxy.git" rel="noopener ugc nofollow" target="_blank">https://github.com/approov/hands-on-api-proxy.git</a></span></pre><h2 id="7297" class="lv ky hu bd kz lw lx ly ld lz ma mb lh kk mc md lj ko me mf ll ks mg mh ln mi dt translated">2.从NASA注册一个API密匙(免费)</h2><p id="d8b3" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">美国宇航局需要一个有效的注册码来访问他们的免费图片服务。打开浏览器，访问https://api.nasa.gov/index.html#apply-for-an-api-key的<a class="ae ka" href="https://api.nasa.gov/index.html#apply-for-an-api-key" rel="noopener ugc nofollow" target="_blank"/>。完成注册，并将您的API密钥保存在安全的地方。</p><h2 id="ca91" class="lv ky hu bd kz lw lx ly ld lz ma mb lh kk mc md lj ko me mf ll ks mg mh ln mi dt translated">3.下载证明演示服务包(免费)</h2><p id="2b5c" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">证明服务用于在客户端和代理服务器之间建立信任。打开浏览器，访问<a class="ae ka" href="https://www.approov.io/demo-reg.html" rel="noopener ugc nofollow" target="_blank">https://www.approov.io/demo-reg.html</a>获得免费演示服务。完成注册，打开电子邮件，将zip文件解压到一个方便的地方。在所示的示例目录树中，我将它放在与api-key-proxy repo相同的父目录下。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff ms"><img src="../Images/852393bc3087ec08f89b87cda92b0b60.png" data-original-src="https://miro.medium.com/v2/resize:fit:396/format:webp/1*txle1Au_TurQnD-GEAcUvw.png"/></div></figure><p id="94e4" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">在本教程中，您将对移动客户端和api密钥代理进行更改。已经为您创建了一个工作目录<code class="eh mt mu mv mk b">pen</code>，其中保存了客户端应用程序和API密钥代理的初始副本。</p><p id="a7f2" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">对于客户机和代理，教程的每个完成的步骤都存储在<code class="eh mt mu mv mk b">steps</code>目录下。如果您想从某个中间点开始，可以将其中任何一个复制到您的工作目录中。</p><p id="d473" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">不久将使用<code class="eh mt mu mv mk b">config</code>目录用您的特定密钥和秘密预先配置这些步骤。</p><h2 id="8e6c" class="lv ky hu bd kz lw lx ly ld lz ma mb lh kk mc md lj ko me mf ll ks mg mh ln mi dt translated">4.安装Android Studio和SDK</h2><p id="089e" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">Android Studio和Android SDK用于构建和运行Astropiks客户端应用程序。确保安装了Android Studio，并且是最新的，最好是2.3版或更高版本。如果您需要全新安装Android工具，请访问Android开发者网站<a class="ae ka" href="https://developer.android.com/studio/index.html" rel="noopener ugc nofollow" target="_blank">开始安装。</a></p><p id="6d4c" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">本教程假设您将在Android模拟器中运行客户端，但是您也可以使用Android手机或平板电脑。Android设备应该运行API 19或更高版本。</p><h2 id="cbd1" class="lv ky hu bd kz lw lx ly ld lz ma mb lh kk mc md lj ko me mf ll ks mg mh ln mi dt translated">5.设置Node.js</h2><p id="3051" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">Node.js环境用于构建和运行示例密钥代理服务器。确保安装了Node.js环境，最好是稳定的版本6。如果您需要全新安装，请访问<a class="ae ka" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>开始安装。如果要维护多个节点版本，请安装<a class="ae ka" href="https://github.com/creationix/nvm" rel="noopener ugc nofollow" target="_blank">节点版本管理器(nvm </a>)。</p><p id="5556" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">这将安装节点及其软件包管理器npm。我们将在构建每个代理时安装额外的包依赖项。</p><p id="e16b" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">Android和Node.js环境被选为示例演示环境。其他实现，包括用于客户端的iOS和用于代理的NGINX或Go，当然也是合适的。如果你想看看其他的客户端或代理实现，在回复中添加一个建议，我会看看有什么可以添加的。</p><h2 id="192b" class="lv ky hu bd kz lw lx ly ld lz ma mb lh kk mc md lj ko me mf ll ks mg mh ln mi dt translated">6.配置代码示例</h2><p id="0d89" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated"><code class="eh mt mu mv mk b">config</code>目录包含一个节点脚本，它将帮助配置所有的示例代码步骤。首先进入<code class="eh mt mu mv mk b">config</code>目录，并安装所需的节点依赖项:</p><pre class="jk jl jm jn fq mj mk ml mm aw mn dt"><span id="1aa3" class="lv ky hu mk b fv mo mp l mq mr">tutorials$ cd api-key-proxy/config<br/>tutorials/api-key-proxy/config$ npm install</span></pre><p id="d463" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">接下来将示例机密配置文件<code class="eh mt mu mv mk b">secrets.sample.yaml</code>复制到<code class="eh mt mu mv mk b">secrets.yaml</code>中，并打开它进行编辑:</p><pre class="jk jl jm jn fq mj mk ml mm aw mn dt"><span id="bad7" class="lv ky hu mk b fv mo mp l mq mr">tutorials/api-key-proxy/config$ cp secrets.sample.yaml secrets.yaml</span></pre><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mw mx l"/></div></figure><p id="006e" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">将<code class="eh mt mu mv mk b">proxy_home</code>设置为完全合格的URL地址和协议。如果您将在仿真器中运行Android客户端，并在本地运行代理服务器，那么使用<code class="eh mt mu mv mk b">http:</code>作为协议，使用<code class="eh mt mu mv mk b">10.0.2.2</code>作为地址(仿真器到<code class="eh mt mu mv mk b">localhost</code>的默认隧道)，并在示例文件中选择一个未使用的本地主机端口<code class="eh mt mu mv mk b">8080</code>。</p><p id="7b7c" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">更改<code class="eh mt mu mv mk b">nasa_api_key</code>和<code class="eh mt mu mv mk b">approov_token_secret</code>值，以匹配您收到的NASA API密钥和您在演示下载中获得的Approov令牌秘密。将<code class="eh mt mu mv mk b">approov_android_lib</code>指向演示下载中<code class="eh mt mu mv mk b">approov.aar</code>文件的位置。保存<code class="eh mt mu mv mk b">secrets.yaml</code>，运行配置脚本:</p><pre class="jk jl jm jn fq mj mk ml mm aw mn dt"><span id="3845" class="lv ky hu mk b fv mo mp l mq mr">tutorials/api-key-proxy/config$ npm start</span></pre><p id="3dfa" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">如果配置是正确的，那么所有客户端和代理步骤现在都拥有一组一致的配置和密码值，approov演示服务SDK库已经添加到相关的客户端步骤中，并且已经为客户端和代理设置了代理URL。</p><p id="02fc" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated"><code class="eh mt mu mv mk b">pen</code>工作目录包含启动配置、<code class="eh mt mu mv mk b">0_direct_client</code>和<code class="eh mt mu mv mk b">1_open_proxy</code>的副本。你应该可以走了。</p><h1 id="1ee6" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">构建初始客户端应用程序</h1><p id="1d5a" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">最初的客户端应用程序直接与NASA每日图片服务通信。NASA API密钥必须存储在应用程序中，并随每个API调用一起提供。</p><p id="76aa" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">启动Android Studio，打开<code class="eh mt mu mv mk b">api-key-proxy/pen/client</code>工作目录下的Astropiks Android客户端。Android Studio将需要一段时间来加载库依赖项，并重建项目。如果您的配置是有效的，那么项目应该会正确构建。</p><p id="c7d1" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">您可能会看到无法加载模块的通知或错误消息，还可能会出现一个对话框，询问是否可以删除模块:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff my"><img src="../Images/b978cb97e59d7292927828b42d75eebb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nvGK3-xe8KqAya7kS5XmTQ.png"/></div></div></figure><p id="048c" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">如果您在目录之间移动了android项目，这通常会发生，例如，如果您将一个完成的步骤复制到您的工作目录<code class="eh mt mu mv mk b">pen</code>中。对<code class="eh mt mu mv mk b">Remove Selected</code>模块来说应该是安全的，并且你的项目应该同步，没有进一步的问题。</p><p id="d088" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">这个应用程序是一个相当简单的模型-视图-控制器风格的主从照片库。<code class="eh mt mu mv mk b">PhotoRequester</code>类使用<a class="ae ka" href="http://square.github.io/okhttp/" rel="noopener ugc nofollow" target="_blank"> OkHttp </a>库处理初始API调用，使用<a class="ae ka" href="http://square.github.io/picasso/" rel="noopener ugc nofollow" target="_blank"> Picasso </a>库下载图像。NASA API URL存储在<code class="eh mt mu mv mk b">app/src/main/res/values/config.xml</code>文件中，应该如下所示:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mw mx l"/></div></figure><p id="419d" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated"><code class="eh mt mu mv mk b">App</code>应用程序类在一个方便的地方为所有活动创建并提供HTTP客户端和下载程序。</p><p id="e936" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">在运行您的应用程序之前，确保您的NASA API密钥在<code class="eh mt mu mv mk b">app/src/main/res/values/secrets.xml</code>文件中设置正确:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mw mx l"/></div></figure><p id="5dd7" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">根据需要创建和/或更新这两个文件。</p><p id="d1ac" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">注意<code class="eh mt mu mv mk b">secrets.xml</code>已经被添加到。<code class="eh mt mu mv mk b">gitignore</code>文件，这样它就不会被无意中添加到您的git存储库中。已经有足够的<a class="ae ka" href="https://arstechnica.com/security/2015/03/in-major-goof-uber-stored-sensitive-database-key-on-public-github-page/" rel="noopener ugc nofollow" target="_blank">个密钥被登记到GitHub </a>中，不需要添加你的！</p><p id="d869" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">现在构建、安装并运行应用程序APK。在Android Studio中，点击运行“应用”按钮，启动模拟器或其他连接设备:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mz"><img src="../Images/44294db1f1fdc890ceda54b64d363610.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*L-ffWDz-cohMy6Yr."/></div></div></figure><p id="be1d" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">您应该会看到类似左边截图的内容:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff lu"><img src="../Images/b2a6c1d013a41abc30224692d8c68453.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*N55ySyz6MHsDBbOyi8yP-Q.png"/></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">Good (left) and Bad (right) Gallery Screens</figcaption></figure><p id="c486" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">如果您看到右边的屏幕，您可能没有正确配置您的API密钥，或者您有网络连接问题。打开浏览器或<a class="ae ka" href="https://www.getpostman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>，尝试访问NASA服务，用自己的密钥替换下面截图中的DEMO_KEY:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff na"><img src="../Images/18a916f6e65bb688f9e7f902181d9709.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1Yz6v3oFhHSO9YCO."/></div></div></figure><p id="be39" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">调试您的设置连接和API密钥，直到您获得有效的响应。确保您的<code class="eh mt mu mv mk b">api_key</code>正确设置在<code class="eh mt mu mv mk b">secrets.xml</code>文件中，并且您的<code class="eh mt mu mv mk b">api_url</code>正确设置在<code class="eh mt mu mv mk b">config.xml</code>到<code class="eh mt mu mv mk b">https://api.nasa.gov</code>中。仔细检查您是否在另一个文件中设置了这些值，比如<code class="eh mt mu mv mk b">strings.xml</code>。</p><p id="3191" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">运行后，向下滚动图库屏幕，从NASA获取更多图片。点击图片以查看其详细屏幕。点击返回箭头返回画廊屏幕。</p><p id="63e1" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated"><em class="nb">作为参考，现阶段客户端app的一个完整版本在</em> <code class="eh mt mu mv mk b"><em class="nb">steps/client/android/0_direct-client</em></code> <em class="nb">中。</em></p><h1 id="a12e" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">窃取客户端的API密钥</h1><p id="6c6e" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">您的API密钥用于客户端和NASA服务器之间的API调用。大多数生产应用程序将调用多个第三方API，并持有多个API密钥。</p><p id="a130" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">客户端应用程序应该始终使用<a class="ae ka" href="https://www.owasp.org/index.php/Transport_Layer_Protection_Cheat_Sheet" rel="noopener ugc nofollow" target="_blank"> TLS最佳实践</a>，包括证书锁定，来保护API通信，这样您的API密钥就不会被轻易发现。只要客户端使用一个密钥，客户端的APK就包含该密钥的静态表示。在我们的例子中，使用<a class="ae ka" href="https://ibotpeaches.github.io/Apktool/" rel="noopener ugc nofollow" target="_blank"> Apkool </a>，逆向工程你的APK并揭示APK的<code class="eh mt mu mv mk b">api_key</code>值是一件简单的事情。混淆技术会使这变得更加困难，但您的密钥最终会被找到。</p><p id="9cff" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">一旦你的API密匙被发现，就可以用来访问NASA的公共服务。在这种情况下，黑客反复调用NASA网站将触发速率限制，最终您将被拒绝访问。但是如果你是电商网站呢？如果你的站点忙于处理无意义的API调用，真正的客户会因为响应能力差而被拒绝访问或者放弃。一个恶意的黑客可能能够创建一堆虚假的商品订单或获取竞争信息。或者，黑客可以使用你的API创建一个类似的应用程序,在一个缩小的网站上显示你的库存，从即将愤怒的客户那里收集订单，并在这个过程中获取他们的凭据和信用卡信息。</p><p id="ec80" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">让我们从你的应用程序中找出这个秘密。</p><h1 id="1c57" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">构建初始API密钥代理</h1><p id="1bc7" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">要开始在代理服务器上工作，请切换到代理工作目录，并安装任何缺失的节点依赖项:</p><pre class="jk jl jm jn fq mj mk ml mm aw mn dt"><span id="aee9" class="lv ky hu mk b fv mo mp l mq mr">tutorials$ cd api-key-proxy/pen/proxy<br/>tutorials/api-key-proxy/pen/proxy$ npm install</span></pre><p id="6c92" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">这可能需要一段时间，您可能会看到几个依赖项的一些警告，根据您的主机平台，这些警告可能是不必要的。</p><p id="f145" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">根据您的初始配置，您的<code class="eh mt mu mv mk b">src/config.js</code>文件应该如下所示:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mw mx l"/></div></figure><p id="0088" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">您正在将NASA API密钥从客户端应用程序转移到代理中，因此您的<code class="eh mt mu mv mk b">src/secrets.js</code>文件应该如下所示:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mw mx l"/></div></figure><p id="ecb7" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">确保<code class="eh mt mu mv mk b">nasa_api_key</code>被设置为你的NASA API密匙串。</p><p id="d25a" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">像您的客户端的<code class="eh mt mu mv mk b">secrets.xml</code>文件一样，<code class="eh mt mu mv mk b">secrets.js</code>文件将被git安全地忽略。</p><p id="ebb0" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">代理服务器是一个简单的快速应用程序。NASA API调用在<code class="eh mt mu mv mk b">src/api/nasa.js</code>模块中处理。当代理服务器看到对route <code class="eh mt mu mv mk b">/api.nasa.gov</code>的调用时，它将您的API键添加到查询字符串中，将请求代理到NASA每日图片服务，并将响应转发给原始调用者。</p><p id="e04c" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">启动代理服务器:</p><pre class="jk jl jm jn fq mj mk ml mm aw mn dt"><span id="02cf" class="lv ky hu mk b fv mo mp l mq mr">tutorials/api-key-proxy/pen/proxy$ npm start</span></pre><p id="6cd0" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">您应该会看到一条消息，表明服务器正在监听在<code class="eh mt mu mv mk b">config.js</code>中为代理指定的端口。</p><p id="537a" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">使用浏览器或邮递员呼叫代理，尝试使用您的代理。假设您正在本地运行端口<code class="eh mt mu mv mk b">8080</code>，用现在代理的调用<code class="eh mt mu mv mk b">htttp://localhost:8080/api.nasa.gov/planetary/apod?date=2017–01–01&amp;api_key=YOUR_API_KEY</code>替换对NASA的直接调用。请注意，我们还将协议从<code class="eh mt mu mv mk b">https</code>切换到<code class="eh mt mu mv mk b">http</code>。这对于生产来说是不安全的，但是可以更容易地在本地运行我们的示例，而无需锁定连接。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff na"><img src="../Images/0047151ca30ca66f162acc4d572ad49e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5Ha2GaKkRAF0Of8q."/></div></div></figure><p id="72b2" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">JSON响应包括日期、解释和一个或多个下载媒体的URL。如果您看到一个格式良好的响应，则您的代理服务器工作正常。否则，检查你的API密匙在<code class="eh mt mu mv mk b">secrets.js</code>中是正确的，并且你的服务器正在运行，正在监听正确的端口，并且能够访问外部网络。</p><p id="c8df" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">虽然这个例子只使用了一个API，因此只需要一个API键，但是大多数应用程序会使用多个API和多个API键。API密钥服务器必须能够代理多个不同的API代理。尽管这是一个简单的Express应用程序，但它被设置为自动加载在<code class="eh mt mu mv mk b">src/api</code>目录中找到的所有路线处理程序。要添加额外的API密钥代理，您可以创建一个类似于<code class="eh mt mu mv mk b">nasa.js</code>的新路由处理程序，并将URL和密钥添加到配置和机密文件中。</p><p id="75f7" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated"><em class="nb">作为参考，现阶段代理服务器的一个完整版本在</em> <code class="eh mt mu mv mk b"><em class="nb">steps/proxy/node/1_open-proxy</em></code> <em class="nb">中。</em></p><h1 id="6252" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">修改客户端应用程序以使用API密钥代理</h1><p id="34bb" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">既然API密钥代理正在工作，您可以修改Android客户端来通过代理。您将使用与上面相同的端口号。按照惯例，如果在Android模拟器中运行，<code class="eh mt mu mv mk b">localhost</code>可以使用<code class="eh mt mu mv mk b">http:</code>通过地址<code class="eh mt mu mv mk b">10.0.2.2</code>访问。因此，对于默认的模拟器和本地代理服务器，代理URL应该是<code class="eh mt mu mv mk b"><a class="ae ka" href="http://10.0.2.2:8080/api.nasa.gov/planetary/apod." rel="noopener ugc nofollow" target="_blank">http://10.0.2.2:8080/api.nasa.gov</a></code> <a class="ae ka" href="http://10.0.2.2:8080/api.nasa.gov/planetary/apod." rel="noopener ugc nofollow" target="_blank">。</a></p><p id="6a66" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">在<code class="eh mt mu mv mk b">app/src/main/res/values/config.xml</code>文件中适当修改<code class="eh mt mu mv mk b">api_url</code>值:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mw mx l"/></div></figure><p id="a4a7" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">您不再需要客户机中的API密钥，所以删除<code class="eh mt mu mv mk b">app/src/main/res/values/secrets.xml</code>文件。您还应该从<code class="eh mt mu mv mk b">PhotoRequester</code> <code class="eh mt mu mv mk b">getPhoto()</code>函数中的<code class="eh mt mu mv mk b">urlRequest</code>查询字符串中删除<code class="eh mt mu mv mk b">api_key</code>:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mw mx l"/></div></figure><p id="9594" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">通过<code class="eh mt mu mv mk b">config.xml</code>和<code class="eh mt mu mv mk b">PhotoRequester.java</code>的这些小改动，重新构建修改后的客户端app。</p><p id="6e37" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">确保代理服务器正在运行，并像以前一样在Android模拟器或设备上安装并运行修改后的客户端应用程序。您应该会看到和以前一样的结果，但是现在照片是通过API key代理提供的。您应该在API密钥代理控制台日志中看到照片请求。</p><p id="d1a7" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">如果您没有看到照片，请仔细检查您的代理URL和网络连接。如果代理是本地的，确保您使用的是<code class="eh mt mu mv mk b">http:</code>而不是<code class="eh mt mu mv mk b">https:</code>协议，并仔细检查主机地址和端口号。或者，在您的客户端设备或仿真器上启动一个浏览器，并尝试从那里访问代理服务器。如果在模拟器上运行，这将有助于验证<code class="eh mt mu mv mk b">10.0.2.2</code>是本地主机的正确地址。</p><p id="84c2" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated"><em class="nb">作为参考，现阶段客户端app的一个完整版本在</em> <code class="eh mt mu mv mk b"><em class="nb">steps/client/android/1_open-client</em></code> <em class="nb">中。</em></p><h1 id="674a" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">添加代理安全性</h1><p id="3fd1" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">恭喜你，你现在应该有一个正常工作的代理服务器了。客户机上不再有任何秘密，但是您有了一个任何人都可以使用的代理。您需要一种方法来确保只有受信任的客户端可以访问您的代理服务器，而不需要该客户端上的任何新机密。一种方法是使用动态证明服务将客户端应用程序认证为您信任的人。</p><p id="3ae2" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">您将通过使用之前下载的Approov演示包来连接到证明服务。一旦证明服务在客户机上运行(下一节)，客户机将把一个短期的<a class="ae ka" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> JSON Web令牌(JWT) </a>传递给代理服务器。使用只有证明者和代理服务器知道的应用程序机密，代理服务器可以验证JWT签名和过期，如果有效，可以满足代理请求。</p><p id="6b4a" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">为此，我们将在代理服务器中添加演示令牌密码和JWT令牌检查。从演示包中，打开<code class="eh mt mu mv mk b">secret/token-secret.txt</code>文件。复制令牌字符串并粘贴到<code class="eh mt mu mv mk b">src/secrets.js</code>文件中作为<code class="eh mt mu mv mk b">approov_token_secret</code>:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mw mx l"/></div></figure><p id="6f99" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">approov令牌将使用名为<code class="eh mt mu mv mk b">approov</code>的请求头来传递。在调试期间，我们希望验证令牌，但即使令牌验证失败，也允许请求通过。打开<code class="eh mt mu mv mk b">src/config.js file and add </code>approv _ header和<code class="eh mt mu mv mk b">approov_enforcement</code>条目:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mw mx l"/></div></figure><p id="f03e" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">原始的<code class="eh mt mu mv mk b">index.js</code>文件包含一个预处理所有请求的路由处理程序:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mw mx l"/></div></figure><p id="3ebe" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">这只是一个简单的占位符，现在将被一个预处理所有路由处理程序所取代，该处理程序将检查每个请求的有效approov令牌。用以下代码替换占位符例程:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mw mx l"/></div></figure><p id="9b89" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">重启代理服务器，重启你的Android客户端应用。在代理服务器控制台中，您应该看到令牌检查失败，但是服务器仍然满足NASA API请求，因为强制被禁用。客户端应用程序应该仍然像往常一样显示照片。</p><p id="8854" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">接下来，在<code class="eh mt mu mv mk b">src/config.js</code>中，将<code class="eh mt mu mv mk b">approov_enforcement</code>值更改为<code class="eh mt mu mv mk b">true</code>。重新启动代理服务器和客户端应用程序。现在，您应该会看到失败的证明和未经授权的访问错误返回到客户端应用程序。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff nc"><img src="../Images/70b5a00aef9f722236f11ec53d6513bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:422/format:webp/1*yhqCcoPH8eeFV_5nvIN4hA.png"/></div></figure><p id="68ea" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated"><em class="nb">作为参考，现阶段代理服务器的一个完整版本在</em> <code class="eh mt mu mv mk b"><em class="nb">steps/proxy/node/2_secure-proxy</em></code> <em class="nb">中。</em></p><h1 id="504b" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">添加客户端证明</h1><p id="aea6" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">接下来，您将在客户端应用程序中添加缺失的证明功能。</p><p id="a913" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">首先将Approov SDK库添加到客户端项目中。该库位于<code class="eh mt mu mv mk b">libraries/android/approov.aar</code>的approov演示包中。</p><p id="235f" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">在Android Studio中，点击<code class="eh mt mu mv mk b">Build -&gt; Edit Libraries and Dependencies…</code>菜单项。在“项目结构”对话框中，确保突出显示app模块并选择“依赖项”选项卡。点击对话框左上方的<code class="eh mt mu mv mk b"><strong class="kd hv">+</strong></code>按钮。在新建模块对话框中，选择<code class="eh mt mu mv mk b">Import .JAR/.ARR Package</code>选项并点击<code class="eh mt mu mv mk b">Next</code>。在文件名字段中，导航到您的<code class="eh mt mu mv mk b">libraries/android/approov.aar</code>文件并点击确定。子项目名称字段将用AAR文件的名称填充，在本例中为<code class="eh mt mu mv mk b">approov</code>。点击<code class="eh mt mu mv mk b">Finish</code>。将启动gradle项目同步。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff nd"><img src="../Images/27ceb239c44ba61b6dee962972b1d8ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3-V_0P49JHq-n1nV."/></div></div></figure><p id="b74c" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">回到项目结构对话框，点击对话框左上方的<code class="eh mt mu mv mk b"><strong class="kd hv">+</strong></code>按钮，选择<code class="eh mt mu mv mk b">3. Module Dependencies</code>。在选择模块框中，选择<code class="eh mt mu mv mk b">:approov</code>模块并点击<code class="eh mt mu mv mk b">OK</code>。</p><p id="bd72" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">您可以使用Approov SDK来创建approv证明对象。该对象将定期要求证明服务验证其真实性，并将缓存生成的短期验证令牌。对于API调用，还添加了一个拦截器对象，它将拦截所有API请求，并将最新的令牌添加到请求头中。</p><p id="ff14" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">这几个变化都包含在App类中。将<code class="eh mt mu mv mk b">app/src/main/java/com/criticalblue/android/astropiks/App.java</code>源文件替换为:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mw mx l"/></div></figure><p id="fcf0" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">应该不需要其他更改。</p><p id="3333" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">确保代理服务器正在运行。重新构建并运行Android客户端应用程序。可悲的是，Astropiks客户端仍然没有显示照片！</p><p id="b973" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">如果你做的一切都正确，Approov服务现在正在验证应用程序，但它仍然返回一个失败的验证令牌。在您向证明服务注册应用程序之前，证明者不知道如何验证您的应用程序。</p><p id="62f5" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">要注册这个应用程序，打开一个终端或命令窗口，进入解压后的approov演示文档中的目录，这个文档包含了适合Android和您的本地环境的注册工具。例如，在Linux上，该目录是registration-tools/Android/Linux。运行注册工具，指定应用程序APK的路径。如果你的approov演示位于<code class="eh mt mu mv mk b">~/tutorial/demo</code>，你的Astropiks项目位于<code class="eh mt mu mv mk b">~/tutorial/api-key-proxy/pen/client</code>，那么:</p><pre class="jk jl jm jn fq mj mk ml mm aw mn dt"><span id="ee58" class="lv ky hu mk b fv mo mp l mq mr">tutorial$ cd demo/registration-tools/Android/Linux</span><span id="3393" class="lv ky hu mk b fv ne mp l mq mr">tutorial$ ./registration -a ~/tutorial/api-key-proxy/pen/client/app/<br/>build/outputs/apk/app-debug.apk -t ../../registration_access.tok <br/>-e 2d</span><span id="a282" class="lv ky hu mk b fv ne mp l mq mr">Submitting data…</span><span id="ac3a" class="lv ky hu mk b fv ne mp l mq mr">Success: new app signature added to database.</span><span id="8a7b" class="lv ky hu mk b fv ne mp l mq mr">You can check in the Approov portal that signature vmz6h52XaGJ5VZPWC5W4YQ6kWlU7KR0im/NrVhQclas= has been added to the library 1490625733147480904</span></pre><p id="dd9e" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">请注意，您正在使用和注册调试APK<code class="eh mt mu mv mk b">app-debug.apk</code>。如果您使用的是生产版本，请确保您的APK在注册到approov服务之前已正确签名。</p><p id="4548" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">上面的应用程序注册将在2天后过期。无论设置的过期时间有多长，Approov演示服务都会定期删除客户端注册，因此，如果您将来再次启动客户端，您可能需要再次向演示服务注册它。</p><p id="2372" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">给Approov演示服务几秒钟的时间，你的应用应该可以正确注册了。重新启动您的客户端应用程序，如果一切都正确，证明者服务将不断验证您的客户端，代理服务器将验证Approov令牌并完成API请求，Astropiks客户端将再次显示NASA当天的照片库！</p><p id="cf3f" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated"><em class="nb">作为参考，现阶段客户端app的一个完整版本在</em> <code class="eh mt mu mv mk b"><em class="nb">steps/client/android/2_secure-client</em></code> <em class="nb">中。</em></p><h1 id="7e60" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">没有假客户</h1><p id="7c77" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">秘密已经不在app上了。代理服务器持有API密钥，证明者服务和代理服务器共享一个秘密以在客户机和代理服务器之间建立信任。没有API密匙有可能构建一个假的app吗？</p><p id="394f" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">在Android Studio中，尝试通过简单地清理和重建现有应用程序来构建一个假应用程序。重新安装并运行新构建的应用程序。运行成功吗？</p><p id="48ce" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">尽管它具有完全相同的功能，但这不是同一个APK版本，因此认证失败。如果您想使用这个新应用程序，您必须单独注册这个新版本。</p><h1 id="6c26" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">增强代理服务</h1><p id="8a9d" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">这是一个可选部分，它修改API响应，以便图像下载请求也通过API密钥代理运行，并因此使用approov令牌进行验证。这是一个如何在代理路由处理程序中添加额外处理的示例，以修复响应中包含的URIs，调整或组合API调用，或者添加额外的安全性。</p><p id="6056" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">再次查看来自早期浏览器调用的JSON响应。该响应包括用于下载图像的URL。请注意，这些URL直接指向NASA，不需要API密钥。</p><p id="94f9" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">为了增加安全性，我们也可以通过我们的API代理服务器来运行这些。您可以通过重写响应JSON中的图像下载URL来通过代理来实现这一点。Javascript正则表达式替换重写了URL字符串，并且我们还需要修改<code class="eh mt mu mv mk b">content-length</code>头以考虑更长的JSON主体。您还为<code class="eh mt mu mv mk b">apod</code>图像请求添加了一个简单的直通代理。将现有的<code class="eh mt mu mv mk b">src/api/nasa.js</code>文件替换为:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mw mx l"/></div></figure><p id="0130" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">重启修改后的代理服务器，重启你的Android客户端应用。客户端应用程序应该仍然像往常一样显示照片。在代理服务器控制台中，您现在应该可以看到NASA API和NASA apod图像请求。</p><p id="e1f1" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">当代理更复杂的API时，您需要小心地转换响应，以修复代理的资源URIs和其他重定向。</p><p id="b03d" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">作为参考，此阶段代理服务器的完整版本在<code class="eh mt mu mv mk b">steps/proxy/node/3_enhanced-proxy</code>中。</p><h1 id="fbf1" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">在野外</h1><p id="f8e1" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">不要忘记在生产中使用带有证书固定的TLS，以便通信通道是适当安全的。</p><p id="12bb" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">您的应用程序的每个版本都将被单独注册，您可以根据需要注册和取消注册版本，可能会在下次使用时强制更新未注册的应用程序。</p><p id="f93c" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">当秘密保存在应用程序中时，替换一个泄露的密钥需要更新现有的客户端安装基础。现在，由于API密钥不再位于客户机上，因此可以在API密钥代理服务器上轻松地更改它们，而不需要对移动客户机的安装基础进行任何更改。</p><p id="130c" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">尽管有额外的跃点，API密钥代理服务器提供了增强的安全性、可伸缩性和恢复优势。</p><h1 id="6424" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">前进</h1><p id="7abc" class="pw-post-body-paragraph kb kc hu kd b ke lp iv kg kh lq iy kj kk lr km kn ko ls kq kr ks lt ku kv kw hn dt translated">感谢阅读！如果你推荐这个教程(点击❤按钮)让其他人也能找到它，我会非常感激。</p><p id="7df8" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">要了解更多关于API安全性和相关主题的信息，请访问<a class="ae ka" href="https://www.approov.io/" rel="noopener ugc nofollow" target="_blank">approv . io</a>或在twitter上关注@critblue。</p><div class="jk jl jm jn fq ab cb"><figure class="nf jo ng nh ni nj nk paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="nf jo ng nh ni nj nk paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="nf jo ng nh ni nj nk paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="nl nm nn"><p id="f922" class="kb kc nb kd b ke kf iv kg kh ki iy kj no kl km kn np kp kq kr nq kt ku kv kw hn dt translated"><a class="ae ka" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ka" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ka" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ka" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="kb kc nb kd b ke kf iv kg kh ki iy kj no kl km kn np kp kq kr nq kt ku kv kw hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ka" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ka" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff nr"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>