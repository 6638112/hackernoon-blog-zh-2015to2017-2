<html>
<head>
<title>Monitoring CouchDB with Prometheus, Grafana and Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Prometheus、Grafana和Docker监控CouchDB</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/monitoring-couchdb-with-prometheus-grafana-and-docker-4693bc8408f0?source=collection_archive---------8-----------------------#2017-08-02">https://medium.com/hackernoon/monitoring-couchdb-with-prometheus-grafana-and-docker-4693bc8408f0?source=collection_archive---------8-----------------------#2017-08-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/9669e5199c40f4665b67bdcbcecdcbe5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B8eCC-5y_MvtJXfp3TqVsw.png"/></div></div></figure><p id="0b0b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">假设您已经让新的CouchDB集群在生产环境中工作，然后一个节点出现故障。如果你的设计是可靠的，并且有足够多的CouchDB节点还在运行，你的应用程序应该会继续运行。另一方面，您会想知道一个节点为什么会关闭，这样您就可以确定是否需要调整节点上的内存或CPU。您可能还希望通过电子邮件或slack接收通知，以便可以实时诊断。</p><p id="c2cb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae ka" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>是一个开源监控系统，允许您将监控指标视为生成警报和报告的数据源。它最初是由SoundCloud创建的，后来加入了云原生计算基金会。围绕Prometheus有一个繁荣的社区，许多开发者为许多网络服务贡献了插件(被称为<a class="ae ka" href="https://prometheus.io/docs/instrumenting/exporters/" rel="noopener ugc nofollow" target="_blank"> exporters </a>),包括CouchDB。</p><p id="fdc7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">乍一看，尝试设置Prometheus环境的所有部分可能有点困难，但使用Docker，我们可以轻松地将它们放在同一个机器上，然后再将它们移动到其他机器上，以扩展我们的环境。</p><p id="d4c0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">下面的教程将介绍Ubuntu上的设置，但它可以很容易地适应任何其他运行Docker的操作系统。</p><h1 id="f06d" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">步骤1 —安装Docker</h1><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="6c6a" class="li kc hu le b fv lj lk l ll lm">$ git clone <a class="ae ka" href="https://github.com/redgeoff/docker-ce-vagrant" rel="noopener ugc nofollow" target="_blank">https://github.com/redgeoff/docker-ce-vagrant</a><br/>$ cd <a class="ae ka" href="https://github.com/redgeoff/docker-ce-vagrant" rel="noopener ugc nofollow" target="_blank">docker-ce-vagrant</a><br/>$ sudo ./docker.sh</span></pre><h1 id="bc52" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">步骤2—安装AlertManager</h1><p id="41e3" class="pw-post-body-paragraph jc jd hu je b jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz hn dt translated">AlertManager是一种服务，它决定在生成警报时做什么。</p><p id="d3c1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们创建一个目录来存放我们的普罗米修斯配置文件:</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="954c" class="li kc hu le b fv lj lk l ll lm">$ mkdir /home/ubuntu/prometheus</span></pre><p id="4b1e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，用下面的配置编辑<em class="ls">/home/Ubuntu/Prometheus/alert manager . conf</em>。我们的配置指示AlertManager通过Gmail帐户发送电子邮件，并向我们的<em class="ls"> #alerts </em> slack通道发送消息。您需要启用<a class="ae ka" href="https://api.slack.com/incoming-webhooks" rel="noopener ugc nofollow" target="_blank">传入Webhooks </a>并用您的slack webhook URL替换WEBHOOK-URL。你还需要更换GMAIL密码。为了提高安全性，您可能需要创建一个新的Gmail帐户，这样就不必使用您的主要Gmail密码。</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="8a47" class="li kc hu le b fv lj lk l ll lm">global:<br/>  slack_api_url: 'WEBHOOK-URL'</span><span id="5822" class="li kc hu le b fv lt lk l ll lm">route:<br/>  receiver: 'all-alerts'<br/>  group_by: ['CouchDBDownAlert', datacenter, app]</span><span id="35df" class="li kc hu le b fv lt lk l ll lm">receivers:<br/>- name: 'all-alerts'<br/>  email_configs:<br/>  - to: '<a class="ae ka" href="mailto:to-example@gmail.com" rel="noopener ugc nofollow" target="_blank">to-example@gmail.com</a>'<br/>    from: '<a class="ae ka" href="mailto:from-example@gmail.com" rel="noopener ugc nofollow" target="_blank">from-example@gmail.com</a>'<br/>    smarthost: smtp.gmail.com:587<br/>    auth_username: "<a class="ae ka" href="mailto:from-example@gmail.com" rel="noopener ugc nofollow" target="_blank">from-example@gmail.com</a>"<br/>    auth_identity: "<a class="ae ka" href="mailto:from-example@gmail.com" rel="noopener ugc nofollow" target="_blank">from-example@gmail.com</a>"<br/>    auth_password: "GMAIL-PASSWORD"<br/>  slack_configs:<br/>  - channel: '#alerts'<br/>    send_resolved: true</span></pre><p id="45d1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当然，如果你不想要email_configs或slack_configs中的任何一个，你可以把它们注释掉。还有许多其他<a class="ae ka" href="https://prometheus.io/docs/alerting/configuration/" rel="noopener ugc nofollow" target="_blank">支持的配置</a>。</p><p id="7590" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后，使用以下命令运行警报管理器。该命令将在服务器重新启动或管理器崩溃时自动重新启动管理器。</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="3db6" class="li kc hu le b fv lj lk l ll lm">sudo docker run -d --name alertmanager \<br/> --restart always \<br/>  -p 9093:9093 \<br/>  -v /home/ubuntu/prometheus:/alertmanager \<br/>  prom/alertmanager \<br/>  --config.file=/alertmanager/alertmanager.conf</span></pre><p id="9369" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您曾经更改过alertmanager.conf，您可以用<code class="eh lu lv lw le b">sudo docker restart alertmanager</code>重新启动alertmanager。(您还必须重启Prometheus服务器)</p><h1 id="ebe1" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">步骤3—创建警报</h1><p id="3cd2" class="pw-post-body-paragraph jc jd hu je b jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz hn dt translated">Prometheus使用规则来定义警报，当某个条件为真时就会触发警报。</p><p id="8e6c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">编辑<em class="ls">/home/Ubuntu/Prometheus/Prometheus . rules</em>并创建一个<em class="ls">couchdbdownealert</em>，每当CouchDB节点没有报告其状态或被报告为停机时，就会触发该警报。</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="3e13" class="li kc hu le b fv lj lk l ll lm">groups:<br/>- name: example.rules<br/>  rules:<br/>  - alert: CouchDBDownAlert<br/>    expr: absent(couchdb_httpd_up) or couchdb_httpd_up &lt; 1<br/>    for: 1m<br/>    annotations:<br/>      summary: CouchDB Node Down</span></pre><h1 id="9292" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">步骤4—安装CouchDB导出器</h1><p id="6cb7" class="pw-post-body-paragraph jc jd hu je b jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz hn dt translated">Prometheus通过轮询不同的目标来收集指标。默认情况下，CouchDB不提供普罗米修斯所需格式的指标，但幸运的是，Tobias Gesellchen开发了令人敬畏的<a class="ae ka" href="https://github.com/gesellix/couchdb-prometheus-exporter" rel="noopener ugc nofollow" target="_blank">couch db-普罗米修斯导出器</a>！</p><p id="b137" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">由于导出器会自动报告每个节点的指标，因此只需要运行一个导出器实例就可以覆盖整个CouchDB集群。</p><p id="ac5a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们假设您的集群正在监听默认端口5984。用以下方式运行导出器:</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="49d5" class="li kc hu le b fv lj lk l ll lm">sudo docker run -d --name couchdb-prometheus-exporter \<br/>  --restart always \<br/>  -p 9984:9984 \<br/>  gesellix/couchdb-prometheus-exporter \<br/>  -couchdb.uri=<a class="ae ka" href="http://IP_OR_DNS_FOR_ANY_COUCH_NODE:5984" rel="noopener ugc nofollow" target="_blank">http://IP_OR_DNS_TO_ANY_COUCH_NODE:5984</a> \<br/>  -couchdb.username=COUCH_USER \<br/>  -couchdb.password=COUCH_PASSWORD</span></pre><p id="3014" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您需要运行导出程序的服务器的IP地址。在Linux上，通常可以通过以下方式获得:</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="1ee5" class="li kc hu le b fv lj lk l ll lm">/sbin/ip route | awk '/eth0  proto/ { print $9 }'</span></pre><h1 id="dfb5" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">步骤5—安装普罗米修斯</h1><p id="ea50" class="pw-post-body-paragraph jc jd hu je b jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz hn dt translated">让我们配置Prometheus来轮询它自己和我们的couchdb-prometheus-exporter。编辑<em class="ls">/home/Ubuntu/Prometheus/Prometheus . conf</em>:</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="52a8" class="li kc hu le b fv lj lk l ll lm">global:<br/>  scrape_interval: 15s</span><span id="bb79" class="li kc hu le b fv lt lk l ll lm">external_labels:<br/>    monitor: exporter-metrics</span><span id="aa34" class="li kc hu le b fv lt lk l ll lm">rule_files:<br/>  - 'prometheus.rules'</span><span id="ea1b" class="li kc hu le b fv lt lk l ll lm">alerting:<br/>  alertmanagers:<br/>  - static_configs:<br/>    - targets:<br/>      - <a class="ae ka" href="http://IP_OR_DNS_TO_ALERT_MANAGER_SERVER:9093" rel="noopener ugc nofollow" target="_blank">IP_OR_DNS_TO_ALERT_MANAGER_SERVER</a>:9093</span><span id="8888" class="li kc hu le b fv lt lk l ll lm">scrape_configs:<br/>  - job_name: prometheus</span><span id="d43f" class="li kc hu le b fv lt lk l ll lm">    scrape_interval: 5s</span><span id="7d03" class="li kc hu le b fv lt lk l ll lm">    static_configs:<br/>      # These endpoints are scraped via HTTP.<br/>      - targets:<br/>        - 'localhost:9090'<br/>        - 'IP-OF-EXPORTER-SERVER:9984'</span></pre><p id="5829" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后运行普罗米修斯:</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="99ec" class="li kc hu le b fv lj lk l ll lm">sudo docker run -d --name prometheus-server -p 9090:9090 \<br/>  --restart always \<br/>  -v /home/ubuntu/prometheus/prometheus.conf:/prometheus.conf \<br/>  -v /home/ubuntu/prometheus/prometheus.rules:/prometheus.rules \<br/>  prom/prometheus \<br/>  --config.file=/prometheus.conf</span></pre><p id="666e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这将在服务器重启或崩溃时自动重启Prometheus。</p><p id="6272" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">至此，您现在可以访问<a class="ae ka" href="http://IP_OR_DNS_TO_PROMETHEUS_SERVER:9090" rel="noopener ugc nofollow" target="_blank">http://IP _ OR _ DNS _ TO _ PROMETHEUS _ SERVER:9090</a>查看Prometheus UI。<em class="ls">图表</em>选项卡为您提供了一种快速查看特定指标图表的方式。然而，在下一步中，我们将更进一步，安装Grafana，这样我们就可以轻松地构建漂亮的定制仪表板。</p><p id="3914" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了测试您的警报，停止您的CouchDB节点之一，您应该会收到一封电子邮件和一个slack通知。然后，重新启动节点，您应该会再次收到通知。相当酷！</p><h1 id="a730" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">步骤6—安装Grafana</h1><p id="5bf0" class="pw-post-body-paragraph jc jd hu je b jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz hn dt translated"><a class="ae ka" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>是一个开放的平台，用于漂亮的分析和监控。Grafana让我们能够创建自定义仪表板，并保存我们的数据。我们可以将我们的报告与历史数据进行比较，以确定什么时候事情正在发生或者甚至开始发生。</p><figure class="kz la lb lc fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lx"><img src="../Images/89ab749aae2b418bc600c885dc8d8bbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SvuwlXEX7RkgNqQtKpoisg.png"/></div></div></figure><p id="5da8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为Grafana创建一个卷，以便我们的数据在重新启动后仍然存在:</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="28bb" class="li kc hu le b fv lj lk l ll lm">sudo <!-- -->docker volume create grafana-storage</span></pre><p id="93e2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">运行Grafana:</p><pre class="kz la lb lc fq ld le lf lg aw lh dt"><span id="1b42" class="li kc hu le b fv lj lk l ll lm">sudo docker run -d --name grafana -p 3000:3000 \<br/>    --restart always \<br/>    -v grafana-storage:/var/lib/grafana \<br/>    grafana/grafana</span></pre><p id="c984" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后，您可以通过<a class="ae ka" href="http://IP_OR_DNS_TO_GRAFANA_SERVER:3000." rel="noopener ugc nofollow" target="_blank">http://IP _ OR _ DNS _ TO _ GRAFANA _ SERVER:3000</a>访问web UI，并使用admin/admin登录。登录后，点击侧边栏中的齿轮图标，选择数据源，点击<em class="ls">添加数据源</em>按钮，然后填写以下详细信息:</p><ol class=""><li id="4d96" class="ly lz hu je b jf jg jj jk jn ma jr mb jv mc jz md me mf mg dt translated">名称:普罗米修斯</li><li id="0e81" class="ly lz hu je b jf mh jj mi jn mj jr mk jv ml jz md me mf mg dt translated">类型:普罗米修斯</li><li id="0ff0" class="ly lz hu je b jf mh jj mi jn mj jr mk jv ml jz md me mf mg dt translated">网址:<a class="ae ka" href="http://prom.couchcloud.io:9090" rel="noopener ugc nofollow" target="_blank">http://IP _ OR _ DNS _ TO _ PROMETHEUS _ SERVER:9090</a></li><li id="355d" class="ly lz hu je b jf mh jj mi jn mj jr mk jv ml jz md me mf mg dt translated">访问:直接</li></ol><p id="912d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后，您可以创建一个新的仪表板，并添加一个度量图，如<em class="ls"> couchdb_httpd_up </em>或<em class="ls">couch db _ httpd _ request _ time</em>。太酷了！</p><h2 id="e3c2" class="li kc hu bd kd mm mn mo kh mp mq mr kl jn ms mt kp jr mu mv kt jv mw mx kx my dt translated">更好的安全性</h2><p id="b89f" class="pw-post-body-paragraph jc jd hu je b jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz hn dt translated">您可能想知道如何阻止其他人访问您的报告。最简单的方法之一是将一切置于防火墙之后，确保所有容器都通过私有IP地址连接，然后<a class="ae ka" rel="noopener" href="/@redgeoff/using-a-vpn-server-to-connect-to-your-aws-vpc-for-just-the-cost-of-an-ec2-nano-instance-3c81269c71c2">使用VPN服务器将流量</a>传输到虚拟云中。</p><p id="8836" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们可以做的另一件事是将我们的密码，例如<em class="ls"> couchdb.password </em>移动到<a class="ae ka" href="https://docs.docker.com/compose/env-file/" rel="noopener ugc nofollow" target="_blank"> Docker。环境文件</a>。如果你碰巧在使用Docker Swarm，一个更好的选择是使用<a class="ae ka" href="https://docs.docker.com/engine/swarm/secrets/" rel="noopener ugc nofollow" target="_blank"> Docker Swarm Secrets </a>。</p><h1 id="14a7" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">关于作者</h1><p id="de82" class="pw-post-body-paragraph jc jd hu je b jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz hn dt translated">杰夫·考克斯是MSON的创造者，这是一种新的声明式编程语言，它将允许任何人可视化地开发软件。他喜欢承担雄心勃勃但令妻子抓狂的项目，比如创建数据库和分布式数据同步系统。你可以在<a class="ae ka" href="https://redgeoff.com" rel="noopener ugc nofollow" target="_blank">redgeoff.com</a>或者<a class="ae ka" href="https://twitter.com/coxgeoffrey" rel="noopener ugc nofollow" target="_blank"> @CoxGeoffrey </a>或者<a class="ae ka" href="https://github.com/redgeoff" rel="noopener ugc nofollow" target="_blank"> github </a>上看到更多他的帖子。</p></div></div>    
</body>
</html>