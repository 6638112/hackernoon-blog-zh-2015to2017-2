<html>
<head>
<title>A Tour of C++ 17: If Constexpr</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">C++ 17之旅:If Constexpr</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/a-tour-of-c-17-if-constexpr-3ea62f62ff65?source=collection_archive---------2-----------------------#2017-05-31">https://medium.com/hackernoon/a-tour-of-c-17-if-constexpr-3ea62f62ff65?source=collection_archive---------2-----------------------#2017-05-31</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="4fe2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们兴奋地看到<strong class="it hv"> if-constexpr </strong>已经做成<strong class="it hv"> </strong> C++ 17了！在这篇文章中，我们将看看一些C++ 14代码，并展示如何使用这种新的语言特性使它更简单、更简洁。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/ba483abc4d33ce105b662aa7b8b02859.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EpUtYUOYMkeNSV5_eSRgAw.jpeg"/></div></div></figure><h1 id="6649" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">介绍</h1><p id="80d2" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">在深入研究<strong class="it hv"> if-constexpr </strong>之前，快速回顾一下<code class="eh le lf lg lh b">constexpr</code>可能是有用的。在C++ 11中引入，<code class="eh le lf lg lh b">constexpr</code>是一个关键字，它将表达式或函数标记为具有<em class="li">编译时常量结果</em>。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="0530" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当然，这将被编译器优化掉:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="c1a7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好的，所以你可能想知道<code class="eh le lf lg lh b">constexpr</code>的目的是什么。毕竟，编译器不是足够聪明来优化这样的函数吗，即使它们没有被标记为<code class="eh le lf lg lh b">constexpr</code>？</p><p id="02f2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh le lf lg lh b">constexpr</code>的真正价值是作为<em class="li">保证</em>该函数在编译时是可计算的。这可以防止令人讨厌的副作用随着代码的发展潜入代码中，并且允许编译器做一些聪明的事情:</p><ul class=""><li id="d7bd" class="ll lm hu it b iu iv iy iz jc ln jg lo jk lp jo lq lr ls lt dt translated">与模板和预处理器宏不同，<code class="eh le lf lg lh b">constexpr</code>允许编译时的循环和递归，而没有极端的样板文件。</li><li id="81cd" class="ll lm hu it b iu lu iy lv jc lw jg lx jk ly jo lq lr ls lt dt translated">函数可以作为常规函数使用，尽管在内部它们有更大的限制。</li><li id="e525" class="ll lm hu it b iu lu iy lv jc lw jg lx jk ly jo lq lr ls lt dt translated">随着需求的变化，函数可以很容易地转换成常规函数。</li><li id="f64e" class="ll lm hu it b iu lu iy lv jc lw jg lx jk ly jo lq lr ls lt dt translated"><code class="eh le lf lg lh b">constexpr</code>函数的编译速度比同等的基于模板的解决方案快得多，后者与模板递归的深度成线性比例。</li></ul><h2 id="f046" class="lz kc hu bd kd ma mb mc kh md me mf kl jc mg mh kp jg mi mj kt jk mk ml kx mm dt translated">编译时斐波那契</h2><p id="9346" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">例如，看看斐波那契数列的这两个编译时实现:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="lj lk l"/></div><figcaption class="mn mo fg fe ff mp mq bd b be z ek">Compile-time Fibonacci Using Templates</figcaption></figure><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="lj lk l"/></div><figcaption class="mn mo fg fe ff mp mq bd b be z ek">Compile-time Fibonacci Using Constexpr</figcaption></figure><h2 id="555f" class="lz kc hu bd kd ma mb mc kh md me mf kl jc mg mh kp jg mi mj kt jk mk ml kx mm dt translated">那么什么是<strong class="ak"> if-constexpr </strong>？</h2><p id="f702" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">简而言之，<strong class="it hv"> if-constexpr </strong>扩展了C++语言的编译时子集，以包含if语句。更何况如果<strong class="it hv"> if-constexpr </strong>的一个分支没有被命中，那么它甚至不会被编译。</p><p id="a0e0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有了if-constexpr 供您使用，您不需要求助于复杂的元编程技术，如模板模式匹配和SFINAE。</p><p id="f5df" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们看一些例子。</p><h1 id="c7e4" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">示例1 —获取第n个参数</h1><p id="69bb" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">许多模板元程序在可变类型列表上操作。在C++ 14中，获取第n种类型的参数列表通常使用复杂的模板来实现:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="c330" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">C++ 17让这变得更加直观:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="lj lk l"/></div></figure><h1 id="d27e" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">示例2——API垫片</h1><p id="8975" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">有时你想支持一个替代的API。C++ 14提供了一种简单的方法来检查一个对象是否可以以某种方式使用:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="d00c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，在C++ 14中实现自定义行为可以这样完成:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="5c1e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">等效的C++17要简单得多:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="8213" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这非常方便，因为语义上属于一起的代码不会分散在多个函数中。此外，您甚至可以定义包含<strong class="it hv"> if-constexpr </strong>的lambdas。</p><h1 id="ef8a" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">示例3 —编译时算法选择</h1><p id="203a" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">通常，您需要根据类型的属性找到最佳算法。有很多解决方法。例如，STL使用“类型标签”为一些给定的迭代器选择正确的算法:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="d0a6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，一旦您有了更复杂的规则，您可能需要一个更强大的解决方案— <a class="ae mr" href="http://en.cppreference.com/w/cpp/language/sfinae" rel="noopener ugc nofollow" target="_blank"> SFINAE </a>:</p><p id="a97f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">C++ 14:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="f2cc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用<strong class="it hv"> </strong> C++ 17，你可以用更少的样板文件和更清晰的方式描述这些规则:</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="cd0b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这非常实用，因为使用if语句比使用各种语言特性更直观。</p><p id="b3d0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">重构元函数变得和普通代码一样简单。有了<strong class="it hv"> if-constexpr </strong>，担心不明确的重载和其他意想不到的复杂情况将成为过去。</p><div class="jq jr js jt fq ab cb"><figure class="ms ju mt mu mv mw mx paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="ms ju mt mu mv mw mx paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="ms ju mt mu mv mw mx paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="my mz na"><p id="f922" class="ir is li it b iu iv iw ix iy iz ja jb nb jd je jf nc jh ji jj nd jl jm jn jo hn dt translated"><a class="ae mr" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae mr" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae mr" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae mr" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is li it b iu iv iw ix iy iz ja jb nb jd je jf nc jh ji jj nd jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae mr" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae mr" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ne"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>