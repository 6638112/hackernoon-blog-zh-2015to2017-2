<html>
<head>
<title>Dealing with a nasty AWS Billing Surprise: Beware the defaults.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">处理令人讨厌的AWS账单惊喜:当心违约。</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/dealing-with-an-aws-billing-surprise-beware-the-defaults-d8a95f6635a2?source=collection_archive---------9-----------------------#2017-02-08">https://medium.com/hackernoon/dealing-with-an-aws-billing-surprise-beware-the-defaults-d8a95f6635a2?source=collection_archive---------9-----------------------#2017-02-08</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="7bfb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我的亚马逊Web服务应用程序的<a class="ae jp" href="https://hackernoon.com/tagged/architecture" rel="noopener ugc nofollow" target="_blank">架构</a>应该是<a class="ae jp" href="https://github.com/antsankov/MrRoadboto" rel="noopener ugc nofollow" target="_blank"> <em class="jq">简单的</em> </a> <em class="jq">。这是两个独立的Lambda函数，它们之间有一个Redis缓存用于持久化。通过购买毫秒级的Lambda计算能力，我认为我的应用程序会非常便宜，甚至可能是免费的！当我收到我半个月开发的第一张账单时，我甚至还没有投入生产:26.97美元，如果这还不够糟糕的话，我对下个月的预测应该是40.78美元，甚至没有人使用我的应用程序！</em></p><p id="ac89" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个发现的震惊给我上了宝贵的一课，告诉我如何在<a class="ae jp" href="https://hackernoon.com/tagged/aws" rel="noopener ugc nofollow" target="_blank"> AWS </a>上创建爱好项目:<strong class="it hv">小心过度供应</strong>。在本文的其余部分，我将介绍我是如何确定我的应用程序中成本较高的部分，以及我是如何削减成本的。</p></div><div class="ab cl jr js hc jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hn ho hp hq hr"><p id="7b88" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">转到计费控制台！</strong>当我收到一封来自亚马逊的意想不到的讨厌账单时，我的第一反应是一边咒骂一边不要重新打开邮件。“一定是弄错了……”我完全否认地说。第一步应该是使用AWS网站上的计费控制台来确定成本的实际来源。我去我的时候发现了下面这张吓人的图:</p><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="fe ff jy"><img src="../Images/17d8d3392f8233bf82a6e4df8bd7f59a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6sAaHvqd9xGPcMExbrRd1w.png"/></div></div><figcaption class="kk kl fg fe ff km kn bd b be z ek">$40 for an app I haven’t even launched, yikes!</figcaption></figure><p id="1a14" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">从那里，我注意到两个直接的成本中心:EC2和Elasticache。我觉得这很奇怪。我甚至没有使用任何EC2实例，我只使用Lambda，我在Elasticache中的Redis节点只存储5个字符串。这怎么会让我每月花费41美元呢？！</p><p id="ec83" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我从主页跳转到仪表板，在那里我可以清楚地看到是什么花费了我的钱:</p><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="fe ff ko"><img src="../Images/d25d24a4532140d42616baccdd377cd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*08DzpDKrgjZCpTQ8Yclo9w.png"/></div></div><figcaption class="kk kl fg fe ff km kn bd b be z ek">Aha! My two targets.</figcaption></figure><p id="74ba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我可以看到，这显然是两个有问题的服务，我的NAT网关和我的Redis节点。考虑到降低成本，我知道我有自己的工作要做。</p></div><div class="ab cl jr js hc jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hn ho hp hq hr"><p id="6023" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">推出我自己的NAT网关:</strong>我的第一份工作是更换昂贵的NAT网关，它允许我的Lambda连接到外部网络。亚马逊提供这些网关来处理高达10 Gbps的突发数据。对于我的简单需求来说，这是一种过度的供应。所以我找到了一个有趣的<a class="ae jp" href="https://forums.aws.amazon.com/thread.jspa?threadID=234959" rel="noopener ugc nofollow" target="_blank">解决方案</a>:用NAT AMI设置一个免费的t2.micro。幸运的是，亚马逊为此提供了一个预配置的映像(<strong class="it hv">amzn-ami-VPC-NAT-hvm-2016 . 03 . 0 . x86 _ 64-EBS</strong>)<strong class="it hv">)。</strong>我创建了一个实例，并把它放入我的VPC，放在一个有互联网网关的子网中。</p><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="fe ff kp"><img src="../Images/350113d8efd544dbac962a5f3a83bb44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZD-IkUqzKy7eaD19sEDukw.png"/></div></div><figcaption class="kk kl fg fe ff km kn bd b be z ek">The new instance goes into the subnet with the internet gateway as a default route.</figcaption></figure><p id="21c5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">令人惊讶的是，它开箱即用！我很感谢Amazon提供了一个机器镜像来复制他们的NAT网关功能，但是我发现很不幸的是，设置一个Lambda函数来发出出站请求是如此的困难。如果你在Lambdas和VPCs方面有问题，我推荐你看看这篇AWS <a class="ae jp" href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_NAT_Instance.html" rel="noopener ugc nofollow" target="_blank">文章</a>，以及文森特·德拉加贝非常有用的StackOverflow <a class="ae jp" href="http://stackoverflow.com/questions/35455281/aws-lambda-how-to-setup-a-nat-gateway-for-a-lambda-function-with-vpc-access" rel="noopener ugc nofollow" target="_blank">回答</a>。</p><p id="b623" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">运行新t2.micro实例的成本:<strong class="it hv"> $0 </strong></p></div><div class="ab cl jr js hc jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hn ho hp hq hr"><p id="299c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">以低成本运行Redis</strong>:第二个成本中心是我的Elasticache Redis实例。它花费我6美元的原因是它运行在一个t2.small实例上。考虑到我的简单用例，我只需要将它移动到t2.micro实例中。只是在Elasticache控制台中更改机器类型对吗？<em class="jq">错了</em>。我不知道，我在一个t2.small Elasticache集群上使用了Redis的默认配置，这个集群有两个节点。一个t2.micro只支持一个节点。</p><p id="2751" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这在任何地方都没有记录，更令人沮丧的是，AWS控制台允许我更改集群机器类型，但在列表中的任何地方都没有显示T2.micro。我直接从AWS CLI运行命令，发现实际上我不能将节点类型更改为micro:</p><pre class="jz ka kb kc fq kq kr ks kt aw ku dt"><span id="718c" class="kv kw hu kr b fv kx ky l kz la">aws elasticache list-allowed-node-type-modifications — cache-cluster-id roadbotomicro</span></pre><p id="4f5c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">解决方案就是简单地在t2.micro实例<strong class="it hv">上建立一个全新的Elasticache实例<strong class="it hv">和一个节点</strong>。</strong></p><p id="1a6b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">t2.micro上Redis的成本:<strong class="it hv"> $o </strong></p></div><div class="ab cl jr js hc jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="hn ho hp hq hr"><p id="bc55" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">故事的寓意:AWS是爱好者的绝佳平台。它也是一个金融巨兽，通过为大公司过度提供资源来赚取大量金钱，而这些大公司却忘记了这些小支出加起来有多少。然而，作为一个业余爱好者，你需要格外小心自己的预算。就像我们已经学会要小心安装程序或下载按钮一样，我们需要小心AWS产品的默认配置。</p><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div class="fe ff lb"><img src="../Images/52826bbd7bc6344e4b7ef441c8f49e13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/1*rkH1IkuDuLiN8p5WgbsfQQ.gif"/></div><figcaption class="kk kl fg fe ff km kn bd b be z ek">When you avoid the shiny defaults…</figcaption></figure><div class="jz ka kb kc fq ab cb"><figure class="lc kd ld le lf lg lh paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="lc kd ld le lf lg lh paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="lc kd ld le lf lg lh paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="li lj lk"><p id="f922" class="ir is jq it b iu iv iw ix iy iz ja jb ll jd je jf lm jh ji jj ln jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是T21家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is jq it b iu iv iw ix iy iz ja jb ll jd je jf lm jh ji jj ln jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="fe ff lo"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="jz ka kb kc fq kd"><div class="bz el l di"><div class="lp lq l"/></div></figure></div></div>    
</body>
</html>