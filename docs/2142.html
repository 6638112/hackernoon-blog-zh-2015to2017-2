<html>
<head>
<title>Fixing bugs and handling 186k requests/second using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python修复错误并处理每秒186k的请求</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/fixing-bugs-and-handling-186k-requests-second-using-python-2e75d2f9f4f6?source=collection_archive---------7-----------------------#2017-01-08">https://medium.com/hackernoon/fixing-bugs-and-handling-186k-requests-second-using-python-2e75d2f9f4f6?source=collection_archive---------7-----------------------#2017-01-08</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="dccd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://github.com/channelcat/sanic" rel="noopener ugc nofollow" target="_blank"> Sanic </a>是一个<a class="ae jp" href="https://hackernoon.com/tagged/python3" rel="noopener ugc nofollow" target="_blank"> Python3 </a> <a class="ae jp" href="https://hackernoon.com/tagged/framework" rel="noopener ugc nofollow" target="_blank">框架</a>，使用稍微新引入的<a class="ae jp" href="https://docs.python.org/3/library/asyncio-task.html" rel="noopener ugc nofollow" target="_blank">协程</a>构建，利用uvloop并基于Flask。但是，它有一个问题，使其无法正确利用多个流程。前面的代码试图天真地产生新的服务器，而没有显式地继承套接字连接:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="ab53" class="jz ka hu jv b fv kb kc l kd ke">processes = []<br/>for _ in range(workers):<br/>    process = Process(target=serve, kwargs=server_settings)<br/>    process.start()<br/>    ...</span></pre><p id="bc83" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这导致只有一个进程实际处理请求。在Guido Van Rossum和uvloop的创建者Yury Selivanov(相关链接<a class="ae jp" href="https://github.com/python/asyncio/issues/481" rel="noopener ugc nofollow" target="_blank">此处为</a>)的帮助下，我能够通过在父进程中创建一个套接字并将其传递给子进程来实现一个解决方案:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="d2d0" class="jz ka hu jv b fv kb kc l kd ke">sock = socket()<br/>sock.setsockopt(SOL_SOCKET, SO_REUSEADDR, 1)<br/>sock.bind((server_settings['host'], server_settings['port']))<br/>set_inheritable(sock.fileno(), True)<br/>server_settings['sock'] = sock<br/>server_settings['host'] = None<br/>server_settings['port'] = None<br/>processes = []<br/>for _ in range(workers):<br/>    process = Process(target=serve, kwargs=server_settings)<br/>    process.daemon = True<br/>    process.start()<br/>    processes.append(process)</span></pre><p id="4cce" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我在本地验证了这些更改对吞吐量的影响(我能够使用4个进程实现每秒双倍的请求数)，以及多个进程实际上响应了请求(通过用进程id进行响应)。最后，我提供了一个20核数字Ocean droplet，并使用20个工作进程通过<code class="eh kf kg kh jv b">wrk -t250 -c500 <a class="ae jp" href="http://localhost:8000" rel="noopener ugc nofollow" target="_blank">http://localhost:8000</a></code>对服务器进行了基准测试:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="a9c1" class="jz ka hu jv b fv kb kc l kd ke">from sanic.response import text<br/>from sanic import Sanic</span><span id="127e" class="jz ka hu jv b fv ki kc l kd ke">app = Sanic()</span><span id="3f70" class="jz ka hu jv b fv ki kc l kd ke">@app.route('/')<br/>async def hello(request):<br/>    return text("OK")</span><span id="1d37" class="jz ka hu jv b fv ki kc l kd ke">if __name__ == '__main__':<br/>     app.run(workers=20)</span></pre><p id="e999" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">并且能够在最大运行时间内达到每秒186k的请求。这将继续随着CPU数量的增加而增加。变更还没有被合并(编辑:变更已经被合并了，所以您现在可以从主分支进行合并)，尽管它可能很快就会被合并。同时，您应该能够通过克隆sanic存储库，使用<code class="eh kf kg kh jv b">worker</code>分支，并将上面的文件保存到<code class="eh kf kg kh jv b">hello.py</code>来演示它:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="5f58" class="jz ka hu jv b fv kb kc l kd ke">git clone <a class="ae jp" href="https://github.com/channelcat/sanic" rel="noopener ugc nofollow" target="_blank">https://github.com/channelcat/sanic</a><br/>cd sanic<br/>git checkout workers<br/>pip3 install -r requirements.txt<br/>python3 hello.py</span></pre><p id="519c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当然，你也需要一个20芯的滴管。我只跑了6分钟，每小时花费不到1美元。所以如果你对复制感兴趣，请告诉我进展如何！我本来打算在AWS上用36核来做这件事，但是显然我2年前的账户由于某种原因仍然“悬而未决”。无论如何，感谢阅读！此外，感谢尤里和BDFL！</p><blockquote class="kj kk kl"><p id="c117" class="ir is km it b iu iv iw ix iy iz ja jb kn jd je jf ko jh ji jj kp jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="dca4" class="ir is km it b iu iv iw ix iy iz ja jb kn jd je jf ko jh ji jj kp jl jm jn jo hn dt translated">要了解更多信息，请<a class="ae jp" href="https://goo.gl/4ofytp" rel="noopener ugc nofollow" target="_blank">阅读我们的“关于”页面</a>、<a class="ae jp" href="http://bit.ly/HackernoonFB" rel="noopener ugc nofollow" target="_blank">在脸书上点赞/给我们发消息</a>，或者简单地说，<a class="ae jp" href="https://goo.gl/k7XYbx" rel="noopener ugc nofollow" target="_blank"> tweet/DM @HackerNoon。</a></p><p id="708a" class="ir is km it b iu iv iw ix iy iz ja jb kn jd je jf ko jh ji jj kp jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jq jr js jt fq kq"><div class="bz el l di"><div class="kr ks l"/></div></figure></div></div>    
</body>
</html>