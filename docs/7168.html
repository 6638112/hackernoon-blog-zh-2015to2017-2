<html>
<head>
<title>Microservices are hard — an invaluable guide to microservices.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">微服务很难——微服务的无价指南。</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/microservices-are-hard-an-invaluable-guide-to-microservices-2d06bd7bcf5d?source=collection_archive---------0-----------------------#2017-10-19">https://medium.com/hackernoon/microservices-are-hard-an-invaluable-guide-to-microservices-2d06bd7bcf5d?source=collection_archive---------0-----------------------#2017-10-19</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="8934" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你想迁移到微服务，我有一些非常有用的建议给你，这是我们在从整体迁移到可扩展、可维护的微服务架构的过程中学到的。</p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h1 id="ec53" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">背景</h1><p id="6505" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">18个月以来，我们一直在构建我们的平台。开始时相对简单。我们有一个<strong class="it hv">小型</strong> go服务器(使用<a class="ae jp" href="https://github.com/gin-gonic/gin" rel="noopener ugc nofollow" target="_blank"> Gin </a>)和一些REST端点。它看起来有点像这样。</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="bfc2" class="lj jy hu lf b fv lk ll l lm ln">https://oursite.com/api/v1/places<br/>https://oursite.com/api/v1/users<br/>https://oursite.com/api/v1/bookings</span></pre><p id="e949" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每个资源都有自己的版本URL。他们将各自支持<strong class="it hv">岗位</strong>，<strong class="it hv">获取</strong>，<strong class="it hv">补丁</strong>，<strong class="it hv">必要时删除</strong>。我们有两个独立的移动客户端连接到这些API，我们有一个集中的数据库。我们使用<a class="ae jp" href="https://jwt.io" rel="noopener ugc nofollow" target="_blank"> JWT </a>进行用户认证，一切进展顺利。我们每小时处理相当多的请求。然而，我们需要改变我们的平台。移动应用程序不太好用。</p><p id="0c79" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是我们开始遇到问题的地方。我们有大量涉及2个web应用程序的新需求。有两个选择，其中只有一个是可行的。我们可以重写我们的整个架构，花几个月的时间编写一个具有所需功能的新服务器，或者我们可以使用现有的服务器，并为其添加新功能。考虑到时间限制，我们使用了现有的服务器。</p><p id="7d03" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">几周后，我们的遗留代码已经开始增长，我们开始遇到问题。改变模式变得越来越困难，一切都像是一件苦差事。我们坚持不了多久，来到了另一个路口。我们现在的选择是:继续构建当前的服务器，在扩展时遇到困难的问题<strong class="it hv">或者</strong>迁移到一个更具可扩展性和可维护性的方法。一颗银弹，如果你愿意的话。</p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h1 id="ebb5" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">什么是微服务？</h1><p id="f061" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">无论如何想象，微服务都不是银弹。谈到<a class="ae jp" href="https://hackernoon.com/tagged/software-development" rel="noopener ugc nofollow" target="_blank">软件开发</a>，我不相信有什么灵丹妙药。如果有人告诉你有，要持怀疑态度。基本上，微服务做到了他们在铁皮上说的话。它们是小型的、孤立的服务，代表了你的业务领域的一小部分。</p><p id="55ac" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于微服务应该如何工作和通信，每个人都有不同的看法，但有些信念比其他信念更普遍。说它们简单是一种保守的说法。微服务架构的概念简单而理想。最初的处决？远非如此。</p><figure class="la lb lc ld fq lq fe ff paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="fe ff lp"><img src="../Images/5a542bcd2324dd29a5ae4fa1a22cc06a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xu1Ge_Cew0DHdSU6ETcpLQ.png"/></div></div><figcaption class="lx ly fg fe ff lz ma bd b be z ek">Monolithic vs Microservice — courtesy of <a class="ae jp" href="https://www.weave.works" rel="noopener ugc nofollow" target="_blank">https://www.weave.works</a></figcaption></figure><p id="f5f1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上图解释了单片架构和非常简单的微服务架构之间的区别。使用单一架构，您有一个大型服务器负责处理所有请求。这会让你大吃一惊。这会给你很大的打击。然而，微服务可以根据您的业务需求平衡流量。如果您收到大量付款，您可以扩大您的付款服务，并保持其他服务使用较少的资源。这是<a class="ae jp" href="https://www.ibm.com/blogs/cloud-computing/2014/04/explain-vertical-horizontal-scaling-cloud/" rel="noopener ugc nofollow" target="_blank">水平缩放</a>的最佳表现。</p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h2 id="198b" class="lj jy hu bd jz mb mc md kd me mf mg kh jc mh mi kl jg mj mk kp jk ml mm kt mn dt translated">微服务听起来很棒，为什么很难？</h2><p id="277a" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">微服务非常理想化，你会听到相对较少的大公司宣扬其好处。我觉得好像很多小公司错误地把这些信息当成了福音。这些大公司如<strong class="it hv">优步</strong>、<strong class="it hv">谷歌</strong>、<strong class="it hv"> AirBnb </strong>、<strong class="it hv"> Square </strong>等等之所以能做好微服务，是因为它们<em class="lo">绝对负载</em>。他们有资源和时间来投资构建这个架构。</p><p id="df80" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当你开始研究微服务时，你进入了一个绝对巨大的兔子洞。它让《爱丽丝梦游仙境》看起来像个穿洞。您很快就会了解到，您需要管理所有这些微服务并平衡负载，同时监控正在发生的一切。哦，不要忘记，当您构建新功能时，您需要在本地测试每个服务。</p><p id="cb68" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">经过几周的研究和测试，这里有一个我推荐研究的每个服务和工具的责任清单</p><ul class=""><li id="b699" class="mo mp hu it b iu iv iy iz jc mq jg mr jk ms jo mt mu mv mw dt translated">集装箱(<a class="ae jp" href="https://www.docker.com" rel="noopener ugc nofollow" target="_blank">码头工人</a></li><li id="9615" class="mo mp hu it b iu mx iy my jc mz jg na jk nb jo mt mu mv mw dt translated">编排(<a class="ae jp" href="https://kubernetes.io" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>)</li><li id="ca7e" class="mo mp hu it b iu mx iy my jc mz jg na jk nb jo mt mu mv mw dt translated">管理(<a class="ae jp" href="https://forge.sh" rel="noopener ugc nofollow" target="_blank">伪造</a>)</li><li id="f5c1" class="mo mp hu it b iu mx iy my jc mz jg na jk nb jo mt mu mv mw dt translated">Api网关/金丝雀(<a class="ae jp" href="https://www.getambassador.io" rel="noopener ugc nofollow" target="_blank">大使</a>)</li><li id="1cd0" class="mo mp hu it b iu mx iy my jc mz jg na jk nb jo mt mu mv mw dt translated">边缘代理(<a class="ae jp" href="https://envoyproxy.github.io" rel="noopener ugc nofollow" target="_blank">特使</a>)</li><li id="10c3" class="mo mp hu it b iu mx iy my jc mz jg na jk nb jo mt mu mv mw dt translated">监控(<a class="ae jp" href="https://prometheus.io" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a>)</li><li id="5243" class="mo mp hu it b iu mx iy my jc mz jg na jk nb jo mt mu mv mw dt translated">本地测试(<a class="ae jp" href="https://www.telepresence.io" rel="noopener ugc nofollow" target="_blank">远程呈现</a>)</li></ul><p id="7882" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">看看这个列表，对于一个简单的服务来说，这是一个很大的负担。然而，能够监控服务之间的交互并编排它们是非常强大的。这里面有些术语可能会让人困惑。我会涵盖最令人困惑的。</p><p id="f4fc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">边缘代理</strong> —边缘代理是一个与您的服务并行运行的进程，它通过自己的内部系统代理您的服务流量，通常使用某种中间件(如prometheus)来监控和跟踪该流量。大使是建立在特使，并提供更多的功能。</p><p id="b682" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">集装箱</strong>——你现在很可能听说过Docker。这是网络上的容器标准。这实际上是对“容器”一词的一种玩法。您可以考虑docker容器和小型运输容器，它们在云中运行您的应用程序，并由orchestrator移动和优化它们。他们还直接使用linux容器。</p><p id="b47d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">配器 — Kubernetes是最受欢迎的配器，它与Docker配合得非常好。它本质上使用你的docker容器，并照看它们以确保它们都以一种有效的方式工作。</p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h2 id="b9e3" class="lj jy hu bd jz mb mc md kd me mf mg kh jc mh mi kl jg mj mk kp jk ml mm kt mn dt translated">我听说我可以在每个微服务中使用任何语言，是这样吗？</h2><p id="3334" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">确定<strong class="it hv">。你可以为微服务使用任何语言，就像你可以穿着靴子跑马拉松一样。这是可能的，但并不意味着它是有效的，你可能是在浪费时间。创建稳定且可扩展的微服务架构的关键是确保它是可维护的，并且符合您企业的总体趋势。</strong></p><p id="148b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你的架构应该有坚实的基础。如果有人参与你的项目，你应该能够说:</p><blockquote class="nc nd ne"><p id="c78e" class="ir is lo it b iu iv iw ix iy iz ja jb nf jd je jf ng jh ji jj nh jl jm jn jo hn dt translated">通常，我们的服务是用{主语言}编写的。他们使用以下框架:{框架列表}。如果你认为一项服务应该使用不同的语言，你将负责确保它与我们现有的服务具有相同的功能。</p></blockquote><p id="ce62" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这保持了项目的一致性。当然，也有例外。如果您有一个执行复杂数学运算并处理大量流量的服务，那么您可能希望选择一种更适合该任务的语言。然而，这不是一项简单的任务。如果您在PSL(主要服务语言)中有依赖项，那么在新语言中重新构建这种依赖项可能需要时间。</p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h2 id="1d2a" class="lj jy hu bd jz mb mc md kd me mf mg kh jc mh mi kl jg mj mk kp jk ml mm kt mn dt translated">微服务如何沟通？</h2><p id="c0bd" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">过去微服务的主要问题之一是延迟问题。在多个服务之间发出多个HTTPS请求可能会给客户端带来相当明显的延迟。这不是一个可行的方法，当然也不是轻量级的。</p><p id="e417" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">微服务需要一种新的方法，于是我们的救星来了:<a class="ae jp" href="https://grpc.io" rel="noopener ugc nofollow" target="_blank"> gRPC </a>。gRPC是一个高效的RPC框架，它的设计考虑了速度和效率。二进制数据通过线路高速发送，同时还有快速的序列化/反序列化。</p><p id="50fc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用gRPC，您可以使用一个<strong class="it hv"> protobuf </strong>定义来定义您的模型，这相当简单，并且他们有一个用于许多常见语言的protobuf编译器。使用gRPC平息了对延迟的担忧。</p><p id="552d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，使用这些protobuf模型会带来一些困惑。<strong class="it hv">版本化。</strong>过去几周我们一直在研究这个问题，想知道不同的服务如何共享相同的protobuf模型(例如，一个用户模型)。我们有一些想法，比如将protobuf模型保存在一个版本化的git存储库中，但是我们没有被说服。我们目前正在研究这方面的最佳机制。</p><p id="22a6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用gRPC也有问题。您可能还需要维护一个标准的REST API，供标准的web客户端访问。我们正在使用envoy和<a class="ae jp" href="https://github.com/grpc-ecosystem/grpc-gateway" rel="noopener ugc nofollow" target="_blank"> grpc-gateway </a>在这方面取得进展。这仍然是一个复杂的问题，在微服务领域似乎没有得到太多的报道。</p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h1 id="04e2" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">迁移</h1><p id="811e" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">如果你正在考虑构建一个微服务架构，我不建议你这么做。你将花费太多的时间对你并不真正了解的域名进行不成熟的优化。要创建一个可靠的微服务架构，你需要确切地知道你为什么要这么做，没有人能真正告诉你。</p><p id="3ef8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，如果你已经有了一个整体，你正在寻找迁移，这里有一些建议。</p><ul class=""><li id="003a" class="mo mp hu it b iu iv iy iz jc mq jg mr jk ms jo mt mu mv mw dt translated">确定你的<a class="ae jp" href="https://docs.microsoft.com/en-us/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/microservice-domain-model" rel="noopener ugc nofollow" target="_blank">业务领域</a>(有界环境)</li><li id="1a87" class="mo mp hu it b iu mx iy my jc mz jg na jk nb jo mt mu mv mw dt translated">彻底研究Docker，Kubernetes和特使</li><li id="13f5" class="mo mp hu it b iu mx iy my jc mz jg na jk nb jo mt mu mv mw dt translated">研究监控和测试工具</li><li id="5550" class="mo mp hu it b iu mx iy my jc mz jg na jk nb jo mt mu mv mw dt translated">花大量时间制作演示</li></ul><p id="04e7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是我们的亲身经历。我们花了很多时间在谷歌云平台上，用新工具创建不同的架构，发现什么最适合我们。我们目前使用以下堆栈:</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="49df" class="lj jy hu lf b fv lk ll l lm ln">Primary Service Language: Go<br/>Primary Service Datastore: Postgresq<br/>Cloud Platform: Google Cloud<br/>Containers: Docker<br/>Container Orchestration: Kubernetes<br/>Edge Proxy: Envoy<br/>Local Testing: Telepresence<br/>Monitoring: Prometheus<br/>Management: Forge</span></pre><p id="e229" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">完成迁移经历了令人兴奋的几个月。这很难。然而，最近我们偶然发现一家公司打破了构建微服务架构的复杂门槛。他们创建了许多工具来帮助您开始使用微服务，通过我们有限的经验，我们很喜欢使用它们。该团队也非常尊重，知识渊博，反应迅速。</p><p id="5350" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">给他们点爱在<a class="ae jp" href="https://www.datawire.io" rel="noopener ugc nofollow" target="_blank"> https://www.datawire.io </a>。看看他们的产品，通读他们的文件。你会对微服务有更多的了解。</p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><p id="986e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我很想知道你的想法，并感谢你对这个话题的想法。如果你能从你的经历中给我们一些建议，请告诉我。我也很乐意回答任何关于我们经历的问题。</p><p id="4c87" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本帖由https://baeji.com<a class="ae jp" href="https://baeji.com" rel="noopener ugc nofollow" target="_blank">赞助</a></p><figure class="la lb lc ld fq lq"><div class="bz el l di"><div class="ni nj l"/></div></figure></div></div>    
</body>
</html>