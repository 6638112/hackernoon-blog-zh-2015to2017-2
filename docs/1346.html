<html>
<head>
<title>Shared Components Across Multiple Laravel/Lumen Micro-Services</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">跨多个Laravel/Lumen微服务的共享组件</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/shared-components-across-multiple-laravel-lumen-micro-services-44ebee128fa1?source=collection_archive---------1-----------------------#2016-10-16">https://medium.com/hackernoon/shared-components-across-multiple-laravel-lumen-micro-services-44ebee128fa1?source=collection_archive---------1-----------------------#2016-10-16</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/93aac2bd8c3beedf8399769b47773be1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/0*xPiq8ZkTYxpuR-EU.png"/></div></figure><p id="7656" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在<a class="ae jw" href="https://www.stomt.com" rel="noopener ugc nofollow" target="_blank"> stomt </a>我们收集建设性的反馈，归结为单一的论点，识别重复的，并将它们合并到运动中。</p><p id="cb09" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在这篇博文中，我们展示了一种将大型Laravel应用程序拆分成较小的微服务的方法，在我们的例子中是Laravel &amp; Lumen应用程序，以及它带来的优点和缺陷。结果，我们将应用程序的速度提高了30%以上，并且获得了更好的可维护性。当然，这些原则可以很容易地应用于其他框架。</p><h2 id="6312" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr dt translated">为什么我们要在Laravel和Lumen实例之间共享组件？</h2><p id="f242" class="pw-post-body-paragraph iy iz hu ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hn dt translated">我们的后端是一个巨大的Laravel应用程序。我们有一个服务器端呈现的管理界面，一个为我们的客户提供的<a class="ae jw" href="https://rest.stomt.com" rel="noopener ugc nofollow" target="_blank"> REST API </a>，一个OAuth 2.0服务器，以及我们自己的URL缩短器(stomt.co)。此外，我们有一个队列后端，用于调整图像大小和其他不应该打扰我们的客户的密集型任务。我不想说Laravel很慢，但我们正在寻找更好的性能，当Lumen出现时，我们决定将我们的后端分成多个微服务。这将使它更容易在几个Amazon Web服务之间扩展，也允许给某些特性更好和更个性化的可维护性。</p><p id="48c2" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们的REST API和管理面板中都需要很多函数。但是，尽管REST API结果有时是不够的，并且有时需要特殊的行为，但我们不能100%依赖于只是从一个服务到另一个服务进行API调用。此时，我们需要能够从Laravel(由我们的管理面板使用)以及Lumen(我们的REST API)调用命令/作业。</p><p id="534f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">虽然我们仍然有一个“单一的”代码库，但我们有多个完全独立的后端应用程序。你可能想称它们为“微服务”(因为它太时髦了)。</p><h2 id="b2e9" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr dt translated">拆分应用程序时的要求</h2><p id="4b76" class="pw-post-body-paragraph iy iz hu ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hn dt translated">当每个服务都有自己的名称空间时，如何确保组件，尤其是命令、配置和服务提供者可以跨不同的服务使用？</p><ol class=""><li id="3951" class="kx ky hu ja b jb jc jf jg jj kz jn la jr lb jv lc ld le lf dt translated">开始使用组件(我们将在后面讨论)</li><li id="2918" class="kx ky hu ja b jb lg jf lh jj li jn lj jr lk jv lc ld le lf dt translated"><a class="ae jw" href="https://laravel.com/docs/5.3/events#writing-event-subscribers" rel="noopener ugc nofollow" target="_blank">利用事件订阅者类</a>和<a class="ae jw" href="https://laravel.com/docs/5.3/events#registering-event-subscribers" rel="noopener ugc nofollow" target="_blank">注册它们</a>(因此每个组件应该有自己的事件订阅者类)</li><li id="1182" class="kx ky hu ja b jb lg jf lh jj li jn lj jr lk jv lc ld le lf dt translated">确保在<a class="ae jw" href="https://laravel.com/docs/5.3/queues#creating-jobs" rel="noopener ugc nofollow" target="_blank">命令(现在称为“作业”)</a>或类似的东西中有所有的业务逻辑。将所有业务逻辑封装在组件中是很重要的。您的命令无法从外部访问数据。您在您的HTTP层<a class="ae jw" href="https://laravel.com/docs/5.3/controllers" rel="noopener ugc nofollow" target="_blank">(在控制器中)</a>中这样做，并传递数据。</li><li id="5025" class="kx ky hu ja b jb lg jf lh jj li jn lj jr lk jv lc ld le lf dt translated">根据你的文件夹结构在任何地方使用名称空间。(推荐PSR-4)</li><li id="738a" class="kx ky hu ja b jb lg jf lh jj li jn lj jr lk jv lc ld le lf dt translated">确保所有的事情都有一个单一的责任。这样做得越多，共享组件的灵活性就越大。</li></ol><h2 id="cfe0" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr dt translated">拆分应用程序</h2><p id="1580" class="pw-post-body-paragraph iy iz hu ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hn dt translated">软件随着时间而发展。你不会开始为你的后端开发一个<a class="ae jw" href="https://en.wikipedia.org/wiki/Domain-driven_design" rel="noopener ugc nofollow" target="_blank">领域驱动的设计</a>。你从一个原型开始，让你的架构进化或者重写。然后，你应该不断记住保持你的技术债务低。从一开始，我们至少决定基于。一种模块化结构，采用<a class="ae jw" href="https://en.wikipedia.org/wiki/SOLID_(object-oriented_design)" rel="noopener ugc nofollow" target="_blank">坚实</a>原则的低层次方法。</p><h2 id="24bd" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr dt translated">让我们来看看组件是什么样子的:</h2><figure class="lm ln lo lp fq iv fe ff paragraph-image"><div class="fe ff ll"><img src="../Images/a2a885544a7fddfdad20d8b2848c3e76.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/0*3S7zvUXRp3rs-RyA.png"/></div></figure><p id="720e" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">斯托特组件</p><p id="7424" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">当路由和控制器停留在HTTP层时，组件包括所有的业务逻辑，这些逻辑被分离在<a class="ae jw" href="https://laravel.com/docs/5.3/queues#creating-jobs" rel="noopener ugc nofollow" target="_blank">命令</a>(同时在Laravels语言中称为“作业”)中，产生<a class="ae jw" href="https://laravel.com/docs/5.3/events" rel="noopener ugc nofollow" target="_blank">事件</a>及其处理程序以及实体/模型/存储库。组件文件夹也可以有子组件。组件之间也可以相互通信。</p><p id="9e35" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们网络平台上的帖子被称为“定制”。假设客户可以有评论。您将创建一个名为“Comment”的子组件，并将其放入自定义组件文件夹中。注释文件夹将具有相同的子文件夹结构。</p><h2 id="3197" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr dt translated">如何构建新的后端</h2><p id="518c" class="pw-post-body-paragraph iy iz hu ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hn dt translated">基本思想:<em class="lq"> apps </em>文件夹包含多个Laravel/Lumen实例。</p><figure class="lm ln lo lp fq iv fe ff paragraph-image"><div class="fe ff lr"><img src="../Images/dc503fb22e6bf6290209cb0bd0866a10.png" data-original-src="https://miro.medium.com/v2/resize:fit:560/format:webp/1*5QTvA3WyvTQAoFw9mz9PPw.png"/></div></figure><p id="e322" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">任何与部署相关的东西:ElasticBeanstalk文件、配置、迁移和种子、环境——文件和脚本都基于后端的根目录。共享文件夹包含我们的共享组件和服务提供商。我们将很快对此进行深入研究。</p><p id="a67d" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">例如，<em class="lq"> Release.sh </em>通过<a class="ae jw" href="https://github.com/danielgtaylor/aglio" rel="noopener ugc nofollow" target="_blank"> aglio </a>自动创建一个新的git流版本，包括语义版本化和重新生成我们的API文档。</p><p id="698b" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><em class="lq"> Update.sh </em>调用所有服务/应用中的依赖关系更新编写器命令。</p><p id="ba9f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">现在让我们再深入一步。</p><figure class="lm ln lo lp fq iv fe ff paragraph-image"><div class="fe ff lr"><img src="../Images/01752a24700766cb5265edddaec14aba.png" data-original-src="https://miro.medium.com/v2/resize:fit:560/format:webp/1*o0ch4q4yctbJPXYQvlWYKA.png"/></div></figure><p id="00e9" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">仔细看看<em class="lq">API</em>-应用程序文件夹。我们总是引用词根<em class="lq">。env </em> -file，同时使用符号链接引用根文件夹中的<em class="lq">配置</em>和<em class="lq">数据库</em>文件夹。这样，由于每个配置文件允许多种配置，因此可以轻松地跨所有服务维护配置。这可能是Laravel特有的。您还可以看到我们在共享文件夹中存储了什么:组件、提供者和服务。稍后我们将探讨如何使服务提供者可共享。让我们先来看看如何通过正确使用<a class="ae jw" href="http://www.php-fig.org/psr/psr-4/" rel="noopener ugc nofollow" target="_blank">名称空间</a>和<a class="ae jw" href="https://getcomposer.org/" rel="noopener ugc nofollow" target="_blank">编写器</a>来使<em class="lq">共享</em>-文件夹可访问。</p><h2 id="6210" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr dt translated">为共享组件自动加载多个名称空间</h2><p id="4750" class="pw-post-body-paragraph iy iz hu ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hn dt translated">现在，我们该如何处理名称空间呢？Composer使得定义PSR-4名称空间变得非常容易。虽然我们的每个应用程序都有自己的名称空间(例如REST API的<em class="lq"> StomtApi </em>)并且配置文件不需要它们，但是我们的Components文件夹有自己的名称空间<em class="lq"> Stomt。</em></p><p id="3b22" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们通过使用composers自动加载配置使这些文件可访问:</p><figure class="lm ln lo lp fq iv fe ff paragraph-image"><div class="fe ff ll"><img src="../Images/3b0dcaf76e3b009a768b4fb0d6dd31da.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/0*MjaIJUAVKJ6K7tkA.png"/></div></figure><p id="6e4c" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">很简单，是吧？现在，我们总是部署完整的单片代码库，同时具有应用程序精简和更易维护的优势。需要时，可以将Lumen用于我们的REST API和成熟的Laravel框架，从而获得更高的性能。</p><h2 id="f5b7" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr dt translated">如何在Lumen和Laravel应用程序之间共享服务提供者</h2><p id="b5b4" class="pw-post-body-paragraph iy iz hu ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hn dt translated">如果想让服务提供者在Laravel和Lumen应用程序之间可访问，有一个小陷阱。它们都扩展了不同的<em class="lq">事件服务提供者</em>。</p><p id="edd4" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">Lumen延伸自:<br/><em class="lq">Laravel \ Lumen \ Providers \ EventServiceProvider</em><br/>而Laravel延伸自:<br/><em class="lq">Illuminate \ Foundation \ Support \ Providers \ EventServiceProvider</em></p><p id="85bb" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">但是如果你看看里面，两者都在做完全一样的事情。Laravel使用事件facade，而Lumen使用<em class="lq">app(‘events’)</em>来获取事件实例，因为在Lumen中，facade是默认禁用的。为了确保服务提供商系统仍然工作，Lumen使用了<em class="lq">应用程序(‘事件’)</em>。由于Lumen方式也适用于Laravel，解决方案是显而易见的。我们将把Lumens EventServiceProvider复制到共享的<em class="lq">Providers</em>-文件夹中，并将该文件重命名为“ServiceProvider”。然后，我们让所有服务提供商扩展我们新的<em class="lq">服务提供商</em>。(您不能称它为“EventServiceProvider ”,因为您通常使用<em class="lq"> EventServiceProvider </em>在您的应用程序中注册<a class="ae jw" href="https://laravel.com/docs/5.3/events#registering-event-subscribers" rel="noopener ugc nofollow" target="_blank">事件订阅者</a>)</p><p id="a806" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">总的来说:共享服务提供商是否有意义完全取决于你的应用程序。对我们来说确实如此，因此我们想分享如何做到这一点。</p><h2 id="7e3c" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr dt translated">未来的步骤</h2><p id="a7be" class="pw-post-body-paragraph iy iz hu ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hn dt translated">长期目标是让组件越来越与框架无关。关于Laravel特定立面的讨论:我们不再使用它们了。</p><p id="b12e" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们接下来将把应用程序的哪些部分转换成自己的服务？授权和搜索。</p><p id="3e0f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">请随时在这里或在<a class="ae jw" href="https://news.ycombinator.com/item?id=12719496" rel="noopener ugc nofollow" target="_blank"> HN </a>上提出建议和问题！</p></div><div class="ab cl ls lt hc lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hn ho hp hq hr"><p id="27d0" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><em class="lq">最初发表于</em> <a class="ae jw" href="https://www.stomt.com/blog/shared-components-across-multiple-laravel-lumen-micro-services/" rel="noopener ugc nofollow" target="_blank"> <em class="lq">斯托特博客</em> </a> <em class="lq">。</em></p><div class="lm ln lo lp fq ab cb"><figure class="lz iv ma mb mc md me paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="lz iv ma mb mc md me paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="lz iv ma mb mc md me paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mf mg mh"><p id="f922" class="iy iz lq ja b jb jc jd je jf jg jh ji mi jk jl jm mj jo jp jq mk js jt ju jv hn dt translated"><a class="ae jw" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是这个家庭的一员。我们现在<a class="ae jw" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jw" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="iy iz lq ja b jb jc jd je jf jg jh ji mi jk jl jm mj jo jp jq mk js jt ju jv hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jw" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jw" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lm ln lo lp fq iv fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff ml"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure></div></div>    
</body>
</html>