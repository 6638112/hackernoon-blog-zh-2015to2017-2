<html>
<head>
<title>How to Build SaaS Using Docker-based Tools — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用基于Docker的工具构建SaaS—第2部分</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-build-saas-using-docker-based-tools-part-2-529615ac6db0?source=collection_archive---------14-----------------------#2017-07-19">https://medium.com/hackernoon/how-to-build-saas-using-docker-based-tools-part-2-529615ac6db0?source=collection_archive---------14-----------------------#2017-07-19</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/ef2de3278bde54dca31a7da3248542c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XFdAfu8xfUd9d8aKIJylzA.jpeg"/></div></div></figure><p id="2c42" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是我的<a class="ae ka" href="https://hackernoon.com/tagged/docker" rel="noopener ugc nofollow" target="_blank"> Docker </a>编排工具回顾的第二部分。作为<a class="ae ka" rel="noopener" href="/@igor.petrov/how-to-build-saas-using-docker-based-tools-part-1-ceb1a96e0907">如何使用基于Docker的工具构建SaaS的续集——第一部分</a>。接下来让我们试试<a class="ae ka" href="http://kontena.io/" rel="noopener ugc nofollow" target="_blank"> Kontena </a>。</p><h1 id="36e4" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">Kontena CLI</h1><p id="5578" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">对<a class="ae ka" href="https://hackernoon.com/tagged/kontena" rel="noopener ugc nofollow" target="_blank"> Kontena </a>的第一印象是“真的很酷”和“非常开发者友好”。你需要做的第一件事是安装Kontena CLI。我已经按照说明文件在MacOS和Ubuntu上安装了它，没有遇到任何问题。安装后，您可以立即开始使用它，因为它使用起来非常简单，并且<a class="ae ka" href="https://kontena.io/docs/" rel="noopener ugc nofollow" target="_blank">文档</a>足够好(相对于Docker Cloud CLI)。</p><p id="2e52" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要使用Kontena，您需要有一个主节点——这是一台可以在任何云提供商上引导的机器，可以用作管理其他节点、网格和服务的中心点。</p><h1 id="d6e5" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">支持的云提供商</h1><p id="fb6b" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">目前，正如文档中提到的，Kontena支持5家云提供商:AWS、Azure、Digital Ocean、Packer和UpCloud。我试着用亚马逊网络服务来设置它。要开始在AWS上安装主节点，您需要用安全凭证设置AWS用户。只需转到AWS IAM并创建一个新用户。例如，“kontena-master”或任何其他名称。确保选中“编程访问”复选框，因为您需要访问和密钥。然后通过选择<strong class="je hv">“amazonec 2 full access”</strong>策略为刚刚创建的用户设置权限。</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff le"><img src="../Images/b3a9e3bd64f64aa97392ff18c4827dd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1m_OhqRD6TRDtpKVx431Jw.png"/></div></div></figure><p id="aae0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在最后一步，你会得到“访问密钥ID”和“秘密访问密钥”。将其保存在项目中的某个位置。</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div class="fe ff lj"><img src="../Images/515a658853d47de80dce6dd8d494078b.png" data-original-src="https://miro.medium.com/v2/resize:fit:954/format:webp/1*sF34otzKSeVV_91NiaIAKQ.png"/></div></figure><p id="115c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但这还不是全部:您需要一个AWS EC2密钥对——这些是Kontena能够登录到您的节点所需的密钥。只需将AWS控制台切换到Amazon EC2服务并创建一个密钥对。一旦完成，现在您就拥有了在AWS上设置Kontena主节点的所有信息。让我们使用文档中描述的CLI命令来实现这一点(不要忘记根据您的需要更改<code class="eh lk ll lm ln b">— storage</code>和<code class="eh lk ll lm ln b">— type</code>选项):</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="e2f5" class="ls kc hu ln b fv lt lu l lv lw">$ kontena aws master create \<br/>  --access-key &lt;aws_master_key&gt; \<br/>  --secret-key &lt;aws_secret_key&gt; \<br/>  --key-pair &lt;aws_key_pair_name&gt; \<br/>  --type m3.medium \<br/>  --storage 100 \<br/>  --region eu-west-1</span></pre><p id="f61f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在创建主节点的过程中，会询问您几个问题。一个是关于访问您的Kontena托管基础设施的身份验证，此时推荐的变体是通过Kontena云进行身份验证。这也是我选择的。但是除了Kontena Cloud之外，可以使用任何其他兼容OAuth2的身份验证提供者。</p><h1 id="da1f" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">网格、堆栈和服务</h1><p id="e066" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">让我们创建第一个网格:根据<code class="eh lk ll lm ln b">etcd</code>规则，推荐的初始节点数是3、5、7。这些节点将形成一个<code class="eh lk ll lm ln b">etcd</code>集群基础设施——负责集群稳定性和故障转移的主要节点。</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="4179" class="ls kc hu ln b fv lt lu l lv lw">$ kontena grid create --initial-size=&lt;initial_node_count&gt; aws-grid</span><span id="f640" class="ls kc hu ln b fv lx lu l lv lw"># Now let's create AWS EC2 node in the current grid</span><span id="6c4e" class="ls kc hu ln b fv lx lu l lv lw">$ kontena aws node create \<br/>  --access-key &lt;aws_master_key&gt; \<br/>  --secret-key &lt;aws_secret_key&gt; \<br/>  --key-pair &lt;aws_key_pair_name&gt; \<br/>  --type m4.medium \<br/>  --storage 100 \<br/>  --zone a \<br/>  --region eu-west-1</span></pre><p id="cdf5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在您的网格准备好运行之后，您就离准备基础设施更近了。假设您有一个web应用程序，它需要一个数据库，当然还有web服务器/负载平衡器。我开始使用微服务方法，将每个组件放在单独的容器中。有两种组织容器的方法:</p><ul class=""><li id="13d8" class="ly lz hu je b jf jg jj jk jn ma jr mb jv mc jz md me mf mg dt translated">通过单独独立的<a class="ae ka" href="https://www.kontena.io/docs/using-kontena/services.html" rel="noopener ugc nofollow" target="_blank">服务</a>(可以链接在一起)</li><li id="5818" class="ly lz hu je b jf mh jj mi jn mj jr mk jv ml jz md me mf mg dt translated">通过<a class="ae ka" href="https://www.kontena.io/docs/using-kontena/stacks.html" rel="noopener ugc nofollow" target="_blank">堆栈</a>(这是Kontena团队的首选方式和推荐方式)</li></ul><p id="7464" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">因此，Kontena Stack实际上是一组有组织的服务，而服务是一组使用相同Docker映像的容器。第二个选项是我已经选择并开始准备我的栈:一个web应用的栈，一个数据库的栈，一个负载平衡器的栈。您可以为数据库和负载平衡器使用预定义的Kontena映像，但是您也需要将您的web应用程序打包到映像中。我的网络应用已经有了一个——APIQ CMS。所以我的服务是打包成Docker image、PostgreSQL和负载平衡器(公开HTTP的web服务器)的Ruby on Rails app。下面是我的栈定义的例子(你使用YAML格式并根据<a class="ae ka" href="https://www.kontena.io/docs/references/kontena-yml.html" rel="noopener ugc nofollow" target="_blank"> Kontena.yml </a>定义它)</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="9077" class="ls kc hu ln b fv lt lu l lv lw"># lb-stack.yml<br/>stack: apiq/lb<br/>description: APIQ LB<br/>expose: internet_lb<br/>services:<br/>  internet_lb:<br/>    image: kontena/lb:latest<br/>    ports:<br/>      - 80:80<br/>      - 443:443    <br/>    deploy:<br/>      strategy: daemon</span></pre><p id="0ca3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">需要注意这里的<code class="eh lk ll lm ln b">expose:</code>选项——这允许您向其他栈公开您的服务。</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="73da" class="ls kc hu ln b fv lt lu l lv lw"># db-stack.yml<br/>stack: apiq/db<br/>description: APIQ DB<br/>expose: db<br/>services:<br/>  db:<br/>    image: postgres:latest<br/>    stateful: true</span></pre><p id="7221" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">数据库是一个有状态的服务，我猜你想把你的数据库数据存储在某个地方，数据库节点的删除不会影响你的数据。</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="dee1" class="ls kc hu ln b fv lt lu l lv lw"># kontena.yml<br/>stack: apiq/core<br/>description: APIQ Core<br/>variables:<br/>  secret_token: # variable name<br/>    type: string  # type (string, integer, boolean, uri, enum)<br/>    from: # where to obtain a value for this variable<br/>      random_string: 64 # still no value, auto generate a random<br/>    to:<br/>      env: SECRET_TOKEN # send this value to the vault on kontena master<br/>services:<br/>  app:<br/>    image: webgradus/kms<br/>    command: bundle exec rails s -p 3000 -b '0.0.0.0'<br/>    environment:<br/>      SECRET_TOKEN: ${SECRET_TOKEN}<br/>      RAILS_SERVE_STATIC_FILES: 'true'<br/>      KONTENA_LB_INTERNAL_PORT: 3000<br/>      KMS_ASSETS_STORAGE: 'fog'      <br/>    hooks:<br/>      post_start:<br/>        - name: db_create<br/>          cmd: rails db:create<br/>          instances: 1<br/>          oneshot: true<br/>        - name: db_migration<br/>          cmd: rails db:migrate<br/>          instances: 1<br/>    links:<br/>      - lb/internet_lb<br/>      - db/db<br/>    ports:<br/>      - "3000:3000"<br/>    secrets:<br/>      - secret: AWS_ACCESS_KEY_ID<br/>        name: AWS_ACCESS_KEY_ID<br/>        type: env<br/>      - secret: AWS_SECRET_ACCESS_KEY<br/>        name: AWS_SECRET_ACCESS_KEY<br/>        type: env<br/>      - secret: AWS_REGION<br/>        name: AWS_REGION<br/>        type: env</span></pre><p id="db40" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们来详细回顾一下这个。第一，<code class="eh lk ll lm ln b">variables</code>节。本节允许您定义变量以及获取它们的方式，这些变量可以在Kontena.yml中使用。在我的堆栈文件中，我正在生成一个随机字符串，并将其传递给<code class="eh lk ll lm ln b">SECRET_TOKEN</code>环境变量(这应该是为应用程序指定的)。<code class="eh lk ll lm ln b">command</code>定义应用程序应该启动的方式，<code class="eh lk ll lm ln b">environment</code> —应用程序的环境变量以及特殊的Kontena变量(例如，链接web应用程序和负载平衡器的<code class="eh lk ll lm ln b">KONTENA_LB_INTERNAL_PORT</code>)。接下来，我定义了几个钩子来执行正确的应用程序引导所必需的特定于Rails的任务——数据库创建和迁移。很明显，<code class="eh lk ll lm ln b">links</code>部分将<code class="eh lk ll lm ln b">app</code>服务与前两个堆栈中暴露的<code class="eh lk ll lm ln b">db</code>和<code class="eh lk ll lm ln b">internet_lb</code>服务链接起来。而<code class="eh lk ll lm ln b">secrets</code>部分是Kontena Vault所负责的——您在网格级别上为可访问的API或数据库密码指定密钥。在我的例子中，我在我的web应用程序中使用亚马逊S3服务，并希望任何<code class="eh lk ll lm ln b">app</code>服务节点都可以访问亚马逊凭证。通过将机密保存到保管库中来准备您的机密:</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="fe33" class="ls kc hu ln b fv lt lu l lv lw">$ kontena vault write AWS_REGION us-east-1</span></pre><p id="735d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，我们可以在节点上安装准备好的堆栈:</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="1dfb" class="ls kc hu ln b fv lt lu l lv lw">$ kontena stack install lb-stack.yml<br/>$ kontena stack install db-stack.yml<br/>$ kontena stack install --name cms-1 kontena.yml</span></pre><p id="4465" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">之后，我将APIQ CMS实例连接到数据库和负载平衡器，并在web上提供。要查找公共IP并在浏览器中查看您的应用程序:</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="d4b5" class="ls kc hu ln b fv lt lu l lv lw">$ kontena service show cms-1</span></pre><h1 id="949c" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">SaaS到底在哪里？</h1><p id="78e5" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">好的，非常好的问题:-)现在，在您使用CLI尝试了所有操作之后，是时候通过Kontena Master REST API执行相同的操作了。只需生成API令牌，并根据客户需求开始安装应用程序堆栈。遵循<a class="ae ka" href="https://kontena.io/docs/api/master/" rel="noopener ugc nofollow" target="_blank"> API文档</a>，用你最喜欢的语言编写代码。</p><pre class="lf lg lh li fq lo ln lp lq aw lr dt"><span id="4b2b" class="ls kc hu ln b fv lt lu l lv lw">$ kontena master token create --expires-in 0 --token</span></pre><h1 id="5fd6" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">Kontena云</h1><p id="ebf4" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">一旦你在Kontena Cloud上注册并使用它进行身份验证，你就可以随时登录并查看基于Kontena的基础设施的仪表板(现在完全免费)。真的很酷！在那里，您可以找到您的网格、节点、服务、资源使用和日志。</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mm"><img src="../Images/e761c17e39017c03d4b81cfba6916390.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MKJ1EjlKXWUUO87OI1u03g.jpeg"/></div></div></figure><h1 id="fee5" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">社区</h1><p id="1d8b" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">关于Kontena，接下来需要提到的是核心团队的大力支持。我在Kontena论坛上问了两个问题，总是得到回复。此外，还出现了许多新资源:YouTube上的视频指南、Kontena新闻和更新的常规电子邮件摘要以及博客帖子。</p><p id="4fb6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">总之，我建议试一试，即使你不需要建造SaaS。您可以通过轻松扩展服务、添加更多节点和网格来管理应用的基础架构。</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="mn mo l"/></div></figure></div></div>    
</body>
</html>