<html>
<head>
<title>Automate npm releases with semantic-release and human-written change logs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过语义发布和人工编写的变更日志实现npm发布的自动化</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/automate-npm-releases-with-semantic-release-and-human-written-change-logs-2adb1dce487?source=collection_archive---------1-----------------------#2016-11-10">https://medium.com/hackernoon/automate-npm-releases-with-semantic-release-and-human-written-change-logs-2adb1dce487?source=collection_archive---------1-----------------------#2016-11-10</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="5c24" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在开源软件中，发布新版本是最枯燥乏味的任务之一。</p><p id="0cd4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有很多工具尝试自动化发布，其中最有趣的是语义发布。我很长一段时间都在避免使用它，因为它使提交消息生成的变更日志的发布完全自动化，并且我相信<a class="ae jp" href="http://blog.sapegin.me/all/changelog" rel="noopener ugc nofollow" target="_blank">变更日志必须由人类</a>编写。</p><p id="ed3c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但实际上它非常灵活，我能够对它进行定制，以完全满足我的需求:</p><ul class=""><li id="a6b1" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated">一旦修复提交合并到主分支，就向npm发布新的修补程序版本，从提交消息生成changelog。</li><li id="425a" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">推迟次要版本和主要版本，直到项目维护人员编写出合适的变更日志。</li><li id="7b96" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">生成changelog草案:Markdown文件，将最新版本以来的所有重要提交分为三个部分:重大更改、新功能和错误修复。</li></ul><p id="90ba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面我将描述我自己实现这个工作流的脚本集。</p><h2 id="b592" class="ke kf hu bd kg kh ki kj kk kl km kn ko jc kp kq kr jg ks kt ku jk kv kw kx ky dt translated">它是如何工作的</h2><ol class=""><li id="e112" class="jq jr hu it b iu kz iy la jc lb jg lc jk ld jo le jw jx jy dt translated">语义发布在CI服务器上运行。</li><li id="ff8f" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo le jw jx jy dt translated">每次成功构建后，它都会分析新的提交，并查看是否有要发布的内容。</li><li id="596a" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo le jw jx jy dt translated">它通过分析提交消息来确定发布类型(补丁、小版本或大版本)(稍后将详细介绍)。</li><li id="047a" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo le jw jx jy dt translated">它生成一个changelog: <br/> a .如果发布类型是PATCH: from commit messages。<br/> b .如果发布类型是次要或主要，并且最新提交是一个变更日志:使用该提交的主体作为一个变更日志。</li><li id="1fc2" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo le jw jx jy dt translated">向npm发布新版本。</li><li id="b330" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo le jw jx jy dt translated">将changelog发布到GitHub发布页面。</li></ol><h2 id="4bfa" class="ke kf hu bd kg kh ki kj kk kl km kn ko jc kp kq kr jg ks kt ku jk kv kw kx ky dt translated">安装语义发布</h2><p id="539e" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">首先安装语义发布命令行工具:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="f88c" class="ke kf hu ln b fv lr ls l lt lu">npm install -g semantic-release-cli</span></pre><p id="c4b4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后在您的项目文件夹中运行它:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="3d45" class="ke kf hu ln b fv lr ls l lt lu">semantic-release-cli setup</span></pre><p id="4046" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">输入您的npm和GitHub凭据。如果你已经有一个，选择“创建no .travis.yml ”,否则它将被覆盖。</p><figure class="li lj lk ll fq lw fe ff paragraph-image"><div class="fe ff lv"><img src="../Images/9c3169ae1c4896257eeba13667788b2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*b8hFWqxIDWfvPDpLZa033A.png"/></div></figure><p id="e58a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将这几行添加到您的travis.yml中:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="6968" class="ke kf hu ln b fv lr ls l lt lu">after_success:<br/>  - npm run semantic-release<br/>branches:<br/>  except:<br/>    - /^v\d+\.\d+\.\d+$/</span></pre><h2 id="7c4c" class="ke kf hu bd kg kh ki kj kk kl km kn ko jc kp kq kr jg ks kt ku jk kv kw kx ky dt translated">定制语义发布</h2><p id="e5c5" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">你可以用插件改变语义发布行为:检测发布类型，检查发布需求(像一个变更日志)，生成变更日志，等等。我做了一个<a class="ae jp" href="https://github.com/tamiadev/semantic-release-tamia" rel="noopener ugc nofollow" target="_blank">包，里面有我需要的所有插件</a>来支持我的工作流程。</p><p id="2e3c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先安装插件:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="e4b8" class="ke kf hu ln b fv lr ls l lt lu">npm install --save-dev semantic-release-tamia</span></pre><p id="dda6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后添加到您的package.json:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="c8c2" class="ke kf hu ln b fv lr ls l lt lu">"release": {<br/>  "analyzeCommits": "semantic-release-tamia/analyzeCommits",<br/>  "generateNotes": "semantic-release-tamia/generateNotes",<br/>  "verifyRelease": "semantic-release-tamia/verifyRelease"<br/>}</span></pre><p id="b1cb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">运行<em class="lz"> npm安装</em>和<em class="lz"> npm运行语义发布</em>来测试是否一切正常。你会看到这样的东西:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="937b" class="ke kf hu ln b fv lr ls l lt lu">semantic-release WARN pre semantic-release didn’t run on Travis CI and therefore a new version won’t be published.<br/>semantic-release WARN pre You can customize this behavior using "verifyConditions" plugins: git.io/sr-plugins<br/>semantic-release ERR! pre Failed to determine new version.<br/>semantic-release ERR! pre ENOCHANGE There are no relevant changes, so no new version is released.</span></pre><p id="9c82" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这很好，意味着两件事:语义发布不会发布，直到它在CI环境中运行，并且您没有可以发布的更改。</p><h2 id="c32f" class="ke kf hu bd kg kh ki kj kk kl km kn ko jc kp kq kr jg ks kt ku jk kv kw kx ky dt translated">使用Git提交消息约定</h2><p id="c20b" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">默认情况下，semantic-release使用了<a class="ae jp" href="https://docs.google.com/document/d/1QrDFcIiPjSLDn3EL15IJygNPiHORgU1_OOAqWjiDU5Y/edit#" rel="noopener ugc nofollow" target="_blank"> AngularJS约定</a>，我不喜欢这种美学上的约定。所以我用<a class="ae jp" href="https://github.com/tamiadev/semantic-release-tamia/blob/master/Convention.md" rel="noopener ugc nofollow" target="_blank">稍微修改了一下约定</a>:</p><figure class="li lj lk ll fq lw fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff ma"><img src="../Images/cd7fb26d0e20979f0ce1125d70683ea1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BBVYrZYgDs-KQgaTgNrgoQ.png"/></div></div></figure><p id="4332" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每个提交消息包括:</p><ol class=""><li id="fc7c" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo le jw jx jy dt translated">类型:新特性专长，错误修正等等。</li><li id="055d" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo le jw jx jy dt translated">主题:简短的更改描述。</li><li id="2140" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo le jw jx jy dt translated">Body(可选):长变更描述。</li><li id="76f2" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo le jw jx jy dt translated">页脚(可选):重大变更、GitHub发布引用等。</li></ol><p id="2a48" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Semantic-release使用这个标签来查找发布的所有重要提交(修复很重要，文档不重要)，并确定应该发布哪个版本(主要版本、次要版本或补丁)。</p><h2 id="3cd2" class="ke kf hu bd kg kh ki kj kk kl km kn ko jc kp kq kr jg ks kt ku jk kv kw kx ky dt translated">为次要或主要版本编写变更日志</h2><p id="9437" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">我给<a class="ae jp" href="https://github.com/tamiadev/semantic-release-tamia#release-process" rel="noopener ugc nofollow" target="_blank">写了一个脚本</a>来帮助我修改日志。</p><p id="c20e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首次运行<em class="lz"> sr-changelog </em>。它将创建一个文件，其中包含该版本所有重要的提交，按类型分组(重大更改、新特性和错误修复)，并在您的默认编辑器中打开它。</p><p id="3085" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，您可以重写您的变更日志，使其对您的用户有用且易于阅读。</p><p id="4bf2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后运行<em class="lz"> sr-changelog提交</em>。它将在提交消息正文中不更改类型changelog和Changelog的情况下进行提交(git commit — allow-empty)。</p><h2 id="f203" class="ke kf hu bd kg kh ki kj kk kl km kn ko jc kp kq kr jg ks kt ku jk kv kw kx ky dt translated">发布新版本</h2><p id="46b3" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">现在你需要<em class="lz"> git推送</em>你的改变，煮点咖啡。</p><figure class="li lj lk ll fq lw fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff mf"><img src="../Images/07c648face5cace1d331e5474ca9e86c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NeUDBskPnU6KtTwv1ReblQ.png"/></div></div></figure><h2 id="ff46" class="ke kf hu bd kg kh ki kj kk kl km kn ko jc kp kq kr jg ks kt ku jk kv kw kx ky dt translated">链接</h2><ul class=""><li id="f5e5" class="jq jr hu it b iu kz iy la jc lb jg lc jk ld jo jv jw jx jy dt translated"><a class="ae jp" href="https://github.com/semantic-release/semantic-release" rel="noopener ugc nofollow" target="_blank">语义发布</a></li><li id="edbb" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated"><a class="ae jp" href="https://github.com/tamiadev/semantic-release-tamia" rel="noopener ugc nofollow" target="_blank">我的语义发布插件和脚本</a></li><li id="8b32" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated"><a class="ae jp" href="https://github.com/tamiadev/semantic-release-tamia/blob/master/Convention.md" rel="noopener ugc nofollow" target="_blank">我的提交消息约定</a></li><li id="654a" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated"><a class="ae jp" href="https://docs.google.com/document/d/1QrDFcIiPjSLDn3EL15IJygNPiHORgU1_OOAqWjiDU5Y/edit#" rel="noopener ugc nofollow" target="_blank"> AngularJS提交消息约定</a></li><li id="f87d" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated"><a class="ae jp" href="https://egghead.io/lessons/javascript-how-to-write-a-javascript-library-automating-releases-with-semantic-release" rel="noopener ugc nofollow" target="_blank">如何写一个开源JavaScript库Egghead教程</a></li><li id="7813" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated"><a class="ae jp" href="http://blog.sapegin.me/all/changelog" rel="noopener ugc nofollow" target="_blank">为什么你需要自己写变更日志</a></li><li id="3b21" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">保持一个变更日志:不要让你的朋友将git日志转储到变更日志中</li><li id="eeae" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated"><a class="ae jp" href="http://semver.org/" rel="noopener ugc nofollow" target="_blank">语义版本化</a></li></ul><div class="li lj lk ll fq ab cb"><figure class="mg lw mh mi mj mk ml paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mg lw mh mi mj mk ml paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mg lw mh mi mj mk ml paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mm mn mo"><p id="f922" class="ir is lz it b iu iv iw ix iy iz ja jb mp jd je jf mq jh ji jj mr jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is lz it b iu iv iw ix iy iz ja jb mp jd je jf mq jh ji jj mr jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="li lj lk ll fq lw fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff ms"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure></div></div>    
</body>
</html>