<html>
<head>
<title>Moving our Flask backend from Heroku to AWS — The Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将我们的Flask后端从Heroku迁移到AWS——指南</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/moving-our-flask-backend-from-heroku-to-aws-the-guide-31b2b372291c?source=collection_archive---------0-----------------------#2016-04-05">https://medium.com/hackernoon/moving-our-flask-backend-from-heroku-to-aws-the-guide-31b2b372291c?source=collection_archive---------0-----------------------#2016-04-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="6f92" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最初的理由是纯粹的成本相关，但是性能的提高是巨大的。我们公司决定正式进入“蟑螂时代”，很遗憾，这意味着我们要将大量的服务器端实现移出Heroku。Heroku让事情变得简单，这是肯定的，但我们有大量的亚马逊信用，并感觉有点被利用了，因为纯粹的懒惰而付出更多，得到更少。</p><p id="bfd6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我不能说这很容易。我随便看了几十篇，都是提供部分信息或者过时/错误的信息。我在想“这太奇怪了，为什么没有简单明了的指南来告诉我们这些小而穷的初创公司如何远离Heroku”。因此，经过大量的指导，堆栈溢出错误解决，AWS architect 1对1，以及一些处于放弃边缘的纯粹挫折，我在这里为您提供如何进行这一可怕举动的完整指导。</p><h2 id="4a70" class="jp jq hu bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj dt translated">1.弹性豆茎</h2><p id="6614" class="pw-post-body-paragraph ir is hu it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hn dt translated">我们大多数人都已经使用过或者知道EC2实例，但是当对整个后端使用一个专用的EC2实例时，当工作负载发生变化时，它将变得更加难以扩展。因此我选择了使用Elastic Beanstalk，这是一个易于使用的部署和扩展web应用程序的服务，而且是免费的。下面是如何为Flask设置的(<em class="kp">我用的是EB CLI界面，所以你需要事先下载:</em><a class="ae kq" href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb-cli3-install.html" rel="noopener ugc nofollow" target="_blank"><em class="kp">http://docs . AWS . Amazon . com/elastic beanstalk/latest/DG/e b-CLI 3-install . html</em></a><em class="kp">)</em>:</p><ul class=""><li id="ce4c" class="kr ks hu it b iu iv iy iz jc kt jg ku jk kv jo kw kx ky kz dt translated">转到项目所在的文件夹</li><li id="dc7e" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo kw kx ky kz dt translated">在命令行中键入:<strong class="it hv"> <em class="kp"> eb init </em> </strong></li><li id="2504" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo kw kx ky kz dt translated">选择您所在的地区，创建一个新的应用程序，输入它的名称，然后选择它的平台(在我们的例子中是Python)。选择版本(最有可能是2.7)，同意设置SSH，选择已经在AWS中设置的现有密钥对，或者创建一个新的密钥对。</li></ul><p id="ca86" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们已经完成了EB的目录设置，我们可以创建我们的运行环境了。</p><ul class=""><li id="83a2" class="kr ks hu it b iu iv iy iz jc kt jg ku jk kv jo kw kx ky kz dt translated">在命令行中键入:<strong class="it hv"> <em class="kp"> eb create </em> </strong></li></ul><p id="65f4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">恭喜你。您刚刚创建了您的第一个电子商务环境。EB现在已经创建了一个EC2实例，并为其附加了一个存储卷。现在，您可以进入AWS EB仪表板，查看新创建的环境。EB非常智能，正如您所看到的，它的设置非常简单。它将您的文件夹压缩并上传到AWS，并基于它对Python环境的了解构建服务器。它将查看您的requirements.txt文件以了解要下载什么库，并尝试找到您的WSGI配置以启动服务器。您可以进入“配置”选项卡，更改其扩展和网络。您还可以在仪表板中查看环境的健康状况，或者获取日志，如果您需要更多关于正在发生的事情的信息。</p><p id="c382" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当然，我的执行带来了一些错误，重点是一种他们称之为“的生物”。ebextensions”。这是一个需要添加到项目中的文件夹，它由。配置文件。这些文件基本上允许您在设置环境时对其进行配置。</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="c9e4" class="jp jq hu lk b fv lo lp l lq lr">#my example.config<br/>packages:<br/>  yum:<br/>    git: []<br/>    libffi-devel: []<br/>    libjpeg-turbo-devel: []<br/><br/>container_commands:<br/>  01_wsgipass:<br/>    command: 'echo "WSGIPassAuthorization On" &gt;&gt; ../wsgi.conf'<br/>  AddGlobalWSGIGroupAccess:<br/>    command: "if ! grep -q 'WSGIApplicationGroup %{GLOBAL}' ../wsgi.conf ; then echo 'WSGIApplicationGroup %{GLOBAL}' &gt;&gt; ../wsgi.conf; fi;"<br/><br/>option_settings:<br/>  "aws:elasticbeanstalk:container:python":<br/>    WSGIPath: application.py<br/>    NumProcesses: 3<br/>    NumThreads: 20<br/>  "aws:elasticbeanstalk:application:environment":<br/>    EXAMPLE_ENV_VAR: env_var_value</span></pre><p id="486c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我的例子中，我使用<strong class="it hv"> <em class="kp"> yum </em> </strong>命令在机器上安装一些加密库和git。我使用了<strong class="it hv"><em class="kp">AWS:elastic beanstalk:application:environment</em></strong>来添加我所有的环境变量。最重要的是，我有几个WSGI问题需要解决。告诉EB从哪个文件启动我的应用程序。<strong class="it hv"> <em class="kp"> 01_wsgipass </em> </strong>允许基本的HTTP认证头在传递给服务器时不被截断，以及<strong class="it hv"><em class="kp">AddGlobalWSGIGroupAccess</em></strong>由于我曾与本文相关的问题:<a class="ae kq" href="http://djm.io/deploying-scipy-into-aws-elastic-beanstalk/" rel="noopener ugc nofollow" target="_blank">http://djm.io/deploying-scipy-into-aws-elastic-beanstalk/</a></p><p id="12c9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好吧！现在，在您添加了您的。ebextensions文件夹，只需返回到CLI并发出命令<strong class="it hv"> <em class="kp"> eb deploy </em> </strong>，这基本上就是用新的更改重新部署您的服务器。</p><h2 id="5166" class="jp jq hu bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj dt translated">2.工人</h2><p id="7dc4" class="pw-post-body-paragraph ir is hu it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hn dt translated">我们还有一些事情要解决，因为我们还有一个工作进程在运行我们较长的任务，或者我们不希望阻塞服务器的任务。我们在Heroku上使用一个Redis队列和一个单独的dyno来生成我们当前的worker配置。幸运的是，Elastic Beanstalk还附带了一个工作环境，设置起来非常简单。您需要做的是遵循与设置web环境相同的步骤，只是这一次选择您已经创建的现有应用程序，并在提示时选择创建一个工作环境。工人环境会提示你一个SQS的创作，我们现在就来谈谈。</p><p id="365d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">EB中工作环境的工作方式是通过使用SQS与web env通信。SQS基本上是一个简单的队列服务，你可以发送信息。在这种情况下，我们的web env可以向SQS队列发送一条消息，工作线程安装了一个守护进程来监听该队列，并在消息到达时获取消息，执行所需的操作，然后返回200 (ok)状态。如果它没有返回200，消息将被发送到一个死队列，如果这些失败的请求需要重新发出，就可以使用这个死队列。</p><p id="61f4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要实现这一点，需要设置什么:</p><ul class=""><li id="43d8" class="kr ks hu it b iu iv iy iz jc kt jg ku jk kv jo kw kx ky kz dt translated">在flask后端安装<a class="ae kq" href="https://aws.amazon.com/sdk-for-python/" rel="noopener ugc nofollow" target="_blank"> boto </a>(用于Python的AWS SDK)并创建一个方法，将SQS消息发送到为worker env <em class="kp">设置的所需队列(您可能需要为您的服务器设置适当的AWS权限，以允许您发送SQS消息)</em>。在我的例子中，我发送了一个由两个参数组成的SQS消息，一个函数名和一个参数列表。</li></ul><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="edcf" class="jp jq hu lk b fv lo lp l lq lr">def send_message_to_sqs(<em class="kp">data</em>):<br/>    # Put the message in the queue<br/>    m = boto.sqs.message.RawMessage()<br/>    m.set_body(json.dumps(<em class="kp">data</em>))<br/>    status = q.write(m)<br/>    print status</span><span id="46a2" class="jp jq hu lk b fv ls lp l lq lr">send_message_to_sqs({'func':'save_to_s3_and_update_user', 'args':{'user_id':str(usr.id)}})</span></pre><p id="2df5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">b.在worker env中有一个端点，以便将SQS消息发送到该端点。您可以在Worker env配置中配置端点名称。</p><p id="a01f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">c.我的worker env中的那个端点的方法基本上是根据函数名查看传入的消息，理解要调用什么函数，并给它一个参数列表。最后，如果一切顺利，它就返回200 (ok)状态。</p><p id="3886" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是亚马逊提供的一个例子<a class="ae kq" href="https://github.com/awslabs/eb-py-flask-signup" rel="noopener ugc nofollow" target="_blank"> web环境</a>和<a class="ae kq" href="https://github.com/awslabs/eb-py-flask-signup-worker" rel="noopener ugc nofollow" target="_blank"> worker环境</a>作为例子。</p><p id="69d3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您能够达到这一点，那么您现在很可能已经配置了一个基本的弹性Beanstalk web应用程序，它带有一个与之交互的工作线程。万岁！</p><h2 id="0fff" class="jp jq hu bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj dt translated">3.MongoDB</h2><p id="954d" class="pw-post-body-paragraph ir is hu it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hn dt translated">我们为MongoDB数据库使用了一个Heroku插件(mLab)。它使事情变得超级简单，他们为你提供全面的支持，为你设置和维护数据库。然而，我们决定给AWS一个公平的机会。这是一个相当长且详细的指南，所以我将把你链接到我在这上面找到的最好的指南:</p><div class="lt lu fm fo lv lw"><a href="https://docs.mongodb.org/ecosystem/platforms/amazon-ec2/" rel="noopener  ugc nofollow" target="_blank"><div class="lx ab ej"><div class="ly ab lz cl cj ma"><h2 class="bd hv fv z el mb eo ep mc er et ht dt translated">亚马逊EC2</h2><div class="md l"><h3 class="bd b fv z el mb eo ep mc er et ek translated">EC2实例可以使用弹性块存储(EBS…)配置临时存储或永久存储</h3></div><div class="me l"><p class="bd b gc z el mb eo ep mc er et ek translated">docs.mongodb.org</p></div></div><div class="mf l"><div class="mg l mh mi mj mf mk ml lw"/></div></div></a></div><p id="1ce4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您遇到问题或收到错误(如我们所做的)，只需提供一些提示:</p><ol class=""><li id="1926" class="kr ks hu it b iu iv iy iz jc kt jg ku jk kv jo mm kx ky kz dt translated">确保您有一个打开端口22和27017的安全组。您需要SSH到您的机器，因此您需要端口22，27017用于您的MongoDB连接。</li><li id="5227" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo mm kx ky kz dt translated">编辑/etc/mongod.conf，寻找<strong class="it hv"> <em class="kp"> bind_ip </em> </strong>。如果它指向本地主机，您将无法从外部ip访问它。要么给它需要访问它的机器的ip，要么完全注释掉这个命令。</li><li id="6cc8" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo mm kx ky kz dt translated">确保您为正在交互的数据库的MongoDB用户添加了一个<strong class="it hv"> <em class="kp"> dbOwner </em> </strong>用户(或者符合您需求的合适角色)。通过连接到您的mongo shell (SSHing然后键入<strong class="it hv"> <em class="kp"> mongo </em> </strong>或者从您的本地机器执行一个远程<strong class="it hv"> <em class="kp"> mongo </em> </strong>命令<strong class="it hv"> <em class="kp"> </em> </strong>)，然后发出一个<strong class="it hv"><em class="kp">db . create user()</em></strong>命令。我给新用户的角色是:</li></ol><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="08f7" class="jp jq hu lk b fv lo lp l lq lr">“roles” : [ {“role” : “dbOwner”, “db” : “my_database_name”} ]</span></pre><p id="a331" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果在没有任何用户的情况下连接到数据库，您可能处于只读模式。确保您在flask后端使用正确的用户名和密码连接到数据库。</p><h2 id="ccf6" class="jp jq hu bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj dt translated">4.附加组件</h2><p id="3331" class="pw-post-body-paragraph ir is hu it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hn dt translated">Heroku有许多简洁的插件，特别是在我的例子中，我发现它对UI日志和定期数据库备份有很大用处。没有人说你不能在EB上也这么做！</p><p id="5753" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">伐木的书面记录</strong></p><div class="lt lu fm fo lv lw"><a href="http://help.papertrailapp.com/kb/hosting-services/aws-elastic-beanstalk/" rel="noopener  ugc nofollow" target="_blank"><div class="lx ab ej"><div class="ly ab lz cl cj ma"><h2 class="bd hv fv z el mb eo ep mc er et ht dt translated">AWS弹性豆茎</h2><div class="md l"><h3 class="bd b fv z el mb eo ep mc er et ek translated">AWS Elastic Beanstalk是一种在Amazon Web Services cloud中快速部署和管理应用程序的简单方法…</h3></div><div class="me l"><p class="bd b gc z el mb eo ep mc er et ek translated">help.papertrailapp.com</p></div></div></div></a></div><p id="c07b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">基本上就像将另一个配置文件添加到。ebextensions并正确配置它:)</p><p id="295a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">定期备份您的MongoDB </strong></p><div class="lt lu fm fo lv lw"><a href="https://github.com/theycallmeswift/node-mongodb-s3-backup" rel="noopener  ugc nofollow" target="_blank"><div class="lx ab ej"><div class="ly ab lz cl cj ma"><h2 class="bd hv fv z el mb eo ep mc er et ht dt translated">他们称之为meswift/node-mongodb-s3-backup</h2><div class="md l"><h3 class="bd b fv z el mb eo ep mc er et ek translated">node-mongodb-s3-backup——一个node.js包，使MongoDB数据库与S3同步变得简单。</h3></div><div class="me l"><p class="bd b gc z el mb eo ep mc er et ek translated">github.com</p></div></div><div class="mf l"><div class="mn l mh mi mj mf mk ml lw"/></div></div></a></div><p id="d287" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">简单易用的节点包，每天将数据库备份到S3。</p><h2 id="96bc" class="jp jq hu bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj dt translated">最后的话</h2><p id="821d" class="pw-post-body-paragraph ir is hu it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hn dt translated">我希望这篇指南能够帮助你完成从Heroku到AWS的<strong class="it hv"><em class="kp"/></strong>旅程，或者至少向你展示了我个人对它的处理。自从我们搬迁后，我们肯定更具成本效益，我们的应用程序有更好的响应时间，并且非常满意:)</p><blockquote class="mo mp mq"><p id="55a4" class="ir is kp it b iu iv iw ix iy iz ja jb mr jd je jf ms jh ji jj mt jl jm jn jo hn dt translated"><a class="ae kq" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae kq" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae kq" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae kq" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="dca4" class="ir is kp it b iu iv iw ix iy iz ja jb mr jd je jf ms jh ji jj mt jl jm jn jo hn dt translated">要了解更多信息，<a class="ae kq" href="https://goo.gl/4ofytp" rel="noopener ugc nofollow" target="_blank">请阅读我们的“关于”页面</a>、<a class="ae kq" href="http://bit.ly/HackernoonFB" rel="noopener ugc nofollow" target="_blank">在脸书上给我们点赞/发消息</a>，或者简单地说，<a class="ae kq" href="https://goo.gl/k7XYbx" rel="noopener ugc nofollow" target="_blank"> tweet/DM @HackerNoon。</a></p><p id="708a" class="ir is kp it b iu iv iw ix iy iz ja jb mr jd je jf ms jh ji jj mt jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kq" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kq" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote></div></div>    
</body>
</html>