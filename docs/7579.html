<html>
<head>
<title>Architecting a Highly Scalable Golang API with Docker Swarm &amp; Traefik</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Docker Swarm &amp; Traefik构建高度可扩展的Golang API</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/architecting-a-highly-scalable-golang-api-with-docker-swarm-traefik-875d1871cc1f?source=collection_archive---------4-----------------------#2017-11-01">https://medium.com/hackernoon/architecting-a-highly-scalable-golang-api-with-docker-swarm-traefik-875d1871cc1f?source=collection_archive---------4-----------------------#2017-11-01</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/300e3e60395e1c61bf3e3ce28969172d.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*h9iJ9whjCQ-ovuSGOCOVcA.png"/></div></figure><p id="a941" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">这篇文章将向你展示如何设置一个<strong class="ja hv">群集群</strong>，部署几个微服务，并创建一个反向代理服务(用<a class="ae jw" href="https://traefik.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ja hv"> Traefik </strong> </a>)负责在它们的基本URL上路由请求。</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff jx"><img src="../Images/177159ecc3b8847f1733d346774cccba.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/0*4bVQigaoHVORG5jK."/></div></figure><p id="e2fd" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如果您还没有创建一个Swarm集群，您可以使用下面的shell脚本来设置一个包含3个节点(1个管理器和2个工作器)的集群</p><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="df19" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">发出以下命令来执行脚本:</p><blockquote class="ke kf kg"><p id="6043" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">chmod +x setup.sh</p><p id="fde0" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">。/setup.sh</p></blockquote><p id="03b4" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">上述命令的输出如下:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff kl"><img src="../Images/9f5dc45dee6928b9727356b7b1ae675a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*JGIZdKmzUqatk94i."/></div></figure><p id="beb6" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">此时，我们有3个节点:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff km"><img src="../Images/65e4d961d6336c334455fa376ae3f142.png" data-original-src="https://miro.medium.com/v2/resize:fit:1106/0*m089OwIWHjyY3z68."/></div></figure><p id="8d4d" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们的示例微服务应用程序由两部分组成。<strong class="ja hv">书籍API </strong>和<strong class="ja hv">电影API </strong>。对于这两个部分，我已经为您准备了可以从<a class="ae jw" href="https://hub.docker.com/u/mlabouardy/" rel="noopener ugc nofollow" target="_blank"> DockerHub </a>中提取的图像。</p><p id="a128" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">两张图片的<strong class="ja hv"> Dockerfiles </strong>可以在我的<a class="ae jw" href="https://github.com/mlabouardy/alb-go" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到。</p><p id="316e" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">用以下内容创建<em class="kh"> docker-compose.yml </em>文件:</p><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="kc kd l"/></div></figure><ul class=""><li id="5902" class="kn ko hu ja b jb jc jf jg jj kp jn kq jr kr jv ks kt ku kv dt translated">我们使用一个名为<em class="kh"> traefik-net </em>的<strong class="ja hv">覆盖网络</strong>，在其上我们添加我们想要向<strong class="ja hv"> Traefik </strong>公开的服务。</li><li id="73af" class="kn ko hu ja b jb kw jf kx jj ky jn kz jr la jv ks kt ku kv dt translated">我们使用<em class="kh">约束</em>在Swarm manager上的workers &amp; Traefik上部署API。</li><li id="1c03" class="kn ko hu ja b jb kw jf kx jj ky jn kz jr la jv ks kt ku kv dt translated">Traefik容器被配置为在端口<strong class="ja hv"> 80 </strong>上侦听标准HTTP流量，但也为web仪表板公开端口<strong class="ja hv"> 8080 </strong>。</li><li id="ae53" class="kn ko hu ja b jb kw jf kx jj ky jn kz jr la jv ks kt ku kv dt translated">docker套接字(<strong class="ja hv"> /var/run/docker.sock </strong>)的使用允许Traefik监听<strong class="ja hv"> Docker守护进程</strong>事件，并在容器启动/停止时重新配置自身。</li><li id="d76b" class="kn ko hu ja b jb kw jf kx jj ky jn kz jr la jv ks kt ku kv dt translated">trfik使用标签<em class="kh"> traefik.frontend.rule </em>来确定哪个容器用于哪个请求路径。</li><li id="c16e" class="kn ko hu ja b jb kw jf kx jj ky jn kz jr la jv ks kt ku kv dt translated"><em class="kh">配置</em>部分从<em class="kh"> config.toml </em>中为Traefik创建一个配置文件(它启用<strong class="ja hv"> Docker </strong>后端)</li></ul><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="3411" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">为了部署我们的堆栈，我们应该执行以下命令:</p><blockquote class="ke kf kg"><p id="41bf" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">docker stack deploy-compose-file docker-compose . yml API</p></blockquote><p id="c0af" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">让我们检查一下覆盖网络:</p><blockquote class="ke kf kg"><p id="ce5d" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">码头网络</p></blockquote><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff lb"><img src="../Images/28a81941dc4d66da45f84ad3a9f0493e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/0*G2jzOPQS6OLBPzD9."/></div></figure><p id="3b9a" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">Traefik配置:</p><blockquote class="ke kf kg"><p id="2375" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">docker配置ls</p></blockquote><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff kl"><img src="../Images/948a3160cc7e6afa03e1f63b4591f0d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*_jmU6aURCZCyT3e2."/></div></figure><p id="a5f9" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">要显示配置内容:</p><blockquote class="ke kf kg"><p id="d0c2" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">docker配置检查API _ traefik-config-pretty</p></blockquote><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff lc"><img src="../Images/899f46a93510ad5815fd5ea63f88f51e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/0*Zn0bdMLZ8kaBD98I."/></div></figure><p id="2bf4" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">最后，列出所有服务:</p><blockquote class="ke kf kg"><p id="301a" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">docker堆栈ps api</p></blockquote><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff kl"><img src="../Images/a5d733bd9862594537e7e408a9acaf9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*CfIqyG6UMKnnD460."/></div></figure><p id="bc90" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在上面的列表中，你可以看到3个容器正在<strong class="ja hv">节点-1 </strong>、<strong class="ja hv">节点-2 </strong> &amp; <strong class="ja hv">节点-3 </strong>上运行:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff ld"><img src="../Images/1ad11e6e0c25205a5e1db0240dea53a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/0*byQWqrM8ZBrtRw_H."/></div></figure><p id="2a3c" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如果你把你最喜欢的浏览器(不是你的IE)指向<strong class="ja hv">Traefik Dashboard URL</strong>(<strong class="ja hv">http://MANAGER _ NODE _ IP:8080</strong>)你应该会看到前端和后端都定义得很好:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff kl"><img src="../Images/5705f66d55e080194515499a89be890b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*9hNDn71R43GvrU7r."/></div></figure><p id="fd91" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如果你查看<a class="ae jw" href="http://MANAGER_NODE_IP/books," rel="noopener ugc nofollow" target="_blank"><strong class="ja hv">http://MANAGER _ NODE _ IP/books</strong>，</a>你会得到一个图书列表:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff le"><img src="../Images/e0ad8c38d5d46e9586ceecac14bffffe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/0*qzj1AO4PTRRkPVhf."/></div></div></figure><p id="9d5a" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如果用<strong class="ja hv"> /movies </strong>替换基本URL:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff kl"><img src="../Images/85996114ccd93f22d7dabe1d3ff26aa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*uIAArV6zv5EKN_-L."/></div></figure><p id="986d" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如果我们想要扩展书籍和电影API，会发生什么？用<strong class="ja hv"> docker服务秤</strong>命令:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff lj"><img src="../Images/3af84f469d9aa58b3db296d5c0038a36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/0*_M6lvw_QDZho4Gk1."/></div></figure><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff kl"><img src="../Images/b2d5750e8d3baf19cf158dd13c23bab1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*Q2xrhc_nlpZAZUH1."/></div></figure><p id="7f04" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们可以确认:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff kl"><img src="../Images/34213c8cc28b32d53fb3d54ef08d1f85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*W3R6UKxouLVbfQd1."/></div></figure><p id="e5c8" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">显然<strong class="ja hv"> Traefik </strong>确实意识到我们启动了更多的容器，并使它们自动对右侧前端可用:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff kl"><img src="../Images/d44533a3d7a59bf3ba5a9500a1d1af86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*OIE0IZQvexcx_ph-."/></div></figure><p id="e334" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在下图中，您会发现经理已经决定使用<a class="ae jw" href="https://en.wikipedia.org/wiki/Round-robin_scheduling" rel="noopener ugc nofollow" target="_blank">循环调度</a>策略在<strong class="ja hv">节点-2 </strong>(其中3个)和<strong class="ja hv">节点-3 </strong>(其中4个)上调度新容器:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff lk"><img src="../Images/450a8527786eee1783ac7d489cd3f684.png" data-original-src="https://miro.medium.com/v2/resize:fit:894/0*n_B3wVNIdtnr_kNC."/></div></figure></div></div>    
</body>
</html>