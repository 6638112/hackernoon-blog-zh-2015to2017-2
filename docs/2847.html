<html>
<head>
<title>Make development great again!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让发展再伟大！</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/make-development-great-again-faab769d264e?source=collection_archive---------14-----------------------#2017-02-22">https://medium.com/hackernoon/make-development-great-again-faab769d264e?source=collection_archive---------14-----------------------#2017-02-22</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="bb95" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">这是一个Python故事，有一些RESTful和一堆Redis</h2></div><p id="1e4d" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">今天我想通过一个简单的，希望不会太无聊的例子来展示最新版本的<a class="ae kf" href="https://github.com/mindflayer/python-mocket" rel="noopener ugc nofollow" target="_blank"> <em class="kg"> Mocket </em> </a>。</p><figure class="ki kj kk kl fq km fe ff paragraph-image"><div class="fe ff kh"><img src="../Images/491070ce932b1e4043d0bf3459a018ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*8cJqTMzQ5N8AO5afgVLeNg.jpeg"/></div><figcaption class="kp kq fg fe ff kr ks bd b be z ek">Source: <a class="ae kf" href="http://www.dhgate.com/product/home-office-wall-socket-hidden-covert-camera/233012186.html" rel="noopener ugc nofollow" target="_blank">http://www.dhgate.com/product/home-office-wall-socket-hidden-covert-camera/233012186.html</a></figcaption></figure><blockquote class="kt ku kv"><p id="304c" class="jj jk kg jl b jm jn iv jo jp jq iy jr kw jt ju jv kx jx jy jz ky kb kc kd ke hn dt translated">关于<em class="hu"> Mocket </em>的简要介绍，请阅读<a class="ae kf" rel="noopener" href="/@mindflayer/mocket-is-alive-and-is-fighting-with-us-b2810d52597a">我之前的博文</a>。</p></blockquote></div><div class="ab cl kz la hc lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hn ho hp hq hr"><p id="b1ce" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">首先，我们需要一个新的<code class="eh lg lh li lj b">virtualenv</code>。</p><pre class="ki kj kk kl fq lk lj ll lm aw ln dt"><span id="2108" class="lo lp hu lj b fv lq lr l ls lt">virtualenv -p python3 todos<br/>source todos/bin/activate<br/>cd todos</span></pre><p id="e57e" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们还需要一些包装。</p><pre class="ki kj kk kl fq lk lj ll lm aw ln dt"><span id="33a9" class="lo lp hu lj b fv lq lr l ls lt">pip install requests redis mocket ipython</span></pre><p id="98f7" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">额外要求:一个本地运行的<a class="ae kf" href="http://redis.io/" rel="noopener ugc nofollow" target="_blank"> <em class="kg"> Redis </em> </a>数据库。在一个现代的<a class="ae kf" href="https://hackernoon.com/tagged/ubuntu" rel="noopener ugc nofollow" target="_blank"> <em class="kg"> Ubuntu </em> </a>盒子上，安装它就像启动一个</p><pre class="ki kj kk kl fq lk lj ll lm aw ln dt"><span id="6890" class="lo lp hu lj b fv lq lr l ls lt">sudo apt install redis-server redis-tools</span></pre><p id="7dde" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您可以使用<code class="eh lg lh li lj b">redis-cli</code>来监控<em class="kg"> Redis </em>，在CLI中键入<code class="eh lg lh li lj b">MONITOR</code>作为第一个命令。</p><p id="9d02" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在是时候看看Pythonic的东西了。这是一个简单的故事，通过JSON API可以获得一些用户和他们发布的帖子。有了这些数据，我们想使用IPython和一堆Redis命令做一些统计，看看用户作为作者的表现如何。</p><p id="da35" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这些是我们启动项目所需的代码行。</p><pre class="ki kj kk kl fq lk lj ll lm aw ln dt"><span id="877a" class="lo lp hu lj b fv lq lr l ls lt">from collections import Counter<br/>import requests<br/>import redis</span><span id="1b1a" class="lo lp hu lj b fv lu lr l ls lt"># get all users<br/>users = requests.get(<br/>    '<a class="ae kf" href="http://jsonplaceholder.typicode.com/users'" rel="noopener ugc nofollow" target="_blank">http://jsonplaceholder.typicode.com/users'</a><br/>).json()</span><span id="3271" class="lo lp hu lj b fv lu lr l ls lt"># users will be retrieved by userId<br/>users_by_id = {u['id']: u for u in users}</span><span id="993a" class="lo lp hu lj b fv lu lr l ls lt">todos = requests.get(<br/>    '<a class="ae kf" href="http://jsonplaceholder.typicode.com/todos'" rel="noopener ugc nofollow" target="_blank">http://jsonplaceholder.typicode.com/todos'</a><br/>).json()</span><span id="8dca" class="lo lp hu lj b fv lu lr l ls lt"># let's put some salt and pepper, skipping some todos<br/>filtered_todos = [<br/>    t for t in todos if 'et' in t['title']<br/>]</span></pre><p id="cfba" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在一个<em class="kg"> IPython </em>会话中复制并粘贴它们，您应该能够得到如下结果:</p><pre class="ki kj kk kl fq lk lj ll lm aw ln dt"><span id="d24b" class="lo lp hu lj b fv lq lr l ls lt">In [9]: len(users_by_id)<br/>Out[9]: 10</span><span id="2c0f" class="lo lp hu lj b fv lu lr l ls lt">In [10]: len(filtered_todos)<br/>Out[10]: 62</span></pre><p id="6c61" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们需要一个<em class="kg">计数器</em>实例，来计算每个用户已经发布了多少帖子。</p><pre class="ki kj kk kl fq lk lj ll lm aw ln dt"><span id="04a6" class="lo lp hu lj b fv lq lr l ls lt"># use a counter for user todos<br/>user_todos = Counter()<br/>for t in filtered_todos:<br/>    user_todos[t['userId']] += 1</span></pre><p id="71ea" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">同样，IPython应该显示我们的<em class="kg">计数器</em>表示:</p><pre class="ki kj kk kl fq lk lj ll lm aw ln dt"><span id="0136" class="lo lp hu lj b fv lq lr l ls lt">In [11]: user_todos<br/>Out[11]: Counter({1: 6, 2: 4, 3: 7, 4: 5, 5: 8, 6: 8, 7: 7, 8: 7, 9: 5, 10: 5})</span></pre><p id="2c0c" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在我们的例子中，<em class="kg">用户</em> #5和#6是最有生产力的，因为他们各自发表了8篇文章。</p><p id="9e59" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">是时候使用一些Redis命令了。</p><pre class="ki kj kk kl fq lk lj ll lm aw ln dt"><span id="a1d2" class="lo lp hu lj b fv lq lr l ls lt"># it's going to connect to localhost on port 6379<br/>r = redis.StrictRedis()</span><span id="1f4e" class="lo lp hu lj b fv lu lr l ls lt"># be careful when you flush your DB<br/># in case you need it, it's as simple as<br/># r.flushdb()</span><span id="ba0b" class="lo lp hu lj b fv lu lr l ls lt">for k, v in user_todos.items():<br/>    r.zadd("todos", {users_by_id[k]["username"]: v})</span></pre><p id="3fe9" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们刚刚填充了一个Redis <em class="kg">排序集</em>，它有一个类似于前面的计数器，但是使用用户名作为键。</p><p id="8573" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在IPython上，我们可以看到发生了什么:</p><pre class="ki kj kk kl fq lk lj ll lm aw ln dt"><span id="8040" class="lo lp hu lj b fv lq lr l ls lt">In [12]: r.zrange('todos', 0, len(todos), desc=True, withscores=True)<br/>Out[12]: <br/>[(b'Leopoldo_Corkery', 8.0),<br/> (b'Kamren', 8.0),<br/> (b'Samantha', 7.0),<br/> (b'Maxime_Nienow', 7.0),<br/> (b'Elwyn.Skiles', 7.0),<br/> (b'Bret', 6.0),<br/> (b'Moriah.Stanton', 5.0),<br/> (b'Karianne', 5.0),<br/> (b'Delphine', 5.0),<br/> (b'Antonette', 4.0)]</span></pre><p id="49c9" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这是我们的用户，以及他们的用户名。你看我们在<em class="kg">柜台</em>发现的两张顶级海报。<a class="ae kf" href="https://hackernoon.com/tagged/mocket" rel="noopener ugc nofollow" target="_blank"> <em class="kg">模仿</em> </a>的时间，及其新的<em class="kg">录制</em>功能。让我们在第一个脚本中添加几行代码，就在导入定义之后。</p><pre class="ki kj kk kl fq lk lj ll lm aw ln dt"><span id="ddb3" class="lo lp hu lj b fv lq lr l ls lt">from collections import Counter<br/>import requests<br/>import redis<br/>from mocket import Mocket</span><span id="e284" class="lo lp hu lj b fv lu lr l ls lt">Mocket.enable('example', '.')</span><span id="7afc" class="lo lp hu lj b fv lu lr l ls lt"># get all users<br/>users = requests.get(<br/>    '<a class="ae kf" href="http://jsonplaceholder.typicode.com/users'" rel="noopener ugc nofollow" target="_blank">http://jsonplaceholder.typicode.com/users'</a><br/>).json()</span><span id="669d" class="lo lp hu lj b fv lu lr l ls lt">[...]</span></pre><p id="ff0b" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">使用<em class="kg"> Mocket </em>的经典方式是定义一堆<em class="kg">条目</em>实例——也就是模仿一些资源。在这个例子中，我们的目标是让<em class="kg"> Mocket </em>将实际套接字上运行的内容转储到一个名为<code class="eh lg lh li lj b">example.json</code>的文件中，该文件将在本地目录中创建，该目录由我们作为第二个参数输入的<code class="eh lg lh li lj b">.</code>指定。</p><p id="b7c6" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这正是我们的<code class="eh lg lh li lj b">Mocket.enable('example', '.')</code>所做的。</p><p id="7ead" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">再次运行我们的脚本。看里面有什么<code class="eh lg lh li lj b">example.json</code>，纯魔术。</p><p id="9767" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在反复运行这个脚本，您会看到它有多快，因为每个响应都直接来自我们的JSON转储。</p></div><div class="ab cl kz la hc lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hn ho hp hq hr"><blockquote class="kt ku kv"><p id="a2fd" class="jj jk kg jl b jm jn iv jo jp jq iy jr kw jt ju jv kx jx jy jz ky kb kc kd ke hn dt translated">它是<em class="hu"> HTTPretty </em>、<em class="hu"> vcrpy </em>等等。</p><p id="c050" class="jj jk kg jl b jm jn iv jo jp jq iy jr kw jt ju jv kx jx jy jz ky kb kc kd ke hn dt translated">是<a class="ae kf" href="https://github.com/mindflayer/python-mocket" rel="noopener ugc nofollow" target="_blank"> <em class="hu"> Mocket </em> </a>，socket mock框架。</p></blockquote></div><div class="ab cl kz la hc lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hn ho hp hq hr"><p id="192c" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><a class="ae kf" href="https://github.com/mindflayer/python-mocket" rel="noopener ugc nofollow" target="_blank">https://github.com/mindflayer/python-mocket</a></p><div class="ki kj kk kl fq ab cb"><figure class="lv km lw lx ly lz ma paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="lv km lw lx ly lz ma paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="lv km lw lx ly lz ma paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="kt ku kv"><p id="f922" class="jj jk kg jl b jm jn iv jo jp jq iy jr kw jt ju jv kx jx jy jz ky kb kc kd ke hn dt translated"><a class="ae kf" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是AMI家庭的一员。我们现在<a class="ae kf" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae kf" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jj jk kg jl b jm jn iv jo jp jq iy jr kw jt ju jv kx jx jy jz ky kb kc kd ke hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kf" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kf" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="ki kj kk kl fq km fe ff paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="fe ff mb"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="ki kj kk kl fq km"><div class="bz el l di"><div class="mg mh l"/></div></figure></div></div>    
</body>
</html>