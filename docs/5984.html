<html>
<head>
<title>Docker Compose + GPU + TensorFlow = ❤️</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">docker compose+GPU+tensor flow =❤️</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/docker-compose-gpu-tensorflow-%EF%B8%8F-a0e2011d36?source=collection_archive---------2-----------------------#2017-08-28">https://medium.com/hackernoon/docker-compose-gpu-tensorflow-%EF%B8%8F-a0e2011d36?source=collection_archive---------2-----------------------#2017-08-28</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="bf2f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Docker很棒——越来越多的人利用它进行开发和发布。即时环境设置、独立于平台的应用、现成的解决方案、更好的版本控制、简化的维护:Docker有很多好处。</p><p id="f3f6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是当涉及到数据科学和深度学习时，就有一定的障碍了。你必须记住所有这些docker标志，以便在主机和容器之间共享端口和文件，创建不必要的<code class="eh jp jq jr js b">run.sh</code>脚本，并处理CUDA版本和GPU共享。如果你见过这个错误，你就知道它的痛苦:</p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="d239" class="kb kc hu js b fv kd ke l kf kg">$ nvidia-smi <br/>Failed to initialize NVML: Driver/library version mismatch</span></pre><figure class="jt ju jv jw fq ki fe ff paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="fe ff kh"><img src="../Images/9624485b3a54e37dcc9bd84dc3e0840b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nbtUgG4ZD9tayuliqwAkWA.png"/></div></div></figure><h1 id="8e02" class="kp kc hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">我们的目标</h1><p id="ad1a" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">这篇小帖子的目的是向您介绍我们公司经常使用的一套足够的Docker实用程序和GPU就绪样板文件。</p><p id="b5ee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以，不要这样:</p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="fb67" class="kb kc hu js b fv kd ke l kf kg">docker run \<br/>--rm \<br/>--device /dev/nvidia0:/dev/nvidia0 \<br/>--device /dev/nvidiactl:/dev/nvidiactl \<br/>--device /dev/nvidia-uvm:/dev/nvidia-uvm \<br/>-p 8888:8888 \<br/>-v `pwd`:/home/user \<br/>gcr.io/tensorflow/tensorflow:latest-gpu</span></pre><p id="f59a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你会得到这样的结果:</p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="1be5" class="kb kc hu js b fv kd ke l kf kg">doc up</span></pre><p id="bd28" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">很酷，对吧？</p><p id="ef3c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们实际上想要实现什么:</p><ul class=""><li id="5c5c" class="lr ls hu it b iu iv iy iz jc lt jg lu jk lv jo lw lx ly lz dt translated">使用一个命令管理我们的应用程序状态(运行、停止、删除)</li><li id="9e78" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated">将所有这些运行标志保存到我们可以提交给git repo的单个配置文件中</li><li id="0740" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated">忘记GPU驱动版本不匹配和共享</li><li id="238a" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated">在Kubernetes或Rancher等生产工具中使用GPU就绪的容器</li></ul><p id="50f7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是我们向每个深度学习者强烈推荐的工具列表:</p><h1 id="d81f" class="kp kc hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">1.库达</h1><p id="9dff" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">首先，你需要<a class="ae mf" href="https://developer.nvidia.com/cuda-downloads" rel="noopener ugc nofollow" target="_blank">的CUDA工具包</a>。如果你打算自己训练模特，这绝对是必备的。我们建议使用<code class="eh jp jq jr js b">runfile</code>安装程序类型，而不是<code class="eh jp jq jr js b">deb</code>，因为它不会在将来的更新中弄乱你的依赖关系。</p><p id="70f0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="mg">(可选)如何检查是否工作:</em></p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="4278" class="kb kc hu js b fv kd ke l kf kg">cd /usr/local/cuda/samples/1_Utilities/deviceQuery<br/>make<br/>./deviceQuery # Should print "Result = PASS"</span></pre><h1 id="6fe9" class="kp kc hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">2.码头工人</h1><p id="8ecb" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">你不想用大量的库污染你的计算机，也不想害怕破碎的版本。此外，您不必自己构建和安装软件——通常，软件已经为您构建好了，并打包在映像中！<a class="ae mf" href="https://www.docker.com/get-docker" rel="noopener ugc nofollow" target="_blank">安装Docker </a>很简单:</p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="a380" class="kb kc hu js b fv kd ke l kf kg">curl -sSL <a class="ae mf" href="https://get.docker.com/" rel="noopener ugc nofollow" target="_blank">https://get.docker.com/</a> | sh</span></pre><h1 id="4e7a" class="kp kc hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">3.Nvidia Docker</h1><p id="df2b" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">如果你使用Docker，必须有NVIDIA的<a class="ae mf" href="https://github.com/NVIDIA/nvidia-docker" rel="noopener ugc nofollow" target="_blank">实用程序</a>——它真的简化了Docker容器中GPU的使用。</p><p id="34a2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">安装非常简单:</p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="1be6" class="kb kc hu js b fv kd ke l kf kg">wget -P /tmp https://github.com/NVIDIA/nvidia-docker/releases/download/v1.0.1/nvidia-docker_1.0.1-1_amd64.deb<br/>sudo dpkg -i /tmp/nvidia-docker*.deb</span></pre><p id="e756" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，不是每次都像这样共享nvidia设备:</p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="faa4" class="kb kc hu js b fv kd ke l kf kg">docker run --rm --device /dev/nvidia0:/dev/nvidia0 --device /dev/nvidiactl:/dev/nvidiactl --device /dev/nvidia-uvm:/dev/nvidia-uvm <!-- -->nvidia/cuda nvidia-smi</span></pre><p id="666f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以使用<code class="eh jp jq jr js b">nvidia-docker</code>命令:</p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="a4fe" class="kb kc hu js b fv kd ke l kf kg">nvidia-docker run --rm nvidia/cuda nvidia-smi</span></pre><p id="58cd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此外，您可以停止担心驱动程序版本不匹配:Nvidia的docker插件将解决您的问题。</p><h1 id="f3a6" class="kp kc hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">4.Docker撰写</h1><p id="4100" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">这是一个非常有用的工具，允许你在一个文件中存储<code class="eh jp jq jr js b">docker run</code>配置，并且更容易地管理应用程序状态。尽管docker compose被设计为将多个docker容器“组合”在一起，但当您只有一个服务时，它仍然非常有用。在这里选择稳定版本<a class="ae mf" href="https://github.com/docker/compose/releases" rel="noopener ugc nofollow" target="_blank"/>:</p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="9162" class="kb kc hu js b fv kd ke l kf kg">curl -L https://github.com/docker/compose/releases/download/1.15.0/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose<br/>chmod +x /usr/local/bin/docker-compose</span></pre><h1 id="28f5" class="kp kc hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">5.Nvidia Docker撰写</h1><p id="0fbe" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">可惜Docker Compose不知道Nvidia Docker的存在。幸运的是，有一个解决方案:一个微小的<a class="ae mf" href="https://github.com/eywalker/nvidia-docker-compose" rel="noopener ugc nofollow" target="_blank"> Python脚本</a>，用<code class="eh jp jq jr js b">nvidia-docker</code>驱动程序生成配置。使用pip安装它:</p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="9c65" class="kb kc hu js b fv kd ke l kf kg">pip install nvidia-docker-compose</span></pre><p id="2f51" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在你可以用<code class="eh jp jq jr js b">nvidia-docker-compose</code>命令代替<code class="eh jp jq jr js b">docker-compose</code>。</p><h2 id="6d65" class="kb kc hu bd kq mh mi mj ku mk ml mm ky jc mn mo lc jg mp mq lg jk mr ms lk mt dt translated">供选择的</h2><p id="ce6a" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">如果不想用<code class="eh jp jq jr js b">nvidia-docker-compose</code>，可以<a class="ae mf" href="https://github.com/NVIDIA/nvidia-docker/wiki/NVIDIA-driver#alternatives" rel="noopener ugc nofollow" target="_blank">手动通过音量驱动器</a>。只需将这些选项添加到您的<code class="eh jp jq jr js b">docker-compose.yml</code>中:</p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="5920" class="kb kc hu js b fv kd ke l kf kg"># Your nvidia driver version here<br/>volumes:<br/>  nvidia_driver_375.26:<br/>    external: true<br/>...<br/>  volumes:<br/>    - nvidia_driver_375.26:/usr/local/nvidia:ro</span></pre><h1 id="6918" class="kp kc hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">6.Bash别名</h1><p id="de6f" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">但是<code class="eh jp jq jr js b">nvidia-docker-compose</code>是21个字符打出来的！那太多了。</p><figure class="jt ju jv jw fq ki fe ff paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="fe ff mu"><img src="../Images/8dae09ce86dede4bbfff2c19b618672b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ze6lqlMM2Lesvq1Ywm5K4g.jpeg"/></div></div></figure><p id="fa39" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">幸运的是我们可以使用bash别名。在您最喜欢的编辑器中打开<code class="eh jp jq jr js b">~/.bashrc</code>(有时是<code class="eh jp jq jr js b">~/.bash_profile</code>)并输入这些行:</p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="57fc" class="kb kc hu js b fv kd ke l kf kg">alias doc='<!-- -->nvidia-docker-compose<!-- -->'<br/>alias docl='doc logs -f --tail=100'</span></pre><p id="7183" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过运行<code class="eh jp jq jr js b">source ~/.bashrc</code>更新您的设置。</p><h1 id="633a" class="kp kc hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">启动TensorFlow服务</h1><p id="d147" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">现在，我们已经准备好利用上述所有这些优势。例如，让我们运行一个支持Tensorflow GPU的Docker容器。</p><p id="6832" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在项目目录下创建文件<code class="eh jp jq jr js b">docker-compose.yml</code>，内容如下:</p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="bf35" class="kb kc hu js b fv kd ke l kf kg">version: '3'</span><span id="e348" class="kb kc hu js b fv mv ke l kf kg">services:<br/>  tf:<br/>    image: gcr.io/tensorflow/tensorflow:latest-gpu<br/>    ports:<br/>      - 8888:8888<br/>    volumes:<br/>      - .:/notebooks</span></pre><p id="d437" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我们可以用一条命令启动TensorFlow Jupiter:</p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="56a5" class="kb kc hu js b fv kd ke l kf kg">doc up</span></pre><figure class="jt ju jv jw fq ki fe ff paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="fe ff mw"><img src="../Images/49b30e16e8d8136a693650e531c47b94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DDoYc3hQhzjalnhn_msLQw.png"/></div></div></figure><p id="39fd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh jp jq jr js b">doc</code>是<code class="eh jp jq jr js b">nvidia-docker-compose</code>的别名——它将使用正确的<code class="eh jp jq jr js b">volume-driver</code>生成修改后的配置文件<code class="eh jp jq jr js b">nvidia-docker-compose.yml</code>,然后运行<code class="eh jp jq jr js b">docker-compose</code>。</p><p id="e3bd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以使用相同的命令管理您的服务:</p><pre class="jt ju jv jw fq jx js jy jz aw ka dt"><span id="00a8" class="kb kc hu js b fv kd ke l kf kg">doc logs<br/>doc stop<br/>doc rm<br/># ...etc</span></pre><h1 id="d9b0" class="kp kc hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">结论</h1><p id="f58d" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">但这值得努力吗？这里我们来权衡一下利弊。</p><h2 id="26a2" class="kb kc hu bd kq mh mi mj ku mk ml mm ky jc mn mo lc jg mp mq lg jk mr ms lk mt dt translated">赞成的意见</h2><ul class=""><li id="fd67" class="lr ls hu it b iu lm iy ln jc mx jg my jk mz jo lw lx ly lz dt translated">忘记GPU设备共享</li><li id="d6b2" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated">你再也不用担心Nvidia驱动版本了</li><li id="d33b" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated">我们抛弃了命令标志，支持干净和简单的配置</li><li id="d21e" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated">不再有用于管理容器状态的<code class="eh jp jq jr js b">--name</code>标志</li><li id="6dd4" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated">众所周知的记录在案的和广泛使用的实用程序</li><li id="30ff" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated">您的配置已经为像Kubernetes这样理解docker-compose文件的编排工具做好了准备</li></ul><h2 id="928f" class="kb kc hu bd kq mh mi mj ku mk ml mm ky jc mn mo lc jg mp mq lg jk mr ms lk mt dt translated">骗局</h2><ul class=""><li id="36a0" class="lr ls hu it b iu lm iy ln jc mx jg my jk mz jo lw lx ly lz dt translated">你必须安装更多的工具</li></ul><h1 id="9a2e" class="kp kc hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">生产就绪了吗？</h1><p id="ab64" class="pw-post-body-paragraph ir is hu it b iu lm iw ix iy ln ja jb jc lo je jf jg lp ji jj jk lq jm jn jo hn dt translated">没错。在我们的电影推荐服务<a class="ae mf" href="https://movix.ai" rel="noopener ugc nofollow" target="_blank"> Movix </a>中，我们使用GPU加速的TensorFlow网络根据用户输入计算实时电影选择。</p><p id="44c4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在代理API后面的<a class="ae mf" href="http://rancher.com/" rel="noopener ugc nofollow" target="_blank">牧场主集群</a>中，我们有三台装有Nvidia Titan X的计算机。配置存储在常规的<code class="eh jp jq jr js b">docker-compose.yml</code>文件中:因此在新的服务器上设置开发环境或部署应用程序非常容易。到目前为止，它运行良好。</p><figure class="jt ju jv jw fq ki fe ff paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="fe ff na"><img src="../Images/1d4a02d0a8f5e4cafc094eaee5cac26b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4yLLzzJ5LIPlNVR6SI4bDA.png"/></div></div><figcaption class="nb nc fg fe ff nd ne bd b be z ek">Be prepared for the future of ML!</figcaption></figure><p id="ed44" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="mg">如有任何问题或意见，欢迎在此处或推特上写下</em><a class="ae mf" href="http://twitter.com/deepsystemsru" rel="noopener ugc nofollow" target="_blank"><em class="mg">@ deepsystemsru</em></a><em class="mg">。</em></p></div></div>    
</body>
</html>