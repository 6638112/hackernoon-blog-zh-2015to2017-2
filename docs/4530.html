<html>
<head>
<title>Routing to namespaces</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">路由到名称空间</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/routing-to-namespaces-8e1eaffaac7f?source=collection_archive---------12-----------------------#2017-06-06">https://medium.com/hackernoon/routing-to-namespaces-8e1eaffaac7f?source=collection_archive---------12-----------------------#2017-06-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="ee00" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我很想知道一个缓冲区(skb)是如何“路由”到一个特定的名称空间或进程的。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/e08e61cd6af88881df7816e52a550c85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ductCv_fSgJ_Rt9xP4vf1w.png"/></div></div></figure><p id="e042" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就这么简单，我想知道userland告诉内核将数据发送到特定名称空间/接口的机制。</p><p id="d157" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以我发现内核在2.4版本中有一个特定的接口专门用于这种用途。<strong class="it hv"> AF_NETLINK </strong>，你可能对AF_UNIX或AF_INET很熟悉，因为它是建立在bsd sockets架构之上的，所以它使用了<strong class="it hv"> bind() listen() accept() </strong>等方法。</p><p id="9137" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">开始吧，首先我将跟踪创建网络名称空间的userland命令(<strong class="it hv"> ip route2 </strong>):</p><pre class="jq jr js jt fq kb kc kd ke aw kf dt"><span id="4d92" class="kg kh hu kc b fv ki kj l kk kl">strace ip netns add demo -e trace=network</span></pre><p id="4a57" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这会创建一个网络名称空间，并将<strong class="it hv">从父节点中取消共享()</strong>，结果片段如下:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff km"><img src="../Images/c00641dcef1875ec0c78ffb57cfbe7e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nUJ3QoBGi41jx9QmxV4-hg.png"/></div></div></figure><p id="8634" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，您可以看到正在发生一些事情，出于某种原因，ip route创建了一个特定类型的套接字(<strong class="it hv"> NETLINK </strong>)，并且正在向<strong class="it hv">内核</strong>发送一些数据(配置数据，例如路由)。</p><p id="c8e8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">之后<strong class="it hv">取消共享</strong>发生:(注意<strong class="it hv"> CLONE_NEWNET </strong>)</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kn"><img src="../Images/1870fd4ac51da8b8269de403fa12bd85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fj5unQAcXBlt5R_2Ul4Q5g.png"/></div></div></figure><p id="039a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">到目前为止，理论上我们有了一个新的网络名称空间，我们可以检查:</p><pre class="jq jr js jt fq kb kc kd ke aw kf dt"><span id="e7cd" class="kg kh hu kc b fv ki kj l kk kl">ip netns show</span></pre><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ko"><img src="../Images/7777df7c5ae7cd79f6527db3e9a05f9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n3M-NnX7MNaHFlIwxA6oHg.png"/></div></div></figure><p id="a958" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">看起来不错，现在我们需要创建一个对等体或veth，并将其中一个添加到名称空间，您可能以前见过<strong class="it hv">veth</strong>，它们是虚拟以太网设备，大多数情况下是成对的，这就像一种帧转发设备，例如，您在<strong class="it hv"> veth0 </strong>中插入的任何帧都会到达<strong class="it hv"> veth1 </strong>。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kp"><img src="../Images/a7565932b4dba4529b402728f56022ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OBZjd0q1iQht7gtWWMlZgg.png"/></div></div></figure><p id="c865" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们创建一对Veths，并将其中一个添加到<strong class="it hv"> demo </strong>名称空间中</p><pre class="jq jr js jt fq kb kc kd ke aw kf dt"><span id="0eff" class="kg kh hu kc b fv ki kj l kk kl">ip link add veth0 type veth peer name veth1</span></pre><p id="c204" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在将<strong class="it hv"> veth1 </strong>连接到<strong class="it hv"> demo </strong></p><pre class="jq jr js jt fq kb kc kd ke aw kf dt"><span id="017d" class="kg kh hu kc b fv ki kj l kk kl">ip link set veth1 netns demo</span></pre><p id="2c82" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">太好了，这些接口都没有ip地址，所以什么都不能有效地工作，但是我们怎样才能“tcpdump”NETLINK流量，这可能吗？</p><p id="e0ce" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">理论上，我们应该看到从ip路由到内核的AF_NETLINK消息，说“<strong class="it hv">嘿，所有进入veth1的流量也应该进入这个名称空间”</strong></p><p id="4ca7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">据我所知，tcpdump不能做到这一点，但ip路由有一个监控功能，这是我们得到的结果:</p><pre class="jq jr js jt fq kb kc kd ke aw kf dt"><span id="d072" class="kg kh hu kc b fv ki kj l kk kl">ip monitor all</span></pre><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kq"><img src="../Images/4bdbf6d5f3bcfe160f5c35bc58cabd84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u5BOQuf0fOvA9PnSSMVGxw.png"/></div></div></figure><p id="11ae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我认为，对我来说似乎很清楚的部分是在<strong class="it hv">“IP链接集veth1 netns演示”</strong>之后发生的事情</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kr"><img src="../Images/961115f3fa4b041c8a72eafc92921b1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OmM5myDrPn14s-UWyHjRoA.png"/></div></div></figure><p id="9c05" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">netlink(<strong class="it hv">net/netlink/af _ netlink . c</strong>)的实现完全知道用户名称空间。</p><p id="32c6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在剩下的问题是，内核知道一个给定的流量必须被“路由”到一个特定的名称空间(或网络堆栈的一个特定副本)，它如何从那里工作？啊我还不知道，但是我会设法找到它。</p><p id="3793" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">郑重声明:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ks"><img src="../Images/aaf5b2b297b91702854d1cf47e322e5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4bJjdiiiHIXXhpnKsIiS_g.png"/></div></div></figure><div class="jq jr js jt fq ab cb"><figure class="kt ju ku kv kw kx ky paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="kt ju ku kv kw kx ky paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="kt ju ku kv kw kx ky paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="kz la lb"><p id="f922" class="ir is lc it b iu iv iw ix iy iz ja jb ld jd je jf le jh ji jj lf jl jm jn jo hn dt translated"><a class="ae lg" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae lg" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae lg" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae lg" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is lc it b iu iv iw ix iy iz ja jb ld jd je jf le jh ji jj lf jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae lg" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae lg" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff lh"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>