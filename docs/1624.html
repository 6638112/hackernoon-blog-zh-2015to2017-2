<html>
<head>
<title>Help, my sin() is slow, and my FPU is inaccurate!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">救命，我的sin()慢，FPU不准！</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/help-my-sin-is-slow-and-my-fpu-is-inaccurate-a2c751106102?source=collection_archive---------4-----------------------#2016-11-22">https://medium.com/hackernoon/help-my-sin-is-slow-and-my-fpu-is-inaccurate-a2c751106102?source=collection_archive---------4-----------------------#2016-11-22</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="e072" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">几年前我开始写代码做一个生物系统的模拟，写了20行就卡住了。我的测试代码试图完成一百万个时间步骤，但基本上什么都没做，而且只花了一分钟。然而，如果我把它减少到只有100，000个时间步，它就会向前移动。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff jp"><img src="../Images/fa9914e25b503155046447497b662f7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/0*80mu1QlnsRQeUWvK."/></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">Number of steps versus running time for sin() and cos()</figcaption></figure><p id="68f6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以我检查了一些常见的事情——是不是有一个<a class="ae kb" href="https://hackernoon.com/tagged/cpu" rel="noopener ugc nofollow" target="_blank"> CPU </a>频率缩放问题，是不是我的CPU过热了，等等，但是都不是这样。然后，我将对sin()的调用改为对cos()的调用..一切又变得很快。</p><p id="4036" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">经过一些进一步的测试，我还发现将M_PI改为3.141也可以使速度再次加快。把我弄糊涂了！</p><p id="6ec2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以，我深入研究了汇编输出，在那里我发现当我把M_PI或sin()改为cos()时，我的代码并没有真正发生变化。我注意到的是，实际调用了C库中的一个sin()函数。</p><p id="cb8d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在网上搜索发现了各种关于sin()和cos()的错误报告，它们有时既不准确又很慢。这让我震惊。20世纪80年代末，我第一次接触到带有浮点运算单元的计算机。在过去的三十年里，我一直(正确地)假设一个<a class="ae kb" href="https://hackernoon.com/tagged/fpu" rel="noopener ugc nofollow" target="_blank"> FPU </a>会附带一个专用的SINCOS指令。我还假设(不正确！)既然它是CPU自带的，那么它将会是正确的&amp;快，人们将会使用它！</p><p id="943d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">事实证明，FPU提供的既不正确，也不快速。事实上，似乎没有人使用FPU的三角学指令。那么是什么原因呢？</p><h1 id="ffba" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">范围缩小</h1><p id="b433" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">射程的缩小。使用简单的近似公式，例如<a class="ae kb" href="http://en.wikipedia.org/wiki/Taylor_series" rel="noopener ugc nofollow" target="_blank">泰勒级数</a>，完全有可能非常快速地计算出小x的sin(x)。也可以使用表格，对于硬件来说，有一种合适的算法称为<a class="ae kb" href="http://en.wikipedia.org/wiki/CORDIC" rel="noopener ugc nofollow" target="_blank"> CORDIC </a>(用于坐标旋转数字计算机)。</p><p id="caf0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">虽然这种近似只适用于小输入，但由于sin()和cos()是周期性的，因此完全有可能将大输入角映射到小输入角。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff jp"><img src="../Images/293d964d44e27269423e78343218a3ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/0*VAT-TUK1kXgB0jtI."/></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">Actual sin(x) versus 11th order Taylor series, tsin(x)</figcaption></figure><p id="c3e7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">假设我们试图计算sin(1 + 600π)，我们可以将其映射为试图计算sin(1)，答案将是相同的。</p><p id="d82f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要做到这一点，计算机程序必须采用提供的输入值，并去掉足够多的π的偶数倍，以使结果值足够小，从而使我们的近似足够精确。</p><p id="dcbb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">困难就在这里。如果我们的输入可以是通过双精度浮点数可获得的所有值，那么天真地执行这种范围缩小需要知道π达到惊人的精度，<strong class="it hv">这是浮点硬件本身无法达到的精度</strong>！</p><p id="57b8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">很容易看出这是如何工作的——即使π值的微小误差累加起来，在我们的sin(1 + 600π)示例中，1/1000的误差仍会导致0.6！</p><p id="3d55" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当然，CPU可以做得比1/1000的错误更好，但它仍然无法将(比如说)10^22降低到正确的值。要在实践中看到这一点，sin(9*10^18的正确值是-0.48200764357448050434，但如果我们问我的英特尔FPU，它返回-0.47182360331267464426，相差超过2%。值得称赞的是，如果我们要求FPU计算更大数字的正弦，它会拒绝。</p><p id="1a70" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此..这解释了为什么编程语言不能依靠FPU来计算正确的值。但是它仍然没有解释高级语言如何解决这个问题。</p><h1 id="3bf6" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">追溯到1982年</h1><p id="3a5f" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">众所周知，缩小范围的问题非常困难，以至于程序员被敦促不要试图计算非常大的角度的正弦值！“你做范围缩小”。然而，这是淡酱，使生活变得不必要的艰难。例如，如果对系统对f Hz正弦波输入的响应进行建模，则通常需要长时间计算F(x) = sin(2π * f * t)。如果我们只能用精心选择的时间步长或频率来运行模拟，以便我们能够轻松地将我们的范围调整回个位数，那将是非常不方便的。</p><p id="3edb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，在多年来告诉程序员要清理他们的行为之后，突然两个独立的小组取得了突破。数字设备公司的玛丽·h·佩恩(Mary H. Payne)和罗伯特·n·哈内克(Robert N. Hanek)发表了开创性的论文《三角函数的弧度简化》，<a class="ae kb" href="http://dl.acm.org/citation.cfm?id=1057602" rel="noopener ugc nofollow" target="_blank"> paywalled至今</a>。与此同时，加州大学伯克利分校的鲍勃·科比特没有写论文，但是<a class="ae kb" href="http://ftp.netbsd.org/pub/NetBSD/NetBSD-current/src/lib/libm/arch/vax/n_sincos.S" rel="noopener ugc nofollow" target="_blank">在BSD中独立实现了</a>相同的技术。</p><p id="b8ea" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我很想解释它是如何工作的，但我不能解释让我很痛苦。虽然它非常聪明！很明显，我们不得不感谢佩恩、哈内克和科比特发明了“无限精度范围缩减”！它似乎被普遍使用，而且令人震惊的是，在1982年之前，在现有的硬件上很难对非常大的数字进行三角运算！</p><h1 id="fa88" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">那么为什么我的原始代码这么慢呢？</h1><p id="9cdb" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">我们现在知道，计算机使用实际代码来计算sin(x)，而不是将其留给专用的FPU指令。但为什么快到17万步呢？事实证明，在我的C库中找到的sin(x)包含计算正确答案的各种策略，并且它确实使用了Payne-Hanek-Corbett技术，正如IBM在其精确数学库中实现的那样。</p><p id="51d8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果一切顺利，就会使用一些非常快速的代码。但是如果这个库检测到它不能保证所需精度的情况，它会返回到一个名为“slow()”的函数。他们名副其实。这应该是罕见的，为什么会发生在我身上呢？</p><p id="29ea" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">即测试代码:</p><pre class="jq jr js jt fq lf lg lh li aw lj dt"><span id="07d1" class="lk kd hu lg b fv ll lm l ln lo">int main(int argc, char **argv)<br/>{<br/> double t;<br/> double stepsizeMS=0.1;<br/> double Hz=1000;<br/> double val=0;<br/> unsigned int limit = argc &gt; 1 ? atoi(argv[1]) : 200000;</span><span id="b38b" class="lk kd hu lg b fv lp lm l ln lo"> for(unsigned int steps = 0; steps &lt; limit; ++steps) {<br/>    t = steps * stepsizeMS;<br/>    val = sin(2.0*M_PI*Hz*t);<br/>    printf(“%f %f\n”, t, val);<br/> }<br/>}</span></pre><p id="1d47" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">看看你是否能发现它。我没有，但最优秀的尼古拉斯·米尔做到了。这段代码有效地计算了π 的整数倍<strong class="it hv">的正弦值，因为Hz*stepsizeMS等于100.0000，而steps是一个整数。显然，在大约100，000步之后，这将触发glibc libm实现返回到“slow()”函数之一。</strong></p><p id="f690" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这也解释了为什么通过将sin()改为cos()，或者我只从M_PI中去掉一点点精度，问题就消失了——我们不再总是走在慢路上。</p><p id="83f3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我并不高兴system C库表现出如此缓慢的速度(其他人已经注意到了这一点，参见参考文献2)，但在这种情况下，我的模拟在任何情况下都是无用的——无论如何，我只会施加0的力，而永远不会实现任何东西！</p><p id="93e0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">事实证明，确实有一些库提供了卓越的性能，比如:</p><ul class=""><li id="9346" class="lq lr hu it b iu iv iy iz jc ls jg lt jk lu jo lv lw lx ly dt translated"><a class="ae kb" href="http://software.intel.com/en-us/intel-mkl/" rel="noopener ugc nofollow" target="_blank">英特尔MKL </a>(不免费，既不是啤酒，也不是演讲)</li><li id="e08c" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated"><a class="ae kb" href="http://developer.amd.com/tools-and-sdks/cpu-development/amd-core-math-library-acml/" rel="noopener ugc nofollow" target="_blank"> AMD ACML </a>(免费，但无源码，CPU支持有限)</li><li id="5967" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo lv lw lx ly dt translated"><a class="ae kb" href="http://gruntthepeon.free.fr/ssemath/" rel="noopener ugc nofollow" target="_blank">简单的SSE和SSE2(以及现在的NEON)优化了sin、cos、log和exp </a> (zlib许可，非常快，但不缩小范围)</li></ul><h1 id="63fe" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">总结</h1><p id="7929" class="pw-post-body-paragraph ir is hu it b iu la iw ix iy lb ja jb jc lc je jf jg ld ji jj jk le jm jn jo hn dt translated">计算(co)正弦是“手动”完成的，可能会根据您的输入以不同的速度进行。你的FPU的输出可能是错误的，许多FPU拒绝处理非常大的输入。如果您确实需要高性能，可能需要比标准系统库更好的库。</p><h1 id="89b9" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">参考</h1><ol class=""><li id="82b4" class="lq lr hu it b iu la iy lb jc me jg mf jk mg jo mh lw lx ly dt translated">巨大论点的论点简化:好到最后一点作者:吴国昌和SunPro的FP小组成员—<a class="ae kb" href="http://www.validlab.com/arg.txt" rel="noopener ugc nofollow" target="_blank">http://www.validlab.com/arg.txt</a></li><li id="a2c4" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo mh lw lx ly dt translated">glibc libm的状态(dire)——<a class="ae kb" href="http://gcc.gnu.org/ml/gcc/2012-02/msg00469.html" rel="noopener ugc nofollow" target="_blank">http://gcc.gnu.org/ml/gcc/2012-02/msg00469.html</a></li><li id="2e37" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo mh lw lx ly dt translated">英特尔夸大了FPU的准确性—<a class="ae kb" href="http://notabs.org/fpuaccuracy/" rel="noopener ugc nofollow" target="_blank">http://notabs.org/fpuaccuracy/</a></li><li id="3c1b" class="lq lr hu it b iu lz iy ma jc mb jg mc jk md jo mh lw lx ly dt translated">一种新的距离缩减算法——http://www.imada.sdu.dk/~kornerup/papers/RR2.pdf<a class="ae kb" href="http://www.imada.sdu.dk/~kornerup/papers/RR2.pdf" rel="noopener ugc nofollow" target="_blank"/></li></ol><div class="jq jr js jt fq ab cb"><figure class="mi ju mj mk ml mm mn paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mi ju mj mk ml mm mn paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mi ju mj mk ml mm mn paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mo mp mq"><p id="f922" class="ir is mr it b iu iv iw ix iy iz ja jb ms jd je jf mt jh ji jj mu jl jm jn jo hn dt translated"><a class="ae kb" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae kb" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae kb" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae kb" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is mr it b iu iv iw ix iy iz ja jb ms jd je jf mt jh ji jj mu jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kb" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kb" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="fe ff mv"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="na nb l"/></div></figure></div></div>    
</body>
</html>