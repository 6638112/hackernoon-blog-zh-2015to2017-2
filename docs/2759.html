<html>
<head>
<title>Sending Ether Between Two Contracts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在两个合同之间传递以太</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/sending-ether-between-two-contracts-5ad8699805fe?source=collection_archive---------7-----------------------#2017-02-17">https://medium.com/hackernoon/sending-ether-between-two-contracts-5ad8699805fe?source=collection_archive---------7-----------------------#2017-02-17</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="2556" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">什么是真实世界的应用？</strong> <br/>我们有向人们提供服务的提供商，比如互联网、电话、水、食物和住所。想要使用这些服务的人可以订阅这些服务。提供商可以收取用户因使用该服务而欠下的债务。用户可以通过向提供商发送以太网来清偿债务。</p><p id="962b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">提供者有他们跟踪的工作，以便提供他们的服务并雇佣员工来完成这些工作。员工用户可以通过从提供商处提取乙醚来获得报酬。</p><p id="1db9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这篇文章将介绍一名员工用户完成一项工作并从提供商合同中撤销ether，以帮助澄清发送ether到合同的无效跳转错误。我们将以奇点厨房为例。我将首先介绍测试，然后介绍智能合约。</p><p id="9a10" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">免责声明<br/> <strong class="it hv">合同未经审核，包含安全漏洞，请勿用于学习以外的任何其他目的。</strong></p><p id="c7dc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">试验</p><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="6397" class="jy jz hu ju b fv ka kb l kc kd">it('init', function() {<br/>    return Kitchen.new("SingularityKitchen", "Healthy living for the next gen", {from:_owner})<br/>      .then(function(kitchenContract) {<br/>        if(kitchenContract.address){<br/>          kitchen = kitchenContract;<br/>        } else {<br/>          throw new Error("no contract address");<br/>        }<br/>        return true;<br/>      })<br/>  })</span><span id="fb9c" class="jy jz hu ju b fv ke kb l kc kd">it('pay-out-job', function(){<br/>    var jobName = "Single Customer Order";<br/>    assert.equal(balance(kitchen.address), web3.fromWei(1100000000000000000,"ether"))<br/>    return kitchen.payOutJob(staff.address, jobName, {from:_owner})<br/>      .then(function(txHash){<br/>        return kitchen.staffList(staff.address);<br/>      })<br/>      .then(function(staffInfo){<br/>        //this is the payout stored in a struct<br/>        assert.equal(staffInfo[2].toString(), 300000000000000000);<br/>        return kitchen.collectPayout(staff.address, {from:_staff1})<br/>      .then(function(txHash){<br/>        return kitchen.staffList(staff.address);<br/>      })<br/>      .then(function(staffInfo){<br/>        console.log(balance(kitchen.address))<br/>        assert.equal(staffInfo[2].toString(), 0);<br/>        assert.equal(balance(staff.address), web3.fromWei(300000000000000000, "ether"));<br/>        assert.equal(balance(kitchen.address), web3.fromWei(800000000000000000, "ether"));<br/>      })<br/>    })<br/>  })<br/></span></pre><p id="82f2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将在这里介绍这两个测试，合同的其余测试可以在<a class="ae kf" href="https://github.com/qjflores/singularity/tree/master/test" rel="noopener ugc nofollow" target="_blank"> github repo </a>上找到。</p><p id="15b7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在“init”中，我们使用new方法创建了一个厨房合同的新实例，该方法带有一些参数和关于谁在发送该事务的数据。创建智能合约的新实例会返回智能合约，我们可以检查智能合约是否有地址，如果有，我们就将其设置为全局变量‘kitchen’。如果契约没有地址，那么我们抛出一个新的错误。</p><p id="69bc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在“支付工作”中，我们首先检查厨房合同是否有要支付给员工的费用。然后我们尝试从厨房契约中调用payOutJob函数。它接受用户合同的地址和完成的作业名。这种事务由某种所有者调用，比如一个授权用户，他被允许根据合同向完成工作的人支付报酬。一旦payoutjob函数将返回一个txHash，我们不打算对txHash做任何事情，但是我们可以控制台记录它并查看它包含的数据。我们将调用契约的公共属性“staffList ”,这是一个映射数据类型，因此我们将传入用户契约的地址。将用户合同的地址传入staffList将返回一个struct数据类型，该数据类型包含一个用于存储向Staff用户支付的信息的字段。我们可以像调用数组中的元素一样调用结构的内容。StaffInfo[2]是一个uint256数据类型，我们可以调用一个toString方法来获取要支付给用户合同的金额。这里我们断言它是厨房合同中设定的300000000000000卫或“单个顾客订单”工作的比率。当员工用户准备好收取他们的支出时，他们可以从厨房合同中调用collectPayout函数。我们得到一个事务散列并调用staffList，这样我们就可以检查结构中是否有变化。我们检查支出是否已设置为0，厨房和员工合同的余额是否已适当更改。</p><p id="9683" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">智能合同</p><p id="4a81" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们需要两个智能契约来为这个约定提供自治，它们是用户契约和提供者契约。我正在从Shlomi Zeltsinger的这个<a class="ae kf" href="https://www.youtube.com/watch?v=m9Zb49RNGis" rel="noopener ugc nofollow" target="_blank"> YouTube教程系列</a>中构建这些合同。</p><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="42b3" class="jy jz hu ju b fv ka kb l kc kd">contract User {<br/>  string public userName;<br/>  address public owner;</span><span id="45f1" class="jy jz hu ju b fv ke kb l kc kd">mapping (address =&gt; Service) public services;</span><span id="71a8" class="jy jz hu ju b fv ke kb l kc kd">struct Service{<br/>    bool active;<br/>    uint lastUpdated;<br/>    uint debt;<br/>  }</span><span id="4e9e" class="jy jz hu ju b fv ke kb l kc kd">function User(string _name) payable {<br/>    userName = _name;<br/>    owner = msg.sender;<br/>  }</span><span id="96ae" class="jy jz hu ju b fv ke kb l kc kd">function payable {<br/>  }</span><span id="0056" class="jy jz hu ju b fv ke kb l kc kd">function registerToProvider(address _providerAddress){<br/>    services[_providerAddress] = Service({<br/>      active:true,<br/>      lastUpdated: now,<br/>      debt: 0<br/>      });<br/>  }</span><span id="223e" class="jy jz hu ju b fv ke kb l kc kd">function setDebt(uint256 _debt){<br/>    if(services[msg.sender].active){<br/>      services[msg.sender].lastUpdated = now;<br/>      services[msg.sender].debt += _debt;<br/>      } else {<br/>        throw;<br/>      }<br/>  }</span><span id="c1cb" class="jy jz hu ju b fv ke kb l kc kd">function clearDebt() returns (bool result){<br/>    if (services[msg.sender].active){<br/>      services[msg.sender].lastUpdated = now;<br/>      services[msg.sender].debt = 0;<br/>    } else {<br/>      throw;<br/>    }<br/>  }</span><span id="29af" class="jy jz hu ju b fv ke kb l kc kd">function unsubcribe(address _providerAddress){<br/>    if(services[_providerAddress].debt == 0){<br/>      services[_providerAddress].active = false;<br/>    } else {<br/>      throw;<br/>    }<br/>  }</span><span id="ab16" class="jy jz hu ju b fv ke kb l kc kd">contract Provider {<br/>  string public providerName;<br/>  string public description;</span><span id="9886" class="jy jz hu ju b fv ke kb l kc kd">mapping (address =&gt; staffUser) public staffList;<br/>  mapping (bytes32 =&gt; Job) public jobs;</span><span id="3a05" class="jy jz hu ju b fv ke kb l kc kd">struct staffUser{<br/>    bool active;<br/>    uint lastUpdated;<br/>    uint256 payout;<br/>  }</span><span id="b9a5" class="jy jz hu ju b fv ke kb l kc kd">struct Job {<br/>    bytes32 name;<br/>    uint256 rate;<br/>  }</span><span id="99cd" class="jy jz hu ju b fv ke kb l kc kd">function Provider(string _name, string _description) {<br/>    providerName = _name;<br/>    description = _description;<br/>  }</span><span id="e16d" class="jy jz hu ju b fv ke kb l kc kd">function setDebt(uint256 _debt, address _userAddress) {<br/>    User person = User(_userAddress);<br/>    person.setDebt(_debt);<br/>  }</span><span id="665c" class="jy jz hu ju b fv ke kb l kc kd">function recievePayment(address _userAddress) payable returns (bool result) {<br/>    User person = User(_userAddress);<br/>    person.clearDebt();<br/>    return true;<br/>  }</span><span id="8491" class="jy jz hu ju b fv ke kb l kc kd">function addStaff(address _userAddress) {<br/>    staffList[_userAddress] = staffUser({<br/>      active:true,<br/>      lastUpdated: now,<br/>      payout: 0<br/>      });<br/>  }</span><span id="a79f" class="jy jz hu ju b fv ke kb l kc kd">function addJob(bytes32 _name, uint256 _rate) {<br/>    jobs[_name] = Job({name:_name,rate:_rate});<br/>  }</span><span id="8d2e" class="jy jz hu ju b fv ke kb l kc kd">function updateJobRate(bytes32 _name, uint256 _rate){<br/>    jobs[_name].rate = _rate; <br/>  }</span><span id="6498" class="jy jz hu ju b fv ke kb l kc kd">function payOutJob(address _userContractAddress, bytes32 _jobName){<br/>    staffList[_userContractAddress].payout += jobs[_jobName].rate;<br/>  }</span><span id="4a86" class="jy jz hu ju b fv ke kb l kc kd">function collectPayout(address _userContractAddress) {<br/>    uint256 _amount = staffList[_userContractAddress].payout;<br/>    staffList[_userContractAddress].payout = 0; <br/>    if(!_userContractAddress.send(_amount)){<br/>      throw;<br/>    }<br/>  }</span><span id="829f" class="jy jz hu ju b fv ke kb l kc kd">}</span></pre><p id="0698" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将在合同中强调一些与这个职位相关的职能。这里有一个真正<a class="ae kf" href="https://github.com/raineorshine/solidity-by-example/blob/master/send-eth.sol" rel="noopener ugc nofollow" target="_blank">有用的发送以太的例子</a>。</p><p id="7c0c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们的测试中，“staff”变量是用户契约的一个实例。要强调的大函数和编写这个代码评审的主要原因是payable函数。这是一个后备功能。回退功能是不运行任何东西的功能。更多关于回退功能的信息可以在<a class="ae kf" href="https://github.com/ConsenSys/Ethereum-Development-Best-Practices/wiki/Fallback-functions-and-the-fundamental-limitations-of-using-send()-in-Ethereum-&amp;-Solidity" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="d85d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果一个合同正在接收以太网，它需要有这个回退功能，否则你会收到一个无效的跳转错误。</p><blockquote class="kg kh ki"><p id="d16b" class="ir is kj it b iu iv iw ix iy iz ja jb kk jd je jf kl jh ji jj km jl jm jn jo hn dt translated">无效跳转意味着您调用了不存在的代码，或者数组越界。调用不存在的代码可能以多种形式出现:1)由于某种原因，您的契约地址中没有代码，2)您正在调用实际上不可用的契约函数，3)您的契约正在调用另一个不可用的契约或函数。现在最简单的方法是注释掉代码，直到错误消失，然后慢慢地让它返回，直到你找到正确的行。Truffle的下一个重要特性是获取这些消息的堆栈跟踪。—蒂姆</p></blockquote><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="9a49" class="jy jz hu ju b fv ka kb l kc kd">function payable {<br/>  }</span></pre><p id="091f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">payOutJob函数获取用户合同地址和作业名称，该函数所做的就是通过使用用户合同地址调用staffList映射从staffUser结构获取支出字段，然后通过使用jobName调用jobs映射从Job结构获取作业费率字段来更新支出。</p><p id="a4c2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">collectPayout函数获取一个用户协定地址，并通过使用用户协定地址调用staffList映射，将变量_amount设置为staffList结构中的支出字段。然后，我们将支出字段更新为0，并尝试使用“_ usercontracaddress . send(_ amount)”将乙醚量发送给用户合同。如果我们不能发送以太网，那么throw将恢复我们交易中的所有内容，并且支付字段将保持不变。</p><p id="4b25" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">感谢Tim Coulter和Nikita Fuchs对无效跳转的澄清。</p><blockquote class="kg kh ki"><p id="6a71" class="ir is kj it b iu iv iw ix iy iz ja jb kk jd je jf kl jh ji jj km jl jm jn jo hn dt translated"><a class="ae kf" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae kf" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae kf" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae kf" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="dca4" class="ir is kj it b iu iv iw ix iy iz ja jb kk jd je jf kl jh ji jj km jl jm jn jo hn dt translated">要了解更多信息，<a class="ae kf" href="https://goo.gl/4ofytp" rel="noopener ugc nofollow" target="_blank">请阅读我们的“关于”页面</a>，<a class="ae kf" href="http://bit.ly/HackernoonFB" rel="noopener ugc nofollow" target="_blank">在脸书上点赞/给我们发消息</a>，或者简单地说，<a class="ae kf" href="https://goo.gl/k7XYbx" rel="noopener ugc nofollow" target="_blank"> tweet/DM @HackerNoon。</a></p><p id="708a" class="ir is kj it b iu iv iw ix iy iz ja jb kk jd je jf kl jh ji jj km jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kf" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kf" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote></div></div>    
</body>
</html>