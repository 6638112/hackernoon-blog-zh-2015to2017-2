<html>
<head>
<title>Steam chat message crash explained.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">蒸汽聊天消息崩溃解释。</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/steam-chat-message-crash-explained-3c7562abfaeb?source=collection_archive---------2-----------------------#2017-04-18">https://medium.com/hackernoon/steam-chat-message-crash-explained-3c7562abfaeb?source=collection_archive---------2-----------------------#2017-04-18</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="c8dd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">大约一天前，有人在/r/Steam上发布了一条消息，这条消息在通过Steam的聊天工具发送时，会导致收件人的客户端崩溃。</p><figure class="jp jq jr js fq jt"><div class="bz el l di"><div class="ju jv l"/></div></figure><p id="92f5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该漏洞已被修补，所以现在可以安全地深入研究这个漏洞是如何工作的。</p><p id="3baf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">崩溃消息及其变体大量使用了<a class="ae jw" href="http://unicode.org/faq/char_combmark.html" rel="noopener ugc nofollow" target="_blank"> unicode组合字符</a>，并且长度非常长。该消息在外观上与<a class="ae jw" href="http://stackoverflow.com/questions/6579844/how-does-zalgo-text-work" rel="noopener ugc nofollow" target="_blank"> Zalgo文本</a>相似，它导致崩溃的能力很可能是在试图制作令人讨厌的东西时被意外发现的。</p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div class="fe ff jx"><img src="../Images/732aa7608f9d6623dbd77085c7ce54b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*cPmBoqlVo2BDvo1PiKJUOg.png"/></div><figcaption class="ka kb fg fe ff kc kd bd b be z ek">The variation of the crash message I analyzed.</figcaption></figure><p id="8665" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了弄清楚这个可怕的文本中包含了什么，我写了一个极其简单的脚本:</p><figure class="jp jq jr js fq jt"><div class="bz el l di"><div class="ke jv l"/></div></figure><p id="6a99" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当提供崩溃文本时，该脚本的输出如下:</p><pre class="jp jq jr js fq kf kg kh ki aw kj dt"><span id="549c" class="kk kl hu kg b fv km kn l ko kp">&gt; python3 analyze.py</span><span id="416a" class="kk kl hu kg b fv kq kn l ko kp">Length of message in bytes: 5135</span><span id="c9ac" class="kk kl hu kg b fv kq kn l ko kp">Number of characters in message: 2044</span><span id="3b47" class="kk kl hu kg b fv kq kn l ko kp">LATIN SMALL LETTER M</span><span id="f8b2" class="kk kl hu kg b fv kq kn l ko kp">LATIN SMALL LETTER E</span><span id="48d0" class="kk kl hu kg b fv kq kn l ko kp">LATIN SMALL LETTER O</span><span id="a5fa" class="kk kl hu kg b fv kq kn l ko kp">LATIN SMALL LETTER W</span><span id="7af0" class="kk kl hu kg b fv kq kn l ko kp">Number of latin characters: 4</span><span id="76d0" class="kk kl hu kg b fv kq kn l ko kp">Number of combining characters: 2040</span></pre><p id="4eca" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该消息由2044个unicode字符组成。然而，这些字符中有许多是多字节的组合标记，所以消息的总长度为5135字节。<br/>这条信息有一个绝对疯狂的拉丁文对组合字符的比率。这条信息只有四个拉丁字母拼成“喵”这个词。然而，堆叠在这些字母之上的是一个巨大的2040个组合字符。这解释了为什么这串文本会使任何文本呈现器陷入困境。复制粘贴到<a class="ae jw" href="https://hackernoon.com/tagged/chrome" rel="noopener ugc nofollow" target="_blank"> Chrome </a>、记事本或任何你可以输入文本的地方，这会产生明显的延迟，因为渲染器必须在如此小的空间内绘制如此多的组合符号。但是他们从来没有<em class="kr">崩溃过</em>。唯一一个因显示这条消息而完全崩溃的软件是Steam。为什么？</p><p id="5cb4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最初，我假设崩溃是由于Steam消息客户端的2048个字符的限制。该消息占用5k字节，而仅使用2k个字符，因此它适合于单个Steam消息中。也许Steam只为每条聊天消息分配了2KB？从Steam Web客户端(没有2k字符限制)向我的桌面客户端发送一些消息证明了这个理论是错误的。Steam可以正确地接收超长的Unicode消息而不会崩溃。事实上,“喵”崩溃消息比许多无法使客户端崩溃的消息要短。</p><p id="1c45" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我被难住了，于是我给reddit上的Valve员工Henry G .发了消息，他回复了一个关于这个bug的精彩解释。非常非常感谢他花时间写了这么好的回复。</p><h1 id="0af9" class="ks kl hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">阀门的响应</h1><blockquote class="lp lq lr"><p id="c789" class="ir is kr it b iu iv iw ix iy iz ja jb ls jd je jf lt jh ji jj lu jl jm jn jo hn dt translated">这实际上是一个奇怪而古老的bug，并不特定于大小或长度。它可以追溯到一些我们已经忘记的非常古老的代码。</p><p id="0631" class="ir is kr it b iu iv iw ix iy iz ja jb ls jd je jf lt jh ji jj lu jl jm jn jo hn dt translated">回到Windows 98时代，Arial字体不支持很多Unicode字符，但Tahoma字体(这是全新的)支持。回到大约12年前，在Valve工作的人在我们的低级字体渲染中添加了一点逻辑，将某些Unicode字符从Arial切换到Tahoma，然后再切换回来。</p><p id="dfde" class="ir is kr it b iu iv iw ix iy iz ja jb ls jd je jf lt jh ji jj lu jl jm jn jo hn dt translated">为了执行字体切换，他们让我们的“DrawText”例程递归。它会一直绘制文本，直到切换，然后用不同的字体名称再次调用剩余的字符。</p><p id="0a5e" class="ir is kr it b iu iv iw ix iy iz ja jb ls jd je jf lt jh ji jj lu jl jm jn jo hn dt translated">在这个漏洞利用消息中最终发生的事情(我不认为提出这个消息的人实际上发现了这一点)是，许多相邻的字符从Arial范围交替进入Tahoma范围，然后返回。因为每一次字体切换都是一次递归函数调用，所以我们最终进行了超过一千层的递归函数调用。最终程序耗尽了堆栈空间，不能再递归调用自己，并崩溃。</p><p id="02ee" class="ir is kr it b iu iv iw ix iy iz ja jb ls jd je jf lt jh ji jj lu jl jm jn jo hn dt translated">这对我们来说是一个很大的惊喜，因为我们已经很多年没有查看字体渲染代码了，我们不知道其中有这个递归函数调用，有人只是为了修复Windows 98字体中的一个错误而添加的！</p><p id="0677" class="ir is kr it b iu iv iw ix iy iz ja jb ls jd je jf lt jh ji jj lu jl jm jn jo hn dt translated">当然，这完全是荒谬的。一旦我们发现了崩溃的递归代码，我们就删除它。微软在Windows ME / Windows 2000前后推出了更好的字体。自从我们停止支持Windows 98以来，已经有十多年没有任何理由做这种奇怪的拆分字体的事情了。</p><p id="432d" class="ir is kr it b iu iv iw ix iy iz ja jb ls jd je jf lt jh ji jj lu jl jm jn jo hn dt translated">自从Steam最初发布以来，这个聊天崩溃可能在任何时候发生。但是据我们所知，直到现在还没有人发现它！最近粘贴看起来很奇怪的Unicode文本的趋势恰好是偶然引发的。</p></blockquote><p id="7371" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，崩溃是由一个老式的堆栈溢出引起的！然而，我仍然很好奇为什么Steam桌面客户端将PC上的聊天消息长度限制为2048个字符，所以我也向Henry询问了这个问题。他回答如下:</p><blockquote class="lp lq lr"><p id="d3e7" class="ir is kr it b iu iv iw ix iy iz ja jb ls jd je jf lt jh ji jj lu jl jm jn jo hn dt translated">我不认为我们有一个很好的字符限制的理由，除了我们的文本输入代码和Win98字体代码一样古老，并且是用一堆任意的限制编写的，因为这是原作者的做法。自从我在Valve工作(六年)以来，文本输入代码就一直存在，我希望今年我们最终扣动扳机，删除所有这些代码。有传言说，一个主要的客户端UI重写，如果真的发生了，它将发生在一个新的基于网络的框架，不使用旧的遗留代码…或者我希望如此。</p><p id="ac8d" class="ir is kr it b iu iv iw ix iy iz ja jb ls jd je jf lt jh ji jj lu jl jm jn jo hn dt translated">IIRC，我们确实执行了16kb的服务器端字节限制，主要是为了避免单个用户耗尽我们所有的服务器内存。</p></blockquote><p id="4629" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最终，这个奇怪的崩溃是由被遗忘的遗留代码引起的。再次感谢Henry G .解释了这个bug的内部工作原理。</p><div class="jp jq jr js fq ab cb"><figure class="lv jt lw lx ly lz ma paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="lv jt lw lx ly lz ma paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="lv jt lw lx ly lz ma paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="lp lq lr"><p id="f922" class="ir is kr it b iu iv iw ix iy iz ja jb ls jd je jf lt jh ji jj lu jl jm jn jo hn dt translated"><a class="ae jw" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jw" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jw" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae jw" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is kr it b iu iv iw ix iy iz ja jb ls jd je jf lt jh ji jj lu jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jw" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jw" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jp jq jr js fq jt fe ff paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="fe ff mb"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="jp jq jr js fq jt"><div class="bz el l di"><div class="mg jv l"/></div></figure></div></div>    
</body>
</html>