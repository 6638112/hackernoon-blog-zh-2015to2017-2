<html>
<head>
<title>SSH key rotation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SSH密钥旋转</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/ssh-key-rotation-b0877fbd75c2?source=collection_archive---------7-----------------------#2017-08-19">https://medium.com/hackernoon/ssh-key-rotation-b0877fbd75c2?source=collection_archive---------7-----------------------#2017-08-19</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="fc14" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">SSH密钥轮换！更多周六早晨的乐趣。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/89d345160ed159421a1fd3d2611b29a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dVCvC7XuuYzkxdUPkom4rA.png"/></div></div></figure><p id="b01e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在某些圈子里，ssh密钥轮换是可怕的，被认为是一个巨大的难题。在安全圈里，缺乏密钥轮换是一个成熟的目标来妥协和破解所有的东西。</p><p id="d1db" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们如何解决这个问题？你可以写一个bash脚本，遍历一系列主机，然后对每个主机执行`<em class="kb"> ssh-copy-id` </em>,但是这不会使旧的密钥失效，它只是添加新的密钥。只解决了问题的一半。尽管如此，对于解决方案的初始设置来说，这个命令还是很不错的。</p><blockquote class="kc kd ke"><p id="8eaf" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">ssh-copy-id -i ~/。ssh/mykey user @ host<br/>【https://www.ssh.com/ssh/copy-id T4】</p></blockquote><p id="1ded" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">解决方案:Ansible并不是什么新东西，它已经存在了一段时间，但是令人惊讶的是没有人使用它。这里有一些关于http://docs.ansible.com/的信息。<br/>我们要重点介绍的功能是authorized_key模块<a class="ae ki" href="http://docs.ansible.com/ansible/latest/authorized_key_module.html" rel="noopener ugc nofollow" target="_blank">http://docs . ansi ble . com/ansi ble/latest/authorized _ key _ module . html</a></p><p id="479e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">实验室设置:</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff kj"><img src="../Images/e3f286c4c335b0a3047bc82846b1a929.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nCe8-xMiumKOlQ-kYNtuIA.png"/></div></div></figure><p id="1ca7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">需要的是，SSH密钥已经在您要更改的每台主机上设置好了。<br/> Ansible运行在您的笔记本电脑上，这就是我们将要进行ssh的地方。<br/>具有共享ssh密钥的主机的清单。对于我的实验室，我使用了一堆物理的树莓pi，因为我喜欢它们，它让我感觉自己像一个小小的疯狂科学家，在我的桌子上运行着一个迷你pi集群。有些日子我宁愿有一个贝奥武夫集群的机器运行，但嘿，你得凑合。</p><p id="0383" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae ki" href="https://www.youtube.com/watch?v=8LsxmQV8AXk" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=8LsxmQV8AXk</a>:切换到linux</p><p id="ff07" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是一个库存示例——非常简单</p><blockquote class="kc kd ke"><p id="3c75" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">[pi] <br/> 192.168.1.6用户=pi <br/> 192.168.1.7用户=pi <br/> 192.168.1.8用户=pi <br/> 192.168.1.9用户=pi</p></blockquote><p id="8650" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Ansible将在一个不同于我的主键的位置生成一个新的ssh密钥，因为现在我只是把它拿出来，不想破坏所有的东西。一旦我们离开实验室阶段，使用您的中心位置就很容易了。未来的实现将有一个KMS，这样我就可以安全地存储所有的密钥，但现在让我们不安全地这样做，我们可以稍后讨论最佳实践。跳马:【https://www.vaultproject.io/docs/secrets/ssh/index.html】T21</p><p id="e642" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">太好了，我们在每台主机上都有清单和ssh密钥。让我们向我们的主机问好，确保实验室已配置好</p><p id="4538" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kb">ansi ble pi-a "/bin/echo hello world "-I hosts-u pi—private-key = " ~/。ssh/id_rsa </em></p><blockquote class="kc kd ke"><p id="0a7e" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">192.168.1.6 |成功| RC = 0 &gt; &gt;<br/>hello world<br/>92.168.1.7 |成功| RC = 0&gt;&gt;<br/>hello world<br/>92.168.1.8 |成功| RC = 0&gt;&gt;<br/>hello world<br/>92.168.1.9 |成功| rc=0 &gt; &gt; <br/> hello world</p></blockquote><p id="27fa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">太好了，接下来让我们改变密钥，希望不要破坏一切。我们将创建一个可行的行动手册，其中包含一些任务。第一个任务是在我们的新位置本地生成一个新的ssh-key。</p><blockquote class="kc kd ke"><p id="31d2" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">名称:“为根用户设置授权密钥”<br/>主机:pi <br/>用户:pi</p><p id="1b70" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">任务:<br/> —名称:创建新的ssh密钥对<br/> local_action:命令ssh-keygen-t RSA-N " "-q-f ~/test/id _ RSA</p></blockquote><p id="5f87" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，我们将有一个任务，使用一个独占属性获取新的密钥文件并将其推送到主机。独占属性很重要，因为没有它，我们可以保留旧的密钥。如果我们想要部署多个键，我们可以执行多个步骤，第一步是独占推送，然后在没有独占设置的情况下添加我们的键。</p><blockquote class="kc kd ke"><p id="0add" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">— name:为pi用户设置authorized _ keys<br/>authorized _ key:user = pi key = " { { item } } " state = present exclusive = yes<br/>with _ file:<br/>—~/test/id _ RSA . pub</p></blockquote><p id="7e17" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，我们有两个步骤来移动新生成的密钥到我们的超级秘密档案，我还没有解决这个问题，但清理是需要的。目前它正试图运行多次，这是一个错误。</p><blockquote class="kc kd ke"><p id="5252" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">- name:移动密钥对<br/>local _ action:command mv ~/test/id _ RSA ~/test/id _ RSA . bak<br/>run _ once:true</p><p id="4715" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">— name:移动密钥对<br/>local _ action:command mv ~/test/id _ RSA . pub ~/test/id _ RSA . pub . bak<br/>run _ once:true</p></blockquote><p id="901c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">综合起来我们得到了。<br/>我意识到这种格式很糟糕，所以这里有一个要点:<a class="ae ki" href="https://gist.github.com/ridingintraffic/a89b8a27cb6b9148c5bf7f9dd4294c35" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/ridingintraft/a 89 b 8 a 27 CB 6b 9148 C5 BF 7 f 9 DD 4294 c 35</a></p><blockquote class="kc kd ke"><p id="6678" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">- name:"为root用户设置授权密钥"<br/> hosts: pi <br/> user: pi</p><p id="7eee" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">任务:<br/> —名称:创建新的ssh密钥对<br/> local_action:命令ssh-keygen-t RSA-N " "-q-f ~/test/id _ RSA<br/><br/><br/>—名称:为pi用户设置authorized _ keys<br/>authorized _ key:user = pi key = " { { item } } " state = present exclusive = yes<br/>with _ file:<br/>—~/test/id _ RSA . pub</p><p id="0945" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">- name:移动密钥对<br/>local _ action:command mv ~/test/id _ RSA ~/test/id _ RSA . bak<br/>run _ once:true</p><p id="ce20" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">- name:移动密钥对<br/>local _ action:command mv ~/test/id _ RSA . pub ~/test/id _ RSA . pub . bak<br/>run _ once:true</p></blockquote><p id="372a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们点燃它，换一些钥匙！</p><blockquote class="kc kd ke"><p id="16e3" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">$ ansi ble-playbook-I hosts playbook/ssh-key-push-revoke-old . yml</p><p id="7bee" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">播放[为根用户设置授权密钥]* * * * * * * * * * * * * * * * * * * * * * * * * * * * * *</p><p id="9794" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">任务[设置]* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *<br/>ok:[192 . 168 . 1 . 9]</p><p id="2473" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">任务[创建新的ssh密钥对]* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *<br/>已更改:[192.168.1.9 - &gt; localhost]</p><p id="4656" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">任务[为pi用户设置授权密钥]* * * * * * * * * * * * * * * * * * * * * * * * * * * * *<br/>已更改:[192 . 168 . 1 . 9]=&gt;(item = ssh-RSA xxxxx XXX @ XXX)</p><p id="39ec" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">任务[移动密钥对]* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *<br/>变更:[192.168.1.9 - &gt;本地主机]</p><p id="572b" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">任务【移动密钥对】* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *<br/>变更:【192 . 168 . 1 . 9-&gt;localhost】<br/>重试，使用:—limit<a class="ae ki" href="http://twitter.com/playbook/ssh-key-push-revoke-old" rel="noopener ugc nofollow" target="_blank">@ playbook/ssh-key-push-revoke-old</a>。重试</p><p id="afd9" class="ir is kb it b iu iv iw ix iy iz ja jb kf jd je jf kg jh ji jj kh jl jm jn jo hn dt translated">播放摘要* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *<br/>192 . 168 . 1 . 9:ok = 1 changed = 1 unreachable = 0 failed = 0</p></blockquote><p id="9305" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">成功了！我们更换了钥匙，比一小时前更安全了！！！</p><p id="acb8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我在此过程中使用了大量的链接，所以我将在这里一一列出:<br/><a class="ae ki" href="https://derpops.bike/2014/06/07/ssh-key-rotation-with-ansible/" rel="noopener ugc nofollow" target="_blank">https://der pops . bike/2014/06/07/ssh-key-rotation-with-ansi ble/</a><br/><a class="ae ki" href="http://vicendominguez.blogspot.kr/2014/05/ansible-generating-pub-key-file-and.html" rel="noopener ugc nofollow" target="_blank">http://vicendominguez . blogspot . kr/2014/05/ansi ble-generating-pub-key-file-and . html</a></p><p id="7364" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">ansi ble docs:<br/><a class="ae ki" href="http://docs.ansible.com/ansible/latest/playbooks_intro.html" rel="noopener ugc nofollow" target="_blank">http://docs.ansible.com/ansible/latest/playbooks_intro.html</a><br/><a class="ae ki" href="http://docs.ansible.com/ansible/latest/authorized_key_module.html" rel="noopener ugc nofollow" target="_blank">http://docs . ansi ble . com/ansi ble/latest/authorized _ key _ module . html</a></p><p id="8c65" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">手动ssh-copy-id<br/>https://www.ssh.com/ssh/copy-id<a class="ae ki" href="https://www.ssh.com/ssh/copy-id" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>