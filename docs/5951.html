<html>
<head>
<title>Kubernetes Adventures on Azure — Part 2 (Windows Cluster and trick for scaling Pods)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure上的Kubernetes冒险—第2部分(Windows集群和扩展pod的技巧)</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/kubernetes-adventures-on-azure-part-2-windows-cluster-and-trick-for-scaling-pods-27e769edde15?source=collection_archive---------7-----------------------#2017-08-25">https://medium.com/hackernoon/kubernetes-adventures-on-azure-part-2-windows-cluster-and-trick-for-scaling-pods-27e769edde15?source=collection_archive---------7-----------------------#2017-08-25</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/d0a680168a3f63e7d447ef21fa0967a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ScCK5yhshi3xmEb_tHOzQQ.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Kubernetes Windows cluster on Azure</figcaption></figure><h1 id="0445" class="jg jh hu bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">Windows Kubernetes群集安装</h1><p id="1a1b" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">第三部分可在这里获得:<a class="ae lc" href="https://hackernoon.com/kubernetes-adventures-on-azure-part-3-acs-engine-hybrid-cluster-bc453c13b451" rel="noopener ugc nofollow" target="_blank">Kubernetes Azure上的冒险——第三部分(ACS引擎&amp;混合集群)</a></p><p id="a67e" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated">在本系列的第1部分中，我们已经看到了如何在Azure容器服务上创建一个Linux Kubernetes集群。</p><p id="885f" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated">今天，我将尝试创建一个Kubernetes集群，但是使用Windows而不是Linux作为节点。显然Master永远是Linux。</p><p id="e3cb" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated">这次我将一步一步地按照<a class="ae lc" href="https://docs.microsoft.com/en-us/azure/container-service/kubernetes/container-service-kubernetes-windows-walkthrough" rel="noopener ugc nofollow" target="_blank">部署Kubernetes cluster for Windows containers</a>，然后使用新创建的集群。</p><h2 id="48bb" class="li jh hu bd ji lj lk ll jm lm ln lo jq kp lp lq ju kt lr ls jy kx lt lu kc lv dt translated">创建Kubernetes Windows集群</h2><p id="912a" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">让我们从为这个测试创建一个资源组开始，这样我们可以轻松地将所有的云工件分组，并在最后删除所有的内容。ARM是微软Azure的重要补充。</p><ul class=""><li id="7f3a" class="lw lx hu kg b kh ld kl le kp ly kt lz kx ma lb mb mc md me dt translated">创建专用资源组:<code class="eh mf mg mh mi b">az group create --name myAcsWinTest --location westeurope</code></li><li id="c0d5" class="lw lx hu kg b kh mj kl mk kp ml kt mm kx mn lb mb mc md me dt translated">创建Kubernetes集群(这里我将使用在第1部分中创建的ssh密钥对):</li></ul><pre class="mo mp mq mr fq ms mi mt mu aw mv dt"><span id="a1ec" class="li jh hu mi b fv mw mx l my mz">az acs create --orchestrator-type=kubernetes \<br/>--resource-group <!-- -->myAcsWinTest<!-- --> \<br/>--name=myK8sCluster \<br/>--agent-count=2 \<br/>--ssh-key-value ~/acs/sshkeys/acsivan.pub \<br/>--windows --admin-username azureuser \<br/>--admin-password myTestPassword1</span></pre><ul class=""><li id="64ac" class="lw lx hu kg b kh ld kl le kp ly kt lz kx ma lb mb mc md me dt translated">连接到Kubernetes cluser: <code class="eh mf mg mh mi b">az acs kubernetes get-credentials --resource-group=myAcsWinTest --name=myK8sCluster --ssh-key-file ~/acs/sshkeys/acsivan</code></li><li id="df79" class="lw lx hu kg b kh mj kl mk kp ml kt mm kx mn lb mb mc md me dt translated">检查连接检索节点列表:<code class="eh mf mg mh mi b">kubectl get nodes</code></li></ul><pre class="mo mp mq mr fq ms mi mt mu aw mv dt"><span id="8b6f" class="li jh hu mi b fv mw mx l my mz">NAME                  STATUS AGE  VERSION<br/>fb7c1acs9000          Ready  19m  v1.6.6–9+8a67b481dfc2c6<br/>fb7c1acs9001          Ready  19m  v1.6.6–9+8a67b481dfc2c6<br/>k8s-master-fb7c1c12–0 Ready  19m  v1.6.6</span></pre><p id="38c7" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated">集群启动并运行！厉害！</p><p id="95fa" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated">在继续之前，打开<a class="ae lc" href="https://hackernoon.com/tagged/kubernetes" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>仪表板，使用浏览器检查集群中的情况。</p><ul class=""><li id="5db4" class="lw lx hu kg b kh ld kl le kp ly kt lz kx ma lb mb mc md me dt translated">连接到Kubernetes仪表板:</li><li id="6bba" class="lw lx hu kg b kh mj kl mk kp ml kt mm kx mn lb mb mc md me dt translated">打开一个指向<a class="ae lc" href="http://127.0.0.1:8001/ui" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8001/ui</a>的浏览器，让它保持打开，以便您可以在那里检查，稍后应用更改。</li></ul><h2 id="3087" class="li jh hu bd ji lj lk ll jm lm ln lo jq kp lp lq ju kt lr ls jy kx lt lu kc lv dt translated">玩Kubernetes Windows集群</h2><p id="a006" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">让我们从使用windowsservercore而不是nanocore的IIS的简单示例开始，如<a class="ae lc" href="https://hackernoon.com/tagged/microsoft" rel="noopener ugc nofollow" target="_blank">微软</a>文章所述。我将按照同样的步骤来介绍像pod这样的概念，以及一旦手动部署就暴露它的方法。<br/> <strong class="kg hv">注意</strong>:我认为这样不好，因为你最终得到了一个pod，一个服务，但是在它们之间没有控制器作为一个副本集或者一个管理它的部署。稍后我们将看到如何在不停机的情况下“修复”这个问题。</p><ul class=""><li id="3eeb" class="lw lx hu kg b kh ld kl le kp ly kt lz kx ma lb mb mc md me dt translated">部署IIS windowsservercore容器</li></ul><p id="c2d5" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated">使用以下内容创建iis.json:</p><pre class="mo mp mq mr fq ms mi mt mu aw mv dt"><span id="627a" class="li jh hu mi b fv mw mx l my mz">{<br/> "apiVersion": "v1",<br/> "kind": "Pod",<br/> "metadata": {<br/>   "name": "iis",<br/>   "labels": {<br/>     "app": "iis"<br/>   }<br/> },<br/> "spec": {<br/>   "containers": [<br/>     {<br/>       "name": "iis",<br/>       "image": "microsoft/iis",<br/>       "ports": [<br/>         {<br/>         "containerPort": 8000<br/>         }<br/>       ]<br/>     }<br/>   ],<br/>   "nodeSelector": {<br/>    "beta.kubernetes.io/os": "windows"<br/>    }<br/>  }<br/>}</span></pre><p id="e75f" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated">我们现在可以将配置应用到名为iis: <code class="eh mf mg mh mi b">kubectl apply -f iis.json</code>的新Pod</p><ul class=""><li id="220c" class="lw lx hu kg b kh ld kl le kp ly kt lz kx ma lb mb mc md me dt translated">检查运行Pod: <code class="eh mf mg mh mi b">kubectl get pods --watch</code>创建它大约需要10分钟，因为windowsservercore映像相当大~5GB。为了赢得时间，您可以现在就暴露这个pod，不需要在这个测试中等待pod的创建。负载平衡器创建将立即开始。</li><li id="724f" class="lw lx hu kg b kh mj kl mk kp ml kt mm kx mn lb mb mc md me dt translated">打开Pods部分的<a class="ae lc" href="http://127.0.0.1:8001/api/v1/namespaces/kube-system/services/kubernetes-dashboard/proxy/#!/pod?namespace=default" rel="noopener ugc nofollow" target="_blank"> Kubernetes仪表板</a>，您将看到如下内容:</li></ul><figure class="mo mp mq mr fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff na"><img src="../Images/cc578b537b63eae449c32abbe079658c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HOcFa3rcZ0LQCDHSvYQgdg.png"/></div></div></figure><ul class=""><li id="ca2a" class="lw lx hu kg b kh ld kl le kp ly kt lz kx ma lb mb mc md me dt translated">使用服务暴露Pod:<code class="eh mf mg mh mi b">kubectl expose pods iis --port=80 --type=LoadBalancer</code>(在以后的帖子中，我将在混合集群中尝试Ingress，让我们将Kubernetes推向极限！).</li><li id="ec84" class="lw lx hu kg b kh mj kl mk kp ml kt mm kx mn lb mb mc md me dt translated">使用<code class="eh mf mg mh mi b">kubectl get svc --watch</code>等待负载平衡器激活，或使用Kubernetes仪表板手动检查。</li></ul><p id="151f" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated">当您拥有IP时，您可以尝试在那里浏览，您应该会看到:</p><figure class="mo mp mq mr fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nb"><img src="../Images/1a2dea825516c5fee35328d03c8be428.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*onppEwjSEl5jBgzMz78Org.png"/></div></div></figure><h1 id="524b" class="jg jh hu bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">如果我有一个要扩展的pod，我会_________？</h1><p id="fb08" class="pw-post-body-paragraph ke kf hu kg b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb hn dt translated">现在，让我们尝试横向扩展我们的iis pod。等等…我们不能直接扩展一个舱。我们需要一个副本集或者一个部署。你会怎么处理这件事？</p><p id="4b2d" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated">在这里，我使用了我在研究中发现的一个技巧，让你在没有任何最终用户停机时间的情况下扩展你的pod<strong class="kg hv">。或许有更好的方法，如果有，请添加到评论中。</strong></p><figure class="mo mp mq mr fq iv fe ff paragraph-image"><div class="fe ff nc"><img src="../Images/5dc96583e5bf9ffedf69c429ea99f1a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:300/format:webp/1*9NSbabr8KPi-_25VyUzo8g.png"/></div></figure><blockquote class="nd ne nf"><p id="4db0" class="ke kf ng kg b kh ld kj kk kl le kn ko nh lf kr ks ni lg kv kw nj lh kz la lb hn dt translated">如果我们知道我们在做什么，那就不叫研究了，对吗？<br/> <strong class="kg hv">爱因斯坦</strong></p></blockquote><p id="0bcb" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated"><strong class="kg hv">需要简要说明</strong></p><ul class=""><li id="c2b5" class="lw lx hu kg b kh ld kl le kp ly kt lz kx ma lb mb mc md me dt translated">运行<code class="eh mf mg mh mi b">kubectl describe service iis</code>,你可以看到服务有一个等于“app=iis”的选择器。这意味着任何带有此标签的pod都将使用此负载平衡器公开</li></ul><pre class="mo mp mq mr fq ms mi mt mu aw mv dt"><span id="50b7" class="li jh hu mi b fv mw mx l my mz">Name: iis<br/>Namespace: default<br/>Labels: app=iis<br/>Annotations: &lt;none&gt;<br/><strong class="mi hv">Selector: app=iis</strong><br/>Type: LoadBalancer<br/>IP: 10.0.201.106<br/>LoadBalancer Ingress: 40.118.109.119<br/>...<br/>...</span></pre><p id="6743" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated">这里的想法是创建一个新的部署，它将使用相同的标签创建我们的iis pod的两个新副本。</p><ul class=""><li id="2031" class="lw lx hu kg b kh ld kl le kp ly kt lz kx ma lb mb mc md me dt translated">创建一个名为iisdeployment.yaml的文件，包含以下内容:</li></ul><pre class="mo mp mq mr fq ms mi mt mu aw mv dt"><span id="599a" class="li jh hu mi b fv mw mx l my mz">apiVersion: apps/v1beta1<br/>kind: Deployment<br/>metadata:<br/> name: iis<br/>spec:<br/> replicas: 2<br/> template:<br/>   metadata:<br/>     labels:<br/>       <strong class="mi hv">app: iis</strong><br/>   spec:<br/>     containers:<br/>     — name: iis<br/>       image: microsoft/iis<br/>       ports:<br/>       — containerPort: 80<br/>         name: iis<br/>     nodeSelector:<br/>       beta.kubernetes.io/os: windows</span></pre><ul class=""><li id="ae9f" class="lw lx hu kg b kh ld kl le kp ly kt lz kx ma lb mb mc md me dt translated">使用<code class="eh mf mg mh mi b">kubectl create -f iisdeployment.yaml</code>创建部署</li><li id="ff15" class="lw lx hu kg b kh mj kl mk kp ml kt mm kx mn lb mb mc md me dt translated">现在运行<code class="eh mf mg mh mi b">kubectl get pods</code>,你可以看到一个正在运行的pod和另外两个正在创建的pod:</li></ul><pre class="mo mp mq mr fq ms mi mt mu aw mv dt"><span id="8d4e" class="li jh hu mi b fv mw mx l my mz">NAME                 READY STATUS            RESTARTS AGE<br/>iis                  1/1   Running           0        32m<br/>iis-1894189856-bxjf5 0/1   ContainerCreating 0        6s<br/>iis-1894189856-zjw98 0/1   ContainerCreating 0        6s</span></pre><p id="c3f4" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated"><strong class="kg hv">注意</strong>:在这些步骤中，您可以使用浏览器检查您的服务，查看它是否正常运行。</p><ul class=""><li id="221e" class="lw lx hu kg b kh ld kl le kp ly kt lz kx ma lb mb mc md me dt translated">您现在可以删除原始pod，而不会给运行<code class="eh mf mg mh mi b">kubectl delete pods iis</code>的最终用户带来任何停机时间</li></ul><pre class="mo mp mq mr fq ms mi mt mu aw mv dt"><span id="1801" class="li jh hu mi b fv mw mx l my mz">NAME                 READY STATUS            RESTARTS AGE<br/><strong class="mi hv">iis                  1/1   Terminating       0        49m</strong><br/>iis-1894189856-bxjf5 1/1   Running           1        17m<br/>iis-1894189856-zjw98 1/1   Running           0        17m</span></pre><h2 id="c226" class="li jh hu bd ji lj lk ll jm lm ln lo jq kp lp lq ju kt lr ls jy kx lt lu kc lv dt translated">最多可扩展到4个副本！</h2><ul class=""><li id="f129" class="lw lx hu kg b kh ki kl km kp nk kt nl kx nm lb mb mc md me dt translated">这下好办了:<code class="eh mf mg mh mi b">kubectl scale deployments/iis replicas 4</code></li></ul><pre class="mo mp mq mr fq ms mi mt mu aw mv dt"><span id="b018" class="li jh hu mi b fv mw mx l my mz">NAME                 READY STATUS            RESTARTS AGE<br/><strong class="mi hv">iis-1894189856–9fwsp 0/1   ContainerCreating 0        52s</strong><br/>iis-1894189856-bxjf5 1/1   Running           1        17m<br/><strong class="mi hv">iis-1894189856-t3m26 0/1   ContainerCreating 0        52s</strong><br/>iis-1894189856-zjw98 1/1   Running           0        17m</span></pre><p id="285f" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated"><strong class="kg hv">如果我们有一个pod IIS-1894189856–9 fwsp的问题，我们希望将其与其他部分隔离，同时保持其运行以进行调试，该怎么办？</strong></p><ul class=""><li id="a541" class="lw lx hu kg b kh ld kl le kp ly kt lz kx ma lb mb mc md me dt translated">我这样跑:<code class="eh mf mg mh mi b">kubectl edit pods iis-1894189856-9fwsp</code></li><li id="2e0c" class="lw lx hu kg b kh mj kl mk kp ml kt mm kx mn lb mb mc md me dt translated">文件在预定义的编辑器中打开</li><li id="f301" class="lw lx hu kg b kh mj kl mk kp ml kt mm kx mn lb mb mc md me dt translated">将标签部分从:</li></ul><pre class="mo mp mq mr fq ms mi mt mu aw mv dt"><span id="e20c" class="li jh hu mi b fv mw mx l my mz">labels:<br/>  app: iis<br/>  pod-template-hash: “1894189856”</span></pre><p id="bd39" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated">到以下内容并保存文件:</p><pre class="mo mp mq mr fq ms mi mt mu aw mv dt"><span id="b8bd" class="li jh hu mi b fv mw mx l my mz">labels:<br/> app: iisdebug</span></pre><ul class=""><li id="4a41" class="lw lx hu kg b kh ld kl le kp ly kt lz kx ma lb mb mc md me dt translated">如果您现在获得了您的pod列表，您将会看到Kubernetes已经为iis部署创建了第四个控制器，并且您的pod仍然在那里运行。</li></ul><h2 id="d933" class="li jh hu bd ji lj lk ll jm lm ln lo jq kp lp lq ju kt lr ls jy kx lt lu kc lv dt translated">如何连接到正在运行的Windows Server核心容器？</h2><ul class=""><li id="7de9" class="lw lx hu kg b kh ki kl km kp nk kt nl kx nm lb mb mc md me dt translated"><strong class="kg hv">您现在可以调试这个容器，确保它没有对外公开，因为我们的iis服务使用app:iis作为选择器。</strong></li><li id="9226" class="lw lx hu kg b kh mj kl mk kp ml kt mm kx mn lb mb mc md me dt translated">使用<code class="eh mf mg mh mi b">kubectl exec -ti iis-1894189856-9fwsp powershell</code>连接到它</li></ul><figure class="mo mp mq mr fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nn"><img src="../Images/38e6758867666e4f96a64e05fb8c83d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8o5E63XD4EZhmX1tMdlllw.png"/></div></div></figure><ul class=""><li id="b7fd" class="lw lx hu kg b kh ld kl le kp ly kt lz kx ma lb mb mc md me dt translated">从您的计算机上，您现在可以在云中的运行映像中轻松运行任何PowerShell命令！</li><li id="252e" class="lw lx hu kg b kh mj kl mk kp ml kt mm kx mn lb mb mc md me dt translated">请记住，当您使用以下工具玩完群集后，请删除所有内容:</li></ul><pre class="mo mp mq mr fq ms mi mt mu aw mv dt"><span id="3089" class="li jh hu mi b fv mw mx l my mz">az group delete — name myAcsWinTest — yes — no-wait</span></pre><figure class="mo mp mq mr fq iv fe ff paragraph-image"><div class="fe ff no"><img src="../Images/59905ff3f30bdab1e028419ae4f46b18.png" data-original-src="https://miro.medium.com/v2/resize:fit:520/format:webp/1*QJ4wpHg8ZFSw8qZ-qBtkoA.jpeg"/></div></figure><p id="0aa8" class="pw-post-body-paragraph ke kf hu kg b kh ld kj kk kl le kn ko kp lf kr ks kt lg kv kw kx lh kz la lb hn dt translated">在第3部分中，我将尝试用Windows ad Linux节点创建一个混合集群！</p><figure class="mo mp mq mr fq iv"><div class="bz el l di"><div class="np nq l"/></div></figure></div></div>    
</body>
</html>