<html>
<head>
<title>Behind the magic of Phoenix LiveReload</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">凤凰城魅力的背后</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/behind-the-magic-of-phoenix-livereload-aa007995aa0f?source=collection_archive---------7-----------------------#2017-05-10">https://medium.com/hackernoon/behind-the-magic-of-phoenix-livereload-aa007995aa0f?source=collection_archive---------7-----------------------#2017-05-10</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="e97a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当您在代码编辑器中更新文件时，Phoenix的实时重新加载功能会立即刷新您的浏览器。这种体验非常简单，Phoenix代码也非常轻量级。</p><p id="3f63" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们一起穿越LiveReload的优雅魔力。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/011bef5194cb0a3462b7da3ed34954d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*REFEMpVoXdz2Zky8HSgVqQ.png"/></div></div></figure><h1 id="59ec" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated"><strong class="ak">如何将所需代码注入HTML？</strong></h1><p id="a27e" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">当您运行<code class="eh le lf lg lh b">mix phoenix.new</code>来生成Phoenix应用程序时，您将在<code class="eh le lf lg lh b">web/endpoint.ex:</code>中看到以下内容</p><pre class="jq jr js jt fq li lh lj lk aw ll dt"><span id="eb7a" class="lm kc hu lh b fv ln lo l lp lq">if code_reloading? do<br/>  socket "/phoenix/live_reload/socket", Phoenix.LiveReloader.Socket<br/>  plug Phoenix.LiveReloader<br/>  ...<br/>end</span></pre><p id="d167" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh le lf lg lh b">Phoenix.LiveReloader</code>负责注入触发实时重载所需的HTML位。这是一个模块插件:它通过实现<code class="eh le lf lg lh b">call/2</code>来转换连接。</p><p id="65f1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh le lf lg lh b">Phoenix.LiveReloader</code>实际上声明了两个<code class="eh le lf lg lh b">call/2</code>函数:</p><ol class=""><li id="cf26" class="lr ls hu it b iu iv iy iz jc lt jg lu jk lv jo lw lx ly lz dt translated"><strong class="it hv">有一个通用的函数定义(</strong> <a class="ae ma" href="https://github.com/phoenixframework/phoenix_live_reload/blob/master/lib/phoenix_live_reload/live_reloader.ex" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">来源</strong> </a> <strong class="it hv"> ): </strong></li></ol><pre class="jq jr js jt fq li lh lj lk aw ll dt"><span id="8a4c" class="lm kc hu lh b fv ln lo l lp lq">def call(conn, _) do</span></pre><p id="5540" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将在HTML中注入一个iframe来加载“/phoenix/live_reload_iframe”。</p><p id="f057" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> 2。另一个</strong> <code class="eh le lf lg lh b"><strong class="it hv">call/2</strong></code> <strong class="it hv">函数定义根据请求路径通过模式匹配加载iframe内容(</strong> <a class="ae ma" href="https://github.com/phoenixframework/phoenix_live_reload/blob/master/lib/phoenix_live_reload/live_reloader.ex#L63" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">源</strong> </a> <strong class="it hv"> ): </strong></p><pre class="jq jr js jt fq li lh lj lk aw ll dt"><span id="8b04" class="lm kc hu lh b fv ln lo l lp lq">def call(%Plug.Conn{path_info: ["phoenix", "live_reload", "frame"]} = conn , _) do</span></pre><p id="e32e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将返回注入客户端Javascript以连接到<code class="eh le lf lg lh b">Phoenix.LiveReloader.Socket</code>的HTML。</p><h1 id="ca63" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">如何观察对文件的更改？</h1><p id="47d2" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">Erlang包用于监听文件的变化。当iframe中的javascript加入通道时，<code class="eh le lf lg lh b">LiveReloader</code>开始订阅文件系统变更(<a class="ae ma" href="https://github.com/phoenixframework/phoenix_live_reload/blob/master/lib/phoenix_live_reload/channel.ex#L12" rel="noopener ugc nofollow" target="_blank"> source </a>)。</p><h1 id="92ba" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">观察哪些文件？</h1><p id="5608" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">默认情况下，您的静态资产(javascript、css等)以及web视图和模板。</p><blockquote class="mb mc md"><p id="e656" class="ir is me it b iu iv iw ix iy iz ja jb mf jd je jf mg jh ji jj mh jl jm jn jo hn dt translated">有没有部署凤凰app？试试Scout，这是我帮助开发的一个新的Elixir应用程序监控解决方案。<a class="ae ma" href="https://scoutapp.com/info/pricing" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">报名免费</strong> </a>。</p></blockquote><h1 id="c0a8" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">LiveReload如何监听变化？</h1><p id="df3b" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">调用<code class="eh le lf lg lh b">:fs.subscribe/0</code>后，通道进程通过定义<code class="eh le lf lg lh b">handle_info/</code> ( <a class="ae ma" href="https://github.com/phoenixframework/phoenix_live_reload/blob/master/lib/phoenix_live_reload/channel.ex#L17" rel="noopener ugc nofollow" target="_blank">源</a>)监听<code class="eh le lf lg lh b">fs</code>消息事件:</p><pre class="jq jr js jt fq li lh lj lk aw ll dt"><span id="4966" class="lm kc hu lh b fv ln lo l lp lq">def handle_info({_pid, {:fs, :file_event}, {path, _event}}, socket) do</span></pre><p id="8831" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将接收文件系统上的所有文件事件。因为我们只关心一个子集，<code class="eh le lf lg lh b">matches_any_pattern?/2</code>检查文件是否在我们的Phoenix应用程序中。</p><p id="3cc8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，我们通过信道发送消息通知这一变化:</p><pre class="jq jr js jt fq li lh lj lk aw ll dt"><span id="127c" class="lm kc hu lh b fv ln lo l lp lq">push socket, "assets_change", %{asset_type: asset_type}</span></pre><h1 id="bf9f" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">Javascript代码如何刷新页面？</h1><p id="c2ad" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">JS监听<code class="eh le lf lg lh b">assets_change</code>事件，并以两种方式之一更新窗口:</p><ol class=""><li id="1d10" class="lr ls hu it b iu iv iy iz jc lt jg lu jk lv jo lw lx ly lz dt translated">当一个css文件改变时，不需要完全重新加载。相反，在加载更新样式表的页面中插入一个新的link元素。</li><li id="129d" class="lr ls hu it b iu mi iy mj jc mk jg ml jk mm jo lw lx ly lz dt translated">当任何其他类型的文件发生更改时，将触发全窗口重新加载。</li></ol><h1 id="566b" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">摘要</h1><p id="8c8f" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">LiveReload在你的应用中编织了一条有趣的路径:插入一个插件将内容注入HTML，呈现一个iframe，将Javascript插入iframe并订阅一个通道，监听文件系统事件，通过通道发送相关事件的消息，最后，重新加载你的浏览器窗口。</p><p id="1b43" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae ma" href="https://github.com/phoenixframework/phoenix_live_reload" rel="noopener ugc nofollow" target="_blank">在GitHub </a>上查看源码。</p><div class="jq jr js jt fq ab cb"><figure class="mn ju mo mp mq mr ms paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mn ju mo mp mq mr ms paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mn ju mo mp mq mr ms paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mb mc md"><p id="f922" class="ir is me it b iu iv iw ix iy iz ja jb mf jd je jf mg jh ji jj mh jl jm jn jo hn dt translated"><a class="ae ma" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是阿妹家庭的一员。我们现在<a class="ae ma" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ma" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is me it b iu iv iw ix iy iz ja jb mf jd je jf mg jh ji jj mh jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ma" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ma" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff mt"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>