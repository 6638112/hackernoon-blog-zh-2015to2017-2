<html>
<head>
<title>Await is the new black</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">等待是新的黑色</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/await-is-the-new-black-e47217f96f06?source=collection_archive---------1-----------------------#2016-12-07">https://medium.com/hackernoon/await-is-the-new-black-e47217f96f06?source=collection_archive---------1-----------------------#2016-12-07</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/bf44366032ccec9575c9536de2e30252.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/1*XlpvbC9ntipm_Y52zMtTFA.gif"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">This guy uses await. Look how happy he is.</figcaption></figure><p id="41d9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你知道es7的新功能有多棒吗？表演时间到了。</p><h2 id="d580" class="kf kg hu bd kh ki kj kk kl km kn ko kp jn kq kr ks jr kt ku kv jv kw kx ky kz dt translated">1.开始的时候，有回调</h2><p id="9de7" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">想象一下，你被告知要订购一个亚马逊包裹，然后去邮局拿，然后回家打开它。</p><p id="30eb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">简单的说明。你猜怎么着，大多数人不会花3天时间在邮局前等待他们的包裹到达。除了你可能会挨饿的事实之外，这看起来不像是一种组织工作流程的非常有效的方式。类似于等待amazon包，web开发主要是发送服务器/数据库/服务请求，然后等待它返回，并对数据做一些事情。因此，使用能够处理并发性的语言是很自然的。</p><p id="e847" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">回调是处理并发性的一种方式。节点用户熟悉这样的代码</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">Looks familiar to you, but many beginners will scratch their heads before understanding what’s going on here.</figcaption></figure><p id="7706" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它基本上告诉从某个数据库获取一个用户，同时传递两个参数:</p><ul class=""><li id="e565" class="ll lm hu je b jf jg jj jk jn ln jr lo jv lp jz lq lr ls lt dt translated"><code class="eh ka kb kc kd b">userId</code>、<em class="lu">又名</em>你的查询</li><li id="1988" class="ll lm hu je b jf lv jj lw jn lx jr ly jv lz jz lq lr ls lt dt translated">回调函数<code class="eh ka kb kc kd b">(err, user) =&gt; {...}</code>解释当查询结果到达时做什么<em class="lu">。</em>作为一个节点约定，第一个回调参数是一个错误消息，您希望它只是<code class="eh ka kb kc kd b">null</code></li></ul><p id="ab94" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它可以工作，但是在某种程度上，处理所有的错误处理变得很乏味，您可能会以一些不可理解的、深度嵌套的代码而告终。许多人把这种情况称为回调地狱。我不太确定这是不是地狱，但在我看来肯定很无聊。</p><h2 id="8537" class="kf kg hu bd kh ki kj kk kl km kn ko kp jn kq kr ks jr kt ku kv jv kw kx ky kz dt translated">2.输入承诺</h2><p id="d899" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">承诺是最近的特性，它有助于链接异步任务，同时保持更好的可读性。我们的第一个例子是</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="dbc3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">哇，好多了！</p><p id="3286" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但是如果我想同时使用<code class="eh ka kb kc kd b">user</code>和<code class="eh ka kb kc kd b">result</code>作为另一个函数的参数呢？这将把我们的代码变成</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">I skipped the error catching on this example. How would you do it ?</figcaption></figure><p id="d8f0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们又回到了多重嵌套层次。好难过:(</p><p id="526e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">承诺是一件伟大的事情，它们极大地提高了代码的可读性。然而，它们并没有解决我们所有的问题，嵌套/错误捕捉仍然存在，尽管它肯定比回调好。</p><p id="49a8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv"> <em class="lu">编辑:</em> </strong> <em class="lu">聪明的人指出，用承诺来解决例子2的一种更诚实/优雅的方式可以是:</em></p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="ccd1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">确实比我原来的解决方案要好:)</p><h2 id="6b58" class="kf kg hu bd kh ki kj kk kl km kn ko kp jn kq kr ks jr kt ku kv jv kw kx ky kz dt translated">3.输入Await</h2><figure class="lf lg lh li fq iv fe ff paragraph-image"><div class="fe ff ma"><img src="../Images/9239a8f516f73e153ca3e0036bfaeba6.png" data-original-src="https://miro.medium.com/v2/resize:fit:740/1*gyYNiqjVDMBxqxKU0_6sEg.gif"/></div></figure><p id="3642" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">做好准备，ES7来了。目前<code class="eh ka kb kc kd b">async/await</code>仍然是一个提议，所以下面可能会有(我希望是微小的)变化。</p><p id="0bc9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要使用ES7功能，要么<a class="ae ke" href="http://jamesknelson.com/using-es6-in-the-browser-with-babel-6-and-webpack/" rel="noopener ugc nofollow" target="_blank">设置babel </a>，要么使用<a class="ae ke" href="https://www.typescriptlang.org/" rel="noopener ugc nofollow" target="_blank"> typescript </a>(或者其他我没想到要提的东西)。至于今天，TS团队选择发布一个<code class="eh ka kb kc kd b">await/async</code>功能，它与ES7具有相同的规格。请注意，这可能有一天会改变，虽然我们不希望如此。</p><p id="97e7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先，让我们更新我们的例子:</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">Double rainbow !</figcaption></figure><p id="2a3d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">以下是一些需要注意的事项:</p><ul class=""><li id="6b35" class="ll lm hu je b jf jg jj jk jn ln jr lo jv lp jz lq lr ls lt dt translated">该函数被声明为<code class="eh ka kb kc kd b">async</code>，所以我们可以在函数内部使用<code class="eh ka kb kc kd b">await</code></li><li id="5483" class="ll lm hu je b jf lv jj lw jn lx jr ly jv lz jz lq lr ls lt dt translated"><code class="eh ka kb kc kd b">const user = await User.findById(userId)</code>将像在同步世界中开发一样工作。虽然它不会阻塞线程(所以它实际上是异步的)，但它允许开发人员真正表达他/她在想什么:做一些事情，命名结果，并在以后使用它们。</li><li id="c770" class="ll lm hu je b jf lv jj lw jn lx jr ly jv lz jz lq lr ls lt dt translated"><code class="eh ka kb kc kd b">try/catch</code>回好ol’进行错误处理</li></ul><h1 id="d6e7" class="mb kg hu bd kh mc md me kl mf mg mh kp mi mj mk ks ml mm mn kv mo mp mq ky mr dt translated">我们可以用await/async做的很酷的事情的例子</h1><p id="b559" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated"><strong class="je hv">承诺</strong></p><p id="07d9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">异步函数总是返回一个承诺。您甚至可以用它来“许诺”一个常规函数:</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="8131" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">注意将函数声明为<code class="eh ka kb kc kd b">async</code>是如何将<code class="eh ka kb kc kd b">return i +1</code>(一个数字)变成了<code class="eh ka kb kc kd b">Promise&lt;number&gt;</code></p><h2 id="3413" class="kf kg hu bd kh ki kj kk kl km kn ko kp jn kq kr ks jr kt ku kv jv kw kx ky kz dt translated">扔</h2><p id="dd68" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">A <code class="eh ka kb kc kd b">throw</code>将返回一个错误拒绝的承诺:</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><ul class=""><li id="dbd1" class="ll lm hu je b jf jg jj jk jn ln jr lo jv lp jz lq lr ls lt dt translated">再举个例子？</li></ul><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">return a promise that either resolves to null, or a user, or reject with ‘User not found’</figcaption></figure><h2 id="7d46" class="kf kg hu bd kh ki kj kk kl km kn ko kp jn kq kr ks jr kt ku kv jv kw kx ky kz dt translated">睡眠</h2><p id="20e9" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">实现<code class="eh ka kb kc kd b">sleep</code>功能:</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">*__*</figcaption></figure><h2 id="5425" class="kf kg hu bd kh ki kj kk kl km kn ko kp jn kq kr ks jr kt ku kv jv kw kx ky kz dt translated">Node.js测试示例</h2><p id="387b" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">我们来看看编写测试的三种方法怎么样？</p><p id="19bd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这个测试统计用户的数量，检查是否多于1个，然后获取一个，并检查它是否有一个<code class="eh ka kb kc kd b">email</code>字段。</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek">BOOM, two-liner !</figcaption></figure><p id="1d28" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你觉得哪个更好看？</p><h2 id="eb0c" class="kf kg hu bd kh ki kj kk kl km kn ko kp jn kq kr ks jr kt ku kv jv kw kx ky kz dt translated">协议:并行性</h2><p id="26cc" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated"><code class="eh ka kb kc kd b">await Promise.all(...)</code>将等待多个并行承诺解决:</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><h1 id="4585" class="mb kg hu bd kh mc md me kl mf mg mh kp mi mj mk ks ml mm mn kv mo mp mq ky mr dt translated">结论</h1><p id="b092" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">如果你还在这里，那么我很肯定你现在对这个非常奇特的<code class="eh ka kb kc kd b">async/await</code>功能有一个很好的想法。</p><p id="933b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我希望你现在相信它有多棒。让我知道你的想法！</p><div class="lf lg lh li fq ab cb"><figure class="ms iv mt mu mv mw mx paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="ms iv mt mu mv mw mx paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="ms iv mt mu mv mw mx paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="my mz na"><p id="f922" class="jc jd lu je b jf jg jh ji jj jk jl jm nb jo jp jq nc js jt ju nd jw jx jy jz hn dt translated"><a class="ae ke" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ke" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ke" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae ke" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jc jd lu je b jf jg jh ji jj jk jl jm nb jo jp jq nc js jt ju nd jw jx jy jz hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ke" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ke" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="fe ff ne"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="nj lk l"/></div></figure></div></div>    
</body>
</html>