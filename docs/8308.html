<html>
<head>
<title>Full-stack smart contract development</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">全栈智能合约开发</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/full-stack-smart-contract-development-fccdfe5176ce?source=collection_archive---------2-----------------------#2017-11-28">https://medium.com/hackernoon/full-stack-smart-contract-development-fccdfe5176ce?source=collection_archive---------2-----------------------#2017-11-28</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="eb51" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">编写、测试和部署以太坊智能合约及其web界面</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/ce3635d03fa10145496620e0d3596ac4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4GNg30Shnxd3JZysM75dFQ.jpeg"/></div></div></figure><p id="20c7" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这个周末，我和我的团队花了一些时间研究以太坊区块链特有的工具和部署，并做了一个小实验:<a class="ae kr" href="https://forever.lifeonmars.pt/" rel="noopener ugc nofollow" target="_blank">永远在链条上</a>。</p><p id="a3f2" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这相当于一个数字纹身:一个智能合同，任何人都可以免费使用(减去交易成本)，在以太坊区块链上留下永久的信息。这条信息被永远保存在区块链，铭刻在成千上万的电脑里，不可更改，不朽。</p><p id="e29e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">尽管持久性是区块链的核心概念之一，但这仍然让一些人担心，所以我也写了一篇关于该工具和区块链技术的一些含义的<a class="ae kr" href="https://hackernoon.com/forever-on-the-chain-c755838dfc79" rel="noopener ugc nofollow" target="_blank">非技术性文章。</a></p><p id="0904" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">接下来是智能合约教程。我将带您浏览这个工具的关键路径的创建和测试。</p><p id="d1fb" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这里假设你已经理解了一些以太坊的核心概念，比如智能合约、交易和gas。如果你不知道，这里有一个解释，让你开始。</p><div class="ks kt fm fo ku kv"><a rel="noopener follow" target="_blank" href="/@preethikasireddy/how-does-ethereum-work-anyway-22d1df506369"><div class="kw ab ej"><div class="kx ab ky cl cj kz"><h2 class="bd hv fv z el la eo ep lb er et ht dt translated">以太坊到底是怎么运作的？</h2><div class="lc l"><h3 class="bd b fv z el la eo ep lb er et ek translated">介绍</h3></div><div class="ld l"><p class="bd b gc z el la eo ep lb er et ek translated">medium.com</p></div></div><div class="le l"><div class="lf l lg lh li le lj jt kv"/></div></div></a></div><h1 id="ec19" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">智能合同</h1><p id="20e9" class="pw-post-body-paragraph jv jw hu jx b jy mc iv ka kb md iy kd ke me kg kh ki mf kk kl km mg ko kp kq hn dt translated">这份智能合同非常简单。它唯一的功能是将消息记录到区块链中。这是通过使用事件来实现的，如下所述。</p><h2 id="5e1b" class="mh ll hu bd lm mi mj mk lq ml mm mn lu ke mo mp lw ki mq mr ly km ms mt ma mu dt translated">代码走查</h2><p id="ea02" class="pw-post-body-paragraph jv jw hu jx b jy mc iv ka kb md iy kd ke me kg kh ki mf kk kl km mg ko kp kq hn dt translated">聪明的契约是写在实处的。这是一个静态类型语言，用来写以太坊智能合约。来自<a class="ae kr" href="http://solidity.readthedocs.io/en/develop/index.html" rel="noopener ugc nofollow" target="_blank">的文档</a>:</p><blockquote class="mv mw mx"><p id="8ecf" class="jv jw my jx b jy jz iv ka kb kc iy kd mz kf kg kh na kj kk kl nb kn ko kp kq hn dt translated">Solidity是一种面向契约的高级语言，其语法类似于JavaScript，旨在针对以太坊虚拟机(EVM)。</p></blockquote><p id="debf" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">下面是我们的契约的实现情况。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="e17b" class="mh ll hu nd b fv nh ni l nj nk">pragma solidity 0.4.24;</span><span id="5e27" class="mh ll hu nd b fv nl ni l nj nk">/**<br/> * <a class="ae kr" href="http://twitter.com/title" rel="noopener ugc nofollow" target="_blank">@title</a> Recorder — record a message into the blockchain<br/> * <a class="ae kr" href="http://twitter.com/dev" rel="noopener ugc nofollow" target="_blank">@a</a>uthor Life on Mars — https://lifeonmars.pt<br/> */<br/>contract Recorder{<br/>  event Record(<br/>    address _from,<br/>    string _message<br/>  );</span><span id="ff0c" class="mh ll hu nd b fv nl ni l nj nk">  /**<br/>   * <a class="ae kr" href="http://twitter.com/dev" rel="noopener ugc nofollow" target="_blank">@n</a>otice Sends the contract a message<br/>   * to record into the blockchain<br/>   * <a class="ae kr" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank">@param</a> message  message to record<br/>   */<br/>  function record(string message) public {<br/>    emit Record(msg.sender, message);<br/>  }<br/>}</span></pre><p id="9feb" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">让我们从慢慢浏览这段代码开始。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="f197" class="mh ll hu nd b fv nh ni l nj nk">pragma solidity 0.4.24;</span></pre><p id="667f" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">根据<a class="ae kr" href="http://solidity.readthedocs.io/en/develop/layout-of-source-files.html#version-pragma" rel="noopener ugc nofollow" target="_blank">文件</a>:</p><blockquote class="mv mw mx"><p id="3618" class="jv jw my jx b jy jz iv ka kb kc iy kd mz kf kg kh na kj kk kl nb kn ko kp kq hn dt translated">源文件可以(也应该)用所谓的版本杂注进行注释，以拒绝用未来的编译器版本进行编译，这可能会引入不兼容的更改。</p></blockquote><p id="946f" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这一行确保您的源文件不会被版本不是0.4.24的编译器编译。</p><p id="e529" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">也可以使用限制较少的pragmas，例如通过插入符号范围。取<code class="eh nm nn no nd b">^0.4.24</code>。在这种情况下，你的源代码将被任何晚于<code class="eh nm nn no nd b">0.4.24</code>早于<code class="eh nm nn no nd b">0.5.0.</code>的编译器编译。更多信息参见npm 的<a class="ae kr" href="https://docs.npmjs.com/misc/semver" rel="noopener ugc nofollow" target="_blank"> semver文档。</a></p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="d2be" class="mh ll hu nd b fv nh ni l nj nk">contract Recorder {}</span></pre><p id="a7d7" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><code class="eh nm nn no nd b">contract</code>顾名思义，是用来定义合同的关键词。合同用写在<a class="ae kr" href="https://en.wikipedia.org/wiki/PascalCase" rel="noopener ugc nofollow" target="_blank"> PascalCase </a>中的名称来定义。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="b11f" class="mh ll hu nd b fv nh ni l nj nk">event Record(<br/>  address _from,<br/>  string _message<br/>);</span></pre><p id="ed2c" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">在这里，我们定义一个事件。事件允许您对以太坊日志记录工具进行写访问。当被调用时，调用它们的参数存储在事务的日志中，这是区块链[ <a class="ae kr" href="http://solidity.readthedocs.io/en/develop/contracts.html#events" rel="noopener ugc nofollow" target="_blank"> docs </a> ]中的一种特殊数据结构。这些事务日志可用于存储信息。</p><p id="8887" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">与使用合同存储(写入合同中的变量)相比，使用日志在天然气成本方面要便宜得多。然而，这也带来了一个代价:契约不能从日志数据中读取数据(更多细节参见Consensys的这篇好文章<a class="ae kr" href="https://media.consensys.net/technical-introduction-to-events-and-logs-in-ethereum-a074d65dd61e" rel="noopener ugc nofollow" target="_blank">】)。</a></p><p id="db4e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">因为，对于我们的用例，我们不需要契约来读取这些日志，我们使用事件而不是存储字符串数组。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="ae65" class="mh ll hu nd b fv nh ni l nj nk">function record(string message) public {<br/>  Record(msg.sender, message);<br/>}</span></pre><p id="2c11" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><code class="eh nm nn no nd b">record</code>的方法非常简单。这是一种<code class="eh nm nn no nd b">public</code>方法，<a class="ae kr" href="https://solidity.readthedocs.io/en/v0.4.24/contracts.html#visibility-and-getters" rel="noopener ugc nofollow" target="_blank">的意思是可以对外调用</a>。它接受一个名为<code class="eh nm nn no nd b">message</code>的<code class="eh nm nn no nd b">string</code>参数，它所做的就是用两个参数调用<code class="eh nm nn no nd b">Record</code>事件:</p><ul class=""><li id="1010" class="np nq hu jx b jy jz kb kc ke nr ki ns km nt kq nu nv nw nx dt translated"><code class="eh nm nn no nd b">msg.sender</code>保存调用<code class="eh nm nn no nd b">record</code>函数[ <a class="ae kr" href="http://solidity.readthedocs.io/en/develop/units-and-global-variables.html#block-and-transaction-properties" rel="noopener ugc nofollow" target="_blank"> docs </a> ]的账户地址；</li><li id="f0b5" class="np nq hu jx b jy ny kb nz ke oa ki ob km oc kq nu nv nw nx dt translated"><code class="eh nm nn no nd b">message</code>只是调用<code class="eh nm nn no nd b">record</code>的参数。</li></ul><p id="b281" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">只有一种方式可以与这个特定的智能契约进行交互:向它发送一个事务，以及一个调用<code class="eh nm nn no nd b">record</code>方法的<code class="eh nm nn no nd b">message</code>参数。当一个账户<code class="eh nm nn no nd b">A</code>调用<code class="eh nm nn no nd b">record</code>方法时，就会调用<code class="eh nm nn no nd b">Record</code>事件，这导致元组<code class="eh nm nn no nd b">{A's address, message}</code>被存储在相应的事务日志中。</p><h2 id="e984" class="mh ll hu bd lm mi mj mk lq ml mm mn lu ke mo mp lw ki mq mr ly km ms mt ma mu dt translated">汇编</h2><p id="7065" class="pw-post-body-paragraph jv jw hu jx b jy mc iv ka kb md iy kd ke me kg kh ki mf kk kl km mg ko kp kq hn dt translated">Solidity代码可以使用solidity命令行编译器<code class="eh nm nn no nd b">solc</code>进行编译。稍后我们将看到如何使用<a class="ae kr" href="http://truffleframework.com/" rel="noopener ugc nofollow" target="_blank"> Truffle </a>进行编译和部署，但是现在请耐心等待。<a class="ae kr" href="http://solidity.readthedocs.io/en/develop/installing-solidity.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jx hv">如果你想跟着做，安装solc </strong> </a> <strong class="jx hv">。</strong></p><p id="c15e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">运行<code class="eh nm nn no nd b">solc</code>允许我们输出契约的二进制表示。这用于部署合同(同样，Truffle稍后会为我们处理这个问题)。下面是这个契约的二进制输出的样子(你可以用<code class="eh nm nn no nd b">solc --bin Recorder.sol</code>自己看看)</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="83f8" class="mh ll hu nd b fv nh ni l nj nk">6060604052341561000f57600080fd5b6101a28061001e6000396000f300606060405260043610610041576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063e51ace1614610046575b600080fd5b341561005157600080fd5b6100a1600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506100a3565b005b7fac0fdae5d3299ac82cf049834f149484c5cafb1584ffd1e2432597e4581b16a73382604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001828103825283818151815260200191508051906020019080838360005b8381101561013857808201518184015260208101905061011d565b50505050905090810190601f1680156101655780820380516001836020036101000a031916815260200191505b50935050505060405180910390a1505600a165627a7a723058201b9ef174b2b5557ad31400e4eb1cd02dd02b8244eefbc97e9b75b01072cc706e0029</span></pre><p id="3ce5" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">相当令人兴奋的东西。</p><p id="0922" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">根据<a class="ae kr" href="http://solidity.readthedocs.io/en/develop/abi-spec.html" rel="noopener ugc nofollow" target="_blank">官方文件</a>:</p><blockquote class="mv mw mx"><p id="5483" class="jv jw my jx b jy jz iv ka kb kc iy kd mz kf kg kh na kj kk kl nb kn ko kp kq hn dt translated">编码不是自描述的，因此需要一个模式来解码。</p></blockquote><p id="97d1" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这意味着，如果我们能够理解一个契约并与之交互，我们需要知道它的<a class="ae kr" href="https://en.wikipedia.org/wiki/Application_binary_interface" rel="noopener ugc nofollow" target="_blank"> ABI规范</a>。ABI(应用程序二进制接口)是程序的接口规范。</p><p id="edae" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这是这个合同的规格说明(你可以通过<code class="eh nm nn no nd b">solc --abi Recorder.sol</code>亲自查看)。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="24ae" class="mh ll hu nd b fv nh ni l nj nk">[<br/>  {<br/>    "constant": false,<br/>    "inputs": [<br/>      {<br/>        "name": "message",<br/>        "type": "string"<br/>      }<br/>    ],<br/>    "name": "record",<br/>    "outputs": [],<br/>    "payable": false,<br/>    "stateMutability": "nonpayable",<br/>    "type": "function"<br/>  },<br/>  {<br/>    "anonymous": false,<br/>    "inputs": [<br/>      {<br/>        "indexed": false,<br/>        "name": "_from",<br/>        "type": "address"<br/>      },<br/>      {<br/>        "indexed": false,<br/>        "name": "_message",<br/>        "type": "string"<br/>      }<br/>    ],<br/>    "name": "Record",<br/>    "type": "event"<br/>  }<br/>]</span></pre><p id="8455" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这个ABI规范将在以后变得相关。</p><h2 id="20c1" class="mh ll hu bd lm mi mj mk lq ml mm mn lu ke mo mp lw ki mq mr ly km ms mt ma mu dt translated">Natspec</h2><p id="a174" class="pw-post-body-paragraph jv jw hu jx b jy mc iv ka kb md iy kd ke me kg kh ki mf kk kl km mg ko kp kq hn dt translated">编译器也可以根据你对以太坊自然规范格式的使用，或者Natspec ，生成文档。这可以被用户界面用来向用户和/或开发者显示附加信息。这个契约对它自己和它的<code class="eh nm nn no nd b">record</code>方法都有这样的注释。</p><p id="87b3" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这是编译输出。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="b4b4" class="mh ll hu nd b fv nh ni l nj nk">“devdoc”: {<br/>  “author”: “Life on Mars — <a class="ae kr" href="https://lifeonmars.pt" rel="noopener ugc nofollow" target="_blank">https://lifeonmars.pt</a>",<br/>  “methods”: {<br/>    “record(string)”: {<br/>      “params”: {<br/>        “message”: “ — message to record”<br/>      }<br/>    }<br/>  },<br/>  “title”: “Recorder — record a message into the blockchain”<br/>},<br/>“userdoc”: {<br/>  “methods”: {<br/>    “record(string)”: {<br/>      “notice”: “Sends the contract a message to record into the blockchain”<br/>    }<br/>  }<br/>}</span></pre></div><div class="ab cl od oe hc of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="hn ho hp hq hr"><p id="4e08" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我想给你看这些内部结构，但是从现在开始我们要用松露了。Truffle是以太坊的一个框架，它的一些细微之处会让我们的生活变得更简单。在我们的例子中，它将有助于编译和测试。</p><p id="aec9" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><strong class="jx hv">你需要块菌来跟随接下来的部分，所以请</strong> <a class="ae kr" href="http://truffleframework.com/docs/getting_started/installation" rel="noopener ugc nofollow" target="_blank"> <strong class="jx hv">按照说明安装它</strong> </a> <strong class="jx hv">。</strong></p><h1 id="25a9" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">在本地网络上部署和测试合同</h1><p id="8197" class="pw-post-body-paragraph jv jw hu jx b jy mc iv ka kb md iy kd ke me kg kh ki mf kk kl km mg ko kp kq hn dt translated">为了测试和部署合同，我们需要运行一个以太坊客户端。我们将从<a class="ae kr" href="https://github.com/trufflesuite/ganache-cli" rel="noopener ugc nofollow" target="_blank"> Ganache CLI </a>开始，它模拟了一个真实客户端的行为(比如<a class="ae kr" href="https://github.com/ethereum/go-ethereum/" rel="noopener ugc nofollow" target="_blank"> geth </a>，我们将在后面研究它)，但是它要快得多。这个速度有助于加快开发和测试周期。</p><p id="337f" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><strong class="jx hv">按照说明，用</strong> <code class="eh nm nn no nd b"><strong class="jx hv">npm install -g ganache-cli</strong></code> <strong class="jx hv">安装，用</strong> <code class="eh nm nn no nd b"><strong class="jx hv">ganache-cli</strong></code> <strong class="jx hv">运行。</strong></p><p id="7fc2" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在，创建一个新的<code class="eh nm nn no nd b">recorder</code>目录，将<code class="eh nm nn no nd b">cd</code>放入其中，并运行<code class="eh nm nn no nd b">truffle init</code>。我们需要配置Truffle来连接到<code class="eh nm nn no nd b">ganache-cli</code>。如下编辑<code class="eh nm nn no nd b">truffle.js</code>文件:</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="82a3" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle.js<br/>-------------</span><span id="477f" class="mh ll hu nd b fv nl ni l nj nk">module.exports = {<br/>  networks: {<br/>    development: {<br/>      host: "localhost",<br/>      port: 8545,<br/>      network_id: "*",<br/>      gas: 4712387,<br/>    }<br/>  }<br/>};</span></pre><p id="86ec" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">接下来，创建一个<code class="eh nm nn no nd b">contracts/Recorder.sol</code>文件，用于存储合同的源代码，如上所示。</p><p id="561d" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">然后像这样创建<code class="eh nm nn no nd b">migrations/2_deploy_contracts.js</code>:</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="6565" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ migrations/<!-- -->2_deploy_contracts.js<br/>-----------------------------------</span><span id="f5dd" class="mh ll hu nd b fv nl ni l nj nk">var Recorder = artifacts.require("./Recorder.sol");</span><span id="fa65" class="mh ll hu nd b fv nl ni l nj nk">module.exports = function(deployer) {<br/>  deployer.deploy(Recorder);<br/>};</span></pre><p id="41cb" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在我们准备打开<code class="eh nm nn no nd b">truffle console</code>，在这里我们将让Truffle通过<code class="eh nm nn no nd b">migrate --reset</code>将记录器合同部署到网络中。Truffle将确保为您自动编译您的合同。</p><p id="eb12" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">(顺便说一下，<code class="eh nm nn no nd b">--reset</code>告诉松露<a class="ae kr" href="http://truffleframework.com/docs/getting_started/migrations" rel="noopener ugc nofollow" target="_blank">从头开始运行所有的迁移</a>。出于本文的目的，我们对使用迁移进行契约版本控制不感兴趣，所以我们总是使用它来重新开始这个过程。)</p><p id="5997" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">一旦部署了合同，我们就可以使用它了！我们将存储几条记录，然后继续查询它们。</p><p id="abc3" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我们可以通过获取一个契约引用并直接在其上调用方法来调用契约上的方法:</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="511c" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle console<br/>-----------------</span><span id="8fe1" class="mh ll hu nd b fv nl ni l nj nk">truffle(development)&gt; recorder = Recorder.at(Recorder.address)<br/>truffle(development)&gt; recorder.record("first message");<br/>truffle(development)&gt; recorder.record("second message");</span></pre><p id="a4c0" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">注意<code class="eh nm nn no nd b">ganache-cli</code>输出。在其他事情中，它会告诉你运行这个交易用了多少汽油。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="fa84" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ ganache-cli output<br/>-----------------</span><span id="5945" class="mh ll hu nd b fv nl ni l nj nk">eth_sendTransaction</span><span id="c398" class="mh ll hu nd b fv nl ni l nj nk">Transaction: 0x118de578d3bcbd9474099e5385b0a883ad18eaa99319f710f641db1cc6b2e8fe<br/>  Gas usage: 24577<br/>  Block Number: 14<br/>  Block Time: Fri Nov 10 2017 20:06:42 GMT+0000 (WET)</span><span id="124d" class="mh ll hu nd b fv nl ni l nj nk">eth_getTransactionReceipt</span></pre><p id="b9f8" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">为了阅读前面写的内容，我们需要运行下面的代码。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="0c5f" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle console<br/>------------------</span><span id="36fe" class="mh ll hu nd b fv nl ni l nj nk">truffle(development)&gt; recorder<br/>  .Record({}, {fromBlock: 0, toBlock: "latest"})<br/>  .get((error,result) =&gt; (<br/>    console.log(result.map(<br/>      (result) =&gt; (result.args._message)<br/>    )<br/>  )))</span></pre><p id="4925" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">注意我们是如何调用<code class="eh nm nn no nd b">Record({}, {fromBlock: 0, toBlock: "latest"})</code>的。第一个参数用于过滤结果，这超出了本文的范围。第二个是我们如何指定我们将在哪个块跨度中寻找<code class="eh nm nn no nd b">Record</code>的事务日志。</p><p id="18b2" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><code class="eh nm nn no nd b">get</code>方法接受回调，我们只是<code class="eh nm nn no nd b">map</code> ping返回的结果，以获得每个结果的<code class="eh nm nn no nd b">args._message</code>值。</p><p id="bd10" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果这一切都解决了，您应该看到您的控制台输出如下。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="5245" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle console<br/>------------------</span><span id="cd15" class="mh ll hu nd b fv nl ni l nj nk">truffle(development)&gt; [ 'first message', 'second message']</span></pre><p id="4526" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">就是这样！您的契约已经部署，您已经使用它将消息写入链中，然后您查询它以获取这些消息。</p><h2 id="a62e" class="mh ll hu bd lm mi mj mk lq ml mm mn lu ke mo mp lw ki mq mr ly km ms mt ma mu dt translated">测试</h2><p id="6195" class="pw-post-body-paragraph jv jw hu jx b jy mc iv ka kb md iy kd ke me kg kh ki mf kk kl km mg ko kp kq hn dt translated">在我们在真实网络上尝试之前，让我们先来看看测试合同。Truffle使用<a class="ae kr" href="https://mochajs.org/" rel="noopener ugc nofollow" target="_blank"> Mocha </a>测试框架，使用<a class="ae kr" href="http://chaijs.com/" rel="noopener ugc nofollow" target="_blank"> Chai </a>进行断言。我们将使用下面的测试。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="1399" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ test/recorder.js<br/>-------------------</span><span id="638b" class="mh ll hu nd b fv nl ni l nj nk">var Recorder = artifacts.require("Recorder");</span><span id="fe88" class="mh ll hu nd b fv nl ni l nj nk">contract('Recorder', function(accounts) {<br/>  it("records event", function(done) {<br/>    Recorder.deployed().then(function (instance) {<br/>      instance<br/>        .Record({}, {fromBlock: 0, toBlock: "latest"})<br/>        .get(function (error, events) {<br/>          assert.equal(<br/>            0,<br/>            events.length,<br/>            "There should be no events at start."<br/>          );<br/>          instance.record("pokemon").then(function () {<br/>            instance<br/>              .Record({}, {fromBlock: 0, toBlock: "latest"})<br/>              .get(function (error, events) {<br/>                assert.equal(<br/>                  1,<br/>                  events.length,<br/>                  "There should be one event after recording."<br/>                );<br/>                done();<br/>              });<br/>          });<br/>        });<br/>    });<br/>  });<br/>});</span></pre><p id="7424" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">它看起来很丑，但就测试而言，它非常简单:</p><ul class=""><li id="b121" class="np nq hu jx b jy jz kb kc ke nr ki ns km nt kq nu nv nw nx dt translated"><code class="eh nm nn no nd b">Recorder.deployed()</code>在获得已部署的记录器实例时解析</li><li id="1a1e" class="np nq hu jx b jy ny kb nz ke oa ki ob km oc kq nu nv nw nx dt translated">我们首先使用<code class="eh nm nn no nd b">instance.Record(...).get()</code>,获取写入其中的消息列表</li><li id="ccde" class="np nq hu jx b jy ny kb nz ke oa ki ob km oc kq nu nv nw nx dt translated">我们用<code class="eh nm nn no nd b">assert.equal(0, events.length)</code>检查它没有消息</li><li id="4b86" class="np nq hu jx b jy ny kb nz ke oa ki ob km oc kq nu nv nw nx dt translated">然后我们用<code class="eh nm nn no nd b">instance.record("pokemon")</code>写一条消息</li><li id="88f1" class="np nq hu jx b jy ny kb nz ke oa ki ob km oc kq nu nv nw nx dt translated">最后，我们确保消息是用<code class="eh nm nn no nd b">assert.equal(1, events.length)</code>写的</li></ul><p id="c0b4" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">在<code class="eh nm nn no nd b">tests</code>目录中创建一个名为<code class="eh nm nn no nd b">recorder.js</code>的文件，并将测试粘贴到其中。您可以通过退出控制台并简单地在您的shell中键入<code class="eh nm nn no nd b">truffle test</code>来运行这个测试。注意，每次运行测试文件时，truffle都会重新部署契约。更多详情参见<a class="ae kr" href="http://truffleframework.com/docs/getting_started/javascript-tests" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="6e85" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle test output<br/>----------------------</span><span id="d92b" class="mh ll hu nd b fv nl ni l nj nk">Using network 'development'.</span><span id="76d9" class="mh ll hu nd b fv nl ni l nj nk">Contract: Recorder<br/>    ✓ records event (101ms)</span><span id="dd5d" class="mh ll hu nd b fv nl ni l nj nk">1 passing (115ms)</span></pre><p id="a0fc" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">成功！</p><h1 id="b4fc" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">连接到真实的网络</h1><p id="9d8f" class="pw-post-body-paragraph jv jw hu jx b jy mc iv ka kb md iy kd ke me kg kh ki mf kk kl km mg ko kp kq hn dt translated">你现在可以合理地说<em class="my">它在我的机器</em>上工作。不够好？让我们试着让它在真实的以太网上工作。</p><p id="16b4" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">在我们部署到实际的<em class="my"> mainnet </em>之前，让我们先使用一个<em class="my"> testnet </em>。testnet是以太网的模拟，由真实节点支持，但主要用于测试。因此，测试网不用于任何严肃的事情，其中的以太不应该包含任何值。我们将使用<a class="ae kr" href="https://github.com/ethereum/ropsten" rel="noopener ugc nofollow" target="_blank"> Ropsten testnet </a>。这将允许我们使用一个<a class="ae kr" href="https://ropsten.etherscan.io/" rel="noopener ugc nofollow" target="_blank">块浏览器</a>来挖掘我们在网络上的合同和交易。</p><p id="2362" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><strong class="jx hv">根据</strong> <a class="ae kr" href="https://github.com/ethereum/go-ethereum/wiki/Building-Ethereum" rel="noopener ugc nofollow" target="_blank"> <strong class="jx hv">说明书</strong> </a> <strong class="jx hv">安装geth。</strong>然后我们用Ropsten同步(<a class="ae kr" href="https://github.com/ethereum/ropsten" rel="noopener ugc nofollow" target="_blank">更多指令</a>)。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="897f" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ shell<br/>--------</span><span id="5731" class="mh ll hu nd b fv nl ni l nj nk">$ geth --testnet --fast --bootnodes "enode://20c9ad97c081d63397d7b685a412227a40e23c8bdc6688c6f37e97cfbc22d2b4d1db1510d8f61e6a8866ad7f0e17c02b14182d37ea7c3c8b9c2683aeb6b733a1@52.169.14.227:30303,enode://6ce05930c72abc632c58e2e4324f7c7ea478cec0ed4fa2528982cf34483094e9cbc9216e7aa349691242576d552a2a56aaeae426c5303ded677ce455ba1acd9d@13.84.180.240:30303" --rpc</span></pre><ul class=""><li id="955d" class="np nq hu jx b jy jz kb kc ke nr ki ns km nt kq nu nv nw nx dt translated">告诉geth连接到Ropsten测试网</li><li id="c20f" class="np nq hu jx b jy ny kb nz ke oa ki ob km oc kq nu nv nw nx dt translated"><code class="eh nm nn no nd b">--fast</code>或<code class="eh nm nn no nd b">--syncmode="fast"</code>使区块链同步更快(详见<a class="ae kr" href="https://github.com/ethereum/go-ethereum/pull/1889" rel="noopener ugc nofollow" target="_blank">本PR</a>)；</li><li id="813e" class="np nq hu jx b jy ny kb nz ke oa ki ob km oc kq nu nv nw nx dt translated"><code class="eh nm nn no nd b">--bootnodes=...</code>告诉geth要连接到哪些节点，以便发现网络的其余部分</li><li id="49dd" class="np nq hu jx b jy ny kb nz ke oa ki ob km oc kq nu nv nw nx dt translated"><code class="eh nm nn no nd b">--rpc</code>告诉geth启用HTTP-RPC服务器，允许trufle和其他RPC客户端连接到它</li></ul><p id="f5b7" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我们可以使用geth提供的控制台与网络进行交互。<code class="eh nm nn no nd b">geth attach</code>应该可以了，但是如果不行，就在geth输出中查找下面一行。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="adde" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ geth output<br/>--------------</span><span id="ae33" class="mh ll hu nd b fv nl ni l nj nk">INFO [11-13|14:45:16] IPC endpoint opened: /Users/pokemon/.rinkeby/geth.ipc</span></pre><p id="2722" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">并相应运行<code class="eh nm nn no nd b">geth attach /Users/pokemon/.rinkeby/geth.ipc</code>。这会让你直接进入控制台。Geth应该很难与Ropsten链同步，这可能需要几分钟到几个小时，具体取决于您的硬件和网络。下面是我们检查进度的方法。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="8ca5" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ geth console<br/>---------------</span><span id="49f5" class="mh ll hu nd b fv nl ni l nj nk">&gt; eth.blockNumber<br/>0</span></pre><p id="93ce" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><code class="eh nm nn no nd b">eth.blockNumber</code>返回最近块的编号<a class="ae kr" href="https://github.com/ethereum/wiki/wiki/JavaScript-API#web3ethblocknumber" rel="noopener ugc nofollow" target="_blank">文档</a>。它将显示<code class="eh nm nn no nd b">0</code>，直到您与网络同步，我们可以通过<code class="eh nm nn no nd b">eth.syncing</code>检查:</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="b6da" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ geth console<br/>---------------</span><span id="75f2" class="mh ll hu nd b fv nl ni l nj nk">&gt; eth.syncing<br/>false</span></pre><p id="9403" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">真扫兴。似乎我们还没有连接到任何节点。在我们继续之前，我们必须在geth的输出中看到这一点。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="5cae" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ geth output<br/>--------------</span><span id="9c4a" class="mh ll hu nd b fv nl ni l nj nk">INFO [11-13|15:26:26] Block synchronisation started<br/>INFO [11-13|15:26:28] Imported new block headers               count=384 elapsed=951.820ms number=384 hash=d3d5d5…c79cf3 ignored=0</span></pre><p id="9749" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">太好了！让我们再试试控制台:</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="de9d" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ geth console<br/>---------------</span><span id="f604" class="mh ll hu nd b fv nl ni l nj nk">&gt; eth.blockNumber<br/>0<br/>&gt; eth.syncing<br/>{<br/>  currentBlock: 775342,<br/>  highestBlock: 2356143,<br/>  knownStates: 167957,<br/>  pulledStates: 162021,<br/>  startingBlock: 0<br/>}</span></pre><p id="57fe" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">好多了。我们将等到<code class="eh nm nn no nd b">eth.syncing</code>再次返回<code class="eh nm nn no nd b">false</code>后再与区块链交互。上面那个0<a class="ae kr" href="https://github.com/ethereum/go-ethereum/issues/14338" rel="noopener ugc nofollow" target="_blank">没事，不用担心。</a></p><p id="1e88" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这里有几个让您忙碌的其他命令:</p><ul class=""><li id="427a" class="np nq hu jx b jy jz kb kc ke nr ki ns km nt kq nu nv nw nx dt translated"><code class="eh nm nn no nd b">net.listening</code>告诉我们节点是否在主动监听网络连接[ <a class="ae kr" href="https://github.com/ethereum/wiki/wiki/JavaScript-API#web3netlistening" rel="noopener ugc nofollow" target="_blank">文档</a></li><li id="64b0" class="np nq hu jx b jy ny kb nz ke oa ki ob km oc kq nu nv nw nx dt translated"><code class="eh nm nn no nd b">net.peerCount</code>返回连接的对等体数量[ <a class="ae kr" href="https://github.com/ethereum/wiki/wiki/JavaScript-API#web3netpeercount" rel="noopener ugc nofollow" target="_blank">文档</a></li><li id="daf4" class="np nq hu jx b jy ny kb nz ke oa ki ob km oc kq nu nv nw nx dt translated"><code class="eh nm nn no nd b">admin.peers</code>让我们深入了解我们联系的同行</li></ul></div><div class="ab cl od oe hc of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="hn ho hp hq hr"><p id="d28b" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">让我们尝试将我们的合同部署到Ropsten网络。我们会让松露再一次为我们做艰苦的工作。然而，Ropsten是一个真正的人造网络，我们需要为我们的一个帐户得到一些真正的人造乙醚。</p><p id="6f14" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我们先去geth确认一下有没有乙醚:</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="3aad" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ geth console<br/>---------------</span><span id="7d2b" class="mh ll hu nd b fv nl ni l nj nk">&gt; eth.getBalance(eth.accounts[0])<br/>0</span></pre><p id="9b48" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">没错。我试着用了一个水龙头，但是当我试的时候，它就坏了。<a class="ae kr" href="https://gitter.im/ethereum/ropsten" rel="noopener ugc nofollow" target="_blank"> Ropsten Gitter </a>推荐我使用<a class="ae kr" href="https://faucet.metamask.io/" rel="noopener ugc nofollow" target="_blank"> MetaMask的乙醚龙头</a>，你需要<a class="ae kr" href="https://metamask.io/" rel="noopener ugc nofollow" target="_blank"> MetaMask </a>使用它，它对我很有效。</p><p id="9a6e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">然后，我使用MetaMask将Ether发送到我在geth的帐户。首先我必须找到它的地址。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="837a" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ geth console<br/>---------------</span><span id="30af" class="mh ll hu nd b fv nl ni l nj nk">&gt; eth.accounts[0]<br/>"0xff7771583ee3944a9ef32cfcb54c0b0d688fa70a"</span></pre><p id="2569" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">然后我使用MetaMask中的“Send”将资金发送到这个地址。传输时间不会超过几分钟(您可以点击MetaMask中的传输，在Etherscan上查看)。一旦确认，您应该能够在geth:</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="88c0" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ geth console<br/>---------------</span><span id="bec6" class="mh ll hu nd b fv nl ni l nj nk">&gt; eth.getBalance(eth.accounts[0])<br/>1836311700000000000</span></pre><p id="606b" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">让我们也使用这个帐户地址来告诉Truffle使用哪个帐户与区块链进行交互。更新您的<code class="eh nm nn no nd b">truffle.js</code>文件，如下所示:</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="94a5" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle.js<br/>-------------</span><span id="ec96" class="mh ll hu nd b fv nl ni l nj nk">module.exports = {<br/>  networks: {<br/>    development: {<br/>      host: "localhost",<br/>      port: 8545,<br/>      network_id: "*",<br/>      from: /* YOUR ADDRESS HERE */,<br/>      gas: 4000000,<br/>    }<br/>  }<br/>};</span></pre><p id="e5eb" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">因为我们是坚持者，我们再次运行测试，现在在Ropsten上。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="0f55" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ shell<br/>--------</span><span id="1eec" class="mh ll hu nd b fv nl ni l nj nk">$ truffle test</span><span id="cdd2" class="mh ll hu nd b fv nl ni l nj nk">Using network 'development'.</span><span id="a08a" class="mh ll hu nd b fv nl ni l nj nk">Error encountered, bailing. Network state unknown. Review successful transactions manually.<br/>Error: authentication needed: password or unlock</span></pre><p id="e7cd" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">哦，对了。所以，为了保护你，geth一直锁定这个帐户。为了使用它，你需要解锁它。回到geth:只要geth保持开放，就让我们保持帐户解锁。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="f206" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ geth console<br/>---------------</span><span id="465b" class="mh ll hu nd b fv nl ni l nj nk">&gt; personal.unlockAccount(eth.accounts[0], "password", 0)</span></pre><p id="92b9" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">太好了。现在让我们再试一次。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="ecfd" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ shell<br/>--------</span><span id="7cc3" class="mh ll hu nd b fv nl ni l nj nk">$ truffle test</span><span id="eeaa" class="mh ll hu nd b fv nl ni l nj nk">Using network 'development'.</span><span id="66db" class="mh ll hu nd b fv nl ni l nj nk">Contract: Recorder<br/>    ✓ records event (54382ms)</span><span id="c7de" class="mh ll hu nd b fv nl ni l nj nk">1 passing (54s)</span></pre><p id="9071" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这比使用Ganache CLI花费的时间长得多，但是测试通过了。现在让我们引导<code class="eh nm nn no nd b">truffle console</code>并尝试部署契约。这一次，Ganache CLI不是目标。罗普斯滕群岛。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="095e" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle console<br/>------------------</span><span id="c2f5" class="mh ll hu nd b fv nl ni l nj nk">truffle(development)&gt; migrate --reset<br/>Using network 'development'.</span><span id="0eb6" class="mh ll hu nd b fv nl ni l nj nk">Running migration: 1_initial_migration.js<br/>  Replacing Migrations...<br/>  ... 0x2b330d5a4bac42ac3aea135c0f7090502f05e5349a6684c869db9a9591d02bd3</span></pre><p id="9fc0" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">好多了，但这需要一段时间才能完成。花点时间在geth的输出中注意类似这样的内容。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="e892" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ geth output<br/>--------------</span><span id="2743" class="mh ll hu nd b fv nl ni l nj nk">INFO [11-22|11:05:50] Submitted contract creation              fullhash=0xfb92a0da5e5b7d13a155b1c57bb46ffeb672502842ffe744de30be068a4d5b4f contract=0xf7Ec3C971DFA6549e2c0aC4437068e86dC39b25F</span></pre><p id="4a23" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">整洁，对不对？顺便说一下，你可以复制那个交易散列和合同地址，然后去<a class="ae kr" href="https://ropsten.etherscan.io" rel="noopener ugc nofollow" target="_blank"> Ropsten Etherscan </a>中寻找它们。它可能需要一分钟才能显现出来，但它会的。我们现在正在将合同部署到一个真正的网络上。记住，你没有服务器。这简直太棒了。</p><p id="548e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">与此同时，松露继续进行。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="1812" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle console<br/>------------------</span><span id="a1e3" class="mh ll hu nd b fv nl ni l nj nk">Running migration: 1_initial_migration.js<br/>  Replacing Migrations...<br/>  ... 0x2b330d5a4bac42ac3aea135c0f7090502f05e5349a6684c869db9a9591d02bd3<br/>  Migrations: 0xf1867e8ac0fe8c4dd26157c2e5123b9f5d63e0e0<br/>Saving successful migration to network...<br/>  ... 0x3c0364b133a07bed6f34c1e2b733f57cfee65ded088bdd452547bfba5eb3c18c<br/>Saving artifacts...<br/>Running migration: 2_deploy_contracts.js<br/>  Deploying Recorder...<br/>  ... 0x4c86ec2e5da57f734706257a86e7fff929538a68ed7a5265cc628b984613d822<br/>  Recorder: 0x949d9ac08845f74ec7cd96337920b672fb31c017<br/>Saving successful migration to network...<br/>  ... 0x02c04fc250d3077c12eef7e3c580564f03791ee53de2a1dfcc82eb37deba3911<br/>Saving artifacts...</span></pre><p id="7231" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">太好了。我们完了。看到这条线了吗？</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="1993" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle console<br/>------------------</span><span id="b841" class="mh ll hu nd b fv nl ni l nj nk">Recorder: 0x949d9ac08845f74ec7cd96337920b672fb31c017</span></pre><p id="2fc4" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">是的，<a class="ae kr" href="https://ropsten.etherscan.io/address/0x949d9ac08845f74ec7cd96337920b672fb31c017" rel="noopener ugc nofollow" target="_blank">就是我们</a>。我们在Ropsten测试网上直播。</p><p id="53fa" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">让我们玩我们的合同。我们知道它能工作是因为它通过了测试，但是。回到松露，所以我们可以记录一个信息，并确保它留在那里。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="08c4" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle console<br/>------------------</span><span id="94a2" class="mh ll hu nd b fv nl ni l nj nk">truffle(development)&gt; recorder = Recorder.at(Recorder.address)<br/>truffle(development)&gt; recorder.record("i dont even")</span></pre><p id="7a78" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这将需要几分钟，因为我们现在在Ropsten上。但是后来:</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="1fba" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle console<br/>------------------</span><span id="98e8" class="mh ll hu nd b fv nl ni l nj nk">truffle(development)&gt; recorder.Record(<br/>  {},<br/>  {fromBlock: 0, toBlock: "latest"}<br/>).get(function (error,result) {<br/>  console.log(result.map((x)=&gt;(x.args._message)))<br/>})<br/>truffle(development)&gt; ['i dont even']</span></pre><p id="ff8e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">完美！</p><h1 id="dddc" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">使用以太坊主网</h1><p id="df0e" class="pw-post-body-paragraph jv jw hu jx b jy mc iv ka kb md iy kd ke me kg kh ki mf kk kl km mg ko kp kq hn dt translated">有了这些知识，我们现在可以轻松地将相同的契约部署到mainnet中。为了简洁起见，我们将跳过测试等几个步骤，直接进入正题。</p><p id="60b7" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">让我们重新启动geth并让它连接到mainnet。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="5c30" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ shell<br/>--------</span><span id="3715" class="mh ll hu nd b fv nl ni l nj nk">$ geth --fast --cache=512</span></pre><p id="ccc5" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我们需要等待geth同步。去别处忙吧，这会花些时间。</p><p id="c54f" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">一旦<code class="eh nm nn no nd b">eth.syncing</code>再次返回false，让我们使用truffle来部署它。确保你使用的账户里有资金。真正的以太。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="c5a2" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ shell<br/>--------</span><span id="47e0" class="mh ll hu nd b fv nl ni l nj nk">$ truffle migrate --reset</span></pre><p id="33e7" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">一开始可能会不太顺利。你可能会遇到两种故障模式。有这样一种美:</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="7ade" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle migrate output<br/>-------------------------</span><span id="5a07" class="mh ll hu nd b fv nl ni l nj nk">Running migration: 1_initial_migration.js<br/>  Deploying Migrations...<br/>  ... undefined<br/>Error encountered, bailing. Network state unknown. Review successful transactions manually.<br/>Error: insufficient funds for gas * price + value</span></pre><p id="b8c1" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这个也是:</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="14d7" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle migrate output<br/>-------------------------</span><span id="bf1e" class="mh ll hu nd b fv nl ni l nj nk">Running migration: 1_initial_migration.js<br/>  Deploying Migrations...<br/>  ... undefined<br/>Error encountered, bailing. Network state unknown. Review successful transactions manually.<br/>Error: exceeds block gas limit</span></pre><p id="55bf" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">所以，这是geth告诉松露你的<a class="ae kr" href="http://truffleframework.com/docs/advanced/configuration" rel="noopener ugc nofollow" target="_blank">气体设置</a>不理想。我建议将<code class="eh nm nn no nd b">gas</code>设置为一个合理的高值，比如1000000(注意上面合同部署是如何消耗大约20K汽油的)，并检查<a class="ae kr" href="https://ethgasstation.info/" rel="noopener ugc nofollow" target="_blank"> ETH加油站</a>以计算出<code class="eh nm nn no nd b">gasPrice</code>的值应该是多少。这是我现在看到的:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff ok"><img src="../Images/af790f4215cedf5d970864535db49aaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YhwulqooonC2gFrrgbIdNw.png"/></div></div></figure><p id="7b7c" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">所以，10 Gwei在0.53分钟内给我们一个确认。那很好。以太坊转换器可以帮我们把那个变成卫。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff ol"><img src="../Images/2916db12bdbc108a9f7676bcb0cbf433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0jgBkIvri5aBqtnnemq4VQ.png"/></div></div></figure><p id="3670" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">所以现在truffle.config应该是这样的。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="58ea" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle.js<br/>-------------</span><span id="db2c" class="mh ll hu nd b fv nl ni l nj nk">module.exports = {<br/>  networks: {<br/>    development: {<br/>      host: "localhost",<br/>      port: 8545,<br/>      network_id: "*",<br/>      from: "0x13f53d42fc7cf4f1cf4ca8031a526f6a8528cdfa",<br/>      gas: 1000000,<br/>      gasPrice: 10000000000,<br/>    }<br/>  }<br/>};</span></pre><p id="502d" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这应该能让你顺利上路！</p><h1 id="88b9" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">构建web前端</h1><p id="b3be" class="pw-post-body-paragraph jv jw hu jx b jy mc iv ka kb md iy kd ke me kg kh ki mf kk kl km mg ko kp kq hn dt translated">让我们继续为这个合同实现一个web前端。当然——它已经是公开的，任何人都可以使用……算是吧。使用<code class="eh nm nn no nd b">geth</code>并不是最用户友好的工具，而且你也不能轻易地与一个没有ABI的合同进行交互。所以，我们需要再接再厉，让普通大众也能使用它。</p><p id="486f" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我们将从使用<a class="ae kr" href="https://github.com/ethereum/web3.js/" rel="noopener ugc nofollow" target="_blank"> web3.js </a>并将其连接到我们的本地节点开始。web3.js是什么？来自<a class="ae kr" href="https://github.com/ethereum/web3.js/" rel="noopener ugc nofollow" target="_blank">的自述</a>:</p><blockquote class="mv mw mx"><p id="98cc" class="jv jw my jx b jy jz iv ka kb kc iy kd mz kf kg kh na kj kk kl nb kn ko kp kq hn dt translated">这是以太坊兼容的<a class="ae kr" href="https://github.com/ethereum/wiki/wiki/JavaScript-API" rel="noopener ugc nofollow" target="_blank"> JavaScript API </a>，它实现了<a class="ae kr" href="https://github.com/ethereum/wiki/wiki/JSON-RPC" rel="noopener ugc nofollow" target="_blank">通用JSON RPC </a>规范。</p></blockquote><p id="6fc4" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">让我们回到Ganache CLI，因为它比使用真实网络更快。从<code class="eh nm nn no nd b">ganache-cli</code>开始。重新调整你的<code class="eh nm nn no nd b">truffle.js</code>，重新部署你的合同。找到它的地址。</p><p id="5d88" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">然后从<code class="eh nm nn no nd b">ganache-cli</code>输出中获取第一个账户地址。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="66e5" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ ganache-cli output<br/>-----------------</span><span id="f5c1" class="mh ll hu nd b fv nl ni l nj nk">Available Accounts<br/>==================<br/>(0) 0xa2dee6cd83d3d9cb6fb2d42899abcbdf04bf344f</span></pre><p id="57fc" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我们可以用松露来查询这个账户的余额。为此，我们还将使用web3库，它很方便地包含在truffle中。它告诉我们这个帐户是加载的。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="de22" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle console<br/>------------------</span><span id="3cb5" class="mh ll hu nd b fv nl ni l nj nk">truffle(development)&gt; account = "0xa2dee6cd83d3d9cb6fb2d42899abcbdf04bf344f"<br/>truffle(development)&gt; parseInt(web3.eth.getBalance(account))<br/>'99944815499999920000'</span></pre><p id="73ab" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">太好了！让我们在浏览器中仔细检查一下。<a class="ae kr" href="https://github.com/ethereum/web3.js/blob/develop/dist/web3.js" rel="noopener ugc nofollow" target="_blank">下载web3.js </a>并将其包含在一个带有<code class="eh nm nn no nd b">&lt;script&gt;</code>标签的HTML文件中。在您的浏览器中打开该文件，并将其放入控制台。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="8482" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ browser javascript console<br/>-----------------------------</span><span id="2b91" class="mh ll hu nd b fv nl ni l nj nk">&gt; var host = "<a class="ae kr" href="http://localhost:8545" rel="noopener ugc nofollow" target="_blank">http://localhost:8545</a>"<br/>&gt; var web3 = new Web3(new Web3.providers.HttpProvider(host))<br/>&gt; var account = "0xa2dee6cd83d3d9cb6fb2d42899abcbdf04bf344f"<br/>&gt; parseInt(web3.eth.getBalance(account))<br/>&lt; 99944815499999920000</span></pre><p id="16f7" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">太好了。现在我们知道可以将浏览器连接到Ganache CLI，让我们继续做更好的事情。我们想做的是测试合同的书写和阅读。这是一个开始。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="2c89" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ browser javascript console<br/>-----------------------------</span><span id="4953" class="mh ll hu nd b fv nl ni l nj nk">&gt; var contractABI = JSON.parse('[{"constant":false,"inputs":[{"name":"message","type":"string"}],"name":"record","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_from","type":"address"},{"indexed":false,"name":"_message","type":"string"}],"name":"Record","type":"event"}]');<br/>&gt; var contractAddress = "0x2680998ab6aa13fd092636ec974f5e305a8d9051";<br/>&gt; var web3 = new Web3(new Web3.providers.HttpProvider("<a class="ae kr" href="http://localhost:8545" rel="noopener ugc nofollow" target="_blank">http://localhost:8545</a>"));<br/>&gt; web3.eth.defaultAccount = "0xa2dee6cd83d3d9cb6fb2d42899abcbdf04bf344f";<br/>&gt; var contract = web3.eth.contract(contractABI).at(contractAddress);</span></pre><p id="fd6b" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">好的，我们现在有一个<code class="eh nm nn no nd b">contract</code>实例。让我们试着在上面记录一些东西。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="d6d1" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ browser javascript console<br/>-----------------------------</span><span id="6b64" class="mh ll hu nd b fv nl ni l nj nk">&gt; contract.record("hello from console");<br/>&lt; "0x09506da426e48b5b9a36cda4dd176767a1a3a1392c80299a4b3a16281f10ece3"</span></pre><p id="5a4d" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">哦，看，这是一个交易ID。这一定很棒。让我们检查它的工作情况，好吗？</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="ffda" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ browser javascript console<br/>-----------------------------</span><span id="5ce5" class="mh ll hu nd b fv nl ni l nj nk">&gt; contract.Record({}, {fromBlock: 0, toBlock: "latest"}).get(function (error, results) {<br/>  console.log(results.map((result) =&gt; (result.args._message)));<br/>});<br/>["hello from console"]</span></pre><p id="2e8b" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">好像管用！我们现在准备继续前进。</p><h2 id="9424" class="mh ll hu bd lm mi mj mk lq ml mm mn lu ke mo mp lw ki mq mr ly km ms mt ma mu dt translated">使用元掩码</h2><p id="2f16" class="pw-post-body-paragraph jv jw hu jx b jy mc iv ka kb md iy kd ke me kg kh ki mf kk kl km mg ko kp kq hn dt translated">请注意，我们在上面设置了<code class="eh nm nn no nd b">web3.eth.defaultAccount</code>，并使用了Ganache CLI为我们创建的一个帐户。现在，这对于开发来说是好的，但是当你把它放到网上时，你最好让用户为交易付费。</p><p id="df70" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">输入元掩码。MetaMask是一个Chrome扩展，用作浏览器内以太坊钱包。<strong class="jx hv">你会需要它继续，所以</strong> <a class="ae kr" href="https://metamask.io" rel="noopener ugc nofollow" target="_blank"> <strong class="jx hv">去安装它</strong> </a> <strong class="jx hv">。</strong></p><p id="3ae0" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">此外，要使用MetaMask进行开发，您需要运行一个本地服务器，因为仅仅打开HTML文件是不够的。你喜欢怎么做就怎么做。我喜欢用python。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="65fa" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ shell<br/>--------</span><span id="b34c" class="mh ll hu nd b fv nl ni l nj nk">$ python -m SimpleHTTPServer<br/>Serving HTTP on 0.0.0.0 port 8000 ...</span></pre><p id="d382" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">去掉<code class="eh nm nn no nd b">&lt;script&gt;</code>标签，在浏览器上打开localhost:8000。如果你在控制台中输入<code class="eh nm nn no nd b">web3</code>，你应该看不到<code class="eh nm nn no nd b">undefined</code>。如果是这样，请确保MetaMask正在运行。</p><p id="4046" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">最后，确保元掩码连接到您的本地节点。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff om"><img src="../Images/f5ae8f391139ce271d4bb2b9aeabeaae.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*lb2PvNpzCIX8TMEPLXnfQw.png"/></div></figure><p id="d845" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">让我们再试一次，现在不设置<code class="eh nm nn no nd b">web3.eth.defaultAccount</code>。把这个扔进控制台。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="4754" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ browser javascript console<br/>-----------------------------</span><span id="d66a" class="mh ll hu nd b fv nl ni l nj nk">&gt; var contractABI = JSON.parse('[{"constant":false,"inputs":[{"name":"message","type":"string"}],"name":"record","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_from","type":"address"},{"indexed":false,"name":"_message","type":"string"}],"name":"Record","type":"event"}]');<br/>&gt; var contractAddress = "0x2680998ab6aa13fd092636ec974f5e305a8d9051";<br/>var web3 = new Web3(web3.currentProvider);<br/>var contract = web3.eth.contract(contractABI).at(contractAddress);</span><span id="55ca" class="mh ll hu nd b fv nl ni l nj nk">contract.Record({}, {fromBlock: 0, toBlock: "latest"}).get(function (error, results) {<br/>  console.log(results.map((result) =&gt; (result.args._message)));<br/>});<br/>["hello from console"]</span></pre><p id="a2e2" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">它像预期的那样工作。让我们试着录制另一条消息，并确保我们也能阅读这条消息。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="11cc" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ browser javascript console<br/>-----------------------------</span><span id="7c1c" class="mh ll hu nd b fv nl ni l nj nk">&gt; contract.record("hello again")<br/>Uncaught Error: The MetaMask Web3 object does not support synchronous methods like eth_sendTransaction without a callback parameter</span></pre><p id="eeec" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">啊哦。这是因为MetaMask是一个<a class="ae kr" href="https://github.com/ethereum/wiki/wiki/Light-client-protocol" rel="noopener ugc nofollow" target="_blank">光以太坊客户端</a>。这意味着它不会存储所有的区块链数据，而是每次都向网络请求所需的数据。</p><p id="9afa" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">因此，我们需要使用异步方法来做我们以前做过的事情。提醒你一下，不太复杂。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="820b" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ browser javascript console<br/>-----------------------------</span><span id="9ae5" class="mh ll hu nd b fv nl ni l nj nk">&gt; contract.record("hello again", (error, result) =&gt; (console.log(result)))</span></pre><p id="0a37" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">一旦你这样做了，MetaMask应该弹出这个。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff on"><img src="../Images/bc6c6e4b1a8118d136e40510377abf47.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*x7f-aZL2yGBwCYVsBuJs3A.png"/></div></figure><p id="48a2" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">注意，它说你的余额不足。有道理。让我们向MetaMask为我们创建的这个帐户发送一些资金。首先，找到账户地址。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff on"><img src="../Images/6cae67dc770d4420d8cb2716af2c8224.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*h6Wg9VDgKoZqIvUhn-qakg.png"/></div></figure><p id="c1f2" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在，回到松露。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="a806" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ truffle console<br/>------------------</span><span id="752b" class="mh ll hu nd b fv nl ni l nj nk">truffle(development)&gt; web3.eth.sendTransaction({<br/>  from: web3.eth.accounts[0],<br/>  to: "0x6a7eB27407a50a4eb9d015EA2B0F2e1BcC724461",<br/>  value: 5000000000000000}<br/>)</span></pre><p id="7fce" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在让我们再次尝试相同的命令。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="79cc" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ browser javascript console<br/>-----------------------------</span><span id="abc5" class="mh ll hu nd b fv nl ni l nj nk">&gt; contract.record("hello again", (error, result) =&gt; (console.log(result)))</span></pre><p id="0546" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这一次，弹出窗口应该没有错误消息。单击发送。您应该能够在Ganache CLI上看到类似这样的内容。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="fb5d" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ ganache-cli output<br/>-----------------</span><span id="3804" class="mh ll hu nd b fv nl ni l nj nk">eth_sendRawTransaction</span><span id="169d" class="mh ll hu nd b fv nl ni l nj nk">Transaction: 0xfd78adcb6bd3aa86d6e67e5edc946ca3b53235553d4cc5a409c3566bdafb13f6<br/>  Gas usage: 25025<br/>  Block Number: 24<br/>  Block Time: Wed Nov 22 2017 15:58:27 GMT+0100 (CET)</span></pre><p id="79c6" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">成功了吗？好吧，让我们来看看！</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="bbaf" class="mh ll hu nd b fv nh ni l nj nk">ℹ️ browser javascript console<br/>-----------------------------</span><span id="be9a" class="mh ll hu nd b fv nl ni l nj nk">&gt; contract.Record({}, {fromBlock: 0, toBlock: "latest"}).get(function (error, results) {<br/>  console.log(results.map((result) =&gt; (result.args._message)));<br/>});<br/>["hello from console", "hello again"]</span></pre><p id="1d18" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这是两条信息。成功！</p><p id="1d4a" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">从这里开始，您将从Ganache CLI切换到Ropsten，然后是以太坊mainnet。在这篇文章中，我就不重复了。</p><h1 id="8888" class="lk ll hu bd lm ln lo lp lq lr ls lt lu ja lv jb lw jd lx je ly jg lz jh ma mb dt translated">最终注释</h1><p id="9468" class="pw-post-body-paragraph jv jw hu jx b jy mc iv ka kb md iy kd ke me kg kh ki mf kk kl km mg ko kp kq hn dt translated">为了让<a class="ae kr" href="https://forever.lifeonmars.pt/" rel="noopener ugc nofollow" target="_blank">永远在链</a>上按预期工作，我们必须做几件额外的事情(除了建立网站之外)。</p><p id="3760" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">为了让“保存的消息”列表用新条目更新自己，我们决定使用<a class="ae kr" href="https://github.com/ethereum/wiki/wiki/JavaScript-API#contract-events" rel="noopener ugc nofollow" target="_blank">事件观察方法</a>。这就建立了一个监听器，每当一个符合您喜欢的任何标准的事件出现在链上时，这个监听器就调用您的回调。我们是这样做的。</p><pre class="jk jl jm jn fq nc nd ne nf aw ng dt"><span id="abd9" class="mh ll hu nd b fv nh ni l nj nk">contract.Record(<br/>  {},<br/>  {fromBlock: 4491369, toBlock: "latest"}<br/>).watch(function (error, result) {<br/>  // DO THINGS<br/>});</span></pre><p id="a42b" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">注意那上面的<code class="eh nm nn no nd b">4491369</code>。由于我们连接到mainnet，从block 0清除所有事务会非常慢。因此，我们将我们的搜索限制在从契约部署到的块的块号开始的事件。你可以通过使用以太扫描找到那个号码，但是如果你知道合同是在什么交易中产生的，那么<a class="ae kr" href="https://github.com/ethereum/wiki/wiki/JavaScript-API#web3ethgettransaction" rel="noopener ugc nofollow" target="_blank"> web3也可以帮助你</a>。</p><p id="60cd" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">尽管这非常简单，<a class="ae kr" href="https://github.com/MetaMask/metamask-extension/issues/2114" rel="noopener ugc nofollow" target="_blank"> MetaMask对这个</a>并不满意，所以我们最终在EC2实例上部署了一个light节点。</p><p id="7a42" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这个项目的代码是<a class="ae kr" href="https://github.com/lifeonmarspt/ethereum-eventer" rel="noopener ugc nofollow" target="_blank">，可以在GitHub </a>上找到。</p></div></div>    
</body>
</html>