<html>
<head>
<title>Integrating TensorFlow Model in an iOS App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在iOS应用中集成TensorFlow模型</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/integrating-tensorflow-model-in-an-ios-app-cecf30b9068d?source=collection_archive---------6-----------------------#2017-12-18">https://medium.com/hackernoon/integrating-tensorflow-model-in-an-ios-app-cecf30b9068d?source=collection_archive---------6-----------------------#2017-12-18</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/9599240f991b5a88a0c12915105ecb77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hOIvJZvw75Gqq2PJ-trbUw.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae jg" href="http://tomtunguz.com/images/ml_icons.jpg" rel="noopener ugc nofollow" target="_blank">http://tomtunguz.com/images/ml_icons.jpg</a></figcaption></figure><p id="b6a6" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">苹果在WWDC 2017上发布了Core ML framework，允许开发者将机器学习集成到他们的<a class="ae jg" href="https://hackernoon.com/tagged/ios" rel="noopener ugc nofollow" target="_blank"> iOS </a>应用中。为了开始，苹果提供了一份与核心ML框架兼容的<a class="ae jg" href="https://developer.apple.com/machine-learning/" rel="noopener ugc nofollow" target="_blank">列表</a>。这些模型已经可以使用，并且可以集成到iOS应用程序中。</p><p id="0fae" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">但是如果你必须使用深度学习来训练自己的模型呢？幸运的是，谷歌提供了一个名为<a class="ae jg" href="http://tensorflow.org/" rel="noopener ugc nofollow" target="_blank"> TensorFlow </a>的开源库，它能够基于数值计算创建深度学习图。这意味着你可以开发一个符合你需求的定制深度学习模型。使用TensorFlow已经创建了许多不同的模型，但不幸的是，在iOS应用程序中使用它们需要大量的工作。最近，Google发布了一个工具“<a class="ae jg" href="https://github.com/tf-coreml/tf-coreml" rel="noopener ugc nofollow" target="_blank"> <strong class="jj hv"> tfcoreml </strong> </a>”，它允许开发者将TensorFlow模型转换为coreml模型。</p><p id="8ed2" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在这篇文章中，我将解释如何使用tfcoreml工具将TensorFlow模型转换成coreml模型。这个过程很复杂，我花了几天时间才弄明白。特别感谢Google tfcoreml团队的持续支持。</p><h1 id="5d2f" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">安装tfcoreml</h1><p id="b8aa" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">安装tfcoreml工具有多种方式。最快的方法是使用pip工具来安装它。</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="f010" class="lr kg hu ln b fv ls lt l lu lv">pip install -U tfcoreml</span></pre><p id="cca1" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在撰写本文时，我建议不要采用上述方法。原因是在master branch中对tfcoreml工具的源代码进行了一些修复，这些修复只有在您从源代码构建工具时才可用。</p><p id="2785" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">要从源安装，您必须克隆tfcoreml存储库。</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="0cdb" class="lr kg hu ln b fv ls lt l lu lv">git clone <a class="ae jg" href="https://github.com/tf-coreml/tf-coreml.git" rel="noopener ugc nofollow" target="_blank">https://github.com/tf-coreml/tf-coreml.git</a></span></pre><p id="09b6" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">一旦存储库被克隆，进入目录并运行以下命令:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="741f" class="lr kg hu ln b fv ls lt l lu lv">python setup.py bdist_wheel</span></pre><p id="6cd0" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">最后，使用以下命令安装软件包:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="d271" class="lr kg hu ln b fv ls lt l lu lv">pip install -e .</span></pre><p id="c667" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">恭喜您成功安装了tfcoreml工具！</p><h1 id="ce69" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">转换张量流模型</h1><p id="0a49" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">在执行实际转换之前，让我们先了解一下张量流模型。您可以在<a class="ae jg" href="https://github.com/tf-coreml/tf-coreml" rel="noopener ugc nofollow" target="_blank">文档</a>的末尾找到几个TensorFlow兼容模型。我们将使用“Inception v1 (Slim)”模型进行演示。下载该模型，您会注意到它包含两个文件。</p><ul class=""><li id="508a" class="lw lx hu jj b jk jl jo jp js ly jw lz ka ma ke mb mc md me dt translated">inception _ v1 _ 2016 _ 08 _ 28 _ frozen . Pb</li><li id="ef54" class="lw lx hu jj b jk mf jo mg js mh jw mi ka mj ke mb mc md me dt translated">imagenet_slim_labels.txt</li></ul><p id="f2d3" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">文件“<strong class="jj hv">inception _ v1 _ 2016 _ 08 _ 28 _ frozen . Pb</strong>”是实际模型，“<strong class="jj hv">imagenet _ slim _ labels . txt</strong>”是类标签。您可以将类标签视为将附加到每个预测的标签/标题。</p><p id="82f3" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在文档中，您会看到以下转换代码:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="967b" class="lr kg hu ln b fv ls lt l lu lv">import tfcoreml as tf_converter<br/>tf_converter.convert(tf_model_path = 'my_model.pb',<br/>                     mlmodel_path = 'my_model.mlmodel',<br/>                     output_feature_names = ['softmax:0'])</span></pre><p id="0670" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我创建了一个名为“<strong class="jj hv">converter . py</strong>的文件，并将上述所有代码放在该文件中。如你所见，我已经用正确的文件名替换了变量。</p><figure class="li lj lk ll fq iv"><div class="bz el l di"><div class="mk ml l"/></div></figure><p id="8edd" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">转到TensorFlow模型所在文件夹内的终端，执行<a class="ae jg" href="https://hackernoon.com/tagged/python" rel="noopener ugc nofollow" target="_blank"> Python </a>脚本。</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="c079" class="lr kg hu ln b fv ls lt l lu lv">python convertor.py </span></pre><figure class="li lj lk ll fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mm"><img src="../Images/f6b07ca38197b270a1ab3d2cdc096c85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z0AfohWUFFKofJzgq_oVxg.png"/></div></div></figure><p id="6b10" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">欢迎来到将TensorFlow模型转换为Core ML的奇妙世界！我知道你在想什么，这是什么意思。Google的好心人帮我解释说，要让tfcoreml工具工作，我需要传递正确的操作符。为了找到操作符，可以将TensorFlow模型转换为文本摘要，并在文本文件中搜索操作符。</p><p id="03f0" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">TensorFlow工具已经包含用于将模型转换为基于文本的摘要的Python脚本。您可以在以下位置查看该脚本的实现:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="b751" class="lr kg hu ln b fv ls lt l lu lv"><a class="ae jg" href="https://github.com/tf-coreml/tf-coreml" rel="noopener ugc nofollow" target="_blank">tf-coreml</a>/<a class="ae jg" href="https://github.com/tf-coreml/tf-coreml/tree/master/utils" rel="noopener ugc nofollow" target="_blank">utils</a>/inspect_pb.py</span></pre><p id="69a2" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我已经将<strong class="jj hv"> inspect_pb.py </strong>文件复制到我的本地文件夹中，这样会更容易引用它。下面的代码展示了如何将TensorFlow模型转换成文本摘要。</p><figure class="li lj lk ll fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mn"><img src="../Images/7b9adaadf9cd16be250f52dd1b7d9781.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kv4yGHDv7YfHajE514F4qg.png"/></div></div></figure><p id="7592" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">生成“<strong class="jj hv"> text_summary.txt </strong>”文件。在文件的末尾，您将看到特定型号的所有操作符的列表。</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="d973" class="lr kg hu ln b fv ls lt l lu lv">OPS counts:<br/>Squeeze : 1<br/><strong class="ln hv">Softmax : 1</strong><br/>BiasAdd : 1<br/>Placeholder : 1<br/>AvgPool : 1<br/>Reshape : 2<br/>ConcatV2 : 9<br/>MaxPool : 13<br/>Sub : 57<br/>Rsqrt : 57<br/>Relu : 57<br/>Conv2D : 58<br/>Add : 114<br/>Mul : 114<br/>Identity : 231<br/>Const : 298</span></pre><p id="71b6" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在，让我们搜索Softmax，您会发现几个不同的条目。我突出显示了与输出特征名称相对应的名称，如下所示:</p><figure class="li lj lk ll fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mo"><img src="../Images/c61a82dbc40c942556cbd43a11934440.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Myo0GFKt7C70QMwtOfN5Q.png"/></div></div></figure><p id="f2f4" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在，使用新的"<strong class="jj hv"> output_feature_names </strong>"参数更新转换器文件，如下所示:</p><figure class="li lj lk ll fq iv"><div class="bz el l di"><div class="mk ml l"/></div></figure><p id="dbfb" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">从终端再次运行convertor.py。这一次转换将成功完成，如下所示:</p><figure class="li lj lk ll fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mn"><img src="../Images/2eeeda8e900756b05a1ba61a77b5e223.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ddJQqLrujaN4OwekMrdVSA.png"/></div></div></figure><p id="cd3a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">将生成核心ML模型“InceptionV1.mlmodel”。继续并双击生成的模型。这将在Xcode中打开它，如下所示:</p><figure class="li lj lk ll fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mp"><img src="../Images/d176b24a5b096869dd8f50a4570fa289.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K3LlZafGQ4ACVau4-dkzpA.png"/></div></div></figure><p id="b48b" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">虽然已经成功地创建了模型，但它对我们来说并不真正有用，因为我们希望我们的模型将图像作为图像参数，并且还提供类标签来标识检测到的对象。</p><p id="1698" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">幸运的是，我们已经可以访问类标签文件"<strong class="jj hv">imagenet _ slim _ labels . txt</strong>，并且我们可以使用text_summary.txt文件来找出提供<strong class="jj hv"> image_input_names </strong>所需的操作符。更新后的代码“<strong class="jj hv">converter . py</strong>”如下所示:</p><figure class="li lj lk ll fq iv"><div class="bz el l di"><div class="mk ml l"/></div></figure><p id="ce0e" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">跳到终端上，运行convertor.py文件，如下所示:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="9848" class="lr kg hu ln b fv ls lt l lu lv">python convertor.py </span></pre><p id="f560" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">查看下面截图中生成的模型:</p><figure class="li lj lk ll fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mq"><img src="../Images/596b6d729f66f766e77764a3bfde36e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rs2ipsAcfDPJ7dbNAZ1v5Q.png"/></div></div></figure><p id="2966" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">Wohoo！！！我们以图像的形式获得输入，以预测字典和分类标签的形式获得输出。</p><p id="ae95" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">让我们将这个模型导入到我们的iOS项目中，看看预测结果。我已经有了一个核心的ML iOS项目设置，可以从<a class="ae jg" href="https://github.com/azamsharp/TensorFlowToCoreML" rel="noopener ugc nofollow" target="_blank"> Github </a>下载。我简单地把这个模型插入，这是我得到的结果。</p><figure class="li lj lk ll fq iv fe ff paragraph-image"><div class="fe ff mr"><img src="../Images/d12bee3866effadaeb09c6cf47ca5d87.png" data-original-src="https://miro.medium.com/v2/resize:fit:694/format:webp/1*htF5KifLAO-8v8SzSvAeIQ.png"/></div></figure><p id="bf55" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">香蕉！没错。不幸的是，转换后的模型预测相差甚远。在与谷歌开发人员交谈后，他们认为这是因为图像在使用前需要预处理。这意味着我们需要更新我们的“<strong class="jj hv">converter . py</strong>”来包含图像的预处理。如下所示:</p><figure class="li lj lk ll fq iv"><div class="bz el l di"><div class="mk ml l"/></div></figure><p id="5d05" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">从终端再次运行“convertor.py ”,它将生成一个新模型。将模型导入到iOS应用程序中，你会发现现在预测正确了。</p><figure class="li lj lk ll fq iv fe ff paragraph-image"><div class="fe ff mr"><img src="../Images/844a6a2ddb0f7b0300cbd2080145e0bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:694/format:webp/1*OJ7xp68tKwfJ5ETfsrt94w.png"/></div></figure><p id="0c1b" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">恭喜您，您已成功将TensorFlow模型转换为Core ML，并将其集成到您的应用中！</p><p id="e681" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果你想支持我的写作并了解更多关于核心ML的知识，请查看我的课程“<a class="ae jg" href="https://www.udemy.com/mastering-core-ml-for-ios/?couponCode=ILOVECOREMLBONUS" rel="noopener ugc nofollow" target="_blank">掌握iOS核心ML</a>”。请务必对课程进行评分和复习，因为它有助于添加更多精彩的内容。</p><p id="d581" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><a class="ae jg" href="https://github.com/azamsharp/TensorFlowToCoreML" rel="noopener ugc nofollow" target="_blank"> Github </a></p><p id="ce0a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">谢谢你，</p><p id="5466" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">阿扎姆</p><figure class="li lj lk ll fq iv"><div class="bz el l di"><div class="ms ml l"/></div></figure></div></div>    
</body>
</html>