<html>
<head>
<title>Master-Master Replication and Scaling of an Application between Each of the IoT Devices and the Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">每个物联网设备和云之间应用的主-主复制和扩展</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/master-master-replication-and-scaling-of-an-application-between-each-of-the-iot-devices-and-the-69c286f1b0d3?source=collection_archive---------13-----------------------#2017-01-16">https://medium.com/hackernoon/master-master-replication-and-scaling-of-an-application-between-each-of-the-iot-devices-and-the-69c286f1b0d3?source=collection_archive---------13-----------------------#2017-01-16</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/70d26a28d1e6cf7b3eeaa415c405674f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u4nqyMcGU8nc1tZGdFTBwg.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Photo showing the devices used for prototyping. As you can plainly see, I’m using Intel Edison, as it supports many microcomputers, like MIPS, ARM and so on.</figcaption></figure></div><div class="ab cl jg jh hc ji" role="separator"><span class="jj bw bk jk jl jm"/><span class="jj bw bk jk jl jm"/><span class="jj bw bk jk jl"/></div><div class="hn ho hp hq hr"><p id="af32" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">在这篇文章中，我想与你分享我是如何解决一个非常有趣的问题，即在物联网设备和云应用程序之间同步数据。</p><p id="bbcc" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">我将从概述我的项目的总体想法和目标开始。然后我将更详细地描述我的实现。这将是一个技术上更先进的部分，我会谈到Contiki OS，数据库，协议等。最后，我将总结我用来实现整个系统的技术。</p><blockquote class="kl km kn"><p id="c408" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk hn dt translated"><strong class="jp hv">项目概述</strong></p></blockquote><p id="bb63" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">所以，先说一下大概的思路。</p><p id="eacc" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">这里有一个图解说明整个系统的最终状态:</p><figure class="kt ku kv kw fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ks"><img src="../Images/4e8b25530c7fbe221abebf70ec92cc41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mU43DP91EAY8lUloby4MVw.png"/></div></div></figure><p id="1822" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">我有一个用户可以通过云服务或直接(通过Wi-Fi)连接到物联网设备。</p><p id="4f0d" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">此外，我在云中的某个地方有一个应用服务器，而云本身在互联网上的某个地方。这个云可以是任何东西——例如，AWS或Azure实例，或者它可以是专用服务器，它可以是任何东西:)</p><p id="5730" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">应用服务器通过某种协议连接到物联网设备。我需要这个连接来在应用服务器和物联网设备之间交换数据。</p><p id="e3fe" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">物联网设备以某种方式相互连接(比如，通过以太网或Wi-Fi)。</p><p id="c70f" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">此外，我有更多的物联网设备生成一些遥测数据，如光线或温度读数。可以有100多个甚至1000多个设备。</p><p id="b8d5" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">基本上，我的目标是让云和这些物联网设备之间的数据交换成为可能。</p><p id="06c8" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">在继续之前，让我概述一下我的系统的一些要求:</p><ul class=""><li id="18b1" class="kx ky hu jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf dt translated"><em class="ko">它应该在物联网设备之间同步数据。</em></li><li id="a041" class="kx ky hu jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf dt translated"><em class="ko">它应该从物联网设备收集数据。</em></li><li id="a96a" class="kx ky hu jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf dt translated"><em class="ko">它应该在物联网设备和云之间同步数据。</em></li></ul><blockquote class="kl km kn"><p id="e717" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk hn dt translated"><strong class="jp hv">实施</strong></p></blockquote><figure class="kt ku kv kw fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ll"><img src="../Images/3c3c96a5e79c2dd3b1e15fe36b0ea39c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3W-kJgnjAkLmHzqxkqxZ9A.png"/></div></div></figure><p id="130b" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">这非常简单:用户通过HTTP(S)或WebSocket或类似的协议连接到应用服务器。</p><p id="4a4d" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">好吧，给你一个小测验。您认为可以使用什么将应用服务器连接到物联网设备？</p><figure class="kt ku kv kw fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lm"><img src="../Images/7604144c92f8ec1affd54d1f462e696f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ifYYkyAh4H8LUQyffq3CNA.png"/></div></div></figure><p id="c29a" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">如果你想到了MQTT，那你肯定是对的！选择HTTP(S)的人也是如此。事实上，它可能是任何协议！就选一个然后搞定它。</p><p id="887e" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">我的选择是异步复制！我说的是数据库中常见的复制。</p><figure class="kt ku kv kw fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ln"><img src="../Images/497a078b27845457cf998710f527ac6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iGnQnsn7Me75D_u9jAfaHQ.png"/></div></div></figure><p id="e887" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">你可能想知道复制是如何帮助我的。基本上，复制是为了同步数据而存在的。因此，我可以在所有设备上维护相同的数据库，包括云和物联网设备。</p><p id="42e6" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">不过，复制很难实现。如果您想要复制，您需要有一个支持它的数据库。因为复制是数据库的一个自然特性。</p><p id="bd09" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">在这里，我想说一下我为这个项目考虑的数据库:<a class="ae lo" href="https://en.wikipedia.org/wiki/SQLite" rel="noopener ugc nofollow" target="_blank"> SQLite </a>、<a class="ae lo" href="https://en.wikipedia.org/wiki/Redis" rel="noopener ugc nofollow" target="_blank"> Redis </a>、<a class="ae lo" href="https://en.wikipedia.org/wiki/MySQL" rel="noopener ugc nofollow" target="_blank"> MySQL </a>、<a class="ae lo" href="https://en.wikipedia.org/wiki/PostgreSQL" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>和<a class="ae lo" href="https://en.wikipedia.org/wiki/Tarantool" rel="noopener ugc nofollow" target="_blank"> Tarantool </a>。</p><p id="85c9" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">我比较了它们的特征，并尝试在物联网设备上直接运行其中的一些(MySQL和PostgreSQL除外)，并希望分享我得到的结果。</p><p id="4914" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">SQLite绝对是在物联网设备上直接存储数据的好选择，但它没有复制功能，也不真正支持不同进程的并发访问。</p><p id="08c9" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">Redis不支持主-主复制，所以它不能解决我的问题，因为我需要双向复制。</p><p id="4daf" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">MySQL和PostgreSQL对于一个物联网设备来说太重了。我甚至没有试图安装它们。但是如果你决定尝试MySQL或PostgreSQL，请在下面的评论中分享你的经验。</p><p id="32cd" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">我名单上的最后一个数据库是Tarantool。事实上，我是Tarantool项目的委托人，所以我知道开发它的人。当然，这对我来说是一个很好的选择，因为我很了解这个项目。当然，Tarantool有主-主复制。你也可以用它来尝试其他的东西。我在这里的主要观点是，物联网设备可以通过主-主复制来利用真实数据库进行数据传输。</p><p id="efed" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">但是到目前为止，我们只是触及了表面，所以现在让我们更深入地研究实现。</p><p id="31c4" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">我先说我和塔兰图尔的问题。</p><p id="3366" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">首先，Tarantool不能在ARMv7架构上工作。更糟糕的是，Tarantool无法在32位环境中运行(只有64位)。</p></div><div class="ab cl jg jh hc ji" role="separator"><span class="jj bw bk jk jl jm"/><span class="jj bw bk jk jl jm"/><span class="jj bw bk jk jl"/></div><div class="hn ho hp hq hr"><p id="ec5a" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">我设法解决了这些问题，我想分享我的开发规则，这些规则帮助我完成了这件事:</p><ol class=""><li id="7aa7" class="kx ky hu jp b jq jr ju jv jy kz kc la kg lb kk lp ld le lf dt translated"><strong class="jp hv"> <em class="ko">为CMake使用工具链文件。</em> </strong> <em class="ko"> <br/>否则，你会像我一样浪费很多时间修补你的CMake文件。</em></li><li id="7add" class="kx ky hu jp b jq lg ju lh jy li kc lj kg lk kk lp ld le lf dt translated"><strong class="jp hv"> <em class="ko">不要使用无符号和其他没有指定大小的类型。libc对此有特殊的类型，比如uint32_t。否则，你会得到未定义的行为。这条规则只适用于C/C++代码。</em></strong></li><li id="c3b4" class="kx ky hu jp b jq lg ju lh jy li kc lj kg lk kk lp ld le lf dt translated"><strong class="jp hv"> <em class="ko">移植你的自动测试。</em> </strong> <em class="ko"> <br/>你应该期待你的自动测试可以在物联网设备上执行。否则，您将花费大量时间来修复bug。</em></li></ol></div><div class="ab cl jg jh hc ji" role="separator"><span class="jj bw bk jk jl jm"/><span class="jj bw bk jk jl jm"/><span class="jj bw bk jk jl"/></div><div class="hn ho hp hq hr"><p id="69a9" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">好的，我有一个主-主复制的工作数据库。到目前为止一切顺利！我的下一步是通过<a class="ae lo" href="https://en.wikipedia.org/wiki/6LoWPAN" rel="noopener ugc nofollow" target="_blank"> 6LoWPAN </a>连接运行这个数据库的设备。</p><p id="46b4" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">回想一下，我在一个6LoWPAN网络中有许多互联的物联网设备。我需要收集他们所有的遥测数据。</p><figure class="kt ku kv kw fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lq"><img src="../Images/31a099f63cb1020306c1ecff1d4cb881.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KqM_3YAheQnJvRZabJR0KA.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Here’s a brief visual explanation of how this whole setup works</figcaption></figure><p id="43e0" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">带有传感器的设备通过无线电波传输遥测数据。这个标准被称为6LoWPAN，是低功率无线个人区域网上IPv6的首字母缩写。</p><p id="21b1" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">我想指出的是，我没有使用<a class="ae lo" href="https://en.wikipedia.org/wiki/LPWAN" rel="noopener ugc nofollow" target="_blank">劳拉茵</a>。不过，我将来可能会用到它。在本文中，我将只关注6LoWPAN。</p><p id="e3f9" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">因此，遥测数据由网关收集，网关是系统的重要组成部分。网关是一种MIPS设备，提醒您一下，MIPS是一个处理器家族，它有一个WAN天线，用于收集通过无线电波传输的数据。此外，网关安装了6LBR软件，帮助将通过无线电波接收的数据转换为IPv6数据包。</p></div><div class="ab cl jg jh hc ji" role="separator"><span class="jj bw bk jk jl jm"/><span class="jj bw bk jk jl jm"/><span class="jj bw bk jk jl"/></div><div class="hn ho hp hq hr"><blockquote class="kl km kn"><p id="27a5" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk hn dt translated"><strong class="jp hv"> 6LBR应用</strong></p></blockquote><figure class="kt ku kv kw fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lr"><img src="../Images/f865191829cd3d0178cd25b30f89d6ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MBrCwOGpOgn3EHFDDX763g.png"/></div></div></figure><p id="2b92" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">上图说明了6LBR的工作流程。安装了6LBR软件的网关是无线传感器网络和任何其他网络之间的转换器。</p><p id="e83c" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">此图显示了从无线传感器网络到IP网络的转换，因为这是6LBR的默认行为。我将在后面解释如何改变这种行为。</p><p id="f505" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">欲了解更多信息，请查看此链接至<a class="ae lo" href="https://github.com/cetic/6lbr" rel="noopener ugc nofollow" target="_blank"> 6LBR GitHub页面</a>。</p><p id="1d14" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">你可能会问，“6LBR到底为我做了什么？”</p><p id="bf93" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">首先，它给了我一个IP栈，所以我可以在我的6LBR应用程序中使用TCP和UDP栈的所有特性。</p><p id="3df1" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">第二，我可以用6LBR使用任何I/O设备。比方说，我可以将原始数据直接写入bash =)</p><p id="7d76" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">遗憾的是，6LBR不能直接写入MQTT。MQTT经纪人对原始数据一无所知。可悲，但却是真的！</p><p id="98bb" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">但是为什么我首先需要直接写给MQTT代理呢？答案是遗产。</p><p id="cc54" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">这里我想说几句6LBR的应用。</p><p id="cea1" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">一般来说，6LBR应用程序是带有6LBR API的C代码，允许使用IP堆栈和做其他事情。开发这样的应用程序与至少两个主要困难相关联:复杂的线程模型和复杂的内存模型。也就是说，如果你想创建一个6LBR应用程序，你必须准备好许多segfaults。</p><p id="ae43" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">下面是我的6LBR应用程序的一个片段(抱歉，我只能给出一个模糊代码的截图，真实的源代码是封闭的):</p><figure class="kt ku kv kw fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ls"><img src="../Images/408aa7545588dd466beb9c07ca804301.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P0--ugXhUge5QLXqB2waug.png"/></div></div></figure><p id="18c2" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">注意这里有一件有趣的事情— PROCESS_YIELD()。6LBR具有协作式多任务处理，这意味着6LBR应用程序必须让步，并且它们在每次循环迭代中都这样做。代码不应该运行太长时间。</p></div><div class="ab cl jg jh hc ji" role="separator"><span class="jj bw bk jk jl jm"/><span class="jj bw bk jk jl jm"/><span class="jj bw bk jk jl"/></div><div class="hn ho hp hq hr"><p id="0c57" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">让我们回顾一下目前项目的进展情况。</p><p id="0a72" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">6LBR网关使我能够创建一个网状网络，因此我可以在其中读取和写入数据。此外，我能够将IP包包装到MQTT消息中，每个消息都包含有关设备的信息，包括遥测数据。此外，我有能力操纵输入输出设备。例如，我能够将MQTT消息写入UART。但随后我面临一个新问题:Tarantool不与MQTT经纪人合作。</p><p id="14c1" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">我是这样解决这个问题的。</p><p id="952f" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">我决定使用用普通C语言编写的MQTT库<a class="ae lo" href="https://mosquitto.org/man/libmosquitto-3.html" rel="noopener ugc nofollow" target="_blank">libmosquito</a>，作为将MQTT集成到我的应用程序中的一种简单且可移植的方式。</p><p id="292f" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">下面的代码片段展示了如何使用这个库来处理MQTT消息(<a class="ae lo" href="https://github.com/tarantool/mqtt" rel="noopener ugc nofollow" target="_blank">链接</a>):</p><figure class="kt ku kv kw fq iv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="631d" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">我可以引用一个套接字文件句柄，并使用我自己的事件循环来处理一些事件。很好，对吧？</p><p id="7afe" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">我想提醒你注意一个事实，那就是<a class="ae lo" rel="noopener ugc nofollow" target="_blank" href="/"> Tarantool </a>也有协同多任务处理功能，和6LBR一样。对于产量，Tarantool使用coio_wait()。</p><p id="3008" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">哦，忘了说<a class="ae lo" href="https://github.com/tarantool/tarantool" rel="noopener ugc nofollow" target="_blank"> Tarantool </a>是Lua应用服务器。惊喜！</p><p id="6640" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">所以，为了在Lua中使用这段代码，我移植了libmosquitto。</p><p id="7773" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">下面是一个例子，我调用了你在前面的代码片段中看到的函数:</p><figure class="kt ku kv kw fq iv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="8ed4" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">另外，我从libmosquitto API移植了所有函数。你可以在这里查看这个端口<a class="ae lo" href="https://github.com/tarantool/mqtt" rel="noopener ugc nofollow" target="_blank">。这里有一个如何使用的</a><a class="ae lo" href="https://github.com/tarantool/mqtt/blob/master/examples/producer_consumer_queue.lua" rel="noopener ugc nofollow" target="_blank">示例</a>。</p><p id="f6ad" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">为了从网状网络中的所有设备获取数据，我需要从特定位置调用subscribe()函数并发布get()方法。这就是与网状网络中的设备进行通信所需的一切！</p><blockquote class="kl km kn"><p id="22f3" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk hn dt translated"><strong class="jp hv">总结</strong></p></blockquote><p id="a721" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">现在让我们来看看最终的设置:</p><figure class="kt ku kv kw fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lv"><img src="../Images/6015d8de8a81ceed323712fa0fccb287.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GWQ-pYyBG3jtyyXbN6ZhkA.png"/></div></div></figure><p id="b640" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">应用服务器通过Tarantool的主-主复制进行连接。这给了我两个特点:</p><ol class=""><li id="8bc5" class="kx ky hu jp b jq jr ju jv jy kz kc la kg lb kk lp ld le lf dt translated">当应用服务器更改任何数据集时，这些更改将被传送到网络中的所有物联网设备。</li><li id="4cb8" class="kx ky hu jp b jq lg ju lh jy li kc lj kg lk kk lp ld le lf dt translated">当物联网设备更改任何数据集时，这些更改将被传送到应用服务器。</li></ol><p id="fb94" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">这两个特性是我问题的解决方案。</p><p id="0bb5" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">此外，我可以通过主-主复制连接我的物联网设备。这将它们和云捆绑成一个集群，允许我同步所有数据集。所有物联网设备和云在大部分时间都是同步的，除非连接中断。但一旦备份，它们会很快再次同步。是不是很酷！</p><p id="b707" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">6LBR网关允许在我的物联网设备和其他物联网设备之间交换数据集。它将每个消息包装成一个MQTT消息，并将它们传递到一个UART通道。</p><p id="1b23" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">安装了MQTT代理的IoT设备#N从UART通道读取这些消息。MQTT代理通过MQTT连接将消息重定向到Tarantool。Tarantool读取它们，然后Tarantool的应用服务器为每条消息执行一些代码。</p><p id="d377" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">物联网设备#N通过Tarantool的主-主复制连接到所有其他设备。云与每个物联网设备也通过Tarantool的主-主复制连接在一起。</p></div><div class="ab cl jg jh hc ji" role="separator"><span class="jj bw bk jk jl jm"/><span class="jj bw bk jk jl jm"/><span class="jj bw bk jk jl"/></div><div class="hn ho hp hq hr"><p id="b7d2" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">好了，这就结束了！我已经设法解决了这个问题，我真的希望我的经验能在将来帮助你。重申一下，我使用Tarantool作为专用服务器的主前端和应用服务器。如果你感兴趣并想了解更多，查看这篇<a class="ae lo" href="https://hackernoon.com/shrink-the-number-of-tiers-in-a-multitier-architecture-from-5-to-2-c59b7bf46c86#.3uwawab8w" rel="noopener ugc nofollow" target="_blank">文章</a>。</p><p id="5782" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">敬请期待更多精彩内容！</p><div class="kt ku kv kw fq ab cb"><figure class="lw iv lx ly lz ma mb paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="lw iv lx ly lz ma mb paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="lw iv lx ly lz ma mb paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="kl km kn"><p id="f922" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk hn dt translated"><a class="ae lo" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae lo" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae lo" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae lo" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae lo" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae lo" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kt ku kv kw fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mc"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>