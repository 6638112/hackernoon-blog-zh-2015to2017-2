<html>
<head>
<title>XPath tips from the web scraping trenches</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从网上搜集的XPath技巧</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/xpath-tips-from-the-web-scraping-trenches-fda06b0bf0a8?source=collection_archive---------0-----------------------#2016-11-11">https://medium.com/hackernoon/xpath-tips-from-the-web-scraping-trenches-fda06b0bf0a8?source=collection_archive---------0-----------------------#2016-11-11</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="8e93" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在web抓取的上下文中，<a class="ae jp" href="http://en.wikipedia.org/wiki/XPath" rel="noopener ugc nofollow" target="_blank"> XPath </a>是一个很好的随身工具，因为它允许您比CSS选择器更灵活地编写文档位置的规范。如果你正在寻找一个教程，<a class="ae jp" href="http://www.zvon.org/comp/r/tut-XPath_1.html" rel="noopener ugc nofollow" target="_blank">这里有一个XPath教程，有很好的例子</a>。</p><p id="805e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本帖中，我们将向您展示一些我们发现在战壕中使用XPath时很有价值的技巧，以<a class="ae jp" href="http://doc.scrapy.org/en/latest/topics/selectors.html" rel="noopener ugc nofollow" target="_blank"> Scrapy选择器API </a>为例。</p><h1 id="8660" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">避免使用包含(。//text()，' search text ')。</h1><p id="ebb8" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">使用包含(。，'搜索文本')。</p><p id="a6a1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">原因如下:表达式<code class="eh kt ku kv kw b">.//text()</code>产生一个文本元素集合——一个<em class="kx">节点集</em>。当一个节点集被转换成一个字符串时，当它作为参数传递给一个字符串函数如<code class="eh kt ku kv kw b">contains()</code>或<code class="eh kt ku kv kw b">starts-with()</code>时，只产生第<strong class="it hv">个</strong>元素的文本。</p><pre class="ky kz la lb fq lc kw ld le aw lf dt"><span id="833a" class="lg jr hu kw b fv lh li l lj lk">&gt;&gt;&gt; from scrapy import Selector<br/>&gt;&gt;&gt; sel = Selector(text='&lt;a href="#"&gt;Click here to go to the &lt;strong&gt;Next Page&lt;/strong&gt;&lt;/a&gt;')<br/>&gt;&gt;&gt; xp = lambda x: sel.xpath(x).extract() # let's type this only once<br/>&gt;&gt;&gt; xp('//a//text()') # take a peek at the node-set<br/>[u'Click here to go to the ', u'Next Page']<br/>&gt;&gt;&gt; xp('string(//a//text())') # convert it to a string<br/>[u'Click here to go to the ']</span></pre><p id="d6c6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，转换为字符串的<em class="kx">节点</em>将自身及其所有后代的文本放在一起:</p><pre class="ky kz la lb fq lc kw ld le aw lf dt"><span id="1b66" class="lg jr hu kw b fv lh li l lj lk">&gt;&gt;&gt; xp('//a[1]') # selects the first a node<br/>[u'&lt;a href="#"&gt;Click here to go to the &lt;strong&gt;Next Page&lt;/strong&gt;&lt;/a&gt;']<br/>&gt;&gt;&gt; xp('string(//a[1])') # converts it to string<br/>[u'Click here to go to the Next Page']</span></pre><p id="8798" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以，总的来说:</p><p id="8d22" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">好:</strong></p><pre class="ky kz la lb fq lc kw ld le aw lf dt"><span id="9c75" class="lg jr hu kw b fv lh li l lj lk">&gt;&gt;&gt; xp("//a[contains(., 'Next Page')]")<br/>[u'&lt;a href="#"&gt;Click here to go to the &lt;strong&gt;Next Page&lt;/strong&gt;&lt;/a&gt;']</span></pre><p id="d4fa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">坏:</strong></p><pre class="ky kz la lb fq lc kw ld le aw lf dt"><span id="0dff" class="lg jr hu kw b fv lh li l lj lk">&gt;&gt;&gt; xp("//a[contains(.//text(), 'Next Page')]")<br/>[]</span></pre><p id="6391" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">好:</strong></p><pre class="ky kz la lb fq lc kw ld le aw lf dt"><span id="c6bb" class="lg jr hu kw b fv lh li l lj lk">&gt;&gt;&gt; xp("substring-after(//a, 'Next ')")<br/>[u'Page']</span></pre><p id="606e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">不好:</strong></p><pre class="ky kz la lb fq lc kw ld le aw lf dt"><span id="4851" class="lg jr hu kw b fv lh li l lj lk">&gt;&gt;&gt; xp("substring-after(//a//text(), 'Next ')")<br/>[u'']</span></pre><p id="d6e6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以阅读XPath规范中关于节点和节点集的字符串值的更多详细解释。</p><h1 id="3bd0" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">注意//node[1]和(//node)[1]之间的区别</h1><p id="f613" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated"><code class="eh kt ku kv kw b">//node[1]</code>选择在其各自父节点下首先出现的所有节点。</p><p id="51ac" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh kt ku kv kw b">(//node)[1]</code>选择文档中的所有节点，然后只获取第一个节点。</p><pre class="ky kz la lb fq lc kw ld le aw lf dt"><span id="6b47" class="lg jr hu kw b fv lh li l lj lk">&gt;&gt;&gt; from scrapy import Selector<br/>&gt;&gt;&gt; sel=Selector(text="""<br/>....: &lt;ul class="list"&gt;<br/>....: &lt;li&gt;1&lt;/li&gt;<br/>....: &lt;li&gt;2&lt;/li&gt;<br/>....: &lt;li&gt;3&lt;/li&gt;<br/>....: &lt;/ul&gt;<br/>....: &lt;ul class="list"&gt;<br/>....: &lt;li&gt;4&lt;/li&gt;<br/>....: &lt;li&gt;5&lt;/li&gt;<br/>....: &lt;li&gt;6&lt;/li&gt;<br/>....: &lt;/ul&gt;""")<br/>&gt;&gt;&gt; xp = lambda x: sel.xpath(x).extract()<br/>&gt;&gt;&gt; xp("//li[1]") # get all first LI elements under whatever it is its parent<br/>[u'&lt;li&gt;1&lt;/li&gt;', u'&lt;li&gt;4&lt;/li&gt;']<br/>&gt;&gt;&gt; xp("(//li)[1]") # get the first LI element in the whole document<br/>[u'&lt;li&gt;1&lt;/li&gt;']<br/>&gt;&gt;&gt; xp("//ul/li[1]") # get all first LI elements under an UL parent<br/>[u'&lt;li&gt;1&lt;/li&gt;', u'&lt;li&gt;4&lt;/li&gt;']<br/>&gt;&gt;&gt; xp("(//ul/li)[1]") # get the first LI element under an UL parent in the document<br/>[u'&lt;li&gt;1&lt;/li&gt;']</span></pre><p id="bea1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">还有，</p><p id="3c80" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh kt ku kv kw b">//a[starts-with(@href, '#')][1]</code>获取首先出现在各自父节点下的本地锚的集合。</p><p id="8f43" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh kt ku kv kw b">(//a[starts-with(@href, '#')])[1]</code>获取文档中的第一个本地锚点。</p><h1 id="44a3" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">按类别选择时，尽可能具体</h1><p id="5ef3" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">如果您想通过CSS类选择元素，XPath的方法相当冗长:</p><pre class="ky kz la lb fq lc kw ld le aw lf dt"><span id="99f1" class="lg jr hu kw b fv lh li l lj lk">*[contains(concat(' ', normalize-space(<a class="ae jp" href="http://twitter.com/class" rel="noopener ugc nofollow" target="_blank">@class</a>), ' '), ' someclass ')]</span></pre><p id="c8e1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们编造一些例子:</p><pre class="ky kz la lb fq lc kw ld le aw lf dt"><span id="9243" class="lg jr hu kw b fv lh li l lj lk">&gt;&gt;&gt; sel = Selector(text='&lt;p class="content-author"&gt;Someone&lt;/p&gt;&lt;p class="content text-wrap"&gt;Some content&lt;/p&gt;')<br/>&gt;&gt;&gt; xp = lambda x: sel.xpath(x).extract()</span></pre><p id="2c86" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">坏:</strong>不起作用，因为属性中有多个类</p><pre class="ky kz la lb fq lc kw ld le aw lf dt"><span id="68a7" class="lg jr hu kw b fv lh li l lj lk">&gt;&gt;&gt; xp("//*[<a class="ae jp" href="http://twitter.com/class" rel="noopener ugc nofollow" target="_blank">@class</a>='content']")<br/>[]</span></pre><p id="0fe6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">坏:得到的比我们想要的多</p><pre class="ky kz la lb fq lc kw ld le aw lf dt"><span id="0b78" class="lg jr hu kw b fv lh li l lj lk">&gt;&gt;&gt; xp("//*[contains(<a class="ae jp" href="http://twitter.com/class" rel="noopener ugc nofollow" target="_blank">@class</a>,'content')]")<br/>[u’&lt;p class=”content-author”&gt;Someone&lt;/p&gt;’]</span></pre><p id="da00" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">好:</strong></p><pre class="ky kz la lb fq lc kw ld le aw lf dt"><span id="c58d" class="lg jr hu kw b fv lh li l lj lk">&gt;&gt;&gt; xp("//*[contains(concat(' ', normalize-space(<a class="ae jp" href="http://twitter.com/class" rel="noopener ugc nofollow" target="_blank">@class</a>), ' '), ' content ')]")<br/>[u'&lt;p class="content text-wrap"&gt;Some content&lt;/p&gt;']</span></pre><p id="93a1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">很多时候，您可以只使用CSS选择器，如果需要，甚至可以将两者结合使用:</p><p id="8165" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">还好:</strong></p><pre class="ky kz la lb fq lc kw ld le aw lf dt"><span id="d382" class="lg jr hu kw b fv lh li l lj lk">&gt;&gt;&gt; sel.css(".content”).extract()<br/>[u'&lt;p class="content text-wrap"&gt;Some content&lt;/p&gt;']<br/>&gt;&gt;&gt; sel.css('.content').xpath('<a class="ae jp" href="http://twitter.com/class" rel="noopener ugc nofollow" target="_blank">@class</a>').extract()<br/>[u'content text-wrap']</span></pre><p id="3c75" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这里阅读<a class="ae jp" href="http://scrapy.readthedocs.org/en/latest/topics/selectors.html#nesting-selectors" rel="noopener ugc nofollow" target="_blank">更多关于你能用Scrapy的选择器做什么的信息。</a></p><h1 id="43c2" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">学会使用所有不同的轴</h1><p id="8a64" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">知道如何使用轴是很方便的，你可以<a class="ae jp" href="http://www.zvon.org/comp/r/tut-XPath_1.html#Pages~List_of_XPaths" rel="noopener ugc nofollow" target="_blank">按照教程</a>中给出的例子快速复习。</p><p id="cb6c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">特别是，你应该注意到后面的<a class="ae jp" href="http://www.zvon.org/comp/r/tut-XPath_1.html#Pages~Following_axis" rel="noopener ugc nofollow" target="_blank">和</a><a class="ae jp" href="http://www.zvon.org/comp/r/tut-XPath_1.html#Pages~Following-sibling_axis" rel="noopener ugc nofollow" target="_blank">后面的-兄弟</a>不是同一个东西，这是一个常见的混淆来源。同样适用于之前的<a class="ae jp" href="http://www.zvon.org/comp/r/tut-XPath_1.html#Pages~Preceding_axis" rel="noopener ugc nofollow" target="_blank">和</a><a class="ae jp" href="http://www.zvon.org/comp/r/tut-XPath_1.html#Pages~Preceding-sibling_axis" rel="noopener ugc nofollow" target="_blank">之前的同级</a>，以及<a class="ae jp" href="http://www.zvon.org/comp/r/tut-XPath_1.html#Pages~Ancestor_axis" rel="noopener ugc nofollow" target="_blank">的祖先</a>和<a class="ae jp" href="http://www.zvon.org/comp/r/tut-XPath_1.html#Pages~Parent_axis" rel="noopener ugc nofollow" target="_blank">的父</a>。</p><h1 id="1504" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">获取文本内容的有用技巧</h1><p id="02bd" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">下面是另一个XPath技巧，您可以使用它来获得有趣的文本内容:</p><p id="691b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh kt ku kv kw b">1//*[not(self::script or self::style)]/text()[normalize-space(.)]</code></p><p id="850c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这排除了来自<code class="eh kt ku kv kw b">script</code>和<code class="eh kt ku kv kw b">style</code>标签的内容，也跳过了只有空白的文本节点。来源:<a class="ae jp" href="http://stackoverflow.com/a/19350897/2572383" rel="noopener ugc nofollow" target="_blank">http://stackoverflow.com/a/19350897/2572383</a></p><h1 id="94d5" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">您还有其他XPath技巧吗？</h1><p id="cbd9" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">请给我们留下您的建议或问题。</p></div><div class="ab cl ll lm hc ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hn ho hp hq hr"><figure class="ky kz la lb fq lt fe ff paragraph-image"><div class="fe ff ls"><img src="../Images/2ee7e6ccac9e6ea3fafa7f0b4d6d0086.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/1*qFn8iZ84gy4aLsBetYPN1g.jpeg"/></div></figure><p id="bdac" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这篇文章由Zyte(前身为Scrapinghub)的软件开发人员Elias Dorneles(<a class="ae jp" href="https://twitter.com/eliasdorneles" rel="noopener ugc nofollow" target="_blank">@ Elias Dorneles</a>)撰写。</p><p id="7927" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请用心“推荐”并广泛分享这些技巧。</p></div><div class="ab cl ll lm hc ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hn ho hp hq hr"><p id="21bb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://www.zyte.com/data-extraction/" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">了解一下网页抓取和网页数据能为你做什么</strong> </a> <strong class="it hv">。</strong></p><div class="ky kz la lb fq ab cb"><figure class="lw lt lx ly lz ma mb paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="lw lt lx ly lz ma mb paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="lw lt lx ly lz ma mb paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mc md me"><p id="f922" class="ir is kx it b iu iv iw ix iy iz ja jb mf jd je jf mg jh ji jj mh jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is kx it b iu iv iw ix iy iz ja jb mf jd je jf mg jh ji jj mh jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="ky kz la lb fq lt fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff mi"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure></div></div>    
</body>
</html>