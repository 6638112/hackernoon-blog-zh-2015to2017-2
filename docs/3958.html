<html>
<head>
<title>Unexpected SQLite with Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Swift的意外SQLite</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/unexpected-sqlite-with-swift-ddc6343bcbfc?source=collection_archive---------5-----------------------#2017-05-03">https://medium.com/hackernoon/unexpected-sqlite-with-swift-ddc6343bcbfc?source=collection_archive---------5-----------------------#2017-05-03</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="5291" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有一个我几乎每天都喜欢的Swift库，因为我编写的许多应用程序都使用数据库进行本地存储。<a class="ae jp" href="https://github.com/groue/GRDB.swift" rel="noopener ugc nofollow" target="_blank"> GRDB.swift </a>将所有赌注压在了<a class="ae jp" href="https://hackernoon.com/tagged/sqlite" rel="noopener ugc nofollow" target="_blank"> SQLite </a>上，这是一个既非常有名，又不太知名的库。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="jv jw l"/></div></figure><p id="01b0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">SQLite被设计成嵌入式的，并且访问本地数据库。这使它有别于客户机-服务器数据库，并带来了许多独特的特性。不幸的是，很少有开发人员使用它们，假设他们甚至知道它们的存在。这是因为除非你用c编程，否则这些特性通常是不可用的。</p><p id="df86" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">关于数据库库也有很强的文化假设，从低级驱动程序到成熟的ORM，中间是SQL查询构建器。打破这些假设需要大量的交流和教学，例如由生动的社区和非常活跃的公司支持的数据库引擎。</p><p id="4e14" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本文的其余部分列出了SQLite和GRDB的一些意想不到的特性。</p><h2 id="14b5" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">WAL模式，又名高效多线程</h2><p id="8d4e" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">WAL表示<a class="ae jp" href="https://sqlite.org/wal.html" rel="noopener ugc nofollow" target="_blank">提前写日志</a>。这是一种允许SQLite支持并发数据库读取器和写入器的技术，并且极大地改进了多线程应用程序。例如，当UI线程从数据库加载数据时，它永远不会被阻塞。</p><p id="4521" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">GRDB通过<a class="ae jp" href="https://github.com/groue/GRDB.swift/blob/master/README.md#database-pools" rel="noopener ugc nofollow" target="_blank"> DatabasePool </a>类支持WAL模式，并提供了一个<a class="ae jp" href="https://github.com/groue/GRDB.swift/blob/master/README.md#concurrency" rel="noopener ugc nofollow" target="_blank">并发指南</a>，涵盖了高效多线程应用的最佳实践。</p><h2 id="54bd" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">活性SQLite</h2><p id="0bc7" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">SQLite提供了<a class="ae jp" href="https://sqlite.org/c3ref/update_hook.html" rel="noopener ugc nofollow" target="_blank">数据变更通知回调</a>和<a class="ae jp" href="https://sqlite.org/c3ref/set_authorizer.html" rel="noopener ugc nofollow" target="_blank">编译时授权回调</a>。第一个通知修改的行，当后者告诉SQL语句中涉及哪些表和列时。</p><p id="28de" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当您将它们结合起来时，您就能够判断一个SQL语句是否有机会影响另一个查询的结果。这是通过<a class="ae jp" href="https://github.com/groue/GRDB.swift/blob/master/README.md#valueobservation" rel="noopener ugc nofollow" target="_blank"> GRDB的ValueObservation </a>进行数据库观察的诀窍，内置对Combine和RxSwift的支持。</p><h2 id="75ac" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">面向协议的ORM</h2><p id="38a4" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">一个ORM ( <a class="ae jp" href="https://en.wikipedia.org/wiki/Object-relational_mapping" rel="noopener ugc nofollow" target="_blank">对象关系映射</a>)将原始数据库行映射到名为records的简单对象。</p><p id="4b64" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">ORM中常见的特性有获取和持久化方法、关系、延迟加载、记录自动更新和记录唯一化。最后三个是典型的ORM，由<em class="kx">管理</em>记录，并假装它们直接映射数据库行。这种错觉通常会为所有记录类型引入一个基类，并在应用程序线程之间设置栅栏，以避免共享数据的突变。</p><p id="144b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">由Swift和Rust等语言引入的对不变性和<a class="ae jp" href="https://developer.apple.com/swift/blog/?id=10" rel="noopener ugc nofollow" target="_blank">值类型</a>的关注带来了一种编写ORM的新方法:现在可以放弃公共基类，跨线程共享记录，并使用数据库作为整个应用程序的唯一来源。GRDB <a class="ae jp" href="https://github.com/groue/GRDB.swift/blob/master/README.md#records" rel="noopener ugc nofollow" target="_blank">唱片</a>和Rust的<a class="ae jp" href="https://diesel.rs" rel="noopener ugc nofollow" target="_blank">柴油</a>建立在这些新的基础上。</p><h2 id="989f" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">有用的错误</h2><p id="4c47" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">太多的数据库库假装数据库错误没有发生，很容易忽略它们，或者发出难以理解的错误消息。GRBD使用全范围的<a class="ae jp" href="https://github.com/apple/swift/blob/master/docs/ErrorHandlingRationale.rst" rel="noopener ugc nofollow" target="_blank"> Swift错误</a>，并提供尽可能详细的<a class="ae jp" href="https://github.com/groue/GRDB.swift/blob/master/README.md#error-handling" rel="noopener ugc nofollow" target="_blank">错误</a>。</p><h2 id="b8e8" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">轻松的SQL</h2><p id="0403" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">GRDB欢迎不熟悉SQL和SQLite的开发人员:它的<a class="ae jp" href="https://github.com/groue/GRDB.swift/blob/master/README.md#the-query-interface" rel="noopener ugc nofollow" target="_blank">查询接口</a>使得不用写一行SQL就能访问数据库成为可能。</p><p id="03ba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">同时，没有一个查询生成器能够生成所有可能的查询，偶尔出现的复杂查询在编写为普通SQL时可能更容易阅读。这就是为什么GRDB确保你永远不会为你的SQL技能买单。</p><p id="6821" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">例如，您可以从SQL以及Swift请求中加载记录:</p><pre class="jq jr js jt fq ky kz la lb aw lc dt"><span id="b335" class="jx jy hu kz b fv ld le l lf lg">// Two one liners that load the same array of Person:<br/>try Person.filter(emailColumn != nil).fetchAll(db)<br/>try Person.fetchAll(db, """<br/>    SELECT * FROM persons<br/>    WHERE email IS NOT NULL<br/>    """)</span></pre><p id="24fd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="http://github.com/RxSwiftCommunity/RxGRDB" rel="noopener ugc nofollow" target="_blank">反应式延伸</a>同样用途广泛:</p><pre class="jq jr js jt fq ky kz la lb aw lc dt"><span id="0249" class="jx jy hu kz b fv ld le l lf lg">let request = SQLRequest("SELECT * FROM persons")<br/>request.rx.changes(in: dbPool)<br/>  .subscribe(onNext: { db: Database in<br/>    print("Persons table has changed.")<br/>  })<br/><br/>try dbPool.write { db in<br/>  try Person(name: "Arthur").insert(db)<br/>  try Person(name: "Barbara").insert(db)<br/>} // Prints "Persons table has changed."</span></pre><p id="f228" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本着同样的精神，GRDB支持所有种类的主键、惟一键和外键:您可以自由地设计关系模式的完整性，并在列不符合要求时摆脱沉闷的<code class="eh lh li lj kz b">id</code>列。</p></div><div class="ab cl lk ll hc lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="hn ho hp hq hr"><p id="6021" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">SQLite和GRDB是两个提供简单和高级工具来帮助开发应用程序的库。查看<a class="ae jp" href="https://github.com/groue/GRDB.swift/blob/master/README.md#documentation" rel="noopener ugc nofollow" target="_blank">文档</a>,获得更多意想不到的好处，如高级unicode支持、记录更改跟踪、内存受限设备的维护、定制的SQLite构建、定制的全文索引…</p><p id="e7a6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://github.com/groue/GRDB.swift" rel="noopener ugc nofollow" target="_blank">https://github.com/groue/GRDB.swift</a></p></div><div class="ab cl lk ll hc lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="hn ho hp hq hr"><p id="3759" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这篇文章是GRDB故事的一部分:</p><ol class=""><li id="2ec0" class="lr ls hu it b iu iv iy iz jc lt jg lu jk lv jo lw lx ly lz dt translated"><a class="ae jp" rel="noopener" href="/@gwendal.roue/grdb-stories-993b9d016867">取值</a></li><li id="e3fe" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated"><a class="ae jp" rel="noopener" href="/@gwendal.roue/grdb-stories-cae49d47dc21">内存消耗</a></li><li id="9713" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated"><a class="ae jp" rel="noopener" href="/@gwendal.roue/grdb-stories-592d03b42384">从调试器查询数据库</a></li><li id="b368" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated"><a class="ae jp" rel="noopener" href="/@gwendal.roue/grdb-stories-8c37a03ef72d">主键自由度</a></li><li id="5fed" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated"><a class="ae jp" rel="noopener" href="/@gwendal.roue/grdb-stories-1da44bdb53ab">FetchedRecordsController</a></li><li id="06a0" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated"><a class="ae jp" rel="noopener" href="/@gwendal.roue/grdb-stories-9bfcfb8b6a88">对象和数据库之间的松散耦合</a></li><li id="50e4" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated"><a class="ae jp" rel="noopener" href="/@gwendal.roue/four-different-ways-to-handle-sqlite-concurrency-db3bcc74d00e">处理SQLite并发的四种不同方式</a></li><li id="8385" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated"><a class="ae jp" rel="noopener" href="/@gwendal.roue/how-to-build-an-ios-application-with-sqlite-and-grdb-swift-d023a06c29b3">如何用GRDB.swift构建iOS应用</a></li><li id="c434" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated"><strong class="it hv">使用Swift的意外SQLite</strong></li></ol><blockquote class="mf mg mh"><p id="6446" class="ir is kx it b iu iv iw ix iy iz ja jb mi jd je jf mj jh ji jj mk jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是阿美族家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="dca4" class="ir is kx it b iu iv iw ix iy iz ja jb mi jd je jf mj jh ji jj mk jl jm jn jo hn dt translated">要了解更多信息，<a class="ae jp" href="https://goo.gl/4ofytp" rel="noopener ugc nofollow" target="_blank">请阅读我们的“关于”页面</a> , <a class="ae jp" href="http://bit.ly/HackernoonFB" rel="noopener ugc nofollow" target="_blank">喜欢/在脸书给我们发消息</a>，或者简单地，<a class="ae jp" href="https://goo.gl/k7XYbx" rel="noopener ugc nofollow" target="_blank">发推文/DM @HackerNoon。</a></p><p id="708a" class="ir is kx it b iu iv iw ix iy iz ja jb mi jd je jf mj jh ji jj mk jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="ml jw l"/></div></figure></div></div>    
</body>
</html>