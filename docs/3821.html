<html>
<head>
<title>“The Giving Ruby”—The Strange Case of User Enumeration on Heroku (Not Fixed)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">“给予的红宝石”Heroku上用户枚举的奇怪情况(未修复)</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/the-giving-ruby-the-strange-case-of-user-enumeration-on-heroku-not-fixed-1a8296067318?source=collection_archive---------6-----------------------#2017-04-25">https://medium.com/hackernoon/the-giving-ruby-the-strange-case-of-user-enumeration-on-heroku-not-fixed-1a8296067318?source=collection_archive---------6-----------------------#2017-04-25</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/b7fcac00079e04ba2eef08a5fa8947ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L54uL-09KnDSnMAWGcIhRw.png"/></div></div></figure><p id="0461" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我想分享一个最近关于臭虫奖励的经历。我多年来一直在做昆虫奖金，现在我正在操场上试用大男孩——bugcrowd.com<em class="kb"/>和hackerone.com<em class="kb"/>——这种体验是……嗯，不一样的。</p><p id="22cb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我想，动机是为了能够与关心交付时间并对你评估的公司负责的人谈判，但我从未觉得有必要让第三方参与这个过程，可能是因为我不是以此为生，也不是出于乐趣和真正的关心，因为通常我会在我已经是活跃用户的网站上发现漏洞。额外的美元、t恤或者仅仅是在某种名人堂上被提及，大多是为了炫耀的权利。在这篇文章的最后，我将回到我自己的一些二分水平的见解——但首先，让我们继续告诉你在Heroku上发现的漏洞。</p><h1 id="b1a8" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">什么是Heroku？</h1><p id="3ef1" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated"><a class="ae ka" href="https://www.heroku.com/" rel="noopener ugc nofollow" target="_blank"> <em class="kb"> Heroku </em> </a> <em class="kb"> </em>其实挺神奇的。他们有一个集成的PaaS解决方案，允许开发人员最轻松地在云上托管他们的应用程序。</p><figure class="lg lh li lj fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lf"><img src="../Images/96677f9982361551ab1718d889842082.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ylwFQDTtMlEyRc-i51IDaw.png"/></div></div></figure><p id="3c5c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">无论是大公司还是小公司都在不停地使用Heroku，所以我猜想这是一个发现有趣漏洞的好地方，通过发现一个与组织无关的漏洞，这些漏洞可能会影响到他们所有人。</p><h1 id="bbd6" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">登录API调用，发现响应异常</h1><p id="520f" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">Heroku有几种与他们的服务接口的选择。基于网络是很常见的用法，API紧随其后。有一个Heroku命令行界面(CLI)工具，它基本上是API调用的包装器。我使用CLI工具来联系网站，并开始弄乱一些输入，过了一段时间，我把重点放在了看起来非常简单的登录机制上。它基于一个POST请求，伴随着<em class="kb">用户名</em>和<em class="kb">密码</em>参数。</p><p id="db0a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">起初，当我弄乱输入时，我认为没什么大不了的，我希望出现错误输出或者真实用户名和虚假用户名之间的任何响应变化。尽管我没有看到这些错误文本的任何变化，但是响应中有一个更微妙的变化。</p><p id="8d53" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">登录请求看起来像这样:</p><pre class="lg lh li lj fq lk ll lm ln aw lo dt"><span id="97f2" class="lp kd hu ll b fv lq lr l ls lt">POST <strong class="ll hv">https://api.heroku.com/login</strong> HTTP/1.1<br/>Host: api.heroku.com<br/>User-Agent: heroku-cli/5.2.39-010a227 (windows-386) go1.6.2<br/>Content-Length: 54<br/>Accept: application/json<br/>Content-Type: application/x-www-form-urlencoded<br/>Accept-Encoding: gzip<br/><br/>password=fjfjfjfj&amp;username=bogus%40gmail.com</span></pre><p id="c992" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">适当的回应应该是:</p><pre class="lg lh li lj fq lk ll lm ln aw lo dt"><span id="12bd" class="lp kd hu ll b fv lq lr l ls lt">HTTP/1.1 404 Not Found<br/>Cache-Control: private, no-cache<br/>Content-Type: text/html;charset=utf-8<br/>Date: Mon, 29 Aug 2016 16:49:52 GMT<br/>Request-Id: b3ca4a2c-1adf-4244-4cb0-17fbbc9deb06<br/>Server: nginx/1.8.1<br/>Strict-Transport-Security: max-age=31536000; includeSubDomains<br/>Vary: Accept-Encoding<br/>X-Content-Type-Options: nosniff<br/>X-Frame-Options: SAMEORIGIN<br/>X-Runtime: 0.018023806<br/>X-Xss-Protection: 1; mode=block<br/>Content-Length: 0<br/>Connection: keep-alive</span></pre><p id="ed19" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">所以，如前所述，不超过404，但另一方面，它在可选标题上有些慷慨——“那又怎样？”你可能会问。这就完全不同了。具体来说，引起我注意的是“<strong class="je hv">X-Runtime”</strong>头。</p><p id="63d4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">从它的名字我只能猜测我发现了什么。但是它需要更多的探测来确定。</p><h1 id="9c78" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">别动，你这个混蛋！</h1><p id="4f85" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">第一站是在HTTP RFCs上查看第1，000，000次，注意这里没有类似的东西——所以它一定是由web服务器上的另一个组件添加的。简短的扫描显示，它很可能是由依赖于Ruby/Rails的服务器端组件派生的。</p><p id="2887" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">其中一个名为<strong class="je hv"> Rack </strong>的项目首先出现在搜索中，也就是说我们不能确定这是否是网站上运行的Ruby代码，但我们会把它作为一个测试案例，最终证明这是足够的。</p><p id="e7a7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对于那些从未听说过它的人(像我一样)，GitHub页面上写着:</p><blockquote class="lu lv lw"><p id="3b44" class="jc jd kb je b jf jg jh ji jj jk jl jm lx jo jp jq ly js jt ju lz jw jx jy jz hn dt translated">Rack为用Ruby开发web应用程序提供了一个最小的、模块化的、适应性强的接口。通过以尽可能简单的方式包装HTTP请求和响应，它将web服务器、web框架和它们之间的软件(所谓的中间件)的API统一和提取到一个方法调用中。</p></blockquote><p id="5fab" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">仔细查看它的源代码，在<em class="kb"> lib/rack/runtime.rb </em>中解释了异常的头文件:</p><figure class="lg lh li lj fq iv"><div class="bz el l di"><div class="ma mb l"/></div></figure><p id="f793" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在我们可以充分肯定我们对“X-Runtime”含义的常识性理解。它指的是操作完成所需的时间。</p><p id="935b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你和我想的一样吗？</p><p id="5073" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了证实这一想法，我们必须针对系统中不存在的用户名和存在的用户名的不同组合获得一个更大的测试样本集。并且记录定时差异以及是否存在任何可辨别的种类的增量。</p><p id="bde2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现有用户名包含生成了以下计时注释:</p><pre class="lg lh li lj fq lk ll lm ln aw lo dt"><span id="b9c4" class="lp kd hu ll b fv lq lr l ls lt">X-Runtime: 0.093990008<br/>X-Runtime: 0.088857339<br/>X-Runtime: 0.09251876<br/>X-Runtime: 0.089843447<br/>X-Runtime: 0.091845765<br/>X-Runtime: 0.101260549</span></pre><p id="8033" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当使用不存在的用户名时(为了安全起见，我使用了正确的电子邮件地址方案):</p><pre class="lg lh li lj fq lk ll lm ln aw lo dt"><span id="91e2" class="lp kd hu ll b fv lq lr l ls lt">X-Runtime: 0.027787351<br/>X-Runtime: 0.018023806<br/>X-Runtime: 0.020997733<br/>X-Runtime: 0.021645124<br/>X-Runtime: 0.016645836<br/>X-Runtime: 0.021828831<br/>X-Runtime: 0.022211143</span></pre><h1 id="0882" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">守旧派旁门左道定时攻击——❤</h1><p id="e2e3" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">所有这些评估都集中到一个最终结论中——系统上的假用户名和真用户名在时间上有明显的(~1个数量级)差异。</p><p id="1ee0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这怎么可能呢？可能是因为在根据真正的散列密码检查密码的过程中涉及到了与加密相关的操作。</p><p id="6edd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是一个定时攻击的常规例子。一旦服务器接收到来自用户的参数，它首先检查用户以查看它是否相关，如果不相关，操作结束并向用户响应<em class="kb"> 404 </em>。在另一种情况下，如果发现用户名是相关的——它将继续前进，根据密码的本地散列副本检查用户给出的密码，这是一个非常密集的操作，与其后面的用户名列表的短途旅行形成对比。由于运行时间不同，我们可以感知这些独特的路线。</p><p id="e70a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">许多应用程序都在做同样的事情，但主要是因为延迟，对于基于时间的攻击，要确定一个明确的结论有点困难。在这种情况下Ruby服务器通过一个简单的POST请求为我们提供了得出这个结论所需的所有信息。<strong class="je hv">爽！</strong></p><h1 id="dc21" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">如何克服攻击？</h1><p id="73a5" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">这可以在许多层面上解决。由于我不知道Heroku对保持这个标题的考虑，我将尝试涵盖不同的方法，因为几乎每种方法都有实际的限制。</p><ol class=""><li id="2632" class="mc md hu je b jf jg jj jk jn me jr mf jv mg jz mh mi mj mk dt translated"><strong class="je hv">从响应中删除“X-Runtime”标头— </strong>这是最明显的建议，因为这是导致我们得出结论的错误，但这只是某种内在因素的最终结果—时间计算可能以其他不太直接的方式观察，如响应延迟时间。通过计算从发送请求到收到响应的往返时间，我观察到的并不仅仅是这一点。运行时值可以用于调试目的，我在过去遇到过一些客户，他们不能从所有响应甚至某些响应的子集中删除调试头——如果是这样，他们可能会在更高的web服务器级别上修改它，并在编译最终响应之前努力删除慷慨的一行。非常丑陋的补丁，但实用性有时压倒优雅。</li><li id="5555" class="mc md hu je b jf ml jj mm jn mn jr mo jv mp jz mh mi mj mk dt translated"><strong class="je hv">使所有操作时间相等— </strong>依靠Heroku对用户认证过程的精细控制，他们可能会将检查用户名和密码参数的过程延迟一段时间。如果他们决定把它留在原地，这就不一定会通过X-Runtime来实现。</li><li id="ed4a" class="mc md hu je b jf ml jj mm jn mn jr mo jv mp jz mh mi mj mk dt translated"><strong class="je hv">为操作添加随机时间— </strong>在流程中注入随机长度的延迟，实际上会使这些时间变得不稳定。这种方法的问题是，在更大的范围内，对每个猜测进行多次检查，你会得到(假设随机长度延迟的正态分布)一个更大的结果。这也不一定要通过X-Runtime来体现。</li><li id="c832" class="mc md hu je b jf ml jj mm jn mn jr mo jv mp jz mh mi mj mk dt translated"><strong class="je hv">限制请求数量— </strong>如果您认为这种攻击威胁到整个客户群，而不是针对一小部分用户的攻击，那么这是一种解决方案。根据这个定义——您应该能够在给定时间限制来自单个源的请求数量，这使得决心较小的攻击者的工作变得多余。在任何情况下，这都不是一个防弹的解决方案，因为攻击者通常会使用VPN、匿名网络或僵尸网络来掩盖他们的踪迹。</li></ol></div><div class="ab cl mq mr hc ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="hn ho hp hq hr"><h1 id="3ea1" class="kc kd hu bd ke kf mx kh ki kj my kl km kn mz kp kq kr na kt ku kv nb kx ky kz dt translated">Heroku/BugCrowd的回应</h1><p id="d156" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">根据Bugcrowd的条款——用户枚举漏洞不在范围内，他们实际上为此罚了我-1分(老实说，我早该知道的。我的辩护是，我不清楚是否有一个独立的条款，不仅来自供应商，也来自BugCrowd，需要遵守。)</p><p id="9718" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">事情是这样的，正如我之前提到的——这不是我的重点，因为我的许多同行都不是为了盈利而做这件事，我只是想做一个我评估过的网站，供我自己使用，如果碰巧，就像在这种情况下，提示有<a class="ae ka" href="https://hackernoon.com/tagged/security" rel="noopener ugc nofollow" target="_blank">安全</a>漏洞。我是否得到奖金是次要目标，让我担心的是，因为BugCrowd认为它超出了范围，所以我们不应该讨论这个漏洞。应该有这样的术语来定义，不是所有的东西都会让你赚一点小钱，但是一旦你发现bugcrowd范围之外的东西，为什么它应该被认为是供应商缓解范围之外的呢？</p><p id="4f60" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我真的不反对Heroku或BugCrowd，他们都是由伟大的，充满激情的人组成，从我的经验来看，但官僚主义在这种情况下与进步相矛盾，我希望这些不成文的程序应该得到照顾，为我们的社区的利益。</p><div class="lg lh li lj fq ab cb"><figure class="nc iv nd ne nf ng nh paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="nc iv nd ne nf ng nh paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="nc iv nd ne nf ng nh paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="lu lv lw"><p id="f922" class="jc jd kb je b jf jg jh ji jj jk jl jm lx jo jp jq ly js jt ju lz jw jx jy jz hn dt translated"><a class="ae ka" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ka" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ka" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ka" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jc jd kb je b jf jg jh ji jj jk jl jm lx jo jp jq ly js jt ju lz jw jx jy jz hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ka" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ka" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lg lh li lj fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ni"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="lg lh li lj fq iv"><div class="bz el l di"><div class="nj mb l"/></div></figure></div></div>    
</body>
</html>