<html>
<head>
<title>RxRecipes: Wrap your way to Rx</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">处方:包装你的处方</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/rxrecipes-wrap-your-way-to-rx-fd40eb5254b6?source=collection_archive---------1-----------------------#2016-11-25">https://medium.com/hackernoon/rxrecipes-wrap-your-way-to-rx-fd40eb5254b6?source=collection_archive---------1-----------------------#2016-11-25</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/535ad9a547cf2b83f054cda5ea269340.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HbXol0ztoXNPlJt93R-2sA.jpeg"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Image Credit: <a class="ae ih" href="https://www.flickr.com/photos/jodimichelle/6421813195/in/photostream/" rel="noopener ugc nofollow" target="_blank">JodiMichelle @ Flickr</a></figcaption></figure><div class=""/><blockquote class="jh ji jj"><p id="7108" class="jk jl jm jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hn dt translated">RxRecipes系列一般指Android和<a class="ae ih" href="https://github.com/ReactiveX/RxJava/tree/2.x" rel="noopener ugc nofollow" target="_blank"> RxJava2 </a>，但同样的Recipes可以适用于任何Rx实现和平台(<a class="ae ih" href="https://github.com/Reactive-Extensions/RxJS" rel="noopener ugc nofollow" target="_blank"> RxJs </a>、<a class="ae ih" href="https://github.com/ReactiveX/RxSwift" rel="noopener ugc nofollow" target="_blank"> RxSwift </a>，一个带有RxJava的后端等)。</p></blockquote><h1 id="3968" class="kj kk ik bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">带外部代码的Rx组合</h1><p id="99a8" class="pw-post-body-paragraph jk jl ik jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">假设您的最新应用程序有一个非常棒的反应式数据层。API/磁盘/缓存设置非常漂亮，如此清新干净，真是一个充满欢乐和奇迹的绿洲。</p><p id="ac9d" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">来自product的新需求:您需要用一些静态数据初始化应用程序，以进行无等待/无互联网要求的首次运行。</p><p id="ef8d" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">因此，您决定将一个JSON文档放在/assets文件夹中。</p><p id="6b27" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">除非您很快意识到这个新数据源(以及相关的<a class="ae ih" href="https://developer.android.com/reference/android/content/res/AssetManager.html" rel="noopener ugc nofollow" target="_blank"> AssetManager API </a>)不适合您的可组合、可调度、可链接、可终止错误(以及所有其他功能)的反应式数据层。</p><figure class="lp lq lr ls fq hw"><div class="bz el l di"><div class="lt lu l"/></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Ugh. InputStream and array literals, IOException to cover multiple cases (file doesn’t exist, some issue with the disk), synchronous-blocking close. No thanks.</figcaption></figure><p id="d55e" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">我们真正想要的是这样一个反应式的简洁API:</p><figure class="lp lq lr ls fq hw"><div class="bz el l di"><div class="lt lu l"/></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Optional since the file may not exist. Completeable for the no-return-value operation. and an Observable stream of locales. Sweet! See discussion in comments regarding Maybe type for the getFileAsString() method.</figcaption></figure><p id="432d" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">但是我们如何到达那里呢？</p><figure class="lp lq lr ls fq hw fe ff paragraph-image"><div class="fe ff lv"><img src="../Images/37c67bc148efa55f6dd1321615a01f31.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/1*E8ROs4RlEao12IOzP6KX-A.gif"/></div></figure></div><div class="ab cl lw lx hc ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hn ho hp hq hr"><h1 id="6727" class="kj kk ik bd kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc mh le lf lg dt translated">解决方案:用fromCallable()包装</h1><p id="0e6e" class="pw-post-body-paragraph jk jl ik jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">来自官方文件:</p><p id="598f" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated"><em class="jm">返回一个可观察对象，当观察者订阅它时，调用您指定的函数，然后发出从该函数返回的值。这允许您将指定函数的执行推迟到观察者订阅ObservableSource之后。也就是说，它让函数变得“懒惰”</em></p><figure class="lp lq lr ls fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mi"><img src="../Images/8be5fd21588eddfab9d28924f2ef9823.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s3oJcF4MLoyDDqULb4bgJw.png"/></div></div></figure><p id="7996" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">使用fromCallable()是获取声明性外部代码并使其具有反应性的最简单方法。</p><p id="a3ff" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">fromCallable()创建方法需要与以下简单接口匹配的可调用实现:</p><figure class="lp lq lr ls fq hw"><div class="bz el l di"><div class="lt lu l"/></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Doesn’t get much simpler than that.</figcaption></figure></div><div class="ab cl lw lx hc ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hn ho hp hq hr"><h1 id="8f2c" class="kj kk ik bd kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc mh le lf lg dt translated">让我们看看代码</h1><p id="d9e6" class="pw-post-body-paragraph jk jl ik jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">我将在这个特定的实现中使用一些<a class="ae ih" href="https://github.com/google/guava" rel="noopener ugc nofollow" target="_blank"> Guava </a>类(可选的，CharStreams，Lists)。</p><figure class="lp lq lr ls fq hw"><div class="bz el l di"><div class="lt lu l"/></div></figure><ul class=""><li id="1a11" class="mj mk ik jn b jo jp js jt lj ml ll mm ln mn ki mo mp mq mr dt translated">我们返回一个实例，该实例在订阅时执行以下代码:</li><li id="52a4" class="mj mk ik jn b jo ms js mt lj mu ll mv ln mw ki mo mp mq mr dt translated">我们尝试获取文件的InputStream，并将该流读入CharStream，后者产生一个字符串结果。</li><li id="5ea4" class="mj mk ik jn b jo ms js mt lj mu ll mv ln mw ki mo mp mq mr dt translated">如果有一个IOException(文件不存在，一些磁盘问题),我们返回一个缺席可选。</li></ul><figure class="lp lq lr ls fq hw"><div class="bz el l di"><div class="lt lu l"/></div></figure><ul class=""><li id="a960" class="mj mk ik jn b jo jp js jt lj ml ll mm ln mn ki mo mp mq mr dt translated">我们创建一个可观察对象，它在订阅时执行以下代码:</li><li id="9e7c" class="mj mk ik jn b jo ms js mt lj mu ll mv ln mw ki mo mp mq mr dt translated">我们获得了资产的现有区域设置(String[])。</li><li id="aaf8" class="mj mk ik jn b jo ms js mt lj mu ll mv ln mw ki mo mp mq mr dt translated">我们使用<a class="ae ih" href="http://reactivex.io/RxJava/javadoc/rx/Observable.html#flatMapIterable%28rx.functions.Func1%29" rel="noopener ugc nofollow" target="_blank"> flatMapIterable </a>()操作符将流从String[]项转换成发出每个String[]项的字符串流(在我们的例子中，原始流中只有一个数组)。</li></ul><figure class="lp lq lr ls fq hw"><div class="bz el l di"><div class="lt lu l"/></div></figure><ul class=""><li id="a9b4" class="mj mk ik jn b jo jp js jt lj ml ll mm ln mn ki mo mp mq mr dt translated">我们返回一个Completable，它在订阅时执行close方法。</li><li id="6beb" class="mj mk ik jn b jo ms js mt lj mu ll mv ln mw ki mo mp mq mr dt translated">编辑:<a class="ae ih" href="https://github.com/ReactiveX/RxJava/blob/2.x/src/main/java/io/reactivex/Completable.java#L316" rel="noopener ugc nofollow" target="_blank">我们正在使用fromAction()，它类似于fromCallable()，只是它接受一个runnable(无返回类型)。</a> fromAction()仍然是延期执行，但是这样我们就不用做任何奇怪的返回了(感谢<a class="mx my gr" href="https://medium.com/u/70dbce2c0387?source=post_page-----fd40eb5254b6--------------------------------" rel="noopener" target="_blank"> Dávid Karnok </a>的提示！).</li><li id="79e9" class="mj mk ik jn b jo ms js mt lj mu ll mv ln mw ki mo mp mq mr dt translated">当然，只有Completable类型有fromAction()，因为其他反应类型都包含值。</li></ul></div><div class="ab cl lw lx hc ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hn ho hp hq hr"><h1 id="8a2a" class="kj kk ik bd kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc mh le lf lg dt translated">为什么fromCallable()而不仅仅是()，或者其他的创建方法</h1><p id="4120" class="pw-post-body-paragraph jk jl ik jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">关键是我们使用fromCallable()，而不是类似just()或fromIterable()等。因为我们不希望这段代码同步运行。</p><p id="b4fe" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">这是一个临界点，所以我们来看一个例子:</p><figure class="lp lq lr ls fq hw"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="2f39" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">我们现在阻塞调用线程很长时间了。如果你从Android的主线程调用这个函数，你就导致了一个<a class="ae ih" href="https://developer.android.com/training/articles/perf-anr.html" rel="noopener ugc nofollow" target="_blank"> ANR </a>，或者导致了UI冻结并变得没有反应。</p><p id="d8c6" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">但是即使你从一个你不介意阻塞的线程中调用它，仍然存在问题。</p><p id="42e7" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">假设这个文件在操作符链中被修改了，这个变化不会在这里反映出来。文件甚至可以在创建源之后被删除，而被动源不会反映这一点。</p><figure class="lp lq lr ls fq hw fe ff paragraph-image"><div class="fe ff mz"><img src="../Images/916841ad9bf204780f6b51b9810023ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/1*b0mlkp47zCcCpIzDVhM-Dw.gif"/></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Words are hard…</figcaption></figure><p id="70e7" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">换句话说:我们创建的反应式源将发出在创建源时已经运行的操作的结果；当订阅源时不运行操作，然后发出结果。</p><p id="7cda" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">这有点拗口，但是理解这种区别对于创建反应式应用程序或者包装命令式代码是至关重要的。</p></div><div class="ab cl lw lx hc ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hn ho hp hq hr"><h1 id="b5d4" class="kj kk ik bd kl km md ko kp kq me ks kt ku mf kw kx ky mg la lb lc mh le lf lg dt translated">让我们回顾一下</h1><p id="d9ca" class="pw-post-body-paragraph jk jl ik jn b jo lh jq jr js li ju jv lj lk jy jz ll lm kc kd ln lo kg kh ki hn dt translated">我们经常需要将一些反应式代码与我们不拥有的命令式代码(库、操作系统、跨项目的内部共享库)连接起来。</p><p id="64a1" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">我们可以用fromCallable()包装命令式代码来创建可观察的流源。</p><p id="1a86" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">我们回顾了一些AssetManager API的示例Rx-fromCallable()包装的实现。</p><p id="fb07" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">fromCallable()(以及Completables 的<a class="ae ih" href="https://github.com/ReactiveX/RxJava/blob/2.x/src/main/java/io/reactivex/Completable.java#L316" rel="noopener ugc nofollow" target="_blank"> fromAction())创建一个反应式源，它在订阅时执行它的工作，而不是在我们创建它时执行。</a></p></div><div class="ab cl lw lx hc ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hn ho hp hq hr"><h2 id="2685" class="na kk ik bd kl nb nc nd kp ne nf ng kt lj nh ni kx ll nj nk lb ln nl nm lf nn dt translated">RxRecipes系列的下一步:</h2><figure class="lp lq lr ls fq hw fe ff paragraph-image"><div class="fe ff no"><img src="../Images/bed7fb14d12304ccaffb82f22af25624.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/1*skNf8P_lWPjH4FW1sY9Lsg.gif"/></div><figcaption class="id ie fg fe ff if ig bd b be z ek">TBD — I’ll update this with a link to the next post once it’s done.</figcaption></figure><p id="de1f" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">喜欢这道菜吗？</p><p id="2b9e" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">不同意执行？</p><p id="eabd" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">对上面的某句话有火热的看法吗？</p><p id="5739" class="pw-post-body-paragraph jk jl ik jn b jo jp jq jr js jt ju jv lj jx jy jz ll kb kc kd ln kf kg kh ki hn dt translated">我很乐意收到你的来信，请在下面留下你的评论！</p><div class="lp lq lr ls fq ab cb"><figure class="np hw nq nr ns nt nu paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="np hw nq nr ns nt nu paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="np hw nq nr ns nt nu paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="jh ji jj"><p id="f922" class="jk jl jm jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hn dt translated"><a class="ae ih" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ih" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ih" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ih" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jk jl jm jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ih" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ih" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lp lq lr ls fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nv"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>