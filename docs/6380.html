<html>
<head>
<title>Kubernetes: Installing MongoDB ReplicaSet on Azure using Helm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:使用Helm在Azure上安装MongoDB ReplicaSet</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/kubernetes-installing-mongodb-replicaset-on-azure-using-helm-20f6bfcf92b3?source=collection_archive---------5-----------------------#2017-09-15">https://medium.com/hackernoon/kubernetes-installing-mongodb-replicaset-on-azure-using-helm-20f6bfcf92b3?source=collection_archive---------5-----------------------#2017-09-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/c6c3ceddd0ccd7b4268a63e8a97c9ebc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*NdeB_90Cgot5xfELzlBz1w.jpeg"/></div></figure><p id="a332" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">是时候在Azure上的一个Kubernetes集群上安装一个MongoDB ReplicaSet，并尝试用所有可能的方法杀死它了！<br/>主演:</p><ul class=""><li id="507e" class="jw jx hu ja b jb jc jf jg jj jy jn jz jr ka jv kb kc kd ke dt translated"><a class="ae kf" href="https://github.com/kubernetes/helm" rel="noopener ugc nofollow" target="_blank">掌舵</a></li><li id="f804" class="jw jx hu ja b jb kg jf kh jj ki jn kj jr kk jv kb kc kd ke dt translated"><a class="ae kf" href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/" rel="noopener ugc nofollow" target="_blank">statefullset</a></li><li id="9c84" class="jw jx hu ja b jb kg jf kh jj ki jn kj jr kk jv kb kc kd ke dt translated"><a class="ae kf" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/" rel="noopener ugc nofollow" target="_blank">持久卷</a></li><li id="8938" class="jw jx hu ja b jb kg jf kh jj ki jn kj jr kk jv kb kc kd ke dt translated"><a class="ae kf" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims" rel="noopener ugc nofollow" target="_blank">持续体积索赔</a></li></ul><figure class="km kn ko kp fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="fe ff kl"><img src="../Images/43f4258b065a5755fe935835e2533f7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9NFnIc44d5EtXz-IXR3MnA.png"/></div></div></figure><h1 id="4ff3" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">Azure Kubernetes群集配置</h1><p id="9e10" class="pw-post-body-paragraph iy iz hu ja b jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv hn dt translated">让我们使用ACS引擎和下面的命令安装一个包含1个主节点和3个节点的集群，这些节点都运行Linux。</p><p id="fc6c" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我在我的<a class="ae kf" href="https://hackernoon.com/kubernetes-adventures-on-azure-part-3-acs-engine-hybrid-cluster-bc453c13b451" rel="noopener ugc nofollow" target="_blank">Kubernetes Adventures on Azure—第3部分(ACS引擎&amp;混合集群)</a>文章中描述了使用ACS引擎安装集群的详细步骤。详情请参考。在这里，我快速列出了要使用的命令。</p><h2 id="0827" class="lx kv hu bd kw ly lz ma la mb mc md le jj me mf li jn mg mh lm jr mi mj lq mk dt translated"><strong class="ak">创建资源组</strong></h2><p id="f1e7" class="pw-post-body-paragraph iy iz hu ja b jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv hn dt translated">这是将本教程的所有资源分组到一个逻辑组中所需要的，以便能够在最后用一个命令删除所有内容。</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="88e5" class="lx kv hu mm b fv mq mr l ms mt">az group create --name k8sMongoTestGroup --location westeurope</span></pre><h2 id="2e57" class="lx kv hu bd kw ly lz ma la mb mc md le jj me mf li jn mg mh lm jr mi mj lq mk dt translated"><strong class="ak">集群配置</strong></h2><p id="2d55" class="pw-post-body-paragraph iy iz hu ja b jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv hn dt translated">我通常为我在acs上的测试创建一个ssh对。请查看我的文章<a class="ae kf" href="https://hackernoon.com/kubernetes-adventures-on-azure-part-1-e0f68b486679#cf20" rel="noopener ugc nofollow" target="_blank">在这里</a>如何做到这一点。我将更改examples/kubernetes.json文件，以使用之前创建的ssh对、dnsPrefix和servicePrincipalProfile ( <em class="mu">跟随</em> <a class="ae kf" href="https://github.com/Azure/acs-engine/blob/master/docs/kubernetes/deploy.md#step-3-edit-your-cluster-definition" rel="noopener ugc nofollow" target="_blank"> <em class="mu">部署一个kubernetes集群</em> </a> <em class="mu">来自微软</em>的建议)。</p><p id="400b" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我的kubernetes.json文件中用<strong class="ja hv">粗体</strong>表示的变化是:</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="2df2" class="lx kv hu mm b fv mq mr l ms mt">{<br/>  "apiVersion": "vlabs",<br/>  "properties": {<br/>    "orchestratorProfile": {<br/>      "orchestratorType": "Kubernetes",<br/>      "orchestratorRelease": "1.7"<br/>    },<br/>    "masterProfile": {<br/>      "count": 1,<br/>      "dnsPrefix": "<strong class="mm hv">ivank8stest</strong>",<br/>      "vmSize": "Standard_D2_v2"<br/>    },<br/>    "agentPoolProfiles": [<br/>      {<br/>        "name": "agentpool1",<br/>        "count": 3,<br/>        "vmSize": "Standard_D2_v2",<br/>        "availabilityProfile": "AvailabilitySet"<br/>      }<br/>    ],<br/>    "linuxProfile": {<br/>      "adminUsername": "azureuser",<br/>      "ssh": {<br/>        "publicKeys": [<br/>          {<br/>            "keyData": "<strong class="mm hv">ssh-rsa yourpubkeyhere</strong>"<br/>          }<br/>        ]<br/>      }<br/>    },<br/>    "servicePrincipalProfile": {<br/>      "clientId": "<strong class="mm hv">yourappclientid</strong>",<br/>      "secret": "<strong class="mm hv">yourappsecrete</strong>"<br/>    }<br/>  }<br/>}</span></pre><p id="a20c" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">使用以下内容创建您的集群:</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="8021" class="lx kv hu mm b fv mq mr l ms mt">acs-engine deploy --subscription-id <!-- -->c8399910-5ac0-4dc4-98ec-c7774baf9a02<!-- --> \<br/>  --resource-group <!-- -->k8sMongoTestGroup \<br/>  <!-- -->--location <!-- -->westeurope<!-- --> \<br/>  --api-model examples/kubernetes.json</span></pre><p id="f6eb" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">等待群集启动运行:</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="ac7c" class="lx kv hu mm b fv mq mr l ms mt">INFO[0010] Starting ARM Deployment (k8sMongoGroup-2051810234). This will take some time…<br/>INFO[0651] Finished ARM Deployment (k8sMongoGroup-2051810234).</span></pre><p id="0239" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">使用在_output文件夹中部署期间生成的kubeconfig文件连接到它。</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="3a16" class="lx kv hu mm b fv mq mr l ms mt">export KUBECONFIG=~/acs/acs-engine/_output/<strong class="mm hv">ivank8stest</strong>/kubeconfig/kubeconfig.westeurope.json</span></pre><p id="1ecc" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">以下命令可用于确定集群何时就绪:</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="501a" class="lx kv hu mm b fv mq mr l ms mt">kubectl cluster-info<br/>kubectl get nodes</span><span id="6a66" class="lx kv hu mm b fv mv mr l ms mt">NAME                        STATUS    AGE       VERSION<br/>k8s-agentpool1-33584487-0   Ready     46m       v1.7.4<br/>k8s-agentpool1-33584487-1   Ready     46m       v1.7.4<br/>k8s-agentpool1-33584487-2   Ready     46m       v1.7.4<br/>k8s-master-33584487-0       Ready     46m       v1.7.4</span></pre><p id="2ca1" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">现在，如果您想使用UI来检查集群状态，您可以打开Kubernetes Dashboard:<code class="eh mw mx my mm b">kubectl proxy</code>，然后在<a class="ae kf" href="http://127.0.0.1:8001/ui" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8001/UI</a>上打开浏览器</p><h1 id="cac1" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">Helm MongoDB图表</h1><p id="288e" class="pw-post-body-paragraph iy iz hu ja b jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv hn dt translated">Helm是Kubernetes的包装经理。它简化了产品和服务的安装和维护，例如:</p><ul class=""><li id="2e22" class="jw jx hu ja b jb jc jf jg jj jy jn jz jr ka jv kb kc kd ke dt translated">MongoDB</li><li id="9466" class="jw jx hu ja b jb kg jf kh jj ki jn kj jr kk jv kb kc kd ke dt translated">雷迪斯</li><li id="b6b3" class="jw jx hu ja b jb kg jf kh jj ki jn kj jr kk jv kb kc kd ke dt translated">兔子q</li><li id="0e4d" class="jw jx hu ja b jb kg jf kh jj ki jn kj jr kk jv kb kc kd ke dt translated">和许多其他问题</li></ul><p id="dffc" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们将使用它来安装和配置MongoDB副本集。</p><h2 id="67a4" class="lx kv hu bd kw ly lz ma la mb mc md le jj me mf li jn mg mh lm jr mi mj lq mk dt translated"><strong class="ak">舵安装</strong></h2><p id="4e7f" class="pw-post-body-paragraph iy iz hu ja b jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv hn dt translated">先决条件、安装步骤和细节可以在微软的文章<a class="ae kf" href="https://docs.microsoft.com/en-us/azure/container-service/kubernetes/container-service-kubernetes-helm" rel="noopener ugc nofollow" target="_blank">使用Helm在Kubernetes集群上部署容器</a>中找到。</p><p id="24b4" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">具备所有先决条件后，Helm的安装就像运行命令一样简单:</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="1b17" class="lx kv hu mm b fv mq mr l ms mt">helm init --upgrade</span></pre><h2 id="42f8" class="lx kv hu bd kw ly lz ma la mb mc md le jj me mf li jn mg mh lm jr mi mj lq mk dt translated">克隆图表存储库</h2><p id="e9c6" class="pw-post-body-paragraph iy iz hu ja b jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv hn dt translated">让我们克隆图表存储库，以便能够在我们的集群上部署所有东西之前检查和更改MongoDB图表文件:</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="0f1d" class="lx kv hu mm b fv mq mr l ms mt">git clone <a class="ae kf" href="https://github.com/kubernetes/charts.git" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes/charts.git</a></span></pre><p id="96b2" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">现在进入<code class="eh mw mx my mm b">/charts/stable/mongodb-replicaset</code>文件夹。在这里你可以找到组成舵图的所有神器。如果需要，您可以更改<code class="eh mw mx my mm b">values.yaml</code>文件，根据您的需要定制安装。现在，让我们尝试一个标准安装。</p><p id="8a98" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">运行以下命令:<code class="eh mw mx my mm b">helm install .</code>并等待以下输出:</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="8412" class="lx kv hu mm b fv mq mr l ms mt">NAME:   foppish-angelfish<br/>LAST DEPLOYED: Sun Sep 10 20:42:42 2017<br/>NAMESPACE: default<br/>STATUS: DEPLOYED</span><span id="b421" class="lx kv hu mm b fv mv mr l ms mt">RESOURCES:<br/>==&gt; v1/Service<br/>NAME                                  CLUSTER-IP  EXTERNAL-IP  PORT(S)    AGE<br/>foppish-angelfish-mongodb-replicaset  None        &lt;none&gt;       27017/TCP  5s</span><span id="7ecb" class="lx kv hu mm b fv mv mr l ms mt">==&gt; v1beta1/StatefulSet<br/>NAME                                  DESIRED  CURRENT  AGE<br/>foppish-angelfish-mongodb-replicaset  3        1        5s</span><span id="66a2" class="lx kv hu mm b fv mv mr l ms mt">==&gt; v1/ConfigMap<br/>NAME                                        DATA  AGE<br/>foppish-angelfish-mongodb-replicaset        1     5s<br/>foppish-angelfish-mongodb-replicaset-tests  1     5s</span><span id="702c" class="lx kv hu mm b fv mv mr l ms mt">NOTES:<br/>...</span></pre><h2 id="174e" class="lx kv hu bd kw ly lz ma la mb mc md le jj me mf li jn mg mh lm jr mi mj lq mk dt translated">搞定了。</h2><p id="8ada" class="pw-post-body-paragraph iy iz hu ja b jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv hn dt translated">MongoDB Replicaset已经启动并运行了！<strong class="ja hv"> Helm超轻松，功能强大！</strong></p><figure class="km kn ko kp fq iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/1e1d21442c229dbb824f51a1de0eb92b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*TgP46mqoShBuHLK81H5ehA.jpeg"/></div><figcaption class="mz na fg fe ff nb nc bd b be z ek"><strong class="bd nd">Helm is ultra easy and powerful!</strong></figcaption></figure><h2 id="0e19" class="lx kv hu bd kw ly lz ma la mb mc md le jj me mf li jn mg mh lm jr mi mj lq mk dt translated">MongoDB安装测试</h2><p id="4ff0" class="pw-post-body-paragraph iy iz hu ja b jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv hn dt translated">从helm install的输出中选择您的版本名称，并在以下命令中使用它:</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="6916" class="lx kv hu mm b fv mq mr l ms mt">export RELEASE_NAME=<strong class="mm hv">foppish-angelfish</strong></span></pre><p id="79fa" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在这里，我们遵循一条与舵图不同的路径。让我们打开一个与远程Mongo服务器的交互式shell会话！</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="5e8f" class="lx kv hu mm b fv mq mr l ms mt">kubectl exec $RELEASE_NAME-mongodb-replicaset-0 --mongo --shell</span><span id="b69e" class="lx kv hu mm b fv mv mr l ms mt">OUTPUT</span><span id="46f0" class="lx kv hu mm b fv mv mr l ms mt">MongoDB shell version v3.4.8<br/>connecting to: mongodb://127.0.0.1:27017<br/>MongoDB server version: 3.4.8<br/>type "help" for help<br/>...<br/>...<br/>A LOT OF WARNING (I will check these in a future post to clean them up, if possible)<br/>...<br/>...<br/>rs0:PRIMARY&gt;</span></pre><h2 id="5f45" class="lx kv hu bd kw ly lz ma la mb mc md le jj me mf li jn mg mh lm jr mi mj lq mk dt translated">谁是主要的？</h2><p id="5ed7" class="pw-post-body-paragraph iy iz hu ja b jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv hn dt translated">从理论上讲，Pod 0应该是主设备，正如您在rom rs: <strong class="ja hv"> PRIMARY </strong> &gt;提示符中看到的那样。如果不是这种情况，请执行以下命令来查找主机:</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="68c7" class="lx kv hu mm b fv mq mr l ms mt">rs0:SECONDARY&gt; db.isMaster().primary</span></pre><p id="4488" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">请注意主Pod，因为我们将很快杀死它，并使用上面使用的最后一个kubectl exec连接到它。</p><h2 id="d147" class="lx kv hu bd kw ly lz ma la mb mc md le jj me mf li jn mg mh lm jr mi mj lq mk dt translated">故障转移测试</h2><p id="6e23" class="pw-post-body-paragraph iy iz hu ja b jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv hn dt translated">我们需要创建一些数据来检查跨故障的持久性。我们已经连接到mongo shell，创建一个文档并离开会话非常简单:</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="1fae" class="lx kv hu mm b fv mq mr l ms mt">rs0:PRIMARY&gt; db.test.insert({key1: 'value1'})<br/>rs0:PRIMARY&gt; exit</span></pre><p id="c22f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">使用以下命令监控副本集中的更改:</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="7219" class="lx kv hu mm b fv mq mr l ms mt">kubectl run --attach bbox --image=mongo:3.4 --restart=Never --env="RELEASE_NAME=$RELEASE_NAME" -- sh -c 'while true; do for i in 0 1 2; do echo $RELEASE_NAME-mongodb-replicaset-$i $(mongo --host=$RELEASE_NAME-mongodb-replicaset-$i.$RELEASE_NAME-mongodb-replicaset --eval="printjson(rs.isMaster())" | grep primary); sleep 1; done; done';</span><span id="dd47" class="lx kv hu mm b fv mv mr l ms mt">OUTPUT<br/>foppish-angelfish-mongodb-replicaset-0 "primary" : "foppish-angelfish-mongodb-replicaset-0.foppish-angelfish-mongodb-replicaset.default.svc.cluster.local:27017",<br/>foppish-angelfish-mongodb-replicaset-1 "primary" : "foppish-angelfish-mongodb-replicaset-0.foppish-angelfish-mongodb-replicaset.default.svc.cluster.local:27017",<br/>foppish-angelfish-mongodb-replicaset-2 "primary" : "foppish-angelfish-mongodb-replicaset-0.foppish-angelfish-mongodb-replicaset.default.svc.cluster.local:27017",<br/>...<br/>...<br/>...</span></pre><h2 id="b588" class="lx kv hu bd kw ly lz ma la mb mc md le jj me mf li jn mg mh lm jr mi mj lq mk dt translated">干掉初级！</h2><p id="34f9" class="pw-post-body-paragraph iy iz hu ja b jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv hn dt translated">就是这里:<code class="eh mw mx my mm b">kubectl delete pod $RELEASE_NAME-mongob-replicaset-0</code></p><p id="591c" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">MongoDB将开始选举，另一个Pod将成为主设备:</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="bcc1" class="lx kv hu mm b fv mq mr l ms mt">foppish-angelfish-mongodb-replicaset-1 “primary” : “foppish-angelfish-mongodb-replicaset-1.foppish-angelfish-mongodb-</span></pre><p id="92ff" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">与此同时，Kubernetes将立即采取纠正措施，实例化新的Pod 0。</p><h2 id="7915" class="lx kv hu bd kw ly lz ma la mb mc md le jj me mf li jn mg mh lm jr mi mj lq mk dt translated">杀光他们</h2><p id="ff89" class="pw-post-body-paragraph iy iz hu ja b jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv hn dt translated">现在我们必须模拟一场真正的灾难:让我们杀死所有的豆荚，看StatefulSet用所有可用的数据神奇地重建一切。</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="43c3" class="lx kv hu mm b fv mq mr l ms mt">kubectl delete po -l "app=mongodb-replicaset,release=$RELEASE_NAME"<br/>kubectl get po --watch-only</span></pre><p id="e6f8" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">几分钟后，我们的MongoDB副本集将重新联机，我们可以再次测试它，看看我们的数据是否还在那里。</p><h2 id="58c0" class="lx kv hu bd kw ly lz ma la mb mc md le jj me mf li jn mg mh lm jr mi mj lq mk dt translated">最终检查和清理</h2><p id="de63" class="pw-post-body-paragraph iy iz hu ja b jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv hn dt translated">运行以下命令以验证创建的密钥仍然存在:</p><pre class="km kn ko kp fq ml mm mn mo aw mp dt"><span id="8d4b" class="lx kv hu mm b fv mq mr l ms mt">kubectl exec $RELEASE_NAME-mongodb-replicaset-1 --mongo --eval=”rs.slaveOk(); db.test.find({key1:{\$exists:true}}).forEach(printjson)”</span></pre><p id="c7d9" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">像往常一样，你可以用一个简单的Azure CLI 2命令删除一切:<code class="eh mw mx my mm b">az group delete --name k8sMongoTestGroup --yes --no-wait</code></p><h1 id="8cd6" class="ku kv hu bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr dt translated">如何对外公开这个副本集？</h1><p id="cc43" class="pw-post-body-paragraph iy iz hu ja b jb ls jd je jf lt jh ji jj lu jl jm jn lv jp jq jr lw jt ju jv hn dt translated">这是<a class="ae kf" href="https://hackernoon.com/tagged/future" rel="noopener ugc nofollow" target="_blank">future</a>e帖子的主题。这看起来微不足道，但并不容易。<br/>如果您公开现有服务，它将在其后面的3个节点上进行负载平衡，这是错误的。我们需要3个负载平衡器，公开3个服务，StatefulSet中的每个Pod一个。此外，我们必须激活身份验证和SSL，以确保从<a class="ae kf" href="https://hackernoon.com/tagged/security" rel="noopener ugc nofollow" target="_blank">安全性</a>角度来看的最佳实践。</p><p id="0f15" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我会找到最好的方法去做，同时玩Heml，Kubernetes，MongoDB和Azure！</p><figure class="km kn ko kp fq iv"><div class="bz el l di"><div class="ne nf l"/></div></figure></div></div>    
</body>
</html>