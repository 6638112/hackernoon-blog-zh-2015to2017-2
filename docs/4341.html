<html>
<head>
<title>Man in the Middle iOS Attacks: The Danger of Relying on a Single Layer of Security</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">中间人iOS攻击:依赖单一安全层的危险</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/man-in-the-middle-ios-attacks-the-danger-of-relying-on-a-single-layer-of-security-d39096c207a9?source=collection_archive---------2-----------------------#2017-05-26">https://medium.com/hackernoon/man-in-the-middle-ios-attacks-the-danger-of-relying-on-a-single-layer-of-security-d39096c207a9?source=collection_archive---------2-----------------------#2017-05-26</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="9a76" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">作者注:这篇文章不会研究任何新的漏洞。相反，它探索了在琐碎的 <a class="ae jq" href="https://hackernoon.com/tagged/hacking" rel="noopener ugc nofollow" target="_blank"> <em class="jp">入侵</em> </a> <em class="jp"> iOS应用程序中使用的一种常见方法，在这种方法中，你对自己进行中间人(MitM)攻击。</em></p><p id="23d5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">此外，您还需要对中间人攻击、SSL和HTTP协议有初步的了解。它是为普通读者编写的，因此为了本文的目的，对一些示例进行了简化。</em></p><h1 id="9c25" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">通用设计模式</h1><p id="d9ea" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">作为一名iOS开发人员，你通常希望以比苹果允许的应用更新速度更快的速度推送更新/更改。此外，经常会有一些小的变化(实际上是几个字节)，需要所有用户下载更新的二进制文件，这可能有几百兆字节的大小。</p><p id="3d80" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您经常更改某些参数，那么远程调用它们可能是有意义的。对服务器上的配置文件进行简单的更改，就可以快速有效地传播您的更改。然而，如果在应用程序中设置的参数很关键，它可能会使您的应用程序暴露于漏洞和MitM攻击。</p><p id="e65e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这最常见于手机游戏、有p2p需求的应用，以及需要快速更新的应用(新闻、社交媒体等)。)</p><h1 id="d51c" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">拦截请求</h1><p id="8327" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">作为一名移动设备开发人员，最初可能不会想到拦截他们的网络请求会很容易，而且简单地使用https就足以阻止任何人四处窥探。然而，当您处理需要频繁更新的互连模型时，您将自己暴露在一个全新的攻击媒介面前——当用户对自己进行中间人攻击时。</p><p id="baaa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">虽然没有方法可以完全防止用户拦截自己的连接，但是有一些设计模式可以减轻这种风险。</p><figure class="kv kw kx ky fq kz fe ff paragraph-image"><div class="fe ff ku"><img src="../Images/940053cdc8479a0ba6262c1f83404942.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*jW6wKoVIoJIfTE0z2caIzg.png"/></div></figure><p id="a661" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">作为概念验证，看一下Tap Tap Reborn。大约50万用户，游戏外有一个活跃的社区，相对昂贵的应用内购买(高级20美元，750个“宝石”10美元)。</p><p id="89af" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jq" href="https://support.portswigger.net/customer/portal/articles/1841108-configuring-an-ios-device-to-work-with-burp" rel="noopener ugc nofollow" target="_blank">要拦截iOS网络请求，我建议遵循PortSwigger </a>的指南。此外，在较新版本的iOS中，您需要允许完全信任根证书，方法是前往设置- &gt;通用- &gt;关于- &gt;证书信任设置。</p><p id="c8e0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在首次加载应用程序时，它会尝试从EC2实例下载配置文件——不对输入进行验证或确认。这些规定了一切，从默认设置、可用歌曲、要求的点数级别，到每个动作的“奖励”。</p><figure class="kv kw kx ky fq kz fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff lc"><img src="../Images/4efee035e675136d93f909937817039e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BVqczBBncpFggMTTTKpRmw.png"/></div></div><figcaption class="lh li fg fe ff lj lk bd b be z ek">Example config file that tells the app how much EXP is required for each level</figcaption></figure><figure class="kv kw kx ky fq kz fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff ll"><img src="../Images/237a6672097cc54ce044b2cda1e53f2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UXff7S68wWxibl0zAaKPOQ.png"/></div></div></figure><p id="127c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这些配置文件的内容没有任何形式的验证。此外，每次运行应用程序时，它都会用一个包含您所有详细信息的大型JSON对象来更新服务器。同样，没有验证或加密。</p><figure class="kv kw kx ky fq kz fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff lm"><img src="../Images/4e90fee785822039cbbe3b7afce09a61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ekm_ohG9Tkx2IFjivlmrRA.png"/></div></div><figcaption class="lh li fg fe ff lj lk bd b be z ek">POSTing updates to the server for games you’ve played since last update</figcaption></figure><p id="d3fe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">真正有意思的是，这个应用程序在加载时会用你上次签名后的进度来更新服务器。它也不基于事件进行这些更新(比如，如果您播放了3首歌曲，它会提交3个带有歌曲详细信息的事件，并记录您的XP)，相反，它只接受一个大的JSON profile对象。</p><p id="1243" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">服务器盲目地接受任何发送过来的东西。<em class="jp">在这里改变数值准确地反映了服务器端！</em></p><p id="00b4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，拦截单个请求并修改值，然后清除应用程序并通过脸书重新登录将允许你设置你的宝石，等级和经验值为你喜欢的任何东西。作为alpha用户，你也可以将自己设置为premium，以及每首歌曲的最高分。</p><p id="bb45" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过这种方法，一个人很容易成为世界第一玩家，并给自己任意数量的游戏内货币。</p><figure class="kv kw kx ky fq kz fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff ln"><img src="../Images/bff07652aec950ad8413213095dac260.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GesBkLt-ElE16oMtJDGdHQ.jpeg"/></div></div></figure><p id="f204" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">那批宝石相当于<em class="jp">18.7万美元。</em>当然，它实际上根本不值这个数目，但很容易想象，在更重要的产品或SaaS产品上，由于付款或购买未经验证，你会很容易地积累费用。</p><h1 id="5954" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">可能的解决方案</h1><p id="1ddc" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">应该如何解决这个问题？我们将探索一些常用的方法来缓解这种攻击媒介。</p><h2 id="ef93" class="lo js hu bd jt lp lq lr jx ls lt lu kb jc lv lw kf jg lx ly kj jk lz ma kn mb dt translated">散列内容并验证</h2><p id="5fdd" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">突破难度:微不足道</p><p id="e828" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">嵌入盐的难度:中等</p><p id="19a6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个问题的第一个解决方案是在数据中包含一个散列，看起来有点像这样:</p><figure class="kv kw kx ky fq kz fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff mc"><img src="../Images/3ded8e1edf1a3879bc3ecffa541f1e8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8G0CQYOJ9T1c10SaR8CjNg.png"/></div></div></figure><p id="e3d1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这对于测试你的信息的有效性和没有损坏是很好的，但它不是一个有效的<a class="ae jq" href="https://hackernoon.com/tagged/security" rel="noopener ugc nofollow" target="_blank">安全</a>方法——你需要做的只是在将数据包转发到设备之前重新散列信息和替换散列。</p><p id="dc3c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当你在二进制文件中嵌入了一个salt时，这变得更加可行。这更正式地称为“共享密钥”类型的加密。例如，如果在对照哈希验证数据之前，将“My$ecure$@lt”附加到数据的末尾，就可以防止任何纯粹的中间人攻击。攻击者必须反编译并检查二进制文件，这是可行的，但比简单的MitM攻击需要更多的努力和知识。</p><figure class="kv kw kx ky fq kz fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff md"><img src="../Images/a2a10262dc40638915e04b9092a98748.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hs1iTCwx9FiR9Z05PKpFVw.png"/></div></div><figcaption class="lh li fg fe ff lj lk bd b be z ek">What the hashing/verification would look like internally to your iOS application — it would append the salt, then hash it and verify against the provided hash. This is a “shared secret” method of encryption.</figcaption></figure><p id="7db3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过使用obfuscator，<a class="ae jq" href="https://github.com/pjebs/Obfuscator-iOS" rel="noopener ugc nofollow" target="_blank">比如Obfuscator-iOS </a>，这种方法可以变得更加安全。然而，这仍然不能阻止专门的攻击者。</p><h2 id="a1b0" class="lo js hu bd jt lp lq lr jx ls lt lu kb jc lv lw kf jg lx ly kj jk lz ma kn mb dt translated">自定义加密</h2><p id="ee20" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">突破难度:中等/困难</p><p id="3859" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这更像是模糊的设计，而不是清晰开放的设计，但是它会给大多数攻击者设置一个不小的路障。这种模式会以某种方式对数据内容进行加密。这可以从简单的编码(base-64)一直到PGP，甚至是滚动你自己的加密(<a class="ae jq" href="https://security.stackexchange.com/questions/18197/why-shouldnt-we-roll-our-own" rel="noopener ugc nofollow" target="_blank">我不推荐——一个系统在被彻底攻击之前是不安全的</a>)。这将再次需要某种形式的密钥隐藏在二进制文件中，这不是不可能的逆向工程和提取。</p><p id="3ca1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将挫败除了最专注的攻击者之外的所有人。纯粹的MitM攻击是不够的，需要大量的知识来计算如何解密。</p><p id="837f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这种方法的缺点是，它需要更多的计算资源，并且给系统增加了另一层抽象。</p><h2 id="f38a" class="lo js hu bd jt lp lq lr jx ls lt lu kb jc lv lw kf jg lx ly kj jk lz ma kn mb dt translated">证书锁定</h2><p id="969d" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">突破难度:困难</p><p id="e99b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">证书锁定包括验证加密/返回信息的证书是否与一组已知的证书相匹配，也就是说，它没有在两者之间被“换出”。这可以说是防止MitM攻击的最安全的方法之一——设备不会接受任何未经嵌入证书签名的连接。</p><p id="e5b8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">绕过这个的唯一方法是越狱设备，手动禁用SSL验证或者用Burp Suite替换嵌入的证书。这将需要更复杂的攻击级别，如果您的设备越狱/扎根，那么还有多个其他攻击媒介需要考虑。</p><h2 id="c050" class="lo js hu bd jt lp lq lr jx ls lt lu kb jc lv lw kf jg lx ly kj jk lz ma kn mb dt translated">更好的建筑设计</h2><p id="7ef4" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">安全系统的最佳方法是从一开始就考虑安全性。这意味着保护您的终端，并有意识地决定每次会话应该更新哪些信息，以及每个阶段需要多少级别的验证。它包括对您的应用程序有一个更抽象、更有安全意识的观点，以及它可能有哪些攻击媒介。在上面的示例中，最小化这些向量意味着每次会话需要刷新尽可能少的信息，而不是从实时配置中提取某些关键组件。</p><h1 id="da8e" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">适用性和进一步研究</h1><p id="8545" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">中间人攻击并不是什么新鲜事，这与其说是一个突破性的发现，不如说是一个安全范例的应用。然而，作为一名开发人员，您通常更关注防止外部攻击者破坏您用户的数据完整性，而不是防止由您的用户自己执行的MitM攻击。</p><p id="0e3c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Snapchat和脸书已经实现了证书锁定，因为这是防止任何第三方在连接过程中修改数据的最可靠、最安全的方法之一(截至本文撰写之时)。这并不是不可能绕过(越狱设备见<a class="ae jq" href="https://github.com/iSECPartners/ios-ssl-kill-switch" rel="noopener ugc nofollow" target="_blank"> iOS Kill Switch </a>)，但在这一点上，攻击者将获得比单个HTTP连接更多的访问权限。</p><p id="ccff" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这篇文章旨在说明一种常见的不良设计模式，以及iOS应用程序完全依赖SSL/TLS会导致怎样的后果，从收入损失到应用程序的完全妥协。在iOS上尤其如此，在iOS上很容易简单地依赖Swift的HTTP请求，而不用考虑用户用自己的证书替换证书。</p><div class="kv kw kx ky fq ab cb"><figure class="me kz mf mg mh mi mj paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="me kz mf mg mh mi mj paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="me kz mf mg mh mi mj paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mk ml mm"><p id="f922" class="ir is jp it b iu iv iw ix iy iz ja jb mn jd je jf mo jh ji jj mp jl jm jn jo hn dt translated"><a class="ae jq" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jq" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jq" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jq" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is jp it b iu iv iw ix iy iz ja jb mn jd je jf mo jh ji jj mp jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jq" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jq" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kv kw kx ky fq kz fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff mq"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="kv kw kx ky fq kz"><div class="bz el l di"><div class="mr ms l"/></div></figure></div></div>    
</body>
</html>