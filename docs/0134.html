<html>
<head>
<title>Building Periscope fast rewind control for iOS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为iOS建立潜望镜快速倒带控制</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/building-periscope-fast-rewind-control-for-ios-5cb6801db0fd?source=collection_archive---------1-----------------------#2016-01-05">https://medium.com/hackernoon/building-periscope-fast-rewind-control-for-ios-5cb6801db0fd?source=collection_archive---------1-----------------------#2016-01-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="8e21" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">圣诞节结束了。除夕也过完了。我希望每个人都过得很愉快，并且你已经准备好开始努力工作和学习新的东西了！</p><p id="a539" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我想从今年的一篇精彩文章开始——关于如何创建类似于<a class="ae jp" href="https://itunes.apple.com/us/app/periscope/id972909677?mt=8" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">潜望镜</strong> </a>快速倒带控件的教程。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/e26b49fc7286f3f2795c20fa10be0b2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/1*6JLzAWxZsXHvwebRfig9bw.gif"/></div></figure><h2 id="6147" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated">要求</h2><ol class=""><li id="acc0" class="kt ku hu it b iu kv iy kw jc kx jg ky jk kz jo la lb lc ld dt translated">Xcode 7+</li><li id="fc33" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated"><a class="ae jp" href="https://hackernoon.com/tagged/ios" rel="noopener ugc nofollow" target="_blank"> iOS </a> 8+</li><li id="b6f0" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">至少基本的Swift知识</li><li id="dd87" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">对iOS和开发充满热情</li></ol></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><h2 id="ad98" class="jy jz hu bd ka kb kc kd ke kf kg kh ki jc kj kk kl jg km kn ko jk kp kq kr ks dt translated">高层解释</h2><p id="2703" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc lq je jf jg lr ji jj jk ls jm jn jo hn dt translated">为了构建这个组件，我们必须使用视频播放器— <a class="ae jp" href="https://developer.apple.com/library/ios/documentation/AVFoundation/Reference/AVPlayer_Class/" rel="noopener ugc nofollow" target="_blank"> AVPlayer </a>。我们将添加<a class="ae jp" href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UILongPressGestureRecognizer_Class/" rel="noopener ugc nofollow" target="_blank">UILongPressGestureRecognizer</a>来开始倒带和计算手指平移——它将帮助我们改变倒带速度和计算时间。在倒带过程中，我们将使用<a class="ae jp" href="https://developer.apple.com/library/tvos/documentation/UIKit/Reference/UIVisualEffectView/index.html" rel="noopener ugc nofollow" target="_blank"> UIVisualEffectView </a>模糊视频，使用<a class="ae jp" href="https://developer.apple.com/library/mac/documentation/AVFoundation/Reference/AVAssetImageGenerator_Class/" rel="noopener ugc nofollow" target="_blank"> AVAssetImageGenerator </a>生成预览缩略图。</p><p id="5c5f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好的。不说了，<a class="ae jp" href="https://www.youtube.com/watch?v=ZXsQAXx_ao0" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">就这么办</strong> </a>。</p></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><p id="4c25" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">创建单视图应用程序并创建新类<strong class="it hv">video view controller</strong>—uiview controller的子类。导入<strong class="it hv"> AVFoundation </strong>并将这段代码放入类声明中:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="ef81" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们在这里做的一切都很简单:</p><ol class=""><li id="21d7" class="kt ku hu it b iu iv iy iz jc lv jg lw jk lx jo la lb lc ld dt translated">声明了所有与AVPlayer相关的变量，我们将在未来使用这些变量；</li><li id="758c" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">用videoURL创建了自定义初始化器，其中我们设置了URL并初始化了所有—avurlasse、AVPlayerItem、AVPlayer和AVPlayerLayer</li><li id="1bf4" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">在<strong class="it hv"> loadView </strong>中，我们添加玩家来查看子层；</li><li id="3eda" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">在<strong class="it hv"> viewDidLoad </strong>中，我们简单地开始播放视频；</li><li id="4168" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">在<strong class="it hv"> prefersStatusBarHidden </strong>中，我们返回<strong class="it hv">true</strong>——如果我们的状态栏基于视图控制器，它会隐藏状态栏(可以在<em class="ly"> Info.plist </em>文件中更改)。</li><li id="a878" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">只需将playerLayer的框架设置为view.bounds —我们支持纵向和横向。</li></ol><p id="b1ce" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好的。我们的视频查看控制器已准备好进行早期测试。为了测试它，我们必须做两个简单的步骤:</p><ol class=""><li id="fe01" class="kt ku hu it b iu iv iy iz jc lv jg lw jk lx jo la lb lc ld dt translated"><a class="ae jp" href="http://www.filedropper.com/resources" rel="noopener ugc nofollow" target="_blank">下载这个ZIP文件</a>，解压<strong class="it hv">资源</strong>文件夹并添加到您的项目<em class="ly">(不要忘记选择需要的目标)</em>；</li><li id="f55c" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">打开<strong class="it hv"> ViewController.swift </strong>文件，将以下代码放入其中:</li></ol><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="60a1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，在您的设备或模拟器上运行project，并确保视频视图控制器存在，视频正在播放，并且所有方向都受支持。</p></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><p id="79ee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们的下一步是识别触摸和模糊内容。</p><p id="02c9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在<strong class="it hv"> VideoViewController </strong>中声明这两个变量:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="e275" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将此代码粘贴到<strong class="it hv"> loadView </strong>方法的末尾:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="b481" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将此代码添加到<strong class="it hv">viewlllayoutsubviews</strong>方法的末尾:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="f9f3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">实现此功能:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="c991" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此功能的目的是当触摸开始时暂停视频并淡出视觉效果视图，当触摸取消、结束或失败时恢复视频并淡出视觉效果视图。将来我们会给这个方法添加更多的逻辑。</p><p id="69f4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">运行项目并测试长按。</p><p id="f8be" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就是它在我的设备上的工作方式:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/ae24255c1cb5a170acb1b121f79b54fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/1*t5421kRy9QxibtK0KU9jhw.gif"/></div></figure></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><p id="c764" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下一步是创建时间轴视图并实现倒带功能。但是让我们快速浏览一下<a class="ae jp" href="https://hackernoon.com/tagged/periscope" rel="noopener ugc nofollow" target="_blank">潜望镜</a> UI来理解我们的时间线到底应该是什么样的，以及它应该如何工作。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff lz"><img src="../Images/efe584ebd43b1c34397319921a1c3c73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*p_0atw2UJTEEXOm-MEAaSw.png"/></div></figure><p id="9b30" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如您所见，时间轴从视图控制器的左侧延伸到右侧。它有一个白点，指示当用户开始倒带时视频停止的位置。如果你比较截图，你会注意到，间隔宽度是不同的——这是因为倒带速度(在我们的项目中，我们称之为<strong class="it hv">缩放</strong>)值不相等。最后要注意的是，当前时间总是在时间轴的中间。</p><p id="ccca" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">创建<strong class="it hv"> TimelineView </strong>作为UIView的子类，并声明这些变量:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="993e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每个变量的目的都很明显，但让我们确保每个人都明白:</p><ol class=""><li id="03fa" class="kt ku hu it b iu iv iy iz jc lv jg lw jk lx jo la lb lc ld dt translated"><strong class="it hv">时长</strong> —一段视频的总时长，单位为秒；</li><li id="c96d" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated"><strong class="it hv"> initialTime </strong> —倒带开始的秒数；</li><li id="e86a" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated"><strong class="it hv">当前时间</strong> —以秒为单位的当前时间；</li><li id="06c5" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated"><strong class="it hv"> _zoom </strong> —存储缩放值的私有变量；</li><li id="4d56" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated"><strong class="it hv"> zoom </strong> —在_zoom变量的顶部换行，这样当新值被赋值时，我们可以检查它是否在可接受的范围内；</li><li id="c0c1" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated"><strong class="it hv"> minZoom </strong>和<strong class="it hv"> maxZoom </strong> —这两个变量都定义了缩放的可接受范围；</li><li id="ee51" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated"><strong class="it hv"> intervalWidth </strong> —代表时间线上特定时间间隔的线条宽度。如果缩放不等于1，则实际间隔宽度等于<strong class="it hv">间隔宽度*缩放</strong>。计算时将在倒回过程中使用该值—例如，如果zoom为1，intervalWidth为30，intervalDuration为15，则当用户向左或向右移动10个像素时，我们将倒回+5或-5秒；</li><li id="0aff" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated"><strong class="it hv"> intervalDuration </strong> —以秒为单位的间隔持续时间。如果视频是55秒，间隔是15秒，那么我们将有3个完整的间隔和一个不完整的间隔。值将在倒带期间用于计算。</li></ol><p id="5097" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">minZoom、maxZoom、intervalWidth和intervalDuration可以是常量，但我决定将它们设为变量——如果您想在不同的视频中重用此视图控制器，您可能需要调整这些值。</p><p id="677f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">实现这些功能:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><ol class=""><li id="c9d6" class="kt ku hu it b iu iv iy iz jc lv jg lw jk lx jo la lb lc ld dt translated"><strong class="it hv"> currentIntervalWidth </strong> —根据缩放值计算间隔宽度；</li><li id="1870" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated"><strong class="it hv">time interval from distance</strong>—计算从通过宽度开始的时间间隔，单位为秒。会被用来按距离倒带；</li><li id="e4e2" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated"><strong class="it hv">distance from time interval</strong>—根据给定的时间间隔计算距离。将用于计算经过的间隔宽度；</li><li id="0c19" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated"><strong class="it hv">rewindbyddistance</strong>—获取距离，计算时间间隔，并将该值添加到当前时间。</li></ol><p id="3c13" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">实现绘制矩形:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="e12a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不要害怕。这里的一切都很简单:)我将只解释那些我认为可能需要解释的事情:</p><ol class=""><li id="fa10" class="kt ku hu it b iu iv iy iz jc lv jg lw jk lx jo la lb lc ld dt translated">正如你之前可能注意到的——当我们在潜望镜中倒带时，时间线从左向右移动。为了实现这种移动，我们计算出<strong class="it hv"> originX </strong>值，并应用到我们所有的绘图中；</li><li id="0e3b" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">我们画第一条线，表示完整的时间线；</li><li id="bdc0" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">我们画第二条线，表示经过的时间；</li><li id="aeb6" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">我们画点表示初始时间；</li><li id="3ce5" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">最后，我们在区间之间画分隔符。</li></ol><p id="44b6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">时间轴视图的最后一位——实现新的初始化器并将<strong class="it hv"> opaque </strong>设置为<strong class="it hv"> false </strong>:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="331b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我感觉我们的时间线结束了。下一步是将其添加到视图控制器并使其工作！</p><p id="fe1a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">添加这些变量:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="4d00" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">第一个变量是内容视图，其中将添加所有与回放相关的视图/控件。当倒带开始和结束时，我们将淡入和淡出这个视图。第二个变量是我们在前一阶段实现的实际时间线视图。最后一个变量将帮助我们计算手指移动了多远，我们应该倒回多远。</p><p id="bdcd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将这段代码放在<strong class="it hv"> loadView </strong>方法的末尾:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="09aa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它将所有新的子视图添加到它们的监督视图中，并将时间线的持续时间设置为资产的持续时间。</p><p id="3ec5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">用此代码更新<strong class="it hv">长按</strong>功能:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><ol class=""><li id="9cbb" class="kt ku hu it b iu iv iy iz jc lv jg lw jk lx jo la lb lc ld dt translated">我们已经添加了代码来获取手指的当前位置；</li><li id="e65b" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">我们根据手指位置计算缩放值。你可以玩这种计算，但我更喜欢这种计算；</li><li id="91df" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">当倒带开始时，我们添加了逻辑来设置时间轴的初始时间；</li><li id="1675" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">当手势状态等于时，我们调用rewindByDistance方法。变了；</li><li id="504f" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">我们淡入淡出新创建的内容视图；</li><li id="374a" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">如果前一个位置x不等于当前位置，我们就更新它。</li></ol><p id="fee7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们尝试之前的最后一个阶段是布局我们新创建的视图。将此代码放在<strong class="it hv">viewlllayoutsubviews</strong>的末尾:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="7e48" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在您的设备或模拟器上运行project并检查它！</p><p id="43d2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是它在我的设备上的外观:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/1db10d16392b1cd6026761e96c445c37.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/1*JkT3wjTusFLaY34eBuYm6A.gif"/></div></figure><p id="b3cf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我真的希望你能做好每一件事，并且工作起来完全一样。如果没有——赶紧再去扔教程。</p><p id="4dfc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正如你可能已经注意到的，当我们松开手指时，它不会倒带。为了使用以下代码添加更新长按函数:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="b1f3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们增加了两条新线路——17号线和18号线。用第一行我们计算新时间，用第二行我们寻找那个时间。</p><p id="8375" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">再次运行您的项目..尽情享受吧！</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/659505ba444422b44d36fda0bcea271c.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/1*qrIxeqbT62yy-w5MBbhkyA.gif"/></div></figure><p id="501d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在能用了！</p><p id="ed13" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">懒惰的人可以在这个阶段关闭教程<em class="ly">(希望你不懒惰)</em>，因为核心的东西已经建立，下一阶段主要是改进和一些不错的功能。</p></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><p id="0bc2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们的目标是添加两个新视图:</p><ol class=""><li id="0ab1" class="kt ku hu it b iu iv iy iz jc lv jg lw jk lx jo la lb lc ld dt translated">预览图像视图将显示当前回放时间的视频缩略图；</li><li id="a29d" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">标签，它将以分:秒的格式显示当前倒带时间。</li></ol><p id="9f9e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了更新这些视图，我决定给时间线视图添加闭包，每当<strong class="it hv">当前时间</strong>值改变时就会触发。</p><p id="d791" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将此变量添加到<strong class="it hv">时间线视图</strong>:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="93df" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">更新<strong class="it hv"> currentTime </strong>变量实现:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="ecf8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将这些变量添加到<strong class="it hv"> VideoViewController </strong>类:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="de7f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将这两行添加到<strong class="it hv"> init(videoURL: NSURL) </strong>的末尾:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="bb8d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最大尺寸指定生成图像的最大尺寸。我们希望最大高度为<strong class="it hv"> rewindPreviewMaxHeight </strong>。生成的图像从未按比例放大。但是在大多数情况下，视频大小比预期的缩略图大得多。</p><p id="d255" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将这几行添加到loadView方法的末尾:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="f9f7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">用以下代码更新<strong class="it hv"> viewWillLayoutSubviews </strong>函数:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="656f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">随意更改<strong class="it hv">垂直间距</strong>值。它表示预览图像视图、当前时间标签和时间线视图之间的间隙高度。</p><p id="90be" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这一部分的最后一步是实现<strong class="it hv">currentdimedidchange</strong>闭包。在将时间线视图添加到其superview之前添加以下代码:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><ol class=""><li id="0713" class="kt ku hu it b iu iv iy iz jc lv jg lw jk lx jo la lb lc ld dt translated">我们生成当前时间字符串并赋值给rewindCurrentTimeLabel.text</li><li id="e7de" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">我们用当前时间和要求的时间刻度初始化请求的时间；</li><li id="c570" class="kt ku hu it b iu le iy lf jc lg jg lh jk li jo la lb lc ld dt translated">我们异步生成CGImages。完成后，我们尝试从CGImage生成UIImage，切换到主线程，将图像设置为预览图像视图，并在需要时请求调用布局子视图。</li></ol><p id="bcda" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">运行您的项目并享受！看起来棒极了！</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/85fd8a3fece2cb556c19d311573c204c.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/1*CxSIODFbzergTwce0bVkcA.gif"/></div></figure></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><p id="f6dc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们做最后的润色！在潜望镜中，它们在预览图像视图后面有一个很好的阴影。我们也会添加它！</p><p id="181e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将该变量添加到<strong class="it hv">视频视图控制器</strong>:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="c1b5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在设置rewindPreviewImageView并将其添加到子视图<em class="ly">之前，将此代码块添加到<strong class="it hv"> loadView </strong>函数中(如果您在rewindPreviewImageView之后添加它，那么它将在层层次结构中处于较高位置，并将显示在ImageView的顶部)</em>:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="d3c7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于那些不理解第6行的目的的人，我建议阅读一下关于<a class="ae jp" href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreAnimation_guide/CreatingBasicAnimations/CreatingBasicAnimations.html" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv"> iOS隐式动画</strong> </a>。</p><p id="dd1f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">更新视图viewWillLayoutSubviews:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="f295" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">跑去看看。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff ma"><img src="../Images/c6539e1da8a12670e5214fd9f2554c1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OIYT_ktqY9qOhgxp3aHFiA.png"/></div></div></figure><p id="fc95" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一切都很好。但是..等待..我们的预览图像是像素化的！</p><p id="4ab0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">是因为<strong class="it hv">avassetimagegenerator . maximumsize</strong>期望我们提供像素而不是点。关于点和像素有何不同的文档可以在<a class="ae jp" href="https://developer.apple.com/library/ios/documentation/2DDrawing/Conceptual/DrawingPrintingiOS/GraphicsDrawingOverview/GraphicsDrawingOverview.html#//apple_ref/doc/uid/TP40010156-CH14-SW7" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">这里</strong> </a>找到。</p><p id="0c36" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们解决这个小问题。</p><p id="87b2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在全班更新这句话:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="2c7a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有了这个:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="bdd5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在再次运行项目。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff ma"><img src="../Images/33d34cb22fb8346682608ff0be95ee0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cGwg-CTA2x56CUIpX-2YfQ.png"/></div></div></figure><p id="ab45" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">发生什么事了..我们的影子在哪里？！我们的拐角半径在哪里？！</p><p id="976a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们忘记了一件小事—<strong class="it hv">AVAssetImageGenerator</strong>返回给我们CGImage，我们用CGImage初始化UIImage，但没有提供所需的比例。在我们的例子中，我们需要的尺度是<strong class="it hv"> UIScreen.mainScreen()。标度</strong>。</p><p id="3562" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">找到这条线:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="6c21" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">用这个更新:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="706e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">又是润！</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff ma"><img src="../Images/0e261a876e7371dbaea5c64d30bc0a4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WQVivC4_bjpJBTMSgzSMyQ.png"/></div></div></figure><p id="d30d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">精彩！一切都回来了，它工作得很好！呜呜呜。！！</p></div><div class="ab cl lj lk hc ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hn ho hp hq hr"><p id="dba1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">感谢你去扔本教程。如果你喜欢它，请按下心形按钮，并与你的朋友和同事分享。</p><p id="2a04" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">源代码从本教程与一些改进和更多的功能可以下载<a class="ae jp" href="https://github.com/gontovnik/Periscope-VideoViewController" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">这里</strong> </a>。</p><p id="e077" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我的下一篇文章——教程中再见！再见！</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="mf lu l"/></div></figure></div></div>    
</body>
</html>