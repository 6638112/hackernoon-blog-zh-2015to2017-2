<html>
<head>
<title>Rust for the Particle Photon</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">粒子光子的铁锈</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/rust-for-the-particle-photon-8e1156b7085a?source=collection_archive---------15-----------------------#2017-07-18">https://medium.com/hackernoon/rust-for-the-particle-photon-8e1156b7085a?source=collection_archive---------15-----------------------#2017-07-18</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/8ee658e78e393a2d3ee97d5f3565defc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_0H8Fr5L9vnSaZap_QhFJg.jpeg"/></div></div></figure><div class=""/><p id="c24f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">不久前，我还是一名移动开发者。我为iOS开发应用程序，不得不经常担心内存消耗、性能，你知道，所有那些让电脑变得很难的无聊事情。</p><p id="b9f2" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">后来我成了一名网页开发人员。我踢我的脚，让虚拟机为我工作。记忆？Psh，多买ram小气鬼。<a class="ae ka" href="https://hackernoon.com/tagged/memory" rel="noopener ugc nofollow" target="_blank">内存</a>泄露？谁会让一个网页打开足够长的时间以至于出现漏洞呢？停止从你的工作笔记本电脑上播放视频，使用Chromecast，这是一种在家进行的活动，所以没人知道你爱单身汉。</p><p id="8e87" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我也有两只狗。他们很棒，但我总觉得他们没有足够酷的东西属于自己。当然，他们有喜欢吃的玩具，但我是一个技术人员，他们是没有技术的狗，这有点尴尬。</p><p id="9d7e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">所以，很自然地，我开始尝试为勒德分子的绒毛球做一个恶狗项圈。我拿起一些粒子光子(这很棒，强烈推荐)，然后去参加比赛，<a class="ae ka" href="https://hackernoon.com/tagged/programming" rel="noopener ugc nofollow" target="_blank">用baby C和C++编程</a>，就像大学里的数据结构一样，除了没有宿醉和视频游戏。好吧，还带着宿醉，只是没有电子游戏。好吧，还是玩电子游戏。</p><p id="e0d8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">用那些旧语言编程并不太糟糕，它们有非常正常的特性，字符串是一种痛苦，但是包含的库在那里提供了一些很好的支持。然后，当我认为一切都很顺利的时候,《天堂单身汉》被关闭了——哦，我的程序也神秘地崩溃了。结果发现这个问题是代码中的内存泄漏，因为，当然，我已经有<em class="kb">年</em>没有关注手动内存管理了。</p><p id="978f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我继续努力，试图记住像冠军一样分配和分配，直到我的好朋友威尔建议我试试Rust。他将其描述为“进行内存管理的正确方法”，现在我可以说我同意了。</p><p id="c854" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这时候我开始尝试移植我的狗项圈代码生锈。</p></div><div class="ab cl kc kd hc ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hn ho hp hq hr"><p id="3aed" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对豪尔赫·阿帕里西奥(Jorge Aparicio)大声喊出来，他在这一切中给了我很大的帮助。这家伙有克里斯·哈里森在玫瑰仪式上的耐心。</p><p id="b572" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我从Jorge令人敬畏的quickstart自述文件开始，并能够快速启动和运行我的代码。老实说，我对它的简单程度感到惊讶。我还需要使用几个用C/C++编写的库来实现基本功能。就在那时，我绊了一跤，掉进了兔子洞。</p><p id="2c8b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Jorge给了我一些很好的指导，基本上有几个步骤:</p><ul class=""><li id="b294" class="kj kk if je b jf jg jj jk jn kl jr km jv kn jz ko kp kq kr dt translated">获取C/C++库</li><li id="09c4" class="kj kk if je b jf ks jj kt jn ku jr kv jv kw jz ko kp kq kr dt translated">将<code class="eh kx ky kz la b">bindgen</code>和<code class="eh kx ky kz la b">gcc</code>板条箱添加到您的项目中。</li><li id="a80d" class="kj kk if je b jf ks jj kt jn ku jr kv jv kw jz ko kp kq kr dt translated">创建一个build.rs文件</li><li id="2615" class="kj kk if je b jf ks jj kt jn ku jr kv jv kw jz ko kp kq kr dt translated">将build.rs文件添加到cargo.toml文件中的<code class="eh kx ky kz la b">[package]</code>下，如下所示:</li></ul><pre class="lb lc ld le fq lf la lg lh aw li dt"><span id="261b" class="lj lk if la b fv ll lm l ln lo">build = "build.rs"</span></pre><ul class=""><li id="a24f" class="kj kk if je b jf jg jj jk jn kl jr km jv kn jz ko kp kq kr dt translated">使用<code class="eh kx ky kz la b">bindgen</code>，从您想要导入的库的头文件中生成rust绑定。换句话说，向构建文件的main函数中添加如下内容:</li></ul><pre class="lb lc ld le fq lf la lg lh aw li dt"><span id="6e80" class="lj lk if la b fv ll lm l ln lo">let bindings = bindgen::Builder::default()<br/>  .no_unstable_rust()<br/>  .header("src-cpp/some-library.hpp")<br/>  .generate()<br/>  .expect("Unable to generate bindings");</span><span id="f04b" class="lj lk if la b fv lp lm l ln lo">let out_path = PathBuf::from("src");<br/>bindings<br/>  .write_to_file(out_path.join("lib.rs"))<br/>  .expect("Couldn't write bindings!");</span></pre><p id="72f8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我的代码恰好位于<code class="eh kx ky kz la b">src-cpp</code>。</p><ul class=""><li id="b700" class="kj kk if je b jf jg jj jk jn kl jr km jv kn jz ko kp kq kr dt translated">最后，添加将C/C++代码实际编译成lib并将其放入构建目标的步骤:</li></ul><pre class="lb lc ld le fq lf la lg lh aw li dt"><span id="092d" class="lj lk if la b fv ll lm l ln lo">gcc::Config::new()<br/>  .cpp(true) // Switch to C++ library compilation.<br/>  .file("src-cpp/add.cpp")<br/>  .compile("libsome-library.a");</span></pre><p id="f71b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你幸运的话，就是这样！你包括的库没有任何粒子固件的参考，你一切都很好。你现在可以像一个正常的模块一样使用它，或者需要它作为一个外部机箱，疯狂吧。</p><p id="acb4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你没有得到那枚戒指，不要担心，你仍然可以在天堂的单身汉中寻找真爱，只是有点困难，你必须在墨西哥喝得酩酊大醉——我的意思是，加上一堆编译器旗帜。</p><p id="82e3" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">《光子上的铁锈》很棒，但是，就像《天堂里的单身汉》一样，它缺乏标准(s)…库(明白了。)这很好，直到你意识到几乎所有的事情都依赖于标准库。这意味着在运行编译命令来审计输出的rust代码之后，您必须非常小心。</p><p id="8bbc" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我用<a class="ae ka" href="https://github.com/adafruit/Adafruit_NeoPixel" rel="noopener ugc nofollow" target="_blank"> Adafruit Neopixel库</a>尝试了这个过程，这是我的build.rs经过一些修补后的样子:</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lq lr l"/></div></figure><p id="e942" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您会注意到这里的一些事情:</p><ol class=""><li id="f5b4" class="kj kk if je b jf jg jj jk jn kl jr km jv kn jz ls kp kq kr dt translated">有一大堆的旗子。这些都是我添加的标志，这样gcc就可以使用正确的库，并基于Photon固件构建过程进行编译。我基本上运行了构建过程，并手动复制了gcc步骤。</li><li id="84fa" class="kj kk if je b jf ks jj kt jn ku jr kv jv kw jz ls kp kq kr dt translated">我注释掉了bindgen步骤。这是因为我用它们来生成带有基本类型的rust绑定(对rust来说是新的，这似乎是最安全的事情)，然后我删除了任何引用标准库或看起来无关的东西。例如，产生了许多光子库使用的东西，但没有绑定。</li></ol></div><div class="ab cl kc kd hc ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hn ho hp hq hr"><p id="a641" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这一切看起来都很好，我相信这是一个很好的开始，但是，唉，就像《单身汉》中的建议一样，我一真正尝试，代码就崩溃了。我仍然不确定是什么问题，也许是Neopixel库使用了原始汇编，Rust不喜欢这样。不管怎样，我最终在Rus  t中从头开始编写了大部分功能，但也许我在嵌入式Rust中找到了新的爱好。我接受这朵玫瑰——我是说铁锈。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lt lr l"/></div></figure></div></div>    
</body>
</html>