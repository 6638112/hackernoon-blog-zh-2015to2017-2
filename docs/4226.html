<html>
<head>
<title>How to create an interactive vote swing viewer in D3 (Part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在D3中创建交互式投票摇摆查看器(第1部分)</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-create-an-interactive-vote-swing-viewer-in-d3-a6bbd4c96b6f?source=collection_archive---------11-----------------------#2017-05-19">https://medium.com/hackernoon/how-to-create-an-interactive-vote-swing-viewer-in-d3-a6bbd4c96b6f?source=collection_archive---------11-----------------------#2017-05-19</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/443dd9d3c6a9920075aed6af0000d71f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9EW8nU2poCR60nPGkAkVlQ.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">The final result: a fully interactive Labour/Conservative swing viewer</figcaption></figure><p id="a0de" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">几天前，BBC新闻之夜的政策编辑克里斯·库克的这篇文章出现在BBC网站上。文章讨论了May和Corbyn如何开展截然不同的活动，并使用了以下图表来支持其分析:</p><figure class="kg kh ki kj fq iv fe ff paragraph-image"><div class="fe ff kf"><img src="../Images/ffc7ed13f936d137f337b32227b6e970.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*KYIryDpXp5CvmlVnMHhPPg.jpeg"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Image © BBC: <a class="ae ke" href="http://www.bbc.co.uk/news/uk-politics-39927866" rel="noopener ugc nofollow" target="_blank">http://www.bbc.co.uk/news/uk-politics-39927866</a></figcaption></figure><p id="f16e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我想:哇——这是一个非常好的可视化，可以很容易地用来表示任何两方摇摆。它也可以多一点互动性。所以我开始复制它，我将向你们展示如何复制。最后的结果是这里的<a class="ae ke" href="http://swing.puntofisso.net" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="27ce" class="kk kl hu bd km kn ko kp kq kr ks kt ku jr kv kw kx jv ky kz la jz lb lc ld le dt translated"><strong class="ak">警告</strong>:你会看到一些非常肮脏的编码。我在下班后的几个小时内创造了这个工具。多花一点时间和精力，我相信你会做得更好。</h2><p id="36d6" class="pw-post-body-paragraph jg jh hu ji b jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd hn dt translated">开始了。</p><h1 id="8e26" class="lk kl hu bd km ll lm ln kq lo lp lq ku lr ls lt kx lu lv lw la lx ly lz ld ma dt translated">首先，获取数据，确保数据可靠</h1><p id="d82e" class="pw-post-body-paragraph jg jh hu ji b jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd hn dt translated">我这样说是因为我第一次尝试使用我之前从维基百科搜集的一些数据。我没有检查就按下了“发布”按钮。严重的错误。幸运的是，推特总是很有帮助</p><figure class="kg kh ki kj fq iv"><div class="bz el l di"><div class="mb mc l"/></div></figure><p id="77a7" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这一数据的最佳来源是英国选举研究，正如克里斯·汉莱蒂(Chris Hanretty)所建议的那样(如果你对政治数据分析感兴趣，你应该关注他)。数据可在“BES选区结果与人口普查和候选人数据”下的<a class="ae ke" href="http://www.britishelectionstudy.com/data-objects/linked-data/" rel="noopener ugc nofollow" target="_blank">此处</a>下载。使用像BES这样公认的数据集也将使您的分析和工具可以与他人相比。</p><h1 id="7565" class="lk kl hu bd km ll lm ln kq lo lp lq ku lr ls lt kx lu lv lw la lx ly lz ld ma dt translated">清理数据，删除不需要的内容</h1><p id="609f" class="pw-post-body-paragraph jg jh hu ji b jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd hn dt translated">BES附带了许多有用的变量，但是对于一个简单的两党摇摆工具，我所需要的只是一个三元组:选区名称、获胜政党和多数党(百分比)。此外，我只需要工党和保守党在前两个位置的选区(以任何顺序)。幸运的是，BES结构良好，所以我简单地使用Excel过滤器和一些脚本对其进行了过滤，获得了如下所示的CSV:</p><figure class="kg kh ki kj fq iv fe ff paragraph-image"><div class="fe ff md"><img src="../Images/66297632a45037f37bda42e320ca98aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1118/format:webp/1*U1ehXvSm_2ah5nLFS6xvJA.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">The resulting spreadsheet</figcaption></figure><p id="812f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">现在，我可以直接使用这个CSV文件，但是我更喜欢使用JSON，因为它可以很好地处理D3。由于它更加结构化，它还允许我扩展数据以支持不同的未来分析。我使用了一个快速Bash脚本来做到这一点:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="b77d" class="kk kl hu mf b fv mj mk l ml mm">while read line<br/>do<br/>        const=`echo $line | awk -F"," {'print $1'}`<br/>        maj=`echo $line | awk -F"," {'print $3'}`<br/>        winner=`echo $line | awk -F"," {'print $2'}`<br/>        <br/>        echo "{"<br/>        echo " \"name\": \"$const\","<br/>        echo " \"majority\": \"$maj\","<br/>        echo " \"winner\": \"$winner\""<br/>        echo "},"<br/>done &lt; bes.csv</span></pre><p id="f457" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">确保生成的JSON是正确的，去掉最后一个逗号，就可以开始了。</p><h1 id="8f38" class="lk kl hu bd km ll lm ln kq lo lp lq ku lr ls lt kx lu lv lw la lx ly lz ld ma dt translated">总的想法</h1><p id="26d9" class="pw-post-body-paragraph jg jh hu ji b jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd hn dt translated">我要做的事情相对简单:</p><ol class=""><li id="49c7" class="mn mo hu ji b jj jk jn jo jr mp jv mq jz mr kd ms mt mu mv dt translated">我将宣读工党/保守党占多数的选区名单</li><li id="0ffd" class="mn mo hu ji b jj mw jn mx jr my jv mz jz na kd ms mt mu mv dt translated">将在SVG画布中为每个选区绘制一个矩形</li><li id="e516" class="mn mo hu ji b jj mw jn mx jr my jv mz jz na kd ms mt mu mv dt translated">如果当前由保守党议员担任，矩形将位于右侧，并涂上浅蓝色；红色(如果当前正在分娩)和浅红色</li><li id="6f75" class="mn mo hu ji b jj mw jn mx jr my jv mz jz na kd ms mt mu mv dt translated">该矩形将被堆叠在一个代表其多数的“盆”中，因此我们可以计算收益；每个罐将代表几个百分点的摆动，例如，大多数在29%和31%之间的每个席位将在罐“30”</li><li id="82bb" class="mn mo hu ji b jj mw jn mx jr my jv mz jz na kd ms mt mu mv dt translated">一个滑块可以让你和秋千互动；摇摆的座位将呈现更强烈的蓝色或红色，这取决于谁的增益。</li></ol><h1 id="1c1f" class="lk kl hu bd km ll lm ln kq lo lp lq ku lr ls lt kx lu lv lw la lx ly lz ld ma dt translated">设置您的html页面</h1><p id="b1ba" class="pw-post-body-paragraph jg jh hu ji b jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd hn dt translated">为了将所有这些整合在一起，我使用了一个bootstrap模板，但是您可以使用任何您觉得合适的模板。它所需要做的只是一个图表容器、一个滑块和一些显示摆动的文本容器(因为懒，我还使用了一个隐藏的span来包含一个表示当前滑块值的数字)。记得添加最新的jquery库和D3(我的代码用的是D3版本4):</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="b920" class="kk kl hu mf b fv mj mk l ml mm">&lt;div id="graph"&gt;&lt;/div&gt;<br/>&lt;input type="range" id="slider" min=0 max=100 /&gt;&lt;/input&gt;<br/>&lt;span id="slidertext"&gt;No swing&lt;/span&gt;<br/>&lt;span id="slidervalue"&gt;0&lt;/span&gt;<br/>&lt;span id="seats"&gt;0&lt;/span&gt;</span></pre><p id="67ed" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">请注意，我将滑块设置为在0到100的范围内操作。你可以让它表现得不同，但我更喜欢这样做，因为如果我想切换到使用百分比，这很方便。</p><h1 id="a213" class="lk kl hu bd km ll lm ln kq lo lp lq ku lr ls lt kx lu lv lw la lx ly lz ld ma dt translated">让我们添加选区数据</h1><p id="fc4f" class="pw-post-body-paragraph jg jh hu ji b jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd hn dt translated">使用上面的脚本，您可以生成一个由D3读取的JSON文件，或者将它作为一个变量嵌入到您的html文件中。我选择了后者:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="9a16" class="kk kl hu mf b fv mj mk l ml mm">var constituencies = [<br/>{<br/>   "name": "Gower",<br/>   "majority": "0.06",<br/>   "winner": "Conservative"<br/>},<br/>{<br/>   "name": "Derby North",<br/>   "majority": "0.09",<br/>   "winner": "Conservative"<br/> },<br/>// and so on ... <br/>];</span></pre><h1 id="6aca" class="lk kl hu bd km ll lm ln kq lo lp lq ku lr ls lt kx lu lv lw la lx ly lz ld ma dt translated">图表设置:一点脚手架</h1><p id="6adc" class="pw-post-body-paragraph jg jh hu ji b jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd hn dt translated">图表设置相对容易。首先，我们使用它的id (#graph)选择上面创建的div。我们向它添加一个svg元素，并配置它的主要属性—宽度、高度等:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="b25d" class="kk kl hu mf b fv mj mk l ml mm">var svgContainer = d3.select("#graph")<br/>                     .append("svg")<br/>                     .attr("width", 600)<br/>                     .attr("height", 350)<br/>                     .style("border", "0px solid black");</span></pre><p id="8735" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们还想在每个选区显示一个工具提示。这只是一个出现在某处的div:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="ea3f" class="kk kl hu mf b fv mj mk l ml mm">var div = d3.select("body").append("div")<br/>            .attr("class", "tooltip")<br/>            .style("opacity", 0);</span></pre><h1 id="061f" class="lk kl hu bd km ll lm ln kq lo lp lq ku lr ls lt kx lu lv lw la lx ly lz ld ma dt translated">我们准备好了:绘图功能</h1><p id="cd30" class="pw-post-body-paragraph jg jh hu ji b jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd hn dt translated">页面上的辛苦工作是由一个函数完成的。每次加载页面和移动滑块时都会调用paint _ constituencies()(稍后我会向您展示)。你也许可以用一种不需要重绘的方式更有效地完成它，但是这很简单，性能不会成为问题。</p><p id="566a" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">首先，让我们将画布从其内容中清除，并检查滑块上是否有摆动(以便我们稍后使用该值)；</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="239e" class="kk kl hu mf b fv mj mk l ml mm">svgContainer.selectAll("*").remove();<br/>var swing = d3.select('#slidervalue').node().innerHTML;<br/>var seats_gained = 0;</span></pre><p id="bc1b" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">通过将我们的数组绑定到创建矩形的工厂方法，可以很容易地为每个选区创建一个矩形。我们创建矩形，并将它们附加到刚刚清空的svg容器中。如果你在开发工具中看到html元素，你会意识到这些只是添加到主<svg/>标签中的<svg/>标签。我们以后再担心造型。</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="ebe3" class="kk kl hu mf b fv mj mk l ml mm">var rectangles = svgContainer.selectAll(“rect”)<br/> .data(constituencies)<br/> .enter()<br/> .append(“rect”);</span></pre><p id="4413" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们已经触及了这个应用的核心。我们现在需要做的就是对我们刚刚创建的矩形应用正确的样式。</p><p id="0d72" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在我们这样做之前，你会记得我们说过要根据矩形的多数来堆叠矩形。我简单地使用计数器，每个“罐子”一个:这样我就知道如果我想在一个堆栈上添加一个矩形，我可以看到这个堆栈在哪个级别。比如说我想增加一个30%多数的选区；我需要做的就是检查29–31底池。将会有锅来覆盖所有可能的多数(东哈姆是相当的离群值，有65.50%的多数！)我选择将它们分成2%。为了初始化pots，我执行以下操作:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="b61c" class="kk kl hu mf b fv mj mk l ml mm">var stackLab = {};<br/>var stackCon = {};<br/>for (i = 0; i&lt;67; i=i+2) {<br/> stackLab[i] = 0;<br/> stackCon[i] = 0;<br/>}</span></pre><p id="319e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们现在需要做的就是给矩形正确的属性:它们的x和y位置、大小、填充等等。在我们到达那里之前，我建议您熟悉SVG画布的工作方式——它并不完全是笛卡尔平面。它的轴系总是从左上角的(x=0，y=0)开始；因此，轴总是正的，你可能需要通过调整符号和移动值来从笛卡尔坐标转换你的坐标。这就是我们在接下来的几行代码中要做的。</p><p id="7a88" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">D3允许您设置属性的方式非常简单。这种假设的一般形式如下:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="e229" class="kk kl hu mf b fv mj mk l ml mm">rectangles.attr(&lt;attribute name&gt;, &lt;value&gt;);</span></pre><p id="3fc2" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">最重要的一点是<value>可以是一个函数，带有一个参数来指示我们正在处理哪个特定的矩形。例如，如果我们想把矩形放在水平轴上，从0开始到它们的多数所在的位置，我们应该这样做:</value></p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="22b6" class="kk kl hu mf b fv mj mk l ml mm">rectangles.attr("x", function(d) {<br/> return d['majority'];<br/>});</span></pre><p id="318f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">花些时间欣赏这几行。我们将广泛使用它们。</p><p id="35a8" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">第一步是给我们的矩形一个大小。这相对简单，并且您可以处理这些值，直到您满意为止:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="e4f2" class="kk kl hu mf b fv mj mk l ml mm">rectangles.attr("width", 6).attr("height", 14);</span></pre><p id="b93a" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">是的，你可以像这样连接多个设置——D3是面向对象的，所以每个函数总是返回原始对象，无论函数做了什么修改。这非常方便。</p><p id="2195" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">让我们把长方形放在正确的地方。</p><p id="1f4b" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">对于x轴，上面的代码行不能正常工作，因为我们将我们的区域分为两个区域，工党控制的区域和保守党控制的区域。实际上，我们需要将所有内容平移总宽度的一半，我们在初始化图表时将总宽度定义为600。</p><p id="203e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">想象一下笛卡尔平面上的x轴。保守的会在右边，这里x &gt; 0；工党将在左边，x&lt;0。在我们的svg图上，我们的0是其宽度的一半:300。因此，保守矩形将大致在区域[301，302，… 600]，而劳动矩形将在区域[0，1，2 … 300]。</p><p id="82c4" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们还想考虑矩形的大小和它们之间的间距，并确保我们记住不要使用实际的多数，而是该多数所属的锅。这相当于以下几行:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="ee89" class="kk kl hu mf b fv mj mk l ml mm">rectangles<br/>.attr("x", function (d) {<br/> var pot = Math.round(d['majority'] / 2)*2;<br/> if (d['winner'] === "Conservative")<br/>  val = 300 + (pot+2)*4;<br/> else<br/>  val = 300 — (pot+2)*4;<br/> return val;<br/> });</span></pre><p id="0846" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">y位置的代码非常类似，除了我们将使用该底池达到的堆叠级别，而不是单纯的底池值。换句话说，我们希望将矩形放在该罐中任何已有矩形的顶部，并增加该罐的堆叠级别:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="dcfa" class="kk kl hu mf b fv mj mk l ml mm">rectangles<br/>.attr("y", function (d) {<br/> var pot = Math.round(d['majority'] / 2)*2;<br/> if (d['winner'] === "Labour")<br/>  val = 310 — (stackLab[pot]++)*15;<br/> else<br/>  val = 310 — (stackCon[pot]++)*15;<br/> return val;<br/> });</span></pre><p id="c2e2" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们现在准备添加颜色，使用我们在开始时设置的swing变量:</p><ul class=""><li id="93d7" class="mn mo hu ji b jj jk jn jo jr mp jv mq jz mr kd nc mt mu mv dt translated">浅蓝色或浅红色代表选区的当前持有人；这将在没有施加摆动时出现</li><li id="49a5" class="mn mo hu ji b jj mw jn mx jr my jv mz jz na kd nc mt mu mv dt translated">如果我们应用了一个摆动，并且该摆动大于该矩形所代表的选区的当前多数，则根据谁赢得了席位，颜色将变成强烈的蓝色或红色</li><li id="6ff4" class="mn mo hu ji b jj mw jn mx jr my jv mz jz na kd nc mt mu mv dt translated">顺便说一下，我们已经设计了滑块，如果方向是左，我们需要考虑负摆动，即工党，如果方向是右，我们需要考虑正摆动，即保守党。</li></ul><p id="4014" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">为了实现所有这些，我们使用“fill”属性和摇摆公式——简而言之，记住要赢得10%多数席位，你需要5%的摇摆。当我们这样做时，我们也可以直接从d3设置我们的文本增益指示器。因此:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="593c" class="kk kl hu mf b fv mj mk l ml mm">rectangles.style("fill", function(d) {<br/> var returnColor;</span><span id="a91d" class="kk kl hu mf b fv nd mk l ml mm"> if (d['winner'] === "Labour")<br/>  {<br/>  if (swing*2 &gt; +d['majority']) {<br/>   seats_gained++;<br/>   returnColor = "#0000ff"; //red<br/>  } else {<br/>   returnColor = "#f08080"; //light red<br/>  }<br/> } else if (d['winner'] === "Conservative")<br/>  {<br/>  if (-swing*2 &gt; +d[majority']) {<br/>   seats_gained++;<br/>   returnColor = "#ff0000"; //blue<br/>  } else {<br/>  returnColor = "#87cefa";//light blue<br/>  }</span><span id="a11a" class="kk kl hu mf b fv nd mk l ml mm">  d3.select('#seats').node().innerHTML = seats_gained + " gains";<br/>  return returnColor;<br/>}</span></pre><p id="4159" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">最后，我们希望矩形显示一些关于选区的数据。我们可以这样做，显示我们之前定义的工具提示，我们将使用<em class="nb">监听器</em>这样做。侦听器是帮助器函数，它检测页面上的特定事件，并允许您定义对这些事件的反应。在我们的例子中，我们希望当鼠标指针点击一个矩形时工具提示变得可见，当它不在焦点上时消失:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="3290" class="kk kl hu mf b fv mj mk l ml mm">rectangles<br/>.on("mouseover", function(d) {<br/> div.transition()<br/> .duration(200)<br/> .style("opacity", .9);<br/> div.html(d['name'] + "&lt;br/&gt;" + d['majority'] + "%")<br/> .style("left", (d3.event.pageX) + "px")<br/> .style("top", (d3.event.pageY — 28) + "px");<br/> })<br/> .on("mouseout", function(d) {<br/> div.transition()<br/> .duration(500)<br/> .style("opacity", 0);<br/> });</span></pre><p id="1463" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">上面的代码可能看起来令人困惑，但是如果你一行一行地读它，它实际上是非常容易的。它所做的是使用一个过渡，在这个例子中是一个延迟，来显示工具提示，让用户感觉更舒服。剩下的只是样式问题(添加不透明度=出现，移除不透明度=消失)，以及添加内容，在这种情况下只是选区的名称和当前的大多数。</p><p id="bd7d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">为了让事情更清楚，我在中间加了一个竖线。这实际上非常简单，因为它只使用两个坐标，(x1，y1)表示底端，(x2，y2)表示顶端:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="6d5f" class="kk kl hu mf b fv mj mk l ml mm">svgContainer.append(“line”)<br/>.style(“stroke”, “black”)<br/>.attr(“x1”, 304) <br/>.attr(“y1”, 350) <br/>.attr(“x2”, 304) <br/>.attr(“y2”, 50);</span></pre><h1 id="ea29" class="lk kl hu bd km ll lm ln kq lo lp lq ku lr ls lt kx lu lv lw la lx ly lz ld ma dt translated">标签是可选的，但会使图表更容易阅读</h1><p id="62b6" class="pw-post-body-paragraph jg jh hu ji b jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd hn dt translated">如果你看到我原来的<a class="ae ke" href="http://swing.puntofisso.net" rel="noopener ugc nofollow" target="_blank">摆动工具</a>，x轴上有标签。为此，我创建了一个函数add_labels()，从paint _ constituencies()中调用它。这允许我决定在哪里放置什么，但是有更好的集成方式，例如使用范围和域。在这种情况下，由于我有花盆，可能不想显示所有标签，我选择了非常手动的方法。</p><p id="5465" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我的函数所做的是将文本追加到svg容器中。例如:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="3887" class="kk kl hu mf b fv mj mk l ml mm">svgContainer.append("text")                                                         .attr("class", "x label")                                      .attr("text-anchor", "end")                                       .attr("x", 300 + (1+2) * 4)                                     .attr("y", 340 )                                                .text("0");</span></pre><p id="f575" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我把剩下的留给锻炼。总的想法是，你找到y轴上的最佳点，然后决定如何间隔它们。</p><h1 id="c631" class="lk kl hu bd km ll lm ln kq lo lp lq ku lr ls lt kx lu lv lw la lx ly lz ld ma dt translated">滑块监听器</h1><p id="2be2" class="pw-post-body-paragraph jg jh hu ji b jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd hn dt translated">为了将它们结合在一起，我们需要在swing滑块移动时做出反应。请记住，我们已经将其设置为0到100之间的范围，而实际上这可能代表0%-100%的波动(嗯，理论上…)，如果倾向于保守党，这将是积极的，如果倾向于工党，这将是消极的。实际上，我使用0-100的滑块来代表-100-100的范围。所以我需要转换值，当我们完成计算后，我们可以设置文本并重新绘制矩形:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="fff9" class="kk kl hu mf b fv mj mk l ml mm">$('#slider').change(function() {<br/> swing_pc = $(this).val()-50;<br/> swing=200*swing_pc/100;</span><span id="e5da" class="kk kl hu mf b fv nd mk l ml mm"> if (swing&gt;0){<br/>  text = swing+"% swing to Conservative";<br/> } else {<br/>  text = -swing+"% swing to Labour";<br/>}<br/>                                                                $('#slidervalue').html(swing);                                                               $('#slidertext').html(text);</span><span id="625e" class="kk kl hu mf b fv nd mk l ml mm">paint_constituencies();<br/>});</span></pre><p id="a83d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">差不多就是这样了！</p><h1 id="56b9" class="lk kl hu bd km ll lm ln kq lo lp lq ku lr ls lt kx lu lv lw la lx ly lz ld ma dt translated">记得配置你的CSS</h1><p id="4ae9" class="pw-post-body-paragraph jg jh hu ji b jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd hn dt translated">为了让它显示得更好，您将设置一些样式。您可能希望滑块具有给定的大小，并且工具提示出现在特定的位置。有几种方法可以做到这一点，但为了完整起见，我将粘贴我的CSS:</p><pre class="kg kh ki kj fq me mf mg mh aw mi dt"><span id="0ffc" class="kk kl hu mf b fv mj mk l ml mm">div.tooltip {<br/>    position: absolute;<br/>    text-align: center;<br/>    width: 120px;<br/>    height: 28px;<br/>    padding: 2px;<br/>    font: 12px sans-serif;<br/>    background: white;<br/>    border: 0px;<br/>    border-radius: 8px;<br/>    pointer-events: none;<br/>}</span><span id="42c7" class="kk kl hu mf b fv nd mk l ml mm">#slider {<br/>  width: 600px !important;<br/>}</span><span id="c9f3" class="kk kl hu mf b fv nd mk l ml mm">span#slidervalue {<br/>  visibility: hidden !important;<br/>}</span></pre><h1 id="7e76" class="lk kl hu bd km ll lm ln kq lo lp lq ku lr ls lt kx lu lv lw la lx ly lz ld ma dt translated">干得好，终于来了！</h1><p id="1970" class="pw-post-body-paragraph jg jh hu ji b jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz lj kb kc kd hn dt translated">我没什么可说的，除了通常的:</p><ol class=""><li id="e48a" class="mn mo hu ji b jj jk jn jo jr mp jv mq jz mr kd ms mt mu mv dt translated">如果您有任何反馈，请让我知道-这是正在进行中的工作</li><li id="b617" class="mn mo hu ji b jj mw jn mx jr my jv mz jz na kd ms mt mu mv dt translated">请在http://twitter.com/puntofisso<a class="ae ke" href="http://twitter.com/puntofisso" rel="noopener ugc nofollow" target="_blank">的twitter上关注我</a></li><li id="f0df" class="mn mo hu ji b jj mw jn mx jr my jv mz jz na kd ms mt mu mv dt translated">在http://puntofisso.net/newsletter的<a class="ae ke" href="http://puntofisso.net.newlsetter" rel="noopener ugc nofollow" target="_blank">订阅我关于所有极客奇闻、数据可视化、开放数据和数据新闻的时事通讯</a></li><li id="56dd" class="mn mo hu ji b jj mw jn mx jr my jv mz jz na kd ms mt mu mv dt translated">求推荐分享这篇中帖:-)</li></ol></div><div class="ab cl ne nf hc ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="hn ho hp hq hr"><p id="b230" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><a class="ae ke" rel="noopener" href="/@puntofisso/how-to-create-an-interactive-vote-swing-viewer-in-d3-part-2-fd6ac625930a"> <em class="nb">本教程第二部分</em> </a> <em class="nb">现已发售。更多喜欢的请</em> <a class="ae ke" href="http://twitter.com/puntofisso" rel="noopener ugc nofollow" target="_blank"> <em class="nb">在twitter上关注我</em> </a> <em class="nb">并订阅我的</em> <a class="ae ke" href="http://puntofisso.net/newsletter" rel="noopener ugc nofollow" target="_blank"> <em class="nb">简讯</em> </a> <em class="nb">。</em></p><div class="kg kh ki kj fq ab cb"><figure class="nl iv nm nn no np nq paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="nl iv nm nn no np nq paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="nl iv nm nn no np nq paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="nr ns nt"><p id="f922" class="jg jh nb ji b jj jk jl jm jn jo jp jq nu js jt ju nv jw jx jy nw ka kb kc kd hn dt translated"><a class="ae ke" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是这个家庭的一员。我们现在<a class="ae ke" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ke" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jg jh nb ji b jj jk jl jm jn jo jp jq nu js jt ju nv jw jx jy nw ka kb kc kd hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ke" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ke" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kg kh ki kj fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nx"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>