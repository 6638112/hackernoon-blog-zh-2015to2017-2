<html>
<head>
<title>Hook into Angular’s Initialization Process</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">钩入Angular的初始化过程</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/hook-into-angular-initialization-process-add41a6b7e?source=collection_archive---------0-----------------------#2017-05-12">https://medium.com/hackernoon/hook-into-angular-initialization-process-add41a6b7e?source=collection_archive---------0-----------------------#2017-05-12</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/033b61a4c7453c128f1d909b2add27f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*eKivM1IbPk3EOE4colX53w.png"/></div></figure><p id="6711" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> <em class="jw">本</em>条</strong> <strong class="ja hv"> <em class="jw">原本出现在</em></strong><a class="ae jx" href="https://dormoshe.io/articles/hook-into-angular-initialization-process-8" rel="noopener ugc nofollow" target="_blank"><strong class="ja hv"><em class="jw">dormoshe . io</em></strong></a></p><p id="80c3" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">有时，您需要挂钩内部流程。有时，您需要在加载应用程序之前运行代码。有时，您需要在呈现页面之前配置应用程序的某些部分。有时，您希望暂停初始化，直到完成某些限制。在Angular v4中，你可以用<em class="jw"> APP_INITIALIZER </em>令牌来完成这个任务。</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="ab fr cl kc"><img src="../Images/45a7a173091a006af05aaf7a8d124fd8.png" data-original-src="https://miro.medium.com/v2/1*PFnvyxq66QiDQ8LFwdbdfQ.gif"/></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">Live example</figcaption></figure><p id="df97" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在本文中，我们将了解什么是注入令牌，什么是<em class="jw"> APP_INITIALIZER </em>以及如何使用它来挂钩初始化过程。此外，我们将看到运行该功能的核心模块的源代码，并且我们将介绍该功能的三种不同用法。</p><p id="ec42" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">让我们开始…</p></div><div class="ab cl kh ki hc kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hn ho hp hq hr"><h1 id="545e" class="ko kp hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">注入令牌</h1><p id="6aee" class="pw-post-body-paragraph iy iz hu ja b jb lm jd je jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv hn dt translated">InjectionToken是Angular v2 OpaqueToken的改进版本(<a class="ae jx" href="https://hackernoon.com/top-8-resources-to-explore-angular-4-ff2c1b42020a" rel="noopener ugc nofollow" target="_blank">v4</a>的变化之一)。它允许我们创建基于字符串的令牌，而不会在依赖注入机制中遇到任何冲突。<a class="ae jx" href="https://hackernoon.com/angular-v4-practical-countries-application-f866b567ead1" rel="noopener ugc nofollow" target="_blank">创建一个注入令牌很容易</a>。</p><h1 id="66d7" class="ko kp hu bd kq kr lr kt ku kv ls kx ky kz lt lb lc ld lu lf lg lh lv lj lk ll dt translated">APP_INITIALIZER令牌</h1><p id="78b9" class="pw-post-body-paragraph iy iz hu ja b jb lm jd je jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv hn dt translated">APP_INITIALIZER是Angular的注入令牌之一。这个令牌仍然是实验性的。使用<em class="jw"> APP_INITIALIZER时，</em>Angular<em class="jw">T25】会在APP初始化时执行提供的功能。如果函数返回一个承诺，Angular将延迟初始化，直到承诺解决。这意味着应用程序可以在没有太多延迟的情况下初始化，并且您还可以使用现有的服务和框架功能。</em></p></div><div class="ab cl kh ki hc kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hn ho hp hq hr"><h1 id="5d1e" class="ko kp hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">一个例子</h1><p id="798b" class="pw-post-body-paragraph iy iz hu ja b jb lm jd je jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv hn dt translated">这个例子是基于英雄之旅项目编写的。<br/><em class="jw">ng module . providers</em>数组的定义如下:</p><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="lw lx l"/></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">APP_INITIALIZER module providers</figcaption></figure><p id="ea7f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">所以在初始化过程中调用了两个函数——<em class="jw">onappinit 1，onAppInit2 </em>。下面是这些函数的实现:</p><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="lw lx l"/></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">APP_INITIALIZER providers factory functions</figcaption></figure><p id="9e5f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如您所见，每个函数都返回一个承诺。角度初始化过程将继续，直到所有初始化承诺都将被解决。这是作为英雄之旅项目一部分的跑步视频:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="ab fr cl kc"><img src="../Images/45a7a173091a006af05aaf7a8d124fd8.png" data-original-src="https://miro.medium.com/v2/1*PFnvyxq66QiDQ8LFwdbdfQ.gif"/></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">Tour of heroes — run</figcaption></figure><p id="2962" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">Angular同时运行初始化程序，加载被延迟到最后一次解析。因此，您可以将您的业务逻辑放在提供者中。它可以是远程资源的一些配置或加载以及角度服务中响应的设置。</p></div><div class="ab cl kh ki hc kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hn ho hp hq hr"><h1 id="54dc" class="ko kp hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">内部构件</h1><p id="6e2c" class="pw-post-body-paragraph iy iz hu ja b jb lm jd je jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv hn dt translated">Angular声明了<em class="jw"> APP_INITIALIZER </em>令牌，并在服务ApplicationInitStatus中运行所提供的函数。以下是部分代码:</p><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="lw lx l"/></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">App-initializer file source code</figcaption></figure><p id="3009" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在第一行中，标记被声明。服务构造函数获取提供的函数(如果有的话),运行它们并将返回的承诺推送到一个数组。</p><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="lw lx l"/></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">Application-init-status service — part I</figcaption></figure><p id="512c" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">然后angular通过<em class="jw"> Promise.all </em>并发运行所有承诺。<em class="jw"> _done </em>属性将保持<em class="jw"> false </em>，直到所有的承诺都被解决。</p><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="lw lx l"/></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">Application-init-status service — part II</figcaption></figure><p id="89db" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">源代码可以在<a class="ae jx" href="https://github.com/angular/angular/blob/bebedfed24d6fbfa492e97f071e1d1b41e411280/packages/core/src/application_init.ts" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></div><div class="ab cl kh ki hc kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hn ho hp hq hr"><h1 id="2bae" class="ko kp hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">Angular如何使用APP_INITIALIZER？</h1><p id="f3d7" class="pw-post-body-paragraph iy iz hu ja b jb lm jd je jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv hn dt translated">Angular使用<em class="jw"> APP_INITIALIZER </em>令牌在应用程序初始化时初始化它的一些实现。这里有三种用法。</p><h2 id="e98d" class="ly kp hu bd kq lz ma mb ku mc md me ky jj mf mg lc jn mh mi lg jr mj mk lk ml dt translated">ng .探针</h2><p id="fc2c" class="pw-post-body-paragraph iy iz hu ja b jb lm jd je jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv hn dt translated">有了DOM元素的引用，您就能够检查它所在的组件的状态。您可以通过使用<em class="jw"> ng.probe </em>并将DOM元素作为一个类似<code class="eh mm mn mo mp b">ng.probe($0)</code>的参数来实现。</p><p id="8a25" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">Angular在应用程序初始化之前使用<em class="jw"> APP_INITIALIZER </em>令牌来配置和初始化ng.prob，因此<code class="eh mm mn mo mp b">ng.prob</code>将按需可用。</p><p id="38eb" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">源代码可以在这里找到<a class="ae jx" href="https://github.com/angular/angular/blob/5293794316cc1b0f57d5d88b3fefdf6ae29d0d97/packages/platform-browser/src/dom/debug/ng_probe.ts#L37" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="220a" class="ly kp hu bd kq lz ma mb ku mc md me ky jj mf mg lc jn mh mi lg jr mj mk lk ml dt translated">网络工作者</h2><p id="d9cc" class="pw-post-body-paragraph iy iz hu ja b jb lm jd je jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv hn dt translated">Web Workers为Web内容提供了一种在后台线程中运行脚本的简单方法。工作线程可以在不干扰用户界面的情况下执行任务。Angular通过一个更高级的API与DOM分离，所以我们可以使用web worker的概念。</p><p id="035a" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">Angular使用<em class="jw"> APP_INITIALIZER </em>是为了在使用它之前设置DOM适配器，所以DOM API调用不会在真正的浏览器DOM上完成。这个适配器需要使用传统的js <em class="jw">控制台</em>对象来记录错误消息。浏览器DOM API的其他方法都抛出异常，因为在web worker上下文中不能直接访问DOM。</p><p id="9a1d" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">源代码可以在<a class="ae jx" href="https://github.com/angular/angular/blob/bebedfed24d6fbfa492e97f071e1d1b41e411280/packages/platform-webworker/src/worker_app.ts#L50" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h2 id="5e49" class="ly kp hu bd kq lz ma mb ku mc md me ky jj mf mg lc jn mh mi lg jr mj mk lk ml dt translated">按指定路线发送</h2><p id="837f" class="pw-post-body-paragraph iy iz hu ja b jb lm jd je jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv hn dt translated">为了正确初始化路由器，Angular需要执行两个主要步骤:</p><ul class=""><li id="ba7e" class="mq mr hu ja b jb jc jf jg jj ms jn mt jr mu jv mv mw mx my dt translated">启动<em class="jw"> APP_INITIALIZER </em>中的导航，如果解析器或保护异步执行，则阻止引导。</li><li id="fbac" class="mq mr hu ja b jb mz jf na jj nb jn nc jr nd jv mv mw mx my dt translated">在<em class="jw"> BOOTSTRAP_LISTENER </em>中运行激活。为此，Angular利用路由器提供的<em class="jw">预激活后</em>挂钩。</li></ul><p id="a6f4" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">路由器导航开始到达预激活完成时的点，然后暂停。它等待钩子被解决。然后在引导监听器中解析它。</p><p id="0cf2" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">源代码可以在<a class="ae jx" href="https://github.com/angular/angular/blob/5293794316cc1b0f57d5d88b3fefdf6ae29d0d97/packages/router/src/router_module.ts#L327" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></div><div class="ab cl kh ki hc kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hn ho hp hq hr"><h1 id="3f8a" class="ko kp hu bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll dt translated">结论</h1><p id="cacf" class="pw-post-body-paragraph iy iz hu ja b jb lm jd je jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv hn dt translated">标记在Angular中广泛用于注入值。您可以根据需要使用它们，比如配置。Angular提供了一种方便的方法来挂钩到应用程序的初始化过程中。当您选择适合这个过程时，请在考虑之后再做，因为它会暂停应用程序的加载。</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff ne"><img src="../Images/522b2e4ace3cfcecd43bba30fcf0a317.png" data-original-src="https://miro.medium.com/v2/resize:fit:400/format:webp/1*cA1Y2VmIvRnUJUvjUPNZ2A.png"/></div></figure><p id="44e2" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> <em class="jw">您可以关注我关于</em></strong><a class="ae jx" href="https://www.dormoshe.io" rel="noopener ugc nofollow" target="_blank"><strong class="ja hv"><em class="jw">dormo she . io</em></strong></a><strong class="ja hv"><em class="jw">或</em></strong><a class="ae jx" href="https://twitter.com/DorMoshe" rel="noopener ugc nofollow" target="_blank"><strong class="ja hv"><em class="jw">Twitter</em></strong></a><strong class="ja hv"><em class="jw">阅读更多关于Angular、JavaScript和web开发的内容。</em>T25】</strong></p></div></div>    
</body>
</html>