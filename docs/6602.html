<html>
<head>
<title>Making audio searchable with Cloud Speech</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用云语音使音频可搜索</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/making-audio-searchable-with-cloud-speech-36ce63b6b4d3?source=collection_archive---------11-----------------------#2017-09-26">https://medium.com/hackernoon/making-audio-searchable-with-cloud-speech-36ce63b6b4d3?source=collection_archive---------11-----------------------#2017-09-26</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="9a5b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上个月，云语音<a class="ae jp" href="https://cloudplatform.googleblog.com/2017/08/Cloud-Speech-API-improves-longform-audio-recognition-and-adds-30-new-language-variants.html" rel="noopener ugc nofollow" target="_blank">推出了</a>一个新的单词级时间戳功能:音频转录现在包括每个单词的开始和结束时间戳。这带来了大量的可能性:开发人员现在可以跳到音频文件中说出某个单词的确切时刻，在播放音频时显示相关文本，或者在音频库中搜索特定术语。</p><p id="2ed4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有了搜索音频文件的能力，我想在视频上试试这个功能。为此，我从一个视频文件中提取了音轨，将其发送到Cloud Speech，并构建了一个搜索音频转录JSON的前端。结果是下面的演示(最好在<a class="ae jp" href="https://youtu.be/hJtTdunppn4?t=12m49s" rel="noopener ugc nofollow" target="_blank">我最近的ML API演示</a>中用声音观看):</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/1a2e6104a4202797e00d7f590a4c3797.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*5Eoo0fccpEgumUbQx_rQzg.gif"/></div></div></figure><p id="d679" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">除了语音API，该演示还使用云功能、云存储和应用引擎进行托管。下面是后端工作原理的示意图:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff kc"><img src="../Images/2df89210ba390e0a45b7846c9dc5dd4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1JB6XwklkcPSqUc_UBqMRA.png"/></div></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">Architecture of Speech Timestamps demo</figcaption></figure><h1 id="86ac" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated"><strong class="ak">第一步:用ffmpeg和云函数提取音频</strong></h1><p id="53b1" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">因为Cloud Speech允许您为音频文件提供云存储URL以便转录，所以我决定将我所有的视频和音频内容存储在云存储中。然后在我的应用引擎前端，我可以直接从云存储中获得视频和相关的转录JSON。</p><p id="598b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我希望能够将视频文件放入云存储中，并自动在另一个存储桶中显示转录。听起来很神奇，对吧？我用<a class="ae jp" href="https://cloud.google.com/functions/" rel="noopener ugc nofollow" target="_blank">云函数</a>实现了这一点:这是一个计算解决方案，用于编写由某些云事件自动触发的函数。函数是用Node.js编写的，您可以指定触发每个函数的事件类型。在这种情况下，每当一个新文件被添加到我的视频桶时，我就触发我的函数。我将转录过程分为两个功能:</p><ol class=""><li id="88f7" class="lk ll hu it b iu iv iy iz jc lm jg ln jk lo jo lp lq lr ls dt translated">从视频中提取音频，并将其转换成语音API可以接受的格式(我使用了FLAC编码)</li></ol><p id="3aef" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">2.<strong class="it hv"> </strong> <code class="eh lt lu lv lw b"><strong class="it hv">transcribeAudio</strong></code> <strong class="it hv"> : </strong>将FLAC文件发送到Speech API，并将转录上传到云存储</p><p id="34ad" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh lt lu lv lw b">extractAudio</code>功能使用<a class="ae jp" href="https://googlecloudplatform.github.io/google-cloud-node/#/" rel="noopener ugc nofollow" target="_blank"> google-cloud Node模块</a>访问云存储，使用<a class="ae jp" href="https://github.com/fluent-ffmpeg/node-fluent-ffmpeg" rel="noopener ugc nofollow" target="_blank"> fluent-ffmpeg </a>提取音频并转码。为了让<a class="ae jp" href="https://www.ffmpeg.org/" rel="noopener ugc nofollow" target="_blank"> ffmpeg </a>在我的云函数环境中工作，我需要在部署我的函数时上传ffmpeg二进制文件，并告诉fluent-ffmpeg这些二进制文件的路径。</p><p id="d2eb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">以下是npm依赖关系的完整列表:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lx ly l"/></div></figure><p id="c12e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们还将为每个云存储桶定义变量:一个用于视频，一个用于FLAC音频文件，一个用于转录JSON:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lx ly l"/></div></figure><p id="80c3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该功能将执行以下操作:</p><ul class=""><li id="f437" class="lk ll hu it b iu iv iy iz jc lm jg ln jk lo jo lz lq lr ls dt translated">从云存储下载视频文件</li><li id="749c" class="lk ll hu it b iu ma iy mb jc mc jg md jk me jo lz lq lr ls dt translated">提取音频并将其转码为FLAC格式，用于云语音</li><li id="ba99" class="lk ll hu it b iu ma iy mb jc mc jg md jk me jo lz lq lr ls dt translated">将FLAC文件上传到云存储</li></ul><p id="b40b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该功能接收一个<code class="eh lt lu lv lw b">event</code>参数，该参数将为我们提供触发事件的文件数据。我们的功能概述如下:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lx ly l"/></div></figure><p id="063d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，我们将编写函数，将视频下载到云存储中。我们可以通过将文件写入<code class="eh lt lu lv lw b">/tmp</code>目录，将其保存到我们的云功能环境中的本地磁盘上:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lx ly l"/></div></figure><p id="3f96" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦我们在云功能中获得了本地可用的视频文件，我们就可以使用ffmpeg对音频进行提取和转码:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lx ly l"/></div></figure><p id="8688" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后一步是将flac文件上传到新的云存储桶中。您可以在<a class="ae jp" href="https://googlecloudplatform.github.io/google-cloud-node/#/docs/google-cloud/0.56.0/storage/bucket?method=upload" rel="noopener ugc nofollow" target="_blank">谷歌云文档</a>中找到上传文件的代码。</p><h1 id="555f" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated"><strong class="ak">第2步:用云语音转录音频</strong></h1><p id="71f7" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">为了得到我们的音频转录和时间戳数据，我们将编写一个名为<code class="eh lt lu lv lw b">transcribeAudio</code>的云函数，每当flac文件被添加到我们的音频桶中时就会被触发。对于这个函数，我们需要用google-cloud Node实例化一个语音客户端，然后编写我们的转录函数:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lx ly l"/></div></figure><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lx ly l"/></div></figure><p id="83b1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们只需要打电话给<code class="eh lt lu lv lw b">longRunningRecognize()</code>向我们的客户云语音提出请求。这将启动一个长时间的语音操作，并在完成时返回最终的转录结果:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lx ly l"/></div></figure><p id="1f0e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，我们可以将转录内容写入本地JSON文件:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lx ly l"/></div></figure><p id="613e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后一步是将我们的JSON文件上传到云存储中，就像我们在第一个函数中所做的那样。</p><p id="3afa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">呜哇！现在我们有了一个完全无服务器的解决方案，可以从视频中生成时间戳转录。请注意，您需要定期从您的云函数文件系统中删除<code class="eh lt lu lv lw b">tmp/</code>的内容，以避免达到<a class="ae jp" href="https://cloud.google.com/functions/pricing#local_disk" rel="noopener ugc nofollow" target="_blank">的内存限制</a>。你可以用<a class="ae jp" href="https://www.npmjs.com/package/rimraf" rel="noopener ugc nofollow" target="_blank"> rimraf </a> npm模块来完成。</p><h1 id="2da7" class="kh ki hu bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le dt translated">开始</h1><p id="9c63" class="pw-post-body-paragraph ir is hu it b iu lf iw ix iy lg ja jb jc lh je jf jg li ji jj jk lj jm jn jo hn dt translated">要开始在你自己的应用中使用时间戳功能，请访问语音API <a class="ae jp" href="https://cloud.google.com/speech/docs/async-time-offsets#speech-async-recognize-gcs-protocol" rel="noopener ugc nofollow" target="_blank">时间戳文档</a>。关于云函数的细节，查看这里的<a class="ae jp" href="https://cloud.google.com/functions/docs" rel="noopener ugc nofollow" target="_blank">文档</a>或者观看我的队友<a class="ae jp" href="https://twitter.com/bretmcg" rel="noopener ugc nofollow" target="_blank"> Bret </a>关于云函数的精彩<a class="ae jp" href="https://www.youtube.com/watch?v=5CZ1f6wzn4Q" rel="noopener ugc nofollow" target="_blank">演讲</a>。</p><p id="5cae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我很想看看你用语音API和云函数构建了什么。请在评论中告诉我你的想法，或者在Twitter上找到我。</p></div></div>    
</body>
</html>