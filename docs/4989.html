<html>
<head>
<title>Building and Publishing a Cosmic JS Extension Using Bitbucket Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Bitbucket管道构建和发布Cosmic JS扩展</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/building-and-publishing-a-cosmic-js-extension-using-bitbucket-pipelines-c170e30b01e?source=collection_archive---------16-----------------------#2017-07-03">https://medium.com/hackernoon/building-and-publishing-a-cosmic-js-extension-using-bitbucket-pipelines-c170e30b01e?source=collection_archive---------16-----------------------#2017-07-03</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/6dcca714eede9631fb5e28041a22844f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ro8Vmzs07aehQrzw.jpg"/></div></div></figure><p id="4098" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Cosmic JS刚刚发布了他们新的扩展功能，这使得任何人都可以在Cosmic CMS中嵌入他们自己的定制应用程序！</p><p id="ddeb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在本教程中，我们将经历一些必要的步骤，使我们的亚马逊产品搜索扩展。</p><h1 id="f41f" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">TL；速度三角形定位法(dead reckoning)</h1><p id="12e8" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated"><a class="ae ld" href="https://github.com/cosmicjs/amazon-product-search" rel="noopener ugc nofollow" target="_blank">查看GitHub上的完整代码库</a> <br/> <a class="ae ld" href="https://cosmicjs.com/login" rel="noopener ugc nofollow" target="_blank">在您的存储桶中安装扩展在您的存储桶中&gt;扩展&gt;浏览扩展</a> <br/> <a class="ae ld" href="https://cosmicjs.com/docs/extensions" rel="noopener ugc nofollow" target="_blank">查看扩展文档</a>了解关于构建扩展的更多信息</p><h1 id="d59c" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">我们正在建造的扩建部分</h1><p id="eab3" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">我们正在构建一个简单的扩展，允许您搜索亚马逊产品目录，并将带有产品名称、描述、图像和附属链接的对象添加到您的存储桶中。</p><p id="ee32" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是一个非常简单的应用程序，使用react构建，我们不会对与新的Cosmic JS Extensions API没有直接关系的部分进行过多的详细描述。</p><h1 id="2dfe" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">在你的扩展中获得对宇宙API的访问</h1><p id="41b5" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">Cosmic JS将扩展作为一个<code class="eh le lf lg lh b">&lt;iframe&gt;</code>嵌入到其CMS接口中，扩展被赋予一个带有查询字符串的url，该字符串提供了应用程序访问相关桶所需的所有信息，如下所示:</p><p id="e79c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh le lf lg lh b"><a class="ae ld" href="https://43d32000-5ce7-11e7-8fc4-c1f6eec4f920.cosmicext.com/?bucket_slug=my-bucket-slug&amp;read_key=foo&amp;write_key=bar" rel="noopener ugc nofollow" target="_blank">https://43d32000-5ce7-11e7-8fc4-c1f6eec4f920.cosmicext.com/?bucket_slug=my-bucket-slug&amp;read_key=foo&amp;write_key=bar</a></code></p><p id="e59a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">提取这些变量非常容易，使用像<code class="eh le lf lg lh b">qs</code>这样的库甚至更容易:</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="1602" class="lq kb hu lh b fv lr ls l lt lu">import qs from "qs";</span><span id="2161" class="lq kb hu lh b fv lv ls l lt lu">const { bucket_slug, read_key, write_key, } = qs.parse(window.location.search.slice(1, Infinity));</span><span id="3c33" class="lq kb hu lh b fv lv ls l lt lu">console.log({<br/>   bucket_slug,<br/>   read_key,<br/>   write_key,<br/>});</span></pre><p id="c9a6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后，可以使用这些键对当前使用扩展的存储桶进行API调用:</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="ae2f" class="lq kb hu lh b fv lr ls l lt lu">fetch(<br/>   `https://api.cosmicjs.com/v1/${bucket_slug}/object/amazon-credentials${<br/>      read_key<br/>         ? "?read_key=" + read_key<br/>         : ""<br/>   }`,<br/>   opts,<br/>);</span></pre><p id="510d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我们的应用程序中，我们使用这些键为我们找到的亚马逊产品添加新对象。</p><h1 id="aee8" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">扩展. json</h1><p id="2b1a" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">您的扩展中必须包含的一个文件是<code class="eh le lf lg lh b">extension.json</code>文件。这告诉Cosmic关于你的应用程序的重要元数据，比如它的名称、图标、显示图像，以及在首次安装扩展时应该创建的默认对象和对象类型。我们应用的<code class="eh le lf lg lh b">extension.json</code>如下:</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="9baf" class="lq kb hu lh b fv lr ls l lt lu">{<br/>  "title": "Amazon Product Search",<br/>  "font_awesome_class": "fa-shopping-basket",<br/>  "image_url": "http://fla.fg-a.com/shopping-cart/shopping-cart-black-3.png",<br/>  "objects": [<br/>    {<br/>      "title": "Amazon Credentials",<br/>      "slug": "amazon-credentials",<br/>      "type": "amazon-credentials",<br/>      "metafields": [<br/>        {<br/>        "key": "amz-key",<br/>        "title": "Key",<br/>        "type": "text",<br/>        "value": ""<br/>        },<br/>        {<br/>        "key": "amz-secret",<br/>        "title": "Secret",<br/>        "type": "text",<br/>        "value": ""<br/>        },<br/>        {<br/>        "key": "amz-tag",<br/>        "title": "Tag",<br/>        "type": "text",<br/>        "value": ""<br/>        }<br/>      ]<br/>    }<br/>  ],<br/>  "object_types": [<br/>    {<br/>      "title": "Amazon Products",<br/>      "slug": "amazon-items",<br/>      "singular": "Amazon Product",<br/>      "metafields":[<br/>        {"key":"image_url","type":"text","value":"","title":"image_url","parent":false,"children":null},<br/>        {"key":"affiliate_link","type":"text","value":"","title":"affiliate_link","parent":false,"children":null}<br/>      ]<br/>    }<br/>  ]<br/>}</span></pre><p id="f56e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh le lf lg lh b">title</code>字段是您的扩展将在Cosmic中显示的名称<code class="eh le lf lg lh b">font_awesome_class</code>字段必须是有效的<a class="ae ld" href="http://fontawesome.io/icons/" rel="noopener ugc nofollow" target="_blank">字体牛逼的</a>图标名称<code class="eh le lf lg lh b">image_url</code>字段是将与您的扩展一起显示的显示图像。</p><p id="53dd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您还可以指定安装扩展时将创建的对象列表，这里我们详细描述了一个对象，它将存储我们的Amazon产品搜索凭证。这意味着宇宙将为我们保存这些信息！</p><h1 id="113d" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">部署和持续集成</h1><p id="85bc" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">将你的扩展上传到Cosmic非常简单，你只需要拿一个包含你的<code class="eh le lf lg lh b">extension.json</code>文件和<code class="eh le lf lg lh b">index.html</code>文件(以及你需要的任何其他资产)的文件夹，压缩它，然后上传。</p><p id="69be" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们的构建文件夹如下所示:</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="881a" class="lq kb hu lh b fv lr ls l lt lu">build<br/>├── extension.json<br/>├── index.html<br/>└── static<br/> └── js<br/> └── main.a651cd8a.js</span></pre><p id="d4d2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以通过Cosmic JS CMS上传您的zip文件，或者使用rest API。</p><p id="51c8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们使用Bitbucket来托管我们的代码，它有一个内置的CI服务，称为Pipelines。您可以将管道配置为在每次提交git repo的<code class="eh le lf lg lh b">master</code>分支时运行，并将最新版本的应用程序上传到Cosmic的服务器。</p><p id="48dc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们将像这样配置我们的位桶管道:</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="31fa" class="lq kb hu lh b fv lr ls l lt lu">image: codogo/pipelines-universal:latest</span><span id="4df5" class="lq kb hu lh b fv lv ls l lt lu">pipelines:<br/>  branches:<br/>    master:<br/>      - step:<br/>          script:<br/>          - yarn install <br/>          - yarn run lint<br/>          - yarn run build<br/>          - ./uploadNewExtension.sh</span></pre><p id="56c3" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">其中<code class="eh le lf lg lh b">uploadNewExtension.sh</code>包含:</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="10c4" class="lq kb hu lh b fv lr ls l lt lu">#!/bin/bash</span><span id="9a0c" class="lq kb hu lh b fv lv ls l lt lu"># $BUCKET_SLUG, $READ_KEY, and $WRITE_KEY are environment variables</span><span id="b771" class="lq kb hu lh b fv lv ls l lt lu">EXTENSION_NAME="${EXTENSION_NAME:-Amazon Product Search}"</span><span id="f951" class="lq kb hu lh b fv lv ls l lt lu">echo "geting previous version extension id..."<br/>PREVIOUS_EXTENSION_ID="$( curl --progress-bar "https://api.cosmicjs.com/v1/extensions-2?hide_metafields=true&amp;read_key=foo" | jq -r ".bucket.extensions | map(select(.title == \"$EXTENSION_NAME\" )) | .[0].id"  )"<br/># jq is a neat little program for extracting data from json, it is available here: https://jqplay.org/</span><span id="28a3" class="lq kb hu lh b fv lv ls l lt lu">if [ "$PREVIOUS_EXTENSION_ID" == "null" ] ; then<br/>echo "There is no '$EXTENSION_NAME' extension on cosmic to delete"<br/>else<br/>echo "Found id for '$EXTENSION_NAME': $PREVIOUS_EXTENSION_ID"<br/>echo "deleting old extension..."<br/>curl --progress-bar -X DELETE "https://api.cosmicjs.com/v1/$BUCKET_SLUG/extensions/$PREVIOUS_EXTENSION_ID" -d "{\"write_key\":\"$WRITE_KEY\"}" -H "Content-type: application/json" &gt; /dev/null<br/>fi</span><span id="31bf" class="lq kb hu lh b fv lv ls l lt lu">echo "upload new version of extension..."<br/>curl --progress-bar --url "https://api.cosmicjs.com/v1/$BUCKET_SLUG/extensions" --header "content-type: multipart/form-data" --form "write_key=$WRITE_KEY" --form "zip=@./build.zip" &gt; /dev/null</span></pre><p id="4505" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这个脚本将删除我们扩展的任何先前上传的版本，然后将我们压缩的扩展上传到我们的bucket。</p><h1 id="79e8" class="ka kb hu bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dt translated">摘要</h1><p id="20bf" class="pw-post-body-paragraph jc jd hu je b jf ky jh ji jj kz jl jm jn la jp jq jr lb jt ju jv lc jx jy jz hn dt translated">在本教程中，我们已经介绍了Cosmic JS托管和集成您的扩展的方式，并解释了如何使用Bitbucket的持续集成来上传您的扩展。如果你学到了什么，请<a class="ae ld" href="https://twitter.com/intent/tweet?text=Building%20and%20Publishing%20a%20Cosmic%20JS%20Extension%20Using%20Bitbucket%20Pipelines%20@cosmic_js:%20https://cosmicjs.com/blog/building-and-publishing-a-cosmic-js-extension-using-bitbucket-pipelines" rel="noopener ugc nofollow" target="_blank">分享这篇文章</a>！</p><p id="adca" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你正在用Cosmic JS <a class="ae ld" href="https://cosmicjs.com/community" rel="noopener ugc nofollow" target="_blank">制作一个扩展或者其他东西，请联系我们的Slack </a>或者<a class="ae ld" href="https://twitter.com/cosmic_js" rel="noopener ugc nofollow" target="_blank"> Twitter </a>，我们很想看看你在制作什么。</p><p id="835d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">本文由<a class="ae ld" href="https://consulting.codogo.io/" rel="noopener ugc nofollow" target="_blank"> Codogo </a>撰写，这是一家屡获殊荣的数字机构，致力于创造令人惊叹的数字体验。</p><blockquote class="lw lx ly"><p id="eb48" class="jc jd lz je b jf jg jh ji jj jk jl jm ma jo jp jq mb js jt ju mc jw jx jy jz hn dt translated">这篇文章最初发表在宇宙JS博客上。</p></blockquote><div class="li lj lk ll fq ab cb"><figure class="md iv me mf mg mh mi paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="md iv me mf mg mh mi paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="md iv me mf mg mh mi paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="lw lx ly"><p id="f922" class="jc jd lz je b jf jg jh ji jj jk jl jm ma jo jp jq mb js jt ju mc jw jx jy jz hn dt translated"><a class="ae ld" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ld" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ld" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ld" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jc jd lz je b jf jg jh ji jj jk jl jm ma jo jp jq mb js jt ju mc jw jx jy jz hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ld" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ld" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="li lj lk ll fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mj"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>