<html>
<head>
<title>Akka Cluster in Docker. A Straight Forward Configuration.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Docker中的Akka集群。直截了当的结构。</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/akka-cluster-in-docker-a-straight-forwards-configuration-b6deea32752d?source=collection_archive---------2-----------------------#2016-11-28">https://medium.com/hackernoon/akka-cluster-in-docker-a-straight-forwards-configuration-b6deea32752d?source=collection_archive---------2-----------------------#2016-11-28</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><blockquote class="ir is it"><p id="679b" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">免责声明:我们不打算过Akka或Docker的细节，这只是我们缺少的指南配置Akka的Docker。为了更好地理解，您应该回顾一下这两个平台的基础</p></blockquote><p id="1ba8" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">在我的上一篇文章<a class="ae jw" href="https://hackernoon.com/yet-another-sbt-docker-introduction-2d9fb99fe367#.u0rt2nduu" rel="noopener ugc nofollow" target="_blank"> <em class="iw">中，我们讨论了如何使用Scala构建工具来创建docker文件和Docker图像。这在我们的组织中是必须的，因为我们可以使用我们习惯的工具sbt在CI环境中集成和自动化Docker流程。然而，正如你可能会怀疑的那样，这并不是故事的结尾。在我们今天要讨论的过程中，我们还遇到了其他Docker挑战。</em></a></p><p id="b970" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">我的团队有足够的信心使用Akka作为分布式工作的平台，并使用Docker作为在生产(或任何其他环境)中运行我们的Actor系统的平台，但这并不容易，至少在开始时是这样。</p><p id="6a68" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">让我们以几周前开始的相同方式开始，一个简单的应用程序使用分布式发布/订阅Akka功能将消息发布到Akka集群。</p><p id="3141" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">让我们来看看发布者代码:</p><figure class="jx jy jz ka fq kb"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="d4dd" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">在这里，我们的应用程序加载配置(我们接下来将查看它)，用它创建一个actor系统，并启动<strong class="ix hv"><em class="iw">dumbtick publisher</em></strong>actor，它每十秒钟向集群发布一条消息。</p><p id="9e5d" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">另一方面，我们需要从集群中读取消息(订阅)并对这些消息进行处理。</p><p id="8f0e" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">我们已经创建了一个新的应用程序，以便它订阅集群中的一些事件。订阅集群事件的参与者如下所示:</p><figure class="jx jy jz ka fq kb"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="9db4" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">它的工作是监听一个主题(<strong class="ix hv"> <em class="iw"> inputTopic </em> </strong>)，通过该主题得到的所有内容都将使用函数<strong class="ix hv"> <em class="iw"> f </em> </strong>进行转换，并使用主题<strong class="ix hv"> <em class="iw"> outputTopic </em> </strong>发布回集群。</p><p id="2407" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">现在，我们需要启动<strong class="ix hv"> <em class="iw">变压器</em> </strong>。</p><figure class="jx jy jz ka fq kb"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="565a" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">这段代码看起来与publisher上的代码非常相似，但是这里我们创建了<strong class="ix hv"> <em class="iw"> Transformer </em> </strong>的实例，而不是<strong class="ix hv"><em class="iw">dummtickpublisher。</em> </strong></p><p id="6474" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">现在我们有两个应用程序，一个向集群发送消息，一个读取消息，所以我们的下一步是能够运行它们。</p><h1 id="a160" class="ke kf hu bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dt translated">配置</h1><p id="6f58" class="pw-post-body-paragraph iu iv hu ix b iy lc ja jb jc ld je jf jt le ji jj ju lf jm jn jv lg jq jr js hn dt translated">这里是我们花了大部分时间的地方，主要是因为我们在网上的其他地方没有找到足够的信息。</p><p id="3804" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">让我们快速回顾一下配置。</p><figure class="jx jy jz ka fq kb"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="22ec" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">你可以在任何在线例子中找到类似的东西，有很多这样的例子，但是仍然缺少在Docker上运行的部分。</p><p id="00ff" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">使用当前的配置，我们实际上可以在两个不同的JVM上本地启动这两个应用程序，它们将开始相互通信。信息会从一个发送到另一个，一点问题都没有。</p><p id="efd9" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">这就是你所需要的，将建立两个Docker图像，并创建一个可能看起来像这样的合成文件。</p><figure class="jx jy jz ka fq kb"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="d85c" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">我们运行<strong class="ix hv"> <em class="iw"> docker-compose up </em> </strong>，两个容器将启动。我们将看到和以前一样，他们的工作。<em class="iw">没有真的</em>。</p><p id="28f2" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">问题是，现在我们希望能够说:</p><p id="579d" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated"><strong class="ix hv"><em class="iw">docker-compose scale C1 = 5</em>T9】</strong></p><p id="8148" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">但这是不可能的。尽管您会看到容器正在启动，但Akka日志说的完全不同。节点不再可见，参与者系统进入不可逆转的失败状态。</p><p id="01bb" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated"><em class="iw">问题是Akka需要一个特殊的配置才能在NAT之后或Docker容器中运行。</em></p><p id="f21e" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">您需要将<strong class="ix hv"> <em class="iw">绑定主机名</em> </strong>和<strong class="ix hv"> <em class="iw">绑定端口</em> </strong>添加到配置文件中。</p><p id="fe75" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">经过多次尝试，我们找到了一种适合我们的配置。</p><figure class="jx jy jz ka fq kb"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="0ab4" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">为了让容器之间能够互相交谈，我们需要设置<strong class="ix hv"><em class="iw"/></strong>到容器的ip和一个特定的<strong class="ix hv"> <em class="iw">端口</em> </strong>。发送到此地址的消息将被翻译成<strong class="ix hv"> <em class="iw"> bind-* </em> </strong>。</p><p id="6653" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">最后一部分是更新我们的合成文件，如下所示。</p><figure class="jx jy jz ka fq kb"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="dc4f" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">记住我们需要Docker容器ip ( <em class="iw"> CLUSTER_IP </em>)，所以我们传递" " with暗示它将使用<strong class="ix hv"><em class="iw">inet address . getlocalhost . gethostaddress</em></strong>来代替，如文档所示。此外，我们在<em class="iw"> CLUSTER_PORT </em>中使用了端口0 (cero ),因此Akka使用随机端口。</p><p id="57ff" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">完成这些更改后，我们应该能够重建Docker映像(确保配置更改进入Docker映像)并运行:</p><p id="9910" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated"><strong class="ix hv"><em class="iw">docker-compose up</em></strong></p><p id="afeb" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated"><strong class="ix hv"><em class="iw">docker-compose scale C1 = 100</em></strong></p><p id="ff4e" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">你会看到你的演员们是如何开始互相交流的，你会意识到你已经准备好了。</p></div><div class="ab cl lh li hc lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="hn ho hp hq hr"><p id="6eb2" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">我们花了很多时间才找到这些小的配置细节。我们认为通过记录它们可以做得更好，特别是在像Akka这样广泛使用的平台上。</p><p id="c851" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf jt jh ji jj ju jl jm jn jv jp jq jr js hn dt translated">我们希望你能从我们在这件事上的工作和时间中受益。特别感谢御光团队为演员系统所做的工作。</p><blockquote class="ir is it"><p id="3975" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><a class="ae jw" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jw" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jw" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae jw" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="dca4" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">要了解更多信息，请<a class="ae jw" href="https://goo.gl/4ofytp" rel="noopener ugc nofollow" target="_blank">阅读我们的“关于”页面</a>、<a class="ae jw" href="http://bit.ly/HackernoonFB" rel="noopener ugc nofollow" target="_blank">在脸书上点赞/给我们发消息</a>，或者简单地说，<a class="ae jw" href="https://goo.gl/k7XYbx" rel="noopener ugc nofollow" target="_blank"> tweet/DM @HackerNoon。</a></p><p id="708a" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jw" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jw" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote></div></div>    
</body>
</html>