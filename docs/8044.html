<html>
<head>
<title>From CSV to Buxfer: an unexpected journey — Collector</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从CSV到Buxfer:意想不到的旅程——收藏家</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/from-csv-to-buxfer-an-unexpected-journey-collector-4dbde92c1e7b?source=collection_archive---------34-----------------------#2017-11-16">https://medium.com/hackernoon/from-csv-to-buxfer-an-unexpected-journey-collector-4dbde92c1e7b?source=collection_archive---------34-----------------------#2017-11-16</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="abd9" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">第3部分——收集器:关于如何编写一个收集纯数据集的程序的故事</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/e584c851ae97f094c5099804323c47eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*16e-kII9hT79sdyrCYN3Ig.jpeg"/></div></div></figure><h1 id="6beb" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">序文</h1><p id="4527" class="pw-post-body-paragraph kn ko hu kp b kq kr iv ks kt ku iy kv kw kx ky kz la lb lc ld le lf lg lh li hn dt translated">在<a class="ae lj" href="https://hackernoon.com/from-csv-to-buxfer-an-unexpected-journey-cleaner-c87e8a77fda6" rel="noopener ugc nofollow" target="_blank">Cleaner-Part 2</a>中，我已经编写了这个项目的第一个程序，清理原始数据并使其可用于第二个程序:收集器📦！</p><p id="9ec2" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">收集器必须从CSV文件中读取干净的数据，并使用在<a class="ae lj" href="https://hackernoon.com/from-csv-to-buxfer-an-unexpected-journey-introduction-ba43ef768fe2" rel="noopener ugc nofollow" target="_blank">第1部分</a>中定义的数据模型将其存储在<a class="ae lj" href="https://hackernoon.com/tagged/mongodb" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>实例中。</p><h2 id="37ba" class="lp jw hu bd jx lq lr ls kb lt lu lv kf kw lw lx kh la ly lz kj le ma mb kl mc dt translated">旅行</h2><p id="f1a4" class="pw-post-body-paragraph kn ko hu kp b kq kr iv ks kt ku iy kv kw kx ky kz la lb lc ld le lf lg lh li hn dt translated">在本文中，我将介绍这一旅程的第三部分:</p><ol class=""><li id="1a87" class="md me hu kp b kq lk kt ll kw mf la mg le mh li mi mj mk ml dt translated"><a class="ae lj" rel="noopener" href="/@wilk/from-csv-to-buxfer-an-unexpected-journey-introduction-ba43ef768fe2">第一部分:简介</a></li><li id="c586" class="md me hu kp b kq mm kt mn kw mo la mp le mq li mi mj mk ml dt translated"><a class="ae lj" href="https://hackernoon.com/from-csv-to-buxfer-an-unexpected-journey-cleaner-c87e8a77fda6" rel="noopener ugc nofollow" target="_blank">第2部分:清洁剂</a></li><li id="2dea" class="md me hu kp b kq mm kt mn kw mo la mp le mq li mi mj mk ml dt translated">第三部分(本部分):收藏家</li><li id="ac79" class="md me hu kp b kq mm kt mn kw mo la mp le mq li mi mj mk ml dt translated"><a class="ae lj" rel="noopener" href="/@wilk/from-csv-to-buxfer-an-unexpected-journey-goxfer-88d8a14e8905">第4部分:Goxfer </a></li><li id="2263" class="md me hu kp b kq mm kt mn kw mo la mp le mq li mi mj mk ml dt translated"><a class="ae lj" rel="noopener" href="/@wilk/from-csv-to-buxfer-an-unexpected-journey-conclusions-b1274aa9841e">第5部分:结论</a></li></ol><h1 id="019a" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">入门指南</h1><p id="bdb8" class="pw-post-body-paragraph kn ko hu kp b kq kr iv ks kt ku iy kv kw kx ky kz la lb lc ld le lf lg lh li hn dt translated">这是这次冒险的第二个重要区块:<strong class="kp hv">收集者</strong>。<br/>过程类似于清理器:更新docker-compose.yml文件，然后用<a class="ae lj" href="https://hackernoon.com/tagged/python" rel="noopener ugc nofollow" target="_blank"> Python </a>编写程序。</p><p id="dcdd" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">因此，与清理程序一样，收集服务程序使用相同的Python映像，装载相同的卷，启动类似的命令，并使用清理程序的一些环境变量。<br/>让我们更新收集服务程序:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mr ms l"/></div></figure><p id="ab9e" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">实际上，连接器需要更多的东西:例如，附加一个MongoDB实例！<br/>好了，连接MongoDB需要一些变量…耶，环境变量！<br/>当然，收集器服务将依赖于<em class="mt"> mongodb </em>服务，所以我将重写它:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mr ms l"/></div></figure><p id="2daf" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">很好！我几乎已经准备好了开始编写收集器程序的一切:我还需要一些信息。<br/>例如，我想为每个文件定制帐户名，比如<em class="mt">费用</em>和<em class="mt">收入</em>，并用我的新定制标签映射交易标签。<br/>如前所述，我将它们放在环境空间内:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mr ms l"/></div></figure><p id="9685" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">现在，<em class="mt"> TAGS_FILE </em>是对一个文件的引用，我将CSV文件中的这些标记与我自己的定制标记进行映射，如下所示:</p><pre class="jk jl jm jn fq mu mv mw mx aw my dt"><span id="ed1c" class="lp jw hu mv b fv mz na l nb nc">{<br/>  "expenses.csv": {<br/>    "Abbigliamento": ["Abbigliamento", "Uscite / Annuali"]<br/>  }<br/>}</span></pre><p id="16f7" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">我必须这样做，因为我当前的事务每个都有多个标记。<br/>因此，对于这样的交易:</p><pre class="jk jl jm jn fq mu mv mw mx aw my dt"><span id="af03" class="lp jw hu mv b fv mz na l nb nc">04/06/2016,Abbigliamento,maglietta,"5,00"</span></pre><p id="3e44" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">结果将是一个新的事务，它有两个相关联的标签:<strong class="kp hv"> Abbigliamento </strong>和<strong class="kp hv"> Uscite / Annuali </strong>。</p><p id="b098" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated"><em class="mt">费用_账户</em>和<em class="mt">收入_账户</em>分别定义费用和收入交易的账户。</p><h1 id="df65" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">收藏者</h1><p id="d21e" class="pw-post-body-paragraph kn ko hu kp b kq kr iv ks kt ku iy kv kw kx ky kz la lb lc ld le lf lg lh li hn dt translated">是时候定义收集器过程了:</p><ol class=""><li id="6cf0" class="md me hu kp b kq lk kt ll kw mf la mg le mh li mi mj mk ml dt translated"><strong class="kp hv">连接到MongoDB </strong></li><li id="068b" class="md me hu kp b kq mm kt mn kw mo la mp le mq li mi mj mk ml dt translated"><strong class="kp hv">读取CSV </strong>已清理文件</li><li id="fe9b" class="md me hu kp b kq mm kt mn kw mo la mp le mq li mi mj mk ml dt translated">对于每一行，映射正确的<strong class="kp hv">帐户和标签</strong></li><li id="9223" class="md me hu kp b kq mm kt mn kw mo la mp le mq li mi mj mk ml dt translated">对于每一行，<strong class="kp hv">创建</strong>一个MongoDB文档</li><li id="121f" class="md me hu kp b kq mm kt mn kw mo la mp le mq li mi mj mk ml dt translated"><strong class="kp hv">检查</strong>增加的交易数量</li></ol><p id="2378" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">好的，首先，我需要收集器检查被清理的文件夹是否存在:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mr ms l"/></div></figure><p id="91ac" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">然后，数据库连接，接着是用于清除以前执行的擦除过程:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mr ms l"/></div></figure><p id="1163" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">太好了！<br/>让我们来读一些文件:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mr ms l"/></div></figure><p id="015e" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated"><strong class="kp hv">标签</strong>是一个字典，用于映射旧标签和新标签，而<strong class="kp hv"> csv_files </strong>保存csv文件引用。</p><p id="49ff" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">现在，是时候编写收集器核心逻辑了:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mr ms l"/></div></figure><p id="bb90" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">长话短说:对于每个CSV文件，在MongoDB中放置一个新的事务，使用一个字典来表示它。<br/>交易模型由一个日期(<a class="ae lj" href="https://docs.python.org/3.6/library/datetime.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kp hv"> datetime </strong> </a>包在这些情况下非常有用)、一个帐户(定义交易的类型)、一个描述、一个金额(通过将string转换为float构建)和一个tag列表(将TAGS_FILE与原始交易的tag结合在一起)组成。<br/>然后更新一些计数器，如<strong class="kp hv"> transactions_counter </strong>和<strong class="kp hv"> total_counter </strong>，因为它们将用于最终测试。</p><h2 id="96ca" class="lp jw hu bd jx lq lr ls kb lt lu lv kf kw lw lx kh la ly lz kj le ma mb kl mc dt translated">测试</h2><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mr ms l"/></div></figure><p id="6b9d" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">当收集器的执行完成后，我需要检查从CSV文件中读取的事务量是否等于MongoDB中插入的事务量:我需要检查计数器和总量。<br/>使用<strong class="kp hv">断言</strong>，我可以测试<strong class="kp hv"> total_counter </strong>(即添加的交易数)和<strong class="kp hv"> total_amount </strong>(添加的每笔交易的总和)是否等于<strong class="kp hv"> collection_counter </strong>和<strong class="kp hv"> amount_counter </strong>(对应的，从DB中读取并计算)。</p><p id="1639" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">此时，在cleaner之后运行collector可以很容易地用清理后的数据填充数据库，从而有新的事务准备推送到Buxfer上！</p><p id="a626" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">遵循<strong class="kp hv"> collector.py </strong>的源代码:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mr ms l"/></div></figure><h1 id="4310" class="jv jw hu bd jx jy jz ka kb kc kd ke kf ja kg jb kh jd ki je kj jg kk jh kl km dt translated">第3部分结束</h1><p id="1485" class="pw-post-body-paragraph kn ko hu kp b kq kr iv ks kt ku iy kv kw kx ky kz la lb lc ld le lf lg lh li hn dt translated">在收集器出现之前，我只有一堆CSV文件，包含如下数据:</p><pre class="jk jl jm jn fq mu mv mw mx aw my dt"><span id="b4c2" class="lp jw hu mv b fv mz na l nb nc">02/01/2016,Alimentari,spesa,"17,64"<br/>26/03/2016,Hobby,libri,"30,46"<br/>04/06/2016,Abbigliamento,maglietta,"5,00"</span></pre><p id="2a76" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">但是，我有更好的东西！看一看:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff nd"><img src="../Images/0d71f38355839ca75a0019970f822f9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jM91o3ZmLvgOVaPLkpbF5A.png"/></div></div></figure><p id="c8e3" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">好多了😁</p><p id="918f" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">因此，Collector将清理后的非结构化数据提升为MongoDB中定义良好、结构良好的文档。<br/>这对于<strong class="kp hv">数据分析</strong>很有用，它绝对是Python和GoLang之间的桥梁(在下一步中使用)。</p><p id="fd54" class="pw-post-body-paragraph kn ko hu kp b kq lk iv ks kt ll iy kv kw lm ky kz la ln lc ld le lo lg lh li hn dt translated">如果你喜欢这篇文章，不要忘记分享它！<br/>在<a class="ae lj" rel="noopener" href="/@wilk/from-csv-to-buxfer-an-unexpected-journey-goxfer-88d8a14e8905">第四部:转移</a>再见！</p></div><div class="ab cl ne nf hc ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="hn ho hp hq hr"><h2 id="c6d6" class="lp jw hu bd jx lq lr ls kb lt lu lv kf kw lw lx kh la ly lz kj le ma mb kl mc dt translated">扰流器</h2><p id="4bab" class="pw-post-body-paragraph kn ko hu kp b kq kr iv ks kt ku iy kv kw kx ky kz la lb lc ld le lf lg lh li hn dt translated">源代码已经可以在这里获得:<a class="ae lj" href="https://github.com/wilk/from-csv-to-buxfer" rel="noopener ugc nofollow" target="_blank">https://github.com/wilk/from-csv-to-buxfer</a></p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nl ms l"/></div></figure></div></div>    
</body>
</html>