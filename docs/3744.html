<html>
<head>
<title>[Nodejs][React] Isomorphic-Fetch: the suspicious part</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">[Nodejs][React]同构获取:可疑部分</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/isomorphic-fetch-node-js-react-tutorial-example-error-timeout-handle-npm-1575752877b4?source=collection_archive---------4-----------------------#2017-04-20">https://medium.com/hackernoon/isomorphic-fetch-node-js-react-tutorial-example-error-timeout-handle-npm-1575752877b4?source=collection_archive---------4-----------------------#2017-04-20</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/7d01e72ddc81dde7746b8d936d87453b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JK8Bg3epsj_K4kvXlLf8iA.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Isomorphic-Fetch, write once use two sides</figcaption></figure><p id="ab58" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我相信每一个<strong class="ji hv"> <em class="ke">【同构开发者】</em> </strong>都一定听说过<em class="ke">同构提取</em>这个神奇的功能，它是为<em class="ke"> Node.js </em>和<em class="ke">浏览器</em>发送API请求的实现。</p><blockquote class="kf"><p id="766c" class="kg kh hu bd ki kj kk kl km kn ko kd ek translated">一次编写使用两端，服务器和浏览器</p></blockquote><p id="61ec" class="pw-post-body-paragraph jg jh hu ji b jj kp jl jm jn kq jp jq jr kr jt ju jv ks jx jy jz kt kb kc kd hn dt translated">为了检验这些测试是如何实现的，请从git 中克隆<a class="ae ku" href="https://github.com/wahengchang/isomorphicfetch-must-know" rel="noopener ugc nofollow" target="_blank">库。</a></p></div><div class="ab cl kv kw hc kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hn ho hp hq hr"><h1 id="daf9" class="lc ld hu bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz dt translated">同构提取简介</h1><h2 id="dd05" class="ma ld hu bd le mb mc md li me mf mg lm jr mh mi lq jv mj mk lu jz ml mm ly mn dt translated">安装</h2><pre class="mo mp mq mr fq ms mt mu mv aw mw dt"><span id="17a4" class="ma ld hu mt b fv mx my l mz na">$ npm install --save<strong class="mt hv"> isomorphic-fetch es6-promise</strong></span></pre><p id="63b5" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">并导入到<em class="ke"> Node.js server </em>的条目中</p><pre class="mo mp mq mr fq ms mt mu mv aw mw dt"><span id="bd2d" class="ma ld hu mt b fv mx my l mz na">require('es6-promise').polyfill();<br/>require('isomorphic-fetch');</span></pre><p id="fdb0" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">正确的方法使用fetch()，使用<strong class="ji hv"><em class="ke">respo SNE . text()</em></strong>解析文本响应，使用<strong class="ji hv"><em class="ke">respo SNE . json()</em></strong>解析来自服务器的JSON响应<strong class="ji hv"> <em class="ke"> </em> </strong>:</p><figure class="mo mp mq mr fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nb"><img src="../Images/944786ab31f7787972596f28e3035a55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J-n0ZP2RfsqoYBqi3VZatg.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">text response</figcaption></figure><figure class="mo mp mq mr fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nb"><img src="../Images/d90061ca0ce66b47e4eaa6d7728120ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7dV_yci7NglmX0n5RRFVFw.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">json response</figcaption></figure><h1 id="def8" class="lc ld hu bd le lf nc lh li lj nd ll lm ln ne lp lq lr nf lt lu lv ng lx ly lz dt translated">同构获取的棘手部分</h1><p id="9a55" class="pw-post-body-paragraph jg jh hu ji b jj nh jl jm jn ni jp jq jr nj jt ju jv nk jx jy jz nl kb kc kd hn dt translated">根据我的经验，fetch()很容易使用，在构建同构网站时节省了我很多时间，但是当有错误或异常发生时，它太安静了，我花了很多时间来找出错误。</p><p id="c0a8" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我试验fetch()的方式是创建一个简单的<strong class="ji hv"> <em class="ke"> Express.js </em> </strong>服务器，有5种不同的情况:<br/> 1)响应<strong class="ji hv">文本</strong>带<strong class="ji hv"> 200 </strong>状态码<br/> 2)响应<strong class="ji hv"> json </strong>带<strong class="ji hv"> 200 </strong>状态码<br/> 3)响应<strong class="ji hv">文本</strong>带<strong class="ji hv"> 400 </strong>状态码</p><p id="83ec" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">当我使用不正确的方法来处理这些情况时，找出fetch()内部实际发生了什么。</p><h2 id="9b06" class="ma ld hu bd le mb mc md li me mf mg lm jr mh mi lq jv mj mk lu jz ml mm ly mn dt translated">1.通过response.json()解析文本响应</h2><p id="0e52" class="pw-post-body-paragraph jg jh hu ji b jj nh jl jm jn ni jp jq jr nj jt ju jv nk jx jy jz nl kb kc kd hn dt translated"><em class="ke">转到异常</em></p><figure class="mo mp mq mr fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nb"><img src="../Images/f0ac459f90a62a8bcfc48dfec4078965.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*geZWo4WoBIvyNq-IK1Mvyw.jpeg"/></div></div></figure><h2 id="0c48" class="ma ld hu bd le mb mc md li me mf mg lm jr mh mi lq jv mj mk lu jz ml mm ly mn dt translated">2.通过response.text()解析json响应</h2><p id="6259" class="pw-post-body-paragraph jg jh hu ji b jj nh jl jm jn ni jp jq jr nj jt ju jv nk jx jy jz nl kb kc kd hn dt translated">它响应为<em class="ke">字符串类型</em></p><figure class="mo mp mq mr fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nb"><img src="../Images/29fc14f7dde452255f18d2ed1d306347.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_9NyUbES9HUuGv9Cd1YPVw.jpeg"/></div></div></figure><h2 id="ec0e" class="ma ld hu bd le mb mc md li me mf mg lm jr mh mi lq jv mj mk lu jz ml mm ly mn dt translated">3.无法进行超时处理</h2><p id="c2e9" class="pw-post-body-paragraph jg jh hu ji b jj nh jl jm jn ni jp jq jr nj jt ju jv nk jx jy jz nl kb kc kd hn dt translated">fetch()不支持超时处理，它可能会一直等到我们死亡而没有响应。绕过的方法是自己创建一个timeoutPromise包装器。</p><p id="b713" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这是@ <a class="ae ku" href="https://github.com/alcat2008" rel="noopener ugc nofollow" target="_blank"> alcat2008 </a>在<a class="ae ku" href="https://github.com/whatwg/fetch/issues/20" rel="noopener ugc nofollow" target="_blank"> <em class="ke"> git问题</em> </a>中提出的解决方案:</p><pre class="mo mp mq mr fq ms mt mu mv aw mw dt"><span id="c1e2" class="ma ld hu mt b fv mx my l mz na">var p = Promise.race([<br/>  fetch('/resource-that-may-take-a-while'),<br/>  new Promise(function (resolve, reject) {<br/>    setTimeout(() =&gt; reject(new Error('request timeout')), 5000)<br/>  })<br/>])</span><span id="ff40" class="ma ld hu mt b fv nm my l mz na">p.then(response =&gt; console.log(response))<br/>p.catch(error =&gt; console.log(error))</span></pre></div><div class="ab cl kv kw hc kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hn ho hp hq hr"><p id="d996" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">喜欢这个故事？对别人有帮助吗？这有助于我知道你是否想看到更多关于他的主题，并帮助人们看到这个故事，<strong class="ji hv"> <em class="ke">当点击下面的心</em> </strong>。</p></div><div class="ab cl kv kw hc kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hn ho hp hq hr"><h2 id="eaae" class="ma ld hu bd le mb mc md li me mf mg lm jr mh mi lq jv mj mk lu jz ml mm ly mn dt translated">参考:</h2><p id="d57e" class="pw-post-body-paragraph jg jh hu ji b jj nh jl jm jn ni jp jq jr nj jt ju jv nk jx jy jz nl kb kc kd hn dt translated"><a class="ae ku" href="https://www.npmjs.com/package/isomorphic-fetch" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/isomorphic-fetch</a></p><p id="365c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">【https://github.com/wahengchang/isomorphicfetch-must-know T2】号</p><div class="mo mp mq mr fq ab cb"><figure class="nn iv no np nq nr ns paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="nn iv no np nq nr ns paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="nn iv no np nq nr ns paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="nt nu nv"><p id="f922" class="jg jh ke ji b jj jk jl jm jn jo jp jq nw js jt ju nx jw jx jy ny ka kb kc kd hn dt translated"><a class="ae ku" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ku" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ku" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ku" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jg jh ke ji b jj jk jl jm jn jo jp jq nw js jt ju nx jw jx jy ny ka kb kc kd hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ku" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ku" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="mo mp mq mr fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nz"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>