<html>
<head>
<title>Simple multi tenant with Laravel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带Laravel的简单多租户</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/simple-multi-tenancy-with-laravel-b3f84fc13c39?source=collection_archive---------0-----------------------#2017-04-23">https://medium.com/hackernoon/simple-multi-tenancy-with-laravel-b3f84fc13c39?source=collection_archive---------0-----------------------#2017-04-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/f479991d55c593fc0365fc99e85a31fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mS2z2TJsSRW6v-VT8-3bmQ.png"/></div></div></figure><div class=""/><p id="86a3" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在开发一个小型管理工具来帮助公司对800个不同的数据库进行数据更改时，我几乎没有时间来想出一个可靠的解决方案，来说明如何用Laravel建立主/租户连接。当你用Laravel搜索多租户时，大约有3个包脱颖而出。</p><ul class=""><li id="4a18" class="ka kb if je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated"><a class="ae kj" href="https://github.com/hyn/multi-tenant" rel="noopener ugc nofollow" target="_blank">hyn/多租户</a>由<a class="ae kj" href="https://github.com/Luceos" rel="noopener ugc nofollow" target="_blank"> Luceos </a></li></ul><p id="a5fe" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我玩了一会儿<a class="ae kj" href="https://hyn.readme.io/" rel="noopener ugc nofollow" target="_blank"> hyn </a>，不可否认这是一个很棒的软件包，但是它与Laravel 5.4不兼容(我说过我时间不多吗？).这让我害怕不得不经常处理过时的软件包，我不想让这个负担压在我身上。</p><ul class=""><li id="1133" class="ka kb if je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated"><a class="ae kj" href="https://github.com/orchestral/tenanti" rel="noopener ugc nofollow" target="_blank">管弦乐/泰南提</a></li></ul><p id="7472" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">那时，管弦乐对我来说太复杂了。Laravel初学者，特别是当你没有其他框架经验时，可能需要一些时间来理解服务提供者、引导等。我无法完全理解单数据库和多数据库的解决方案。</p><ul class=""><li id="8a58" class="ka kb if je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated"><a class="ae kj" href="https://github.com/HipsterJazzbo/Landlord" rel="noopener ugc nofollow" target="_blank">楼主</a></li></ul><p id="208d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">单一数据库解决方案。不是我需要的。</p><h1 id="10a1" class="kk kl if bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">自己动手</h1><p id="e084" class="pw-post-body-paragraph jc jd if je b jf li jh ji jj lj jl jm jn lk jp jq jr ll jt ju jv lm jx jy jz hn dt translated">Laravel让你自己动手变得非常简单。您所需要的只是一个连接配置、一个中间件、一个特征连接器，并相应地设置您的模型。</p><h2 id="5730" class="ln kl if bd km lo lp lq kq lr ls lt ku jn lu lv ky jr lw lx lc jv ly lz lg ma dt translated">连接设置</h2><p id="2d8e" class="pw-post-body-paragraph jc jd if je b jf li jh ji jj lj jl jm jn lk jp jq jr ll jt ju jv lm jx jy jz hn dt translated">在您的<strong class="je ig"> config/database.php </strong>文件中，让我们设置2个连接。请注意，我删除了<strong class="je ig"> mysql </strong>连接，所以您需要您的<strong class="je ig">。env </strong>说<strong class="je ig"> DB_CONNECTION=main </strong></p><pre class="mb mc md me fq mf mg mh mi aw mj dt"><span id="4a1c" class="ln kl if mg b fv mk ml l mm mn">'connections' =&gt; [<br/>    <br/>    'main' =&gt; [<br/>        'driver' =&gt; 'mysql',<br/>        'host' =&gt; env('DB_HOST', '127.0.0.1'),<br/>        'port' =&gt; env('DB_PORT', '3306'),<br/>        'database' =&gt; env('DB_DATABASE', 'forge'),<br/>        'username' =&gt; env('DB_USERNAME', 'forge'),<br/>        'password' =&gt; env('DB_PASSWORD', ''),<br/>        'charset' =&gt; 'utf8mb4',<br/>        'collation' =&gt; 'utf8mb4_unicode_ci',<br/>        'prefix' =&gt; '',<br/>        'strict' =&gt; <strong class="mg ig">true</strong>,<br/>        'engine' =&gt; <strong class="mg ig">null</strong>,<br/>    ],<br/>    <br/>    'tenant' =&gt; [<br/>        'driver' =&gt; 'mysql',<br/>        'host' =&gt; env('DB_HOST', '127.0.0.1'),<br/>        'port' =&gt; env('DB_PORT', '3306'),<br/>        'database' =&gt; '',<br/>        'username' =&gt; '',<br/>        'password' =&gt; '',<br/>        'charset' =&gt; 'utf8mb4',<br/>        'collation' =&gt; 'utf8mb4_unicode_ci',<br/>        'prefix' =&gt; '',<br/>        'strict' =&gt; <strong class="mg ig">true</strong>,<br/>        'engine' =&gt; <strong class="mg ig">null</strong>,<br/>    ]<br/>]</span></pre><h2 id="3beb" class="ln kl if bd km lo lp lq kq lr ls lt ku jn lu lv ky jr lw lx lc jv ly lz lg ma dt translated">中间件</h2><p id="42ae" class="pw-post-body-paragraph jc jd if je b jf li jh ji jj lj jl jm jn lk jp jq jr ll jt ju jv lm jx jy jz hn dt translated">始终确保连接存在。您所要做的就是确保所有应该连接到<strong class="je ig">租户</strong>数据库的路由都使用这个中间件。在我的特定情况下，用户将从列表中选择一个客户(租户),并操作该客户的数据，因此使用了会话。但是我可以很容易地拥有两个中间件(WebTenant、ApiTenant ),并依靠令牌来选择一个租户连接。</p><pre class="mb mc md me fq mf mg mh mi aw mj dt"><span id="7f04" class="ln kl if mg b fv mk ml l mm mn">&lt;?php<br/><br/><strong class="mg ig">namespace </strong>App\Http\Middleware;<br/><br/><strong class="mg ig">use </strong>App\Models\Main\Company;<br/><strong class="mg ig">use </strong>App\Support\Controller\TenantConnector;<br/><strong class="mg ig">use </strong>Closure;<br/><br/><strong class="mg ig">class </strong>Tenant {<br/><br/>    <strong class="mg ig">use </strong>TenantConnector;<br/><br/>    <em class="mo">/**<br/>     * </em><strong class="mg ig"><em class="mo">@var </em></strong><em class="mo">Company<br/>     */<br/>    </em><strong class="mg ig">protected </strong>$company;<br/><br/>    <em class="mo">/**<br/>     * Tenant constructor.<br/>     * </em><strong class="mg ig"><em class="mo">@param </em></strong><em class="mo">Company $company<br/>     */<br/>    </em><strong class="mg ig">public function </strong>__construct(Company $company) {<br/>        $this-&gt;company = $company;<br/>    }<br/><br/>    <em class="mo">/**<br/>     * Handle an incoming request.<br/>     *<br/>     * </em><strong class="mg ig"><em class="mo">@param  </em></strong><em class="mo">\Illuminate\Http\Request $request<br/>     * </em><strong class="mg ig"><em class="mo">@param  </em></strong><em class="mo">\Closure $next<br/>     * </em><strong class="mg ig"><em class="mo">@return </em></strong><em class="mo">mixed<br/>     */<br/>    </em><strong class="mg ig">public function </strong>handle($request, Closure $next) {<br/>        <strong class="mg ig">if </strong>(($request-&gt;session()-&gt;get('tenant')) === <strong class="mg ig">null</strong>)<br/>            <strong class="mg ig">return </strong>redirect()-&gt;route('home')-&gt;withErrors(['error' =&gt; __('Please select a customer/tenant before making this request.')]);<br/><br/>        // Get the company object with the id stored in session<br/>        $company = $this-&gt;company-&gt;find($request-&gt;session()-&gt;get('tenant'));<br/><br/>        // Connect and place the $company object in the view<br/>        $this-&gt;reconnect($company);<br/>        $request-&gt;session()-&gt;put('company', $company);<br/><br/>        <strong class="mg ig">return </strong>$next($request);<br/>    }<br/>}</span></pre><h2 id="b758" class="ln kl if bd km lo lp lq kq lr ls lt ku jn lu lv ky jr lw lx lc jv ly lz lg ma dt translated">TenantConnector(特征)</h2><p id="97ca" class="pw-post-body-paragraph jc jd if je b jf li jh ji jj lj jl jm jn lk jp jq jr ll jt ju jv lm jx jy jz hn dt translated">这里没什么好说的。只需设置您的租户数据连接。</p><pre class="mb mc md me fq mf mg mh mi aw mj dt"><span id="bfe2" class="ln kl if mg b fv mk ml l mm mn"><strong class="mg ig">&lt;?php<br/><br/>namespace </strong>App\Support;<br/><br/><strong class="mg ig">use </strong>App\Models\Main\Company;<br/><strong class="mg ig">use </strong>Illuminate\Support\Facades\Config;<br/><strong class="mg ig">use </strong>Illuminate\Support\Facades\DB;<br/><strong class="mg ig">use </strong>Illuminate\Support\Facades\Schema;<br/><br/><strong class="mg ig">trait </strong>TenantConnector {<br/>   <br/>   <em class="mo">/**<br/>    * Switch the Tenant connection to a different company.<br/>    * </em><strong class="mg ig"><em class="mo">@param </em></strong><em class="mo">Company $company<br/>    * </em><strong class="mg ig"><em class="mo">@return </em></strong><em class="mo">void<br/>    * </em><strong class="mg ig"><em class="mo">@throws<br/>    </em></strong><em class="mo">*/<br/>   </em><strong class="mg ig">public function </strong>reconnect(Company $company) {     <br/>      // Erase the tenant connection, thus making Laravel get the default values all over again.<br/>      DB::<em class="mo">purge</em>('tenant');<br/>      <br/>      // Make sure to use the database name we want to establish a connection.<br/>      Config::<em class="mo">set</em>('database.connections.tenant.host', $company-&gt;mysql_host);<br/>      Config::<em class="mo">set</em>('database.connections.tenant.database', $company-&gt;mysql_database);<br/>      Config::<em class="mo">set</em>('database.connections.tenant.username', $company-&gt;mysql_username);<br/>      Config::<em class="mo">set</em>('database.connections.tenant.password', $company-&gt;mysql_password);<br/>      <br/>      // Rearrange the connection data<br/>      DB::<em class="mo">reconnect</em>('tenant');<br/>      <br/>      // Ping the database. This will throw an exception in case the database does not exists or the connection fails<br/>      Schema::<em class="mo">connection</em>('tenant')-&gt;getConnection()-&gt;reconnect();<br/>   }<br/>   <br/>}</span></pre><h2 id="2686" class="ln kl if bd km lo lp lq kq lr ls lt ku jn lu lv ky jr lw lx lc jv ly lz lg ma dt translated">模特们</h2><p id="a256" class="pw-post-body-paragraph jc jd if je b jf li jh ji jj lj jl jm jn lk jp jq jr ll jt ju jv lm jx jy jz hn dt translated">主数据库中的模型将拥有<strong class="je ig">主</strong>连接，如此而已。</p><pre class="mb mc md me fq mf mg mh mi aw mj dt"><span id="a7e7" class="ln kl if mg b fv mk ml l mm mn"><strong class="mg ig">&lt;?php<br/><br/>namespace </strong>App\Models\Main;<br/><br/><strong class="mg ig">use </strong>Illuminate\Notifications\Notifiable;<br/><strong class="mg ig">use </strong>Illuminate\Foundation\Auth\User <strong class="mg ig">as </strong>Authenticatable;<br/><br/><strong class="mg ig">class </strong>Admin <strong class="mg ig">extends </strong>Authenticatable {<br/>   <br/>   <strong class="mg ig">use </strong>Notifiable;<br/>   <br/>   <strong class="mg ig">protected </strong>$connection = 'main';<br/>}</span></pre><p id="36ec" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">公司(客户/租户)模型只是略有不同。我决定在这里也使用TenantConnector特性，并提供一个<strong class="je ig"> connect() </strong>方法。这让我可以做类似<strong class="je ig">Company::find($ id)-&gt;connect()；</strong></p><pre class="mb mc md me fq mf mg mh mi aw mj dt"><span id="83d7" class="ln kl if mg b fv mk ml l mm mn"><strong class="mg ig">&lt;?php<br/><br/>namespace </strong>App\Models\Main;<br/><br/><strong class="mg ig">use </strong>App\Support\TenantConnector;<br/><strong class="mg ig">use </strong>Illuminate\Database\Eloquent\Model;<br/><br/><em class="mo">/**<br/> * </em><strong class="mg ig"><em class="mo">@property </em></strong><em class="mo">string mysql_host<br/> * </em><strong class="mg ig"><em class="mo">@property </em></strong><em class="mo">string mysql_database<br/> * </em><strong class="mg ig"><em class="mo">@property </em></strong><em class="mo">string mysql_username<br/> * </em><strong class="mg ig"><em class="mo">@property </em></strong><em class="mo">string mysql_password<br/> * </em><strong class="mg ig"><em class="mo">@property </em></strong><em class="mo">string company_name<br/> */<br/></em><strong class="mg ig">class </strong>Company <strong class="mg ig">extends </strong>Model {<br/>    <br/>    <strong class="mg ig">use</strong> TenantConnector;<br/>       <br/>    <strong class="mg ig">protected </strong>$connection = 'main';</span><span id="4b9a" class="ln kl if mg b fv mp ml l mm mn">    <em class="mo">/**<br/>     * </em><strong class="mg ig"><em class="mo">@return </em></strong><em class="mo">$this<br/>     */<br/>    </em><strong class="mg ig">public function </strong>connect() {<br/>        $this-&gt;reconnect($this);<br/>        <strong class="mg ig">return </strong>$this;<br/>    }<br/>    <br/>}</span></pre><p id="1b99" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">租户模型将只连接到<strong class="je ig">租户</strong>数据库设置。</p><pre class="mb mc md me fq mf mg mh mi aw mj dt"><span id="5a07" class="ln kl if mg b fv mk ml l mm mn"><strong class="mg ig">&lt;?php<br/><br/>namespace </strong>App\Models\Tenant;<br/><br/><strong class="mg ig">use </strong>Illuminate\Database\Eloquent\Model;</span><span id="3a17" class="ln kl if mg b fv mp ml l mm mn"><strong class="mg ig">class </strong>MailQueue <strong class="mg ig">extends </strong>Model {<br/><br/>   <strong class="mg ig">protected </strong>$connection = 'tenant';</span><span id="9031" class="ln kl if mg b fv mp ml l mm mn">}</span></pre><p id="0e81" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最后是一个<strong class="je ig"> SelectTenantController </strong>，允许您设置中间件期望的会话。</p><pre class="mb mc md me fq mf mg mh mi aw mj dt"><span id="f623" class="ln kl if mg b fv mk ml l mm mn"><em class="mo">/**<br/> * </em><strong class="mg ig"><em class="mo">@GET<br/> </em></strong><em class="mo">* </em><strong class="mg ig"><em class="mo">@param </em></strong><em class="mo">Request $request<br/> * </em><strong class="mg ig"><em class="mo">@param </em></strong><em class="mo">$company<br/> * </em><strong class="mg ig"><em class="mo">@return </em></strong><em class="mo">\Illuminate\Http\RedirectResponse|\Illuminate\Routing\Redirector<br/> */<br/></em><strong class="mg ig">public function </strong>select(Request $request, $company) {<br/>   $this-&gt;reconnect($this-&gt;company-&gt;findOrFail($company)); <em class="mo"><br/>   </em>$request-&gt;session()-&gt;put('tenant', $company);<br/>   <strong class="mg ig">return </strong>redirect('/');<br/>}</span></pre><h1 id="0a7f" class="kk kl if bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">结论</h1><p id="f9ad" class="pw-post-body-paragraph jc jd if je b jf li jh ji jj lj jl jm jn lk jp jq jr ll jt ju jv lm jx jy jz hn dt translated">Laravel会让你轻松拥有2个连接设置。将连接到特定数据库的路由可以很容易地使用中间件来确保连接存在。您可以轻松地为每个模型选择连接(或者拥有一个MainModel / TenantModel并扩展它们)。万事俱备，您已经得到了一个能够连接多个数据库的Laravel应用程序。</p><p id="de6d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我应该很快会写一篇关于租户自动化测试和租户基于令牌的路由的后续文章。</p><div class="mb mc md me fq ab cb"><figure class="mq hw mr ms mt mu mv paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mq hw mr ms mt mu mv paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mq hw mr ms mt mu mv paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mw mx my"><p id="f922" class="jc jd mo je b jf jg jh ji jj jk jl jm mz jo jp jq na js jt ju nb jw jx jy jz hn dt translated"><a class="ae kj" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae kj" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae kj" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae kj" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jc jd mo je b jf jg jh ji jj jk jl jm mz jo jp jq na js jt ju nb jw jx jy jz hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kj" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kj" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="mb mc md me fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nc"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>