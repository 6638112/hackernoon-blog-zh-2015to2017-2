<html>
<head>
<title>Automate Your Home Theater Lights From The Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从云中自动化您的家庭影院灯光</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/automate-your-home-theater-lights-from-the-cloud-cdb29a8685a6?source=collection_archive---------4-----------------------#2017-05-02">https://medium.com/hackernoon/automate-your-home-theater-lights-from-the-cloud-cdb29a8685a6?source=collection_archive---------4-----------------------#2017-05-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="107a" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">使用AWS API网关和Lambda将Plex媒体服务器连接到色调照明系统</h2></div><p id="8d8e" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这个周末，我开始用我安装在地下室家庭影院里的菲利普斯色调灯做一些很酷的事情。目标:<strong class="jl hv">当我播放电影时，自动将灯光调至“影院模式”。</strong></p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div class="fe ff kg"><img src="../Images/ef152f087d4277528ab9ff079c02d13e.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*gR6T5qGYcabbctEySXgNeA.gif"/></div></figure><h1 id="31ee" class="ko kp hu bd kq kr ks kt ku kv kw kx ky ja kz jb la jd lb je lc jg ld jh le lf dt translated">设置</h1><p id="e258" class="pw-post-body-paragraph jj jk hu jl b jm lg iv jo jp lh iy jr js li ju jv jw lj jy jz ka lk kc kd ke hn dt translated">我住在芝加哥的一套错层公寓里，有一个完工的地下室区域，我把它用作家庭影院。去年10月，我在地下室安装了<a class="ae kf" href="https://www.amazon.com/Philips-432690-Equivalent-Single-Light/dp/B00HNLQQ7K" rel="noopener ugc nofollow" target="_blank"> 6色色调罐灯</a>、一个<a class="ae kf" href="https://www.amazon.com/Philips-Bloom-Works-Amazon-Alexa/dp/B00I12YFP0" rel="noopener ugc nofollow" target="_blank">色调开花</a>和一个<a class="ae kf" href="https://www.amazon.com/Philips-Lightstrip-Generation-Works-Amazon/dp/B014H2OXYU/ref=pd_sim_60_3?_encoding=UTF8&amp;pd_rd_i=B014H2OXYU&amp;pd_rd_r=QJMSJY8Q5NMEMEK5P964&amp;pd_rd_w=ZXNkp&amp;pd_rd_wg=Y4e6J&amp;psc=1&amp;refRID=QJMSJY8Q5NMEMEK5P964" rel="noopener ugc nofollow" target="_blank">色调led灯</a>，我可以用我的iPhone或亚马逊Echo Dot来控制它们。我设置了几个色调照明“场景”,以便我可以轻松地改变地下室灯光的亮度和颜色，包括一个“剧院模式”,它可以关闭除了作为电视柜背后背光的LED灯以外的所有灯光。</p><p id="4c8e" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">对于电影流媒体，我办公室里有一台运行<a class="ae kf" href="https://www.plex.tv/" rel="noopener ugc nofollow" target="_blank"> Plex媒体服务器</a>的电脑，我用它向本地网络内外的各种设备传输流媒体。我还有一台苹果电视，连接在地下室的电视上，安装了<a class="ae kf" href="https://www.plex.tv/apps/streaming-devices/apple-tv/" rel="noopener ugc nofollow" target="_blank"> Plex应用</a>。</p><p id="4bdb" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这种设置已经很好地工作了一段时间，我特别喜欢我可以告诉Alexa打开/关闭灯，甚至不用离开沙发，但我觉得我们可以更懒。</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div class="fe ff ll"><img src="../Images/ff28ee642183399f3b3213edda30ee4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/1*2tKZzeWgi_vCUrcFdiU4zA.gif"/></div></figure><blockquote class="lm"><p id="5fd8" class="ln lo hu bd lp lq lr ls lt lu lv ke ek translated">"如果需要是发明之母，那么懒惰就是发明之父."</p></blockquote><h1 id="7b20" class="ko kp hu bd kq kr ks kt ku kv kw kx ky ja lw jb la jd lx je lc jg ly jh le lf dt translated">这个计划</h1><p id="7b6a" class="pw-post-body-paragraph jj jk hu jl b jm lg iv jo jp lh iy jr js li ju jv jw lj jy jz ka lk kc kd ke hn dt translated">我想要一种方法，让灯光在播放电影时自动进入影院模式(关灯)，然后在电影结束时或者在我暂停使用浴室或制作更多爆米花时返回调光模式(开灯)。(未来，爆米花将从云端自动送达。)</p><p id="9cc8" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">Plex最近为几个事件添加了webhooks ，包括播放/暂停。Hue lights的销售总是考虑到业余程序员，并且包括一个<a class="ae kf" href="https://developers.meethue.com/" rel="noopener ugc nofollow" target="_blank">健壮的API </a>(尽管它可以好得多——稍后会详细介绍)。有了这两个端点，我所要做的就是让它们互相交流。</p><p id="9de0" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">鉴于我的网络上已经有一个服务器来托管Plex，在Node.js上快速启动一个Express服务器将webhook事件转发到我的Hue lighting hub是有意义的，但baremetal服务器是2015年的事情了。不，这个项目听起来像是一个在AWS云中实现无服务器的好机会！</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff lz"><img src="../Images/2533eec56b9f89cc7c1869e705241fad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7y4y6m3W4FAVsqbQseFsqQ.png"/></div></div><figcaption class="me mf fg fe ff mg mh bd b be z ek">Data flow diagram: Plex Webhook → AWS API Gateway → AWS Lambda → Hue Lights</figcaption></figure><p id="93f9" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">声明:我是AWS新手。如果我的任何配置可以改进，请给我发消息！</p><h1 id="628a" class="ko kp hu bd kq kr ks kt ku kv kw kx ky ja kz jb la jd lb je lc jg ld jh le lf dt translated">设置Lambda函数</h1><p id="d91e" class="pw-post-body-paragraph jj jk hu jl b jm lg iv jo jp lh iy jr js li ju jv jw lj jy jz ka lk kc kd ke hn dt translated">为了让Plex服务器与色调灯对话，我们需要实现少量的webhook解析逻辑——这对于<a class="ae kf" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>来说是一项完美的工作。对于外行来说，Lambda函数基本上是云中的一个函数。它们非常适合构建微服务，或者在这种情况下，连接API。</p><p id="0b8a" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">本质上，我们将构建一个“If This Then That”风格的函数，其逻辑如下:</p><ul class=""><li id="cb7c" class="mi mj hu jl b jm jn jp jq js mk jw ml ka mm ke mn mo mp mq dt translated">📺如果操作是由“我的AppleTV”触发的，请检查Plex webhook有效负载。</li><li id="5ac4" class="mi mj hu jl b jm mr jp ms js mt jw mu ka mv ke mn mo mp mq dt translated">📽如果触发的动作来自电影，请检查Plex webhook有效负载。</li><li id="c76d" class="mi mj hu jl b jm mr jp ms js mt jw mu ka mv ke mn mo mp mq dt translated">🌑如果Plex事件正在播放或继续，则将色调灯设置为剧场模式。</li><li id="b8a1" class="mi mj hu jl b jm mr jp ms js mt jw mu ka mv ke mn mo mp mq dt translated">🌕如果Plex事件是暂停或停止，则将色调灯设置为变暗模式。</li></ul><p id="1592" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">首先，我们需要创建一个新的Lambda。我们可以从AWS仪表板上完成这项工作，但是我更喜欢使用NPM包<a class="ae kf" href="https://github.com/motdotla/node-lambda" rel="noopener ugc nofollow" target="_blank"> node-lambda </a>进行配置、部署和测试。你可以在GitHub上看到我的Lambda函数的完整源代码。</p><p id="a2f5" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我不会详细介绍如何设置一个新的Lambda函数，除此之外，我们还需要提供<code class="eh mw mx my mz b">lambda-access</code>角色，以便稍后可以连接到我们的API网关。Lambda还(最终)支持Node v6.10，我们将使用它作为我们的执行环境。一旦我们的Lambda配置好了，我们就可以设置API网关了。</p><h1 id="aaba" class="ko kp hu bd kq kr ks kt ku kv kw kx ky ja kz jb la jd lb je lc jg ld jh le lf dt translated">配置API网关</h1><p id="9458" class="pw-post-body-paragraph jj jk hu jl b jm lg iv jo jp lh iy jr js li ju jv jw lj jy jz ka lk kc kd ke hn dt translated"><a class="ae kf" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank"> AWS API Gateway </a>是我们用来将Plex webhook连接到Lambda函数的接口。API Gateway支持高度复杂的API架构，但是对于我们的目的，我们只需要一个POST端点，它将转发到Lambda函数。</p><p id="2a95" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在我们创建了一个新的API之后，我们将在<code class="eh mw mx my mz b">/</code>创建一个POST资源来处理我们的webhook请求。接下来，我们将配置POST资源的集成请求，如下所示:</p><ul class=""><li id="ca0a" class="mi mj hu jl b jm jn jp jq js mk jw ml ka mm ke mn mo mp mq dt translated">集成类型:λ函数</li><li id="457a" class="mi mj hu jl b jm mr jp ms js mt jw mu ka mv ke mn mo mp mq dt translated">λ区域:我们的λ函数的区域</li><li id="e47b" class="mi mj hu jl b jm mr jp ms js mt jw mu ka mv ke mn mo mp mq dt translated">Lambda函数:Lambda函数的名称</li></ul><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff na"><img src="../Images/bd263533d21cec2afb8c14b72690fb64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HwZboBrfqyBw-oF6U0sYnw.png"/></div></div></figure><p id="1679" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">Plex webhook不提供Lambda函数所需的<code class="eh mw mx my mz b">application/json</code>内容类型的有效负载，所以我们需要将请求转换成Lambda友好的格式。因为没有办法在API Gateway中解析来自Plex webhook的多部分表单数据，所以我们只是将它作为Base64编码的二进制文件传递，然后在我们的Lambda函数中解构它。</p><p id="9558" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们需要<a class="ae kf" href="https://aws.amazon.com/about-aws/whats-new/2016/11/binary-data-now-supported-by-api-gateway/" rel="noopener ugc nofollow" target="_blank">在我们的API上启用二进制支持</a>,并添加二进制媒体类型<code class="eh mw mx my mz b">multipart/form-data</code>,这样API Gateway就不会试图从我们的webhook解析JSON。然后，回到POST资源的集成请求选项卡，我们需要为<code class="eh mw mx my mz b">multipart/form-data</code>内容类型添加以下主体映射模板:</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff nb"><img src="../Images/41598a9c073551b6d586d87bfc278347.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8bRffLupedapAe4741XdPw.png"/></div></div></figure><pre class="kh ki kj kk fq nc mz nd ne aw nf dt"><span id="2dc0" class="ng kp hu mz b fv nh ni l nj nk">{<br/>  "body": "$input.body",<br/>  "headers": {<br/>    #foreach($param in $input.params().header.keySet())<br/>      "$param":<br/>        "$util.escapeJavaScript($input.params().header.get($param))"<br/>      #if($foreach.hasNext),#end<br/>    #end<br/>  }<br/>}</span></pre><blockquote class="nl nm nn"><p id="2a81" class="jj jk no jl b jm jn iv jo jp jq iy jr np jt ju jv nq jx jy jz nr kb kc kd ke hn dt translated">API Gateway使用Apache的<a class="ae kf" href="http://velocity.apache.org/engine/devel/vtl-reference.html" rel="noopener ugc nofollow" target="_blank"> Velocity模板语言(VTL) </a>作为身体映射模板</p></blockquote><p id="533d" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这将在<code class="eh mw mx my mz b">body</code>中包装我们的原始编码请求，并在<code class="eh mw mx my mz b">headers</code>中转发来自Plex webhook的所有头。以上是API Gateway所需的所有配置，我们现在可以单击Actions → Deploy API。创建新的部署阶段，然后单击部署。如果成功，您将进入刚刚创建并部署到的阶段的阶段编辑器。将调用URL复制到帐户设置下的<a class="ae kf" href="https://support.plex.tv/hc/en-us/articles/115002267687-Webhooks" rel="noopener ugc nofollow" target="_blank">新Plex webhook。</a></p><h1 id="71ef" class="ko kp hu bd kq kr ks kt ku kv kw kx ky ja kz jb la jd lb je lc jg ld jh le lf dt translated">在Lambda中解包有效负载</h1><p id="aa3b" class="pw-post-body-paragraph jj jk hu jl b jm lg iv jo jp lh iy jr js li ju jv jw lj jy jz ka lk kc kd ke hn dt translated">我们的Lambda函数公开了一个<code class="eh mw mx my mz b">handler</code>，我们的API网关将使用转发的Plex webhook作为<code class="eh mw mx my mz b">event</code>参数来调用它。我们需要解包事件体，它将是一个多部分的形式，然后解析它以获得有效负载JSON。为此，我们将使用一个名为<a class="ae kf" href="https://github.com/mscdex/busboy" rel="noopener ugc nofollow" target="_blank">的NPM包。</a></p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div class="fe ff ns"><img src="../Images/abb5f0fdf251a2d541787679183d8091.png" data-original-src="https://miro.medium.com/v2/resize:fit:454/1*nwtScI_Fd9vhOOb6hRBbkg.gif"/></div><figcaption class="me mf fg fe ff mg mh bd b be z ek">Busboy loves parsing your multipart form data as much as this one loves bussing tables.</figcaption></figure><p id="56f9" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">Busboy是一个低级可写流，被Multer等几个Express中间件用来解析多部分表单数据。用法很简单——我们只需将头传递给Busboy初始化器，然后用管道传递Base64编码的主体。然后，Busboy将为它遇到的每个表单域触发事件。下面是我们的处理程序代码:</p><pre class="kh ki kj kk fq nc mz nd ne aw nf dt"><span id="4d58" class="ng kp hu mz b fv nh ni l nj nk"><em class="no">const</em> Busboy = require('busboy');</span><span id="82a4" class="ng kp hu mz b fv nt ni l nj nk"><em class="no">exports</em>.handler = (<em class="no">event</em>, <em class="no">context</em>, <em class="no">callback</em>) <em class="no">=&gt;</em> {<br/>  // Busboy expects headers to be lower-case<br/>  <em class="no">const</em> headers = {};<br/>  <em class="no">Object</em>.keys(event.headers).forEach(<br/>    <em class="no">key</em> <em class="no">=&gt;</em> (headers[key.toLowerCase()] = event.headers[key])<br/>  );</span><span id="0d2b" class="ng kp hu mz b fv nt ni l nj nk"><em class="no">  const</em> busboy = new Busboy({<br/>    headers<br/>  });</span><span id="cd43" class="ng kp hu mz b fv nt ni l nj nk">  // For each field in the request<br/>  busboy.on('field', (<em class="no">fieldname</em>, <em class="no">value</em>) <em class="no">=&gt;</em> {<br/>    // Check for the Plex webhook's payload field<br/>    if (fieldname === 'payload') {<br/>      <em class="no">const</em> payload = JSON.parse(value);</span><span id="5838" class="ng kp hu mz b fv nt ni l nj nk">      // Read the payload to control Hue lights<br/>      readPayload(payload);<br/>      <br/>      // Send payload in response for testing &amp; debugging<br/>      callback(null, {<br/>        payload<br/>      });<br/>    }<br/>  });</span><span id="02ef" class="ng kp hu mz b fv nt ni l nj nk">  // Pipe Base64 encoded body from API Gateway to Busboy<br/>  busboy.write(<em class="no">Buffer</em>.from(event.body, 'base64'));<br/>};</span></pre><p id="3e63" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><code class="eh mw mx my mz b">readPayload()</code>函数将包含我们连接到Hue的逻辑，但是您可以使用这个处理程序代码作为将Plex webhook连接到任何外部服务的样板。</p><p id="2b4c" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们现在可以通过创建一个模拟<code class="eh mw mx my mz b">event.json</code>来测试我们的事件处理程序，如果你正在使用<code class="eh mw mx my mz b">node-lambda</code>，或者你可以<code class="eh mw mx my mz b">console.log()</code>到AWS CloudWatch日志。</p><h1 id="2f6c" class="ko kp hu bd kq kr ks kt ku kv kw kx ky ja kz jb la jd lb je lc jg ld jh le lf dt translated">用Lambda控制色调灯</h1><p id="29de" class="pw-post-body-paragraph jj jk hu jl b jm lg iv jo jp lh iy jr js li ju jv jw lj jy jz ka lk kc kd ke hn dt translated">有了正确JSON格式的Plex webhook有效负载，我们就可以与色调灯对话了，但首先我们需要为色调API准备Lambda。我们将为我们需要的各种色调id添加一些环境变量，并执行一个相当简单的身份验证，从本地网络外部的Lambda函数连接到我们的色调桥。</p><p id="9c67" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">Phillips提供了一个相当健壮的RESTful API，用于从同一个本地网络中控制色调照明系统的大多数方面，但是没有提供任何用于从互联网控制灯光的文档，尽管这是可能的。Paul Shi写了一篇关于如何从Hue Bridge本地网络之外“侵入”该网络的精彩博文。使用保罗指南获得<code class="eh mw mx my mz b">BRIDGEID</code>和<code class="eh mw mx my mz b">ACCESSTOKEN</code>。</p><p id="637d" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们将把<code class="eh mw mx my mz b">BRIDGEID</code>和<code class="eh mw mx my mz b">ACCESSTOKEN</code>作为环境变量存储在我们的Lambda中，还有其他几个变量:</p><ul class=""><li id="677c" class="mi mj hu jl b jm jn jp jq js mk jw ml ka mm ke mn mo mp mq dt translated"><code class="eh mw mx my mz b">HUE_TOKEN</code> : <code class="eh mw mx my mz b">ACCESSTOKEN</code></li><li id="c2a3" class="mi mj hu jl b jm mr jp ms js mt jw mu ka mv ke mn mo mp mq dt translated"><code class="eh mw mx my mz b">HUE_BRIDGE_ID</code> : <code class="eh mw mx my mz b">BRIDGEID</code></li><li id="22b1" class="mi mj hu jl b jm mr jp ms js mt jw mu ka mv ke mn mo mp mq dt translated"><code class="eh mw mx my mz b">HUE_SCENE_THEATER</code>:我们剧院场景的场景ID</li><li id="cf2a" class="mi mj hu jl b jm mr jp ms js mt jw mu ka mv ke mn mo mp mq dt translated"><code class="eh mw mx my mz b">HUE_SCENE_DIMMED</code>:调暗场景的场景ID</li><li id="212f" class="mi mj hu jl b jm mr jp ms js mt jw mu ka mv ke mn mo mp mq dt translated"><code class="eh mw mx my mz b">HUE_GROUP_ID</code>:包含我们灯光的组的组ID</li><li id="0d51" class="mi mj hu jl b jm mr jp ms js mt jw mu ka mv ke mn mo mp mq dt translated"><code class="eh mw mx my mz b">PLAYER_UUID</code>:来自Plex webhook的AppleTV设备的UUID</li></ul><p id="b0f6" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您可以通过发出一个<code class="eh mw mx my mz b">GET <a class="ae kf" href="https://www.meethue.com/api/getbridge" rel="noopener ugc nofollow" target="_blank">https://www.meethue.com/api/getbridge</a></code>请求来找到场景ID和组ID，如Paul的博客帖子中所解释的。</p><p id="347a" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们的<code class="eh mw mx my mz b">readPayload()</code>函数将对有效负载执行检查，看看应该向Hue API发送什么动作(如果有的话),然后构造并发送适当的请求:</p><pre class="kh ki kj kk fq nc mz nd ne aw nf dt"><span id="dc95" class="ng kp hu mz b fv nh ni l nj nk"><em class="no">const</em> https = require('https');</span><span id="0802" class="ng kp hu mz b fv nt ni l nj nk"><em class="no">const</em> readPayload = <em class="no">payload</em> <em class="no">=&gt;</em> {<br/>  // Plex webhook event constants<br/>  <em class="no">const</em> PLAY = 'media.play';<br/>  <em class="no">const</em> PAUSE = 'media.pause';<br/>  <em class="no">const</em> RESUME = 'media.resume';<br/>  <em class="no">const</em> STOP = 'media.stop';</span><span id="af35" class="ng kp hu mz b fv nt ni l nj nk"><em class="no">  const</em> { event, Player, Metadata } = payload;</span><span id="46dc" class="ng kp hu mz b fv nt ni l nj nk">  // https options<br/>  <em class="no">const</em> options = {<br/>    hostname: 'www.meethue.com',<br/>    path: `/api/sendmessage?token=${process.env.HUE_TOKEN}`,<br/>    method: 'POST',<br/>    headers: {<br/>      'Content-Type': 'application/x-www-form-urlencoded'<br/>    }<br/>  };</span><span id="c168" class="ng kp hu mz b fv nt ni l nj nk">  if (<br/>    process.env.PLAYER_UUID === Player.uuid &amp;&amp;  // Event came from the correct player<br/>    Metadata.type === 'movie' &amp;&amp;  // Event type is from a movie<br/>    (event === PLAY || event === STOP || event === PAUSE || event === RESUME) // Event is a valid type<br/>  ) {<br/>    <em class="no">const</em> scene = event === PLAY || event === RESUME<br/>      ? process.env.HUE_SCENE_THEATER // Turn the lights off because it's playing<br/>      : process.env.HUE_SCENE_DIMMED; // Turn the lights on because it's not playing</span><span id="6b37" class="ng kp hu mz b fv nt ni l nj nk">    // Construct Hue API body<br/>    <em class="no">const</em> body = `clipmessage={ bridgeId: "${process.env.HUE_BRIDGE_ID}", clipCommand: { url: "/api/0/groups/${process.env.HUE_GROUP_ID}/action", method: "PUT", body: { scene: "${scene}" } } }`;</span><span id="541d" class="ng kp hu mz b fv nt ni l nj nk">    // Send request to Hue API<br/>    <em class="no">const</em> req = https.request(options);<br/>    req.write(body);</span><span id="eff3" class="ng kp hu mz b fv nt ni l nj nk">    req.end();<br/>  }<br/>};</span></pre><p id="b28a" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">就是这样！现在，当电影开始在AppleTV上播放时，灯光将进入影院模式，当电影暂停或停止时，灯光将恢复为暗淡模式。</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div class="fe ff nu"><img src="../Images/f4127e88e1e34134308ddfa0b6fc9124.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/1*6rvCih3a3ICvErq2J__uGA.gif"/></div></figure><div class="kh ki kj kk fq ab cb"><figure class="nv kl nw nx ny nz oa paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="nv kl nw nx ny nz oa paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="nv kl nw nx ny nz oa paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="nl nm nn"><p id="f922" class="jj jk no jl b jm jn iv jo jp jq iy jr np jt ju jv nq jx jy jz nr kb kc kd ke hn dt translated"><a class="ae kf" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae kf" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae kf" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae kf" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jj jk no jl b jm jn iv jo jp jq iy jr np jt ju jv nq jx jy jz nr kb kc kd ke hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kf" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kf" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="fe ff ob"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>