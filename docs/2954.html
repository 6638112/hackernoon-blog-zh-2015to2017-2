<html>
<head>
<title>Debugging a PHP application with strace</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用strace调试PHP应用程序</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/debugging-a-php-application-with-strace-4d0ae59f880b?source=collection_archive---------6-----------------------#2017-03-02">https://medium.com/hackernoon/debugging-a-php-application-with-strace-4d0ae59f880b?source=collection_archive---------6-----------------------#2017-03-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="9814" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每隔一段时间，你就会遇到一个棘手的bug，当它出现时，你可能会损失几个小时甚至几天来修复它。</p><p id="ef5b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">bug应该是软件开发过程的一部分，我多年来学到的是，当你真正适应你的开发环境(语言、框架、部署类型等)时，花在解决bug上的时间是非常有限的，因为你在你的舒适区内工作(<a class="ae jp" href="https://hackernoon.com/tagged/technology-wise" rel="noopener ugc nofollow" target="_blank">技术方面的</a>)。</p><p id="3b02" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，有时有一个bug会让你在花了一整个下午寻找根本原因后失去理智。以我的经验来看，我引入的bug通常很容易被发现和修复。但是真正的挑战是在其他人的代码中发现错误，比如第三方库、PHP扩展甚至PHP本身。</p><p id="7850" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当奇怪的事情发生时，仪式每次都是一样的:启动PHPStorm上的调试器，放置几个断点，然后看看会发生什么。</p><p id="f435" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不过，昨天情况有所不同。</p><p id="8c73" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在对代码库做了一些修改并在浏览器上重新加载页面后，我开始直接收到HTTP 500错误，奇怪的是Zen框架的错误/异常处理程序没有捕捉到这些错误，apache错误日志也没有包含任何错误。</p><p id="1eca" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">看起来阿帕奇可能会崩溃，让我们看看。</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="e913" class="jz ka hu jv b fv kb kc l kd ke">$ sudo less /var/log/syslog<br/>...<br/>Mar  1 15:59:15 redokunvm kernel: [593714.307281] Out of memory: Kill process 30901 (apache2) score 639 or sacrifice child<br/>Mar  1 15:59:15 redokunvm kernel: [593714.308664] Killed process 30901 (apache2) total-vm:2707492kB, anon-rss:1852200kB, file-rss:8024kB<br/>...</span></pre><p id="d249" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">是的，内存不足错误，即使请求执行的操作根本不占用内存。然而，通过<code class="eh kf kg kh jv b"> ini_set</code>施加的内存限制应该已经抓住了这一点。除非它发生在PHP核心或它的某个扩展上。</p><p id="2429" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这些情况下，您有几个选择，例如:</p><ul class=""><li id="e21c" class="ki kj hu it b iu iv iy iz jc kk jg kl jk km jo kn ko kp kq dt translated">在每个步骤中添加日志条目，并尝试找出导致内存泄漏的原因</li><li id="0a75" class="ki kj hu it b iu kr iy ks jc kt jg ku jk kv jo kn ko kp kq dt translated">打开调试器，添加几个断点，看看会发生什么</li></ul><p id="a1d0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">查看应用程序日志可以清楚地看到，问题是在将原则实体保存到数据库时产生的。但是调试教条需要相当长的时间，所以我决定尝试另一种方法。</p><h2 id="850d" class="jz ka hu bd kw kx ky kz la lb lc ld le jc lf lg lh jg li lj lk jk ll lm ln lo dt translated">遇见斯特拉思</h2><p id="8696" class="pw-post-body-paragraph ir is hu it b iu lp iw ix iy lq ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated"><a class="ae jp" href="https://linux.die.net/man/1/strace" rel="noopener ugc nofollow" target="_blank"> strace </a>是一个调试工具，分析某个进程对内核的所有系统调用。这对于我来说非常方便，因为我可以看到当出现问题时PHP应用程序到底在做什么。</p><p id="7cd3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以让我们启动strace并监控所有的apache孩子:</p><p id="9697" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh kf kg kh jv b">$ ps h --ppid $(cat /var/run/apache2/apache2.pid) | awk '{print"-p " $1}' | xargs sudo strace -o strace.txt</code></p><p id="256e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">再次加载网页后，我查看了strace.txt，发现了这个:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="4d24" class="jz ka hu jv b fv kb kc l kd ke">open("/mnt/hgfs/php/redokun/vendor/doctrine/dbal/lib/Doctrine/DBAL/Driver/PDOException.php", O_RDONLY) = 25<br/>...<br/>open("/mnt/hgfs/php/redokun/vendor/doctrine/dbal/lib/Doctrine/DBAL/Driver/DriverException.php", O_RDONLY) = 25<br/>...<br/>mremap(0x7f4b8b111000, 188416, 192512, MREMAP_MAYMOVE) = 0x7f4b8b0e2000<br/>mremap(0x7f4b8b0e2000, 192512, 196608, MREMAP_MAYMOVE) = 0x7f4b8b0e2000<br/>mremap(0x7f4b8b0e2000, 196608, 200704, MREMAP_MAYMOVE) = 0x7f4b8b0e2000</span><span id="c6ea" class="jz ka hu jv b fv lu kc l kd ke">(mremap was called thousand of times without stopping)</span></pre><p id="7221" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">很明显，mremap系统调用分配了越来越多的内存，直到进程被内核终止。</p><p id="086c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以查看最近的系统调用，泄漏似乎与之前自动加载的<code class="eh kf kg kh jv b">PDOException</code>异常有关(还有<code class="eh kf kg kh jv b">DriverException</code>，它是异常实现的一个接口)。</p><p id="b24c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在PDOException.php内部设置了几个断点后，我意识到这个异常确实是由原则准备并抛出的，但是它从未在包含try/catch的<code class="eh kf kg kh jv b">Doctrine\DBAL\Statement::execute()</code>方法中被捕获。</p><p id="9fb9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因为这显然与扩展或PHP本身有关，所以我尝试禁用扩展。最有可能的原因是XDebug，我确信它有某种钩子，当一个异常被创建或抛出时就会被触发。</p><p id="89c0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">果然，在禁用XDebug之后，我终于可以看到异常并修复它了。</p><p id="7e11" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">经过进一步挖掘，我发现这不是XDebug内部的一个错误，而是一个导致XDebug崩溃的错误配置。</p><p id="46d4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是我不得不在我的应用程序中删除的一行代码，它显然产生了内存泄漏:<code class="eh kf kg kh jv b">ini_set("xdebug.var_display_max_data", "-1");</code></p><p id="6c79" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用strace调试PHP应用程序可能看起来像是一种极端的措施，但是考虑到它的易用性，它绝对可以成为在寻找像这样的令人讨厌的错误时使用的<a class="ae jp" href="https://hackernoon.com/tagged/tools" rel="noopener ugc nofollow" target="_blank">工具之一。</a></p><blockquote class="lv lw lx"><p id="973c" class="ir is ly it b iu iv iw ix iy iz ja jb lz jd je jf ma jh ji jj mb jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="dca4" class="ir is ly it b iu iv iw ix iy iz ja jb lz jd je jf ma jh ji jj mb jl jm jn jo hn dt translated">要了解更多信息，请<a class="ae jp" href="https://goo.gl/4ofytp" rel="noopener ugc nofollow" target="_blank">阅读我们的“关于”页面</a>、<a class="ae jp" href="http://bit.ly/HackernoonFB" rel="noopener ugc nofollow" target="_blank">在脸书上给我们点赞/发消息</a>，或者简单地说，<a class="ae jp" href="https://goo.gl/k7XYbx" rel="noopener ugc nofollow" target="_blank"> tweet/DM @HackerNoon。</a></p><p id="708a" class="ir is ly it b iu iv iw ix iy iz ja jb lz jd je jf ma jh ji jj mb jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jq jr js jt fq mc"><div class="bz el l di"><div class="md me l"/></div></figure></div></div>    
</body>
</html>