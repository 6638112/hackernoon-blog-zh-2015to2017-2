<html>
<head>
<title>A Little Hashicorp Vault introduction:</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">小小哈希公司金库游戏攻略:</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/a-little-hashicorp-vault-introduction-d28382487b9f?source=collection_archive---------2-----------------------#2016-09-29">https://medium.com/hackernoon/a-little-hashicorp-vault-introduction-d28382487b9f?source=collection_archive---------2-----------------------#2016-09-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><h1 id="f1e3" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated"><strong class="ak">基础知识:</strong></h1><p id="27a7" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">这将是对哈希公司金库的介绍(为了简单起见(<strong class="jr hv">不要把它与Ansible金库或任何其他金库</strong>)从现在起<strong class="jr hv">我将开始称之为金库</strong>)</p><p id="5ec2" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">Vault是一个<strong class="jr hv"> Go </strong>应用程序，带有一个<strong class="jr hv"> Rest/Cli </strong>接口，可以用来存储秘密，非常简单。</p><p id="4911" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">Vault将存储这个信息<strong class="jr hv">加密</strong>(GCM上的256AES)，但是我们将在后面讨论这个</p><p id="a065" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">秘密是你通常戴上的东西。<strong class="jr hv">git忽略</strong>或<strong class="jr hv"> hiera-pgp </strong>或<strong class="jr hv"> Ansible Vault </strong>，因为显而易见的原因你不想提交到源代码控制的东西。</p><p id="ede2" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">因此，最简单的说法是，您将东西写入Vault，Vault将对其进行加密，并保存在那里供您检索。</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="fe ff ks"><img src="../Images/e730f5c5f1d88b38da27364585b23195.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y9EqlVZooHkXoyWDycbHAQ.png"/></div></div><figcaption class="le lf fg fe ff lg lh bd b be z ek">The idea of Vault</figcaption></figure><h1 id="c89b" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">谁能看到我的东西？：</h1><p id="1f42" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">金库使用一个<strong class="jr hv">令牌</strong>让你可以看到里面的信息，令牌可以根据需要<strong class="jr hv">创建</strong>和<strong class="jr hv">撤销</strong>。也可以将它们设置为在给定时间后<strong class="jr hv">到期</strong>。</p><p id="46d0" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">例如，如果您需要在一个小时内授予对vault中某些信息的访问权限(因为有些内容被转储到prod中)，您可以授予他们一个大约一个小时的令牌(或者在他们确认更改完成后撤销令牌)</p><p id="2273" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">这是一个如何工作的愚蠢的图表，但显然它可以全部自动化:</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="fe ff li"><img src="../Images/98f7afdd1ee9cc5e3ce57cc6a5cc3c0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q_Q5pFjZkSE7NJuD3F1kEw.png"/></div></div><figcaption class="le lf fg fe ff lg lh bd b be z ek">Token creation and usage</figcaption></figure><p id="90c7" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated"><strong class="jr hv">动手:</strong></p><p id="5d2d" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">你应该在Go 1.7上，我对1.6有一些问题，特别是在地形部分，我们稍后会谈到</p><p id="1881" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">好了，让我们安装vault，并从中获得一些乐趣，正如你所知，像大多数Go项目一样，他们会发布预编译的二进制文件，这可能是最简单的方法，从官方网站(<a class="ae lj" href="https://www.vaultproject.io/downloads.html" rel="noopener ugc nofollow" target="_blank">https://www.vaultproject.io/downloads.html</a>)下载vault</p><p id="0de2" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">在zip文件中，您会发现一个具有魔力的二进制文件(不幸的是，vault没有提供initd脚本或类似的任何东西，但我相信google会解决这个问题)，Vault提供了一个开发模式供您测试，这就是我们现在要使用的，所以让我们启动一个开发服务器</p><pre class="kt ku kv kw fq lk ll lm ln aw lo dt"><span id="6e89" class="lp is hu ll b fv lq lr l ls lt">./vault server -dev</span></pre><p id="33f3" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">这样做之后，vault将创建一个<strong class="jr hv">内存中的</strong>后端(稍后将详细介绍后端),并且默认情况下，它将绑定<strong class="jr hv"> tcp:8200 </strong>,您也将获得一些输出，让我们看看:</p><pre class="kt ku kv kw fq lk ll lm ln aw lo dt"><span id="a37c" class="lp is hu ll b fv lq lr l ls lt">==&gt; Vault server configuration:</span><span id="7ae4" class="lp is hu ll b fv lu lr l ls lt"><strong class="ll hv"><em class="lv">Backend: inmem</em></strong><br/>              Listener 1: tcp (<strong class="ll hv"><em class="lv">addr: "127.0.0.1:8200"</em></strong>, cluster address: "", <strong class="ll hv">tls: "disabled"</strong>)<br/>               Log Level: info<br/>                   Mlock: supported: true, enabled: false<br/>                 Version: Vault v0.6.1</span><span id="d3c4" class="lp is hu ll b fv lu lr l ls lt">==&gt; <strong class="ll hv">WARNING: Dev mode is enabled!</strong></span><span id="728b" class="lp is hu ll b fv lu lr l ls lt">In this mode, Vault is completely in-memory and unsealed.<br/>Vault is configured to only have a single unseal key. The root<br/>token has already been authenticated with the CLI, so you can<br/>immediately begin using the Vault CLI.</span><span id="bac3" class="lp is hu ll b fv lu lr l ls lt">The only step you need to take is to set the following<br/>environment variables:</span><span id="81dc" class="lp is hu ll b fv lu lr l ls lt"><strong class="ll hv">export VAULT_ADDR='</strong><a class="ae lj" href="http://127.0.0.1:8200'" rel="noopener ugc nofollow" target="_blank"><strong class="ll hv">http://127.0.0.1:8200'</strong></a></span><span id="ed01" class="lp is hu ll b fv lu lr l ls lt">The unseal key and root token are reproduced below in case you<br/>want to seal/unseal the Vault or play with authentication.</span><span id="5bd2" class="lp is hu ll b fv lu lr l ls lt">Unseal Key (hex)   : b03efb974cbb9023213e550dcab35d0bdaa518b0fe412395917ab162df538811<br/>Unseal Key (base64): sD77l0y7kCMhPlUNyrNdC9qlGLD+QSOVkXqxYt9TiBE=<br/><strong class="ll hv">Root Token: b724183c-15bc-ffd4-1d53-824626348866</strong></span></pre><p id="5a55" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">好了，这是一个很大的输出，值得解释一下，按照发生的顺序:</p><ul class=""><li id="d81f" class="lw lx hu jr b js kn jw ko ka ly ke lz ki ma km mb mc md me dt translated">后端(告诉你-dev默认运行在内存中)</li><li id="c4cf" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">告诉您它绑定到的地址(127.0.0.1)和端口</li><li id="3bcd" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">告诉您TLS被禁用(对于开发模式)</li><li id="3115" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">告诉您导出<strong class="jr hv"> VAULT_ADDR </strong>，稍后当我们向它读取/写入数据时，它将被VAULT读取。</li><li id="ce97" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">根令牌，还记得我们上面提到的我们需要一个根令牌来创建其他令牌以便移交给运营人员吗？</li></ul><h1 id="4219" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">认证、写入、读取、状态、令牌:</h1><p id="f742" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">Vault现在正在运行，它没有被妖魔化，所以它将在前台运行，您可以看到所有输出。</p><p id="4368" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">向您的本地保管库验证:</p><pre class="kt ku kv kw fq lk ll lm ln aw lo dt"><span id="5b8f" class="lp is hu ll b fv lq lr l ls lt"><strong class="ll hv">$ VAULT_ADDR=</strong><a class="ae lj" href="http://localhost:8200" rel="noopener ugc nofollow" target="_blank"><strong class="ll hv">http://localhost:8200</strong></a><strong class="ll hv"> ./vault auth adb1e4e3-e7c0-387b-5ad8-0d92fd282951</strong><br/>Successfully authenticated! <strong class="ll hv">You are now logged in</strong>.<br/>token: adb1e4e3-e7c0-387b-5ad8-0d92fd282952<br/>token_duration: 0<br/>token_policies: [root]</span></pre><p id="f4ec" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">让我们向vault写些东西:</p><pre class="kt ku kv kw fq lk ll lm ln aw lo dt"><span id="2fad" class="lp is hu ll b fv lq lr l ls lt"><strong class="ll hv">VAULT_ADDR=</strong><a class="ae lj" href="http://localhost:8200" rel="noopener ugc nofollow" target="_blank"><strong class="ll hv">http://localhost:8200</strong></a> ./vault <strong class="ll hv">write secret </strong>secret=<strong class="ll hv">donttellanybody</strong></span></pre><p id="d34a" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">这很简单，基本上我告诉它要写并传递一个键值对，这样你以后就可以查找了:</p><pre class="kt ku kv kw fq lk ll lm ln aw lo dt"><span id="6710" class="lp is hu ll b fv lq lr l ls lt">$ <strong class="ll hv">VAULT_ADDR=</strong><a class="ae lj" href="http://localhost:8200" rel="noopener ugc nofollow" target="_blank"><strong class="ll hv">http://localhost:8200</strong></a><strong class="ll hv"> ./vault read secret</strong><br/>Key                     Value<br/>---                     -----<br/>refresh_interval        720h0m0s<br/>mysecret                <strong class="ll hv">donttellanybody</strong></span></pre><p id="0993" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">就是这样！我们已经编写了一个“安全地”存储在vault中的键/值对，并且我们能够检索它。</p><p id="d535" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">这是基本信息，还有很多关于Vault的信息需要阅读，但我不想让它变得太枯燥，但我想浏览一下:</p><p id="d131" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated"><strong class="jr hv">创建新令牌:</strong></p><p id="5758" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">这创建了一个没有过期时间和策略的基本令牌，稍后我们将看到更多相关内容:</p><pre class="kt ku kv kw fq lk ll lm ln aw lo dt"><span id="d0c4" class="lp is hu ll b fv lq lr l ls lt">$ VAULT_ADDR='<a class="ae lj" href="http://127.0.0.1:8200'" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8200'</a> ./vault <strong class="ll hv">token-create</strong><br/>Key             Value<br/>---             -----<br/>token           <strong class="ll hv">6d2aed6c-e2e0-733b-3b81-5c0e34eec0cd</strong><br/>token_accessor  96891866-e336-c6a6-a0c7-8d38861d5154<br/>token_duration  0s<br/>token_renewable false<br/>token_policies  [root]</span></pre><h2 id="a8dd" class="lp is hu bd it mk ml mm ix mn mo mp jb ka mq mr jf ke ms mt jj ki mu mv jn mw dt translated">后端:</h2><p id="48e6" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">Vault有一些后端(aws/ssh/inmem/etc ),作为模型(就mvc而言)或一些具有一些逻辑的虚拟文件系统。</p><p id="33f0" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">例如，AWS后端将按需创建IAM凭证，称为<strong class="jr hv">动态机密(</strong><a class="ae lj" href="https://www.vaultproject.io/intro/getting-started/dynamic-secrets.html" rel="noopener ugc nofollow" target="_blank">https://www . vault project . io/intro/getting-started/dynamic-secrets . html</a>)，并在需要时撤销它们。</p><p id="a2e3" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">这在使用自动化工具时非常有用，我们不想硬编码凭证，请看下面的示例场景:</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="fe ff mx"><img src="../Images/9bc806d554b157f36118d9499abe3a46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pwji2UQD6vVnp1Oe4ZLytQ.png"/></div></div><figcaption class="le lf fg fe ff lg lh bd b be z ek">the ops guy will have set of credentials for a given time , dynamically generated for him.</figcaption></figure><p id="5bd8" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated"><strong class="jr hv"> Rest Api: </strong></p><p id="6136" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">Vault的用处不大，因为它没有一个简单的方法来读取/写入信息，幸运的是，情况并非如此，让我们来看一点rest api。</p><p id="765b" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">它基本上与<strong class="jr hv"> GET/POST/DELETE </strong>一起工作，如果你曾经与JWT一起工作过，这将看起来很熟悉，我们一直在谈论的同一个令牌应该作为自定义头与请求一起传递，例如:</p><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="my mz l"/></div></figure><p id="ce3a" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">标题<strong class="jr hv"> X-Vault-Token </strong>在那里为你变魔术。</p><p id="2aad" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">显然，这打开了许多大门，这意味着你可以从ansible或puppet或terraform调用Vault，无论你在哪里都可以选择编写一个小插件来执行http/https调用。</p><h1 id="bcb9" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated"><strong class="ak">把东西钩在一起</strong></h1><p id="6eb6" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">既然我们已经有了<strong class="jr hv"> Vault </strong>明确运行<strong class="jr hv">(在开发模式下，别忘了你不能使用它)</strong>让我们试着模拟一下<strong class="jr hv"> Ansible </strong>和<strong class="jr hv"> Terraform </strong>如何连接到这个，显然我们将使用rest api连接到Vault，幸运的是两者(<strong class="jr hv"> Terraform </strong>和<strong class="jr hv"> Ansible </strong>)都为我们提供了一个插件框架，我们可以在其中做这些事情。</p><h1 id="4e07" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated"><strong class="ak">地形</strong>:</h1><p id="3037" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">Terraform也是用Go编写的，并且是预编译的，如果你不知道terraform是什么，你肯定应该看看他们的网站(<a class="ae lj" href="https://www.terraform.io" rel="noopener ugc nofollow" target="_blank"> https://www.terraform.io </a>)，但是为了使它快速简单，terraform让你在公共/私有云中部署虚拟基础设施。</p><p id="e92f" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">例如，您可以使用一个特定的映像创建一个具有弹性负载平衡器的5层VPC，在其上运行给定数量的EC2实例，所有这些都来自一个简单的文件，非常简单。</p><p id="5052" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">因此，问题是我们如何从terraform访问Vault存储值，例如，terraform需要IAM cred或RDS等。</p><p id="4962" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">一个善良的terraform用户/开发者已经开始写了一个(“【https://github.com/redredgroovy/terraform-provider-vault】T2”)，不幸的是对我们来说这些还没有包括在最新的terraform版本中，所以我们需要编译它<strong class="jr hv">(确保你使用的是Go 1.7) </strong></p><pre class="kt ku kv kw fq lk ll lm ln aw lo dt"><span id="adea" class="lp is hu ll b fv lq lr l ls lt">$ <strong class="ll hv">git clone </strong><a class="ae lj" href="https://github.com/redredgroovy/terraform-provider-vault" rel="noopener ugc nofollow" target="_blank"><strong class="ll hv">https://github.com/redredgroovy/terraform-provider-vault</strong></a><strong class="ll hv"><br/></strong>Cloning into 'terraform-provider-vault'...<br/>remote: Counting objects: 64, done.<br/>remote: Total 64 (delta 0), reused 0 (delta 0), pack-reused 64<br/>Unpacking objects: 100% (64/64), done.<br/>Checking connectivity... done.<br/><strong class="ll hv">$ cd terraform-provider-vault/<br/>$ go build -o $GOPATH/bin/terraform-provider-vault</strong><br/><strong class="ll hv">$ stat $GOPATH/bin/terraform-provider-vault</strong><br/>  File: '/home/jeronimog/Projects//bin/terraform-provider-vault'<br/>  Size: 14870377        Blocks: 29048      IO Block: 4096   regular file<br/>Device: 801h/2049d      Inode: 1968433     Links: 1<br/>Access: (0775/-rwxrwxr-x)  Uid: ( 1000/jeronimog)   Gid: ( 1000/jeronimog)<br/>Access: 2016-09-28 18:12:58.864000000 +0100<br/>Modify: 2016-09-28 18:12:59.780000000 +0100<br/>Change: 2016-09-28 18:12:59.800000000 +0100<br/> Birth: -<br/><strong class="ll hv">$GOPATH/bin/terraform-provider-vault</strong><br/>This binary is a plugin. These are not meant to be executed directly.<br/>Please execute the program that consumes these plugins, which will<br/>load any plugins automatically</span></pre><p id="aff1" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">步骤:</p><ul class=""><li id="b365" class="lw lx hu jr b js kn jw ko ka ly ke lz ki ma km mb mc md me dt translated">将repo和cd克隆到其中</li><li id="cab4" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">编译，并将目的地设置为$GOPATH/bin(常见的做法)</li><li id="3a93" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">统计它并检查它是否像看起来的那样执行</li></ul><p id="7e30" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">Terraform插件是terraform在需要时执行的二进制文件，所以在编译时没有太多麻烦。所以让我们继续前进。</p><h2 id="8c22" class="lp is hu bd it mk ml mm ix mn mo mp jb ka mq mr jf ke ms mt jj ki mu mv jn mw dt translated">在terraform可以看到的地方添加新编译的模块:</h2><p id="6e7e" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">我们要将二进制文件复制到terraform可以看到并配置它的地方。</p><p id="f8d0" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">我通常在~/Projects/vaulttf/上拥有一切</p><pre class="kt ku kv kw fq lk ll lm ln aw lo dt"><span id="976a" class="lp is hu ll b fv lq lr l ls lt">cd ~/Projects/vaulttf<br/>cp <strong class="ll hv">$GOPATH/bin/terraform-provider-vault .<br/></strong>$ ls<br/>sample.tf <strong class="ll hv">terraform</strong> <strong class="ll hv">terraform-provider-vault</strong> <strong class="ll hv">vault .terraformrc</strong></span></pre><ul class=""><li id="a78e" class="lw lx hu jr b js kn jw ko ka ly ke lz ki ma km mb mc md me dt translated">sample.tf是一个样本terraform文件，我们将使用它来测试这个</li><li id="34cb" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">terraform是我的terraform二元</li><li id="e019" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">terraform-provider-vault是我们刚刚编译的插件</li><li id="9823" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">。terraformrc是terraform配置文件</li></ul><p id="b46b" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">首先，我们需要告诉terraform在哪里可以找到这个插件，这是在。<strong class="jr hv"> terraformrc: </strong></p><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="my mz l"/></div></figure><p id="a9a8" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">所以我们告诉它，它就在同一个路径中，(在prod中使用它时，请记住相对路径)</p><p id="2df9" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">现在，让我们创建一个从Vault中检索信息的示例terraform文件:</p><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="my mz l"/></div></figure><p id="b020" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">总之</p><ul class=""><li id="e572" class="lw lx hu jr b js kn jw ko ka ly ke lz ki ma km mb mc md me dt translated">我们调用保险库提供者，传递toke和地址</li><li id="cc8a" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">创建一个经过我们要查找的路径的资源</li><li id="0688" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">并创建一个输出资源来打印我们从Vault中获取的变量</li></ul><p id="bd44" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">结果应该是这样的:</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div class="fe ff na"><img src="../Images/581ab06ab8bffd0f0e3fc5574f0fb442.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*R7hKa7Pv7S5fuxV6zFNcOw.png"/></div><figcaption class="le lf fg fe ff lg lh bd b be z ek">Console screenshot cause gist gets messed up by the terminal colors</figcaption></figure><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="my mz l"/></div><figcaption class="le lf fg fe ff lg lh bd b be z ek">gist anyways</figcaption></figure><p id="5952" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">现在你有了它，一个通过terraform从Vault中获取的密码已经在一个terraform变量上，你可以对它做任何你想做的事情。</p><h1 id="42db" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">Ansible:</h1><p id="0583" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">另一种可能是通过Ansible(<a class="ae lj" href="https://www.ansible.com/" rel="noopener ugc nofollow" target="_blank">https://www.ansible.com/</a>)检索存储在保险库中的信息，如果你不知道ansi ble是什么，我将使用我从一位同事那里听到的描述:</p><p id="c54d" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated"><strong class="jr hv"><em class="lv">“ansi ble很好地包装了通过ssh执行get的python脚本”</em> </strong></p><p id="10db" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">Ansible使用剧本来定义将在给定主机中执行的动作，例如:<strong class="jr hv">(这是一个非常简单的例子，以防你对ansible一无所知)</strong></p><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="my mz l"/></div></figure><p id="1145" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">输出通过ssh登录到所有服务器的操作，并对列表[1，2，3，4，5]中的每个元素执行echo {{item}}</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="fe ff nb"><img src="../Images/28b2dd862116406101c806265eea0fb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7VZwf6lu0XH9bd5wWqzY4w.png"/></div></div></figure><p id="9f44" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">很简单的事情，但是你看到了它的可能性。</p><p id="62bd" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">一个很好的例子是，想象一下<strong class="jr hv"> Ansible </strong>需要在一个给定的数据库上重新部署一个模型，但是要这样做<strong class="jr hv"> Ansible </strong>需要密码，但是我们不能将它硬编码到剧本中<strong class="jr hv">(有其他机制可以做到这一点，比如Ansible Vault或其他，但是我们今天主要关注Vault)</strong></p><p id="2f9e" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">已经有一些插件可以做到这一点，但我认为模仿我们自己的插件并看看它是如何工作的是个好主意。</p><p id="8448" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">因此，让我们创建一个从Vault中检索“secret/photodb”的Ansible插件。</p><p id="c821" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">第一步，我们将它写入保险库:</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="fe ff nc"><img src="../Images/a46e109de7c9c93b700877d481a255b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TenRcJKAXSyU5s4Y7JaH3A.png"/></div></div></figure><p id="46c1" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">这样，我们现在在<strong class="jr hv">“secret/photodb”</strong>挂载点中有了<strong class="jr hv"> rootpw:qwe123 </strong>。</p><p id="bac8" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">我们也可以用curl来检验这一点:</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="fe ff nd"><img src="../Images/e0696009d21645d3b39de7147d6afe41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EAC8kONahbEN_rU-87i8VA.png"/></div></div></figure><p id="930d" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">现在工作正常了，让我们为ansible制作一个小插件来检索这个<strong class="jr hv"> rootpw </strong>键，并使用它登录mysql。</p><p id="cfc9" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">创建查找插件最简单的方法是将它放入项目根目录下的库中(或者也可以放在一个角色中)</p><pre class="kt ku kv kw fq lk ll lm ln aw lo dt"><span id="3078" class="lp is hu ll b fv lq lr l ls lt">cd Projects/myansiblelittleplugin/<br/>mkdir library/</span></pre><p id="76cc" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">在那里，我们将创建一个名为photo.py的文件，其内容为<strong class="jr hv">“非常基本的”</strong>:</p><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="my mz l"/></div></figure><p id="6740" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">简而言之:</p><ul class=""><li id="0a52" class="lw lx hu jr b js kn jw ko ka ly ke lz ki ma km mb mc md me dt translated"><strong class="jr hv">getphotpw</strong>这是一个简单的函数，它接受一个dict作为参数，并创建一个针对<strong class="jr hv"> Vault </strong>的get请求</li><li id="ef83" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">main函数定义了<strong class="jr hv"> ansible </strong>插件add添加了一个包含所有参数的字典，我将在<strong class="jr hv">剧本</strong>中进一步传递这些参数</li><li id="ab34" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">这只是一个模拟，在点击prod之前需要做大量的工作:)</li></ul><p id="90b9" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">现在剧本看起来是这样的:</p><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="my mz l"/></div></figure><ul class=""><li id="b884" class="lw lx hu jr b js kn jw ko ka ly ke lz ki ma km mb mc md me dt translated">请注意我是如何使用任务“photo”调用插件的</li><li id="9e84" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">传递所有必需的参数</li><li id="7634" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">记录输出<strong class="jr hv">(高亮显示1) </strong></li><li id="2278" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">调试将成为photodb根通道的输出</li><li id="4580" class="lw lx hu jr b js mf jw mg ka mh ke mi ki mj km mb mc md me dt translated">和使用它的运行命令<strong class="jr hv">(高亮显示2) </strong></li></ul><p id="0632" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">输出将如下所示:</p><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="fe ff ne"><img src="../Images/cbc055412f459ca225436557a6fafd3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VtoR6P2v3QkCRW1rbYC0Pg.png"/></div></div></figure><p id="7a44" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated"><strong class="jr hv">最终备注:</strong></p><p id="24f2" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">这只是对Vault的一个小小的介绍，还有很多要探索，但我想至少它清楚了如何与它交互和进行基本操作。</p><p id="7bdf" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">稍后，最好使用不同的后端，并更深入地了解它提供的加密级别。</p><div class="kt ku kv kw fq ab cb"><figure class="nf kx ng nh ni nj nk paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="nf kx ng nh ni nj nk paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="nf kx ng nh ni nj nk paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="nl nm nn"><p id="f922" class="jp jq lv jr b js kn ju jv jw ko jy jz no kp kc kd np kq kg kh nq kr kk kl km hn dt translated"><a class="ae lj" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae lj" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae lj" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae lj" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jp jq lv jr b js kn ju jv jw ko jy jz no kp kc kd np kq kg kh nq kr kk kl km hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae lj" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae lj" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kt ku kv kw fq kx fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff nr"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure></div></div>    
</body>
</html>