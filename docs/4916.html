<html>
<head>
<title>Starting Small With Kubernetes and Kubeadm: 500 Containers?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Kubernetes和Kubeadm开始:500个容器？</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/starting-small-with-kubernetes-and-kubeadm-500-containers-6c76454e6e12?source=collection_archive---------13-----------------------#2017-06-29">https://medium.com/hackernoon/starting-small-with-kubernetes-and-kubeadm-500-containers-6c76454e6e12?source=collection_archive---------13-----------------------#2017-06-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/22847a06c06fca8668102a43a024e2d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gsSi-lhbMKfj7Ceq8C5__Q.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Photo by <a class="ae jg" href="http://unsplash.com/photos/oZPwn40zCK4?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Thomas Kvistholt</a> on <a class="ae jg" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="9613" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在Vurt，我们正在用Kubernetes进行一些内部实验。在这篇测试和文章中，我们专门讨论了kubeadm作为安装程序，以及在裸机服务器上运行k8s节点。哦，还有ZFS。</p><p id="135e" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们认为Kubeadm是一个重要的项目。Vurt的团队在运营OpenStack云方面拥有丰富的经验，我们发现k8s社区在运营决策方面与OpenStack社区在历史上的做法存在明显差异。</p><p id="f15b" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这并不是说一个或另一个是正确的，而是有不同的选择可以做。</p><h2 id="04e0" class="kf kg hu bd kh ki kj kk kl km kn ko kp js kq kr ks jw kt ku kv ka kw kx ky kz dt translated"><strong class="ak"> OpenStack:没有默认部署选项</strong></h2><p id="74d5" class="pw-post-body-paragraph jh ji hu jj b jk la jm jn jo lb jq jr js lc ju jv jw ld jy jz ka le kc kd ke hn dt translated">OpenStack明确选择不支持某个特定的部署机制。所以有很多，而且一直都有新的。例如<a class="ae jg" href="https://git.openstack.org/cgit/openstack/openstack-helm/" rel="noopener ugc nofollow" target="_blank"> OpenStack Helm </a>是一个最近创建的项目，将使用Helm和Kubernetes部署OpenStack云的控制平面。OpenStack大概有五六个主要的安装和管理系统。</p><p id="23aa" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">长话短说，这是选项#1: <em class="lf">没有默认部署系统</em>。相反，我们得到了许多“安装程序”，反过来，关于如何部署OpenStack的观点有些支离破碎。(我们甚至不要进入第2天的操作。)但是这个帖子不是关于OpenStack的，是关于k8s和kubeadm的。</p><h2 id="a0a8" class="kf kg hu bd kh ki kj kk kl km kn ko kp js kq kr ks jw kt ku kv ka kw kx ky kz dt translated">Kubernetes: Kubeadm</h2><p id="ff34" class="pw-post-body-paragraph jh ji hu jj b jk la jm jn jo lb jq jr js lc ju jv jw ld jy jz ka le kc kd ke hn dt translated">另一方面，Kubernetes已经决定实现一个默认的部署机制:<a class="ae jg" href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" rel="noopener ugc nofollow" target="_blank"> kubeadm </a>。当然还有许多其他的“发行版”和“安装程序”，但是kubeadm是一个真实的东西。</p><blockquote class="lg lh li"><p id="c7ca" class="jh ji lf jj b jk jl jm jn jo jp jq jr lj jt ju jv lk jx jy jz ll kb kc kd ke hn dt translated">在SIG-cluster-lifecycle，我们在过去的几个月里一直在努力开发kubeadm，这是一个使Kubernetes安装起来非常容易的工具。我们从用户那里听说安装Kubernetes比它应该的要难，我们希望人们专注于编写伟大的分布式应用程序，而不是与基础设施争吵！— <a class="ae jg" href="http://blog.kubernetes.io/2016/09/how-we-made-kubernetes-easy-to-install.html" rel="noopener ugc nofollow" target="_blank"> k8s博客</a></p></blockquote><p id="bfd0" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">(这篇博文的一个重要部分是他们提到kubeadm不会提供服务器，即它将在一些现有的Linux服务器上部署k8s。所以团队决定稍微限制一下范围。)</p><p id="8845" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">基本上，k8s社区已经决定将有一个默认的安装程序作为k8s核心代码的一部分。这是一个有趣且潜在强大的决定。</p><h2 id="43a7" class="kf kg hu bd kh ki kj kk kl km kn ko kp js kq kr ks jw kt ku kv ka kw kx ky kz dt translated">尝试部署500个容器</h2><p id="9877" class="pw-post-body-paragraph jh ji hu jj b jk la jm jn jo lb jq jr js lc ju jv jw ld jy jz ka le kc kd ke hn dt translated">在我们的一个测试中，我们决定在四台服务器上使用kubeadm执行k8s的快速部署:一台虚拟机和三个裸机节点。虚拟机和网络由OpenStack管理，目前物理节点自动部署在OpenStack之外。物理服务器必须在绑定中配置1GB网卡。</p><p id="1043" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">至于计算资源，裸机节点有128GB的内存和32个CPU。虚拟机将充当k8s主机，它只有4GB内存和2个CPU。我们的目标是部署500个集装箱。</p><p id="ba76" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">值得注意的是，这个测试并不仅仅是让500个容器运行起来，它更多的是探索kubeadm做什么，以及我们可以用它的默认设置做什么，而不是“挑战”硬件和软件的极限。我们并不期望能够在不做一些配置更改的情况下在三个节点上运行500个容器，但是我们想尝试一下！</p><p id="91ee" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">裸机节点还有一个SSD(用于缓存)和一个配置了ZFS的SATA驱动器。此外，Docker配置在节点上，并将ZFS作为映像支持引擎。如果可能的话，我们希望使用ZFS作为我们的默认存储系统，因此我们正在评估将Linux上的ZFS(ZoL)用于Docker/Kubernetes。</p><pre class="lm ln lo lp fq lq lr ls lt aw lu dt"><span id="a424" class="kf kg hu lr b fv lv lw l lx ly">ubuntu@bm-node-1:/var/log$ sudo zpool list<br/>NAME           SIZE  ALLOC   FREE  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT<br/>zpool-docker   840G   380M   840G         -     0%     0%  1.00x  ONLINE  -</span></pre><p id="9d60" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">由于使用了ZFS，我们不得不运行kube init，并选择跳过飞行前检查。这是警告通知。</p><pre class="lm ln lo lp fq lq lr ls lt aw lu dt"><span id="7594" class="kf kg hu lr b fv lv lw l lx ly">[preflight] Some fatal errors occurred:<br/> unsupported graph driver: zfs<br/>[preflight] If you know what you are doing, you can skip pre-flight checks with `--skip-preflight-checks`</span></pre><p id="5108" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">同样，在这个测试中，我们使用了(某种程度上)默认的Weave网络插件。Weave的安装非常简单！</p><pre class="lm ln lo lp fq lq lr ls lt aw lu dt"><span id="6727" class="kf kg hu lr b fv lv lw l lx ly">ubuntu@kube-master:~$ kubectl apply -f <a class="ae jg" href="https://git.io/weave-kube-1.6" rel="noopener ugc nofollow" target="_blank">https://git.io/weave-kube-1.6</a><br/>serviceaccount "weave-net" created<br/>clusterrole "weave-net" created<br/>clusterrolebinding "weave-net" created<br/>daemonset "weave-net" created</span></pre><p id="d077" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">首先配置kube-master节点和网络，然后初始化裸机节点。</p><h2 id="275a" class="kf kg hu bd kh ki kj kk kl km kn ko kp js kq kr ks jw kt ku kv ka kw kx ky kz dt translated">创建部署</h2><p id="b378" class="pw-post-body-paragraph jh ji hu jj b jk la jm jn jo lb jq jr js lc ju jv jw ld jy jz ka le kc kd ke hn dt translated">一旦k8s启动并运行(感谢kubeadm！)我们使用了一个nginx示例部署，并从几个pod开始。然后我们扩大规模，最初是50个，然后是100个……最后达到500个。</p><pre class="lm ln lo lp fq lq lr ls lt aw lu dt"><span id="70e0" class="kf kg hu lr b fv lv lw l lx ly">ubuntu@kube-master:~$ cat deployment.yaml <br/>apiVersion: apps/v1beta1<br/>kind: Deployment<br/>metadata:<br/>  name: nginx-deployment<br/>spec:<br/>  replicas: 500 # tells deployment to run 2 pods matching the template<br/>  template: # create pods using pod definition in this template<br/>    metadata:<br/>      # unlike pod-nginx.yaml, the name is not included in the meta data as a unique name is<br/>      # generated from the deployment name<br/>      labels:<br/>        app: nginx<br/>    spec:<br/>      containers:<br/>      - name: nginx<br/>        image: nginx:1.7.9<br/>        ports:<br/>        - containerPort: 80</span></pre><p id="6daa" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在我们试图从250增加到500之前，这些扩展行动进行得非常顺利。我们遇到的障碍是，默认情况下，每个节点的pod数量限制为110个。</p><pre class="lm ln lo lp fq lq lr ls lt aw lu dt"><span id="9679" class="kf kg hu lr b fv lv lw l lx ly">ubuntu@kube-master:/var/log$ kubectl get nodes -o json | jq '.items[] | {name: .metadata.name, cap: .status.capacity}'<br/>{<br/>  "name": "kube-master",<br/>  "cap": {<br/>    "cpu": "2",<br/>    "memory": "4046412Ki",<br/>    "pods": "110"<br/>  }<br/>}<br/>{<br/>  "name": "bm-node-1",<br/>  "cap": {<br/>    "cpu": "32",<br/>    "memory": "131999476Ki",<br/>    "pods": "110"<br/>  }<br/>}<br/>{<br/>  "name": "bm-node-2",<br/>  "cap": {<br/>    "cpu": "32",<br/>    "memory": "131999472Ki",<br/>    "pods": "110"<br/>  }<br/>}<br/>{<br/>  "name": "bm-node-3",<br/>  "cap": {<br/>    "cpu": "32",<br/>    "memory": "131999636Ki",<br/>    "pods": "110"<br/>  }<br/>}</span></pre><p id="cd27" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">查看<a class="ae jg" href="https://kubernetes.io/docs/admin/kubelet/" rel="noopener ugc nofollow" target="_blank"> kublet文档</a>，有一个设置pod限制的选项。</p><pre class="lm ln lo lp fq lq lr ls lt aw lu dt"><span id="15d3" class="kf kg hu lr b fv lv lw l lx ly">--max-pods int32                                          Number of Pods that can run on this Kubelet. (default 110)</span></pre><p id="c702" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">总的来说，我们对这次测试非常满意。在一个小时左右的时间里，我们在四个节点上部署了一个k8s集群，部署了一个软件定义的网络系统(Weave ),并且几乎不费吹灰之力就创建了250个容器。在未来的测试中，我们将改变每个节点的pod限制，看看会发生什么！当然，裸机节点可以运行更多，尤其是如果这些容器实际上什么也不做的话。</p><h2 id="cc8f" class="kf kg hu bd kh ki kj kk kl km kn ko kp js kq kr ks jw kt ku kv ka kw kx ky kz dt translated">测试客户</h2><p id="f159" class="pw-post-body-paragraph jh ji hu jj b jk la jm jn jo lb jq jr js lc ju jv jw ld jy jz ka le kc kd ke hn dt translated">我们目前正在寻找少量的测试客户加入我们的旅程，在托管的私有基础设施上进行高级Kubernetes部署。如果您的组织希望参与此事，请发送电子邮件至vurt@vurtcloud.com或使用我们的 <a class="ae jg" href="https://vurtcloud.com/contactus.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jj hv">联系表</strong> </a> <strong class="jj hv">。</strong></p><div class="lm ln lo lp fq ab cb"><figure class="lz iv ma mb mc md me paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="lz iv ma mb mc md me paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="lz iv ma mb mc md me paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="lg lh li"><p id="f922" class="jh ji lf jj b jk jl jm jn jo jp jq jr lj jt ju jv lk jx jy jz ll kb kc kd ke hn dt translated"><a class="ae jg" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jg" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jg" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jg" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jh ji lf jj b jk jl jm jn jo jp jq jr lj jt ju jv lk jx jy jz ll kb kc kd ke hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jg" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jg" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lm ln lo lp fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mf"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>