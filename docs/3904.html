<html>
<head>
<title>Asserting Jobs in Queue with Laravel Dusk</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">断言具有Laravel黄昏的队列中的作业</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/asserting-jobs-in-queue-with-laravel-dusk-adb03654ca43?source=collection_archive---------10-----------------------#2017-04-30">https://medium.com/hackernoon/asserting-jobs-in-queue-with-laravel-dusk-adb03654ca43?source=collection_archive---------10-----------------------#2017-04-30</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/cb9aa87d87542a53d2ea83ecd0bc8e57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/format:webp/1*f-OPnsh5Dtiac9pYc_OT4w.png"/></div></figure><p id="c0cf" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">当使用Laravel Dusk编写端到端测试时，您不能像在Laravel 5.3中那样模仿您的作业调度，因为浏览器是一个独立的进程，当浏览器访问应用程序时，您在测试中所做的任何调整都不存在。浏览器将再次引导整个应用程序。我的解决方法是通过一些简单的步骤简单地断言该作业在队列中等待调度。</p><h2 id="a7fe" class="jw jx hu bd jy jz ka kb kc kd ke kf kg jj kh ki kj jn kk kl km jr kn ko kp kq dt translated">设置使用数据库的黄昏队列</h2><p id="cfab" class="pw-post-body-paragraph iy iz hu ja b jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv hn dt translated">打开您的<strong class="ja hv"> config/queue.php </strong>文件，专门为Dusk设置一个队列。将焦点放在数组的<code class="eh kw kx ky kz b">key</code>中定义的<strong class="ja hv">连接名</strong>和<code class="eh kw kx ky kz b">queue</code>索引中定义的<strong class="ja hv">队列名</strong>上。</p><pre class="la lb lc ld fq le kz lf lg aw lh dt"><span id="9f85" class="jw jx hu kz b fv li lj l lk ll">'connections' =&gt; [<br/><br/>    'database' =&gt; [<br/>        'driver' =&gt; 'database',<br/>        'table' =&gt; 'jobs',<br/>        'queue' =&gt; 'default',<br/>        'retry_after' =&gt; 90,<br/>    ],<br/><br/><strong class="kz hv">    'dusk-connection' =&gt; [<br/>        'driver' =&gt; 'database',<br/>        'table' =&gt; 'jobs',<br/>        'queue' =&gt; 'dusk-queue',<br/>        'retry_after' =&gt; 90,<br/>    ],</strong><br/>]</span></pre><h2 id="72f8" class="jw jx hu bd jy jz ka kb kc kd ke kf kg jj kh ki kj jn kk kl km jr kn ko kp kq dt translated">黄昏环境</h2><p id="b1ba" class="pw-post-body-paragraph iy iz hu ja b jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv hn dt translated">在您的<code class="eh kw kx ky kz b">.env.dusk.local</code>文件中，将<code class="eh kw kx ky kz b">QUEUE_DRIVER</code>设置为<code class="eh kw kx ky kz b">dusk-connection</code>。特别关注黄昏如何交换环境。</p><h2 id="21cd" class="jw jx hu bd jy jz ka kb kc kd ke kf kg jj kh ki kj jn kk kl km jr kn ko kp kq dt translated">确保作业表存在</h2><p id="6066" class="pw-post-body-paragraph iy iz hu ja b jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv hn dt translated">如果还没有，运行<code class="eh kw kx ky kz b">php artisan queue:table</code>为<strong class="ja hv">作业</strong>表创建一个迁移，然后运行<code class="eh kw kx ky kz b">php artisan migrate</code>对数据库运行新创建的迁移。</p><figure class="la lb lc ld fq iv fe ff paragraph-image"><div class="fe ff ln"><img src="../Images/9028126e98c6d41c429393a8a463a19c.png" data-original-src="https://miro.medium.com/v2/resize:fit:856/format:webp/1*-JouU6lbQurGB7yPCOj5KA.png"/></div></figure><h2 id="ee78" class="jw jx hu bd jy jz ka kb kc kd ke kf kg jj kh ki kj jn kk kl km jr kn ko kp kq dt translated">向DuskTestCase.php添加自定义断言</h2><p id="814e" class="pw-post-body-paragraph iy iz hu ja b jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv hn dt translated">如果你已经安装了Dusk，你会注意到它创建了文件<strong class="ja hv"> tests/DuskTestCase.php </strong>。让我们在这个文件中添加一个自定义断言。<br/> <strong class="ja hv">注:</strong>我们希望<strong class="ja hv"> </strong>弹出<strong class="ja hv">黄昏队列</strong>中的下一个可用作业，这是在设置步骤中选择的<strong class="ja hv">队列</strong>名称。</p><pre class="la lb lc ld fq le kz lf lg aw lh dt"><span id="185e" class="jw jx hu kz b fv li lj l lk ll"><em class="lo">/**<br/> * Asserts that Jobs are in Queue to be dispatched.<br/> *<br/> * </em><strong class="kz hv"><em class="lo">@param </em></strong><em class="lo">array|string $queued<br/> */<br/></em><strong class="kz hv">public function </strong>assertQueued($queued) {<br/>    <strong class="kz hv">if </strong>(!is_array($queued))<br/>        $queued = func_get_args();<br/><br/>    $repository = app()-&gt;make(<br/>        \Illuminate\Contracts\Queue\Queue::<em class="lo">class<br/>    </em>);<br/><br/>    <strong class="kz hv">foreach </strong>($queued <strong class="kz hv">as </strong>$item) {<br/>        $job = $repository-&gt;pop('dusk-queue');<br/>        $this-&gt;assertTrue($job-&gt;resolveName() == $item);<br/>    }<br/>}</span></pre><h1 id="d963" class="lp jx hu bd jy lq lr ls kc lt lu lv kg lw lx ly kj lz ma mb km mc md me kp mf dt translated">测试你的工作！</h1><p id="43ea" class="pw-post-body-paragraph iy iz hu ja b jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv hn dt translated">对于这个例子，我通过运行<code class="eh kw kx ky kz b">php artisan make:job MyFirstJob</code>和<code class="eh kw kx ky kz b">php artisan make:job MySecondJob</code>创建了两个示例作业，分别名为<code class="eh kw kx ky kz b">MyFirstJob</code>和<code class="eh kw kx ky kz b">MySecondJob</code>。<code class="eh kw kx ky kz b">assertQueued</code>将接受多个参数、一个参数数组或仅仅一个合格的类。</p><pre class="la lb lc ld fq le kz lf lg aw lh dt"><span id="0971" class="jw jx hu kz b fv li lj l lk ll">Route::<em class="lo">get</em>('/', <strong class="kz hv">function </strong>() {<br/>    dispatch(<strong class="kz hv">new </strong>\App\Jobs\MySecondJob);<br/>    dispatch(<strong class="kz hv">new </strong>\App\Jobs\MyFirstJob);<br/>    <strong class="kz hv">return </strong>view('welcome');<br/>});</span><span id="45d7" class="jw jx hu kz b fv mg lj l lk ll"><strong class="kz hv">public function </strong>testBasicExample()<br/>{<br/>    $this-&gt;browse(<strong class="kz hv">function </strong>(Browser $browser) {<br/>        $browser-&gt;visit('/')<br/>                -&gt;assertSee('Laravel');<br/>    });<br/><br/>    $this-&gt;assertQueued([MyFirstJob::<em class="lo">class</em>, MySecondJob::<em class="lo">class</em>]);<br/>}</span></pre><h1 id="30f1" class="lp jx hu bd jy lq lr ls kc lt lu lv kg lw lx ly kj lz ma mb km mc md me kp mf dt translated">结论</h1><p id="cdaa" class="pw-post-body-paragraph iy iz hu ja b jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv hn dt translated">Dusk将导航到您的应用程序，触发一些事件，使用<code class="eh kw kx ky kz b">QUEUE_DRIVER=dusk-connection</code>将作业在<code class="eh kw kx ky kz b">jobs</code>表中排队。然后，您可以断言这个作业在Dusk本身的数据库中。但是请注意:您需要确保您的测试构建了一个干净的数据库，并在每次测试时都将其拆除，否则弹出下一个作业可能不会像预期的那样工作。</p><div class="la lb lc ld fq ab cb"><figure class="mh iv mi mj mk ml mm paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mh iv mi mj mk ml mm paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mh iv mi mj mk ml mm paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mn mo mp"><p id="f922" class="iy iz lo ja b jb jc jd je jf jg jh ji mq jk jl jm mr jo jp jq ms js jt ju jv hn dt translated"><a class="ae lm" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae lm" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae lm" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae lm" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="iy iz lo ja b jb jc jd je jf jg jh ji mq jk jl jm mr jo jp jq ms js jt ju jv hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae lm" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae lm" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="la lb lc ld fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="fe ff mt"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>