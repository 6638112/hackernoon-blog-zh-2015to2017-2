<html>
<head>
<title>6 must-do before hosting your Laravel web platform on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS上托管Laravel web平台之前必须做的6件事</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/6-must-do-before-hosting-your-laravel-web-platform-on-aws-35af4e8bccd8?source=collection_archive---------2-----------------------#2017-03-26">https://medium.com/hackernoon/6-must-do-before-hosting-your-laravel-web-platform-on-aws-35af4e8bccd8?source=collection_archive---------2-----------------------#2017-03-26</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="86ac" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="jp">感谢光临！您可能还想查看这篇关于在AWS上部署Laravel的后续文章</em></strong><a class="ae jq" href="https://hackernoon.com/laravel-on-aws-a-reference-architecture-a680755130d0" rel="noopener ugc nofollow" target="_blank"><strong class="it hv"><em class="jp"/></strong></a><strong class="it hv"><em class="jp">或者甚至使用下面的表格下载这本书！</em>T13】</strong></p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="jw jx l"/></div></figure><p id="2a1b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我的咨询客户经常会问，将他们的web应用程序移植到Amazon Web Services是否值得。他们期待更好的性能和可靠性，因为<a class="ae jq" href="https://hackernoon.com/tagged/aws" rel="noopener ugc nofollow" target="_blank"> AWS </a>听起来更专业，但他们也听说过令人震惊的AWS账单的故事，尽管他们不知道为什么。</p><p id="7c8d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">简而言之，通过以正确的方式构建你的<a class="ae jq" href="https://hackernoon.com/tagged/web-platform" rel="noopener ugc nofollow" target="_blank"> web平台</a>，你将能够首先部署在一个更便宜的主机选项上，同时确保平稳地迁移到AWS，保证零重构。</p><p id="de06" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是一个详细的清单，它将保证你的网络平台是可移植的，并充分利用AWS。</p><h1 id="7355" class="jy jz hu bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv dt translated">1.配置作为环境变量</h1><p id="b852" class="pw-post-body-paragraph ir is hu it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hn dt translated">在审计中，我要检查的第一件事是应用程序配置是否是从环境变量中检索的。环境是你的应用可以运行的任何地方。它可以是您的开发人员的本地机器、您的测试服务器、您的试运行服务器或您的生产服务器。</p><p id="9541" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">应用程序配置是可能在不同环境之间发生变化的任何东西。</p><ul class=""><li id="ae87" class="lb lc hu it b iu iv iy iz jc ld jg le jk lf jo lg lh li lj dt translated">后台服务的资源句柄(数据库、缓存引擎、搜索引擎等的URIs)</li><li id="e309" class="lb lc hu it b iu lk iy ll jc lm jg ln jk lo jo lg lh li lj dt translated">外部服务的任何凭证(密码、SSH密钥、SSL证书)</li></ul><h2 id="dc74" class="lp jz hu bd ka lq lr ls ke lt lu lv ki jc lw lx km jg ly lz kq jk ma mb ku mc dt translated">从预定义的文件中检索您的配置…</h2><p id="28aa" class="pw-post-body-paragraph ir is hu it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hn dt translated">…配置文件应该从环境变量中初始化。</p><p id="13bf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在PHP Laravel中，这是通过在<em class="jp"> config </em>文件夹中创建文件，并使用助手<em class="jp"> env() </em>用环境变量初始化配置文件来实现的。</p><h2 id="a686" class="lp jz hu bd ka lq lr ls ke lt lu lv ki jc lw lx km jg ly lz kq jk ma mb ku mc dt translated"><strong class="ak">并从环境中初始化您的配置文件</strong></h2><p id="c1d6" class="pw-post-body-paragraph ir is hu it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hn dt translated">特定于环境的配置不应该在源代码中，而应该存储在环境中。<br/>在您的测试、试运行和生产服务器上，环境由您的部署脚本设置。</p><p id="d26d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在开发人员的本地机器上，对于Laravel框架，它作为一个. env文件存储在项目的根目录下，不应该提交给源代码库(添加到您的<em class="jp">)。gitignore </em>文件)。</p><p id="6c7d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">测试管道的配置可以存储在<em class="jp"> .env.testing </em>文件中。</p><h2 id="e702" class="lp jz hu bd ka lq lr ls ke lt lu lv ki jc lw lx km jg ly lz kq jk ma mb ku mc dt translated">嗅觉测试</h2><p id="f0f3" class="pw-post-body-paragraph ir is hu it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hn dt translated">任何测试环境的代码都是一面红旗(<em class="jp">ifs</em>production<em class="jp">then…</em>/<em class="jp">if</em>staging<em class="jp">then</em>)。当本地、生产和暂存使用不同的驱动程序时(例如，开发机器在本地存储文件，而生产服务器使用文件存储服务)，那么应该使用一个抽象层，但是它不应该与您的应用程序业务逻辑混合在代码中。<br/> Laravel为<em class="jp">存储</em>、<em class="jp">缓存</em>、<em class="jp">队列</em>等提供服务门面；他们的角色是抽象出文件存储、缓存、后台作业队列等是如何实现的，这样逻辑就独立于环境，你的代码也应该如此。</p><p id="52d5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这样，相同的代码将使用一个本地Redis服务器来存储web会话，并在AWS上使用一个托管服务ElastiCache。将您的代码部署到产品中时，不会有最后一刻的切换，也不会有最后一刻的错误。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="fe ff md"><img src="../Images/6d7e1c19bd15085e81dccad6e6f71880.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8NP1b7FVT4zleY20JQ1y4A.png"/></div></div></figure><h1 id="c132" class="jy jz hu bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv dt translated">2.无状态代码</h1><blockquote class="mk ml mm"><p id="b6d6" class="ir is jp it b iu iv iw ix iy iz ja jb mn jd je jf mo jh ji jj mp jl jm jn jo hn dt translated">无状态应用程序是一种应用程序，它不记录在一个会话中生成的数据(如有关用户设置和发生的事件的信息)，以便在与该用户的下一个会话中使用。</p></blockquote><p id="b4a8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当然你的应用程序不会是无状态的！如果您构建一个web平台，您通常会希望您的用户在您的服务上生成尽可能多的数据。<br/>但是它的<em class="jp">进程</em>应该是无状态的，也就是说，将用户重新部署或崩溃或负载平衡到不同的服务器不应该影响用户<br/>这是通过仅在后端服务而不是在应用服务器上集中存储来实现的。通过将会话存储在托管Redis服务(如AWS ElastiCache)中，将用户文件存储在文件存储服务(如AWS S3)中，并在托管AWS RDS实例上运行数据库，可以确保在一个应用服务器上重新部署不会中断用户会话。</p><p id="5407" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这也意味着您可以在多个应用服务器上负载平衡您的流量，并且您的用户将总是能够找到他们的文件。即使在部署失败和失去服务器后，他们也会找到它们。</p><h2 id="818d" class="lp jz hu bd ka lq lr ls ke lt lu lv ki jc lw lx km jg ly lz kq jk ma mb ku mc dt translated">嗅觉测试:使用本地文件、本地内存的代码</h2><p id="55ad" class="pw-post-body-paragraph ir is hu it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hn dt translated">PHP应用程序将文件存储在其运行的本地服务器上是另一个危险信号。如果您在下一次重新部署时丢失了该服务器，您将丢失用户数据。这样的应用程序还不能进行扩展，也需要重构。</p><h2 id="87c6" class="lp jz hu bd ka lq lr ls ke lt lu lv ki jc lw lx km jg ly lz kq jk ma mb ku mc dt translated">JWT</h2><p id="2b48" class="pw-post-body-paragraph ir is hu it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hn dt translated">对于用户会话和API OAuth令牌，您甚至可以在没有集中的键值存储或使用数据库的情况下处理用户会话数据。通过使用Json Web令牌而不是随机的OAuth令牌，应用程序将依靠客户机(浏览器)来存储和发送所有这些信息。数据在服务器端被加密以避免篡改，并且可以存储在cookie中。在这种情况下，服务器不存储任何东西(或者只存储撤销黑名单)，应用程序进程不需要共享任何东西或者调用后端服务。</p><h1 id="8f60" class="jy jz hu bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv dt translated">3.允许并发</h1><p id="7290" class="pw-post-body-paragraph ir is hu it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hn dt translated">现在你的应用程序是无状态的，一个直接的好处是你可以在不同的服务器上运行它的多个版本。这就是所谓的水平扩展，与垂直扩展相反，垂直扩展意味着在一台服务器上运行应用程序，并在需要时将其升级到更强大的服务器。</p><p id="51e7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不是所有的软件都可以水平缩放(例如，对于数据库或搜索引擎来说，这是一个复杂的问题)，但是PHP应用程序可以通过遵循本指南中的6点立即水平缩放。</p><p id="ccd9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦您的应用程序是无状态的，下一步就是将前端代码与后台任务分开。首先，web进程是对用户的浏览器请求立即做出响应的进程。</p><p id="b968" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你也可能有后台工作(如发送报告、生成发票、处理数据、发送电子邮件/推送通知)。它们应该在web进程之外执行，即使它们也是用PHP编写的。</p><p id="9f8f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这些作业将由工作进程执行，因此不会阻塞web请求。</p><p id="7cee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在Laravel框架中，使用队列facade和Redis之类的消息队列服务器，将这些阻塞任务分派到单独的服务器池。迁移到AWS时，可以使用托管消息队列服务SQS。</p><p id="cb19" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">警告:如果你使用AWS SQS来安排关键任务，你需要注意Buffer.com<a class="ae jq" href="https://stories.buffer.com/the-cronjob-that-generates-4-million-a-year-4540b0cde584" rel="noopener ugc nofollow" target="_blank">在本帖</a>中描述的<em class="jp">重复消息</em>边缘情况。</p><h1 id="2019" class="jy jz hu bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv dt translated">4.日志作为流，而不是文件</h1><p id="7858" class="pw-post-body-paragraph ir is hu it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hn dt translated">就像用户生成的文件不应该存储在您的应用服务器上一样，日志也不应该存储在本地。它们也应该被集中起来，并传输到后端服务，在那里您可以在一个地方找到来自所有应用服务器的所有日志(甚至是来自您丢失或关闭的服务器)。</p><p id="e570" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Laravel的Log facade默认情况下只将日志存储在文件中，所以您需要一个<a class="ae jq" href="https://github.com/laravel/internals/issues/126" rel="noopener ugc nofollow" target="_blank">定制配置</a>来将它们传输到PHP的标准错误输出中。如果您在Docker中运行PHP应用程序，那么您可以利用AWS CloudWatch驱动程序，将您的日志传输到一个集中的位置。</p><h2 id="26ea" class="lp jz hu bd ka lq lr ls ke lt lu lv ki jc lw lx km jg ly lz kq jk ma mb ku mc dt translated">嗅觉测试</h2><p id="70f6" class="pw-post-body-paragraph ir is hu it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hn dt translated">写入生产服务器上本地文件的任何日志。</p><h1 id="31ec" class="jy jz hu bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv dt translated"><strong class="ak"> 5。无重构的水平缩放</strong></h1><p id="8e23" class="pw-post-body-paragraph ir is hu it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hn dt translated">如果你遵循了以上几点，那么恭喜你！您的web应用程序已经可以伸缩了，不需要重构。</p><p id="e6ef" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过将配置从代码中分离出来，应用程序可以从更便宜的主机提供商移植到AWS。<br/>将阻塞任务分派给后台工作进程允许我们卸载前端并独立扩展到工作进程。<br/>通过将我们的应用作为无状态进程运行，我们可以将我们的用户流量负载平衡到不同的服务器，并将数据存储在后端服务中。</p><p id="616f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这些是水平扩展的先决条件。它已经具有成本效益，因为您可以使用更小、更便宜的服务器进行扩展。</p><p id="4e5b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下一步是以经济高效的方式托管后端服务。</p><h1 id="e6af" class="jy jz hu bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv dt translated">6.利用AWS托管服务</h1><p id="7eda" class="pw-post-body-paragraph ir is hu it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hn dt translated">到目前为止，我们只讨论了应用服务器(HTTP服务器通过执行PHP代码来响应web请求)，那么后端服务、数据库、搜索引擎等等呢？</p><p id="dfa6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就是你可以充分利用AWS的地方。所有这些后端服务在AWS上都以<em class="jp">托管服务</em>的形式存在，即一种随用随付的计费方式，不需要你维护服务器。<br/>你要尽可能多地使用这些服务，用于数据库(AWS RDS，DocumentDB)、文件存储(S3)、会话存储(ElastiCache)、日志聚合(CloudWatch)、缓存引擎、搜索引擎(AWS Managed ElasticSearch)和负载均衡。</p><h1 id="707e" class="jy jz hu bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv dt translated"><strong class="ak">结论</strong></h1><p id="6394" class="pw-post-body-paragraph ir is hu it b iu kw iw ix iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo hn dt translated">那么成本效益是怎么回事呢？在实践中，托管服务的成本比运行自己的服务器要低得多。有更多的安全和规模在几个点击。在AWS S3上存储你的用户文件，在每月15GB的传输后，每月每GB的费用约为0.02美元，在此之前<strong class="it hv">是免费的</strong>。<br/>在AWS ElasticSearch托管服务上托管您的搜索引擎对于较小的实例是<strong class="it hv">免费的</strong>。<br/>以此类推。</p><p id="993a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">更重要的是，它们将花费更少的时间来设置，几乎没有时间来维护，并让你晚上睡得更好。</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="jw jx l"/></div></figure></div><div class="ab cl mq mr hc ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="hn ho hp hq hr"><p id="5778" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">莱昂内尔是总部位于伦敦的初创公司Wi5的首席技术官，也是《面向未来的工程文化课程</em>  <em class="jp">的作者。你可以在</em><a class="ae jq" href="https://getlionel.com" rel="noopener ugc nofollow" target="_blank"><em class="jp">https://getlionel.com</em></a>上联系他</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="jw jx l"/></div></figure></div></div>    
</body>
</html>