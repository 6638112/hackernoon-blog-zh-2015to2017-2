<html>
<head>
<title>Vault as CA with PKI backend</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">作为具有公钥基础设施后端的证书颁发机构保管库</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/vault-as-ca-with-pki-backend-bbcfc315f06f?source=collection_archive---------5-----------------------#2017-10-29">https://medium.com/hackernoon/vault-as-ca-with-pki-backend-bbcfc315f06f?source=collection_archive---------5-----------------------#2017-10-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="0c12" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将展示如何在pki框架内运行您自己的CA，并能够生成私钥和签名证书。我们将使用<strong class="it hv"> vault </strong>进行此操作，因为这是完成此操作的最快方法。</p><h2 id="533e" class="jp jq hu bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj dt translated">下载并运行保管库:</h2><p id="1ff8" class="pw-post-body-paragraph ir is hu it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hn dt translated">确保您从<a class="ae kp" href="https://www.vaultproject.io/downloads.html" rel="noopener ugc nofollow" target="_blank">https://www.vaultproject.io/downloads.html</a>获得它，或者您根据自己的喜好手工建造它。</p><p id="4baa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于本教程，我们将在开发模式下运行它，但是如果您在生产中运行它，请确保您会做得更好。</p><pre class="kq kr ks kt fq ku kv kw kx aw ky dt"><span id="890f" class="jp jq hu kv b fv kz la l lb lc">vault server -dev</span></pre><figure class="kq kr ks kt fq le fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff ld"><img src="../Images/f6d0a9526fb0a1a24ca7aad252293580.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0mZXjxERAUWcx3odRmTHRw.png"/></div></div></figure><p id="a5a8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">很简单，需要注意的一点是，您需要导出和env变量，以使vault知道要使用哪个vault服务器:</p><pre class="kq kr ks kt fq ku kv kw kx aw ky dt"><span id="8ce3" class="jp jq hu kv b fv kz la l lb lc">export VAULT_ADDR='<a class="ae kp" href="http://127.0.0.1:8200'" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8200'</a></span></pre><h2 id="185f" class="jp jq hu bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj dt translated">创建公钥基础设施后端</h2><p id="2473" class="pw-post-body-paragraph ir is hu it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hn dt translated">Vault有可插入的后端，所以我们需要安装我们想要使用的后端，原因如下:</p><pre class="kq kr ks kt fq ku kv kw kx aw ky dt"><span id="30ef" class="jp jq hu kv b fv kz la l lb lc">vault mount pki<br/>vault mount-tune -max-lease-ttl=87600h pki</span></pre><figure class="kq kr ks kt fq le fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff ll"><img src="../Images/77ff6b991078cfe4dd178afe9c91a0f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hEdV3pZrBcrX6gEWMa5EBg.png"/></div></div></figure><h2 id="3d70" class="jp jq hu bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj dt translated">生成根证书</h2><p id="4f4c" class="pw-post-body-paragraph ir is hu it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hn dt translated">我们将直接从根证书颁发，而不使用中间证书，所以让我们创建根证书，CA将使用:</p><pre class="kq kr ks kt fq ku kv kw kx aw ky dt"><span id="a4f2" class="jp jq hu kv b fv kz la l lb lc">vault write pki/root/generate/internal common_name=internal.com ttl=87600h</span></pre><figure class="kq kr ks kt fq le fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff lm"><img src="../Images/d418632beae8adb4d858fc523db2bfbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jcF7CnWuL1h7hR-If9SpYQ.png"/></div></div></figure><p id="1e11" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">密钥和证书将存储在后端</p><h2 id="ef79" class="jp jq hu bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj dt translated">为CA配置CRL:</h2><pre class="kq kr ks kt fq ku kv kw kx aw ky dt"><span id="940e" class="jp jq hu kv b fv kz la l lb lc">vault write pki/config/urls issuing_certificates="<a class="ae kp" href="http://127.0.0.1:8200/v1/pki/ca" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8200/v1/pki/ca</a>" crl_distribution_points="<a class="ae kp" href="http://127.0.0.1:8200/v1/pki/crl" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8200/v1/pki/crl</a>"</span></pre><figure class="kq kr ks kt fq le fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff ln"><img src="../Images/bb724fc5cfc13a05bb47e692bbeb688b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y-9jNAHNIS8mIq5hmC07Dw.png"/></div></div></figure><h2 id="d2c1" class="jp jq hu bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj dt translated">创建角色</h2><p id="9b92" class="pw-post-body-paragraph ir is hu it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hn dt translated">我们将创建一个类似策略的角色，允许我们生成证书/密钥或凭据:</p><pre class="kq kr ks kt fq ku kv kw kx aw ky dt"><span id="75bc" class="jp jq hu kv b fv kz la l lb lc">vault write pki/roles/jerrycom allowed_domains="jerry.com" allow_subdomains="true" max_ttl="72h"</span></pre><figure class="kq kr ks kt fq le fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff lo"><img src="../Images/3a7fc31ca0ee6e46b572e2ed07f87994.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nVjlLLJ773N42bq1M0LBCg.png"/></div></div></figure><p id="31fb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，该策略允许我为jerry.com域生成凭据，并允许创建子域。</p><h2 id="4f19" class="jp jq hu bd jr js jt ju jv jw jx jy jz jc ka kb kc jg kd ke kf jk kg kh ki kj dt translated"><strong class="ak">发行crt和私钥</strong></h2><p id="7c60" class="pw-post-body-paragraph ir is hu it b iu kk iw ix iy kl ja jb jc km je jf jg kn ji jj jk ko jm jn jo hn dt translated">最后，我们可以通过tls创建我们需要在不同服务中使用的凭据</p><pre class="kq kr ks kt fq ku kv kw kx aw ky dt"><span id="4ea0" class="jp jq hu kv b fv kz la l lb lc">vault write pki/issue/jerrycom common_name=blah.jerry.com</span></pre><figure class="kq kr ks kt fq le fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff lp"><img src="../Images/9ee77ef57d9063b03d57ea6170682379.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*liZQiV1GBa7qPjHE89Cq5Q.png"/></div></div></figure><p id="56a0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">从上面的命令你会得到一把钥匙和一个阴极射线管，</p><pre class="kq kr ks kt fq ku kv kw kx aw ky dt"><span id="2fa6" class="jp jq hu kv b fv kz la l lb lc">-----BEGIN CERTIFICATE-----</span></pre><p id="ce8c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">和</p><pre class="kq kr ks kt fq ku kv kw kx aw ky dt"><span id="38c9" class="jp jq hu kv b fv kz la l lb lc">-----BEGIN RSA PRIVATE KEY-----</span></pre><p id="3d93" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您想验证这些是否匹配，因为crt已用私钥签名，请将crt保存在一个文件中，并将密钥保存在另一个文件中，然后运行:</p><p id="0e79" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于密钥:</p><pre class="kq kr ks kt fq ku kv kw kx aw ky dt"><span id="fab5" class="jp jq hu kv b fv kz la l lb lc">openssl rsa -noout -modulus -in vaultkey | md5sum</span></pre><figure class="kq kr ks kt fq le fe ff paragraph-image"><div class="fe ff lq"><img src="../Images/08a32df4260dcf6e466255f64b57d0eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*K0Bf67E9G06Yv9wxCsuW_g.png"/></div></figure><p id="336a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于阴极射线管:</p><pre class="kq kr ks kt fq ku kv kw kx aw ky dt"><span id="2182" class="jp jq hu kv b fv kz la l lb lc">openssl x509 -noout -modulus -in vaultcrt | md5sum</span></pre><figure class="kq kr ks kt fq le fe ff paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="fe ff lr"><img src="../Images/d1d08a05b4a17cfcc7dd32d3fad5ebc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AlkNBPw-oMK5h3dsuJRezQ.png"/></div></div></figure><p id="ffaa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">例如，您也可以将它们加载到nginx中，并用浏览器进行测试。</p><p id="97cc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">谢谢你。</p></div></div>    
</body>
</html>