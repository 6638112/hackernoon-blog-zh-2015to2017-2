<html>
<head>
<title>Testing Wordpress Themes and Plugins in Bitbucket Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Bitbucket管道中测试Wordpress主题和插件</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/testing-wordpress-themes-and-plugins-in-bitbucket-pipelines-2527f2729064?source=collection_archive---------6-----------------------#2017-09-29">https://medium.com/hackernoon/testing-wordpress-themes-and-plugins-in-bitbucket-pipelines-2527f2729064?source=collection_archive---------6-----------------------#2017-09-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/fb9bf63488ccb43a1e5a902930fe43bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jSZo-wiG5t8uHl3Kzy_zzw.png"/></div></div></figure><p id="2d1c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在过去的几天里，我和我的同事们正在寻找测试插件和主题的最佳方法，这些测试应该能够在我们的CI环境中运行，并确保在部署到某个地方之前一切都符合要求，这是我决定分享这个的主要原因，它可能会帮助许多寻找捷径和不想浪费时间的开发人员。</p><p id="29f9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">WordPress提供并支持一个单元测试框架，但是只针对核心开发。然而，带着一点好奇心，你可以用它来测试主题和插件。</p><h1 id="9013" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">步骤1:安装PHPUnit</h1><p id="c2ab" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">如果使用composer，只需使用以下命令安装PHPUnit:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="6ff6" class="ln kc hu lj b fv lo lp l lq lr">curl -sS <a class="ae ka" href="https://getcomposer.org/installer" rel="noopener ugc nofollow" target="_blank">https://getcomposer.org/installer</a> | php — — install-dir=/usr/local/bin — filename=composer</span></pre><p id="2ff0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">或者，您可以使用以下命令在本地环境中安装二进制文件:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="ea2e" class="ln kc hu lj b fv lo lp l lq lr">wget https://phar.phpunit.de/phpunit.phar<br/>chmod +x phpunit.phar<br/>mv phpunit.phar /usr/local/bin/phpunit</span></pre><p id="fdbe" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦安装了PHPUnit，您应该能够直接从终端运行该命令:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="0878" class="ln kc hu lj b fv lo lp l lq lr">phpunit — configuration=path/phpunit.xml </span></pre><p id="deff" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">或从您的供应商处获得:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="1564" class="ln kc hu lj b fv lo lp l lq lr">./vendor/bin/phpunit — configuration=path/phpunit.xml</span></pre><h1 id="352f" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">步骤2:获得WordPress框架并配置您的测试数据库</h1><p id="0326" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">Wordpress将其核心框架捆绑在一个svn repo中。我们可以通过查看includes目录下载我们想要的工具。</p><p id="a3e1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你想在哪里组织你的<a class="ae ka" href="https://hackernoon.com/tagged/testing" rel="noopener ugc nofollow" target="_blank">测试</a>库由你决定。对于我们的例子，我们将假设您将它克隆到您的WordPress根目录下的“tests”文件夹中。</p><p id="7d8e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">确保你选择的文件与你的Wordpress核心版本相匹配，在我们的例子中是Wordpress 4.3，进入终端并输入:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="2a92" class="ln kc hu lj b fv lo lp l lq lr">svn co develop.svn.wordpress.org/branches/<strong class="lj hv">4.3</strong>/tests/phpunit/includes/</span></pre><p id="326a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你将需要第二个Wordpress配置文件【wp-tests-config.php T4】，在那里你应该配置你的数据库和Wordpress站点信息，这里有一个例子:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="9deb" class="ln kc hu lj b fv lo lp l lq lr">https://develop.svn.wordpress.org/trunk/wp-tests-config-sample.php</span></pre><p id="a783" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">注意:确保你使用另一个数据库，因为Wordpress在测试过程中会删除并重新创建表格。</p><p id="c536" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在Mysql Host中，我们有2个不同的主机，“Mysql”和“127.0.0.1”，因此我们对配置文件做了一点修改，如下所示:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="d38b" class="ln kc hu lj b fv lo lp l lq lr">$remote = “mysql”;</span><span id="9f7d" class="ln kc hu lj b fv lt lp l lq lr">if(getenv(‘IS_PIPELINES’))</span><span id="7901" class="ln kc hu lj b fv lt lp l lq lr">   $remote = “127.0.0.1”;</span></pre><p id="7a60" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果我们从Docker容器运行测试，我们应该能够使用“mysql”主机进行连接，但在管道中却不是这样，因为我们定义了mysql服务，并且规则是不同的，请参见<a class="ae ka" href="https://confluence.atlassian.com/bitbucket/test-with-databases-in-bitbucket-pipelines-856697462.html" rel="noopener ugc nofollow" target="_blank">https://confluence . atlassian . com/bit bucket/test-with-databases-in-bit bucket-Pipelines-856697462 . html</a></p><h1 id="1a6c" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">步骤3:配置您的测试</h1><p id="cdcc" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">为此，我们将创建一个名为“phpunit.xml”的文件，我们将在其中放置我们的测试设置，无论您将它放在哪里，因为您总是可以在命令中指定它。</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="a3da" class="ln kc hu lj b fv lo lp l lq lr">&lt;phpunit <br/>	bootstrap=“./tests/includes/bootstrap.php"<br/>	backupGlobals="false"<br/>	colors="true"<br/>	convertErrorsToExceptions="true"<br/>	convertNoticesToExceptions="true"<br/>	convertWarningsToExceptions="true"&gt;<br/>	&lt;testsuites&gt;<br/>		&lt;testsuite&gt;<br/>			&lt;directory prefix="test-" suffix=".php"&gt;./tests/&lt;/directory&gt;<br/>		&lt;/testsuite&gt;<br/>	&lt;/testsuites&gt;<br/>&lt;/phpunit&gt;</span></pre><p id="7340" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们将运行前缀为“test-”的每个测试文件。/tests/"文件夹。</p><p id="e591" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在有了这个配置，你将只在Wordpress核心上运行测试，但是如果你需要在你自己的插件和主题上运行测试，我们将创建我们自己的引导文件:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="799b" class="ln kc hu lj b fv lo lp l lq lr">&lt;?php</span><span id="866b" class="ln kc hu lj b fv lt lp l lq lr">require_once dirname( dirname( __FILE__ ) ) . ‘/tests/includes/functions.php’;</span><span id="80ee" class="ln kc hu lj b fv lt lp l lq lr">function _manually_load_environment() {</span><span id="b32c" class="ln kc hu lj b fv lt lp l lq lr"><em class="ls">//</em> Add your theme …</span><span id="4a7c" class="ln kc hu lj b fv lt lp l lq lr">switch_theme(‘my_theme’);</span><span id="547f" class="ln kc hu lj b fv lt lp l lq lr"><em class="ls">//</em> Update array with plugins to include …</span><span id="c267" class="ln kc hu lj b fv lt lp l lq lr"><em class="ls">$plugins_to_active = array(</em></span><span id="df9c" class="ln kc hu lj b fv lt lp l lq lr"><em class="ls">‘your-plugin/your-plugin.php’</em></span><span id="8f3b" class="ln kc hu lj b fv lt lp l lq lr"><em class="ls">);</em></span><span id="3bed" class="ln kc hu lj b fv lt lp l lq lr">update_option( ‘active_plugins’, $plugins_to_active );</span><span id="ec58" class="ln kc hu lj b fv lt lp l lq lr">}</span><span id="ea48" class="ln kc hu lj b fv lt lp l lq lr">tests_add_filter( ‘muplugins_loaded’, ‘_manually_load_environment’ );</span><span id="8354" class="ln kc hu lj b fv lt lp l lq lr">require dirname( dirname( __FILE__ ) ) . ‘/tests/includes/bootstrap.php’;</span></pre><p id="987d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，我正在加载我的主题，以及让我的Wordpress工作所需的插件。</p><p id="eb7f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">不要忘记指向phpunit.xml上的新引导文件，如下所示:</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="68ac" class="ln kc hu lj b fv lo lp l lq lr">bootstrap="./bootstrap.php"</span><span id="a475" class="ln kc hu lj b fv lt lp l lq lr">backupGlobals="false"</span><span id="57ef" class="ln kc hu lj b fv lt lp l lq lr">...</span></pre><h1 id="3e6f" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">第四步:编写测试</h1><p id="62cd" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">你现在已经准备好了，像下面的例子一样编写你的第一个单元测试，检查主题是否正确加载。</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="ecbf" class="ln kc hu lj b fv lo lp l lq lr">&lt;?php</span><span id="fe48" class="ln kc hu lj b fv lt lp l lq lr">class VerificationTest extends <strong class="lj hv">WP_UnitTestCase</strong> {</span><span id="616d" class="ln kc hu lj b fv lt lp l lq lr">  function testTheme() {</span><span id="1c69" class="ln kc hu lj b fv lt lp l lq lr">       $this-&gt;assertTrue( ‘my_theme’ == wp_get_theme() );</span><span id="a58f" class="ln kc hu lj b fv lt lp l lq lr">  }</span><span id="38ea" class="ln kc hu lj b fv lt lp l lq lr">}</span></pre><p id="7e50" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">运行phpunit命令，您应该看到以下关于您的测试的信息:</p><figure class="le lf lg lh fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lu"><img src="../Images/b8acb357963c0d24a7848398c5bc1704.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xel6wKjiLaE81ggvgqYbSw.png"/></div></div></figure><h1 id="23bd" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">步骤5:这完全是关于CI(位桶管道)</h1><p id="f148" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">嗯，我想我们已经解决了这个问题，我们只需要调整它来运行Bitbucket内部的构建。阅读文档，我为我们的测试数据库使用了一个“mysql”服务。</p><figure class="le lf lg lh fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lv"><img src="../Images/f359998e541b37daf3fa11a85f2171d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JFSRwACoksB5XULpmvZuLQ.png"/></div></div></figure><p id="1f32" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请注意，您应该使用您在wp-tests-config.php文件中提到的相同凭据。</p><p id="f888" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我希望这将对你有用，如果有什么可以讨论或纠正的，欢迎你的评论。</p><p id="a96b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">谢谢你😃</p><figure class="le lf lg lh fq iv"><div class="bz el l di"><div class="lw lx l"/></div></figure></div></div>    
</body>
</html>