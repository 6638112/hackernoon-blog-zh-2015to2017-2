<html>
<head>
<title>Stateless end-to-end testing for web apps using Chrome, Lighthouse, and Treo</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Chrome、Lighthouse和Treo对web应用进行无状态端到端测试</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/stateless-end-to-end-testing-for-web-apps-7b54855f3c48?source=collection_archive---------12-----------------------#2017-10-23">https://medium.com/hackernoon/stateless-end-to-end-testing-for-web-apps-7b54855f3c48?source=collection_archive---------12-----------------------#2017-10-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/2e9670b7f966c1473789b3351211dc6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YaooEzYmS_IpTMofcpNchg.jpeg"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Photo by <a class="ae ih" href="https://unsplash.com/photos/ipyxkiJtdYI" rel="noopener ugc nofollow" target="_blank">Khai Sze Ong</a></figcaption></figure><div class=""/><p id="6573" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">本文介绍了使用<a class="ae ih" href="https://github.com/GoogleChrome/lighthouse" rel="noopener ugc nofollow" target="_blank"> Google Chrome的Lighthouse </a>和自动快照进行无状态端到端测试的想法。这种方法支持快速开发体验，并测试可用性、性能和质量回归。对于实际的例子，本文使用了<a class="ae ih" href="https://treo.sh/" rel="noopener ugc nofollow" target="_blank"> Treo </a>。</p><p id="c225" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在我们开始之前，让我们定义端到端测试，为什么它们是有价值的，为什么它们是难以开发的。</p><figure class="kg kh ki kj fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff kf"><img src="../Images/6fdb93147e6dca9c23ea484f1c3eec6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*agXMWNI2s6k9uVgPgDYshw.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Testing Pyramid (source <a class="ae ih" href="https://martinfowler.com/bliki/TestPyramid.html" rel="noopener ugc nofollow" target="_blank"><em class="kk">Martin Fowler</em></a><em class="kk">, triangle </em>authorship<em class="kk"> </em><a class="ae ih" href="http://slides.com/kentcdodds/testing-workshop#/4/8" rel="noopener ugc nofollow" target="_blank">Kent C. Dotts</a>)</figcaption></figure><p id="5260" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj il">端到端测试通过像真实用户一样使用系统来评估系统</strong>。与单元测试相比，它们更慢也更昂贵。但是他们通过验证整个系统依赖链带来了最大的信心。</p><p id="b1cf" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">让我们用E2E测试来分析这两个挑战。</p><p id="5235" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">端到端测试<strong class="jj il">慢</strong>。启动新的浏览器实例并加载页面需要时间。一个测试可能需要20秒，如果按顺序执行多个测试，可能需要几分钟。</p><p id="5742" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">E2E测试很昂贵或者很难开发和维护。首先，开发人员必须配置selenium或其他工具。处理缓慢的反馈循环和模糊的错误消息。部署到CI，这也是相当具有挑战性的。一个月后，这些测试开始失败，没有人了解它们是如何工作的，如何调试它们。我看到这个故事在不同的项目中不断重复。</p><p id="f4de" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们需要更好的东西。我们应该选择哪种<strong class="jj il">取舍</strong>来克服这些挑战？我们如何使端到端测试简单快速，但仍然有价值？</p><h1 id="98a6" class="kl km ik bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li dt translated">无状态端到端测试</h1><p id="bd80" class="pw-post-body-paragraph jh ji ik jj b jk lj jm jn jo lk jq jr js ll ju jv jw lm jy jz ka ln kc kd ke hn dt translated">根据我的经验，<strong class="jj il"/>80%的端到端测试值来自初始页面加载和页面上的检查数据。真实用户使用浏览器与生产环境进行交互。因此<strong class="jj il">如果从端到端测试，它必须是一个实际的部署和一个真正的浏览器。</strong></p><p id="b99a" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj il">定义</strong>:无状态端到端测试不会改变状态，允许并行执行和实际部署验证。</p><p id="d674" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj il">主要思想</strong>:将一个web应用程序描述为一组公开可用的URL，对每个URL执行<a class="ae ih" href="https://github.com/GoogleChrome/lighthouse" rel="noopener ugc nofollow" target="_blank"> Lighthouse </a>审计，将结果与之前成功运行的结果进行比较，以检测回归。</p><p id="3294" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果我们不为每个测试重置环境，我们可以并行执行测试。它极大地改善了反馈循环，并允许使用生产/试运行部署。</p><p id="3688" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果我们测试一个实际的部署，我们可以保证整个系统的可用性。(网络服务器、CDN、数据库、第三方服务)</p><p id="0084" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果不写手工期望，我们使用Lighthouse ( <a class="ae ih" href="https://github.com/GoogleChrome/lighthouse/graphs/contributors" rel="noopener ugc nofollow" target="_blank">和数百名开发人员的经验</a>)来评估页面属性并将其保存为快照。下次我们部署新版本时，我们可以确保页面与之前正确的评估相比没有变化。</p><p id="fc2d" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">值得一提的是，在新的部署<strong class="jj il">之后，所有的关键页面都可用，并且像以前一样运行</strong>。用户可以打开页面并开始与之交互。为了控制整个体验，监控运行时异常(用<a class="ae ih" href="https://rollbar.com/" rel="noopener ugc nofollow" target="_blank">滚动条</a>或<a class="ae ih" href="https://sentry.io" rel="noopener ugc nofollow" target="_blank">哨兵</a>)并立即修复它们。</p><p id="1c56" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">没有一种测试能够保证100%的防错性。我们需要在开发努力和价值之间保持平衡。通过使用无状态的端到端测试，我们以最小的努力获得了巨大的价值。根据我的经验，这种方法非常适合中小型项目。大型项目通常在监控、QA和定制流程方面投入巨大。</p><h1 id="f8c8" class="kl km ik bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li dt translated">使用<a class="ae ih" href="https://treo.sh/" rel="noopener ugc nofollow" target="_blank"> Treo </a>的示例</h1><p id="ea30" class="pw-post-body-paragraph jh ji ik jj b jk lj jm jn jo lk jq jr js ll ju jv jw lm jy jz ka ln kc kd ke hn dt translated"><a class="ae ih" href="https://treo.sh/" rel="noopener ugc nofollow" target="_blank"> Treo </a>是用于<a class="ae ih" href="https://github.com/GoogleChrome/lighthouse" rel="noopener ugc nofollow" target="_blank"> Lighthouse </a>的云基础设施，提供简单的端到端测试流程，并与Slack &amp; Github集成。</p><p id="94a5" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">使用Treo端到端测试设置只需点击几下鼠标。要执行测试，只需调用一个API，并在不到20秒的时间内接收Slack或电子邮件的状态更新。</p><figure class="kg kh ki kj fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff lo"><img src="../Images/16b9a6d71e9118ebf58d525a6c27ca3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GF9GPdzrRj8aob-sdmP4hQ.jpeg"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">A testing flow with Treo</figcaption></figure><h2 id="c4bc" class="lp km ik bd kn lq lr ls kr lt lu lv kv js lw lx kz jw ly lz ld ka ma mb lh mc dt translated">个人网站示例:<a class="ae ih" href="https://alekseykulikov.com" rel="noopener ugc nofollow" target="_blank">alekseykulikov.com</a></h2><p id="3047" class="pw-post-body-paragraph jh ji ik jj b jk lj jm jn jo lk jq jr js ll ju jv jw lm jy jz ka ln kc kd ke hn dt translated">让我们来看一个典型的个人网站:<a class="ae ih" href="https://alekseykulikov.com" rel="noopener ugc nofollow" target="_blank">https://alekseykulikov.com</a>。它包含三个页面:主页、博客和未找到。</p><figure class="kg kh ki kj fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff md"><img src="../Images/ad8255e12af7969a75c8d45464645fba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YDal_wAblchZWnQ4cf3omA.jpeg"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Typical personal website with three pages: Home, Blog, 404</figcaption></figure><p id="4a06" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj il">为什么要测试这个简单的网站？</strong>因为我是本地开发的，用git push部署。这是三个步骤:构建，上传到S3，使CloudFront发行版无效。我希望这个网站是可用的，性能和可访问的。我不想通过点击并运行每个页面的Lighthouse审计来手动验证部署。只是<strong class="jj il">一推就忘了</strong>。</p><p id="f3d1" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">循序渐进教程(<a class="ae ih" href="http://recordit.co/aRY5nyxrcj" rel="noopener ugc nofollow" target="_blank">视频</a>):</p><ol class=""><li id="32af" class="me mf ik jj b jk jl jo jp js mg jw mh ka mi ke mj mk ml mm dt translated">使用Github账号登录<a class="ae ih" href="https://treo.sh" rel="noopener ugc nofollow" target="_blank"> https://treo.sh </a>(免费试用~500审核)。</li><li id="5fb2" class="me mf ik jj b jk mn jo mo js mp jw mq ka mr ke mj mk ml mm dt translated">点击“添加新测试套件”并命名；</li><li id="ebc6" class="me mf ik jj b jk mn jo mo js mp jw mq ka mr ke mj mk ml mm dt translated">添加三个带有标题和URL的页面；</li><li id="d52d" class="me mf ik jj b jk mn jo mo js mp jw mq ka mr ke mj mk ml mm dt translated">点击“创建”，等待几秒钟，看看结果；</li><li id="1b75" class="me mf ik jj b jk mn jo mo js mp jw mq ka mr ke mj mk ml mm dt translated">使用来自Git的自动消息复制curl命令来部署脚本。</li></ol><pre class="kg kh ki kj fq ms mt mu mv aw mw dt"><span id="3f67" class="lp km ik mt b fv mx my l mz na">MESSAGE=`git log --format=%B -n 1 $sha1 | xargs`<br/>curl <a class="ae ih" href="https://api.treo.sh/v1/suites/8" rel="noopener ugc nofollow" target="_blank">https://api.treo.sh/v1/suites/1</a> \<br/>  -H "Authorization: Bearer xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" \<br/>  -d message="$MESSAGE"</span></pre><p id="33ce" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">下一次，我在<a class="ae ih" href="https://alekseykulikov.com/blog" rel="noopener ugc nofollow" target="_blank"> /blog </a>上做了更改并破坏了可访问性，Treo通知我:</p><figure class="kg kh ki kj fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nb"><img src="../Images/6e318c6a1a1e554a5f942d13e3f82bcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qyl5_slQF4A_BpYOWTi8-w.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Failed Report</figcaption></figure><h2 id="49c5" class="lp km ik bd kn lq lr ls kr lt lu lv kv js lw lx kz jw ly lz ld ka ma mb lh mc dt translated">Web应用示例:<a class="ae ih" href="https://treo.sh" rel="noopener ugc nofollow" target="_blank"> treo.sh </a></h2><p id="9b6d" class="pw-post-body-paragraph jh ji ik jj b jk lj jm jn jo lk jq jr js ll ju jv jw lm jy jz ka ln kc kd ke hn dt translated">Treo使用自身进行测试。这是一个有16个不同页面的SPA。测试过程类似于第一个例子，但有一些改进。在美国/欧盟地区，它使用cookies进行身份验证，并使用特殊页面进行性能监控。</p><figure class="kg kh ki kj fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nc"><img src="../Images/66862eff74f64edb7cf21683282d66f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E-MRgPUXWAXDqQfmyrVmwA.jpeg"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Examples of <a class="ae ih" href="https://treo.sh" rel="noopener ugc nofollow" target="_blank">treo.sh</a> UI</figcaption></figure><p id="7e04" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">用一组URL来描述一个SPA是很自然的。通常，每个URL都是一个路由器条目。每个条目都是具有自定义逻辑的独立视图。加载视图与前一次运行没有任何不同，这为它继续工作提供了可靠的保证。</p><p id="1a18" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在Treo的开发过程中，我发现了很多使用Treo的bug。损坏的页面、失败的Webpack构建、可访问性和性能退化。这让我对这种方法充满信心。对于投入的时间来说，无状态端到端测试是最有用的一种测试。接下来，进行单元测试，但这是<a class="ae ih" href="https://github.com/testdouble/contributing-tests/wiki/Testing-Pyramid" rel="noopener ugc nofollow" target="_blank">完全不同的故事</a>。</p></div><div class="ab cl nd ne hc nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="hn ho hp hq hr"><p id="5bcd" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我期待听到来自社区的<strong class="jj il">反馈</strong>！让我们在twitter <a class="ae ih" href="https://twitter.com/alekseykulikov_" rel="noopener ugc nofollow" target="_blank"> @alekseykulikov_ </a>或评论中讨论一个无状态端到端测试的想法。</p><p id="dec8" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">同样，它<strong class="jj il">不是</strong>通用的方法。对于中小型项目来说，这是实现更好的质量和更快的发布周期的一组权衡。</p><p id="6605" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果您在配置Treo方面需要任何支持，请联系我:<a class="ae ih" href="mailto:info@treo.sh" rel="noopener ugc nofollow" target="_blank"> info@treo.sh </a>。我很乐意帮助您的团队定义最重要的网页，并期待灯塔的结果。</p><p id="7186" class="pw-post-body-paragraph jh ji ik jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">让我们构建可靠的web应用程序。测试愉快！👍</p></div></div>    
</body>
</html>