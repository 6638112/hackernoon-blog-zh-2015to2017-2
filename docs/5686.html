<html>
<head>
<title>Creating an Army of Docker Containers using SaltStack, Boto3 &amp; CloudInit on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS上使用SaltStack、Boto3和CloudInit创建大量Docker容器</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/creating-an-army-of-docker-containers-using-saltstack-boto3-cloudinit-on-aws-cfd048e9c116?source=collection_archive---------8-----------------------#2017-08-10">https://medium.com/hackernoon/creating-an-army-of-docker-containers-using-saltstack-boto3-cloudinit-on-aws-cfd048e9c116?source=collection_archive---------8-----------------------#2017-08-10</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="d66c" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">放弃</h2></div><p id="2d66" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">此内容是我们在线课程/培训的一部分/灵感来源。在2019年黑色星期五期间，我们对这些材料提供高达80%的折扣。</p><p id="ede3" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您可以在这里享受您的<a class="ae kf" href="http://bf.eralabs.io" rel="noopener ugc nofollow" target="_blank">折扣。</a></p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><a href="http://bf.eralabs.io"><div class="fe ff kg"><img src="../Images/f322772403668f8316905cec24b85586.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B0qBLWIa0zP-zJcrenZN8w.png"/></div></a></figure></div><div class="ab cl ko kp hc kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="hn ho hp hq hr"><p id="c402" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">不将基础设施作为代码来实施的开发运维转型仍将是不完整的:基础设施自动化是现代数据中心的支柱。</p><p id="9b5c" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">有了SaltStack和Docker这样的工具，事情变得更容易了。</p><p id="fc0a" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">本教程是<a class="ae kf" href="http://painlessdocker.com/" rel="noopener ugc nofollow" target="_blank">无痛码头工人课程</a>的一部分。</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><a href="http://painlessdocker.com"><div class="fe ff kv"><img src="../Images/d12dd3968885f04d94fb3957176c31c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:400/format:webp/1*LnEd0hpeb817zM3rynBytw.jpeg"/></div></a></figure><p id="1be1" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果您有兴趣了解我们关于AWS的新课程，<a class="ae kf" href="https://eon01.typeform.com/to/MMPiyz" rel="noopener ugc nofollow" target="_blank">使用此表格</a>注册，我们将与您分享有趣的内容！</p><p id="3d73" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jl hv">更新:</strong></p><blockquote class="kw"><p id="659b" class="kx ky hu bd kz la lb lc ld le lf ke ek translated"><em class="lg">在将这个故事分享给Reddit后，我看到一些评论说我正在重新发明AWS Lambda或一般的无服务器系统。</em></p><p id="d527" class="kx ky hu bd kz la lb lc ld le lf ke ek translated"><em class="lg">我想说耶！为什么不呢！？</em></p><p id="74cd" class="kx ky hu bd kz la lb lc ld le lf ke ek translated">毕竟，这个课程的目的是教育，你可以把它当作一个反向黑客。</p><p id="8187" class="kx ky hu bd kz la lb lc ld le lf ke ek translated"><em class="lg">黑客快乐！</em></p></blockquote><h1 id="94ba" class="lh li hu bd lj lk ll lm ln lo lp lq lr ja ls jb lt jd lu je lv jg lw jh lx ly dt translated">介绍</h1><p id="2ae8" class="pw-post-body-paragraph jj jk hu jl b jm lz iv jo jp ma iy jr js mb ju jv jw mc jy jz ka md kc kd ke hn dt translated">我们将使用一组工具，如SaltStack、Boto3 (Python3)、AWS CLI、EC2，来创建一个主容器和一些运行Docker容器的附属容器。</p><p id="7c5c" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这张图表解释了我们将要做的许多事情。</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="fe ff me"><img src="../Images/fa00cd745b9c274b98ec82f466e7ec89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hjjmR6ZK9jcKFXY7lENlwA.png"/></div></div></figure><h1 id="a356" class="lh li hu bd lj lk ll lm ln lo lp lq lr ja mj jb lt jd mk je lv jg ml jh lx ly dt translated">使用AWS CLI创建第一台EC2机器</h1><p id="52c1" class="pw-post-body-paragraph jj jk hu jl b jm lz iv jo jp ma iy jr js mb ju jv jw mc jy jz ka md kc kd ke hn dt translated">我们需要VPC的ID、安全组的ID、子网的ID、密钥对的名称以及我们要使用的操作系统的AMI(Ubuntu 16.04)。后者取决于区域。</p><h2 id="2541" class="mm li hu bd lj mn mo mp ln mq mr ms lr js mt mu lt jw mv mw lv ka mx my lx mz dt translated">描述VPCs</h2><p id="8dd8" class="pw-post-body-paragraph jj jk hu jl b jm lz iv jo jp ma iy jr js mb ju jv jw mc jy jz ka md kc kd ke hn dt translated">让我们看看作为VPC我们有什么:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="b8df" class="mm li hu nb b fv nf ng l nh ni">aws ec2 describe-vpcs</span></pre><p id="e65f" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您应该会得到一个活动VPC的详细列表:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="60c3" class="mm li hu nb b fv nf ng l nh ni">{<br/>    "Vpcs": [<br/>        {<br/>            "DhcpOptionsId": "dopt-xxxxxx",<br/>            "CidrBlock": "172.31.0.0/16",<br/>            "InstanceTenancy": "default",<br/>            "State": "available",<br/>            "IsDefault": true,<br/>            "VpcId": "vpc-xxxxx"<br/>        },<br/>        {<br/>            "DhcpOptionsId": "dopt-xxxxx",<br/>            "CidrBlock": "172.20.0.0/16",<br/>            "InstanceTenancy": "default",<br/>            "State": "available",<br/>            "Tags": [<br/>                {<br/>                    "Key": "xxxxx",<br/>                    "Value": "xxxxx"<br/>                },<br/>                {<br/>                    "Key": "xxxxxx",<br/>                    "Value": "xxxxx"<br/>                },<br/>                {<br/>                    "Key": "xxxxxx",<br/>                    "Value": "xxxxxx"<br/>                }<br/>            ],<br/>            "IsDefault": false,<br/>            "VpcId": "vpc-xxxxxx"<br/>        }<br/>    ]<br/>}</span></pre><h2 id="d7e6" class="mm li hu bd lj mn mo mp ln mq mr ms lr js mt mu lt jw mv mw lv ka mx my lx mz dt translated">列出安全组</h2><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="0b08" class="mm li hu nb b fv nf ng l nh ni">aws ec2 describe-security-groups</span></pre><p id="7951" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您应该得到一个列表:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="8b2e" class="mm li hu nb b fv nf ng l nh ni">{<br/>      "IpPermissionsEgress": [<br/>        {<br/>          "IpProtocol": "-1",<br/>          "IpRanges": [<br/>            {<br/>              "CidrIp": "0.0.0.0/0"<br/>            }<br/>          ],<br/>          "UserIdGroupPairs": [<br/>            <br/>          ],<br/>          "PrefixListIds": [<br/>            <br/>          ]<br/>        }<br/>      ],<br/>      "Tags": [<br/>        {<br/>          "Key": "Name",<br/>          "Value": "xxxxxx"<br/>        }<br/>      ],<br/>      "OwnerId": "xxxxx",<br/>      "GroupName": "xxxxxxxx",<br/>      "VpcId": "vpc-xxxxxxx",<br/>      "Description": "xxxxxx",<br/>      "IpPermissions": [<br/>        {<br/>          "IpProtocol": "-1",<br/>          "IpRanges": [<br/>            {<br/>              "CidrIp": "0.0.0.0/0"<br/>            }<br/>          ],<br/>          "UserIdGroupPairs": [<br/>            <br/>          ],<br/>          "PrefixListIds": [<br/>            <br/>          ]<br/>        },<br/>        {<br/>          "IpRanges": [<br/>            {<br/>              "CidrIp": "0.0.0.0/0"<br/>            }<br/>          ],<br/>          "ToPort": 22,<br/>          "UserIdGroupPairs": [<br/>            <br/>          ],<br/>          "PrefixListIds": [<br/>            <br/>          ],<br/>          "IpProtocol": "tcp",<br/>          "FromPort": 22<br/>        },<br/>        {<br/>          "IpRanges": [<br/>            {<br/>              "CidrIp": "0.0.0.0/0"<br/>            }<br/>          ],<br/>          "ToPort": 2376,<br/>          "UserIdGroupPairs": [<br/>            <br/>          ],<br/>          "PrefixListIds": [<br/>            <br/>          ],<br/>          "IpProtocol": "tcp",<br/>          "FromPort": 2376<br/>        }<br/>      ],<br/>      "GroupId": "sg-xxxxxx"<br/>    }    <br/>    ...</span></pre><h2 id="9ac9" class="mm li hu bd lj mn mo mp ln mq mr ms lr js mt mu lt jw mv mw lv ka mx my lx mz dt translated">描述可用性区域和选择AMI:</h2><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="aeb9" class="mm li hu nb b fv nf ng l nh ni">aws ec2 describe-availability-zones</span></pre><p id="8f57" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">即使我们不打算直接使用它来查找AMI，我们也应该首先获得这些信息:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="1239" class="mm li hu nb b fv nf ng l nh ni">{<br/>    "AvailabilityZones": [<br/>        {<br/>            "Messages": [],<br/>            "RegionName": "eu-west-1",<br/>            "ZoneName": "eu-west-1a",<br/>            "State": "available"<br/>        },<br/>        {<br/>            "Messages": [],<br/>            "RegionName": "eu-west-1",<br/>            "ZoneName": "eu-west-1b",<br/>            "State": "available"<br/>        },<br/>        {<br/>            "Messages": [],<br/>            "RegionName": "eu-west-1",<br/>            "ZoneName": "eu-west-1c",<br/>            "State": "available"<br/>        }<br/>    ]<br/>}</span></pre><p id="7189" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">因为我要用Ubuntu，所以我用了这个网站:<a class="ae kf" href="https://cloud-images.ubuntu.com/locator/ec2/" rel="noopener ugc nofollow" target="_blank">https://cloud-images.ubuntu.com/locator/ec2/</a></p><h2 id="db70" class="mm li hu bd lj mn mo mp ln mq mr ms lr js mt mu lt jw mv mw lv ka mx my lx mz dt translated">描述子网</h2><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="3a5f" class="mm li hu nb b fv nf ng l nh ni">aws ec2 describe-subnets</span></pre><p id="bf80" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">你会得到一个类似的列表:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="4fb9" class="mm li hu nb b fv nf ng l nh ni">{<br/>            "AvailableIpAddressCount": 4091,<br/>            "MapPublicIpOnLaunch": true,<br/>            "AvailabilityZone": "eu-west-1b",<br/>            "VpcId": "vpc-xxxxxx",<br/>            "State": "available",<br/>            "DefaultForAz": true,<br/>            "CidrBlock": "172.31.0.0/20",<br/>            "Tags": [<br/>                {<br/>                    "Value": "xxxxxxxxxx",<br/>                    "Key": "Name"<br/>                }<br/>            ],<br/>            "SubnetId": "subnet-xxxxxxxxxx"<br/>        }</span></pre><h2 id="f53f" class="mm li hu bd lj mn mo mp ln mq mr ms lr js mt mu lt jw mv mw lv ka mx my lx mz dt translated">获取密钥对</h2><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="2576" class="mm li hu nb b fv nf ng l nh ni">aws ec2 describe-key-pairs</span></pre><p id="c510" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">它将显示现有密钥对的列表:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="a9e4" class="mm li hu nb b fv nf ng l nh ni">{<br/>    "KeyPairs": [<br/>        {<br/>            "KeyFingerprint": "xxxxxxxxxxx",<br/>            "KeyName": "xxxxxxxx"<br/>        },<br/>        {<br/>            "KeyFingerprint": "xxxxxxxxx",<br/>            "KeyName": "xxxxxxxx"<br/>        }<br/>    ]<br/>}</span></pre><h2 id="fed7" class="mm li hu bd lj mn mo mp ln mq mr ms lr js mt mu lt jw mv mw lv ka mx my lx mz dt translated">让我们创造机器</h2><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="af1b" class="mm li hu nb b fv nf ng l nh ni">aws ec2 run-instances --image-id ami-785db401 --count 1 --instance-type t2.micro --key-name .xxxxx --security-group-ids sg-xxxxx --subnet-id subnet-xxxxx --associate-public-ip-address --query 'Instances[0].InstanceId' --output text</span></pre><p id="f8cc" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这应该向我们显示实例的id:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="b173" class="mm li hu nb b fv nf ng l nh ni">i-0ed688fc95b1feeb2</span></pre><h2 id="0515" class="mm li hu bd lj mn mo mp ln mq mr ms lr js mt mu lt jw mv mw lv ka mx my lx mz dt translated">获取公共DNS</h2><p id="052b" class="pw-post-body-paragraph jj jk hu jl b jm lz iv jo jp ma iy jr js mb ju jv jw mc jy jz ka md kc kd ke hn dt translated">为了使用SSH连接，我们应该得到这个！</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="956b" class="mm li hu nb b fv nf ng l nh ni">aws ec2 describe-instances --instance-ids i-0ed688fc95b1feeb2 --query 'Reservations[0].Instances[0].PublicDnsName' --output text</span></pre><p id="bdb9" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">输出结果是:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="6552" class="mm li hu nb b fv nf ng l nh ni">ec2-34-253-201-12.eu-west-1.compute.amazonaws.com</span></pre><h2 id="e68e" class="mm li hu bd lj mn mo mp ln mq mr ms lr js mt mu lt jw mv mw lv ka mx my lx mz dt translated">让我们试试公共IP吧！</h2><p id="42a9" class="pw-post-body-paragraph jj jk hu jl b jm lz iv jo jp ma iy jr js mb ju jv jw mc jy jz ka md kc kd ke hn dt translated">与DNS相同，类型:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="fa33" class="mm li hu nb b fv nf ng l nh ni">aws ec2 describe-instances --instance-ids i-0ed688fc95b1feeb2 --query 'Reservations[0].Instances[0].PublicIpAddress' --output text</span></pre><p id="4cad" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">输出:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="0b83" class="mm li hu nb b fv nf ng l nh ni">34.253.201.12</span></pre><h2 id="d609" class="mm li hu bd lj mn mo mp ln mq mr ms lr js mt mu lt jw mv mw lv ka mx my lx mz dt translated">我需要私有IP</h2><p id="3d48" class="pw-post-body-paragraph jj jk hu jl b jm lz iv jo jp ma iy jr js mb ju jv jw mc jy jz ka md kc kd ke hn dt translated">在我的例子中，我将使用私有IP将Salt Minion连接到Salt Master，如果您将在同一个VPC中创建两台机器，也可以这样做。</p><p id="ebbd" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果您想使用私有IP:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="fb2d" class="mm li hu nb b fv nf ng l nh ni">aws ec2 describe-instances --instance-ids i-0ed688fc95b1feeb2 --query 'Reservations[0].Instances[0].PrivateIpAddress' --output text</span></pre><p id="9df2" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">输出:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="c364" class="mm li hu nb b fv nf ng l nh ni">172.31.4.106</span></pre><h2 id="a462" class="mm li hu bd lj mn mo mp ln mq mr ms lr js mt mu lt jw mv mw lv ka mx my lx mz dt translated">安装主设备</h2><p id="57d3" class="pw-post-body-paragraph jj jk hu jl b jm lz iv jo jp ma iy jr js mb ju jv jw mc jy jz ka md kc kd ke hn dt translated">使用公共DNS和您的密钥对连接到创建的机器:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="0080" class="mm li hu nb b fv nf ng l nh ni">apt install salt-master</span></pre></div><div class="ab cl ko kp hc kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="hn ho hp hq hr"><h1 id="750c" class="lh li hu bd lj lk nj lm ln lo nk lq lr ja nl jb lt jd nm je lv jg nn jh lx ly dt translated">使用Boto3和Cloudinit创建和配置多个Minion机器</h1><p id="d6df" class="pw-post-body-paragraph jj jk hu jl b jm lz iv jo jp ma iy jr js mb ju jv jw mc jy jz ka md kc kd ke hn dt translated">要使用Boto3 (Python)，如果不想安装到机器上，可以创建一个Python虚拟环境。我在任何情况下都是这么做的。</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="b657" class="mm li hu nb b fv nf ng l nh ni">virtualenv -p python3 learning</span><span id="a2e7" class="mm li hu nb b fv no ng l nh ni">cd learning/<br/>. bin/activate<br/>pip install boto3<br/>mkdir app &amp;&amp; cd app</span></pre><p id="4489" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在让我们创建Python脚本:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="49e4" class="mm li hu nb b fv nf ng l nh ni">import boto3<br/>import sys</span><span id="5189" class="mm li hu nb b fv no ng l nh ni">AWS_ACCESS_ID = "xxxxxxxxxx"<br/>AWS_SECRET_KEY = "x/xxxxxx"<br/>ImageId = "ami-785db401"<br/>KeyName = ".xx"<br/>InstanceType = "t2.micro"</span><span id="5fce" class="mm li hu nb b fv no ng l nh ni">MinCount = 1<br/>MaxCount = 1<br/>SubnetId = "subnet-xxxxx" <br/>SecurityGroupIds = ["sg-xxxxxx"]<br/>UserData = open('init.sh')</span><span id="ab6e" class="mm li hu nb b fv no ng l nh ni">conn = boto3.client(<br/>    'ec2',<br/>    aws_access_key_id=AWS_ACCESS_ID,<br/>    aws_secret_access_key=AWS_SECRET_KEY<br/>)</span><span id="3c6c" class="mm li hu nb b fv no ng l nh ni">for i in range( int(sys.argv[1]) ):<br/>    reservation = conn.run_instances(ImageId=ImageId,<br/>                                 KeyName=KeyName,<br/>                                 InstanceType=InstanceType,<br/>                                 MinCount=MinCount,<br/>                                 MaxCount=MaxCount,<br/>                                 SecurityGroupIds=SecurityGroupIds,                                <br/>             SubnetId = SubnetId,<br/>                                 UserData=UserData.read())</span></pre><p id="43e0" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这是用户数据文件:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="8264" class="mm li hu nb b fv nf ng l nh ni">#!/bin/bash</span><span id="9432" class="mm li hu nb b fv no ng l nh ni">#<a class="ae kf" href="https://alestic.com/2010/12/ec2-user-data-output/" rel="noopener ugc nofollow" target="_blank">https://alestic.com/2010/12/ec2-user-data-output/</a><br/>exec &gt; &gt;(tee /var/log/user-data.log|logger -t user-data -s 2&gt;/dev/console) 2&gt;&amp;1<br/>echo BEGIN</span><span id="8388" class="mm li hu nb b fv no ng l nh ni">sudo apt-get update -y<br/>sudo apt-get upgrade -y</span><span id="d09d" class="mm li hu nb b fv no ng l nh ni"># Install saltstack<br/>sudo apt-get install salt-minion -y</span><span id="42b0" class="mm li hu nb b fv no ng l nh ni"># Set salt master location and start minion<br/>sudo sed -i 's/#master: salt/master: 34.253.201.12/g' /etc/salt/minion<br/>sudo salt-minion -d</span><span id="bca3" class="mm li hu nb b fv no ng l nh ni"># Install Docker<br/>curl -fsSL <a class="ae kf" href="https://download.docker.com/linux/ubuntu/gpg" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/ubuntu/gpg</a> | sudo apt-key add -</span><span id="c9e4" class="mm li hu nb b fv no ng l nh ni">sudo add-apt-repository \<br/>   "deb [arch=amd64] <a class="ae kf" href="https://download.docker.com/linux/ubuntu" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/ubuntu</a> \<br/>   $(lsb_release -cs) \<br/>   stable" -y   <br/>   <br/>sudo apt-get update -y || :<br/>sudo apt-get install docker-ce -y</span><span id="9724" class="mm li hu nb b fv no ng l nh ni">sudo apt install python-pip -y &amp;&amp; sudo pip install docker-py -y</span><span id="0358" class="mm li hu nb b fv no ng l nh ni">echo END</span></pre><p id="5718" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">它将在机器启动时通过安装Salt Minion和Docker来配置机器。</p><p id="33b6" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">请注意，在上面的脚本中，我们已经将minion的服务器设置为master的私有IP地址。</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="f5d1" class="mm li hu nb b fv nf ng l nh ni">sudo sed -i 's/#master: salt/master: 34.253.201.12/g' /etc/salt/minion</span></pre><p id="292e" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">要创建5台机器，只需键入:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="656c" class="mm li hu nb b fv nf ng l nh ni">python &lt;script_name&gt; 5</span></pre><p id="9b7c" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">要运行1000台机器，只需键入:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="e27d" class="mm li hu nb b fv nf ng l nh ni">python &lt;script_name&gt; NO WAY :)</span></pre><p id="756b" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在我们有5台机器安装了Salt Minion和Docker以及一个Salt Master。</p></div><div class="ab cl ko kp hc kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="hn ho hp hq hr"><h1 id="e697" class="lh li hu bd lj lk nj lm ln lo nk lq lr ja nl jb lt jd nm je lv jg nn jh lx ly dt translated">连接奴才和主人</h1><p id="d971" class="pw-post-body-paragraph jj jk hu jl b jm lz iv jo jp ma iy jr js mb ju jv jw mc jy jz ka md kc kd ke hn dt translated">在主类型上:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="9357" class="mm li hu nb b fv nf ng l nh ni">salt-key -L<br/></span></pre><p id="8654" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">你会得到等待被接受的奴才:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="806b" class="mm li hu nb b fv nf ng l nh ni">Accepted Keys:<br/>Denied Keys:<br/>Unaccepted Keys:<br/>ip-172-31-5-169.eu-west-1.compute.internal<br/>ip-172-31-5-168.eu-west-1.compute.internal<br/>ip-172-31-5-167.eu-west-1.compute.internal<br/>ip-172-31-5-166.eu-west-1.compute.internal<br/>ip-172-31-5-165.eu-west-1.compute.internal<br/>ip-172-31-5-164.eu-west-1.compute.internal<br/>..etc</span><span id="24eb" class="mm li hu nb b fv no ng l nh ni">Rejected Keys:</span></pre><p id="5305" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">接受所有使用:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="1e7c" class="mm li hu nb b fv nf ng l nh ni">salt-key -A</span></pre><p id="7deb" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">然后取消注释/etc/salt/master中的以下部分:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="2d25" class="mm li hu nb b fv nf ng l nh ni">file_roots:<br/>  base:<br/>    - /srv/salt</span></pre><p id="13ef" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们将在上述位置为盐状态和盐高状态设置一个文件服务器。现在重新启动主服务器:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="86e5" class="mm li hu nb b fv nf ng l nh ni">pkill salt-master<br/>salt-master -d</span></pre><p id="30e9" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">为了在Minions上安装Docker容器，您不应该忘记这一点:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="4e37" class="mm li hu nb b fv nf ng l nh ni">salt * pip.install docker-py&gt;=1.4.0</span></pre><p id="6af8" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">该命令将安装Python docker包1.4.0的更高版本。</p><p id="804a" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在创建两个文件，顶层文件</p><blockquote class="kw"><p id="acb8" class="kx ky hu bd kz la lb lc ld le lf ke ek translated">在Salt中，包含网络上的机器组和应该应用于它们的配置角色之间的映射的文件被称为<code class="eh np nq nr nb b">top file</code>。</p></blockquote><p id="7b51" class="pw-post-body-paragraph jj jk hu jl b jm ns iv jo jp nt iy jr js nu ju jv jw nv jy jz ka nw kc kd ke hn dt translated">和SLS文件:</p><blockquote class="kw"><p id="0670" class="kx ky hu bd kz la lb lc ld le lf ke ek translated">盐态系统的核心是SLS，或者说<strong class="ak">S</strong>a<strong class="ak">L</strong>t<strong class="ak">S</strong>tate文件。SLS是系统应该处于的状态的表示，并且被设置为以简单的格式包含该数据。这通常被称为配置管理。</p></blockquote><p id="0d75" class="pw-post-body-paragraph jj jk hu jl b jm ns iv jo jp nt iy jr js nu ju jv jw nv jy jz ka nw kc kd ke hn dt translated"><em class="nx">(两个引语均引自官方盐业文献)</em></p><p id="0a7a" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">下面是文件树的结构:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="9bc1" class="mm li hu nb b fv nf ng l nh ni">tree /srv/salt/</span><span id="9ca4" class="mm li hu nb b fv no ng l nh ni">/srv/salt/<br/>├── top.sls<br/>└── webserver.sls</span></pre></div><div class="ab cl ko kp hc kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="hn ho hp hq hr"><h1 id="d556" class="lh li hu bd lj lk nj lm ln lo nk lq lr ja nl jb lt jd nm je lv jg nn jh lx ly dt translated">启动码头集装箱</h1><p id="f8fb" class="pw-post-body-paragraph jj jk hu jl b jm lz iv jo jp ma iy jr js mb ju jv jw mc jy jz ka md kc kd ke hn dt translated">我们将运行多个Nginx容器。Nginx在这里只是一个例子，你可以运行任何你想要的镜像。</p><p id="bc1f" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们来修改一下webserver.sls的内容，告诉高手运行Nginx:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="e052" class="mm li hu nb b fv nf ng l nh ni">my_service:<br/>  dockerng.running:<br/>    - name: nginx<br/>    - image: nginx</span></pre><p id="5819" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在让我们修改顶层文件的内容，并告诉主服务器将状态应用到以Ubuntu为操作系统的服务器上。这是一种瞄准技术，您可以选择任何其他瞄准模式。</p><p id="7bb3" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">(阅读这篇文章了解更多信息:<a class="ae kf" href="https://docs.saltstack.com/en/latest/topics/targeting/" rel="noopener ugc nofollow" target="_blank">https://docs.saltstack.com/en/latest/topics/targeting/</a>)</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="882e" class="mm li hu nb b fv nf ng l nh ni">#top.sls file</span><span id="6221" class="mm li hu nb b fv no ng l nh ni">base:<br/>  'os:Ubuntu':<br/>    - match: grain<br/>    - webserver</span></pre><p id="30ec" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">要启动容器，请键入:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="29b3" class="mm li hu nb b fv nf ng l nh ni">salt '*' state.apply</span></pre><p id="d184" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您将获得执行日志:</p><pre class="kh ki kj kk fq na nb nc nd aw ne dt"><span id="8cfe" class="mm li hu nb b fv nf ng l nh ni">[...]<br/>ip-172-31-5-169.eu-west-1.compute.internal:<br/>----------<br/>          ID: my_service<br/>    Function: dockerng.running<br/>        Name: nginx<br/>      Result: True<br/>     Comment: Container 'nginx' is already configured as specified<br/>     Started: 01:03:40.062033<br/>    Duration: 28.66 ms<br/>     Changes:</span><span id="efd0" class="mm li hu nb b fv no ng l nh ni">Summary for ip-172-31-5-169.eu-west-1.compute.internal<br/>------------<br/>Succeeded: 5<br/>Failed:    0<br/>------------<br/>Total states run:     5</span></pre><p id="32ae" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">Salt、Docker、Boto3和AWS的这种组合可以用于不同的自动化场景，甚至用于自我修复和自动扩展的基础设施。</p><p id="d003" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">你可以在我的<a class="ae kf" href="http://painlessdocker.com" rel="noopener ugc nofollow" target="_blank">无痛码头工课程</a>里找到类似的教程。</p><p id="d8e4" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><em class="nx">都是乡亲们！</em></p></div><div class="ab cl ko kp hc kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="hn ho hp hq hr"><h1 id="1e9e" class="lh li hu bd lj lk nj lm ln lo nk lq lr ja nl jb lt jd nm je lv jg nn jh lx ly dt translated">连接更深</h1><p id="e074" class="pw-post-body-paragraph jj jk hu jl b jm lz iv jo jp ma iy jr js mb ju jv jw mc jy jz ka md kc kd ke hn dt translated">如果你对这篇文章产生了共鸣，你可以在<a class="ae kf" href="http://painlessdocker.com" rel="noopener ugc nofollow" target="_blank">无痛码头工课程</a>中找到更多有趣的内容。</p><p id="99ba" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果您喜欢本课程，请订阅我们的一份或多份简讯:</p><ul class=""><li id="52bd" class="ny nz hu jl b jm jn jp jq js oa jw ob ka oc ke od oe of og dt translated"><a class="ae kf" href="http://devopslinks.com/" rel="noopener ugc nofollow" target="_blank">devo PS links</a>:devo PS生态系统发展迅速。每周，我们都会精心策划必读新闻、教程、评论等等！</li><li id="aad5" class="ny nz hu jl b jm oh jp oi js oj jw ok ka ol ke od oe of og dt translated"><a class="ae kf" href="http://joinshipped.com" rel="noopener ugc nofollow" target="_blank">发货</a>:关注无服务器、集装箱、FaaS &amp;和其他有趣事物的独立时事通讯</li><li id="6c54" class="ny nz hu jl b jm oh jp oi js oj jw ok ka ol ke od oe of og dt translated"><a class="ae kf" href="http://kaptain.xyz/" rel="noopener ugc nofollow" target="_blank"> Kaptain </a>:一个#Kubernetes社区中心，手动策划时事通讯，团队聊天，培训&amp;更多</li></ul><p id="2f0a" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">你可以在<a class="ae kf" href="https://twitter.com/eon01" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae kf" href="https://clarity.fm/aymenelamri/" rel="noopener ugc nofollow" target="_blank"> Clarity </a>或者我的<a class="ae kf" href="http://aymenelamri.com" rel="noopener ugc nofollow" target="_blank">网站</a>上找到我，你也可以查看我的书:<a class="ae kf" href="http://saltstackfordevops.com" rel="noopener ugc nofollow" target="_blank"> SaltStack For DevOps </a>。</p><p id="b90e" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">别忘了加入我们的求职板<a class="ae kf" href="http://jobsfordevops.com" rel="noopener ugc nofollow" target="_blank">devo PS</a>求职！</p><figure class="kh ki kj kk fq kl fe ff paragraph-image"><div class="ab fr cl om"><img src="../Images/9be788c6c2620a6f8af98543b867b658.png" data-original-src="https://miro.medium.com/v2/1*koUfnfQ-YkmwubsUs4zwwQ.gif"/></div></figure><p id="b6b5" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果你喜欢这篇文章，请推荐它并与你的追随者分享。</p></div></div>    
</body>
</html>