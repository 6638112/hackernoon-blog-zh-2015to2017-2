<html>
<head>
<title>EternalPulsar — A practical example of a made up name</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">永恒脉冲星——一个虚构名字的实际例子</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/eternalpulsar-a-practical-example-of-a-made-up-name-629737170a9e?source=collection_archive---------3-----------------------#2017-04-19">https://medium.com/hackernoon/eternalpulsar-a-practical-example-of-a-made-up-name-629737170a9e?source=collection_archive---------3-----------------------#2017-04-19</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="ccd5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" rel="noopener" href="/@xNymia/eternalpulsar-a-weekend-with-the-nsas-finest-29620f8757b9">昨天</a>我们讨论了这个周末的ShadowBrokers转储(我建议你在继续这里之前阅读它),并注意到在大约32个exploit转储中，有几个引起了我们的注意，并且在过去几天里非常有趣。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff jq"><img src="../Images/5e4f88df0f3d49a01643f3cd5e9a487c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*OMe_EP8CRMotz-wjzkrPRg.png"/></div></figure><p id="4cdc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">EasyFun 2.2.0 (EAFU)，这是对WDaemon / MDaemon WorldClient(一种仍然非常常用的邮件服务器)的一些旧版本的利用。该漏洞针对9.5.6及更早版本。目前的版本是18，所以这些目标应该很少，对不对？不对。</p><p id="a4e4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">仍然有超过5000个已识别的潜在攻击目标，太棒了！</p><p id="5ae9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来是本文的主要话题；Windows操作系统中SMBv2服务的EternalBlue漏洞与DoublePulsar dropper结合使用，可用于上传恶意. dll。</p><p id="daac" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">事实上，这种攻击非常非常简单，这让它变得更加可怕。我们将在EternalBlue(EB)上使用<a class="ae jp" href="https://hackernoon.com/tagged/fuzzbunch" rel="noopener ugc nofollow" target="_blank"> FuzzBunch </a>框架(我们之前讨论过的)，在Windows 7机器上开发SMBv2服务。DoublePulsar(DoPu)将作为我们的后门和shellscript执行平台上传，我们的有效载荷将是meter preter(MSF)的x64版本reverse_tcp。我已经开始称这个过程为“<em class="jy">永恒脉冲星</em>”，还有更多酷的名字，我们永远也取不够！</p></div><div class="ab cl jz ka hc kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hn ho hp hq hr"><p id="4731" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我在实验室环境中测试了EternalPulsar，设置如下:</p><p id="8a52" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Windows 8.1(攻击者—<strong class="it hv">192 . 168 . 1 . 252</strong>)<br/>Windows 7(受害者—<strong class="it hv">192 . 168 . 1 . 123</strong>)<br/>kali Linux(MSF Handler—<strong class="it hv">192 . 168 . 1 . 193</strong>)</p><p id="283e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们将经历的简单阶段有:<br/> <strong class="it hv">有效载荷创建</strong> &gt; <strong class="it hv"> EB利用</strong> &gt; <strong class="it hv"> MSF设置</strong> &gt; <strong class="it hv"> DoPu上传</strong> &gt; <strong class="it hv">扎根！</strong></p><p id="b226" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"><em class="jy">Payload</em></strong>:<br/>这个超级简单，我们只需要用msfvenom创建一个. DLL，它会回调我们的MetaSploit监听器。我们的目标是x64架构，所以让我们确保使用正确的架构(最初我没有这样做，当DoublePulsar指责我时，我打了自己一巴掌)。设置您想要回调的机器的IP地址，在本例中是我们的Kali实例和您将要监听的端口。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff kg"><img src="../Images/c0afaadd1822e830e964dac0e886d948.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zOa6q3X6LXKZCqxBAUDffA.png"/></div></div><figcaption class="kl km fg fe ff kn ko bd b be z ek">Nothing decidedly complex here simple reverse_tcp that we’ve all used.</figcaption></figure><p id="ecbc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="jy"> EB漏洞利用:<br/> </em> </strong>就像MetaSploit框架一样，FuzzBunch允许你‘使用’和配置漏洞利用及其有效载荷。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff kp"><img src="../Images/1886e73a131b307f535f8e88c6972b09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/1*smCL-BCp-Fk-sCWA_k9pcw.png"/></div><figcaption class="kl km fg fe ff kn ko bd b be z ek">FuzzBunch configuration and execution of EternalBlue</figcaption></figure><p id="63cd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于此处的示例，我已经配置了目标和参数，但它们是不言自明的，您可以选择:<br/> -目标IP <br/> -目标端口<br/> -回调IP <br/> -确认目标操作系统<br/> -利用尝试次数<br/> -目标可利用性<br/> -定义传送类型<br/> -用于转发的远程IP/端口(旋转)</p><p id="be80" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，在询问我们是否准备好利用漏洞之前，我们会得到设置的最终验证。<br/>该过程的其余部分连接到目标设备，确认其操作系统与基于漏洞利用的配置所期望的相匹配，并且该漏洞利用尚未安装。SMBv1用于连接并在内存中创建一个缓冲区，该缓冲区将被释放，供我们的漏洞利用代码驻留(释放后使用)。</p><p id="ed9f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们的漏洞利用代码被上传，植入物被放置，然后它向FuzzBunch发送一个返回代码，让我们知道它已经成功了。这已被确定为将SMB多路复用ID设置为值82 (52 00h)。这不是此处的标准值，但有助于我们创建用于识别漏洞的签名，我们将在本文末尾介绍:</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff kq"><img src="../Images/42e1be8632bd3f19e17e7e616e108962.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*dQLobDhRjPAVRSRlT0HWRg.png"/></div><figcaption class="kl km fg fe ff kn ko bd b be z ek">Multiplex ID = 82</figcaption></figure><p id="0e95" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="jy"> MSF设置:</em> </strong> <br/>下一步将我们带回到MetaSploit，创建一个简单的处理程序来接收我们的reverse_tcp有效负载将执行的连接。我们有我们预期的有效载荷，监听机器的IP(把它弄对，否则你会在0.0.0.0上结束监听；)和我们在有效负载中配置的端口。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff kr"><img src="../Images/3225af9a83a5b952c0bcaa01376d4eeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*cEfzgPy2LDFX0DmYOVbPpw.png"/></div></div><figcaption class="kl km fg fe ff kn ko bd b be z ek">MetaSploit Reverse TCP Handler</figcaption></figure><p id="6b1f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="jy"> DoPu上传:<br/> </em> </strong>我们终于准备好上传我们的DoublePulsar后门和有效载荷给受害者了。随着EternalBlue的推出，我们得到的配置选项基本相同，只是我们被要求提供DoublePulsar安装后要执行的有效载荷的详细信息。在这种情况下，我们使用我们的“meter.dll ”,这是我们在阶段1中设置的已配置的meterpreter reverse_tcp，以及我们要注入的进程的名称，最好总是使用标准的windows进程，这样我们就可以确定它在那里。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff ks"><img src="../Images/a8d6b61f9309746a97bd24d2cb14dc28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1030/format:webp/1*Ic8Ar0APJ-oD9nMoVRKWyA.png"/></div></figure><p id="9c70" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们正在破坏<a class="ae jp" href="https://hackernoon.com/tagged/security" rel="noopener ugc nofollow" target="_blank">安全性</a>，所以让我们只使用<em class="jy">lsass.exe</em>这是方便的默认设置，我们再次确认我们正在攻击的协议(nbt也是一个需要进一步研究的选项)和目标机器的架构。</p><p id="e5b2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们得到回报，确认双脉冲星后门已经正确启动，然后。DLL外壳代码已经构建并注入。</p><p id="4edc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">老实说，她就写了这么多！</p><p id="3cb2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="jy">扎根！:<br/> </em> </strong>我们可以在我们的MetaSploit处理程序中看到，我们甚至不需要做任何进一步的事情，我们的“<em class="jy">meter.dll</em>”中包含的有效负载已经被执行并被回调到Kali实例。在目标系统上，我们可以看到我们的注入流程、我们的shell以及到我们的登台系统的连接。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff kt"><img src="../Images/704a71d368c2934bb29db53df447558f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h2vL4IJeFO6MDmHP3DqwBg.png"/></div></div></figure><p id="006a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们使用MetaSploit访问我们拥有的shell，可以看到，正如我们所料，我们拥有用户“nt authority\SYSTEM”的完全系统访问权限，如果您不熟悉windows系统，这是最高级别的权限，例如root。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff ku"><img src="../Images/f8d8e579c4dd9e18ab43d4452bb465b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8RwndSL8b9GZKv-n_R5_uw.png"/></div></div><figcaption class="kl km fg fe ff kn ko bd b be z ek">.DLL execution called back to Kali and we just grab a shell</figcaption></figure></div><div class="ab cl jz ka hc kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="hn ho hp hq hr"><p id="b00f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">那么，我们能对此做些什么呢？正如我们昨天谈到的<a class="ae jp" href="https://technet.microsoft.com/en-us/library/security/ms17-010.aspx" rel="noopener ugc nofollow" target="_blank">MS17–010</a>是为比VistaSP2更新的系统发布的，它修补了这些漏洞，使您超级安全*！(*由此，暂且)。</p><p id="661a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">修补、禁用CIFS/中小企业是您的最佳选择，可以保护您免受这种重复利用。此外，我们还花了一些时间来分析由EternalBlue专门生成的SMB流量。我们发现的两个工件是，安装(如上所示)返回了一个82的复用ID，连接到当前的EternalBlue注入(它已经被利用，有些连接到当前的有效负载)的复用ID是81。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff kv"><img src="../Images/302494cda6d6cadc9b071a8a632006ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/1*wIILHA_a2CqdrCGa0jLjHg.png"/></div><figcaption class="kl km fg fe ff kn ko bd b be z ek">EternalBlue connection to pre-installed backdoor value 81</figcaption></figure><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff kq"><img src="../Images/42e1be8632bd3f19e17e7e616e108962.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*dQLobDhRjPAVRSRlT0HWRg.png"/></div><figcaption class="kl km fg fe ff kn ko bd b be z ek">EternalBlue initial exploitation success value 82</figcaption></figure><p id="9fe5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这些MID值不被用作标准SMB协议的一部分，因此是创建规则的一个相当好的基础(至少这是我一直工作和创建工作规则所使用的)。</p><p id="13b7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，我们在Suricata内部确定这些的规则集是这样的(它们有点原始，我没有写太多签名):</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff kw"><img src="../Images/4df3b04b1b3f672bdcabaf4347ba9f3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KWVXJQ_kczvxsNALxkZddg.png"/></div></div><figcaption class="kl km fg fe ff kn ko bd b be z ek">MID=81 — Someone is successfully connecting to EternalBlue</figcaption></figure><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff kw"><img src="../Images/25a1c3bb77c1e9a718d9f0eb0654808e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NI4WeClPx-kS0zjPZIg7OQ.png"/></div></div><figcaption class="kl km fg fe ff kn ko bd b be z ek">MID=82 - Someone has potentially managed to install EternalBlue</figcaption></figure><p id="7629" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这些规则在我的实验室Suricata实例中进行了测试，并在我的测试以及Eric Conrad通过twitter提供的PCAPs上运行。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff kx"><img src="../Images/9c28ae0fa24eef98b9b0ae76e6352c7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4g0lEL5NUWDncbsNN5mEHQ.png"/></div></div><figcaption class="kl km fg fe ff kn ko bd b be z ek">Ignore the ET, I based my rules on their EternalRomance rule, because I’m a noob :P</figcaption></figure><p id="e3ce" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可以从我的github获取这些签名的完整版本:<a class="ae jp" href="https://github.com/xNymia/Suricata-Signatures" rel="noopener ugc nofollow" target="_blank">https://github.com/xNymia/Suricata-Signatures</a></p><p id="3134" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我看来，这将是一个长期的问题。我在做Pentest gigs时看到的大量系统都有大量过时的补丁，系统管理员或开发人员丢弃了Windows Server 2008的测试机器，这些机器没有打补丁，Windows 7家用机器禁用了自动更新。我们都知道它会发生，我们都讨厌它。现在它要咬我们了。很难。</p><p id="e7b8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">更不要想所有的人都在生产环境中使用非法获得的windows版本。会让你头疼的。</p><div class="jr js jt ju fq ab cb"><figure class="ky jv kz la lb lc ld paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="ky jv kz la lb lc ld paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="ky jv kz la lb lc ld paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="le lf lg"><p id="f922" class="ir is jy it b iu iv iw ix iy iz ja jb lh jd je jf li jh ji jj lj jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is jy it b iu iv iw ix iy iz ja jb lh jd je jf li jh ji jj lj jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="fe ff lk"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="ll lm l"/></div></figure></div></div>    
</body>
</html>