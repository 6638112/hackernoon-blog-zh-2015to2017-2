<html>
<head>
<title>Help! My Azure Site Performance Sucks! — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">救命啊！我的Azure网站表现太差了！—第一部分</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/help-my-azure-site-performance-sucks-part-1-5a3a1b048ac0?source=collection_archive---------3-----------------------#2017-12-21">https://medium.com/hackernoon/help-my-azure-site-performance-sucks-part-1-5a3a1b048ac0?source=collection_archive---------3-----------------------#2017-12-21</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/3f77822c8e5ac333928df2e7bfc8551e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*60Ig0PMfhS2QwYKnfQlvUg.jpeg"/></div></div></figure><div class=""/><p id="8d83" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">注</strong> <br/>你可以在这里查看该系列的<a class="ae ka" href="https://blog.usejournal.com/help-my-azure-site-performance-sucks-part-2-df28f40b3778" rel="noopener ugc nofollow" target="_blank"> <strong class="je ig">第二部</strong> </a>和<a class="ae ka" rel="noopener" href="/@bryan_soltis/help-my-azure-site-performance-sucks-part-3-744dc54297f3"> <strong class="je ig">第三部</strong> </a> <strong class="je ig"> </strong>。</p><p id="6fc9" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我猜猜。你已经看到了云的曙光，并将你的应用程序迁移到了微软Azure。你的网站托管在一个足以运行一个比特币大矿的应用服务上，你的数据库是SQL SaaS的技术奇观。你让公司里的每个人一起把你扔在他们的肩膀上，惊叹你新的云动力创造，它的性能…嗯…糟透了。在你把你的网站滚回储藏室的486DX之前，让我在这个由两部分组成的博客系列中给你一些关于如何让它在微软的云中平稳运行的提示。</p><p id="f1c1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我和Azure合作了很长时间。用技术术语来说，我想我是云计算的曾祖父。如果不是这样，至少有一个远房亲戚会出现在家庭聚餐上并偷邮票。不管怎样，自2008年以来，我已经为它创建了应用程序，写了关于它的文章，为它举办了训练营，并尽可能在每个街角挥舞Azure旗帜。我喜欢这个平台，并不断惊讶于你可以用它实现多少目标。作为一名Azure MVP，在我参加的每个会议、活动、代码营、婚礼和家长会上，我都让每个人知道与云一起工作有多棒。是的，我有点喜欢和Azure一起工作。</p><p id="f83a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但是说实话，在云端运行的时候，事情并不总是一帆风顺的。我见过在一个环境中可以快如闪电的应用程序在部署到Azure时会爬行到14.4K的速度。我遇到过最有经验的软件工程师，他们质疑这个平台的一切，质疑它为什么能在如此糟糕的延迟和性能下如此出色。他们对他们的部署感到困惑，没有明显的理由来解释他们痛苦缓慢的站点。</p><p id="1b2d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我完全明白了！云被吹捧为能解决你的问题的神奇技术！</p><p id="8e66" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但是这惊人的速度是怎么回事呢？！？这些年来，我与许多客户和开发人员合作，帮助他们回答这个关于Azure应用程序的问题。让我来阐明这些可能性…</p><h1 id="efd5" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated"><strong class="ak">阅读手册</strong></h1><p id="de74" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">Azure表现不佳的最大原因之一归结于教育。对于刚刚开始使用云并且没有完全理解平台是什么的开发人员来说尤其如此。蔚蓝不是一个东西。这是成百上千的东西(而且还在增长！).它包括基础架构、连接性、功能性、可扩展性和灵活性，所有这些都包含在一个五个字母的名称中，似乎没有人能够就如何发音达成一致。由于其巨大的能力，完全掌握所有的单个棋子可能是一项艰巨的任务，尤其是如果你是游戏新手。</p><p id="19a4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">每当我开始诊断某人的Azure困境时，我首先会确定他们对云了解多少。他们知道为什么云计算会存在吗？他们了解云服务和应用服务吗？他们是将自己的应用程序搬到了云上，还是从一开始就在云上构建了应用程序？他们手头有任何Azure的专业知识吗，或者他们即兴发挥了？当谈到为什么选择特定的架构或配置时，这些都是重要的因素，如果处理不当，可能会导致很长的应用程序加载时间。</p><h1 id="bc3f" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated"><strong class="ak">移除变量</strong></h1><p id="283c" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">作为任何试图找出只有会计部的Linda才能发现的幻影错误的开发人员，在确定Azure站点性能不佳的原因时，您需要采取一种务实的方法。尽可能多地排除等式。如果你的环境中有100个变量，你会花大部分时间寻找和啄你的方式疯狂。给自己省点头痛(和治疗)，尽可能地消除那些不三不四的人。</p><p id="8c4e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您在同一台服务器上有多个应用程序，请将它们隔离到各自的实例中。您的应用程序数据库和存储是否位于不同的数据中心？建立自己的三人公司集，获得同一地区的所有资源。这个问题是只发生在经过身份验证的用户身上还是发生在网站的特定区域？尝试找出共同点以帮助隔离问题。</p><p id="d65a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">知道什么不该看是解决你的表现问题的最好方法之一。</p><h1 id="6269" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated"><strong class="ak">是什么导致了这个问题？</strong></h1><figure class="lf lg lh li fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff le"><img src="../Images/16bbc1fa7af42ace92d19af416408b31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8kR6p8k3ZeLTbVQObPaFoA.jpeg"/></div></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">I combined decks to make it more exciting!</figcaption></figure><p id="dc06" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">好的，所以你知道你的团队在Azure-ology方面是熟练的，并且你已经尽可能多地去除了变量。现在，您需要开始尝试找出问题所在。如果你幸运的话，是环境中的一个单一因素导致了这个问题。如果是这样的话，停下手头的工作，去买张彩票什么的。</p><p id="fc23" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">很有可能，你会有几个导致你悲伤的因素。你只需要弄清楚哪些是。你需要准备好改变不止一件事。在许多情况下，部署的几个方面都会导致速度变慢。</p><p id="10f7" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig"> App服务</strong></p><p id="33a1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">确定web服务器(应用服务)是否是问题的根源往往是一个非常简单的过程。在Azure门户中，您可以检查服务器性能，并查看您的CPU和内存是否出现峰值。如果你发现你的应用程序经常导致你的服务器达到最大限度，你应该开始考虑扩大或缩小。Azure最好的部分之一是能够快速扩展你的web环境，如果需要的话可以自动扩展。查看您的应用服务计划设置并进行调整，直到获得您想要的性能。</p><p id="bd65" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是解决性能问题最简单的方法之一，但前提是您的问题与web服务器相关。老实说，我很少把应用程序服务视为问题的原因。通常，这是一个与数据和/或架构相关的问题。如果服务器看起来像铁皮人的EKG(没有心跳，也就是没有尖峰信号)，那就该继续搜索了。</p><p id="2dff" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">数据库</strong></p><p id="a729" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">许多开发人员将从在SQL数据库(或Azure SQL…或SQL Azure…或Azure的SQL数据库)中托管他们的数据库开始。我见过不少改名的。).而且理由很充分！这是一个非常可伸缩的SQL环境，每月只需几美元(取决于您的需求)。您的数据会自动复制到后端进行灾难恢复，您可以通过SSMS轻松部署数据库，并在几秒钟内连接到您的网站。有什么不喜欢的？？</p><p id="65c7" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">嗯，有一种被称为<a class="ae ka" href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-what-is-a-dtu" rel="noopener ugc nofollow" target="_blank"> DTU(数据库吞吐量单元)</a>的神秘生物多年来一直困扰着开发者。dtu不是一个单一的度量单位，而是Microsoft用来计算数据库消耗的资源的变量集合。这些是CPU、内存和读写速率。(相信我，九年过去了，我还是有点迷茫)。微软使用dtu来计算你的数据库在消耗什么样的资源，以确保平台上的每个人都物有所值。</p><p id="af17" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当谈到表现不佳的Azure网站时，DTU峰值通常是讨论的焦点。无论是长时间运行的查询、性能不佳的索引，还是导致过多调用的糟糕代码，超负荷工作的SQL数据库都会降低任何应用程序的速度。如果你发现你的SQL数据库正在崩溃和挣扎，查看Azure门户网站的支持和故障排除部分寻求帮助。使用这些工具来找出哪些查询占用了最多的时间，以及您的dtu何时达到峰值。</p><p id="b7b4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig"> DTU问题可能是我在过去9年里见过的最常见的问题。</strong></p><h1 id="bacb" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">提供图像</h1><figure class="lf lg lh li fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff ln"><img src="../Images/dc03e9c0d32c031769b31f75c4a0c75e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2eFkmqsTay7jGZgzNSvyUA.jpeg"/></div></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">Just hold that position for another 32 minutes.</figcaption></figure><p id="4150" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">回到关于教育的第一点，处理图像是我最常看到开发人员没有发挥Azure潜力的地方。当涉及到媒体时，开发人员应该重新思考“随站点部署”模式，并探索Azure可以提供的独特功能。因为Azure存储非常灵活(并且易于配置)，在应用程序中不对图像使用它是一个巨大的错误，可能会让你的网站损失很多宝贵的性能。Azure CDN功能包含在存储中，因此从数据中心的全球网络(而不是部署站点的地方)提供站点媒体可以大大加快整个站点的加载时间。</p><p id="115e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">此外，将您的图像卸载到CDN意味着更少调用您的主URL来加载内容，这意味着更好的并行请求管理。</p><h1 id="8ac7" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">也许这是代码</h1><figure class="lf lg lh li fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff lo"><img src="../Images/e26a3a1208cf2cc71d6078e01947512e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6_bjXQCTGkbHS9Dw1R79LQ.jpeg"/></div></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">Aww, man! I got the Gray Screen of Death!</figcaption></figure><p id="0aba" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">再多的内存、处理器或服务器也无法修复糟糕的代码。当所有的架构领域都解决了，而一个站点仍然很慢时，我总是会询问定制功能。这是事情变得棘手的地方，并且需要很多时间。</p><p id="b927" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你在你的网站上使用第三方平台，很可能该公司已经花了很多时间来确保产品的“普通”版本可以在任何环境下运行。考虑到这一点，您的自定义代码可能是罪魁祸首。确保你的代码库是最新的，然后开始挖掘你的功能。</p><p id="8ab7" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您需要确保尽可能高效地访问数据。您是否利用缓存和供应商API在内存中存储数据？您是否只撤回了您需要的数据，从而减少了总体负载？你是否试图在你的自定义功能中除以零或者其他产生虫洞的行为？</p><p id="52b8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">你需要挖掘你的每一段代码，并确保它尽可能的优化。不幸的是，修改代码从来都不是一件容易的事情，你必须为之准备一顿午餐，尤其是如果你隔壁小隔间的实习生编写了整个联系人管理模块。</p><p id="1b5d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这里勤奋是关键，所以不要偷工减料！确保检查任何具有数据库连接、内存访问或依赖于外部系统的功能。了解如何利用Azure缓存和存储来提高速度和延迟。你可能会发现你需要更新网站的几个部分。蔚蓝是一座需要攀登的大山，所以一步一步来。</p><h1 id="8fef" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated"><strong class="ak">思考问题的时间</strong></h1><p id="39e3" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">好吧，所以你现在的思维可能有点像《权力的游戏》中的家谱。您可能已经处理了站点中所有可能需要更新、配置和返工的地方。我要在这里结束这个博客，给你时间来处理事情。在我的下一篇文章中，我将给出我的建议，告诉你应该如何设计你的Azure应用程序，以便在未来最大限度地减少性能问题。它还将包含更多关于识别问题、实施权宜解决方案和构建更好的Azure网站的步骤的提示。下次见，朋友们。</p><h1 id="8b4f" class="kb kc if bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated"><strong class="ak">更新！</strong></h1><p id="8f01" class="pw-post-body-paragraph jc jd if je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">想获得一些真正的提示和技巧吗？看看这个系列的<a class="ae ka" rel="noopener" href="/@bryan_soltis/help-my-azure-site-performance-sucks-part-2-df28f40b3778"> <strong class="je ig">第二部</strong> </a>！</p></div></div>    
</body>
</html>