<html>
<head>
<title>GraphQL nested mutations with Apollo: small fatigue, max gain</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">阿波罗的GraphQL嵌套突变:小疲劳，最大增益</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/graphql-nested-mutations-with-apollo-small-fatigue-max-gain-1020f627ea2e?source=collection_archive---------1-----------------------#2017-02-10">https://medium.com/hackernoon/graphql-nested-mutations-with-apollo-small-fatigue-max-gain-1020f627ea2e?source=collection_archive---------1-----------------------#2017-02-10</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><h1 id="75a8" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">现场</h1><p id="5a4d" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">我正在做一些实验，我想在React项目中用GraphQL做些尝试。我已经对GraphQL有所了解，但我从未真正自己使用过它。</p><p id="e480" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">我开始寻找一个好的GraphQL后端，我选择了目前最好的graph cool(T2 ):有很多指南和教程，可以与其他服务集成，非常灵活，对开发者免费。亮绿灯！</p><p id="a6ba" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">Graphcool有针对<a class="ae ks" href="http://www.apollodata.com/" rel="noopener ugc nofollow" target="_blank"> Apollo </a>和Relay的快速入门指南，但我已经决定使用什么，所以我开始在我的React项目中使用它:</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="7629" class="lc is hu ky b fv ld le l lf lg">"apollo-client": "^0.8.1",<br/>"graphql-tag": "^1.2.3",<br/>"react-apollo": "^0.9.0",</span></pre><h1 id="7dc6" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">任务</h1><p id="ca8c" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">我想一些不那么原创但总是很有趣的东西:乐队、专辑、歌曲等等..总是比<a class="ae ks" href="https://en.wikipedia.org/wiki/List_of_fictional_Microsoft_companies" rel="noopener ugc nofollow" target="_blank"> Northwind Traders或Contoso Ltd. </a>:)更令人兴奋</p><p id="425e" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">所以我只想从/向Graphcool读取/写入数据。</p><p id="76af" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">在GraphQL中，当你想读的时候你需要<a class="ae ks" href="http://dev.apollodata.com/react/queries.html" rel="noopener ugc nofollow" target="_blank">查询</a>，当你想写的时候你需要<a class="ae ks" href="http://dev.apollodata.com/react/mutations.html" rel="noopener ugc nofollow" target="_blank">突变</a>。</p><p id="848b" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated"><em class="lh">我写的不是查询，因为这个故事的重点是嵌套突变，因为查询得到了很好的解释，我在实现过程中没有遇到任何问题。</em></p><p id="0345" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">让派对开始吧</p><p id="2689" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">用Graphcool“控制台”(一个很棒的数据库建模界面)，我创建了一个粗略的结构。</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="4791" class="lc is hu ky b fv ld le l lf lg">type Band {<br/>  name: String!<br/>  country: String<br/>  website: String<br/>  members: [Person]<br/>  contact: Person<br/>  albums: [Album]<br/>}</span><span id="f99c" class="lc is hu ky b fv li le l lf lg">type Person {<br/>  firstName: String!<br/>  lastName: String!<br/>}</span><span id="d467" class="lc is hu ky b fv li le l lf lg">type Album {<br/>  name: String!<br/>  year: Int!<br/>  songs: [Song]<br/>}</span><span id="d58b" class="lc is hu ky b fv li le l lf lg">type Song {<br/>  trkNr: Int<br/>  title: String!<br/>  duration: String<br/>}</span></pre><p id="3f0b" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">如您所见，我们从乐队模型的相册字段开始，在两个不同的级别上嵌套了两个数组。</p><p id="46b9" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">所以，为了清楚起见，我想使用一些关于STORMO音乐乐队的数据来存储所有这些信息，并且我想用一个单独的突变来实现它！</p><h1 id="8564" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">问题是</h1><p id="9206" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">派对突然崩溃(STORMO停止播放！)当我意识到我不知道如何创建嵌套变异，也没有(无论如何非常好的)Apollo文档可以帮助我时。</p><p id="3af4" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">此外，我有足够的勇气使用数组，现在我的眼睛迷失在窗口中… <code class="eh lj lk ll ky b">the physical one!!</code></p><h1 id="e36f" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">帮助</h1><p id="3d30" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">在一些不值得一提的尝试之后，我决定使用<a class="ae ks" href="https://slack.graph.cool/" rel="noopener ugc nofollow" target="_blank">salvitic Graphcool slack support</a>，在那里我开始在通用频道跟踪。</p><p id="56c7" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">Graphcool员工Nilan Marktanner 立即开始帮助我，当我最终以一种可理解的方式解释了我的情况后，他递给我…</p><h1 id="48ae" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">解决方案</h1><p id="8061" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">感谢尼兰，我明白了三件事:</p><ul class=""><li id="a5a2" class="lo lp hu jr b js kn jw ko ka lq ke lr ki ls km lt lu lv lw dt translated">及时援助的重要性，是的，还有它的美妙之处</li><li id="abe8" class="lo lp hu jr b js lx jw ly ka lz ke ma ki mb km lt lu lv lw dt translated"><a class="ae ks" href="https://www.graph.cool/blog/improving-dx-with-nested-mutations-vietahx7ih" rel="noopener ugc nofollow" target="_blank">graph cool上的嵌套突变得到改进，更易于使用</a></li><li id="89fd" class="lo lp hu jr b js lx jw ly ka lz ke ma ki mb km lt lu lv lw dt translated">当你写一个嵌套的变异时，没有必要写嵌套对象的类型！</li></ul><p id="3af0" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">这正是我所需要的。</p><h1 id="f05f" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">代码时间</h1><p id="5850" class="pw-post-body-paragraph jp jq hu jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hn dt translated">我必须制造的变异</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="a57d" class="lc is hu ky b fv ld le l lf lg">mutation {<br/>  createBand(<br/>    name: "Stormo"<br/>    country: "Italy"<br/>    website: "<a class="ae ks" href="https://stormo.bandcamp.com/" rel="noopener ugc nofollow" target="_blank">https://stormo.bandcamp.com/</a>"<br/>    members: [{<br/>      firstName: "Luca"<br/>      lastName: "Rocco"<br/>    }, {<br/>      firstName: "Federico"<br/>      lastName: "Trimeri"<br/>    }, {<br/>      firstName: "Giacomo"<br/>      lastName: "Rento"<br/>    }, {<br/>      firstName: "Gabriele"<br/>      lastName: "Coldepin"<br/>    }]<br/>    contact: {<br/>      firstName: "Giacomo"<br/>      lastName: "Rento"<br/>    }<br/>    albums: [{<br/>      name: "SOSPESI NEL VUOTO BRUCEREMO IN UN ATTIMO E IL CERCHIO SARÀ CHIUSO"<br/>      year: 2014<br/>      songs: [{<br/>        trkNr: 1<br/>        title: "In Volo"<br/>        duration: "02:50" <br/>      }, {<br/>        trkNr: 2<br/>        title: "Supernova"<br/>        duration: "02:10" <br/>      }, {<br/>        trkNr: 3<br/>        title: "Fuga"<br/>        duration: "01:24" <br/>      }, {<br/>        trkNr: 4<br/>        title: "Perchè La Bambina Cade"<br/>        duration: "02:46" <br/>      }]<br/>    }, {<br/>      name: "7"<br/>      year: 2009<br/>      songs: [{<br/>        trkNr: 1<br/>        title: "Incosiderata Putrefazione"<br/>        duration: "03:18"<br/>      }, {<br/>        trkNr: 2<br/>        title: "Abbandono La Mia Volontà"<br/>        duration: "03:20"<br/>      }]<br/>    }, {<br/>      name: "Self-Titled EP"<br/>      year: 2007<br/>      songs: [{<br/>        trkNr: 4<br/>        title: "Quando Non Ci Sei"<br/>        duration: "02:08" <br/>      }, {<br/>        trkNr: 5<br/>        title: "Al Punto Di Non Ritorno"<br/>        duration: "04:36" <br/>      }]<br/>    }]<br/>  ) {<br/>    id<br/>    members {<br/>      id<br/>    }<br/>    contact {<br/>      id<br/>    }<br/>    albums {<br/>      id<br/>      songs {<br/>        id<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="8433" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">使用Apollo Client，我用GraphQL变量指定输入参数，所以让我们看看它在这种情况下是怎样的:</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="597d" class="lc is hu ky b fv ld le l lf lg">import gql from 'graphql-tag';</span><span id="b258" class="lc is hu ky b fv li le l lf lg">const BandMutation = gql`<br/>  mutation (<br/>    $name: String!<br/>    $country: String<br/>    $website: String<br/>    $Members: [Person]<br/>    $Contact: Person<br/>    $Albums: [Albums]<br/>  ) {<br/>    createBand(<br/>      name: $name<br/>      Country: $Country<br/>      Members: $Members<br/>      Contact: $Contact<br/>      Albums: $Albums<br/>    ) {<br/>      id<br/>      members {<br/>        id<br/>      }<br/>      contact {<br/>        id<br/>      }<br/>      albums {<br/>        id<br/>        songs {<br/>          id<br/>        }<br/>      }<br/>    }<br/>  }<br/>`;</span></pre><p id="fc5a" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">使用一个表单，我像这样组合数据:(但是注意，apollo想要这个名为'<em class="lh">变量</em>的对象，而不是别的！)</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="eeef" class="lc is hu ky b fv ld le l lf lg">const variables = {<br/>  name: "Stormo",<br/>  country: "Italy",<br/>  website: "<a class="ae ks" href="https://stormo.bandcamp.com/" rel="noopener ugc nofollow" target="_blank">https://stormo.bandcamp.com/</a>"<br/>  members: [{<br/>    firstName: "Luca",<br/>    lastName: "Rocco",<br/>  }, {<br/>    firstName: "Federico",<br/>    lastName: "Trimeri",<br/>  }, {<br/>    firstName: "Giacomo",<br/>    lastName: "Rento",<br/>  }, {<br/>    firstName: "Gabriele",<br/>    lastName: "Coldepin",<br/>  }],<br/>  contact: {<br/>    firstName: "Giacomo",<br/>    lastName: "Rento",<br/>  },<br/>  albums: [{<br/>    name: "SOSPESI NEL VUOTO BRUCEREMO IN UN ATTIMO E IL CERCHIO SARÀ CHIUSO",<br/>    year: 2014,<br/>    songs: [{<br/>      trkNr: 1,<br/>      title: "In Volo",<br/>      duration: "02:50" ,<br/>    }, {<br/>      trkNr: 2,<br/>      title: "Supernova",<br/>      duration: "02:10" ,<br/>    }, {<br/>      trkNr: 3,<br/>      title: "Fuga",<br/>      duration: "01:24" ,<br/>    }, {<br/>      trkNr: 4,<br/>      title: "Perchè La Bambina Cade",<br/>      duration: "02:46",<br/>    }]<br/>  }, {<br/>    name: "7",<br/>    year: 2009,<br/>    songs: [{<br/>      trkNr: 1,<br/>      title: "Incosiderata Putrefazione",<br/>      duration: "03:18",<br/>    }, {<br/>      trkNr: 2,<br/>      title: "Abbandono La Mia Volontà",<br/>      duration: "03:20",<br/>    }]<br/>  }, {<br/>    name: "Self-Titled EP",<br/>    year: 2007,<br/>    songs: [{<br/>      trkNr: 4,<br/>      title: "Quando Non Ci Sei",<br/>      duration: "02:08",<br/>    }, {<br/>      trkNr: 5,<br/>      title: "Al Punto Di Non Ritorno",<br/>      duration: "04:36",<br/>    }]<br/>  }]<br/>}</span></pre><p id="8c66" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">最后，在我的React组件中，我可以使用所有这些将我的数据发送到Graphcool</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="e830" class="lc is hu ky b fv ld le l lf lg">import React, { Component } from 'react';<br/>import { graphql, compose } from 'react-apollo';<br/>import BandMutation from './../graphql/BandMutation';</span><span id="ce1a" class="lc is hu ky b fv li le l lf lg">class CompanySettings extends Component {<br/>  constructor(props) {<br/>    super(props);<br/>    this.sendData = this.sendData.bind(this);<br/>  }</span><span id="adf7" class="lc is hu ky b fv li le l lf lg">sendData(variables) {<br/>    this.props.CreateBand({ variables })<br/>    .then((response) =&gt; {<br/>      window.alert('You submitted data about a new band');<br/>    }).catch((e) =&gt; {<br/>      console.error(e);<br/>    });<br/>  }</span><span id="b3f1" class="lc is hu ky b fv li le l lf lg">render() {<br/>    return &lt;FormCreateBand onSubmit={this.sendData} /&gt;;<br/>  }<br/>}</span><span id="be01" class="lc is hu ky b fv li le l lf lg">export default compose(<br/>  // with this I can use the mutation with this.props.CreateBand<br/>  graphql(BandMutation, { name: 'CreateBand' }),<br/>  // I can write here other mutations or queries<br/>)(CompanySettings);</span></pre><h1 id="3d42" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">结论…但是等等！这实际上是开始</h1><ul class=""><li id="3393" class="lo lp hu jr b js jt jw jx ka mc ke md ki me km lt lu lv lw dt translated">GraphQL不是未来，而是现在，它是如此的好，在爱的记忆中休息</li><li id="b34e" class="lo lp hu jr b js lx jw ly ka lz ke ma ki mb km lt lu lv lw dt translated">Graphcool是一个很棒的服务，它的员工非常细心和活跃(我很确定他们也不睡觉)</li><li id="aad2" class="lo lp hu jr b js lx jw ly ka lz ke ma ki mb km lt lu lv lw dt translated">是不是有些疲劳？…是的，当然！但是有了这种疲劳，你投入的每一分钟时间，以后都会省下很多，这取决于项目。</li></ul><p id="7634" class="pw-post-body-paragraph jp jq hu jr b js kn ju jv jw ko jy jz ka kp kc kd ke kq kg kh ki kr kk kl km hn dt translated">P.S. <strong class="jr hv">晚会现在要疯狂了，感谢</strong> <a class="ae ks" href="https://stormo.bandcamp.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="jr hv">风暴{O} </strong> </a> <strong class="jr hv">！！</strong></p><blockquote class="mf mg mh"><p id="2f90" class="jp jq lh jr b js kn ju jv jw ko jy jz mi kp kc kd mj kq kg kh mk kr kk kl km hn dt translated"><a class="ae ks" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是阿妹家庭的一员。我们现在<a class="ae ks" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ks" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>的机会。</p><p id="dca4" class="jp jq lh jr b js kn ju jv jw ko jy jz mi kp kc kd mj kq kg kh mk kr kk kl km hn dt translated">要了解更多信息，请阅读我们的“关于”页面、<a class="ae ks" href="http://bit.ly/HackernoonFB" rel="noopener ugc nofollow" target="_blank">喜欢/在脸书上给我们发消息</a>，或者简单地发送<a class="ae ks" href="https://goo.gl/k7XYbx" rel="noopener ugc nofollow" target="_blank"> tweet/DM @HackerNoon。</a></p><p id="708a" class="jp jq lh jr b js kn ju jv jw ko jy jz mi kp kc kd mj kq kg kh mk kr kk kl km hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ks" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ks" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote></div></div>    
</body>
</html>