<html>
<head>
<title>The Serverless Stack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器堆栈</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/the-serverless-stack-3ae91031f050?source=collection_archive---------17-----------------------#2017-10-18">https://medium.com/hackernoon/the-serverless-stack-3ae91031f050?source=collection_archive---------17-----------------------#2017-10-18</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="0593" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">AWS Lambda、API网关、S3、事件驱动的任务</h2></div><h2 id="b3af" class="jj jk hu bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg dt translated">什么是无服务器？</h2><blockquote class="kh ki kj"><p id="69e0" class="kk kl km kn b ko kp iv kq kr ks iy kt ku kv kw kx ky kz la lb lc ld le lf lg hn dt translated"><strong class="kn hv">无服务器</strong>架构指的是在很大程度上依赖于第三方服务(被称为后端即服务或“BaaS”)或在短期容器中运行的定制代码(功能即服务或“FaaS”)的应用程序，目前最知名的供应商主机是AWS Lambda。信用<a class="ae lh" href="https://martinfowler.com/articles/serverless.html" rel="noopener ugc nofollow" target="_blank">马丁·福勒</a></p></blockquote><h2 id="6a97" class="jj jk hu bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg dt translated">什么是堆栈？</h2><p id="5419" class="pw-post-body-paragraph kk kl hu kn b ko li iv kq kr lj iy kt ju lk kw kx jy ll la lb kc lm le lf lg hn dt translated">一个<strong class="kn hv">栈</strong>是AWS资源的集合，您可以将它作为一个单元来管理。换句话说，您可以通过创建、更新或删除<strong class="kn hv">栈</strong>来创建、更新或删除资源集合。一个<strong class="kn hv">栈</strong>中的所有资源都由<strong class="kn hv">栈的</strong> AWS <a class="ae lh" href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacks.html" rel="noopener ugc nofollow" target="_blank"> CloudFormation </a>模板定义。</p><h2 id="1746" class="jj jk hu bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg dt translated">什么是<a class="ae lh" href="https://github.com/thestackshack/serverless-stack" rel="noopener ugc nofollow" target="_blank">无服务器堆栈</a>？</h2><p id="bd50" class="pw-post-body-paragraph kk kl hu kn b ko li iv kq kr lj iy kt ju lk kw kx jy ll la lb kc lm le lf lg hn dt translated"><a class="ae lh" href="https://github.com/thestackshack/serverless-stack" rel="noopener ugc nofollow" target="_blank"> <strong class="kn hv">无服务器堆栈</strong> </a>只是如何使用无服务器技术构建应用程序的一个例子。在这种情况下，我们正在构建一个具有UI、API和异步任务的web应用程序。我们使用<a class="ae lh" href="https://cim.sh" rel="noopener ugc nofollow" target="_blank"> CIM </a> cli实用程序来创建和更新堆栈，并部署Lambda代码。</p><figure class="lo lp lq lr fq ls fe ff paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="fe ff ln"><img src="../Images/bb836c18e72a67b9f7e0744dec4b2fb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DF7FOj1c-OFbcYegmNBJmg.png"/></div></div><figcaption class="lz ma fg fe ff mb mc bd b be z ek">CIM’s Serverless Stack</figcaption></figure><p id="7ad2" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">这个堆栈由3个较小的堆栈组成。所有预构建为<a class="ae lh" href="https://cim.sh" rel="noopener ugc nofollow" target="_blank"> CIM </a>模板。</p><ul class=""><li id="acb2" class="md me hu kn b ko kp kr ks ju mf jy mg kc mh lg mi mj mk ml dt translated">UI —静态S3网站、CloudFront、SSL</li><li id="146b" class="md me hu kn b ko mm kr mn ju mo jy mp kc mq lg mi mj mk ml dt translated">API — API网关、Lambda、SSL</li><li id="9523" class="md me hu kn b ko mm kr mn ju mo jy mp kc mq lg mi mj mk ml dt translated">异步任务— SNS，Lambda</li></ul><h2 id="777a" class="jj jk hu bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg dt translated">构建无服务器应用时为什么要使用CloudFormation？</h2><p id="bd82" class="pw-post-body-paragraph kk kl hu kn b ko li iv kq kr lj iy kt ju lk kw kx jy ll la lb kc lm le lf lg hn dt translated">我们的应用程序的性质已经改变了。</p><p id="000e" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">应用代码模块已经越来越小了(单片-&gt;微服务-&gt;功能)。与此同时，云提供商一直在增加越来越多的服务。结果是一个由小代码模块和云服务混合而成的应用程序。</p><p id="083b" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">好处是？</p><ul class=""><li id="0b70" class="md me hu kn b ko kp kr ks ju mf jy mg kc mh lg mi mj mk ml dt translated">可以扩展以满足巨大需求的应用程序</li><li id="0f81" class="md me hu kn b ko mm kr mn ju mo jy mp kc mq lg mi mj mk ml dt translated">代码易于管理的应用程序</li><li id="a9c4" class="md me hu kn b ko mm kr mn ju mo jy mp kc mq lg mi mj mk ml dt translated">花费不多的应用程序</li></ul><p id="019a" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">问题是这些应用程序的架构变得越来越复杂。作为代码的基础设施(IaC)的重要性已经大大提高。</p><p id="5d14" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">我认为作为代码的基础设施和实际的代码一样重要。在新项目开始时实现IaC是必须的，尤其是对于新的无服务器应用程序。</p><figure class="lo lp lq lr fq ls fe ff paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="fe ff mr"><img src="../Images/157b7bb68962b7f06f874bf0e41d3598.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qBWxtjz5ohBiVYwWfd_bag.png"/></div></div><figcaption class="lz ma fg fe ff mb mc bd b be z ek">Monolithic vs. Serverless app</figcaption></figure><h2 id="a3cf" class="jj jk hu bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg dt translated">什么是CIM？</h2><p id="93a1" class="pw-post-body-paragraph kk kl hu kn b ko li iv kq kr lj iy kt ju lk kw kx jy ll la lb kc lm le lf lg hn dt translated">编写CloudFormation模板对于无服务器、事件驱动的应用程序来说是必不可少的。云的形成有一些棘手的问题。这也是我建立<a class="ae lh" href="https://cim.sh" rel="noopener ugc nofollow" target="_blank"> CIM </a>的原因。</p><p id="8d0c" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated"><a class="ae lh" href="https://cim.sh/" rel="noopener ugc nofollow" target="_blank"> CIM </a>是一个简单的命令行实用程序，它引导您的<a class="ae lh" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank"> CloudFormation </a> CRUD操作，使它们更容易执行，可重复，并且不容易出错。</p><p id="47f2" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">如果你想了解更多关于CIM的知识，以及我为什么要建立它，你可以阅读我的文章，<a class="ae lh" rel="noopener" href="/@rgfindley/meet-cim-cloud-infrastructure-manager-bc8bcfe0593c">认识CIM —云基础设施经理</a>。</p><h1 id="b839" class="ms jk hu bd jl mt mu mv jp mw mx my jt ja mz jb jx jd na je kb jg nb jh kf nc dt translated">无服务器堆栈</h1><p id="8f31" class="pw-post-body-paragraph kk kl hu kn b ko li iv kq kr lj iy kt ju lk kw kx jy ll la lb kc lm le lf lg hn dt translated">现在，让我们了解更多关于无服务器堆栈的信息。也许这应该被称为<strong class="kn hv">无服务器网络应用栈</strong>。无服务器堆栈的数量是无限的。这只是一个无服务器web应用堆栈的示例。</p><p id="437f" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">这个堆栈主要是关于堆栈，而不是代码。一旦部署了这个堆栈，您就可以开始编写自己的前端代码、api代码和异步任务代码。</p><h2 id="22fe" class="jj jk hu bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg dt translated">无服务器用户界面</h2><figure class="lo lp lq lr fq ls fe ff paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="fe ff nd"><img src="../Images/610176d63b8b1f1cee8c0c05339194e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MG0DnlWy1O90NTNX-ko57g.png"/></div></div></figure><p id="6519" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">UI是由AWS S3托管的静态web应用程序。web请求通过亚马逊的内容交付网络(CloudFront代理。CloudFront不仅缓存您的web资产，如图像、样式表和javascript文件，它还支持您的自定义域和SSL证书。这意味着您的web应用程序将是快速和安全的。</p><p id="fbb0" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">一个静态的S3网站的伟大之处在于无限的伸缩性和不需要DevOps。您的站点可以处理巨大的流量高峰，并且没有服务器需要监控。</p><p id="e32d" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">UI还支持持续集成和持续部署(CI/CD)。启用后，GitHub的所有提交都将触发CodePipeline来构建、测试和部署您的站点。你只需要把你的改变推送到GitHub，你的站点就会被构建、测试和部署。当有多个团队成员在开发应用程序时，这一点尤其重要。</p><p id="6669" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">静态网站可以做什么？这里的想法是使用像Angular或React这样的前端框架，然后向后端无服务器api发出请求。</p><p id="8cf3" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">如果我需要一个动态网站怎么办？您可以使用我们的<a class="ae lh" href="https://github.com/thestackshack/services-stack" rel="noopener ugc nofollow" target="_blank">服务栈</a>来创建一个永远在线的web应用程序。或者，你也可以继续使用静态网站，但提前生成所有的静态页面。S3的存储很便宜，所以即使你有很多文件，也没什么大不了的。也许有些页面可以通过JavaScript动态加载。</p><h2 id="8482" class="jj jk hu bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg dt translated">无服务器API</h2><figure class="lo lp lq lr fq ls fe ff paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="fe ff ne"><img src="../Images/8bc284774d8788f12c341f2f2cb21a65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s1BRTdRCFipEiumcu-Kbsg.png"/></div></div></figure><p id="17f9" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">API由AWS API网关组成，代理对AWS Lambda后端函数的调用。api网关使用自定义域名和SSL证书，因此您的API端点可以像<code class="eh nf ng nh ni b">api.yourdomain.com/v1</code>一样可读。</p><p id="2a70" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">这种架构的优点在于，它非常适合非常小的流量，即低成本，以及非常高的流量，即AWS的无忧自动扩展。Lambda确实有一个<a class="ae lh" href="http://docs.aws.amazon.com/lambda/latest/dg/limits.html" rel="noopener ugc nofollow" target="_blank">并发限制</a>，如果你的流量真的很高，你可能会遇到这个限制。如果你担心这一点，然后添加一个警报。然后，如果需要，请求AWS增加您的并发限制。</p><h2 id="1457" class="jj jk hu bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg dt translated">事件驱动的任务</h2><figure class="lo lp lq lr fq ls fe ff paragraph-image"><div class="fe ff nj"><img src="../Images/918235f40422f57529df64f97da30cb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*xe6VaU8Sc6j0PYwN4eQjlw.png"/></div></figure><p id="5503" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">事件驱动的任务堆栈实际上只是将长时间运行的异步任务从web请求中推出并放入后台任务的一种方式的示例。例如，假设我们有一个api端点需要格式化并发送一封电子邮件。这项任务应该异步完成。当我们发送电子邮件时，我们的HTTP api不应该被阻塞。在我们的示例堆栈中，api端点会将任务发布到SNS。SNS将触发一个Lambda函数。Lambda函数将格式化并发送电子邮件。</p><p id="51dd" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">这只是处理异步事件驱动任务的一种方式。AWS Lambda有许多不同的事件触发器。查看我们的<a class="ae lh" href="https://github.com/thestackshack/serverless-demo" rel="noopener ugc nofollow" target="_blank">无服务器演示</a>，获取一些Lambda事件触发示例。</p><p id="7f9c" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">另一个流行的事件触发器是S3更新。假设您需要在新图像或资产上传到S3后采取行动。您可以在添加到S3存储桶的每个新项目上触发Lambda函数。</p><p id="3e0b" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">计划更新(cron)也可以通过CloudWatch Events事件触发器来实现。例如，您可以触发Lambda每10分钟执行一次。</p></div><div class="ab cl nk nl hc nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="hn ho hp hq hr"><h1 id="4df5" class="ms jk hu bd jl mt nr mv jp mw ns my jt ja nt jb jx jd nu je kb jg nv jh kf nc dt translated">使用指南</h1><p id="d60c" class="pw-post-body-paragraph kk kl hu kn b ko li iv kq kr lj iy kt ju lk kw kx jy ll la lb kc lm le lf lg hn dt translated">要使用这个堆栈，只需安装<a class="ae lh" href="https://cim.sh" rel="noopener ugc nofollow" target="_blank"> CIM </a>，派生<a class="ae lh" href="https://github.com/thestackshack/serverless-stack" rel="noopener ugc nofollow" target="_blank">无服务器堆栈</a> repo，添加您的自定义域，并执行<code class="eh nf ng nh ni b">cim stack-up</code>。</p><ul class=""><li id="2b2c" class="md me hu kn b ko kp kr ks ju mf jy mg kc mh lg mi mj mk ml dt translated">安装<a class="ae lh" href="https://cim.sh" rel="noopener ugc nofollow" target="_blank"> CIM </a> ( <code class="eh nf ng nh ni b">npm install -g cim</code>)</li><li id="9af5" class="md me hu kn b ko mm kr mn ju mo jy mp kc mq lg mi mj mk ml dt translated">用<a class="ae lh" href="https://aws.amazon.com/route53/" rel="noopener ugc nofollow" target="_blank"> Route53 </a>注册您的域名</li><li id="f6c3" class="md me hu kn b ko mm kr mn ju mo jy mp kc mq lg mi mj mk ml dt translated">配置管理员@<em class="km">yourdomain.com</em>接收SSL验证电子邮件</li><li id="bac3" class="md me hu kn b ko mm kr mn ju mo jy mp kc mq lg mi mj mk ml dt translated">用你的域名替换<code class="eh nf ng nh ni b">ui/_cim.yml</code>和<code class="eh nf ng nh ni b">api/_cim.yml</code>中的<em class="km">example.com</em></li><li id="59f2" class="md me hu kn b ko mm kr mn ju mo jy mp kc mq lg mi mj mk ml dt translated">运行<code class="eh nf ng nh ni b">cim stack-up --recursive=true</code>安装堆栈</li></ul></div><div class="ab cl nk nl hc nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="hn ho hp hq hr"><p id="7cde" class="pw-post-body-paragraph kk kl hu kn b ko kp iv kq kr ks iy kt ju kv kw kx jy kz la lb kc ld le lf lg hn dt translated">感谢您阅读无服务器堆栈。如果你觉得有帮助，请告诉我。</p></div></div>    
</body>
</html>