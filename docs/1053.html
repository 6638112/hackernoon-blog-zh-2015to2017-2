<html>
<head>
<title>On Golang’s `defer` keyword</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">论戈朗的“推迟”关键词</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/on-golangs-defer-936af46a49da?source=collection_archive---------0-----------------------#2016-08-27">https://medium.com/hackernoon/on-golangs-defer-936af46a49da?source=collection_archive---------0-----------------------#2016-08-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="fc85" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Golang </a>有一个<a class="ae jp" href="https://blog.golang.org/defer-panic-and-recover" rel="noopener ugc nofollow" target="_blank"> <em class="jq"> defer </em>关键字</a>，它“推迟”一个函数的执行，直到周围的<a class="ae jp" href="https://hackernoon.com/tagged/function" rel="noopener ugc nofollow" target="_blank">函数</a>返回。多个<em class="jq">延迟</em>被堆叠<a class="ae jp" href="https://en.wikipedia.org/wiki/Stack_%28abstract_data_type%29" rel="noopener ugc nofollow" target="_blank">后进先出</a>以便最近的<em class="jq">延迟</em>红色功能首先运行。</p><p id="8fb5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们来看一个实践中的例子。</p><pre class="jr js jt ju fq jv jw jx jy aw jz dt"><span id="3064" class="ka kb hu jw b fv kc kd l ke kf">func writeLogs(c chan []string) {<br/>  defer stats.Duration("write_logs_fn", time.Now()) // order: 4<br/>  <br/>  file, err := os.Create("request.log", filename)<br/>  if err != nil {<br/>    panic(err)<br/>  }<br/>  defer file.Close() // order: 3<br/>  <br/>  writer := csv.NewWriter(file)<br/>  defer writer.Flush() // order: 2<br/>  <br/>  for line := range c {<br/>    err := writer.Write(line)<br/>    if err != nil {<br/>      panic(err)<br/>    }<br/>    defer stats.Increment("wrote_line") // order: 1<br/>  }<br/>}</span></pre><p id="720e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">乍一看，你可能会问—</p><blockquote class="kg kh ki"><p id="37ce" class="ir is jq it b iu iv iw ix iy iz ja jb kj jd je jf kk jh ji jj kl jl jm jn jo hn dt translated">这与其他语言中的<a class="ae jp" href="https://docs.oracle.com/javase/tutorial/essential/exceptions/finally.html" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv"> finally </strong>关键字</a>有何不同？</p></blockquote><p id="b0f6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">从<a class="ae jp" href="https://docs.oracle.com/javase/tutorial/essential/exceptions/finally.html" rel="noopener ugc nofollow" target="_blank"> Java文档</a>，</p><blockquote class="kg kh ki"><p id="af78" class="ir is jq it b iu iv iw ix iy iz ja jb kj jd je jf kk jh ji jj kl jl jm jn jo hn dt translated">最后，不仅仅在异常处理上有用——它允许程序员避免清理代码被返回、继续或中断意外绕过。将清理代码放在finally块中始终是一个好的做法，即使没有预料到异常。</p></blockquote><p id="050b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好了，让我们用<em class="jq"> finally </em>来比较<em class="jq"> defer </em>和下面的<a class="ae jp" href="https://hackernoon.com/tagged/java" rel="noopener ugc nofollow" target="_blank"> Java </a>例子。</p><pre class="jr js jt ju fq jv jw jx jy aw jz dt"><span id="644b" class="ka kb hu jw b fv kc kd l ke kf">static void writeLogs(List&lt;List&lt;String&gt;&gt; lines) throws Exception {<br/>  Date start = new Date();<br/>  FileWriter writer = null;<br/>  int lineCount = 0;<br/>  <br/>  try {<br/>    writer = new FileWriter("request.log");<br/>    // non-buffered input<br/>    for (int i = 0; i &lt; lines.size(); i++) {<br/>      // naive CSV writer<br/>      for (value : lines[i]) {<br/>        writer.append(value);<br/>        writer.append(",");<br/>      }<br/>      writer.append("\n");<br/>      lineCount++;<br/>    }<br/>  } <strong class="jw hv">finally {<br/>    if (writer != null) {<br/>      writer.flush();<br/>      writer.close();<br/>    }</strong></span><span id="31cb" class="ka kb hu jw b fv km kd l ke kf"><strong class="jw hv">    stats.increment("wrote_line", lineCount);<br/>    stats.duration(start);<br/>  }</strong><br/>}</span></pre><p id="ee60" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">很快，你就能发现一些“问题”:</p><ul class=""><li id="450e" class="kn ko hu it b iu iv iy iz jc kp jg kq jk kr jo ks kt ku kv dt translated"><strong class="it hv">相似关注点的分离。</strong> <em class="jq">终于</em>把相似的顾虑分开。因为当你打开一个文件时，你不能声明你想要关闭它，你不能有效地提前计划；相反，你必须记住让它适应周围的环境。我数不清我见过多少由于分离相似的关注点而导致的程序员错误。</li><li id="b3c7" class="kn ko hu it b iu kw iy kx jc ky jg kz jk la jo ks kt ku kv dt translated"><strong class="it hv">中断。</strong> <em class="jq">最后</em>需要立即的、排他的、中断的注意力，而<em class="jq">延迟</em>允许你提前计划，而不中断你通常的控制流程。在Go示例中，我们可以在读取每一行时很容易地推迟增加度量，而在Java中，推迟多个调用将需要更高级的控制流，比如队列，所以相反，我们必须通过聚合来重新组织我们的流。</li><li id="e2bf" class="kn ko hu it b iu kw iy kx jc ky jg kz jk la jo ks kt ku kv dt translated"><strong class="it hv">可读性。</strong> <em class="jq"> finally </em>强制嵌套，这会损害整体可读性，而<em class="jq"> defer </em>可以内嵌。注意到了<em class="jq">！= null </em>检查、计数器，并将定义与声明分开。总的来说，这些特征对读者来说都没有意义，但是由于嵌套结构，他们不得不解析它。</li><li id="961f" class="kn ko hu it b iu kw iy kx jc ky jg kz jk la jo ks kt ku kv dt translated">命令式与陈述式。这可能不是你所期望的流向Go方面的一个点，但是总的来说，<em class="jq"> defer </em>更具有宣示性。你告诉计算机你想让<em class="jq">做</em> X，Y，Z而不是<em class="jq">如何做</em>。</li></ul><p id="0ca9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">和大多数技术债务一样，我发现随着功能复杂性的增加，这些“陷阱”会变得更加明显。</p><h2 id="fcc7" class="ka kb hu bd lb lc ld le lf lg lh li lj jc lk ll lm jg ln lo lp jk lq lr ls lt dt translated">结论</h2><p id="d92c" class="pw-post-body-paragraph ir is hu it b iu lu iw ix iy lv ja jb jc lw je jf jg lx ji jj jk ly jm jn jo hn dt translated">虽然不合常规，Go的<em class="jq">延期</em>却是纯粹的聪明。它用一个简单、通用的控制流伪装了一个通常复杂的控制流，既有助于可读性，又保持了事物的声明性(<a class="ae jp" href="http://www.sandimetz.com/blog/2016/1/20/the-wrong-abstraction" rel="noopener ugc nofollow" target="_blank">两个互不相容的因素</a>)。这比传统的通过<em class="jq">最终</em>拆卸要好得多，你应该总是更喜欢它，而不是推出你自己的控制流。</p></div><div class="ab cl lz ma hc mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="hn ho hp hq hr"><p id="620b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你觉得这很有趣，可以考虑在Twitter上关注我，在那里我分享了我的围棋经验和其他经验。</p><blockquote class="kg kh ki"><p id="2e84" class="ir is jq it b iu iv iw ix iy iz ja jb kj jd je jf kk jh ji jj kl jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是阿美族家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="dca4" class="ir is jq it b iu iv iw ix iy iz ja jb kj jd je jf kk jh ji jj kl jl jm jn jo hn dt translated">要了解更多信息，<a class="ae jp" href="https://goo.gl/4ofytp" rel="noopener ugc nofollow" target="_blank">请阅读我们的“关于”页面</a>、<a class="ae jp" href="http://bit.ly/HackernoonFB" rel="noopener ugc nofollow" target="_blank">在脸书上给我们点赞/发消息</a>，或者简单地说，<a class="ae jp" href="https://goo.gl/k7XYbx" rel="noopener ugc nofollow" target="_blank"> tweet/DM @HackerNoon。</a></p><p id="708a" class="ir is jq it b iu iv iw ix iy iz ja jb kj jd je jf kk jh ji jj kl jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jr js jt ju fq mg"><div class="bz el l di"><div class="mh mi l"/></div></figure></div></div>    
</body>
</html>