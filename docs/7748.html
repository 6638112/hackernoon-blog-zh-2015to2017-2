<html>
<head>
<title>Monitor Swarm Cluster with TICK stack &amp; Slack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用TICK堆栈和Slack监控集群集群</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/monitor-swarm-cluster-with-tick-stack-slack-3aaa6483d44a?source=collection_archive---------6-----------------------#2017-11-07">https://medium.com/hackernoon/monitor-swarm-cluster-with-tick-stack-slack-3aaa6483d44a?source=collection_archive---------6-----------------------#2017-11-07</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/4c078b071e01a4904c58b28585f89106.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*BwQlxmUSsB3fyGz8PjqTkg.png"/></div></figure><p id="e2b2" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在本文中，我将向您展示如何建立一个开源时间序列平台来监控您的<strong class="ja hv"> Docker Swarm </strong> cluster &amp;发送关于<strong class="ja hv"> Slack </strong>的通知，以防异常检测。</p><p id="4d2e" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们监控堆栈的组件:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div class="fe ff jw"><img src="../Images/bfa7efd96efe8154a77952acb0b95369.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/0*Zn5Kxf-FmOtzqJfU."/></div></figure><p id="d3c7" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">用于收集和报告指标的插件驱动的服务器代理。</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div class="fe ff jw"><img src="../Images/a9a459c80d8a5c240c868f72d6e1d0bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/0*ZZnmWFSH2bPsAvdy."/></div></figure><p id="a7cc" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">用于度量、事件和实时分析的可扩展时间序列数据库。</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div class="fe ff jw"><img src="../Images/05322ccfa677f5fcdc3f17719ea5c1d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/0*3TP_1DMxp6r8P97K."/></div></figure><p id="13bf" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">用于在数据基础上构建图表的实时可视化工具。</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div class="fe ff jw"><img src="../Images/c85132fc44f745f13e6a1f34975cc6c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/0*hmm0eSyYbjnS5E3w."/></div></figure><p id="969f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">时间序列数据的处理、监控和警报框架。</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div class="fe ff jw"><img src="../Images/733f5797ea62331aafe12d661ac9d8de.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/0*MHURSVStgOCqvp57."/></div></figure><p id="7665" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">实时团队消息应用程序。</p><p id="4f8f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">注意:这篇文章中使用的所有代码都在我的<a class="ae kb" href="https://github.com/mlabouardy/swarm-tick" rel="noopener ugc nofollow" target="_blank"> Github </a>上。</p><p id="aeec" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 1 —群组设置</strong></p><p id="3a50" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如果您已经有了一个现有的<strong class="ja hv"> Swarm集群</strong>，您可以跳过这一部分，如果没有使用以下脚本来设置一个具有3个节点的<strong class="ja hv">Swarm</strong>(1个<strong class="ja hv">管理器</strong> &amp; 2个<strong class="ja hv">工作器</strong>):</p><figure class="jx jy jz ka fq iv"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="b9ab" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">发出以下命令:</p><blockquote class="ke kf kg"><p id="efe1" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">chmod +x setup.sh <br/>。/setup.sh</p></blockquote><p id="8de9" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">上述命令的输出如下:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff kl"><img src="../Images/8c5f9112747c5dac73481ca4d2738f38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fE381efciD38oD-j."/></div></div></figure><p id="7b6a" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 2 —堆栈设置</strong></p><p id="f290" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">创建完成后，通过<strong class="ja hv"> SSH </strong>连接到您的<strong class="ja hv">管理器节点</strong>，并克隆以下存储库:</p><blockquote class="ke kf kg"><p id="7319" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">https://github.com/mlabouardy/swarm-tick.git</p></blockquote><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff kq"><img src="../Images/5518c5bf0bad04fcfc6fee9b873baea6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*daztQUSoX2_Pwi82."/></div></div></figure><p id="b003" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">为了启动所有这些容器，我使用了<strong class="ja hv"> docker-compose </strong>:</p><figure class="jx jy jz ka fq iv"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="67c3" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">发出以下命令来部署堆栈:</p><blockquote class="ke kf kg"><p id="7190" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">docker stack deploy — compose文件docker-compose.yml tick</p></blockquote><p id="3083" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">等待节点从<strong class="ja hv"> DockerHub </strong>中提取图像:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff kr"><img src="../Images/c330c32c5314b1664c87e9633629368d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*98dsMLa40T8sHJgG."/></div></div></figure><p id="3476" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">拉出后，您应该会看到服务正在运行:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff ks"><img src="../Images/7d2d6ea328def7b1399dd5e40b231413.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xazp5SK6iLxN_pPI."/></div></div></figure><p id="0f28" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在<a class="ae kb" href="http://IP:8888" rel="noopener ugc nofollow" target="_blank"><strong class="ja hv">http://IP:8888</strong></a>(<strong class="ja hv">chrono graf</strong>Dashboard)上打开浏览器，正确配置数据源:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff kt"><img src="../Images/e1317a853e1490a18c5ee2044c808295.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kT43cgEg9oH4G7ad."/></div></div></figure><p id="9ca8" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 3 —系统使用仪表板</strong></p><p id="92b1" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">点击“<strong class="ja hv">创建仪表板</strong>，并为仪表板指定一个名称:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff ku"><img src="../Images/9f701fb39ac499f4c68a4007fa3fd68b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2ndXn6-hp-Mh572B."/></div></div></figure><p id="04d2" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在添加图形之前，我们将使用一个叫做<strong class="ja hv">仪表板模板变量</strong>的概念，来创建动态的&amp;交互式图形。在我们的度量查询中，我们将使用变量来代替像节点名和容器名这样的硬编码。因此，点击前面创建的仪表板顶部的“<strong class="ja hv">模板变量</strong>”。并且，创建一个名为<em class="kh"> :host: </em>的变量，如下所示:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff kv"><img src="../Images/5905a4c99b762279144992535950d410.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LcnHODCfOIDBs-Bo."/></div></div></figure><p id="331f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">注意:目前，还没有为用<strong class="ja hv"> swarm全局模式</strong> ( <a class="ae kb" href="https://github.com/moby/moby/pull/24973" rel="noopener ugc nofollow" target="_blank"> Github </a>)创建的服务设置主机名的解决方案。这就是为什么我们得到的是id列表而不是名字</p><p id="dba1" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">您现在可以使用仪表板顶部的下拉菜单来选择<em class="kh">:主机:</em>模板变量的不同选项:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff kw"><img src="../Images/c405161decf56a4ccaffbd141efaeeb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6giSv6Im_rnSy9X9."/></div></div></figure><p id="4628" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">现在是时候创建我们的第一个图表了，所以点击“<strong class="ja hv">添加图表</strong>按钮。</p><p id="6a1e" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 3.1 —每个节点的内存使用量</strong></p><p id="38b4" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">要创建查询，您可以使用<strong class="ja hv">查询构建器</strong>，或者，如果您已经熟悉<strong class="ja hv"> InfluxQL </strong>，您可以在文本输入中手动输入查询:</p><blockquote class="ke kf kg"><p id="4e6c" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">从“vm_metrics”中选择mean(“free”)作为“mean_free”，mean(“used”)作为“mean_used”，mean(“total”)作为“mean_total”。“自动发电机”。" mem_vm "其中time &gt;:dashboard time:AND " host " =:host:GROUP BY:interval:FILL(null)</p></blockquote><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff kx"><img src="../Images/c3d10bcc4025ca218a42fe96e4c13c9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Slj2IYou5V-aXQhH."/></div></div></figure><p id="afe5" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们的查询计算度量<em class="kh"> mem_vm </em>中字段键<em class="kh"> free </em>、<em class="kh"> used </em>和<em class="kh"> total </em>的平均值，并按照时间和节点名称对它们进行分组。</p><p id="7046" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">您可以通过点击“<strong class="ja hv">选项</strong>选项卡来更改图形类型、X轴和Y轴格式:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff ky"><img src="../Images/f38d5c894d583e6f561cb24a9316cbe6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GP1BAoUyirxkUU6J."/></div></div></figure><p id="694f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">仪表板上的一个可视化效果并不十分有趣，所以我添加了更多的图表来展示更多的可能性:</p><p id="f61e" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 3.2 —每个节点的CPU使用率</strong></p><blockquote class="ke kf kg"><p id="dc48" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">从“vm_metrics”中选择mean(“usage _ user”)作为“mean_usage_user”，mean(“usage _ system”)作为“mean_usage_system”。“自动发电机”。" cpu_vm "其中time &gt;:dashboard time:AND " host " =:host:GROUP BY:interval:FILL(null)</p></blockquote><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff kz"><img src="../Images/4751ce788afea5d439432ff0c37ffe4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FzfQuAp658dsl7AW."/></div></div></figure><p id="f522" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 3.3 —每个节点的磁盘使用量</strong></p><blockquote class="ke kf kg"><p id="db22" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">从“vm_metrics”中选择mean(“free”)作为“mean_free”，mean(“total”)作为“mean_total”，mean(“used”)作为“mean_used”。“自动发电机”。" disk_vm "其中time &gt;:dashboard time:AND " host " =:host:GROUP BY:interval:FILL(null)</p></blockquote><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff la"><img src="../Images/63e7e20d7d3fbd4c8950a9fd9b4be9d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6uDm04KmDV2N6o1e."/></div></div></figure><p id="0880" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们最终得到了这样一个漂亮的仪表板:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff lb"><img src="../Images/edf64de125adf1c32347cb502cbd4af2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*L0ZouOXOGvQ1tgHu."/></div></div></figure><p id="6ba1" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">让我们创建另一个仪表板来监控在<strong class="ja hv">集群</strong>上运行的<strong class="ja hv"> Docker容器</strong>。</p><p id="7af6" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4 —群体服务仪表板</strong></p><p id="10e1" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">创建第二个名为“<strong class="ja hv"> Services </strong>”的仪表板，并创建一个模板变量来存储集群上运行的服务列表:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff lc"><img src="../Images/f01ac0892d353051ec8c3df9738487fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GNnEJ5yXZb_EMX0W."/></div></div></figure><p id="bad5" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">您可以按服务名过滤now指标:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff ld"><img src="../Images/b82e2c04dc86dd05514d5639c6ca2e48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LmHg_AJINLIuzyn_."/></div></div></figure><p id="95f0" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4.1 —每个服务的内存使用量</strong></p><blockquote class="ke kf kg"><p id="5254" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">从“docker_metrics”中选择mean(“usage _ percent”)作为“mean_usage_percent”。“自动发电机”。" docker_container_mem_docker "其中time &gt; :dashboardTime:和" com . docker . swarm . service . name " =:container:GROUP BY:interval:FILL(null)</p></blockquote><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff le"><img src="../Images/f2803f0244d335863e72c27516f2f42b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3awskHQW4EHARU6t."/></div></div></figure><p id="f450" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4.2 —每项服务的CPU使用率</strong></p><blockquote class="ke kf kg"><p id="d667" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">从“docker_metrics”中选择mean(“usage _ percent”)作为“mean_usage_percent”。“自动发电机”。" docker_container_cpu_docker "其中time &gt; :dashboardTime:和" com . docker . swarm . service . name " =:container:GROUP BY:interval:FILL(null)</p></blockquote><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff lf"><img src="../Images/98742667d9c26be85a5f021040332d14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uZPUSThhAmblNQ5r."/></div></div></figure><p id="a468" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4.3 —网络发送/接收</strong></p><blockquote class="ke kf kg"><p id="a351" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">从“docker_metrics”中选择mean(“tx _ packets”)作为“mean_tx_packets”，mean(“rx _ packets”)作为“mean_rx_packets”。“自动发电机”。" docker_container_net_docker "其中time &gt; :dashboardTime:和" com . docker . swarm . service . name " =:container:GROUP BY:interval:FILL(null)</p></blockquote><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff lg"><img src="../Images/8c6cade7065b82c21904bc5337df4d5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fZuGMZUbnGGw5aBk."/></div></div></figure><p id="f858" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4.4 —每个服务的IO读/写</strong></p><blockquote class="ke kf kg"><p id="70f0" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">从“docker_metrics”中选择mean(“io _ serviced _ recursive _ write”)作为“mean_io_recursive_write_write”，mean(“io _ serviced _ recursive _ read”)作为“mean _ io _ serviced _ recursive _ read”。“自动发电机”。" docker_container_blkio_docker "其中time &gt; :dashboardTime:和" com . docker . swarm . service . name " =:container:GROUP BY:interval:FILL(null)</p></blockquote><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff lh"><img src="../Images/f0b7ba44abb787c5d8ca13cd9c22ef44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BmDrDVLerplzr_bV."/></div></div></figure><p id="96e4" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">结果:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff li"><img src="../Images/c02229876705ac84df7b59eba73de66a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4dipgPTByMpoHt8P."/></div></div></figure><p id="3c09" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">注意:您可以更进一步，通过创建另一个模板变量，按运行服务的节点过滤指标:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff lj"><img src="../Images/042eeda40d13e8425db5d65c0a032c53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1WFb0nDIPtQpciIL."/></div></div></figure><p id="01d2" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">让我们看看如果我们在<strong class="ja hv"> Swarm </strong>上创建另一个服务会发生什么:</p><blockquote class="ke kf kg"><p id="e99e" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">docker service create-name API-constraint node . role = = worker-p 5000:5000 mlabouardy/books-API</p></blockquote><p id="7d29" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如果您返回到<strong class="ja hv"> Chronograf </strong>，您应该会看到服务已经自动添加到容器下拉列表中:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff kz"><img src="../Images/8b89a9082e83abe3023358cd677d112b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*H43kq5JOEbp2oU98."/></div></div></figure><p id="162a" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">就是这样！现在，您已经具备了使用<strong class="ja hv"> Chronograf </strong>构建漂亮的数据可视化和仪表盘的基础。</p><p id="2306" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">Kapacitor 是拼图的最后一块。我们现在知道了如何存储、获取和读取指标，现在您需要对它们进行详细说明，以做一些类似警报或主动监控的事情。</p><p id="9308" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">所以在“<strong class="ja hv">配置</strong>选项卡上，点击“<strong class="ja hv">添加配置</strong>”:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff lk"><img src="../Images/4491229fa8028f9f6d47cce63beff10f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YSNiMCFN_GtgHI1x."/></div></div></figure><p id="a178" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">添加新的<strong class="ja hv"> Kapacitor </strong>实例如下，并启用<strong class="ja hv"> Slack </strong>:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff ll"><img src="../Images/86e66be8a0fb11cc6e52f79ae069a807.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SHd3ch5u4V3BNaVS."/></div></div></figure><p id="f2e4" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">注意:更新<strong class="ja hv"> Slack </strong>频道&amp; <strong class="ja hv"> Webhook URL </strong>以防你在本教程开始时没有更新<em class="kh"> kapacitor.conf </em>文件。你可以通过进入这个<a class="ae kb" href="https://api.slack.com/incoming-webhooks" rel="noopener ugc nofollow" target="_blank">页面</a>获得一个<strong class="ja hv"> Webhook URL </strong>:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff lm"><img src="../Images/6aa41cd2dbf4a66a2fd4521d3f41e89a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/0*BQEzBOGLxeYjsjjd."/></div></div></figure><p id="92f8" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 5 —警报定义</strong></p><p id="7677" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 5.1 —高内存利用率警报</strong></p><p id="04cb" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">通过访问“<strong class="ja hv">警报</strong>”页面，导航至“<strong class="ja hv">规则配置”</strong>页面，并单击右上角的“<strong class="ja hv">构建规则</strong>”按钮:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff ln"><img src="../Images/5237531a11981b427c8e708d7cb19960.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MH_iSBMz51a82gpR."/></div></div></figure><p id="43ae" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如果<strong class="ja hv">内存</strong>使用率超过<strong class="ja hv"> 60% </strong>，我们将触发警报:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff lo"><img src="../Images/2e0c85541fb5385a5cbf6819ceeae8fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MxaR0xs6DJgztk_M."/></div></div></figure><p id="4694" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">接下来，我们选择<strong class="ja hv"> Slack </strong>作为事件处理器，并配置警告消息:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff lp"><img src="../Images/4121ea628257932e41579a3de7e474ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7DFK3Szr-3pm_tT9."/></div></div></figure><p id="f814" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">注意:如果您在初始<strong class="ja hv">松弛</strong>配置中指定了默认通道，则不需要在<strong class="ja hv">警告消息</strong>部分包含一个<strong class="ja hv">松弛</strong>通道。</p><p id="7a57" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 5.2 —高CPU利用率警报</strong></p><p id="bba7" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">创建第二个规则，在<strong class="ja hv"> CPU </strong>使用率超过<strong class="ja hv"> 40% </strong>时触发警报:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff lq"><img src="../Images/7b132a4938679a11f6178752ca8c0ad3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Q80MlXU8rF3ATBW9."/></div></div></figure><p id="8345" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">警报端点:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff lr"><img src="../Images/1c494750ffedc989acaa2168432dbf61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QdfpS399bUFniU3x."/></div></div></figure><p id="4ce5" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">保存规则，就万事俱备了！</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff ls"><img src="../Images/7bd0f3cd6b9ce8fd880b56b8ade0fae0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PQCEZ4OlOJrJGJvT."/></div></div></figure><p id="b093" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">现在我们的警报规则已经定义好了，让我们通过在集群上创建一些负载来测试它们。</p><p id="1043" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 6 —压力测试</strong></p><p id="ef9a" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我用了<strong class="ja hv"> stress </strong>，一个生成工作量的工具。它会产生CPU、内存、I/O和磁盘压力。</p><p id="780f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 6.1 —给CPU施加压力</strong></p><blockquote class="ke kf kg"><p id="f571" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">docker运行— rm -it进度/压力— cpu 4 —超时20秒</p></blockquote><p id="fe33" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">注意:根据您的CPU类型，确保相应地更换'<strong class="ja hv"> 4 </strong>'。</p><p id="7078" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">几秒钟后，您应该会收到一个<strong class="ja hv">时差</strong>通知:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff lt"><img src="../Images/1126277a364c8156cfc92b9932673f30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fscDAM7mNZMiEEYY."/></div></div></figure><p id="58c7" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> Kapacitor </strong>触发警报，如果警报解除，还会恢复它们(状态正常)。</p><p id="98c2" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 6.2 —强化记忆</strong></p><blockquote class="ke kf kg"><p id="b5ed" class="iy iz kh ja b jb jc jd je jf jg jh ji ki jk jl jm kj jo jp jq kk js jt ju jv hn dt translated">docker运行— rm -it进度/压力—虚拟机3 —超时20秒</p></blockquote><p id="5dcb" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">它将使用三个进程对内存施加压力，每个进程大约有<strong class="ja hv"> 256 Mb </strong>(用选项<em class="kh">–VM-bytes</em>覆盖)。</p><p id="e185" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">让它运行几秒钟:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="fe ff lu"><img src="../Images/0c94e48d82ab39f9827237589cb981e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SA5vXXXOZqNtrzJl."/></div></div></figure><p id="53b2" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">就是这样！您已经成功地为您的<strong class="ja hv"> Swarm集群</strong>建立了一个高度可扩展的分布式监控平台，并且只使用了开源项目。</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div class="fe ff lv"><img src="../Images/3049f70108424edfdc543c54dbc562cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1016/0*5O_UV6TWfFFndE_b."/></div></figure></div></div>    
</body>
</html>