<html>
<head>
<title>Tips and Tricks for Adding Metamask to Your UI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向用户界面添加元掩码的提示和技巧</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/tips-and-tricks-for-adding-metamask-to-your-ui-32728b437194?source=collection_archive---------4-----------------------#2017-05-11">https://medium.com/hackernoon/tips-and-tricks-for-adding-metamask-to-your-ui-32728b437194?source=collection_archive---------4-----------------------#2017-05-11</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/de58eaafc6725a162169a616651d011f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7BcaM0QZwa04YqAxtkVo6w.png"/></div></div></figure><div class=""/><p id="6bc8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在过去的几周里，我一直在开发一款<a class="ae ka" href="https://hackernoon.com/getting-started-as-an-ethereum-web-developer-9a2a4ab47baf" rel="noopener ugc nofollow" target="_blank">以太坊应用</a>，它使用<a class="ae ka" href="https://metamask.io/" rel="noopener ugc nofollow" target="_blank">元掩码</a>进行用户管理，就像我<a class="ae ka" href="https://hackernoon.com/never-use-passwords-again-with-ethereum-and-metamask-b61c7e409f0d" rel="noopener ugc nofollow" target="_blank">说过的那样</a>。总的来说，这是一次不痛不痒的经历，但是我发现了一些我想分享的问题。希望这将在未来节省一些开发人员的时间。</p><figure class="kc kd ke kf fq hw fe ff paragraph-image"><div class="fe ff kb"><img src="../Images/6a43ddef1abc10a7f53f03e3cc045896.png" data-original-src="https://miro.medium.com/v2/resize:fit:712/format:webp/1*65YyD4wdDRTFJOrJ3f9xxw.png"/></div></figure><h2 id="a49c" class="kg kh if bd ki kj kk kl km kn ko kp kq jn kr ks kt jr ku kv kw jv kx ky kz la dt translated">1.确保您的以太坊客户端是最新的</h2><p id="988f" class="pw-post-body-paragraph jc jd if je b jf lb jh ji jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz hn dt translated">我的第一个障碍来自我在交易弹出窗口中发现的一个错误。出于某种原因，当我点击“接受”发送我的交易时，迎接我的是一个不停旋转的橙色圆圈。展开弹出窗口的控制台后，我看到:</p><pre class="kc kd ke kf fq lg lh li lj aw lk dt"><span id="f82f" class="kg kh if lh b fv ll lm l ln lo">AssertionError: The field v must have byte length of 1 at FakeTransaction.setter [as v]</span></pre><p id="cd8b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">嗯……那是什么意思？</p><p id="65de" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我在slack上pinged了Kumavis，他告诉我这与最近刚刚得到支持的<a class="ae ka" href="https://github.com/ethereum/eips/issues/155" rel="noopener ugc nofollow" target="_blank"> EIP155 </a>有关。任何旧版本的testrpc都缺乏这种支持，所以我进行了升级，一切正常:</p><pre class="kc kd ke kf fq lg lh li lj aw lk dt"><span id="b583" class="kg kh if lh b fv ll lm l ln lo">npm i -g ethereumjs-testrpc</span></pre><h2 id="8bf8" class="kg kh if bd ki kj kk kl km kn ko kp kq jn kr ks kt jr ku kv kw jv kx ky kz la dt translated">2.每次重新启动testrpc时重置网络</h2><p id="e314" class="pw-post-body-paragraph jc jd if je b jf lb jh ji jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz hn dt translated">又一个testrpc问题！一旦你打开<a class="ae ka" href="https://hackernoon.com/tagged/metamask" rel="noopener ugc nofollow" target="_blank">元掩码</a>并输入你的密码，你就连接到那个提供商了。如果您切换提供商(例如从main net切换到kovan)并刷新页面，将重置您的连接，您需要再次输入密码。</p><p id="0ae4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但是如果重置testrpc会发生什么呢？你应该还在听<code class="eh lp lq lr lh b">localhost:8545</code>，但是你会发现一旦你刷新页面，事情看起来就不对了。事实上，事情会看起来非常非常不对劲。</p><p id="1873" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是因为metamask正在跟踪块号，当您重新启动testrpc时，该号将重置为零。这是导致灾难的原因。幸运的是，有一个相对简单的方法可以避免这种情况:每当您重启testrpc时，打开metamask并重新选择<code class="eh lp lq lr lh b">localhost:8545</code>作为您的提供者。现在刷新你的页面，点击metamask，输入你的密码。瞧啊。您连接到了新的testrpc实例。</p><h2 id="3d3d" class="kg kh if bd ki kj kk kl km kn ko kp kq jn kr ks kt jr ku kv kw jv kx ky kz la dt translated">3.始终检查web3的类型</h2><p id="b070" class="pw-post-body-paragraph jc jd if je b jf lb jh ji jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz hn dt translated">如果你没有正确检查web3，你的应用可能会遇到竞争情况。如果你试图在web3注入之前渲染你的实际应用，一切都会崩溃。因此，我强烈建议您的应用程序的着陆组件使用如下内容(我假设您正在使用react):</p><pre class="kc kd ke kf fq lg lh li lj aw lk dt"><span id="c10d" class="kg kh if lh b fv ll lm l ln lo">if (typeof web3 == 'undefined') {<br/>  return (<br/>    &lt;NoMetamask/&gt;<br/>  );<br/>} else if (web3.version.network == 'loading') {<br/>  return (<br/>    &lt;WrongNetwork/&gt;<br/>  );<br/>} else {<br/>  return (<br/>    &lt;Landing/&gt;<br/>  );<br/>}</span></pre><p id="87ed" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请注意，检查<code class="eh lp lq lr lh b">if (web3 !== undefined)</code>或<code class="eh lp lq lr lh b">if (web3)</code>或任何等效的<em class="ls">将不起作用</em>。你需要比较<code class="eh lp lq lr lh b">typeof</code>注入的web3对象。</p><h2 id="cbe0" class="kg kh if bd ki kj kk kl km kn ko kp kq jn kr ks kt jr ku kv kw jv kx ky kz la dt translated">4.将所有元掩码调用打包到一个util文件中</h2><p id="e3d4" class="pw-post-body-paragraph jc jd if je b jf lb jh ji jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz hn dt translated">这可能是开发人员的偏好，但我强烈建议将所有元掩码调用抽象到一个文件中，因为您会发现自己会大量重用元掩码调用。与其以后折叠一堆相同函数的copypasta版本，为什么不从您的<code class="eh lp lq lr lh b">util</code>目录中的一个元掩码文件开始呢？不要担心没有访问<code class="eh lp lq lr lh b">web3</code>的权限:它只是一个javascript对象，你可以像传递一个烫手山芋一样传递它——它可以去任何地方！</p><pre class="kc kd ke kf fq lg lh li lj aw lk dt"><span id="2cfc" class="kg kh if lh b fv ll lm l ln lo">// metamask.js<br/>exports.doSomething = function(web3, param) {<br/>  <br/>  // I have access to web3, even though I'm not in the DOM!  <br/>  const user = web3.eth.accounts[0];</span><span id="868c" class="kg kh if lh b fv lt lm l ln lo">  // Do stuff<br/>}</span></pre><h2 id="4f6f" class="kg kh if bd ki kj kk kl km kn ko kp kq jn kr ks kt jr ku kv kw jv kx ky kz la dt translated">5.不要等待推进UX！</h2><p id="36a4" class="pw-post-body-paragraph jc jd if je b jf lb jh ji jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz hn dt translated">我不敢相信我还在生产中看到这个。作为一个生态系统，我们在这方面做得更好，但我想像消灭天花一样消灭它。拜托了，各位。<a class="ae ka" href="https://hackernoon.com/tagged/ethereum" rel="noopener ugc nofollow" target="_blank">以太坊</a>有~15s的封锁时间。在区块链世界里，这可能看起来很快，但在快速、反应式web应用程序的世界里，这是一生的时间。如果您使用testrpc进行开发，您可能会发现自己忘记了区块链有多慢。不要忘记区块链有多慢。每天大声说出来:“等待以太坊交易是不好的用户体验。”</p><p id="22ab" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请不要让你的用户在提交交易后无所事事。处理一个<code class="eh lp lq lr lh b">sendTransaction</code>回调(它是一个事务散列)非常简单，只需将那个散列分派到一个队列中，并定期检查它的接收情况。请考虑以下情况:</p><pre class="kc kd ke kf fq lg lh li lj aw lk dt"><span id="23b6" class="kg kh if lh b fv ll lm l ln lo">// metamask.js<br/>exports.doSomething = function(web3, param) {<br/>  const user = web3.eth.accounts[0];<br/>  web3.eth.getTransactionCount(owner, (err, nonce) =&gt; {<br/>    // Form your tx object...<br/>    web3.eth.sendTransaction(obj, (err, res) =&gt; {<br/>      if (err) { cb(err); }<br/>      else { cb(null, res); }<br/>    })<br/>}</span><span id="a428" class="kg kh if lh b fv lt lm l ln lo">// component.jsx<br/>callMetamask() {<br/>  metamask.doSomething(web3, 'something', (err, result) =&gt; {<br/>    if (err) { console.log('Error doing something.') }<br/>    else { dispatch({ type: 'QUEUE_TXHASH', result: result }) }<br/>  })<br/>}</span></pre><p id="4d31" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">有了队列中的散列，您可以在工具栏中显示它，用户可以愉快地继续使用您的应用程序，同时等待事务通过。</p><p id="b868" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ls">如果在改进你的UI之前处理交易真的很重要(你可以诚实地告诉我这是你能想到的最好的UX流程)，请给你的用户一些令人兴奋的东西</em> <a class="ae ka" href="https://www.sitepoint.com/12-creative-clever-preloader-designs/" rel="noopener ugc nofollow" target="_blank"> <em class="ls">看看</em></a><em class="ls">——也许是</em> <a class="ae ka" href="https://github.com/ethereum/wiki/wiki/White-Paper" rel="noopener ugc nofollow" target="_blank"> <em class="ls">以太坊白皮书</em> </a> <em class="ls">或者这只</em> <a class="ae ka" href="http://i.imgur.com/DPbRepM.gifv" rel="noopener ugc nofollow" target="_blank"> <em class="ls">带着浴帽的猫</em> </a> <em class="ls">。</em></p><h2 id="3bc2" class="kg kh if bd ki kj kk kl km kn ko kp kq jn kr ks kt jr ku kv kw jv kx ky kz la dt translated">6.是的，真的很简单</h2><p id="237a" class="pw-post-body-paragraph jc jd if je b jf lb jh ji jj lc jl jm jn ld jp jq jr le jt ju jv lf jx jy jz hn dt translated">三周的重度变形面具开发，这些真的是我能想到的唯一抱怨。真的，metamask很棒，也很容易设置。一般来说，如果你遵循了上面概述的规则/建议，并正确引用了<a class="ae ka" href="https://github.com/ethereum/wiki/wiki/JavaScript-API" rel="noopener ugc nofollow" target="_blank"> web3 API </a>，你应该会做得很好(记住总是使用异步调用——同步调用在metamask中不起作用)。</p><p id="aad8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你有一个问题，但在这里没有得到回答，我建议检查一下<a class="ae ka" href="https://ethereum.stackexchange.com/" rel="noopener ugc nofollow" target="_blank">以太坊栈交换</a>。</p><p id="a121" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt">—</p><p id="a391" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你喜欢我的文章，<a class="ae ka" href="https://twitter.com/ethereum_alex" rel="noopener ugc nofollow" target="_blank">在twitter上关注我</a>或者看看我的公司，<a class="ae ka" href="https://twitter.com/ConsenSysLLC" rel="noopener ugc nofollow" target="_blank"> ConsenSys </a>，因为我们做的东西很棒。</p><p id="b4fb" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一如既往，我们公开邀请您加入<a class="ae ka" href="https://www.reddit.com/r/ethereum/" rel="noopener ugc nofollow" target="_blank">以太坊社区</a>，帮助我们征服世界。</p><div class="kc kd ke kf fq ab cb"><figure class="lu hw lv lw lx ly lz paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="lu hw lv lw lx ly lz paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="lu hw lv lw lx ly lz paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="ma mb mc"><p id="f922" class="jc jd ls je b jf jg jh ji jj jk jl jm md jo jp jq me js jt ju mf jw jx jy jz hn dt translated"><a class="ae ka" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是阿妹家庭的一员。我们现在<a class="ae ka" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ka" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jc jd ls je b jf jg jh ji jj jk jl jm md jo jp jq me js jt ju mf jw jx jy jz hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ka" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ka" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kc kd ke kf fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mg"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="kc kd ke kf fq hw"><div class="bz el l di"><div class="mh mi l"/></div></figure></div></div>    
</body>
</html>