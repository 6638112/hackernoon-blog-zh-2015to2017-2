<html>
<head>
<title>How to Test API Authentication in Rails</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Rails中测试API认证</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-test-api-authentication-in-rails-2804fd31a1ea?source=collection_archive---------16-----------------------#2017-12-29">https://medium.com/hackernoon/how-to-test-api-authentication-in-rails-2804fd31a1ea?source=collection_archive---------16-----------------------#2017-12-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="10e1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本周我放假，我的一个目标是熟悉Strava API。<a class="ae jp" href="http://www.strava.com" rel="noopener ugc nofollow" target="_blank"> Strava </a>是我选择的社交媒体，它也保存了运动员的大量数据，这使得它成为构建应用程序的有趣数据源。关于<a class="ae jp" href="https://hackernoon.com/tagged/strava" rel="noopener ugc nofollow" target="_blank"> Strava </a> API最好的部分是他们的文档有多好。它组织得很好，提供了通用的curl示例，并以一种清晰的方式描述了API交互，这对于像我这样的初学者来说很容易理解。</p><p id="178f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我想构建的第一个功能是允许用户在我的应用程序上创建一个帐户，然后允许他们在Strava上用自己的个人资料验证该帐户。此外，我需要想出如何测试这个过程。我已经用Faraday通过命令行访问了API，但是生产应用程序需要一个完整的测试套件。在我们开始测试之前，让我们看一下Strava API认证流程。</p><h2 id="bc6d" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">Strava认证流程</h2><p id="eda8" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated"><a class="ae jp" href="https://strava.github.io/api/v3/oauth/" rel="noopener ugc nofollow" target="_blank"> API文档很好地概括了</a>流程:</p><ol class=""><li id="62d8" class="kq kr hu it b iu iv iy iz jc ks jg kt jk ku jo kv kw kx ky dt translated">将用户重定向到Strava身份验证URL以登录并查看授权页面。在url中传递一些参数来标识应用程序，并给Strava一个URL来重定向回。</li><li id="cfe1" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo kv kw kx ky dt translated">如果用户授权该应用程序，那么Strava使用提供的url重定向回该应用程序，并传递一个代码作为参数。如果用户取消授权，他们仍然会被重定向回应用程序，但不会得到一个代码。</li><li id="7d5b" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo kv kw kx ky dt translated">然后，应用程序必须获取该代码，以及应用程序ID和应用程序秘密令牌，然后将其发送回Strava。</li><li id="3570" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo kv kw kx ky dt translated">如果代码、应用ID和应用密码令牌都有效，那么Strava将返回一个用户身份验证令牌以及用户的基本配置文件。</li><li id="c430" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo kv kw kx ky dt translated">然后，我的应用程序将用户认证令牌和Strava配置文件ID保存在用户配置文件中。</li></ol><h2 id="0e37" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">测试环境设置</h2><p id="c94b" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated">确保测试环境数据库已经设置好(我使用的是PostreSQL ),并且已经迁移。这些是我用来联系API和运行我的测试套件的gems:</p><ul class=""><li id="8f65" class="kq kr hu it b iu iv iy iz jc ks jg kt jk ku jo le kw kx ky dt translated"><a class="ae jp" href="https://github.com/lostisland/faraday" rel="noopener ugc nofollow" target="_blank"> Faraday </a> —为我创建API调用，并管理我需要传递给API的附加参数</li><li id="ee09" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo le kw kx ky dt translated"><a class="ae jp" href="https://github.com/flori/json" rel="noopener ugc nofollow" target="_blank"> JSON </a> —将来自API的JSON响应解析成OpenStruct对象，以允许使用基本的Ruby实例方法访问响应</li><li id="2275" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo le kw kx ky dt translated"><a class="ae jp" href="https://github.com/deivid-rodriguez/byebug" rel="noopener ugc nofollow" target="_blank"> Byebug </a> —命令行调试工具(默认为rails)</li><li id="a2d6" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo le kw kx ky dt translated"><a class="ae jp" href="https://github.com/rspec/rspec-rails" rel="noopener ugc nofollow" target="_blank"> RSpec-Rails </a> —针对Rails的RSpec测试框架</li><li id="1555" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo le kw kx ky dt translated">水豚——功能测试工具，允许我像用户一样与我的网站互动</li><li id="444c" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo le kw kx ky dt translated"><a class="ae jp" href="https://github.com/copiousfreetime/launchy" rel="noopener ugc nofollow" target="_blank"> Launchy </a> —为了调试，我可以使用“保存并打开页面”来查看水豚看到的内容</li><li id="c55c" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo le kw kx ky dt translated"><a class="ae jp" href="https://github.com/DatabaseCleaner/database_cleaner" rel="noopener ugc nofollow" target="_blank"> Database_Cleaner </a> —让我为每个测试条件重置我的数据库</li><li id="4eca" class="kq kr hu it b iu kz iy la jc lb jg lc jk ld jo le kw kx ky dt translated"><a class="ae jp" href="https://github.com/jeroenvandijk/capybara-mechanize" rel="noopener ugc nofollow" target="_blank">Capybara-Mechanize</a>——很酷的gem，它允许Capybara访问我的应用程序之外的外国页面</li></ul><p id="a611" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这些都存在于我的gem文件中。主宝石名单里有法拉第和JSON。其他一切都在我的开发和测试团队中:</p><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff lf"><img src="../Images/2b3977d7b22dbf8c3a8e7dad854cf953.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HqWjqsI_h_ICqhguFeGg3g.png"/></div></div></figure><p id="f2cc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh lr ls lt lu b">database_cleaner</code>和<code class="eh lr ls lt lu b">capybara-mechanize</code>宝石需要一点配置才能正常工作，所以在我的<code class="eh lr ls lt lu b">rails_helper.rb</code>文件中我添加了以下几行:</p><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff lv"><img src="../Images/fde1f7a3f3e3c9ee6c3f6f9a15f07a74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WJeYBjIsQ0n64_SW4SsZyw.png"/></div></div></figure><figure class="lg lh li lj fq lk fe ff paragraph-image"><div class="fe ff lw"><img src="../Images/cfcc84a9c033eb237f7eb52b4ebfb031.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*dJGPffpF6lkPxl-cvR74lw.png"/></div></figure><h2 id="5792" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">测试脚本设置</h2><p id="c7e5" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated">此时，我的应用程序允许用户用他们的名字、电子邮件和密码创建一个新帐户。此外，用户需要登录才能将Strava添加到他们的帐户，他们只能从他们的个人用户/展示页面添加。让我们一行一行地检查测试设置，以展示我是如何做事情的。</p><h2 id="d333" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">第1–3行:</h2><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff lx"><img src="../Images/da1f2135b47a97e32e5aa0991182e2a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZRFM0T1eaiUQ3Z4_IWrWug.png"/></div></div></figure><p id="d1f9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">除了第3行，这些是基本的描述/上下文块。在这里我指定了我希望水豚使用的驱动程序。默认情况下，Capybara使用机架驱动程序，不允许测试套件访问任何外部域。通过包含capybara-mechanize gem，我现在可以指定驱动程序为mechanize，它允许capybara访问外部域。这很有用，因为默认驱动程序在大多数情况下都很好，我不知道使用mechanize驱动程序会对我的测试套件的其余部分产生什么样的副作用。</p><h2 id="299f" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">第4–9行:</h2><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff ly"><img src="../Images/28f992c28ad7f0512b28f869f2a3a881.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nYFaGH2BfGrChGo407vHUw.png"/></div></div></figure><p id="3539" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">创建一个基本的用户配置文件，并将<code class="eh lr ls lt lu b">current_user</code>模仿成这个配置文件，这里没有什么特别的。注意，我用的是<code class="eh lr ls lt lu b">create!</code>而不是<code class="eh lr ls lt lu b">create</code>。这样，如果<code class="eh lr ls lt lu b">create</code>失败，我会得到一条错误消息。</p><h2 id="0edc" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">第11–15行:</h2><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff lz"><img src="../Images/2a1756e04f907ac8bb77dafd1c86aa75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gBpiYGwXHJzKwsjDB0FDpQ.png"/></div></div></figure><p id="71e9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">转到这个用户的显示页面，并期待看到一个链接到<code class="eh lr ls lt lu b">“Add Strava to Account”</code>。这是Strava身份验证流程中的第1步。此外，我正在演示用户没有<code class="eh lr ls lt lu b">strava_athlete_id</code>或<code class="eh lr ls lt lu b">strava_access_token</code>。这些验证也可以属于用户模型测试，但是我把它们放在这里只是为了确保一切都按预期工作。</p><h2 id="defd" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">第17–18行:</h2><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff ma"><img src="../Images/30d59681af8dc841cbbd21f62951e92a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C3PAxRw-ZnaVUrtEA5D-1A.png"/></div></div></figure><p id="92df" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">点击链接到<code class="eh lr ls lt lu b">“Add Strava to Account”</code>。这会把我送到<a class="ae jp" href="https://www.strava.com/oauth/token" rel="noopener ugc nofollow" target="_blank">https://www.strava.com/oauth/token</a>。如果我没有使用mechanize，我会得到下面的错误消息。Capybara忽略协议和域，然后期望/oauth/token的路由出现。</p><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff mb"><img src="../Images/aa144d70aa6cd731e2657a6d4aefa6c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WG7GwoKQ4jk0TPkbf2gpmQ.png"/></div></div></figure><p id="bc37" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我可以在这里使用Launchy，通过在第18行插入'<code class="eh lr ls lt lu b">save_and_open_page</code>'来查看水豚点击<code class="eh lr ls lt lu b">‘Add Strava to Account’</code>后看到的内容。结果我被重定向到了斯特拉发的登录页面。我需要登录我的帐户，以便水豚通过授权过程。</p><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff mc"><img src="../Images/2c0836daff5cc602cd898d72bd6146ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6rj3xaRRvDAj5YpXWuSB7Q.png"/></div></div></figure><h2 id="f751" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">第19–22行:</h2><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff md"><img src="../Images/ade5a630d1ae5f801fb5af697e3ef105.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9R3rHXYWTAQM8CYEBSPsAQ.png"/></div></div></figure><p id="e696" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">水豚的方法仍然适用于外部网站，可以与这些网页互动。我查看了登录页面，以了解strava是如何命名电子邮件和密码字段的。接下来，我在终端中设置环境变量，为我的测试环境存储我的电子邮件/密码组合。这很重要，因为当我在这里或github上发帖时，我不想在互联网上到处张贴我的测试环境证书。这些可以通过终端中的导出命令来设置。</p><pre class="lg lh li lj fq me lu mf mg aw mh dt"><span id="020e" class="jq jr hu lu b fv mi mj l mk ml">export STRAVA_TEST_ENVIRONMENT_EMAIL=test@email.com<br/>export STRAVA_TEST_ENVIRONMENT_PASSWORD=12345</span></pre><h2 id="8d5b" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">第24行:</h2><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff mm"><img src="../Images/181450b3ffa3ba07df47fb1e1ade0cea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jiobiEelOxwGGeYEAIZXOQ.png"/></div></div></figure><p id="8dc7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在第22行提交了登录凭证后，我在第23行放置了另一个“save_and_open_page ”,以查看我被重定向到了哪里(见下页)。我看到我现在在授权页面，所以我想让水豚点击“授权”。这是Strava认证流程的第2步。</p><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff mn"><img src="../Images/5e852f2148b457133e11611677298fe8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RxDCVzTQCuOemZV_VmChtg.png"/></div></div></figure><h2 id="bdbc" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">第26–29行:</h2><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff mo"><img src="../Images/0528807fcb13f4a1f5401ad714b6a87f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RQi4qmyJfmB_XsTk7v9xFA.png"/></div></div></figure><p id="a7ba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是我的应用程序在引擎盖下施展小魔法并执行Strava认证流程中的步骤3–5的地方。最终结果是，我希望被重定向回用户显示页面，用户现在已经保存了他们的<code class="eh lr ls lt lu b">strava_athlete_id</code> &amp; <code class="eh lr ls lt lu b">strava_access_token</code>。这里需要注意的一点是，我最初调用的是<code class="eh lr ls lt lu b">user.strava_athlete_id</code>而不是<code class="eh lr ls lt lu b">User.find(user.id).strava_athlete_id</code>，尽管用户保存了凭证，我的测试还是失败了。结果是，<code class="eh lr ls lt lu b">user</code>仍然与我在第4行分配给它的用户的状态相关联，所以我需要直接从数据库中提取用户。</p><h2 id="8d88" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">结论</h2><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff ly"><img src="../Images/1207a61c7fd6c1da5ceb90d909aae98d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wxb8N5eN44FFIpM5uo42Qg.png"/></div></div></figure><p id="fb00" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这可能是我写过的最长的测试脚本，但是当我测试一个有如此多用户交互的过程时，这是意料之中的。如果有更好的方法来测试这个过程，请在评论中告诉我。搞清楚这个测试花了我很长时间，我不愿意承认，所以如果有一个更简单的方法来做，我会全力以赴。</p><figure class="lg lh li lj fq lk"><div class="bz el l di"><div class="mp mq l"/></div></figure></div></div>    
</body>
</html>