<html>
<head>
<title>Creating a pixelation filter in Javascript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Javascript中创建像素过滤器</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/creating-a-pixelation-filter-for-creative-coding-fc6dc1d728b2?source=collection_archive---------2-----------------------#2017-07-28">https://medium.com/hackernoon/creating-a-pixelation-filter-for-creative-coding-fc6dc1d728b2?source=collection_archive---------2-----------------------#2017-07-28</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/d9da234d2cf1b0f02bed31a363153be2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*obi7Vyj4Rex6-17x3oRl2w.gif"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Pixelating Stevie, because she’s awesome</figcaption></figure><div class=""/><p id="4742" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">欢迎来到创造性<a class="ae ke" href="https://hackernoon.com/tagged/coding" rel="noopener ugc nofollow" target="_blank">编码</a>基础的下一期。这里可以看到以前的教程<a class="ae ke" rel="noopener" href="/@radarboy3000">。</a></p><p id="7f88" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">和往常一样，我的github上有完整的代码:【https://github.com/GeorgeGally/creative_coding T4】</p><p id="648c" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">像素过滤器很容易创建，采样技术和公式在创造性编码中很有用，特别是在计算机视觉中，我很快就会谈到。</p><p id="9b5b" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">像素化滤镜的本质是简单地将屏幕分成块，然后对块的颜色进行采样。为了提高性能，我们按块采样，而不是每个像素。样本越小，我们的作品运行得越慢。</p><p id="bdbf" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">让我们从将屏幕划分成块开始…我们通过循环所有的行和列来完成，速度变慢了，看起来像这样:</p><figure class="kg kh ki kj fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff kf"><img src="../Images/35f887873841fb999abad052a879c4c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*OaI4EBp_gmRyFRE73T52RA.gif"/></div></div></figure><p id="ce47" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">该公式是循环中的循环:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="faba" class="kp kq ij kl b fv kr ks l kt ku"><em class="kv">// define the sample size </em><br/>var sample_size = 20;</span><span id="3cd5" class="kp kq ij kl b fv kw ks l kt ku"><em class="kv">// loop through the rows from to to bottom of page</em><br/>for (var y= 0; y &lt; h; y+= sample_size) {</span><span id="142c" class="kp kq ij kl b fv kw ks l kt ku"><em class="kv">  // loop through all the columns from left to right</em><br/>  for (var x = 0; x &lt; w; x+= sample_size) {</span><span id="ac5f" class="kp kq ij kl b fv kw ks l kt ku">     <em class="kv">// do something</em></span><span id="f3c7" class="kp kq ij kl b fv kw ks l kt ku">  }</span><span id="d577" class="kp kq ij kl b fv kw ks l kt ku">}</span></pre><p id="50a6" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这让我们很容易得到这样的好效果:</p><figure class="kg kh ki kj fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff kx"><img src="../Images/f5a545639c40b220f54c9f0193940dc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*dzpsxVdNzun46L-QaZ8IXg.gif"/></div></div></figure><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="2779" class="kp kq ij kl b fv kr ks l kt ku">var ctx = createCanvas("canvas1");</span><span id="f59b" class="kp kq ij kl b fv kw ks l kt ku">// define the sample size<br/>var sample_size = randomInt(20, 80);</span><span id="332c" class="kp kq ij kl b fv kw ks l kt ku">function draw(){</span><span id="e385" class="kp kq ij kl b fv kw ks l kt ku">  if(chance(200)) sample_size = randomInt(10, 40);</span><span id="fe4d" class="kp kq ij kl b fv kw ks l kt ku">  // loop through the rows from to to bottom of page<br/>  for (var y= 0; y &lt; h; y+= sample_size) {</span><span id="cac7" class="kp kq ij kl b fv kw ks l kt ku">    //loop through all the columns from left to right<br/>    for (var x = 0; x &lt; w; x+= sample_size) {<br/>      ctx.fillStyle = rgb(random(205));<br/>      ctx.fillRect(x, y, sample_size, sample_size);<br/>    }</span><span id="ea40" class="kp kq ij kl b fv kw ks l kt ku"> }</span><span id="9290" class="kp kq ij kl b fv kw ks l kt ku">}</span></pre><p id="9d04" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">唯一的新东西是函数<em class="kv"> chance()，</em>，这是一个我一直在使用的方便的小随机帮助函数，它使我能够基于概率随机触发事件。代码如下所示:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="984d" class="kp kq ij kl b fv kr ks l kt ku">function chance(value){<br/> return (random(value) &gt; value-1);<br/>}</span></pre><p id="18b2" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">但是我跑题了。</p><p id="4129" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">现在我们有了采样的公式，让我们对一个图像进行采样。我们需要一点理论…</p><p id="4555" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">用于对画布进行采样的<a class="ae ke" href="https://hackernoon.com/tagged/javascript" rel="noopener ugc nofollow" target="_blank"> Javascript </a>函数是:<em class="kv"> getImageData(start_x，start_y，sample_width，sample_height) </em>，所以要对整个屏幕进行采样，我们可以简单的做:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="4009" class="kp kq ij kl b fv kr ks l kt ku">var sample = ctx.getImageData(0,0,w,h);</span></pre><p id="c85d" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这使我们得到一个包含rgba值的数据数组的对象。我们现在需要做的就是遍历数据值并提取我们的像素值。</p><p id="baf1" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">要获得屏幕上任何一点的位置，我们可以使用神奇的公式:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="78a9" class="kp kq ij kl b fv kr ks l kt ku">var pos = (x + y * w);</span></pre><p id="0b92" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">但是，请记住，数组返回给我们的数据对于每个像素有四个值，所以要获得该像素在数组中的位置，我们只需将其乘以4:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="bd72" class="kp kq ij kl b fv kr ks l kt ku">var sample_point = (x + y * w) * 4;</span></pre><p id="d308" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然后数组中接下来的四个值将是该像素的rgba值…</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="3e3b" class="kp kq ij kl b fv kr ks l kt ku">// we want the data element of the object<br/>var sample = ctx.getImageData(0,0,w,h).data;</span><span id="cdc7" class="kp kq ij kl b fv kw ks l kt ku"> for (var y= 0; y &lt; h; y+= sample_size) {</span><span id="1d9b" class="kp kq ij kl b fv kw ks l kt ku">   for (var x = 0; x &lt; w; x+= sample_size) {</span><span id="52ee" class="kp kq ij kl b fv kw ks l kt ku">     <strong class="kl ik">var pos = (x + y * w) * 4;<br/>     var red   = sample[pos];<br/>     var green = sample[pos + 1];<br/>     var blue  = sample[pos + 2];<br/>     var alpha  = sample[pos + 3];</strong><br/>     <br/>    <em class="kv"> // ...do something with those values</em></span><span id="32dc" class="kp kq ij kl b fv kw ks l kt ku">    }</span><span id="c268" class="kp kq ij kl b fv kw ks l kt ku">}</span></pre><p id="5a7f" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们实际上可以忽略alpha值，因为我们不需要它。所以为了把它整齐地放入一个函数中，以便我们可以轻松地使用它，并且永远不会再想起它，我们做了这样的事情:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="16a6" class="kp kq ij kl b fv kr ks l kt ku">function pixelate(sample_size){</span><span id="ba86" class="kp kq ij kl b fv kw ks l kt ku">  var imgData=this.getImageData(0,0,w,h).data;<br/>  <br/>  for (var y= 0; y &lt; h; y+= sample_size) {</span><span id="7125" class="kp kq ij kl b fv kw ks l kt ku">   for (var x = 0; x &lt; w; x+= sample_size) {<br/>       <br/>     var pos = (x + y * w) * 4;<br/>     var red   = sample[pos];<br/>     var green = sample[pos + 1];<br/>     var blue  = sample[pos + 2];</span><span id="91a0" class="kp kq ij kl b fv kw ks l kt ku">     ctx.fillStyle = rgb(red, blue, green);<br/>     ctx.fillRect(x, y, sample_size, sample_size);</span><span id="4d71" class="kp kq ij kl b fv kw ks l kt ku">  }</span><span id="7905" class="kp kq ij kl b fv kw ks l kt ku">}</span></pre><figure class="kg kh ki kj fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/2aec7290bd825d6a0ba137898ba031b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*3CCSXZMTo2qQ4O3lXq0ucg.gif"/></div></div></figure><p id="5144" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们会这样说:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="36be" class="kp kq ij kl b fv kr ks l kt ku">/<em class="kv">/ create canvas</em><br/>var ctx = createCanvas("canvas1");</span><span id="639c" class="kp kq ij kl b fv kw ks l kt ku"><em class="kv">// define the sample size</em><br/>var sample_size = randomInt(20, 80);</span><span id="1104" class="kp kq ij kl b fv kw ks l kt ku"><em class="kv">//load an image</em><br/>var img = new Image();<br/>img.src = 'img/stevie.jpg';</span><span id="e447" class="kp kq ij kl b fv kw ks l kt ku">function draw(){</span><span id="94ff" class="kp kq ij kl b fv kw ks l kt ku">  if(chance(200)) sample_size = randomInt(10, 40);<br/>  ctx.drawImage(img, 0, 0, w, h);<br/>  pixelate(sample_size);</span><span id="fcda" class="kp kq ij kl b fv kw ks l kt ku">}</span><span id="fb0d" class="kp kq ij kl b fv kw ks l kt ku"><br/>function pixelate(sample_size){</span><span id="a01a" class="kp kq ij kl b fv kw ks l kt ku">  var imgData=this.getImageData(0,0,w,h).data;<br/>  <br/>  for (var y= 0; y &lt; h; y+= sample_size) {</span><span id="1735" class="kp kq ij kl b fv kw ks l kt ku">   for (var x = 0; x &lt; w; x+= sample_size) {<br/>       <br/>     var pos = (x + y * w) * 4;<br/>     var red   = sample[pos];<br/>     var green = sample[pos + 1];<br/>     var blue  = sample[pos + 2];</span><span id="3ea7" class="kp kq ij kl b fv kw ks l kt ku">     ctx.fillStyle = rgb(red, blue, green);<br/>     ctx.fillRect(x, y, sample_size, sample_size);</span><span id="86b6" class="kp kq ij kl b fv kw ks l kt ku">   }</span><span id="4d2a" class="kp kq ij kl b fv kw ks l kt ku">  }</span><span id="9772" class="kp kq ij kl b fv kw ks l kt ku">}</span></pre><p id="522f" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我想对这个函数做一些调整。首先，让我们传入一个上下文，所以如果我们愿意，我们可以在屏幕上有多个画布，并且只针对其中的一个…所以我们只传入一个额外的参数。该行:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="e04f" class="kp kq ij kl b fv kr ks l kt ku">var context = _ctx || ctx;</span></pre><p id="5d95" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">…是这样的简写:如果参数_ctx未定义，则使用默认变量ctx。如果我只有一块画布，这允许我不必传递参数。</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="d0c9" class="kp kq ij kl b fv kr ks l kt ku">function pixelate(sample_size, <strong class="kl ik">_ctx</strong>){</span><span id="4396" class="kp kq ij kl b fv kw ks l kt ku">  <strong class="kl ik">var context = _ctx || ctx;</strong><br/>  var sample = context.getImageData(0,0,w,h).data;</span><span id="faa3" class="kp kq ij kl b fv kw ks l kt ku">  for (var y= 0; y &lt; h; y+= sample_size) {<br/>    <br/>    for (var x = 0; x &lt; w; x+= sample_size) {</span><span id="6f72" class="kp kq ij kl b fv kw ks l kt ku">     var pos = (x + y * w) * 4;<br/>     var red   = sample[pos];<br/>     var green = sample[pos + 1];<br/>     var blue  = sample[pos + 2];<br/>     <strong class="kl ik">context</strong>.fillStyle = rgb(red, blue, green);<br/>     <strong class="kl ik">context</strong>.fillRect(x, y, sample_size, sample_size);<br/>    }<br/>  }</span><span id="dede" class="kp kq ij kl b fv kw ks l kt ku">}</span></pre><p id="ac4f" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">为了额外加分，我们还可以使用一个技巧来加快速度。以上功能完全没问题。但是和往常一样，在Javascript中有很多方法可以剥一只猫的皮。</p><p id="f174" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们可以使用一个无符号的<a class="ae ke" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint32Array" rel="noopener ugc nofollow" target="_blank"> 32位整数数组</a>，再加上使用<a class="ae ke" href="https://www.w3schools.com/js/js_bitwise.asp" rel="noopener ugc nofollow" target="_blank">位操作符</a>，我们可以获得一点额外的性能…所以我们的最终函数看起来像这样:</p><pre class="kg kh ki kj fq kk kl km kn aw ko dt"><span id="532d" class="kp kq ij kl b fv kr ks l kt ku">function pixelate(sample_size, _ctx){</span><span id="81a3" class="kp kq ij kl b fv kw ks l kt ku">  var context = _ctx || ctx;<br/>  <strong class="kl ik">var sourceBuffer32 = new Uint32Array(context.getImageData(0,0,w,h).data.buffer);</strong></span><span id="b80f" class="kp kq ij kl b fv kw ks l kt ku">  for(var y = 0; y &lt; h; y += sample_size){<br/>   <br/>    for(var x = 0; x &lt; w; x += sample_size){</span><span id="a30a" class="kp kq ij kl b fv kw ks l kt ku">      <strong class="kl ik">var pos = (x + y * w);<br/>      var b = (sourceBuffer32[pos] &gt;&gt; 16) &amp; 0xff;<br/>      var g = (sourceBuffer32[pos] &gt;&gt; 8) &amp; 0xff;<br/>      var r = (sourceBuffer32[pos] &gt;&gt; 0) &amp; 0xff;</strong><br/>      context.fillStyle = rgb(r,g,b);<br/>      context.centreFillRect(x, y, sample_size, sample_size);</span><span id="6d5f" class="kp kq ij kl b fv kw ks l kt ku">   }</span><span id="8a28" class="kp kq ij kl b fv kw ks l kt ku"> }</span><span id="2391" class="kp kq ij kl b fv kw ks l kt ku">}</span></pre><p id="261a" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">仅此而已。前进并像素化。</p></div><div class="ab cl ky kz hc la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="hn ho hp hq hr"><p id="be86" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">像往常一样，我的github上有完整的代码:【https://github.com/GeorgeGally/creative_coding T4】</p><p id="0992" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">你可以在这里看到我以前所有的教程<a class="ae ke" rel="noopener" href="/@radarboy3000"/>。</p></div><div class="ab cl ky kz hc la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="hn ho hp hq hr"><p id="6ec9" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如果你愿意，请跟我来</p><p id="93d2" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><a class="ae ke" href="https://www.instagram.com/radarboy3000/" rel="noopener ugc nofollow" target="_blank"><strong class="ji ik">https://www.instagram.com/radarboy3000/</strong></a></p><p id="ebaa" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><a class="ae ke" href="https://twitter.com/radarboy_japan" rel="noopener ugc nofollow" target="_blank"><strong class="ji ik">https://twitter.com/radarboy_japan</strong></a></p><div class="ht hu fm fo hv lf"><a href="https://www.facebook.com/radarboy3000" rel="noopener  ugc nofollow" target="_blank"><div class="lg ab ej"><div class="lh ab li cl cj lj"><h2 class="bd ik fv z el lk eo ep ll er et ii dt translated">雷达男孩</h2><div class="lm l"><h3 class="bd b fv z el lk eo ep ll er et ek translated">雷达男孩。145个赞。艺术、设计可视化、黑客</h3></div><div class="ln l"><p class="bd b gc z el lk eo ep ll er et ek translated">www.facebook.com</p></div></div><div class="lo l"><div class="lp l lq lr ls lo lt ib lf"/></div></div></a></div><figure class="kg kh ki kj fq hw"><div class="bz el l di"><div class="lu lv l"/></div></figure></div></div>    
</body>
</html>