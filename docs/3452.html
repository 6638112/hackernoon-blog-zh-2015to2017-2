<html>
<head>
<title>Ruby’s puts is not atomic</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ruby的puts不是原子的</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/rubys-puts-is-not-atomic-889c57fc9a28?source=collection_archive---------11-----------------------#2017-04-02">https://medium.com/hackernoon/rubys-puts-is-not-atomic-889c57fc9a28?source=collection_archive---------11-----------------------#2017-04-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="2109" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当通过并行化操作来改进构建脚本时，我意识到Ruby的<code class="eh jp jq jr js b">puts</code>不是原子的。</p><figure class="jt ju jv jw fq jx"><div class="bz el l di"><div class="jy jz l"/></div><figcaption class="ka kb fg fe ff kc kd bd b be z ek">Effects of the race condition in action</figcaption></figure><p id="c3f9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">看起来<code class="eh jp jq jr js b">puts</code>调用了底层的<code class="eh jp jq jr js b">write</code>函数两次——一次是实际打印给它的变量，另一次是打印换行符。如上所述，这导致了<code class="eh jp jq jr js b">puts</code>中的竞争情况。</p><p id="038b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我通过查看<a class="ae ke" href="https://github.com/rubinius/rubinius/blob/a57071c650a8ad336ba0bde997879a744d2c9f69/core/io.rb#L2710-L2741" rel="noopener ugc nofollow" target="_blank"> Rubinius </a>和<a class="ae ke" href="https://github.com/ruby/ruby/blob/trunk/io.c#L7184-L7240" rel="noopener ugc nofollow" target="_blank"> MRI </a>中<code class="eh jp jq jr js b">puts</code>的源代码确认了这一点。</p><div class="jt ju jv jw fq ab cb"><figure class="kf jx kg kh ki kj kk paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/861072df9f8b8046635cd23089c0413f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1022/format:webp/1*QOWb6NiKuD7jJVkqlTEmPg.png"/></div></figure><figure class="kf jx kr kh ki kj kk paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/1e2536dbd356f42c9f5569a329eb1046.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*KNORuji7noNYSmcG9Al-Uw.png"/></div><figcaption class="ka kb fg fe ff kc kd bd b be z ek ks di kt ku">Annotated source code for puts in MRI, Rubinius</figcaption></figure></div><p id="b99c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在MRI中有一个未解决的问题，通过使用<code class="eh jp jq jr js b">writev</code>而不是<code class="eh jp jq jr js b">write</code>—<a class="ae ke" href="https://bugs.ruby-lang.org/issues/9420" rel="noopener ugc nofollow" target="_blank">https://bugs.ruby-lang.org/issues/9420</a>来解决这个问题</p><p id="cedc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我通过在代码中创建一个<code class="eh jp jq jr js b">safe_puts</code>函数来解决这个问题，它看起来像这样:</p><figure class="jt ju jv jw fq jx fe ff paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="fe ff kv"><img src="../Images/55603b38774d0e850b39451e6f4e6021.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Pc0IEebEckIFkk_IGxRHQ.png"/></div></div><figcaption class="ka kb fg fe ff kc kd bd b be z ek">By supplying ‘\n’ explicitly at the end, the whole string gets printed at once</figcaption></figure><p id="94b9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">根据<a class="ae ke" href="http://stackoverflow.com/questions/3029816/how-do-i-get-a-thread-safe-print-in-python-2-6" rel="noopener ugc nofollow" target="_blank">这篇StackOverflow帖子</a>，这似乎也是Python的一个问题。</p><div class="jt ju jv jw fq ab cb"><figure class="kf jx kw kh ki kj kk paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="kf jx kw kh ki kj kk paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="kf jx kw kh ki kj kk paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="kx ky kz"><p id="f922" class="ir is la it b iu iv iw ix iy iz ja jb lb jd je jf lc jh ji jj ld jl jm jn jo hn dt translated"><a class="ae ke" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是AMI家庭的一员。我们现在<a class="ae ke" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ke" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is la it b iu iv iw ix iy iz ja jb lb jd je jf lc jh ji jj ld jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ke" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ke" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jt ju jv jw fq jx fe ff paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="fe ff le"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>