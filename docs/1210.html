<html>
<head>
<title>Cron job — a tale of a missing log</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个丢失的木头的故事</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/cron-job-a-tail-of-a-missing-log-45fa700b6fff?source=collection_archive---------0-----------------------#2016-09-25">https://medium.com/hackernoon/cron-job-a-tail-of-a-missing-log-45fa700b6fff?source=collection_archive---------0-----------------------#2016-09-25</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><h1 id="d3ca" class="ir is hu bd it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo dt translated">当在我的应用程序中使用cron作为“快速和肮脏”的调度程序时，我学到了关于日志记录的知识。</h1><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff jp"><img src="../Images/41a7632790a738bcc734d5ebcf1f973b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*t38PUVAHjw54pmiVnxkxWA.jpeg"/></div><figcaption class="jx jy fg fe ff jz ka bd b be z ek">I’m sure I logged the error somewhere</figcaption></figure><p id="051f" class="pw-post-body-paragraph kb kc hu kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">我通常使用一个调度框架来运行预定的(duh)任务。但这真的不是一个重量级的应用程序，我不想添加额外的工具和配置。选择使用<a class="ae kz" href="https://hackernoon.com/tagged/cron" rel="noopener ugc nofollow" target="_blank"> cron </a>从外部运行我的应用程序任务。</p><p id="6653" class="pw-post-body-paragraph kb kc hu kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">Cron是内置的<a class="ae kz" href="https://hackernoon.com/tagged/linux" rel="noopener ugc nofollow" target="_blank"> linux </a>调度程序。用户“MyAppUser”有一个可选的crontab(读取“cron表”)，crond(cron守护进程)从其中读取配置。任务完成，任务正在运行，一切正常。开源岩石和我的快速胜利。</p><p id="1544" class="pw-post-body-paragraph kb kc hu kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">然后就发生了。一些关键的东西坏掉了，真的坏掉了。我真的需要我通过cron运行的命令的日志。</p><p id="d771" class="pw-post-body-paragraph kb kc hu kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">但是他们在哪里？</p><p id="3044" class="pw-post-body-paragraph kb kc hu kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">按照<a class="ae kz" href="https://12factor.net/" rel="noopener ugc nofollow" target="_blank"> 12因子应用</a>的建议，我的应用记录到stdout和stderr流，让这些流从外部处理。对于常规的应用程序日志，管理程序处理stdout和stderr流，写入日志文件，循环等等..</p><p id="6670" class="pw-post-body-paragraph kb kc hu kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">但是supervisord并不运行计划任务，而是运行crond。那么谁来照顾我的日志呢？我记得在syslog中看到过cron条目，所以我查看了一下，发现了如下条目:</p><blockquote class="la lb lc"><p id="7ecc" class="kb kc ld kd b ke kf kg kh ki kj kk kl le kn ko kp lf kr ks kt lg kv kw kx ky hn dt translated">9月23日10:00:01 IP-172–30–0–129 CRON[2021]:(my user)CMD(/bin/bash/home/my user/run _ task . sh)</p><p id="7966" class="kb kc ld kd b ke kf kg kh ki kj kk kl le kn ko kp lf kr ks kt lg kv kw kx ky hn dt translated">9月23日10:00:05 IP-172–30–0–129 CRON[2018]:(CRON)信息(未安装MTA，丢弃输出)</p></blockquote><p id="aafb" class="pw-post-body-paragraph kb kc hu kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">哦。所以cron确实尝试运行my_task.sh但是“丢弃输出”。但是为什么呢？什么是MTA，它与cron日志有什么关系？</p><p id="9039" class="pw-post-body-paragraph kb kc hu kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">谷歌搜索提供了一个解释。<a class="ae kz" href="https://en.wikipedia.org/wiki/Message_transfer_agent" rel="noopener ugc nofollow" target="_blank"> MTA是“消息传输代理”的首字母缩写</a>，通常翻译为电子邮件发送服务(后缀是一种很常见的服务)。所以Cron作业输出是通过电子邮件记录的。如果您没有正确的配置，它将进入内部/var/mail/myuser文件(电子邮件格式)。</p><p id="6251" class="pw-post-body-paragraph kb kc hu kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">虽然我可以理解为什么在某些用例中通过电子邮件使用cron作业报告看起来是个好主意，但是我从来没有遇到过这样的用例:)。实际上，将MTA配置为发送电子邮件会让我收到大量没有价值的报告电子邮件(当我想搜索某些东西时，我会查看日志，而不是一直查看)。不配置它会使/var/mail/myuser充斥这种输出。我们将获得文本，但没有逐行顺序和上下文、日期戳(除非我在我的应用程序日志逻辑中注意这一点)。但更糟糕的问题是，我DONT想安装一个电子邮件服务器在我的应用服务器。打开另一个可能的攻击媒介，另一件需要担心和配置的事情，这看起来不是一个有吸引力的选择。</p><blockquote class="la lb lc"><p id="2beb" class="kb kc ld kd b ke kf kg kh ki kj kk kl le kn ko kp lf kr ks kt lg kv kw kx ky hn dt translated">排除安装电子邮件服务后，我们还能做什么？我发现这个问题有很多有问题的答案，至少在我看来是这样。他们中的大多数要么建议在应用程序代码中处理日志文件(将迫使我处理双重日志逻辑(常规的标准输出和文件日志，记录到我的用户也可以访问的地方，并处理日志循环等)。另一种常见的解决方案是将计划任务的输出重定向到手动日志文件:</p></blockquote><blockquote class="lh"><p id="2ea3" class="li lj hu bd lk ll lm ln lo lp lq ky ek translated">15 15 * * 0–5/bin/bash/home/my user/run _ task . sh &gt; &gt;/var/log/my log . log 2 &gt; &amp; 1</p></blockquote><p id="8339" class="pw-post-body-paragraph kb kc hu kd b ke lr kg kh ki ls kk kl km lt ko kp kq lu ks kt ku lv kw kx ky hn dt translated">这是一个更好的解决方案，但可能不够好，日志没有日期，除非我在应用程序中添加。同样，这是一个我需要添加一个logrotate配置的文件(这看起来并不是一件有趣的事情，并且增加了另一件需要配置和担心的事情)</p><p id="671e" class="pw-post-body-paragraph kb kc hu kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">我选择的解决方案(改编自我现在找不到的stackoverflow问题)使用了以下内容:</p><blockquote class="la lb lc"><p id="a31b" class="kb kc ld kd b ke kf kg kh ki kj kk kl le kn ko kp lf kr ks kt lg kv kw kx ky hn dt translated">15 15 * * 0–5/bin/bash/home/my user/run _ task . sh 2 &gt; &amp; 1 |/usr/bin/logger-t tag _ name</p></blockquote><ul class=""><li id="de09" class="lw lx hu kd b ke kf ki kj km ly kq lz ku ma ky mb mc md me dt translated">我们将stderr重定向到stdout</li><li id="9989" class="lw lx hu kd b ke mf ki mg km mh kq mi ku mj ky mb mc md me dt translated">我们将结果通过管道传输到系统“logger”实用程序，该实用程序负责写入系统日志(duh)，在最近的ubuntu发行版中写入/vat/log/syslog(某些linux发行版会记录到/var/log/messages)</li><li id="62a4" class="lw lx hu kd b ke mf ki mg km mh kq mi ku mj ky mb mc md me dt translated">我们添加了一个标签，以便于搜索和查找</li></ul><p id="6a92" class="pw-post-body-paragraph kb kc hu kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">尝试:</p><blockquote class="la lb lc"><p id="acc3" class="kb kc ld kd b ke kf kg kh ki kj kk kl le kn ko kp lf kr ks kt lg kv kw kx ky hn dt translated">echo " hey there " 2 &gt; &amp; 1 | logger-t my _ tag</p></blockquote><p id="0650" class="pw-post-body-paragraph kb kc hu kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">并检查/var/log/syslog中的结果</p><blockquote class="la lb lc"><p id="4739" class="kb kc ld kd b ke kf kg kh ki kj kk kl le kn ko kp lf kr ks kt lg kv kw kx ky hn dt translated">9月24日09:37:47你好</p></blockquote><p id="dc82" class="pw-post-body-paragraph kb kc hu kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">因此，结果将是把cron任务的输出记录到一个可靠的日志文件中，其中包含服务器上同时发生的其他事情的所有所需上下文。</p><p id="b86f" class="pw-post-body-paragraph kb kc hu kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky hn dt translated">任务完成。更改这个日志配置很快就发现了我一直在寻找的bug。</p><div class="jq jr js jt fq ab cb"><figure class="mk ju ml mm mn mo mp paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mk ju ml mm mn mo mp paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mk ju ml mm mn mo mp paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="la lb lc"><p id="f922" class="kb kc ld kd b ke kf kg kh ki kj kk kl le kn ko kp lf kr ks kt lg kv kw kx ky hn dt translated"><a class="ae kz" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae kz" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae kz" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae kz" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="kb kc ld kd b ke kf kg kh ki kj kk kl le kn ko kp lf kr ks kt lg kv kw kx ky hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kz" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kz" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jq jr js jt fq ju fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff mq"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mr ms l"/></div></figure></div></div>    
</body>
</html>