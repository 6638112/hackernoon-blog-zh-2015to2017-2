<html>
<head>
<title>Configuring the new ALB Host based routing with terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用terraform配置新的基于ALB主机的路由</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/configuring-the-new-alb-host-based-routing-with-terraform-358361bad12b?source=collection_archive---------3-----------------------#2017-04-06">https://medium.com/hackernoon/configuring-the-new-alb-host-based-routing-with-terraform-358361bad12b?source=collection_archive---------3-----------------------#2017-04-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="e542" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">昨天，<a class="ae jp" href="https://hackernoon.com/tagged/amazon" rel="noopener ugc nofollow" target="_blank"> Amazon </a>宣布了一项期待已久的应用负载平衡器新功能。</p><div class="jq jr fm fo js jt"><a href="https://aws.amazon.com/about-aws/whats-new/2017/04/elastic-load-balancing-adds-support-for-host-based-routing-and-increased-rules-on-its-application-load-balancer/" rel="noopener  ugc nofollow" target="_blank"><div class="ju ab ej"><div class="jv ab jw cl cj jx"><h2 class="bd hv fv z el jy eo ep jz er et ht dt translated">弹性负载平衡增加了对基于主机的路由的支持，并增加了其应用规则…</h2><div class="ka l"><h3 class="bd b fv z el jy eo ep jz er et ek translated">我们很高兴宣布在应用负载平衡器上支持基于主机的路由。基于主机的路由允许…</h3></div><div class="kb l"><p class="bd b gc z el jy eo ep jz er et ek translated">aws.amazon.com</p></div></div><div class="kc l"><div class="kd l ke kf kg kc kh ki jt"/></div></div></a></div><p id="68e3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在<a class="ae jp" href="http://globality.com" rel="noopener ugc nofollow" target="_blank"> Globality </a>，我们使用ALB将流量路由到我们的ECS集群。我们利用目标群体来定位我们的许多微服务。</p><p id="5e4b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个功能消除了我们路由系统中的很多复杂性，我认为用<a class="ae jp" href="https://hackernoon.com/tagged/terraform" rel="noopener ugc nofollow" target="_blank">地形</a>配置这个功能是值得的</p><h1 id="8cfe" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">代码</h1><pre class="lh li lj lk fq ll lm ln lo aw lp dt"><span id="4a3c" class="lq kk hu lm b fv lr ls l lt lu">resource "aws_alb" "alb" {<br/>  name            = "${var.name}-alb-${var.environment}"<br/>  internal        = true<br/>  security_groups = ["${var.security_group_id}"]<br/>  subnets         = ["${split(",", var.subnet_ids)}"]</span><span id="48ca" class="lq kk hu lm b fv lv ls l lt lu">tags {<br/>    Environment = "${var.environment}"<br/>  }<br/>}</span><span id="1f22" class="lq kk hu lm b fv lv ls l lt lu">resource "aws_alb_target_group" "alb_targets" {<br/>  count     = "${length(keys(var.services_map))}"<br/>  name      = "${element(values(var.services_map), count.index)}-${var.environment}"<br/>  port      = "${element(keys(var.services_map), count.index)}"<br/>  protocol  = "HTTP"<br/>  vpc_id    = "${var.vpc_id}"</span><span id="9eb4" class="lq kk hu lm b fv lv ls l lt lu">health_check {<br/>    healthy_threshold   = 2<br/>    interval            = 15<br/>    path                = "/api/health"<br/>    timeout             = 10<br/>    unhealthy_threshold = 2<br/>  }</span><span id="1609" class="lq kk hu lm b fv lv ls l lt lu">tags {<br/>    Color       = "${var.color}"<br/>    Service     = "${element(values(var.services_map), count.index)}"<br/>    Tier        = "${var.name}"<br/>    Environment = "${var.environment}"<br/>  }<br/>}</span><span id="ce52" class="lq kk hu lm b fv lv ls l lt lu">resource "aws_alb_listener" "alb_listener" {<br/>  count             = "1"<br/>  load_balancer_arn = "${aws_alb.alb.arn}"<br/>  port              = "${element(keys(var.services_map), count.index)}"<br/>  protocol          = "HTTPS"<br/>  ssl_policy        = "ELBSecurityPolicy-2015-05"<br/>  certificate_arn   = "${var.ssl_certificate_arn}"</span><span id="e27d" class="lq kk hu lm b fv lv ls l lt lu">default_action {<br/>    target_group_arn = "${element(aws_alb_target_group.alb_targets.*.arn, 0)}"<br/>    type = "forward"<br/>  }<br/>}</span><span id="7207" class="lq kk hu lm b fv lv ls l lt lu">resource "aws_alb_listener_rule" "route_path" {<br/>  count         = "${length(values(var.services_map))}"<br/>  listener_arn  = "${aws_alb_listener.alb_listener.arn}"<br/>  priority      = "${1 + count.index}"</span><span id="73ad" class="lq kk hu lm b fv lv ls l lt lu">action {<br/>    type = "forward"<br/>    target_group_arn = "${element(aws_alb_target_group.alb_targets.*.arn, count.index)}"<br/>  }</span><span id="d431" class="lq kk hu lm b fv lv ls l lt lu">condition {<br/>    field = "host-header"<br/>    values = ["${element(values(var.services_map), count.index)}.${var.domain}"]<br/>  }</span><span id="bf4f" class="lq kk hu lm b fv lv ls l lt lu">lifecycle {<br/>    ignore_changes = ["priority"]<br/>  }<br/>}</span></pre><p id="4313" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如您所见，我们正在创建一个只有一个监听器的负载平衡器。这个侦听器是“默认操作”，可以有许多路由规则。</p><p id="d3d9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在过去，这些规则只包括路径，新的特点是增加了主机头。</p><p id="002b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">举个例子。默认动作是我们所有微服务中的一个微服务。然后，我们为所有其他服务的HTTP主机添加规则，并将流量路由到它们的目标组。</p><p id="6151" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">不仅仅是一篇简短的代码文章</strong></p><p id="f46c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">真的比什么都重要，这是一个文化岗位。如果你知道你的系统有问题，你需要一直寻找解决方案，以及如何让它变得更好。</p><p id="44bf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这项功能昨天才推出，今天我们已经在使用它，并融合了整个开发集群。</p><p id="c382" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这从我们的terraform存储库中删除了大约200行代码，并且可能从我们用于管理和翻转部署环境的脚本中删除了大约相同数量的代码。</p><blockquote class="lw lx ly"><p id="5a62" class="ir is lz it b iu iv iw ix iy iz ja jb ma jd je jf mb jh ji jj mc jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="dca4" class="ir is lz it b iu iv iw ix iy iz ja jb ma jd je jf mb jh ji jj mc jl jm jn jo hn dt translated">要了解更多信息，请<a class="ae jp" href="https://goo.gl/4ofytp" rel="noopener ugc nofollow" target="_blank">阅读我们的“关于”页面</a>、<a class="ae jp" href="http://bit.ly/HackernoonFB" rel="noopener ugc nofollow" target="_blank">在脸书上给我们点赞/发消息</a>，或者简单地说，<a class="ae jp" href="https://goo.gl/k7XYbx" rel="noopener ugc nofollow" target="_blank"> tweet/DM @HackerNoon。</a></p><p id="708a" class="ir is lz it b iu iv iw ix iy iz ja jb ma jd je jf mb jh ji jj mc jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lh li lj lk fq md"><div class="bz el l di"><div class="me mf l"/></div></figure></div></div>    
</body>
</html>