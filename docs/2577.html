<html>
<head>
<title>SQL Server Profiler Best Practices and Tuning Advisory</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL Server Profiler最佳实践和优化建议</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/sql-server-profiler-best-practices-and-tuning-advisory-d8c746f54809?source=collection_archive---------3-----------------------#2017-02-05">https://medium.com/hackernoon/sql-server-profiler-best-practices-and-tuning-advisory-d8c746f54809?source=collection_archive---------3-----------------------#2017-02-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="770a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://hackernoon.com/tagged/sql" rel="noopener ugc nofollow" target="_blank"> SQL </a> Profiler是一个很棒的工具，可以让你看到SQL Server内部发生了什么。您可以找出性能最差的查询是什么，查询执行的频率等等。</p><p id="4a41" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要实现最佳可行索引，请执行3个步骤:</p><ul class=""><li id="eb97" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated">收集当前工作量<a class="ae jp" href="https://hackernoon.com/tagged/information" rel="noopener ugc nofollow" target="_blank">信息</a></li><li id="9f9e" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">使用探查器根据工作负载确定索引是否合适</li><li id="5d8f" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">使用优化顾问更新索引</li></ul><figure class="kf kg kh ki fq kj fe ff paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="fe ff ke"><img src="../Images/1ceecb7465ed202f10c48dadc3d870ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*b-2UmUjT7kTPe2z6."/></div></div></figure><p id="bc76" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">探查器自动收集工作负载数据，优化顾问获取探查器生成的工作负载数据，并提供适当的索引。要跟踪特定数据库，请使用<strong class="it hv">列过滤器</strong>功能。使用优化模板启动跟踪，并将跟踪数据保存到跟踪文件中。</p><ul class=""><li id="24c6" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated">点击工具</li><li id="0e0f" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">单击数据库引擎优化顾问</li><li id="047d" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">提供跟踪文件</li><li id="44a3" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">选择需要执行跟踪的数据库</li><li id="f2ee" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">在调整选项中，转到高级选项可以指定建议的最大空间</li><li id="12cb" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">单击开始分析</li></ul><p id="d6f6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">结果表明，如果实施这些建议，可以实现多大的改进:</p><figure class="kf kg kh ki fq kj fe ff paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="fe ff kq"><img src="../Images/05f655c3d0919c6564f096f1cadfc4b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FBqa1oIA0RItDiBa."/></div></div></figure><p id="fdf5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它还有一个定义列，显示了实现什么来提高数据库的速度，例如:</p><figure class="kf kg kh ki fq kj fe ff paragraph-image"><div class="fe ff kr"><img src="../Images/04702edd1cf55906313f49fc254feeb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:994/0*il2P_QMmL-kdltcD."/></div></figure><p id="f577" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">SQL事件探查器最佳实践:</strong></p><ul class=""><li id="19f6" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated">切勿在数据库服务器上运行SQL事件探查器</li><li id="4cd1" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">直接跟踪到文件，而不是跟踪到表</li><li id="81c0" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">过滤结果，如“持续时间&gt; 1000”</li><li id="982b" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">仅包含您感兴趣的事件，如<code class="eh ks kt ku kv b">SP:Completed</code>和<code class="eh ks kt ku kv b">SQL:BatchCompleted</code></li><li id="c378" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">使用用户名、服务器名和应用程序名等过滤器</li><li id="58b3" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">在远程系统上运行SQL事件探查器</li><li id="402c" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">将跟踪事件保存到预定义大小的翻转文件中</li><li id="43e0" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">不要长时间捕获showplan事件，以避免文件过大</li><li id="c025" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">创建模板以便快速访问</li><li id="627a" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">出于优化目的，请使用推荐的优化模板</li></ul><p id="399e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">如何使用SQL Server事件探查器捕获死锁:</strong></p><p id="fe23" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">若要捕获死锁，请首先连接到SQL Server数据库。在SQL Server Management Studio中打开SQL事件探查器:</p><ul class=""><li id="eaae" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated">点击工具</li><li id="bb33" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">单击SQL Server事件探查器</li><li id="ba09" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">连接到我们需要执行分析的服务器</li><li id="81c3" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">在“跟踪属性”窗口的“常规”选项卡下，选择空白模板</li><li id="887e" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">在事件选择选项卡上，选择锁叶下的死锁图形</li></ul><figure class="kf kg kh ki fq kj fe ff paragraph-image"><div class="fe ff kw"><img src="../Images/b177dd1ec1bfe1a31b714ab5d78c88ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:620/0*7rsyqKJqwyVBvqLW."/></div></figure><p id="db1a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们执行下面的查询:</p><figure class="kf kg kh ki fq kj fe ff paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="fe ff kx"><img src="../Images/a9187138124d2cf229956fce7528476c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*C3K-yM-XODSu0FLv."/></div></div></figure><p id="9261" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">按以下顺序:</p><ol class=""><li id="6625" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo ky jw jx jy dt translated">执行蓝色矩形中的查询</li><li id="3af9" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ky jw jx jy dt translated">执行绿色矩形中的查询</li><li id="e099" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ky jw jx jy dt translated">执行以灰色突出显示的查询</li><li id="b7e1" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ky jw jx jy dt translated">执行以蓝色突出显示的查询</li></ol><p id="e148" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意，进程id显示在SQL Server的信息栏上:</p><figure class="kf kg kh ki fq kj fe ff paragraph-image"><div class="fe ff kz"><img src="../Images/23fcc95154e56023cc55ebaf22cd4657.png" data-original-src="https://miro.medium.com/v2/resize:fit:1014/0*bCg0TmPtiIj_AgmI."/></div></figure><p id="e8d1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在执行第4步时将生成死锁:</p><figure class="kf kg kh ki fq kj fe ff paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="fe ff la"><img src="../Images/9849bb51b179248d6f2ea098861594ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xmT47PsXytiK4Hg7."/></div></div></figure><p id="1ed4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了以后的分析，可以从文件-&gt;导出-&gt;提取SQL Server事件-&gt;提取死锁事件…</p><p id="6f50" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">分析死锁图形:</p><ol class=""><li id="cfec" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo ky jw jx jy dt translated">带蓝叉的椭圆表示被SQL Server选为死锁牺牲品的事务/进程</li><li id="dfd8" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ky jw jx jy dt translated">椭圆形代表流程，不带叉的代表成功完成的交易/流程</li><li id="9ea5" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ky jw jx jy dt translated">死锁优先级设置为默认值，即0</li><li id="fda2" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ky jw jx jy dt translated">我们还使用了日志，这表示使用了事务日志。如果事务进行了大量更新，日志大小会更大。因此，滚动一个已经进行了大量更新的事务将花费大量成本。在我们的例子中，死锁牺牲品是具有较少事务日志的一方，因为这样会花费较少的成本。矩形代表资源节点。</li><li id="6741" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ky jw jx jy dt translated">矩形代表资源节点。</li><li id="607f" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ky jw jx jy dt translated">通过使用以下查询，与资源节点相关联的HoBtID(堆或二叉树ID)用于从<code class="eh ks kt ku kv b">sys.partitions</code>视图中找到死锁所涉及的数据库对象:</li></ol><pre class="kf kg kh ki fq lb kv lc ld aw le dt"><span id="8a31" class="lf lg hu kv b fv lh li l lj lk">SELECT object_name([object_id]) from sys.partitions <br/>WHERE hobt_id = xxxxxx</span></pre><ol class=""><li id="cccd" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo ky jw jx jy dt translated">箭头表示我们在每个资源节点上拥有的锁的类型</li><li id="0f48" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo ky jw jx jy dt translated">箭头上的符号X和S代表排他锁和共享锁</li></ol><p id="3b03" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">来源:</p><ul class=""><li id="1c48" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated"><a class="ae jp" href="https://www.mssqltips.com/sqlservertutorial/3501/sql-server-profiler-best-practices/" rel="noopener ugc nofollow" target="_blank"> SQL Server事件探查器最佳实践</a></li><li id="eaeb" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated"><a class="ae jp" href="https://www.youtube.com/watch?v=AaPaIVI-yyI" rel="noopener ugc nofollow" target="_blank">使用探查器和优化顾问提高SQL Server性能</a></li><li id="d581" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated"><a class="ae jp" href="https://goo.gl/photos/VFrQy5CEX1emE39E9" rel="noopener ugc nofollow" target="_blank">照片</a></li></ul></div><div class="ab cl ll lm hc ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hn ho hp hq hr"><p id="ddf7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="ls">最初发布于</em><a class="ae jp" href="http://xameeramir.github.io/SQL-Server-Profiler-Best-Practices-and-Tuning-Advisor/" rel="noopener ugc nofollow" target="_blank"><em class="ls">xameeramir . github . io</em></a><em class="ls">。</em></p><figure class="kf kg kh ki fq kj"><div class="bz el l di"><div class="lt lu l"/></div></figure></div></div>    
</body>
</html>