<html>
<head>
<title>How to write clean code for cascaded promises</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何为级联承诺编写干净的代码</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-write-clean-code-for-cascaded-promises-809de5b950fd?source=collection_archive---------12-----------------------#2017-09-25">https://medium.com/hackernoon/how-to-write-clean-code-for-cascaded-promises-809de5b950fd?source=collection_archive---------12-----------------------#2017-09-25</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="76e7" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">关于相互依赖的承诺的深入指导</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/a70001f357a6a360b4106f8aa7727997.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UBUFWJyxkLyllDuF8O9fUg.jpeg"/></div></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">Photo by <a class="ae jz" href="https://unsplash.com/photos/vYo_Arzy_WU?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Luis Perdigao</a> on <a class="ae jz" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="874a" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">作为一名开发人员，我一直在寻找编写更干净代码的方法。</p><p id="76be" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">一年前，我发布了一个名为<a class="ae jz" href="https://github.com/pedsmoreira/premiere" rel="noopener ugc nofollow" target="_blank"> Premiere </a>的库，旨在方便用Javascript在前端使用Restful APIs。我现在正在构建一个v2版本的库，在这个过程中，我注意到还有让代码更干净的空间，特别是在承诺方面。</p><p id="2f4e" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">在这篇文章中，我不会解释承诺的基础，但是如果你正在寻找，看看戴夫·阿切利的文章，他在这方面做得很好。</p><p id="4e4d" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated"><em class="kw">免责声明:寻找异步/等待示例？跳到最后，单击存储库链接。</em></p></div><div class="ab cl kx ky hc kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hn ho hp hq hr"><p id="5b47" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">虽然承诺不是HTTP请求的唯一性，但这正是它们通常的用途，所以这将是本文示例的主题。</p><p id="034e" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">让我们开始吧:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="le lf l"/></div></figure><p id="499a" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">这是一段直截了当的代码，工作做得很好。然而，如果我们采用相同的功能，并添加更多的功能，如缓存，它可以开始变得复杂。这里有一个例子:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="le lf l"/></div></figure><p id="3a10" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">如你所见，这个例子不像上一个例子那样干净。做的事情太多了。当然这不是世界末日，但是理想情况下每个函数应该只做一件事，所以测试和重用它更容易。</p><p id="d2d8" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">如果我们添加另一个级别的缓存，这个问题会变得更加明显。因此，让我们添加Promise缓存(以防止发出两个相同的请求)并看看它是什么样子的:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="le lf l"/></div></figure><p id="0ea8" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">我们离“只做一件事”更远了。我们添加到代码中的东西越多，它就会变得越乱，也越难重用。例如，如果我们决定创建一个<code class="eh lg lh li lj b">fetchAndCacheItem</code>,这将要求我们复制所有的代码。</p></div><div class="ab cl kx ky hc kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hn ho hp hq hr"><h2 id="04c7" class="lk ll hu bd lm ln lo lp lq lr ls lt lu kj lv lw lx kn ly lz ma kr mb mc md me dt translated">分解它</h2><p id="720c" class="pw-post-body-paragraph ka kb hu kc b kd mf iv kf kg mg iy ki kj mh kl km kn mi kp kq kr mj kt ku kv hn dt translated">分解的第一步是将事情分成更多的功能，每个功能负责一个问题。我们要做的是创建三个函数，每个函数负责做三件事情中的一件:</p><ol class=""><li id="82f6" class="mk ml hu kc b kd ke kg kh kj mm kn mn kr mo kv mp mq mr ms dt translated">缓存承诺</li><li id="60ce" class="mk ml hu kc b kd mt kg mu kj mv kn mw kr mx kv mp mq mr ms dt translated">缓存结果</li><li id="3d43" class="mk ml hu kc b kd mt kg mu kj mv kn mw kr mx kv mp mq mr ms dt translated">取数据</li></ol><p id="29f9" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">这里的主要挑战是将一个片段连接到另一个片段，因为并不是所有的片段都需要每次都执行(例如缓存时)。为此，我们将提供对缓存函数的回调，以便在缓存不存在时调用它们。</p><p id="0edb" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">下面是代码:<em class="kw">(为了清楚起见，隐藏了缓存方法)</em></p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="le lf l"/></div></figure><p id="a116" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">好多了吧？我们确实有更多的代码行，但是阅读维护要容易得多。回到<code class="eh lg lh li lj b">fetchAndCacheItem</code>提到的，随着我们关注点的分离，我们可以开始看到重用相同功能的途径。</p></div><div class="ab cl kx ky hc kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hn ho hp hq hr"><h2 id="75dd" class="lk ll hu bd lm ln lo lp lq lr ls lt lu kj lv lw lx kn ly lz ma kr mb mc md me dt translated">下一步</h2><p id="4613" class="pw-post-body-paragraph ka kb hu kc b kd mf iv kf kg mg iy ki kj mh kl km kn mi kp kq kr mj kt ku kv hn dt translated">我们已经达到了令人满意的程度，但是如果我告诉你我们可以做得更好呢？</p><p id="fa04" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">看一下我们的最后一个函数<code class="eh lg lh li lj b">fetchAndCacheUser</code>，我们可以看到这些函数是以相反的执行顺序声明的，这可能会很混乱。我们还必须声明一个新的变量，并为每一步分配一个函数，这会使代码变得混乱。</p><p id="5a92" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">为了解决这些问题，我创建了<code class="eh lg lh li lj b">promise-cascade</code>库。下面是使用<code class="eh lg lh li lj b">promise-cascade</code>时<code class="eh lg lh li lj b">fetchAndCacheUser`</code>函数的样子:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="le lf l"/></div></figure><p id="d748" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">如你所见，代码现在是按照自然顺序编写的，没有了<code class="eh lg lh li lj b">const ... = () =&gt; ...</code>的混乱。</p><p id="d6d7" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">在一些大量使用这些功能的情况下，扩展<code class="eh lg lh li lj b">PromiseCascade</code>并创建助手方法会很有帮助，因此可以调用<code class="eh lg lh li lj b">cascade.something(value1, value2)</code>而不是<code class="eh lg lh li lj b">cascade.push(something.bind(this), value1, value2)</code>。你可以在GitHub repo 上看到这个<a class="ae jz" href="https://github.com/pedsmoreira/promise-cascade" rel="noopener ugc nofollow" target="_blank">的例子。</a></p><p id="6a0b" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">更多细节和例子(包括<code class="eh lg lh li lj b">async</code>)请查看GitHub。如果你喜欢它，我很感激你给它一个🌟明星。</p><div class="my mz fm fo na nb"><a href="https://github.com/pedsmoreira/promise-cascade" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab ej"><div class="nd ab ne cl cj nf"><h2 class="bd hv fv z el ng eo ep nh er et ht dt translated">佩兹莫瑞拉/无极瀑布</h2><div class="ni l"><h3 class="bd b fv z el ng eo ep nh er et ek translated">JS承诺级联变得简单</h3></div><div class="nj l"><p class="bd b gc z el ng eo ep nh er et ek translated">github.com</p></div></div><div class="nk l"><div class="nl l nm nn no nk np jt nb"/></div></div></a></div></div><div class="ab cl kx ky hc kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hn ho hp hq hr"><h2 id="ad68" class="lk ll hu bd lm ln lo lp lq lr ls lt lu kj lv lw lx kn ly lz ma kr mb mc md me dt translated">❤️喜欢。分享一下。留下你的评论。</h2><p id="f3b6" class="pw-post-body-paragraph ka kb hu kc b kd mf iv kf kg mg iy ki kj mh kl km kn mi kp kq kr mj kt ku kv hn dt translated">别忘了传播爱。加入你喜欢的，与你的朋友和同事分享。也非常欢迎你在下面留下你的评论。</p><p id="3545" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">你可以继续关注我在<a class="ae jz" href="https://twitter.com/pedsmoreira" rel="noopener ugc nofollow" target="_blank">twitter.com/pedsmoreira</a>上创作的东西，或者订阅我的时事通讯:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nq lf l"/></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">Don't worry, no spam ❤</figcaption></figure></div><div class="ab cl kx ky hc kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hn ho hp hq hr"><h2 id="0287" class="lk ll hu bd lm ln lo lp lq lr ls lt lu kj lv lw lx kn ly lz ma kr mb mc md me dt translated">额外的</h2><p id="80b6" class="pw-post-body-paragraph ka kb hu kc b kd mf iv kf kg mg iy ki kj mh kl km kn mi kp kq kr mj kt ku kv hn dt translated">如果你喜欢用爱制作的软件，我想邀请你参加<a class="ae jz" href="http://gitshowcase.com/" rel="noopener ugc nofollow" target="_blank"> GitShowcase </a>。来获得你自己的摇滚明星作品集🤘。<em class="kw"> cc </em> <a class="nr ns gr" href="https://medium.com/u/f2368f957647?source=post_page-----809de5b950fd--------------------------------" rel="noopener" target="_blank"> <em class="kw">维克托·桑托斯</em> </a></p><div class="my mz fm fo na nb"><a href="https://www.gitshowcase.com/" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab ej"><div class="nd ab ne cl cj nf"><h2 class="bd hv fv z el ng eo ep nh er et ht dt translated">GitShowcase</h2><div class="ni l"><h3 class="bd b fv z el ng eo ep nh er et ek translated">开发人员，在即插即用产品组合中展示您的最佳项目。最棒的是，免费的。</h3></div><div class="nj l"><p class="bd b gc z el ng eo ep nh er et ek translated">www.gitshowcase.com</p></div></div><div class="nk l"><div class="nt l nm nn no nk np jt nb"/></div></div></a></div></div></div>    
</body>
</html>