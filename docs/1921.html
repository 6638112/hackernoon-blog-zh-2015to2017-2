<html>
<head>
<title>Calling Python from Elixir: ErlPort vs Thrift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Elixir调用Python:erl port vs Thrift</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/calling-python-from-elixir-erlport-vs-thrift-be75073b6536?source=collection_archive---------4-----------------------#2016-12-20">https://medium.com/hackernoon/calling-python-from-elixir-erlport-vs-thrift-be75073b6536?source=collection_archive---------4-----------------------#2016-12-20</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="5e37" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">学习和使用Elixir是我最愉快的<a class="ae jp" href="https://hackernoon.com/tagged/programming" rel="noopener ugc nofollow" target="_blank">编程</a>经历之一，它有一个很棒的社区和许多很棒的工具。到目前为止，我遇到的唯一问题是社区中的一些图书馆不存在或者还没有完全开发出来。</p><p id="09c1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最近，当我需要处理一些大型GeoJSON文件时，我遇到了这个问题，这些文件定义了街区和城市区域的纬度/经度边界。数据用多边形表示，我需要找出哪些街区属于商业区。这需要检测两个多边形之间的交点，这是一个很难解决的问题。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/8b7dafbfd16d33adb21eaba555fcd6f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2GfT9dGckVYHwIFYX6IJjQ.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">city blocks in red, commercial zones layered on top in green</figcaption></figure><p id="760f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我在Elixir中找不到任何库来帮助我做这件事，但是有一个Python库，<a class="ae jp" href="https://pypi.python.org/pypi/Shapely" rel="noopener ugc nofollow" target="_blank"> Shapely </a>，它正好可以满足我的需要。我找到了两个将它集成到我的项目中的选项，ErlPort和Apache Thrift。</p><p id="77b6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了说明我是如何使用这两个文件的，我将通过一个简单的例子来说明这两个文件，一个定义块，一个定义区域。我假设非商业区域已经被过滤掉了，我们只是试图找到与任何区域相交的区块。这些文件的格式如下:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="kg kh l"/></div></figure><p id="bd95" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于这些例子，我创建了一个新的mix项目，PythonCalls。代码和GeoJSON文件可从这里获得:<a class="ae jp" href="https://github.com/chiragtoor/python_calls" rel="noopener ugc nofollow" target="_blank">https://github.com/chiragtoor/python_calls</a></p><h2 id="68d7" class="ki kj hu bd kk kl km kn ko kp kq kr ks jc kt ku kv jg kw kx ky jk kz la lb lc dt translated">使用ErlPort</h2><p id="2ebf" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">首先，我们可以使用<a class="ae jp" href="https://github.com/devinus/poison" rel="noopener ugc nofollow" target="_blank"> Poison </a>提取块和区域信息，记住我们的示例文件非常小，因此我们可以将它们完全读入内存:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="kg kh l"/></div></figure><p id="ff56" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用这些私有辅助函数，我们可以通过模式匹配获得区块和区域的经纬度坐标:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="kg kh l"/></div></figure><p id="a8e3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们需要一些Python代码，这些代码将接受这些坐标，并使用Shapely的多边形来检测交叉点:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="kg kh l"/></div></figure><p id="a1d5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过ErlPort连接这两部分非常简单，我们需要将它添加到我们的deps中:</p><pre class="jr js jt ju fq li lj lk ll aw lm dt"><span id="7fad" class="ki kj hu lj b fv ln lo l lp lq"> {:erlport, git: “https://github.com/hdima/erlport.git"}</span></pre><p id="f1f6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在只需启动一个Python实例，并使用它来调用我们的Python函数，因为我们的块和区域仅由列表和浮点组成，我们传递给Python的数据被ErlPort自动转换为Python的等效数据:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="kg kh l"/></div></figure><p id="6741" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有了这个，我们的Elixir和Python片段就连接起来了，我们可以很容易地使用Shapely来区分哪些区块进入了商业区。</p><h2 id="8d49" class="ki kj hu bd kk kl km kn ko kp kq kr ks jc kt ku kv jg kw kx ky jk kz la lb lc dt translated">使用Apache Thrift</h2><p id="0761" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">多亏了Pinterest的Riffed库，使用Thrift变得非常容易。这里我将展示一个快速设置，更多关于节俭的细节请参考<a class="ae jp" href="https://thrift.apache.org/" rel="noopener ugc nofollow" target="_blank">项目网页</a>。</p><p id="984d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过Thrift，我们将在Python中建立一个单独的服务，该服务将通过一个Elixir客户端调用。Riffed Github repo中的<a class="ae jp" href="https://github.com/pinterest/riffed/blob/master/doc/GettingStarted.md" rel="noopener ugc nofollow" target="_blank">入门指南</a>涵盖了如何很好地设置Riffed，所以假设已经完成，我们需要定义一个Thrift接口文件。这定义了我们将构建的服务和将使用的数据结构:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="kg kh l"/></div></figure><p id="2a0d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们需要能够以某种方式表达我们的块和区域，所以我们对每一对经纬度坐标都有一个点结构，对块/区域的所有点都有一个边界结构。该服务只需要一个函数，它将接受一个块和区域，并告诉我们它们是否相交。我们需要运行Thrift，以便在这个接口之上构建我们的Python服务。</p><pre class="jr js jt ju fq li lj lk ll aw lm dt"><span id="73b6" class="ki kj hu lj b fv ln lo l lp lq">thrift -gen py -out python/ ./thrift/geoservice.thrift</span></pre><p id="8921" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这需要我们定义的接口，并将几个文件输出到mix项目根目录下的一个名为“python”的目录中。我们将使用这些生成的文件来实现我们的服务:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="kg kh l"/></div></figure><p id="a191" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我们需要使用Riffed为我们的Python服务设置一个Elixir客户端，这也将为我们提供在Thrift文件中指定的数据结构的Elixir结构:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="kg kh l"/></div></figure><p id="9541" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">运行我们的Python服务后，我们可以使用与之前相同的设置，并通过我们的客户端进行调用:</p><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="kg kh l"/></div></figure><p id="6185" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们正在使用GeoJSON数据为每个块和区域创建边界结构，这些数据将在我们的服务调用期间由生成的Thrift代码接收并在Elixir和Python数据结构之间转换。</p><h2 id="da04" class="ki kj hu bd kk kl km kn ko kp kq kr ks jc kt ku kv jg kw kx ky jk kz la lb lc dt translated">比较这两种方法</h2><p id="7aa9" class="pw-post-body-paragraph ir is hu it b iu ld iw ix iy le ja jb jc lf je jf jg lg ji jj jk lh jm jn jo hn dt translated">建立这两种方法都不太难，但是我以前用过Thrift，所以对它的概念和用法很熟悉。使用Thrift方法，可以清楚地定义Elixir和Python之间的接口，但是ErlPort方法使用的代码要少得多(特别是当您计算Thrift生成的文件时)。对于这种简单的情况，我会选择ErlPort，节俭有点过头了。</p><p id="a9eb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，在某些情况下，我会选择节俭的方法:</p><ol class=""><li id="410f" class="lr ls hu it b iu iv iy iz jc lt jg lu jk lv jo lw lx ly lz dt translated">使用ErlPort传递复杂的定制数据结构似乎并不简单，您必须定义自己的编码和解码，而使用Thrift，接口中定义的数据结构会在语言之间自动处理。</li><li id="e951" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated">ErlPort Python实例不能同时处理多个调用，并且它们使用OS进程，因此您需要非常小心地生成多个实例。通过Thrift，您可以将服务转移到另一台机器上，甚至可以设置线程服务器类型来处理多个请求，这是一个现成的选项。</li><li id="c3bf" class="lr ls hu it b iu ma iy mb jc mc jg md jk me jo lw lx ly lz dt translated">根据你想连接的语言，Thrift有许多选择，而ErlPort只有Python或Ruby。</li></ol><p id="8fb8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，对于像GeoJSON这样的简单方法，我会选择ErlPort，但对于任何复杂的方法，我认为节俭会更好。</p><p id="cd4d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">项目回购实例:【https://github.com/chiragtoor/python_calls T2】</p><div class="jr js jt ju fq ab cb"><figure class="mf jv mg mh mi mj mk paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mf jv mg mh mi mj mk paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mf jv mg mh mi mj mk paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="ml mm mn"><p id="f922" class="ir is mo it b iu iv iw ix iy iz ja jb mp jd je jf mq jh ji jj mr jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is mo it b iu iv iw ix iy iz ja jb mp jd je jf mq jh ji jj mr jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff ms"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="mt kh l"/></div></figure></div></div>    
</body>
</html>