<html>
<head>
<title>[ Expressjs ] Cracking nuts, put the IP Address to BlackList</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">[ Expressjs ]破解坚果，把IP地址列入黑名单</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/cracking-nut-nodejs-express-block-get-remote-request-client-ip-address-e4cdfa461add?source=collection_archive---------2-----------------------#2016-12-28">https://medium.com/hackernoon/cracking-nut-nodejs-express-block-get-remote-request-client-ip-address-e4cdfa461add?source=collection_archive---------2-----------------------#2016-12-28</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/c07a9086612ab58aa74ea2f349d876f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GUAiXkIT4Sf53jS3xUVx-w.jpeg"/></div></div></figure><blockquote class="jc"><p id="4817" class="jd je hu bd jf jg jh ji jj jk jl jm ek translated">对付不受欢迎的人的最好办法是把他踢出你的派对。对付不受欢迎的IP的最好方法是列入黑名单。</p></blockquote><p id="fb0b" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj jm hn dt translated">今天的背景是一个运行在Node.js服务器上的应用服务，包括一个静态的HTML网站和API服务。我们手头有一些不受欢迎的IP名单，我的老板告诉我“彼得，把他们列入黑名单。”。</p><p id="e90b" class="pw-post-body-paragraph jn jo hu jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">我喜欢Node.js和Express，中间件加速的设计我完成了工作，然后早早离开办公室去过周五晚上。</p></div><div class="ab cl kp kq hc kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="hn ho hp hq hr"><h2 id="a7b1" class="kw kx hu bd ky kz la lb lc ld le lf lg jy lh li lj kc lk ll lm kg ln lo lp lq dt translated">这个问题被分解为三个部分:</h2><ol class=""><li id="1fbc" class="lr ls hu jp b jq lt ju lu jy lv kc lw kg lx jm ly lz ma mb dt translated">定义黑名单IP</li><li id="9e16" class="lr ls hu jp b jq mc ju md jy me kc mf kg mg jm ly lz ma mb dt translated">获取客户端IP</li><li id="f1a8" class="lr ls hu jp b jq mc ju md jy me kc mf kg mg jm ly lz ma mb dt translated">阻止客户端IP，如果它在黑名单中</li></ol><p id="8648" class="pw-post-body-paragraph jn jo hu jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">在Express.js中提取客户端ID超级简单，<strong class="jp hv"> <em class="mh">路由器</em> </strong>和<strong class="jp hv"> <em class="mh"> req </em> </strong>都是加速提取所有客户端信息的工具，包括头、Cookies、帖子正文、获取URL参数等。</p><h1 id="1fec" class="mi kx hu bd ky mj mk ml lc mm mn mo lg mp mq mr lj ms mt mu lm mv mw mx lp my dt translated">定义黑名单IP</h1><p id="21bb" class="pw-post-body-paragraph jn jo hu jp b jq lt js jt ju lu jw jx jy mz ka kb kc na ke kf kg nb ki kj jm hn dt translated"><em class="mh">将不受欢迎的IP放在一个数组中，该数组将在中间件中用于检查路由器将指向哪里。</em></p><pre class="nc nd ne nf fq ng nh ni nj aw nk dt"><span id="2c49" class="kw kx hu nh b fv nl nm l nn no"><strong class="nh hv">var BLACKLIST =['192.0.0.1'];<br/>//better to store as an String in process.env.BLACKLIST</strong></span></pre><h1 id="68e6" class="mi kx hu bd ky mj mk ml lc mm mn mo lg mp mq mr lj ms mt mu lm mv mw mx lp my dt translated">获取客户端IP</h1><p id="0b17" class="pw-post-body-paragraph jn jo hu jp b jq lt js jt ju lu jw jx jy mz ka kb kc na ke kf kg nb ki kj jm hn dt translated"><em class="mh"> Express提供了一个超级友好的</em><strong class="jp hv"><em class="mh">req</em></strong><em class="mh">在几行代码内获取客户端IP。</em></p><blockquote class="np nq nr"><p id="6890" class="jn jo mh jp b jq kk js jt ju kl jw jx ns km ka kb nt kn ke kf nu ko ki kj jm hn dt translated"><strong class="jp hv"><em class="hu">req . connection . remote address</em></strong>返回的IP，可能是ipv4或ipv6。</p></blockquote><pre class="nc nd ne nf fq ng nh ni nj aw nk dt"><span id="9e77" class="kw kx hu nh b fv nl nm l nn no">var getClientIp = function(req) {<br/><strong class="nh hv"><em class="mh">  var ipAddress = req.connection.remoteAddress;</em></strong></span><span id="bb54" class="kw kx hu nh b fv nv nm l nn no">if (!ipAddress) {<br/>    return '';<br/>  }</span><span id="1dff" class="kw kx hu nh b fv nv nm l nn no">// convert from "::ffff:192.0.0.1"  to "192.0.0.1"<br/><strong class="nh hv"><em class="mh">  if (ipAddress.substr(0, 7) == "::ffff:") {<br/>    ipAddress = ipAddress.substr(7)<br/>  }</em></strong></span><span id="aacb" class="kw kx hu nh b fv nv nm l nn no">return ipAddress;<br/>};</span></pre><h2 id="ba55" class="kw kx hu bd ky kz la lb lc ld le lf lg jy lh li lj kc lk ll lm kg ln lo lp lq dt translated">阻止客户端IP，如果它在黑名单中</h2><p id="3ab9" class="pw-post-body-paragraph jn jo hu jp b jq lt js jt ju lu jw jx jy mz ka kb kc na ke kf kg nb ki kj jm hn dt translated"><em class="mh">在app.use()内增加一个用户阻塞中间件函数(req，res，next)，这个中间件函数会在每次请求app时执行。就像一个过滤器，让正确的IP通过。</em></p><pre class="nc nd ne nf fq ng nh ni nj aw nk dt"><span id="30eb" class="kw kx hu nh b fv nl nm l nn no">app.use(function(req, res, next) {<br/>  var ipAddress = getClientIp(req);</span><span id="3169" class="kw kx hu nh b fv nv nm l nn no">if(<strong class="nh hv">BLACKLIST</strong>.indexOf(ipAddress) !== -1){<br/>    next();<br/>  } else {<br/>    res.send(ipAddress + ' IP is not in whiteList')<br/>  }<br/>});</span></pre></div><div class="ab cl kp kq hc kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="hn ho hp hq hr"><h1 id="6325" class="mi kx hu bd ky mj nw ml lc mm nx mo lg mp ny mr lj ms nz mu lm mv oa mx lp my dt translated">把所有的放在一起</h1><p id="0483" class="pw-post-body-paragraph jn jo hu jp b jq lt js jt ju lu jw jx jy mz ka kb kc na ke kf kg nb ki kj jm hn dt translated">这是一个在Express.js框架中把以上三部分放在一起的例子。要修改一个适合你的黑名单IP，去推你的IP在黑名单阵列，他们永远不会访问该服务。</p><pre class="nc nd ne nf fq ng nh ni nj aw nk dt"><span id="422b" class="kw kx hu nh b fv nl nm l nn no">var express = require(‘express’) <br/>var app = express()<br/>  <br/>// Part1, defining blacklist<br/><strong class="nh hv">var BLACKLIST =['192.0.0.1'];</strong></span><span id="8ac1" class="kw kx hu nh b fv nv nm l nn no">// Part2, Geting client IP<br/><strong class="nh hv">var getClientIp = function(req) {<br/>  var ipAddress = req.connection.remoteAddress;</strong></span><span id="696a" class="kw kx hu nh b fv nv nm l nn no"><strong class="nh hv">if (!ipAddress) {<br/>    return '';<br/>  }</strong></span><span id="a65d" class="kw kx hu nh b fv nv nm l nn no"><strong class="nh hv">// convert from "::ffff:192.0.0.1"  to "192.0.0.1"<br/>  if (ipAddress.substr(0, 7) == "::ffff:") {<br/>    ipAddress = ipAddress.substr(7)<br/>  }</strong></span><span id="ab9b" class="kw kx hu nh b fv nv nm l nn no"><strong class="nh hv">return ipAddress;<br/>};</strong></span><span id="29d4" class="kw kx hu nh b fv nv nm l nn no">//Part3, Blocking Client IP, if it is in the blacklist<br/><strong class="nh hv">app.use(function(req, res, next) {<br/>  var ipAddress = getClientIp(req);</strong></span><span id="32ca" class="kw kx hu nh b fv nv nm l nn no"><strong class="nh hv">  if(BLACKLIST.indexOf(ipAddress) === -1){<br/>    next();<br/>  } else {<br/>    res.send(ipAddress + ' IP is not in whiteList')<br/>  }<br/>});</strong></span><span id="ecfc" class="kw kx hu nh b fv nv nm l nn no">app.get(‘/’, function (req, res) {<br/>   res.send(‘Hello World!’)<br/>})</span></pre><p id="4c43" class="pw-post-body-paragraph jn jo hu jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">#感谢<a class="ob oc gr" href="https://medium.com/u/be20057073a0?source=post_page-----e4cdfa461add--------------------------------" rel="noopener" target="_blank">皮埃尔·张伯伦</a>，纠正了错误<strong class="jp hv">黑名单. index of(IP address)= =-1</strong></p></div><div class="ab cl kp kq hc kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="hn ho hp hq hr"><h1 id="18e5" class="mi kx hu bd ky mj nw ml lc mm nx mo lg mp ny mr lj ms nz mu lm mv oa mx lp my dt translated">注意</h1><ol class=""><li id="ffd5" class="lr ls hu jp b jq lt ju lu jy lv kc lw kg lx jm ly lz ma mb dt translated">req.headers['x-forwarded-for']</li><li id="3e39" class="lr ls hu jp b jq mc ju md jy me kc mf kg mg jm ly lz ma mb dt translated">请求.连接.远程地址</li><li id="5a97" class="lr ls hu jp b jq mc ju md jy me kc mf kg mg jm ly lz ma mb dt translated">请求.连接.套接字.远程地址</li></ol><p id="e638" class="pw-post-body-paragraph jn jo hu jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated"><strong class="jp hv"><em class="mh">1)x-forwarded-for</em></strong>:client，proxy1，proxy2，proxy3 <br/> <em class="mh">如果你是在NGiNX之类的代理后面运行，只有这样你才应该检查‘x-forwarded-for’</em><a class="ae od" href="http://stackoverflow.com/questions/10849687/express-js-how-to-get-remote-client-address" rel="noopener ugc nofollow" target="_blank"><em class="mh">(作者阿莱西奥·亚历克斯)</em> </a></p><p id="7c90" class="pw-post-body-paragraph jn jo hu jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated"><strong class="jp hv"><em class="mh">2)req . connection . remote address<br/></em></strong>默认服务器正在监听IPv6连接，并且没有设置IPV6_V6ONLY标志，导致<strong class="jp hv"> <em class="mh"> IPv4连接被同一个套接字</em> </strong>处理。<a class="ae od" href="http://stackoverflow.com/questions/24896386/request-connection-remoteaddress-now-prefixed-in-ffff-in-node-js" rel="noopener ugc nofollow" target="_blank"> <em class="mh">(作者弗拉基米尔·帕朗)</em> </a></p><p id="ad96" class="pw-post-body-paragraph jn jo hu jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated"><strong class="jp hv"><em class="mh">3)req . connection . socket . remote address<br/></em></strong>在https上，<strong class="jp hv"><em class="mh">req . connection . remote address</em></strong>未定义，但<strong class="jp hv"><em class="mh">req . connection . socket . remote address</em></strong>确实工作<a class="ae od" href="http://stackoverflow.com/questions/5999379/how-to-find-out-the-remote-address-in-node-js-if-it-is-https-request" rel="noopener ugc nofollow" target="_blank">(作者Mathijs Kwik) </a></p></div><div class="ab cl kp kq hc kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="hn ho hp hq hr"><h2 id="5ce9" class="kw kx hu bd ky kz la lb lc ld le lf lg jy lh li lj kc lk ll lm kg ln lo lp lq dt translated">您可能还喜欢:</h2><p id="5062" class="pw-post-body-paragraph jn jo hu jp b jq lt js jt ju lu jw jx jy mz ka kb kc na ke kf kg nb ki kj jm hn dt translated"><a class="ae od" href="https://hackernoon.com/javascript-cracking-nuts-override-object-constructor-48a73628b7e6#.22qqwdp14" rel="noopener ugc nofollow" target="_blank">【Javascript】override object . constructor()</a><br/><a class="ae od" href="https://hackernoon.com/nodejs-express-js-manipulating-response-before-going-back-to-user-5e96ad8d84ca#.zf7rx3el8" rel="noopener ugc nofollow" target="_blank">【Expressjs】override RES . send</a></p><p id="07e4" class="pw-post-body-paragraph jn jo hu jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">喜欢这个故事？对别人有帮助吗？这有助于我知道你是否想看到更多关于他的话题，并有助于人们在点击下面的 时看到这个故事。</p></div><div class="ab cl kp kq hc kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="hn ho hp hq hr"><h2 id="8fae" class="kw kx hu bd ky kz la lb lc ld le lf lg jy lh li lj kc lk ll lm kg ln lo lp lq dt translated">参考:</h2><p id="788f" class="pw-post-body-paragraph jn jo hu jp b jq lt js jt ju lu jw jx jy mz ka kb kc na ke kf kg nb ki kj jm hn dt translated">git:<a class="ae od" href="https://github.com/wahengchang/javascript-must-know/tree/master/middleware_blockIp" rel="noopener ugc nofollow" target="_blank"><br/>https://github . com/wahengcang/JavaScript-must-know/tree/master/middleware _ block IP</a></p><p id="e5ab" class="pw-post-body-paragraph jn jo hu jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">express-IP filter<br/><a class="ae od" href="https://www.npmjs.com/package/express-ipfilter" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/express-ipfilter</a></p><p id="9358" class="pw-post-body-paragraph jn jo hu jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">expressjs.com<br/><a class="ae od" href="http://expressjs.com/en/api.html" rel="noopener ugc nofollow" target="_blank">http://expressjs.com/en/api.html</a></p><p id="988c" class="pw-post-body-paragraph jn jo hu jp b jq kk js jt ju kl jw jx jy km ka kb kc kn ke kf kg ko ki kj jm hn dt translated">stack overflow<br/><a class="ae od" href="http://stackoverflow.com/questions/10849687/express-js-how-to-get-remote-client-address" rel="noopener ugc nofollow" target="_blank">http://stack overflow . com/questions/10849687/express-js-how-to-get-remote-client-address</a><br/><a class="ae od" href="http://stackoverflow.com/questions/24896386/request-connection-remoteaddress-now-prefixed-in-ffff-in-node-js" rel="noopener ugc nofollow" target="_blank">http://stack overflow . com/questions/24896386/request-connection-remote address-now-prefixed-in-ffff-in-node-js</a><br/><a class="ae od" href="http://stackoverflow.com/questions/5999379/how-to-find-out-the-remote-address-in-node-js-if-it-is-https-request" rel="noopener ugc nofollow" target="_blank">http://stack overflow . com/questions/5999379/</a></p><div class="nc nd ne nf fq ab cb"><figure class="oe iv of og oh oi oj paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="oe iv of og oh oi oj paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="oe iv of og oh oi oj paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="np nq nr"><p id="f922" class="jn jo mh jp b jq kk js jt ju kl jw jx ns km ka kb nt kn ke kf nu ko ki kj jm hn dt translated"><a class="ae od" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是这个家庭的一员。我们现在<a class="ae od" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae od" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jn jo mh jp b jq kk js jt ju kl jw jx ns km ka kb nt kn ke kf nu ko ki kj jm hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae od" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae od" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="nc nd ne nf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ok"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>