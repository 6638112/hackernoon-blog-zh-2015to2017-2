<html>
<head>
<title>How to Build a Collaborative MIDI App with Express.js &amp; Socket.io</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Express.js &amp; Socket.io构建协同MIDI App</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-build-a-collaborative-midi-app-with-express-js-socket-io-273663b63201?source=collection_archive---------14-----------------------#2017-07-10">https://medium.com/hackernoon/how-to-build-a-collaborative-midi-app-with-express-js-socket-io-273663b63201?source=collection_archive---------14-----------------------#2017-07-10</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="899b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本教程中，我将向你展示如何构建一个应用程序，让你可以使用midi键盘与朋友实时制作音乐！这是我们正在建造的:</p><figure class="jp jq jr js fq jt"><div class="bz el l di"><div class="ju jv l"/></div><figcaption class="jw jx fg fe ff jy jz bd b be z ek">Key light up pink for you, blue for other users.</figcaption></figure><blockquote class="ka kb kc"><p id="da4d" class="ir is kd it b iu iv iw ix iy iz ja jb ke jd je jf kf jh ji jj kg jl jm jn jo hn dt translated">试试现场演示:<a class="ae kh" href="https://midi-collaboration.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">https://midi-collaboration.herokuapp.com/</a></p><p id="962a" class="ir is kd it b iu iv iw ix iy iz ja jb ke jd je jf kf jh ji jj kg jl jm jn jo hn dt translated">查看代码:【https://github.com/agbales/web-midi-collaboration】T2</p></blockquote><p id="f92d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如你所见，弹奏一个音符会点亮一个粉红色的键，并在列表中显示输入数据。如果另一个用户加入该会话，他们的输入将显示为蓝色，他们的数据将在列表中显示为蓝色条目。</p><p id="b4bb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们将该过程分为5个部分:</p><ol class=""><li id="68df" class="ki kj hu it b iu iv iy iz jc kk jg kl jk km jo kn ko kp kq dt translated">使用Express.js创建应用程序</li><li id="2205" class="ki kj hu it b iu kr iy ks jc kt jg ku jk kv jo kn ko kp kq dt translated">连接Midi控制器</li><li id="1dde" class="ki kj hu it b iu kr iy ks jc kt jg ku jk kv jo kn ko kp kq dt translated">为协作添加Socket.io</li><li id="9919" class="ki kj hu it b iu kr iy ks jc kt jg ku jk kv jo kn ko kp kq dt translated">式样</li><li id="b4d3" class="ki kj hu it b iu kr iy ks jc kt jg ku jk kv jo kn ko kp kq dt translated">部署到Heroku</li></ol><h1 id="8293" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated"><strong class="ak">第一步:创建一个Express.js应用</strong></h1><p id="57c4" class="pw-post-body-paragraph ir is hu it b iu lu iw ix iy lv ja jb jc lw je jf jg lx ji jj jk ly jm jn jo hn dt translated">我们将首先创建一个目录，并使用以下三个终端命令初始化项目:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="d801" class="me kx hu ma b fv mf mg l mh mi">mkdir midi-collaboration<br/>cd midi-collaboration<br/>npm init</span></pre><p id="9bfd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">NPM实用程序将要求提供一些信息来设置package.json文件。请随意提供这些信息，或者按enter键暂时将这些字段留空。</p><p id="888d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，添加Express:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="53d9" class="me kx hu ma b fv mf mg l mh mi">npm install express --save</span></pre><p id="1998" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在package.json中，您现在会看到Express作为一个依赖项包含在内。</p><p id="8092" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在根文件夹中，使用以下内容创建server.js:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="1c78" class="me kx hu ma b fv mf mg l mh mi">touch server.js</span></pre><p id="d844" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在server.js中，添加以下内容:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="484b" class="me kx hu ma b fv mf mg l mh mi">var express = require('express');<br/>var app = express();<br/>const port = process.env.PORT || 8080;<br/>var server = app.listen(port);</span><span id="b7ea" class="me kx hu ma b fv mj mg l mh mi">app.use(express.static('public'));</span></pre><p id="f2b9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将创建一个Express实例，并将端口默认设置为8080。app.use指示express提供“公共”文件夹中的文件。如果你现在运行服务器，你会得到一个错误。那是因为我们还没有公共文件夹！</p><p id="46f6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">公共文件夹</strong></p><p id="2c68" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们创建公共文件夹:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="b7fc" class="me kx hu ma b fv mf mg l mh mi">mkdir public<br/>cd public</span></pre><p id="d0bb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在里面，我们将创建index.html、index.js和一个包含style.css的CSS文件夹:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="829f" class="me kx hu ma b fv mf mg l mh mi">touch index.html<br/>touch index.js<br/>mkdir css<br/>cd css<br/>touch style.css</span></pre><p id="7ea1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">“公共”文件夹应该如下所示:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="822d" class="me kx hu ma b fv mf mg l mh mi">public<br/>  --&gt; index.html<br/>  --&gt; index.js<br/>  css<br/>     --&gt; style.css</span></pre><p id="cfc2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">index.js应该链接到style.css和index.js。所以让我们添加以下内容:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="46a9" class="me kx hu ma b fv mf mg l mh mi">&lt;!-- /public/index.html --&gt;</span><span id="ca40" class="me kx hu ma b fv mj mg l mh mi">&lt;html&gt;<br/>  &lt;head&gt;<br/>    &lt;title&gt;Midi Collaboration&lt;/title&gt;<br/>    &lt;link rel="stylesheet" href="css/style.css"&gt;<br/>  &lt;/head&gt;<br/>  &lt;body&gt;<br/>    &lt;div&gt;<br/>      &lt;h1&gt;MIDI Collaboration&lt;/h1&gt;<br/>      &lt;ul id="midi-data"&gt;<br/>      &lt;/ul&gt;  <br/>    &lt;/div&gt;<br/>  &lt;/body&gt;<br/>  &lt;script src="index.js" type="text/javascript"&gt;&lt;/script&gt;<br/>&lt;/html&gt;</span></pre><p id="29b1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就产生了一个简单的头，后面跟着一个空的无序列表——这是我们记录midi数据的地方。在主体之后，它引用index.js。现在，让我们向index.js添加一个简单的console.log，这样我们就可以确保它正常工作:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="7f49" class="me kx hu ma b fv mf mg l mh mi">// public/index.js</span><span id="ac52" class="me kx hu ma b fv mj mg l mh mi">console.log('index.js is connected!');</span></pre><p id="2bad" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">更新package.json </strong></p><p id="bce6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，我们希望更新package.json，这样我们就可以用终端命令' npm start '运行我们的服务器。将下面一行添加到“脚本”中:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="6fbc" class="me kx hu ma b fv mf mg l mh mi">"start": "node server.js"</span></pre><p id="0b68" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您的package.json应该如下所示:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="2ed3" class="me kx hu ma b fv mf mg l mh mi">{<br/>  "name": "remaking-midi-maker",<br/>  "version": "1.0.0",<br/>  "description": "",<br/>  "main": "index.js",<br/>  "scripts": {<br/>    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1",<br/>    "start": "node server.js"<br/>  },<br/>  "author": "",<br/>  "license": "ISC",<br/>  "dependencies": {<br/>    "express": "^4.15.3"<br/>  }<br/>}</span></pre><p id="ae8f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">确定您在midi-collaboration文件夹中，并启动您的应用程序:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="a332" class="me kx hu ma b fv mf mg l mh mi">npm start</span></pre><p id="4410" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">太好了！它现在位于<a class="ae kh" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080/ </a></p><h1 id="d665" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated"><strong class="ak">步骤2:连接您的Midi控制器</strong></h1><p id="b48f" class="pw-post-body-paragraph ir is hu it b iu lu iw ix iy lv ja jb jc lw je jf jg lx ji jj jk ly jm jn jo hn dt translated">我们将使用Web Midi API将USB midi控制器连接到应用程序。如果你看到“index.js已连接！”在您的控制台中，让我们将console.log替换为:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="2d3a" class="me kx hu ma b fv mf mg l mh mi">// public/javascript/index.js</span><span id="8c0b" class="me kx hu ma b fv mj mg l mh mi">var context = new AudioContext();<br/>var oscillators = {};<br/>var midi, data;</span><span id="737f" class="me kx hu ma b fv mj mg l mh mi">if (navigator.requestMIDIAccess) {<br/>  navigator.requestMIDIAccess({<br/>    sysex: false<br/>  }).then(onMIDISuccess, onMIDIFailure);<br/>} else {<br/>  console.warn("No MIDI support in your browser");<br/>}</span><span id="e431" class="me kx hu ma b fv mj mg l mh mi">function onMIDISuccess(midiData) {<br/>  console.log(midiData);<br/>  midi = midiData;<br/>  var allInputs = midi.inputs.values();<br/>  for (var input = allInputs.next(); input &amp;&amp; !input.done; input = allInputs.next()) {<br/>    input.value.onmidimessage = onMIDImessage;<br/>  }<br/>}</span><span id="7e7c" class="me kx hu ma b fv mj mg l mh mi">function onMIDIFailure() {<br/>  console.warn("Not finding a MIDI controller");<br/>}</span></pre><p id="a754" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您的midi控制器已连接，您应该会看到MIDIAccess对象的console.log:</p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="fe ff mk"><img src="../Images/70c49f96014d77121b6b8d77cb1b73bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r2QVSOv5UbV8pYOslEHNWw.jpeg"/></div></div></figure><p id="27ef" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在onMIDISuccess()中，for循环监听midi消息。现在它应该在控制台中导致一个错误。为什么？因为我们还没有定义当它接收到一个midi信息时要做什么。</p><p id="1a9b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们创建循环中引用的onMIDImessage函数:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="3dd0" class="me kx hu ma b fv mf mg l mh mi">function onMIDImessage(messageData) {<br/>  var newItem = document.createElement('li');<br/>  newItem.appendChild(document.createTextNode(messageData.data));<br/>  newItem.className = 'user-midi';<br/>  document.getElementById('midi-data').prepend(newItem);<br/>}</span></pre><p id="729c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个函数创建一个新的<li>元素。它用我们的midi数据附加一个文本节点。它添加了一个user-midi的css类(这在后面会很重要)。最后，它用id“midi-data”将新的列表项添加到无序列表中。</li></p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div class="fe ff mr"><img src="../Images/ce0344b0f1a26cf259facc87ccca8fe5.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*HY1lNt7nh_WpnWh34cyP2w.gif"/></div><figcaption class="jw jx fg fe ff jy jz bd b be z ek">Midi keyup and keydown events</figcaption></figure><p id="1d95" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">很酷，是吧？</p><p id="ed46" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是这些数字意味着什么呢？还有:声音在哪里？</p><p id="8802" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> MIDI协议</strong></p><p id="67cf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">MIDI协议本身就是一个兔子洞，但出于我们的目的，您可以通过一个简单的图表来理解这些数字:</p><blockquote class="ms"><p id="00a3" class="mt mu hu bd mv mw mx my mz na nb jo ek translated">开/关→ 144 / 128</p><p id="33eb" class="mt mu hu bd mv mw mx my mz na nb jo ek translated">螺距→0–127</p><p id="8544" class="mt mu hu bd mv mw mx my mz na nb jo ek translated">速度→0–127</p></blockquote><p id="02ba" class="pw-post-body-paragraph ir is hu it b iu nc iw ix iy nd ja jb jc ne je jf jg nf ji jj jk ng jm jn jo hn dt translated">在处理这些数据时，我们将第一个数字视为一个开关。144 =开，128 =关。第二个数字是音高的范围。在我们这里的用法中，最终速度输入也可以理解为<em class="kd">体积</em>。</p><p id="d316" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你想更深入地了解midi，这里的<a class="ae kh" href="https://www.cs.cmu.edu/~music/cmsip/readings/MIDI%20tutorial%20for%20programmers.html" rel="noopener ugc nofollow" target="_blank">是开始</a>的好地方。</p><p id="6047" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">声音</strong></p><p id="9d48" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">MIDI数据不是声音，而是一组方向:开/关、音高、力度。我们需要制造自己的合成器，将这些信息转换成音乐音调。</p><p id="812a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，让我们将数组中的值集转换成一个可以传递给声音播放器的“note”对象。在onMIDImessage函数中，添加:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="aa37" class="me kx hu ma b fv mf mg l mh mi">var d = messageData.data; // Example: [144, 60, 100]<br/>var note = {<br/>  on: d[0], <br/>  pitch: d[1],<br/>  velocity: d[2]<br/>}<br/>play(note);</span></pre><p id="96a6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上面，变量' d '被赋予了输入数据:一个由三个数字组成的数组。这三个值通过它们的索引进行访问，并被指定为对象属性的值。然后，音符对象被传递给播放函数。让我们编写这个函数:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="6f67" class="me kx hu ma b fv mf mg l mh mi">function play(note){<br/>    switch(note.on) {<br/>      case 144:<br/>        noteOn(frequency(note.pitch), note.velocity);<br/>        break;<br/>      case 128:<br/>        noteOff(frequency(note.pitch), note.velocity);<br/>        break;<br/>    }</span><span id="8ddc" class="me kx hu ma b fv mj mg l mh mi">    function frequency(note) {<br/>      return Math.pow(2, ((note - 69) / 12)) * 440;<br/>    }</span><span id="c799" class="me kx hu ma b fv mj mg l mh mi">    function noteOn(frequency, velocity) {<br/>      var osc = oscillators[frequency] = context.createOscillator();<br/>          osc.type = 'sawtooth';<br/>          osc.frequency.value = frequency;<br/>          osc.connect(context.destination);<br/>          osc.start(context.currentTime);<br/>    }</span><span id="6948" class="me kx hu ma b fv mj mg l mh mi">    function noteOff(frequency, velocity) {<br/>        oscillators[frequency].stop(context.currentTime);<br/>        oscillators[frequency].disconnect();<br/>    }<br/>  }</span></pre><p id="8f13" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该功能检查音符是开(144)还是关(128)，并触发适当的命令。noteOn和noteOff都引用了我们在index.js顶部建立的两个全局变量来处理声音的开始和停止。</p><p id="1633" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">frequency函数用于将midi音符数转换为赫兹频率。如果你好奇，你可以<a class="ae kh" href="https://en.wikipedia.org/wiki/Piano_key_frequencies" rel="noopener ugc nofollow" target="_blank">在这里</a>了解更多。</p><p id="568d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您的应用程序现在应该像合成器一样播放。万岁。</p><h1 id="73df" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">步骤3:为协作添加Socket.io</h1><p id="4251" class="pw-post-body-paragraph ir is hu it b iu lu iw ix iy lv ja jb jc lw je jf jg lx ji jj jk ly jm jn jo hn dt translated">现在是有趣的时候了:在一个会话中同步多个用户！Socket.io将通过实现“实时双向基于事件的通信”来帮助我们做到这一点。这意味着当midi信息在任何浏览器上被触发时，我们可以发送和接收它们。将Socket.io添加到项目中:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="b860" class="me kx hu ma b fv mf mg l mh mi">npm install socket.io --save</span></pre><p id="de8b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您还需要将它添加到index.html的头部:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="b4e4" class="me kx hu ma b fv mf mg l mh mi">&lt;!-- public/index.html --&gt;</span><span id="a6e4" class="me kx hu ma b fv mj mg l mh mi">&lt;script src="<a class="ae kh" href="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js" rel="noopener ugc nofollow" target="_blank">https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js</a>"&gt;&lt;/script&gt;</span></pre><p id="6fe7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注意:我使用的是2.0.3版本——确保你的Socket.io版本与你的package.json和html脚本相匹配。你可能想要这个链接到 <a class="ae kh" href="https://cdnjs.com/libraries/socket.io" rel="noopener ugc nofollow" target="_blank"> <em class="kd"> CDN </em> </a> <em class="kd">。</em></p><p id="6bae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于连接用户的Socket.io，我们需要确保:</p><blockquote class="ka kb kc"><p id="c21f" class="ir is kd it b iu iv iw ix iy iz ja jb ke jd je jf kf jh ji jj kg jl jm jn jo hn dt translated">1)用户可以发送和接收笔记</p><p id="5f01" class="ir is kd it b iu iv iw ix iy iz ja jb ke jd je jf kf jh ji jj kg jl jm jn jo hn dt translated">2)服务器监听用户输入，并将其广播给其他用户</p></blockquote><p id="58f4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">用户发送/接收</strong></p><p id="e17e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，让我们确保用户每次弹奏音符时都会发出一个信号。这可以通过打开index.js并向onMIDImessage函数添加一行代码来实现。确保在定义了注释对象后添加此<em class="kd">。</em></p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="0ade" class="me kx hu ma b fv mf mg l mh mi">// public/index.js (inside onMIDImessage)</span><span id="1075" class="me kx hu ma b fv mj mg l mh mi">socket.emit('midi', note);</span></pre><p id="2a00" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们还想播放来自其他用户的任何外部注释。在index.js中，添加以下内容:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="82dc" class="me kx hu ma b fv mf mg l mh mi">// public/index.js</span><span id="d2ab" class="me kx hu ma b fv mj mg l mh mi">var socket = io();<br/>socket.on('externalMidi', gotExternalMidiMessage);</span><span id="e134" class="me kx hu ma b fv mj mg l mh mi">function gotExternalMidiMessage(data) {<br/>  var newItem = document.createElement('li');<br/>  newItem.appendChild(document.createTextNode('Note: ' + data.pitch + ' Velocity: ' + data.velocity));<br/>  newItem.className = "external-midi";<br/>  document.getElementById('midi-data').prepend(newItem);</span><span id="9f2e" class="me kx hu ma b fv mj mg l mh mi">  playNote(data);<br/>}</span></pre><p id="c45a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当我们从服务器收到“externalMidi”消息时，它会触发gotExternalMidiMessage。这个函数看起来应该很熟悉——事实上，我们可以在以后重构它，但是为了清楚起见，现在我们将重复代码。它在视图中显示外部音符的方式几乎与我们处理自己键盘上的midi输入的方式相同。然而，我们给了<li>一个类名‘external-midi’。当我们添加风格来区分我们的midi输入和外部用户的输入时，这一点很重要。</li></p><p id="ece6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，音符被传递给玩家以触发声音。</p><p id="57be" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">服务器</strong></p><p id="c912" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在让我们在用户之间架起一座桥梁。我们希望处理任何传入的信号，并将它们传递给任何其他会话。</p><p id="70f9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在server.js中，需要Socket.io并添加函数newConnection。当服务器获得一个新的连接时，这将被触发。</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="eaf6" class="me kx hu ma b fv mf mg l mh mi">// server.js</span><span id="78d3" class="me kx hu ma b fv mj mg l mh mi">var socket = require('socket.io');<br/>var io = socket(server);</span><span id="62e6" class="me kx hu ma b fv mj mg l mh mi">io.sockets.on('connection', newConnection);</span><span id="3a70" class="me kx hu ma b fv mj mg l mh mi">function newConnection(socket) {<br/>  console.log('new connection from:' + socket.id);</span><span id="97e4" class="me kx hu ma b fv mj mg l mh mi">  socket.on('midi', midiMsg);<br/>  function midiMsg(data) {<br/>    socket.broadcast.emit('externalMidi', data);<br/>  }<br/>}</span></pre><p id="794d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每次建立新连接时，newConnection console.log都会出现在终端中。我们还有socket.on来监听来自任何用户的消息，然后触发midiMsg，它将数据广播给除了原始用户之外的每个用户。</p><p id="ad33" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就这样，我们都准备好了！</p><h1 id="1a3b" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">第三步:造型</h1><p id="cc6c" class="pw-post-body-paragraph ir is hu it b iu lu iw ix iy lv ja jb jc lw je jf jg lx ji jj jk ly jm jn jo hn dt translated">如果你只是想看到你的笔记与其他玩家的不同，你可以在这里走捷径，只需将这些类添加到你的style.css:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="1597" class="me kx hu ma b fv mf mg l mh mi">// public/css/sytle.css</span><span id="67d7" class="me kx hu ma b fv mj mg l mh mi">.user-midi {<br/>  color: green;<br/>}</span><span id="029d" class="me kx hu ma b fv mj mg l mh mi">.external-midi {<br/>  color: blue;<br/>}</span></pre><p id="b3b8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就是这样！现在，您将看到自己的输入为绿色，任何外部信号为蓝色。请随意跳到下一步，将您的应用部署到Heroku！</p><p id="83f8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你想创建一个键盘界面，让我们继续:</p><p id="6661" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">构建键盘</strong></p><p id="dae7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们将制作的这款键盘基于@baileyparker的<a class="ae kh" href="https://codepen.io/baileyparker/pen/pgPxYZ" rel="noopener ugc nofollow" target="_blank"> CodePen项目</a>。我们将对设计和功能进行一些修改，以适应我们的使用。首先，在一个单独的窗口中打开这支笔:</p><figure class="jp jq jr js fq jt"><div class="bz el l di"><div class="nh jv l"/></div></figure><p id="14d2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> HTML </strong></p><p id="563a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">带有类“piano”的div存放了我们所有的键，这些键标有各种选择器。按照钢笔中的html结构，将piano div及其所有键粘贴到您的文档(/public/index.html)中。</p><p id="86cf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> CSS </strong></p><p id="48f9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是我们风格的重大更新。我们导入一个谷歌字体，给身体分配一个背景图片，最后给颜色来区分。用户-midi(粉色)和。外部midi(蓝色)信号。ul和li元素的设计使得它们可以以令人满意的角度向后倾斜。</p><p id="e782" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">键盘样式占据了<a class="ae kh" href="https://hackernoon.com/tagged/css" rel="noopener ugc nofollow" target="_blank"> CSS </a>的剩余部分。这里值得注意的是“活动”类，如。钢琴-键-自然:主动'或'。'钢琴-键-自然-外部:主动'。当演奏一个音符时，这些由<a class="ae kh" href="https://hackernoon.com/tagged/javascript" rel="noopener ugc nofollow" target="_blank"> Javascript </a>触发。如果它与数据号匹配，CSS将激活那个键，对于你的笔记是粉红色的，对于任何外部输入是蓝色的。</p><blockquote class="ka kb kc"><p id="9222" class="ir is kd it b iu iv iw ix iy iz ja jb ke jd je jf kf jh ji jj kg jl jm jn jo hn dt translated">当您将笔中的CSS复制到项目的样式表(/public/style.css)中时，请确保遵循其中包含的注释。最重要的是，您需要更新到背景的路径。</p></blockquote><p id="412e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> JS </strong></p><p id="8754" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您将对Javascript做同样的事情:将它剪切并粘贴到我们编写的代码下面的/public/index.js中。同样，阅读并遵循代码中的一些注释也很重要。</p><p id="a24d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这段代码将管理midi控制器连接。但是您会希望将重点放在两个函数上:onMidiMessage和updateKeyboard。前者处理本地输入，并应用适当的类来照亮按键。后者对外部消息做同样的事情(但使用不同的类)。</p><p id="27c7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要让外部音符点亮键盘，我们需要返回函数gotExternalMidiMessage。在我们调用play()之后，添加以下代码:</p><pre class="jp jq jr js fq lz ma mb mc aw md dt"><span id="875f" class="me kx hu ma b fv mf mg l mh mi">var msg = { }<br/>    msg.data = [];<br/>    msg.data.push(data.on);<br/>    msg.data.push(data.pitch);<br/>    msg.data.push(data.velocity);</span><span id="6222" class="me kx hu ma b fv mj mg l mh mi">updateKeyboard(data);</span></pre><p id="37ae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">键盘需要一种特定的对象数据结构来更新，所以我们创建msg并用笔记中的数据填充它。该msg对象被传递给updateKeyboard，它为该外部信号点亮蓝色的按键。</p><p id="bdf1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你现在应该看到你的键为你自己的输入亮起粉红色！当我们连接到Heroku添加更多用户时，您会看到这些外部midi信息以蓝色亮起！</p><h1 id="0305" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">步骤4:部署到Heroku</h1><p id="7964" class="pw-post-body-paragraph ir is hu it b iu lu iw ix iy lv ja jb jc lw je jf jg lx ji jj jk ly jm jn jo hn dt translated">我不会在这里逐一介绍，而是将您引向Heroku的综合文档。他们在审查部署选项方面做得很好:</p><div class="ni nj fm fo nk nl"><a href="https://devcenter.heroku.com/articles/git" rel="noopener  ugc nofollow" target="_blank"><div class="nm ab ej"><div class="nn ab no cl cj np"><h2 class="bd hv fv z el nq eo ep nr er et ht dt translated">使用Git | Heroku开发中心部署</h2><div class="ns l"><h3 class="bd b fv z el nq eo ep nr er et ek translated">Git是一个强大的分散版本控制系统，是将应用程序部署到Heroku的手段。</h3></div><div class="nt l"><p class="bd b gc z el nq eo ep nr er et ek translated">devcenter.heroku.com</p></div></div><div class="nu l"><div class="nv l nw nx ny nu nz mp nl"/></div></div></a></div><h1 id="f5a5" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">摘要</h1><p id="abf9" class="pw-post-body-paragraph ir is hu it b iu lu iw ix iy lv ja jb jc lw je jf jg lx ji jj jk ly jm jn jo hn dt translated">如果一切顺利，你现在应该有一个应用程序，可以将信号从一个用户传递到下一个用户，并播放每个用户的笔记。对于您的输入和外部输入，键盘应该以不同的颜色亮起。</p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="fe ff oa"><img src="../Images/3198c0ec14c127754481a267cbb834b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*85QJqEIPDihkwklVMHnqHA.png"/></div></div><figcaption class="jw jx fg fe ff jy jz bd b be z ek">Completed App!</figcaption></figure><p id="0f98" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我对这个协作应用程序感到兴奋。把它连接起来并邀请其他州的朋友登录并播放音乐真是令人兴奋！回过头来看，我也看到了数据可以更有效地传递的方法和设计可以改进的地方——例如，它对小屏幕不友好。</p><p id="5064" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我很想听听你如何使用这个应用程序，我希望它能让你更好地理解如何结合Express.js、Socket.io和Web MIDI API！</p><figure class="jp jq jr js fq jt"><div class="bz el l di"><div class="ob jv l"/></div></figure></div></div>    
</body>
</html>