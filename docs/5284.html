<html>
<head>
<title>How to Use SQL Temporal Tables For Easy Point-In-Time Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用SQL时态表进行简单的时间点分析</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-use-sql-temporal-tables-for-easy-point-in-time-analysis-38d43e4ee557?source=collection_archive---------3-----------------------#2017-07-19">https://medium.com/hackernoon/how-to-use-sql-temporal-tables-for-easy-point-in-time-analysis-38d43e4ee557?source=collection_archive---------3-----------------------#2017-07-19</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/82deaff1be0d34d331e27c4fbbf0cccf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oxwv0HJcy7pKsrykprgJhg.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">“<a class="ae jg" href="https://www.flickr.com/photos/stemonx/33365168470/" rel="noopener ugc nofollow" target="_blank">Bordeaux, The Grand Theatre</a>” by <a class="ae jg" href="https://www.flickr.com/photos/stemonx/" rel="noopener ugc nofollow" target="_blank">Stefano Montagner</a> is licensed under <a class="ae jg" href="https://creativecommons.org/licenses/by-nc-nd/2.0/" rel="noopener ugc nofollow" target="_blank">CC BY-NC-ND 2.0</a></figcaption></figure><figure class="jh ji jj jk fq iv"><div class="bz el l di"><div class="jl jm l"/></div></figure><p id="3b58" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">您是否曾经需要查看表<em class="kl">中的数据使用</em>是什么样子？</p><p id="bb44" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">如果您有过，那么编写group-by语句、嵌套子查询和窗口函数来编写您的时间旅行查询可能需要一段非常紧张的时间。</p><p id="f5f2" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">很抱歉你损失了一天的生产力——我也经历过。</p><p id="8dd4" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">幸运的是，<a class="ae jg" href="https://hackernoon.com/tagged/sql-server" rel="noopener ugc nofollow" target="_blank"> SQL Server </a> 2016引入了一个新特性，使我们的时间点分析查询易于编写:时态表。</p><h1 id="4c05" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">时态表？那些和临时表一样吗？</h1><p id="6a70" class="pw-post-body-paragraph jn jo hu jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk hn dt translated">不要让听起来相似的名字欺骗了你:“temporal”&lt;&gt;“temporary”。</p><p id="234c" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">时态表由两部分组成:</p><ol class=""><li id="d7fd" class="lp lq hu jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx dt translated"><a class="ae jg" href="https://hackernoon.com/tagged/temporal-table" rel="noopener ugc nofollow" target="_blank">时态表</a> —这是包含数据当前值的表。</li><li id="1105" class="lp lq hu jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx dt translated">历史表-该表保存时态表中某个时间点的所有先前值。</li></ol><p id="075a" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">在SQL的早期版本中，您可能已经使用触发器创建了类似的设置。然而，使用<a class="ae jg" href="https://docs.microsoft.com/en-us/sql/relational-databases/tables/temporal-tables" rel="noopener ugc nofollow" target="_blank">时态表与此不同</a>,因为:</p><ol class=""><li id="d4f7" class="lp lq hu jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx dt translated">你不需要写任何触发器/存储过程！所有的历史跟踪都是由SQL Server自动完成的。</li><li id="f62d" class="lp lq hu jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx dt translated">检索数据使用简单的WHERE子句，不需要复杂的查询。</li></ol><h1 id="381c" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">我想通过使用时态表让我的生活更轻松！拿着我的钱，告诉我怎么做！</h1><p id="04c9" class="pw-post-body-paragraph jn jo hu jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk hn dt translated">你的提议让我受宠若惊，但既然我们是好朋友，我就免费让你知道这些秘密。</p><p id="0c96" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">首先让我们创建一个时态表。我正在考虑创办一家汽车租赁公司，所以让我们在此之后建立一个模型:</p><pre class="jh ji jj jk fq md me mf mg aw mh dt"><span id="1c85" class="mi kn hu me b fv mj mk l ml mm">IF OBJECT_ID('dbo.CarInventory', 'U') IS NOT NULL <br/>BEGIN<br/> -- When deleting a temporal table, we need to first turn versioning off<br/> ALTER TABLE [dbo].[CarInventory] SET ( SYSTEM_VERSIONING = OFF  ) <br/> DROP TABLE dbo.CarInventory<br/> DROP TABLE dbo.CarInventoryHistory<br/>END<br/>CREATE TABLE CarInventory   <br/>(    <br/> CarId INT IDENTITY PRIMARY KEY,<br/> Year INT,<br/> Make VARCHAR(40),<br/> Model VARCHAR(40),<br/> Color varchar(10),<br/> Mileage INT,<br/> InLot BIT NOT NULL DEFAULT 1,<br/> SysStartTime datetime2 GENERATED ALWAYS AS ROW START NOT NULL,<br/> SysEndTime datetime2 GENERATED ALWAYS AS ROW END NOT NULL,<br/> PERIOD FOR SYSTEM_TIME (SysStartTime, SysEndTime)     <br/>)   <br/>WITH <br/>( <br/> SYSTEM_VERSIONING = ON (HISTORY_TABLE = dbo.CarInventoryHistory)   <br/>)</span></pre><p id="9a27" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">上面的新表格需要注意的关键点是</p><ol class=""><li id="19e9" class="lp lq hu jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx dt translated">它包含一个<code class="eh mn mo mp me b">PRIMARY KEY</code>。</li><li id="646e" class="lp lq hu jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx dt translated">它包含两个<code class="eh mn mo mp me b">datetime2</code>字段，标有<code class="eh mn mo mp me b">GENERATED ALWAYS AS ROW START/END</code>。</li><li id="6035" class="lp lq hu jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx dt translated">它包含了<code class="eh mn mo mp me b">PERIOD FOR SYSTEM_TIME</code>语句。</li><li id="a7af" class="lp lq hu jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx dt translated">它包含具有(可选)历史表名(<code class="eh mn mo mp me b">dbo.CarIntventoryHistory</code>)的<code class="eh mn mo mp me b">SYSTEM_VERSIONING = ON</code>属性。</li></ol><p id="0476" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">如果我们查询新创建的表，您会注意到我们的列布局是相同的:</p><pre class="jh ji jj jk fq md me mf mg aw mh dt"><span id="3a94" class="mi kn hu me b fv mj mk l ml mm">SELECT * FROM dbo.CarInventory<br/>SELECT * FROM dbo.CarInventoryHistory</span></pre><p id="5d45" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">让我们用全美汽车租赁机构的精选汽车来填满它——雪佛兰Malibu:</p><pre class="jh ji jj jk fq md me mf mg aw mh dt"><span id="e00b" class="mi kn hu me b fv mj mk l ml mm">INSERT INTO dbo.CarInventory (Year,Make,Model,Color,Mileage) VALUES(2017,'Chevy','Malibu','Black',0)<br/>INSERT INTO dbo.CarInventory (Year,Make,Model,Color,Mileage) VALUES(2017,'Chevy','Malibu','Silver',0)</span></pre><figure class="jh ji jj jk fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mq"><img src="../Images/7e8eb8a8ec7be766bf0a3e846c40510c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R42hp-gNLpg_GVD17Fy9qQ.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Although we got some unassuming car models, at least we can express our individuality with two different paint colors!</figcaption></figure><p id="0de0" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">在所有剩余的屏幕截图中，顶部的结果是我们的时态表<code class="eh mn mo mp me b">dbo.CarInventory</code>，底部的结果是我们的历史表<code class="eh mn mo mp me b">dbo.CarInventoryHistory</code>。</p><p id="5964" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">您会注意到，因为我们只为每辆车插入了一行，所以还没有行历史，因此我们的历史表是空的。</p><p id="668d" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">让我们通过获得一些客户和出租我们的汽车来改变这种情况吧！</p><pre class="jh ji jj jk fq md me mf mg aw mh dt"><span id="fbfe" class="mi kn hu me b fv mj mk l ml mm">UPDATE dbo.CarInventory SET InLot = 0 WHERE CarId = 1<br/>UPDATE dbo.CarInventory SET InLot = 0 WHERE CarId = 2</span></pre><figure class="jh ji jj jk fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mr"><img src="../Images/b7077ff9f3cee6acc740ce466b05d88a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bm7zZ7UdXcqUpL7lu08MDg.png"/></div></div></figure><p id="4459" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">现在我们看到我们的时态表在工作:我们更新了<code class="eh mn mo mp me b">dbo.CarInventory</code>中的行，我们的历史表自动更新了我们的原始值<em class="kl">以及这些行在我们的表中存在多长时间的</em>时间戳。</p><p id="ecc1" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">过了一会儿，我们的客户会归还他们租赁的汽车:</p><pre class="jh ji jj jk fq md me mf mg aw mh dt"><span id="a8ba" class="mi kn hu me b fv mj mk l ml mm">UPDATE dbo.CarInventory SET InLot = 1, Mileage = 73  WHERE CarId = 1<br/>UPDATE dbo.CarInventory SET InLot = 1, Mileage = 488 WHERE CarId = 2</span></pre><figure class="jh ji jj jk fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ms"><img src="../Images/19844c72d98ab033348245d27e0e9f77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5tP-Zf2ufjaDPsdS9eAxKw.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">It’s totally possible for someone to have driven 73 or 488 miles in a Chevy Malibu in under 4 minutes…ever hear the phrase “drive it like a rental”?</figcaption></figure><p id="1274" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">我们的时态表显示了我们租赁汽车的当前状态:客户已经将汽车归还给我们的停车场，并且每辆汽车都积累了一些里程。</p><p id="8d30" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">与此同时，我们的历史表在最后一个<code class="eh mn mo mp me b">UPDATE</code>语句之前从时态表中获得了一个行的副本。它会自动为我们记录所有的历史！</p><p id="4d55" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">继续说，汽车租赁公司的生意很好。我们又有一个客户租了我们的银色Malibu:</p><pre class="jh ji jj jk fq md me mf mg aw mh dt"><span id="5f91" class="mi kn hu me b fv mj mk l ml mm">UPDATE dbo.CarInventory SET InLot = 0 WHERE CarId = 2</span></pre><figure class="jh ji jj jk fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mt"><img src="../Images/99a5811ee30c56730328449c83b7e940.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OCi0XI8EVAAhK8FIdhJ0Fg.png"/></div></div></figure><p id="233b" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">不幸的是，我们的第二位顾客遭遇车祸，毁了我们的车:</p><pre class="jh ji jj jk fq md me mf mg aw mh dt"><span id="7f60" class="mi kn hu me b fv mj mk l ml mm">DELETE FROM dbo.CarInventory WHERE CarId = 2</span></pre><figure class="jh ji jj jk fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mu"><img src="../Images/f41792020a40aeed695e09b92867d1d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HKT9dGhr2yHjMP7z-g5CUQ.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">The customer walked away from the crash unscathed; the same can not be said for our profits.</figcaption></figure><p id="5335" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">随着我们的银色Malibu的删除，我们的测试数据是完整的。</p><p id="8a7b" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">现在我们有了所有这些伟大的历史跟踪数据，我们如何查询它呢？</p><p id="099b" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">如果我们想回忆两辆车都没有损坏并且我们在赚钱的美好时光，我们可以使用<code class="eh mn mo mp me b">SYSTEM_TIME AS OF</code>编写一个查询，向我们展示我们的桌子在过去的那个时候是什么样子:</p><pre class="jh ji jj jk fq md me mf mg aw mh dt"><span id="3108" class="mi kn hu me b fv mj mk l ml mm">SELECT<br/> *<br/>FROM <br/> dbo.CarInventory<br/>FOR SYSTEM_TIME AS OF '2017-05-18 23:49:50'</span></pre><figure class="jh ji jj jk fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mv"><img src="../Images/3d2098156250b7c6213daed6b13d3711.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xVn3Ej8zkVR0jGDVTDIMeQ.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">The good old days.</figcaption></figure><p id="06b0" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">如果我们想做一些更详细的分析，比如删除了哪些行，我们也可以正常地查询时态表和历史表:</p><pre class="jh ji jj jk fq md me mf mg aw mh dt"><span id="860e" class="mi kn hu me b fv mj mk l ml mm">-- Find the CarIds of cars that have been wrecked and deleted<br/>SELECT DISTINCT<br/> h.CarId AS DeletedCarId<br/>FROM<br/> dbo.CarInventory t<br/> RIGHT JOIN dbo.CarInventoryHistory h<br/>  ON t.CarId = h.CarId <br/>WHERE <br/> t.CarId IS NULL</span></pre><figure class="jh ji jj jk fq iv fe ff paragraph-image"><div class="fe ff mw"><img src="../Images/890369b657f006426637ff43c3850333.png" data-original-src="https://miro.medium.com/v2/resize:fit:428/format:webp/1*aAxrda5LJXKPenh9EI2T5A.png"/></div></figure><h1 id="6644" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">C̶o̶l̶l̶i̶s̶i̶o̶n̶结论</h1><p id="676a" class="pw-post-body-paragraph jn jo hu jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk hn dt translated">即使我的汽车租赁业务没有成功，至少我们能够看到SQL Server的时态表如何帮助我们跟踪汽车库存数据。</p><p id="7f4e" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">我希望您能像我第一次看到时态表时一样兴奋，尤其是在使用<code class="eh mn mo mp me b">FOR SYSTEM_TIME AS OF</code>进行查询时。需要复杂查询来为某个时间点重建数据的日子已经一去不复返了。</p><figure class="jh ji jj jk fq iv"><div class="bz el l di"><div class="mx jm l"/></div></figure><p id="48db" class="pw-post-body-paragraph jn jo hu jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk hn dt translated">喜欢这篇文章吗？请推荐给它一颗绿色的心💚<em class="kl">下图。</em></p><figure class="jh ji jj jk fq iv"><div class="bz el l di"><div class="mx jm l"/></div></figure></div></div>    
</body>
</html>