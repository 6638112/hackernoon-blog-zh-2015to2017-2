<html>
<head>
<title>Monitor your AWS CodeBuilds via Lambda and Slack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Lambda和Slack监控你的AWS代码构建</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/monitor-your-aws-codebuilds-via-lambda-and-slack-ae2c621f68f1?source=collection_archive---------6-----------------------#2017-09-01">https://medium.com/hackernoon/monitor-your-aws-codebuilds-via-lambda-and-slack-ae2c621f68f1?source=collection_archive---------6-----------------------#2017-09-01</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/37868c0eba685bebf118b02080d41250.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pq0G2XAeGbBjPnHXH50DgQ.png"/></div></div></figure><p id="f967" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我最近设置了AWS CodePipeline和CodeBuild来执行持续集成和测试。开箱即用中缺少的部分是构建通知。我想知道我的构建是通过还是失败，如果失败了，错误是什么。</p><p id="b759" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我能够使用AWS CloudWatch Events、Lambda和Slack快速解决问题。它是这样工作的…</p><p id="3582" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">CloudWatch事件触发所有代码构建阶段的Lambda。Lambda帖子是给Slack web hook的消息。我得到了松弛的信息…现场直播是好的。</p><p id="5e5a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我使用CloudFormation来定义和部署堆栈。</p><h2 id="ab8e" class="ka kb hu bd kc kd ke kf kg kh ki kj kk jn kl km kn jr ko kp kq jv kr ks kt ku dt translated">Lambda权限和功能</h2><pre class="kv kw kx ky fq kz la lb lc aw ld dt"><span id="e2fb" class="ka kb hu la b fv le lf l lg lh"><em class="li">#<br/># Role that our Lambda will assume to provide access to other AWS resources<br/>#<br/></em><strong class="la hv">IamRoleLambdaExecution:<br/>  Type: </strong>AWS::IAM::Role<br/>  <strong class="la hv">Properties:<br/>    AssumeRolePolicyDocument:<br/>      Version: </strong>'2012-10-17'<br/>      <strong class="la hv">Statement:<br/>        </strong>- <strong class="la hv">Effect: </strong>Allow<br/>          <strong class="la hv">Principal:<br/>            Service:<br/>              </strong>- lambda.amazonaws.com<br/>          <strong class="la hv">Action:<br/>            </strong>- sts:AssumeRole<br/>    <strong class="la hv">Path: </strong>'/'<br/><br/><em class="li">#<br/># Create a Policy and attach it to our Lambda Role.<br/>#<br/></em><strong class="la hv">IamPolicyLambdaExecution:<br/>  Type: </strong>AWS::IAM::Policy<br/>  <strong class="la hv">DependsOn: </strong>IamRoleLambdaExecution<br/>  <strong class="la hv">Properties:<br/>    PolicyName: </strong>IamPolicyLambdaExecution<br/>    <strong class="la hv">PolicyDocument:<br/>      Version: </strong>'2012-10-17'<br/>      <strong class="la hv">Statement:<br/>      </strong>- <strong class="la hv">Effect: </strong>Allow<br/>        <strong class="la hv">Action:<br/>          </strong>- logs:*<br/>        <strong class="la hv">Resource: </strong>'*'<br/>    <strong class="la hv">Roles:<br/>    </strong>- <strong class="la hv">Ref: </strong>IamRoleLambdaExecution<br/><br/><em class="li">#<br/># Lambda Function<br/>#</em><br/><strong class="la hv">SlackFunction:<br/>  Type: </strong>AWS::Lambda::Function<br/>  <strong class="la hv">Properties:<br/>    Handler: </strong>slack.handler<br/>    <strong class="la hv">Timeout: </strong>5<br/>    <strong class="la hv">Role:<br/>      Fn::GetAtt:<br/>        </strong>- IamRoleLambdaExecution<br/>        - Arn<br/>    <strong class="la hv">Code:<br/>      S3Bucket: </strong>&lt;your s3 bucket&gt;<br/>      <strong class="la hv">S3Key: </strong>'slack.js.zip'<br/>    <strong class="la hv">Runtime: </strong>nodejs6.10<br/>    <strong class="la hv">Environment:<br/>      Variables:<br/>        SLACK_HOOK_URL: </strong>&lt;your slack url&gt;</span></pre><p id="9221" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">将下面的lambda函数作为zip文件上传到S3存储桶。替换上面CloudFormation代码片段中的bucket路径和slack hook url。</p><h2 id="f091" class="ka kb hu bd kc kd ke kf kg kh ki kj kk jn kl km kn jr ko kp kq jv kr ks kt ku dt translated">CloudWatch事件</h2><pre class="kv kw kx ky fq kz la lb lc aw ld dt"><span id="ad19" class="ka kb hu la b fv le lf l lg lh"><em class="li">#<br/># CloudWatch Event to trigger lambda for build slack notifications.<br/>#<br/></em><strong class="la hv">BuildEventRule:<br/>  Type: </strong>'AWS::Events::Rule'<br/>  <strong class="la hv">Properties:<br/>    Description: </strong>'BuildEventRule'<br/>    <strong class="la hv">EventPattern:<br/>      source:<br/>        </strong>- 'aws.codebuild'<br/>      <strong class="la hv">detail-type:<br/>        </strong>- 'CodeBuild Build State Change'<br/>      <strong class="la hv">detail:<br/>        build-status:<br/>          </strong>- 'IN_PROGRESS'<br/>          - 'SUCCEEDED'<br/>          - 'FAILED'<br/>          - 'STOPPED'<br/>    <strong class="la hv">State: </strong>'ENABLED'<br/>    <strong class="la hv">Targets:<br/>      </strong>-<br/>        <strong class="la hv">Arn: </strong>!GetAtt SlackFunction.Arn<br/>        <strong class="la hv">Id: </strong>'BuildRuleLambdaTarget'<br/>        <br/><em class="li">#<br/># Permission for CloudWatch to invoke our Lambda<br/>#</em><br/><strong class="la hv">PermissionForBuildEventsToInvokeLambda:<br/>  Type: </strong>'AWS::Lambda::Permission'<br/>  <strong class="la hv">Properties:<br/>    FunctionName: </strong>!Ref SlackFunction<br/>    <strong class="la hv">Action: </strong>'lambda:InvokeFunction'<br/>    <strong class="la hv">Principal: </strong>'events.amazonaws.com'<br/>    <strong class="la hv">SourceArn: </strong>!GetAtt BuildEventRule.Arn</span></pre><p id="1fc8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，当CodeBuild改变状态时，我们的Lambda将被调用。</p><h2 id="b383" class="ka kb hu bd kc kd ke kf kg kh ki kj kk jn kl km kn jr ko kp kq jv kr ks kt ku dt translated">λ代码</h2><figure class="kv kw kx ky fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="e59d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">就是这样！</p><p id="6457" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您想将您的通知限制到特定的CodeBuild实例，您可以使用<code class="eh ll lm ln la b">project-name</code>将它添加到EventPattern中。例如:</p><pre class="kv kw kx ky fq kz la lb lc aw ld dt"><span id="cf0e" class="ka kb hu la b fv le lf l lg lh"><strong class="la hv">EventPattern:<br/>  source:<br/>    </strong>- 'aws.codebuild'<br/>  <strong class="la hv">detail-type:<br/>    </strong>- 'CodeBuild Build State Change'<br/>  <strong class="la hv">detail:<br/>    project-name:<br/>      </strong>- '&lt;your CodeBuild name&gt;'<br/>    <strong class="la hv">build-status:<br/>      </strong>- 'IN_PROGRESS'<br/>      - 'SUCCEEDED'<br/>      - 'FAILED'<br/>      - 'STOPPED'</span></pre></div></div>    
</body>
</html>