<html>
<head>
<title>Handling webhooks using Django and ngrok</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Django和ngrok处理webhooks</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/handling-webhooks-using-django-and-ngrok-b7ff27a6fd47?source=collection_archive---------5-----------------------#2017-01-23">https://medium.com/hackernoon/handling-webhooks-using-django-and-ngrok-b7ff27a6fd47?source=collection_archive---------5-----------------------#2017-01-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="c2ad" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在本文中，我们将介绍如何使用Django处理webhook，在<a class="ae jp" href="https://hackernoon.com/tagged/github" rel="noopener ugc nofollow" target="_blank"> GitHub </a>中创建一个webhook，并使用ngrok在您的本地机器上测试web hook。但是首先简单介绍一下webhooks。</p><p id="2863" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你已经熟悉webhooks，那么可以跳过第一部分。</p><h1 id="6a51" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">什么是webhooks？</h1><p id="4261" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">假设您正在编写一个应用程序，需要在另一个系统中发生事件时得到通知。事件可能是用户发送推文或某个商品的价格发生变化。</p><p id="21f0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">知道事件何时发生的一个方法是经常检查。例如，你的应用程序可以每5分钟向Twitter发出一个请求，询问“用户<em class="jq">已经发布了什么吗？”这被称为轮询，它会对您的服务器造成负担，因为您必须不断地向外部服务发出请求。</em></p><p id="9ab5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">另一种知道事件已经发生的方法是让其他服务在事情发生变化时通知你的应用程序。这可以通过使用<strong class="it hv"> webhooks </strong>来完成。使用webhooks，您不再需要每5分钟或每天进行一次投票。相反，你的应用程序<strong class="it hv">实时接收事件</strong>。</p><h1 id="98ac" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">处理GitHub webhooks</h1><p id="2309" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">GitHub有太多的事件可以触发webhooks。我们要处理的事件是默认的<code class="eh ku kv kw kx b">push</code>事件，当用户将提交、分支或标记推送到GitHub存储库时会发生该事件。</p><p id="8827" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们写一些代码来处理GitHub的webhooks。我们正在编写一个Django应用程序，所以我们将创建一个视图函数。确保将这个视图连接到URL <code class="eh ku kv kw kx b">/hooks/handle_github</code>。</p><p id="fa3b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是一个视图函数，它将根据GitHub文档中的说明处理GitHub webhooks <a class="ae jp" href="https://developer.github.com/webhooks/creating/" rel="noopener ugc nofollow" target="_blank">。要做到这一点，你需要首先添加一个<code class="eh ku kv kw kx b">GITHUB_WEBHOOK_SECRET</code>到你的设置文件中。把这个当作你的webhook的密码，所以用一个包含很多随机字符的长字符串。另外，记住它，因为我们以后会用到它。</a></p><figure class="ky kz la lb fq lc"><div class="bz el l di"><div class="ld le l"/></div></figure><p id="8688" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">来自GitHub的请求通过<code class="eh ku kv kw kx b">handle_github_hook</code>查看功能进入我们的应用程序。视图确保请求得到授权，加载有效负载JSON，对有效负载做一些有用的事情，并返回HTTP响应。</p><p id="6471" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当编写你的处理程序时，记住<a class="ae jp" href="https://developer.github.com/guides/best-practices-for-integrators/#favor-asynchronous-work-over-synchronous" rel="noopener ugc nofollow" target="_blank"> GitHub希望你在30秒内响应web hooks</a>。如果你需要执行的任务可以快速完成，那么就同步完成。否则最好使用<a class="ae jp" href="http://www.celeryproject.org/" rel="noopener ugc nofollow" target="_blank">芹菜</a>或<a class="ae jp" href="http://python-rq.org/" rel="noopener ugc nofollow" target="_blank"> RQ </a>将任务放在后台。</p><p id="b3e3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们有了处理webhooks的代码，我们需要测试它。</p><h1 id="e0e9" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">输入ngrok</h1><p id="4f67" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">Webhooks需要一些工作来进行本地测试。这是因为从本质上来说，他们希望有一个可公开访问的URL来发送请求，而我们的大多数开发笔记本电脑都没有这个功能。幸运的是，有一个非常简单的方法，我们可以创建一个公共URL，直接指向我们的开发服务器:<a class="ae jp" href="https://ngrok.com/" rel="noopener ugc nofollow" target="_blank"> ngrok </a>。</p><p id="ccfb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Ngrok是一个命令行应用程序，您可以使用它将您的开发机器暴露给互联网。要安装ngrok，请转到<a class="ae jp" href="https://ngrok.com/" rel="noopener ugc nofollow" target="_blank"> ngrok.io </a>并遵循其安装步骤。下载解压就这么简单。你去做那件事时，我会等着的。</p><blockquote class="lf"><p id="b476" class="lg lh hu bd li lj lk ll lm ln lo jo ek translated">🎵危险主题曲🎵</p></blockquote><p id="6c9a" class="pw-post-body-paragraph ir is hu it b iu lp iw ix iy lq ja jb jc lr je jf jg ls ji jj jk lt jm jn jo hn dt translated">ngrok现在安装了吗？太好了！要运行它，请打开您的终端并输入以下内容。</p><pre class="ky kz la lb fq lu kx lv lw aw lx dt"><span id="4901" class="ly js hu kx b fv lz ma l mb mc">ngrok http 8000</span></pre><p id="33b8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这应该会启动一个连接到本地HTTP端口的安全隧道。它看起来会像这样:</p><pre class="ky kz la lb fq lu kx lv lw aw lx dt"><span id="cc61" class="ly js hu kx b fv lz ma l mb mc">ngrok by <a class="ae jp" href="http://twitter.com/inconshreveable" rel="noopener ugc nofollow" target="_blank">@inconshreveable</a>                                                                                                                                         (Ctrl+C to quit)</span><span id="fd35" class="ly js hu kx b fv md ma l mb mc">Session Status                online<br/>Version                       2.1.18<br/>Region                        United States (us)<br/>Web Interface                 <a class="ae jp" href="http://127.0.0.1:4041" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:4041</a><br/>Forwarding                    <a class="ae jp" href="http://dda5f8fd.ngrok.io" rel="noopener ugc nofollow" target="_blank">http://dda5f8fd.ngrok.io</a> -&gt; localhost:8000<br/>Forwarding                    <a class="ae jp" href="https://dda5f8fd.ngrok.io" rel="noopener ugc nofollow" target="_blank">https://dda5f8fd.ngrok.io</a> -&gt; localhost:8000</span><span id="e934" class="ly js hu kx b fv md ma l mb mc">Connections                   ttl     opn     rt1     rt5     p50     p90<br/>                              0       0       0.00    0.00    0.00    0.00</span></pre><p id="570c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">转发URL<a class="ae jp" href="http://dda5f8fd.ngrok.io" rel="noopener ugc nofollow" target="_blank">http://DDA 5 F8 FD . ngrok . io</a>是我将用于webhook的URL。您的URL会有所不同，所以使用ngrok提供的任何东西。</p><h1 id="4184" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">设置我们的网页挂钩</h1><p id="12fe" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">现在我们已经有了代码来处理webhooks <em class="jq">和</em>一个可公开访问的URL，让我们在GitHub中设置一个webhook。</p><p id="4904" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以使用GitHub的API以编程方式将webhook添加到存储库中。事实上，这就是你<em class="jq">应该</em>做的事情，以使整个过程自动化。然而，本着简洁的精神，我们将通过GitHub UI添加一个webhook。为此，请转到GitHub中的一个存储库，选择设置，然后选择Webhooks。</p><p id="e1fd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将您的ngrok URL + <code class="eh ku kv kw kx b">/hooks/handle_github</code>添加到有效负载URL字段。接下来，将Django设置中的秘密字符串添加到秘密字段中。GitHub会发送这个秘密字符串，这样你就可以验证请求是否真的来自他们。最后，选择你希望GitHub通知你的应用程序的事件。当一切就绪后，表单应该如下所示:</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="fe ff me"><img src="../Images/192cdf6f68a18610cb5d4efdb3be80e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*INZptfN1WBQuD2mSOhiDdg.png"/></div></div><figcaption class="ml mm fg fe ff mn mo bd b be z ek">Setting up our webhook in GitHub</figcaption></figure><p id="9763" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">点击添加网页挂钩按钮，你的网页挂钩就可以使用了。</p><h1 id="4c0b" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">测试它</h1><p id="d7b6" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">终于到了确认整件事正常运作的时候了。为此，通过运行<code class="eh ku kv kw kx b">python manage.py runserver</code>启动开发Django服务器。这应该在端口8000上启动您的服务器，这是ngrok期望的端口。</p><p id="4f99" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来我们需要在GitHub中触发一个事件。如果你的webhook被配置为处理默认的<code class="eh ku kv kw kx b">push</code>事件，那么将一个分支推送到GitHub就足够了。</p><p id="d83f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">克隆您创建webhook的存储库。例如:</p><pre class="ky kz la lb fq lu kx lv lw aw lx dt"><span id="4ce3" class="ly js hu kx b fv lz ma l mb mc">$ git clone <a class="ae jp" href="https://github.com/grantmcconnaughey/django-field-history.git" rel="noopener ugc nofollow" target="_blank">https://github.com/grantmcconnaughey/django-field-history.git</a></span></pre><p id="a931" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，创建一个新的分支，并将其推回到GitHub。</p><pre class="ky kz la lb fq lu kx lv lw aw lx dt"><span id="7b90" class="ly js hu kx b fv lz ma l mb mc">$ git checkout -b webhook_test<br/>$ touch new_file.py<br/>$ git add new_file.py<br/>$ git commit -m "Testing webhooks"<br/>$ git push origin webhook_test</span></pre><p id="d0c7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将触发<code class="eh ku kv kw kx b">push</code>事件，GitHub将向您在回购设置中输入的ngrok URL发出请求。这意味着您应该在运行ngrok的终端上看到一些活动:</p><pre class="ky kz la lb fq lu kx lv lw aw lx dt"><span id="16ec" class="ly js hu kx b fv lz ma l mb mc">HTTP Requests<br/>-------------</span><span id="7858" class="ly js hu kx b fv md ma l mb mc">POST /hooks/handle_github/            202 Accepted</span></pre><p id="32f3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">万岁。🎉我们已经成功处理了一个GitHub webhook。</p><h1 id="4a19" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">结论</h1><p id="95e2" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">在这篇文章中，我讨论了<strong class="it hv">什么是</strong>，以及它们为什么有用。接下来，我向您展示了如何在Django应用程序中使用视图功能处理webhooks。然后我开了一个衍生的玩笑，涉及一个深受喜爱的美国游戏节目。之后，我向您展示了如何<strong class="it hv">配置您的本地开发</strong>机器来处理互联网上的webhooks。最后，我们证明了<strong class="it hv">所有这些实际上都有效</strong>。</p><p id="f46e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我希望你学到了一些东西，感谢你的阅读！</p></div><div class="ab cl mp mq hc mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="hn ho hp hq hr"><p id="7b34" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jq">这段代码几乎一字不差地摘自我的项目</em><a class="ae jp" href="https://lintly.com" rel="noopener ugc nofollow" target="_blank"><strong class="it hv"><em class="jq">Lintly</em></strong></a><em class="jq">，一个连续的</em><a class="ae jp" href="https://hackernoon.com/tagged/python" rel="noopener ugc nofollow" target="_blank"><em class="jq">Python</em></a><em class="jq">与GitHub集成的代码林挺服务。如果你想</em> <strong class="it hv"> <em class="jq">跟踪你的Python代码质量</em> </strong> <em class="jq">，那么Lintly可以提供帮助。去lintly.com的</em>和<a class="ae jp" href="https://lintly.com" rel="noopener ugc nofollow" target="_blank">看看吧。</a></p><p id="3a7c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jq">另外，如果你对推特感兴趣，请关注我</em><a class="ae jp" href="https://twitter.com/gmconnaughey" rel="noopener ugc nofollow" target="_blank"><em class="jq">@ gmconnaugney</em></a><em class="jq">。</em></p><div class="ky kz la lb fq ab cb"><figure class="mw lc mx my mz na nb paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mw lc mx my mz na nb paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mw lc mx my mz na nb paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="nc nd ne"><p id="f922" class="ir is jq it b iu iv iw ix iy iz ja jb nf jd je jf ng jh ji jj nh jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is jq it b iu iv iw ix iy iz ja jb nf jd je jf ng jh ji jj nh jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="fe ff ni"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="ky kz la lb fq lc"><div class="bz el l di"><div class="nj le l"/></div></figure></div></div>    
</body>
</html>