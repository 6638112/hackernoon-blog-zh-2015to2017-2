<html>
<head>
<title>Manage AWS VPC as Infrastructure as Code with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform将AWS VPC作为基础架构和代码进行管理</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/manage-aws-vpc-as-infrastructure-as-code-with-terraform-55f2bdb3de2a?source=collection_archive---------0-----------------------#2017-10-27">https://medium.com/hackernoon/manage-aws-vpc-as-infrastructure-as-code-with-terraform-55f2bdb3de2a?source=collection_archive---------0-----------------------#2017-10-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/40663ecc019fcd13d04b71fdfa845c69.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/0*amwV_MPhEcsLUpWr."/></div></figure><p id="5290" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在本教程中，我将向您展示如何使用<strong class="ja hv">地形</strong>在不到<strong class="ja hv"> 1分钟</strong>的时间内设置一个<strong class="ja hv"> VPC </strong>，如下图所示:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div class="fe ff jw"><img src="../Images/9702d61098bcc6f7777365d61dcb0703.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*JrIFRvnGAA7LVq4q."/></div></figure><p id="e653" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">上面的<strong class="ja hv"> VPC </strong>拓扑是将要实现的内容的最佳演示:</p><ul class=""><li id="89aa" class="kb kc hu ja b jb jc jf jg jj kd jn ke jr kf jv kg kh ki kj dt translated">互联网无法访问<strong class="ja hv">私有子网</strong>(包括进出)</li><li id="bfa6" class="kb kc hu ja b jb kk jf kl jj km jn kn jr ko jv kg kh ki kj dt translated"><strong class="ja hv">公共子网</strong>是可访问的，所有流量(0.0.0.0/0)被直接路由到<strong class="ja hv">互联网网关</strong></li></ul><p id="898a" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在我们开始之前，本演示中使用的所有代码都可以在我的<a class="ae kp" href="https://github.com/mlabouardy/terraform-aws-labs" rel="noopener ugc nofollow" target="_blank"> <strong class="ja hv"> Github </strong> </a>中找到。</p><p id="ae34" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">注意:我已经做了一个<a class="ae kp" href="http://www.blog.labouardy.com/manage-aws-infrastracture-as-code-with-terraform/" rel="noopener ugc nofollow" target="_blank"> <strong class="ja hv">教程</strong> </a>关于如何开始使用<strong class="ja hv"> Terraform </strong>所以确保阅读它以获得更多细节。</p><p id="51b2" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 1 —全局变量</strong></p><p id="2b15" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">该文件包含特定于环境的配置，如区域名称、CIDR块和AWS凭证…</p><figure class="jx jy jz ka fq iv"><div class="bz el l di"><div class="kq kr l"/></div></figure><p id="e79b" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 2 —配置AWS提供者</strong></p><figure class="jx jy jz ka fq iv"><div class="bz el l di"><div class="kq kr l"/></div></figure><p id="397a" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 3 —创建一个VPC </strong></p><figure class="jx jy jz ka fq iv"><div class="bz el l di"><div class="kq kr l"/></div></figure><p id="7d48" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4 —创建子网</strong></p><figure class="jx jy jz ka fq iv"><div class="bz el l di"><div class="kq kr l"/></div></figure><p id="152a" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">为了使<strong class="ja hv">公共子网</strong>可由<strong class="ja hv">互联网</strong>寻址，我们需要一个<strong class="ja hv">互联网网关</strong>:</p><p id="f212" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 5 —互联网网关</strong></p><figure class="jx jy jz ka fq iv"><div class="bz el l di"><div class="kq kr l"/></div></figure><p id="e6af" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">为了允许流量从<strong class="ja hv">公共子网</strong>通过<strong class="ja hv"> NAT网关</strong>到达互联网，我们需要创建一个新的<strong class="ja hv">路由表</strong>。</p><p id="fbbf" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 6 —路由表</strong></p><figure class="jx jy jz ka fq iv"><div class="bz el l di"><div class="kq kr l"/></div></figure><p id="c85c" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">接下来，我们将为每个子网创建一个安全组。</p><p id="55f0" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 7 —安全组</strong></p><p id="009f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 7 .1 —网络服务器SG </strong></p><figure class="jx jy jz ka fq iv"><div class="bz el l di"><div class="kq kr l"/></div></figure><p id="ab00" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">这个<strong class="ja hv">安全组</strong>允许<strong class="ja hv"> HTTP/HTTPS </strong>和<strong class="ja hv"> SSH </strong>从<strong class="ja hv">任何地方</strong>连接。</p><p id="f15f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 7.2 —数据库SG </strong></p><figure class="jx jy jz ka fq iv"><div class="bz el l di"><div class="kq kr l"/></div></figure><p id="8cfd" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">这个<strong class="ja hv">安全组</strong>只从<strong class="ja hv">公共子网</strong>启用<strong class="ja hv"> MySQL 3306 </strong>端口、<strong class="ja hv"> ping </strong>和<strong class="ja hv"> SSH </strong>。</p><p id="3fd8" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">现在我们将部署<strong class="ja hv"> EC2 </strong>实例，但在此之前，我们需要创建一个<strong class="ja hv">密钥对</strong>，以便稍后通过<strong class="ja hv"> SSH </strong>连接到实例。</p><p id="71d2" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 8 —密钥对</strong></p><figure class="jx jy jz ka fq iv"><div class="bz el l di"><div class="kq kr l"/></div></figure><p id="f8ce" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 9 — EC2实例</strong></p><p id="e590" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 9.1 —网络服务器实例</strong></p><figure class="jx jy jz ka fq iv"><div class="bz el l di"><div class="kq kr l"/></div></figure><p id="942b" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">这个实例将扮演一个<strong class="ja hv">网络服务器的角色。</strong>因此，我们向实例<strong class="ja hv">用户数据</strong>传递一个shell脚本<strong class="ja hv"> install.sh </strong>，它包含安装<strong class="ja hv"> Apache服务器</strong>的命令:</p><figure class="jx jy jz ka fq iv"><div class="bz el l di"><div class="kq kr l"/></div></figure><p id="5515" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 9.2 —数据库实例</strong></p><figure class="jx jy jz ka fq iv"><div class="bz el l di"><div class="kq kr l"/></div></figure><p id="9549" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">一旦定义了所有需要的模板，确保将<strong class="ja hv"> AWS </strong>凭证<strong class="ja hv">变量设置为<strong class="ja hv">环境变量</strong>:</strong></p><p id="02e3" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">|导出AWS_ACCESS_KEY_ID= "您的访问密钥ID "<br/>|导出AWS_SECRET_ACCESS_KEY= "您的秘密访问密钥"</p><p id="f422" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">注意:您可以始终使用您的根用户<strong class="ja hv">对任何事情都有访问权限，但是出于安全考虑，建议您只使用有限权限的用户帐户。所以使用<strong class="ja hv"> AWS IAM </strong>创建一个新的。</strong></p><p id="1daf" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">要查看terraform计划如何创建资源类型“<strong class="ja hv"> terraform计划</strong>”。要创建基础设施类型"<strong class="ja hv"> terraform应用</strong>":</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><a href="https://asciinema.org/a/9wqCgDworzVqM4jDSs6cIHCWJ"><div class="fe ff ks"><img src="../Images/3c4c9b9369492dbd61351d6e16584935.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8ZBaMFpWzm0Axa6h."/></div></a></figure><p id="c411" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">这将调出<strong class="ja hv"> VPC </strong>，以及所有必要的资源。现在，在您的<a class="ae kp" href="https://console.aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ja hv"> AWS管理控制台</strong> </a>中，您应该看到创建的资源:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div class="fe ff jw"><img src="../Images/40223551e155b0f48a23b973fa920635.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*JmCBDx89kh40EK2M."/></div></figure><p id="8dea" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如果你点击<strong class="ja hv">子网</strong>菜单，你应该看到<strong class="ja hv">公共</strong> &amp; <strong class="ja hv">私有子网</strong>:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="fe ff kt"><img src="../Images/78ae96b9c1c275f4feb7641a03dc1c88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tOLPMktXJwTtBze1NufvDQ.png"/></div></div></figure><p id="1da1" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">同样适用于<strong class="ja hv">路由表</strong>:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="fe ff kt"><img src="../Images/ac0a1b1b42f04ca49a950f52eb11cb30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MVLuV_S91142DwquvMePzg.png"/></div></div></figure><p id="3b21" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">以及<strong class="ja hv">互联网网关</strong>:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="fe ff kt"><img src="../Images/6205cbd2b096ae051b53c83a97b8c760.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L6VHOfqv4tF9foyNqiScRw.png"/></div></div></figure><p id="1298" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv">安全组</strong>也:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="fe ff kt"><img src="../Images/4a2a580d6c892e2c331dbf63d68551c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8QtqrBSP0iChVP3bQX__Yw.png"/></div></div></figure><p id="2f84" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv">web服务器安全组:</strong></p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div class="fe ff jw"><img src="../Images/53970b903b3610b506a4607fa9d38ef2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*q-73WB-_QcvrL0vF."/></div></figure><p id="5741" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv">数据库安全组:</strong></p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="fe ff jw"><img src="../Images/bb616eb8641fa6a6b1ac7cc29f787645.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*qQCmRMiENKY1A4gu."/></div></div></figure><p id="2f92" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">最后是<strong class="ja hv"> EC2实例:</strong></p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="fe ff ky"><img src="../Images/e30a12c062d6c8ca41733feb7b0847c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sYFRuME7rjJV-W6X6iiZyA.png"/></div></div></figure><p id="1cec" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv">网络服务器实例:</strong></p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="fe ff kt"><img src="../Images/20d844be0cf2f1c6b9b971f69a2cab8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cOlA_qc3lKKGQNg50IuJDw.png"/></div></div></figure><p id="08ee" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv">数据库实例:</strong></p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="fe ff kt"><img src="../Images/72974f183e4e24407a9ca5c3759327f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vyxDBy_Y00EOQG8UMJmiGg.png"/></div></div></figure><p id="b0e3" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">不要忘记通过键入"<strong class="ja hv"> terraform destroy </strong>"来销毁不需要的资源:</p><figure class="jx jy jz ka fq iv fe ff paragraph-image"><a href="https://asciinema.org/a/0VRbQdMmqVa7E6HhLK0bqTrat"><div class="fe ff ks"><img src="../Images/c917cbac7c4903dca61511fcdef29759.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lqLd8gbQ9buCrAF_0mXXvw.png"/></div></a></figure></div></div>    
</body>
</html>