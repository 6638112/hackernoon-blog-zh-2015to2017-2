<html>
<head>
<title>What’s really wrong with node_modules and why this is your fault</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">node_modules到底有什么问题，为什么这是您的错</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/whats-really-wrong-with-node-modules-and-why-this-is-your-fault-8ac9fa893823?source=collection_archive---------2-----------------------#2017-12-18">https://medium.com/hackernoon/whats-really-wrong-with-node-modules-and-why-this-is-your-fault-8ac9fa893823?source=collection_archive---------2-----------------------#2017-12-18</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="bf05" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我从来没有真正关心过<code class="eh jp jq jr js b">node_modules</code>的大小——我的想法是，你不应该太在意完成工作所需的工具。如果你需要一个20公斤重的锤子来钉钉子，你就拿着它。与<code class="eh jp jq jr js b">node_modules</code>相同的故事，它可能有几千字节或几兆字节重，因为我们想象的锤子带有一套重钉子，对吗？嗯，也许，理论上。</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div class="fe ff jt"><img src="../Images/31efb7e2813a7b45174467f50f939e7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*QxMRl-ibGJJt3ZF4B1WGJg.jpeg"/></div></figure><p id="176b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们放下那个花哨的类比，看看现实世界的例子。我将研究一些@angular/cli依赖项——但只是因为它是一个相当大的库。我不想让它看起来很糟糕——它只是一个平均包装的良好代表。我用npm@5.5.1安装在空目录下。Npm报告安装后“在107.13s内增加了976个包”(磁盘上有141兆字节)。</p><p id="0989" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好的，cli包是一个非常强大的库，它的依赖项列表有点太长，但也许所有的依赖项都是需要的。让我们来关注一下第一个被选中的包<code class="eh jp jq jr js b">common-tags</code>。快速浏览它的文档，你可以说它是某种utils库，有许多处理文本的常用方法。到目前为止还不错——通用方法，易于重用。</p><p id="a0e9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">只有一个小瑕疵——在<code class="eh jp jq jr js b">common-tags</code>的deps中我们看到了<code class="eh jp jq jr js b">babel-runtime</code>。有点令人惊讶的是，我们只需要一些常见的文本函数，但是-嘿-这是2017 JS给你的。哦等等，原来它想要<code class="eh jp jq jr js b">core-js</code>和<code class="eh jp jq jr js b">regenerator-runtime</code>。幸运的是，它在这里结束了，更重要的是，<code class="eh jp jq jr js b">core-js</code>也是utils库，老实说，相当大的一个库！它有这么多的功能，我敢打赌，很多其他软件包将使用它！</p><p id="9247" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不完全是。只有<code class="eh jp jq jr js b">babel-runtime</code>的dep里有。哦，太好了。 <br/>回到起点，cli只使用了<code class="eh jp jq jr js b">common-tags</code> — <code class="eh jp jq jr js b">stripIndents</code>、<code class="eh jp jq jr js b">stripIndent</code>、<code class="eh jp jq jr js b">oneLine</code>中的3个(琐碎的)方法。哦，我的雏菊。</p><p id="56e5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了使用这3种方法<code class="eh jp jq jr js b">node_modules </code>需要1826个文件。这只是提到的976个已安装软件包中的4个。</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div class="fe ff kc"><img src="../Images/2c7b23f421d5f2f475a45409986c41b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*5shXPVs_DHy0V57FrMiysw.jpeg"/></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">This is your dream about lightweight package collapsing</figcaption></figure><p id="14c0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下一个依赖项是<code class="eh jp jq jr js b">core-object</code>——它总共下载了8个包和45个文件——所以还不错。而且其他包也用这些文件，大多是<code class="eh jp jq jr js b">chalk</code>。<br/>真正令人失望的是这8个中的6个是<code class="eh jp jq jr js b">chalk </code>的依赖项，并且<code class="eh jp jq jr js b">chalk</code>在<code class="eh jp jq jr js b">core-object</code>中只使用了一次，以绘制黄色的反对消息。</p><p id="8975" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">其他随机发现:</p><ul class=""><li id="1e63" class="kh ki hu it b iu iv iy iz jc kj jg kk jk kl jo km kn ko kp dt translated">解决“查询字符串”主题的几个包</li><li id="9420" class="kh ki hu it b iu kq iy kr jc ks jg kt jk ku jo km kn ko kp dt translated">从<code class="eh jp jq jr js b">minimalistic-assert</code>到<code class="eh jp jq jr js b">assert-plus</code>复杂性不同的断言方法的一些尝试</li><li id="2bb2" class="kh ki hu it b iu kq iy kr jc ks jg kt jk ku jo km kn ko kp dt translated">几十种不同的<code class="eh jp jq jr js b">is-*</code>包</li><li id="f8fd" class="kh ki hu it b iu kq iy kr jc ks jg kt jk ku jo km kn ko kp dt translated"><strong class="it hv">许多<strong class="it hv"> </strong>的</strong>包会“美化”错误和控制台打印</li><li id="9a3d" class="kh ki hu it b iu kq iy kr jc ks jg kt jk ku jo km kn ko kp dt translated">数百个多孔填料/垫片或本地方法的重新实现</li><li id="a072" class="kh ki hu it b iu kq iy kr jc ks jg kt jk ku jo km kn ko kp dt translated">当然先前的断言坐在满的<code class="eh jp jq jr js b">lodash</code>旁边的<code class="eh jp jq jr js b">node_modules </code></li><li id="e919" class="kh ki hu it b iu kq iy kr jc ks jg kt jk ku jo km kn ko kp dt translated">…和来自<code class="eh jp jq jr js b">lodash </code>的一些分部方法作为单独的dep</li></ul><p id="17ff" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所谓随机，我的意思是只挑选一些包，然后简单地搜索相似的包，这通常很容易，因为这些包有相似的名字。</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff kv"><img src="../Images/8e1f3527bcb2ff57c1bf8e3d7b1e5e04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KWX2SF2O2hVxDQQ66ZOA3g.png"/></div></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">Some of the found duplicates</figcaption></figure></div><div class="ab cl la lb hc lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="hn ho hp hq hr"><p id="a2ef" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们到此为止吧。我敢打赌，其他依赖是必要的，也是经过深思熟虑的。</p><p id="2ccc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这对于JS开发者来说并不新鲜，已经有一段时间了，这种情况不应该被接受——<code class="eh jp jq jr js b">node_modules </code>的大小是一个笑话的话题，删除像“left pad”这样的包是灾难的原因。</p><p id="4cfe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">那么如何修复呢？通过创建<em class="kb">适当的</em>标准库。</p><p id="03fc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="kb">适当的</em>意味着它应该是完整的，包含各种对文本、数字、集合进行操作的常用函数和很多函数，这样在99.99%的时间里你就不需要任何其他的库了。那是幻想吗？我不这么认为。以提到的一些utils库为基础，并将其与其他库合并将是一个很好的开始。</p><p id="51c5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">只有一个问题，这甚至不是一个技术问题——创建这样一个包需要有人担任领导者。我想的是绝对权力而不是民主——如果你想知道民主如何处理这个问题，再看看你的node_modules。它需要一个强有力的领导者，因为它需要一个坚实的计划，而不仅仅是几个月的讨论。我们已经实现了所有的包，我们只需要以一种逻辑的方式把它粘在一起。</p></div><div class="ab cl la lb hc lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="hn ho hp hq hr"><p id="9f17" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，为了追求可重用性和“保持干燥”,典型的<code class="eh jp jq jr js b">node_modules</code>目录最终完全变湿了。仅仅因为我们认为几十个功能重叠的包比一个精心设计的库要好。</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff lh"><img src="../Images/92b3c686a594c323bd6e8ee4b10e8a3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6YSZXcV1ajvVNOmUBY-G_Q.jpeg"/></div></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">Which is the bigger number, five or one? One army, a real army, united behind one leader with one purpose.</figcaption></figure></div><div class="ab cl la lb hc lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="hn ho hp hq hr"><p id="3f92" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">关于jQuery有一点需要注意——不久前，jQuery几乎出现在每个项目中。为什么？有许多确凿的理由:</p><ul class=""><li id="591a" class="kh ki hu it b iu iv iy iz jc kj jg kk jk kl jo km kn ko kp dt translated">它以一种方便使用的形式提供了一组常用的函数。jQuery方法很容易相互链接(由一个组织开发的结果)。</li><li id="6339" class="kh ki hu it b iu kq iy kr jc ks jg kt jk ku jo km kn ko kp dt translated">这是众所周知的，所以加入一个项目很容易，因为没有额外的学习曲线。</li><li id="433d" class="kh ki hu it b iu kq iy kr jc ks jg kt jk ku jo km kn ko kp dt translated">虽然有些人抱怨jQuery的大小，但这几乎无关紧要，因为它通常是从CDN加载的——所以90%的时间它已经存在于用户的计算机上。</li></ul><p id="bc6a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后一点非常重要——如果你不需要下载，一个库有多大并不重要。我想到了<code class="eh jp jq jr js b">lodash</code>——它真的有很多功能，可以取代很多不必要的依赖。如果您需要JavaScript中缺少的东西，那么它的模块化结构和缺乏依赖性是一个很好的选择。</p><p id="f35a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">仅仅因为库的大小而选择一些较小的库，这与您在进行一些不成熟的优化实践时所做的事情是一样的——最终没有获得性能提升，并且代码混乱。这里也是一样——更小、无组织的包会导致冗余、不兼容和整体更大的<code class="eh jp jq jr js b">node_modules</code>尺寸。</p></div><div class="ab cl la lb hc lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="hn ho hp hq hr"><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff li"><img src="../Images/eacc62e6797d1a9ad14d7487293f8560.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KakQvka8phL2CFstj3ihdw.png"/></div></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">On the vertical axis is a size in KB, on horizontal individual packages</figcaption></figure><p id="a163" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在开始的时候，我说过我不在乎<code class="eh jp jq jr js b">node_modules</code>的大小，这在一定程度上是正确的——我不在乎它占用的空间，但是我在乎文件的数量。在@angular/cli的情况下，几乎70%的磁盘空间是20个最大的包(<a class="ae lj" href="https://en.wikipedia.org/wiki/Pareto_principle" rel="noopener ugc nofollow" target="_blank">帕累托法则</a>在任何地方都适用！).</p><p id="c6a1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">更重要的是，如果你看看下面的WinDirStat的报告，你会发现很多包都包含大文件(例如sourcemaps，这些是绿色的)。就复制文件而言，计算机在处理几个大文件时比处理成千上万个小文件时工作得更好。</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff lk"><img src="../Images/1e496f6db5766b76d7c2bff8772396a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PtO0y-8kRLFxDnO2kllevw.png"/></div></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">The node_modules report from WinDirStat. Packages in the right bottom corner can have only fractions of Planck length</figcaption></figure><p id="5c14" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">大量的包还有一个缺点——潜在的版本不兼容。我们假设每个包都有1.0和2.0两个版本。在最坏的情况下，一些软件包可能需要1.0，而其他的可能需要2.0。我们的应用程序中的软件包越多，您获得的组合就越多。解析这些组合需要时间、CPU和空间来保持某个同样旧的包所需的旧版本的每次出现。</p></div><div class="ab cl la lb hc lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="hn ho hp hq hr"><h2 id="2753" class="ll lm hu bd ln lo lp lq lr ls lt lu lv jc lw lx ly jg lz ma mb jk mc md me mf dt translated">收场白</h2><p id="ca96" class="pw-post-body-paragraph ir is hu it b iu mg iw ix iy mh ja jb jc mi je jf jg mj ji jj jk mk jm jn jo hn dt translated">这就是我们生活的世界。最糟糕的事情是“它有点工作”,所以它不会很快改变。创建JS标准库会有所帮助，但是开发者的心态需要真正的改变。</p><p id="39f6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以，如果你能从我的looong文章中记住一件事，那就是“使用lodash”。如果可以的话，也要“使用已经被其他人使用的流行包”。编程不是个性竞赛，所以选择经过测试、久经沙场的库，不要增加JavaScript熵。</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="fe ff ml"><img src="../Images/16d75d219ec8587f63129a6e071a8098.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tLmdca91O3WXf_ZTiy8JFA.jpeg"/></div></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">Mandatory joke, I almost forgot about it</figcaption></figure></div></div>    
</body>
</html>