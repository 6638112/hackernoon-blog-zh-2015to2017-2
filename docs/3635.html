<html>
<head>
<title>Secure mongodb setup using Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Docker保护mongodb设置</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/securing-mongodb-on-your-server-1fc50bd1267b?source=collection_archive---------2-----------------------#2017-04-13">https://medium.com/hackernoon/securing-mongodb-on-your-server-1fc50bd1267b?source=collection_archive---------2-----------------------#2017-04-13</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/6f0331be9f2d530dd99ec136aff1c0c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E8q-p6mBHRy0PRDfKxDmkw.png"/></div></div></figure><div class=""/><p id="6be4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最近，在不安全的mongodb服务器上出现了许多勒索黑客。由于mongodb的不安全设置或设置时忽略了一些细节，许多人成为了这次黑客攻击的受害者。</p><p id="72db" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">即使在服务器上设置了安全认证设置后，由于黑客设置的自动化脚本，很少有人在几秒钟内升级或重新安装时被黑客攻击。</p><p id="adb1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">关于mongodb ransom hack的更多信息—<a class="ae ka" href="https://nakedsecurity.sophos.com/2017/01/11/thousands-of-mongodb-databases-compromised-and-held-to-ransom/" rel="noopener ugc nofollow" target="_blank">https://naked security . sophos . com/2017/01/11/数千个MongoDB-databases-compromised-and-hold-to-ransom/</a></p></div><div class="ab cl kb kc hc kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hn ho hp hq hr"><h1 id="4136" class="ki kj if bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf dt translated">让我们得到保护</h1><p id="44c6" class="pw-post-body-paragraph jc jd if je b jf lg jh ji jj lh jl jm jn li jp jq jr lj jt ju jv lk jx jy jz hn dt translated">为了解决这些问题，我和我的朋友<a class="ll lm gr" href="https://medium.com/u/7baa042378b3?source=post_page-----1fc50bd1267b--------------------------------" rel="noopener" target="_blank"> Prady </a>用Docker设计了一个简单的可扩展的mongodb设置。我们已经在Digital Ocean上运行Ubuntu 14.04的虚拟专用服务器(VPS)上完成了这个设置。</p><p id="5ce5" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先，我们需要在我们的服务器上创建一个目录，这是我们的数据库实际驻留的地方。即我们数据库的物理位置</p><p id="1322" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">假设我们的应用程序名为“Sample ”,并适当地命名我们的容器、数据库和空间。</p><pre class="ln lo lp lq fq lr ls lt lu aw lv dt"><span id="38bb" class="lw kj if ls b fv lx ly l lz ma">mkdir ~/sample_db</span></pre><p id="6f5f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在你选择的港口创建mongodb容器。</p><p id="fdbf" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">众所周知，27017是mongodb的默认端口。让我们通过在自定义端口上创建mongodb容器来使它不那么明显。</p><pre class="ln lo lp lq fq lr ls lt lu aw lv dt"><span id="fbbb" class="lw kj if ls b fv lx ly l lz ma">sudo docker run -d -p <strong class="ls ig">YOUR_PORT</strong>:27017 -v ~/sample_db:/data/db mongo</span></pre><p id="9cff" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">列出所有docker容器</p><pre class="ln lo lp lq fq lr ls lt lu aw lv dt"><span id="2558" class="lw kj if ls b fv lx ly l lz ma">sudo docker ps</span></pre><p id="a9a9" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以根据application_name或您选择的名称来命名docker容器，以便于记忆。当我们不这样做时——docker会随机赋值，比如“口渴_伦琴”</p><p id="2e1a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">重命名docker容器</p><pre class="ln lo lp lq fq lr ls lt lu aw lv dt"><span id="3465" class="lw kj if ls b fv lx ly l lz ma">sudo docker rename thirsty_roentgen sampledb</span></pre><p id="7c2a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们创建了一个docker容器，但是没有对它进行身份验证。如果没有身份验证，创建的mongodb容器只能通过本地访问，也就是说，当您使用ssh凭证进入您的服务器时</p><p id="46d5" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">要向外界公开这一点，您需要创建启用了身份验证的mongodb容器</p><p id="27e1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">因为您已经在运行一个容器，所以只需添加— auth</p><pre class="ln lo lp lq fq lr ls lt lu aw lv dt"><span id="c7a5" class="lw kj if ls b fv lx ly l lz ma">docker run — name sampledb -d mongo — auth</span></pre><p id="a18c" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">将导致如下错误</p><pre class="ln lo lp lq fq lr ls lt lu aw lv dt"><span id="3519" class="lw kj if ls b fv lx ly l lz ma">The container name “/sampledb” is already in use by container a2ddcec52f17d95ba067ab4e4e52621b74f762a3a2e2024e1a7852d592192b5c. You have to remove (or rename) that container to be able to reuse that name..</span></pre><p id="f079" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们需要停止当前的mongodb实例并删除它，然后在启用身份验证的情况下重新创建</p><pre class="ln lo lp lq fq lr ls lt lu aw lv dt"><span id="6871" class="lw kj if ls b fv lx ly l lz ma">docker stop sampledb<br/>docker rm sampledb</span></pre><p id="6a45" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">创建名为sampledb并启用了身份验证的mongodb容器(— auth)</p><pre class="ln lo lp lq fq lr ls lt lu aw lv dt"><span id="f6bd" class="lw kj if ls b fv lx ly l lz ma">sudo docker run -d — name sampledb -p 29019:27017 -v ~/sample_db:/data/db mongo — auth</span></pre><p id="0356" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">列出集装箱</p><pre class="ln lo lp lq fq lr ls lt lu aw lv dt"><span id="fd39" class="lw kj if ls b fv lx ly l lz ma">sudo docker ps</span></pre><p id="c3c4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">使用管理数据库运行mongodb实例</p><pre class="ln lo lp lq fq lr ls lt lu aw lv dt"><span id="41fd" class="lw kj if ls b fv lx ly l lz ma">docker exec -it sampledb mongo admin</span></pre><p id="a184" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">进入mongodb shell —现在创建管理员用户</p><p id="03ac" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">正在为mongodb服务器创建管理员用户</p><pre class="ln lo lp lq fq lr ls lt lu aw lv dt"><span id="6048" class="lw kj if ls b fv lx ly l lz ma">db.createUser({ user: ‘sample_admin’, pwd: ‘p@ssword’, roles: [ { role: “userAdminAnyDatabase”, db: “admin” } ] });</span></pre><p id="ec9c" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">使用指定的用户和密码运行mongodb</p><pre class="ln lo lp lq fq lr ls lt lu aw lv dt"><span id="9c90" class="lw kj if ls b fv lx ly l lz ma">docker exec -it sampledb mongo -u sample_admin -p p@ssword — authenticationDatabase admin</span></pre><p id="e2d7" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">进入mongodb shell</p><p id="ae12" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">创建所需的数据库</p><pre class="ln lo lp lq fq lr ls lt lu aw lv dt"><span id="e1fb" class="lw kj if ls b fv lx ly l lz ma">use mydatabase</span></pre><p id="1151" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为数据库安全性创建管理应用程序用户</p><pre class="ln lo lp lq fq lr ls lt lu aw lv dt"><span id="6b95" class="lw kj if ls b fv lx ly l lz ma">db.createUser({ user: ‘mydb_admin’, pwd: ‘myp@ss’, roles: [“readWrite”, “dbAdmin”] });</span></pre><p id="21ad" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后创建您需要的集合</p><p id="8ac8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在下一个系列中，我们将让您知道如何使用robomongo连接到mongodb的这个安全设置。</p></div></div>    
</body>
</html>