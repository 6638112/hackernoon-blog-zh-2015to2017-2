<html>
<head>
<title>Yubl’s road to Serverless — Part 4, Building a scalable push notification system</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Yubl的无服务器之路——第4部分，构建可伸缩的推送通知系统</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/yubls-road-to-serverless-part-4-building-a-scalable-push-notification-system-62b38924ed61?source=collection_archive---------3-----------------------#2017-04-23">https://medium.com/hackernoon/yubls-road-to-serverless-part-4-building-a-scalable-push-notification-system-62b38924ed61?source=collection_archive---------3-----------------------#2017-04-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="58b7" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">我们使用Lambda、S3、API Gateway、DynamoDB和SES的组合，构建了一个与BigQuery结果集成的系统，能够批量发送数百万条推送通知。</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff jj"><img src="../Images/0dd315907c4b595f7e469f006369811a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MZZeuhl42pCJf1fG."/></div></figure><h1 id="c8a4" class="jr js hu bd jt ju jv jw jx jy jz ka kb ja kc jb kd jd ke je kf jg kg jh kh ki dt translated">这条路到此为止</h1><p id="c28d" class="pw-post-body-paragraph kj kk hu kl b km kn iv ko kp kq iy kr ks kt ku kv kw kx ky kz la lb lc ld le hn dt translated">第1部分:<a class="ae lf" rel="noopener" href="/@theburningmonk/yubls-road-to-serverless-part-1-overview-ca348370acde">概述</a></p><p id="211d" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">第2部分:<a class="ae lf" rel="noopener" href="/@theburningmonk/yubls-road-to-serverless-part-2-testing-and-ci-cd-72b2e583fe64">测试和持续交付策略</a></p><p id="5c21" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">第三部:<a class="ae lf" href="https://hackernoon.com/yubls-road-to-serverless-part-3-ops-6c82139bb7ee" rel="noopener ugc nofollow" target="_blank"> ops </a></p><p id="ca24" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">第4部分:<a class="ae lf" href="https://hackernoon.com/yubls-road-to-serverless-part-4-building-a-scalable-push-notification-system-62b38924ed61" rel="noopener ugc nofollow" target="_blank">构建可伸缩的推送通知系统</a></p><p id="83ea" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">第5部分:<a class="ae lf" href="https://hackernoon.com/yubls-road-to-serverless-part-5-building-better-recommendations-with-lambda-bigquery-and-1d74407f3b3a" rel="noopener ugc nofollow" target="_blank">建立一个更好的推荐系统</a></p><p id="9fc6" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">就在Yubl的<a class="ae lf" href="http://theburningmonk.com/2016/11/yubl-a-sad-end-to-a-wonderful-journey/" rel="noopener ugc nofollow" target="_blank">不合时宜的消亡</a>之前，我们做了一件有趣的工作，重新设计了向用户发送定向推送通知的系统，以提高用户保留率。</p><p id="07f4" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">旧系统依靠<a class="ae lf" href="https://mixpanel.com/" rel="noopener ugc nofollow" target="_blank"> MixPanel </a>来选择用户和发送推送通知。虽然<em class="ll"> MixPanel </em>对于我们快速获得基本分析非常有用，但我们很快发现我们的用例已经超出了<em class="ll"> MixPanel </em>。最紧迫的限制是，我们无法根据用户的社交图谱查询用户以创建目标推送通知，例如，当某个影响者发布新帖子或开展新的社交媒体活动时，通知他/她的关注者。</p><p id="303e" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">由于我们所有的分析事件都被传输到Google BigQuery(使用<em class="ll">kine sis</em>T20】fire hose、<em class="ll"> S3 </em>和<em class="ll"> Lambda </em>的组合)，我们拥有了支持产品团队复杂用例所需的所有数据。</p><p id="71a1" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">我们需要的是一个推送通知系统，它可以与BigQuery结果集成，并且能够批量发送数百万条推送通知。</p><h1 id="3650" class="jr js hu bd jt ju jv jw jx jy jz ka kb ja kc jb kd jd ke je kf jg kg jh kh ki dt translated">设计目标</h1><p id="fc17" class="pw-post-body-paragraph kj kk hu kl b km kn iv ko kp kq iy kr ks kt ku kv kw kx ky kz la lb lc ld le hn dt translated">从高层次来说，我们需要支持两种类型的通知。</p><p id="1a4c" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated"><strong class="kl hv">特别通知</strong>由营销团队推动，与影响者和BI团队密切合作，将用户与他们可能感兴趣的影响者或内容匹配起来。通知示例包括:</p><ul class=""><li id="038b" class="lm ln hu kl b km lg kp lh ks lo kw lp la lq le lr ls lt lu dt translated">关注<em class="ll">配饰</em>和其他时尚品牌的用户可能有兴趣知道另一个知名时尚品牌何时加入该平台</li><li id="0063" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">关注影响者的用户可能有兴趣知道该影响者何时发布新帖子或开展社交媒体活动(通常有赠送奖品等)。)</li><li id="d021" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">分享/喜欢音乐相关内容的用户可能有兴趣知道<em class="ll">蒂尼·坦帕</em>已经加入该平台</li></ul><p id="2b82" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated"><strong class="kl hv">预定通知</strong>由产品团队驱动，这些通知旨在提醒用户完成注册过程或在过期后返回平台。通知示例包括:</p><ul class=""><li id="bb58" class="lm ln hu kl b km lg kp lh ks lo kw lp la lq le lr ls lt lu dt translated">第1天未完成的注册:通知未完成注册过程的用户回来完成该过程</li><li id="eee7" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">第2天参与:通知用户在第2天回来关注更多人或邀请朋友</li><li id="9f1a" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">第21天不活动:通知21天没有登录应用程序的用户回来查看新内容</li></ul><h1 id="ff30" class="jr js hu bd jt ju jv jw jx jy jz ka kb ja kc jb kd jd ke je kf jg kg jh kh ki dt translated">A/B测试</h1><p id="e29c" class="pw-post-body-paragraph kj kk hu kl b km kn iv ko kp kq iy kr ks kt ku kv kw kx ky kz la lb lc ld le hn dt translated">对于预定通知，我们希望测试不同的消息/布局，以优化它们随时间的有效性。为此，我们希望支持A/B测试作为新系统的一部分(MixPanel<em class="ll">已经支持了)。</em></p><p id="e9a3" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">我们应该能够创建多个变量(每个变量都有一个百分比)，以及一个不会收到任何推送通知的控制组。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff ma"><img src="../Images/4965a5c3183d36d1d10d6b330eea6a6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TzCvvaTbrpr_H5Pi."/></div></div><figcaption class="mf mg fg fe ff mh mi bd b be z ek">A/B test groups are configured in the Lambda function, which can be easily and quickly changed and redeployed, and the changes are source controlled and peer reviewed.</figcaption></figure><h1 id="39ad" class="jr js hu bd jt ju jv jw jx jy jz ka kb ja kc jb kd jd ke je kf jg kg jh kh ki dt translated">监督与无摩擦</h1><p id="fa54" class="pw-post-body-paragraph kj kk hu kl b km kn iv ko kp kq iy kr ks kt ku kv kw kx ky kz la lb lc ld le hn dt translated">对于即席通知，我们不想妨碍营销团队的工作，因此创建即席推送通知的过程应该尽可能无摩擦。然而，我们也不希望营销团队完全在没有监督的情况下运作，并冒着长期损害的风险，向用户发送不想要的推送通知(这可能会导致用户禁用通知，甚至愤怒地退出应用程序)。</p><p id="8e39" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">我们达成的妥协是一个自动化的批准流程，通过该流程:</p><ol class=""><li id="93cc" class="lm ln hu kl b km lg kp lh ks lo kw lp la lq le mj ls lt lu dt translated">营销团队将与BI合作进行查询，以识别用户(例如<em class="ll"> Tinie Tempah </em>的追随者)</li><li id="cbee" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le mj ls lt lu dt translated">填写申请表，通过电子邮件通知指定的批准人</li><li id="5539" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le mj ls lt lu dt translated">审批者可以给自己发送一个测试推送通知，看看它在Android和iOS上的格式如何</li><li id="1dfb" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le mj ls lt lu dt translated">批准者可以批准或拒绝请求</li><li id="b179" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le mj ls lt lu dt translated">一旦获得批准，该请求将被执行</li></ol><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff mk"><img src="../Images/2ff64b3365a0d8cd8eb529270f7ef7ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/0*8NtJo32bPB76bId_."/></div></div><figcaption class="mf mg fg fe ff mh mi bd b be z ek">A simple form to request push notifications to be sent to users identified by the query</figcaption></figure><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff jj"><img src="../Images/12c5ff17b834f844c50f53a28675a77f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ul64iKsHx5ViwQ-4."/></div><figcaption class="mf mg fg fe ff mh mi bd b be z ek">Once your request has been submitted, the requester and the approvers will both receive an email detailing the no. of users selected by the query, the JSON payload, etc. In the email to the approvers, there are also buttons to approve/reject the request, as well as to send the proposed push notification to the approvers so they can see how the message would appear on both Android and iOS devices.</figcaption></figure><h1 id="2f99" class="jr js hu bd jt ju jv jw jx jy jz ka kb ja kc jb kd jd ke je kf jg kg jh kh ki dt translated">履行</h1><p id="45bd" class="pw-post-body-paragraph kj kk hu kl b km kn iv ko kp kq iy kr ks kt ku kv kw kx ky kz la lb lc ld le hn dt translated">我们决定使用<em class="ll"> S3 </em>作为<code class="eh ml mm mn mo b">send-batch-notifications</code>函数的源，因为它允许我们传递大量用户(记住，目标是支持批量向数百万用户发送推送通知),而不必担心分页或有效负载大小的限制。</p><p id="9339" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">该函数可以处理任何格式正确的JSON文件，并且JSON文件可以通过多种方式生成:</p><ul class=""><li id="0531" class="lm ln hu kl b km lg kp lh ks lo kw lp la lq le lr ls lt lu dt translated">由生成计划通知的cron作业执行</li><li id="5165" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">由批准系统在特别推送通知被批准后执行</li><li id="3d06" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">由批准系统向批准者发送测试推送通知(以直观检查消息在Android和iOS设备上的显示方式)</li><li id="6f22" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">当需要人工干预时，由工程团队成员执行</li></ul><p id="0701" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">我们也考虑过将设备注册转移到<em class="ll"> SNS </em>，但是我们决定不这么做，因为它没有提供<em class="ll">足够有用的</em>抽象来证明迁移工作(涉及客户端工作)和<a class="ae lf" href="https://aws.amazon.com/sns/pricing/" rel="noopener ugc nofollow" target="_blank">发送推送通知的额外成本</a>。相反，我们使用<a class="ae lf" href="https://www.npmjs.com/package/node-gcm" rel="noopener ugc nofollow" target="_blank"> node-gcm </a>和<a class="ae lf" href="https://www.npmjs.com/package/apn" rel="noopener ugc nofollow" target="_blank"> apn </a>直接与gcm和apn通信。</p><h1 id="c108" class="jr js hu bd jt ju jv jw jx jy jz ka kb ja kc jb kd jd ke je kf jg kg jh kh ki dt translated">递归函数FTW</h1><p id="83e7" class="pw-post-body-paragraph kj kk hu kl b km kn iv ko kp kq iy kr ks kt ku kv kw kx ky kz la lb lc ld le hn dt translated"><em class="ll"> Lambda </em>有一个5分钟执行时间的硬性限制(在不久的将来可能会放宽)，这可能不足以发送数百万条推送通知。</p><p id="5c22" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">我们处理这种长时间运行任务的方法是将<em class="ll"> Lambda </em>函数写成递归函数。</p><p id="f138" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">一个简单的递归函数将在固定大小的批中处理有效负载，并在每批结束时递归，同时传递一个令牌/位置值，以允许下一次调用从它停止的地方继续。</p><p id="35aa" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">在这种特殊的情况下，我们有额外的考虑，因为工作项的总数可能非常大:</p><ul class=""><li id="0630" class="lm ln hu kl b km lg kp lh ks lo kw lp la lq le lr ls lt lu dt translated">最小化所需递归的数量，这等同于对<em class="ll">λ</em>的<a class="ae lf" href="http://docs.aws.amazon.com/lambda/latest/dg/API_Invoke.html" rel="noopener ugc nofollow" target="_blank">调用</a>请求的数量，并带有<a class="ae lf" href="https://aws.amazon.com/lambda/pricing/#lambda" rel="noopener ugc nofollow" target="_blank">规模成本影响</a></li><li id="a595" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">缓存JSON文件的内容以提高性能(通过避免多次加载和解析大型JSON文件)并降低S3成本</li></ul><p id="89cf" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">为了最小化递归的数量，我们的函数将:</p><ol class=""><li id="98e1" class="lm ln hu kl b km lg kp lh ks lo kw lp la lq le mj ls lt lu dt translated">以500人为一个小批量处理用户列表</li><li id="7665" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le mj ls lt lu dt translated">在每个批处理结束时，调用<code class="eh ml mm mn mo b">context.getRemainingTimeInMillis()</code>来检查这个调用还剩多少时间</li><li id="85f6" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le mj ls lt lu dt translated">如果调用剩余时间超过1分钟，则处理另一个批处理；否则递归</li></ol><p id="6faa" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">当缓存来自<em class="ll"> S3 </em>的JSON文件的内容时，我们还需要比较<em class="ll"> ETAG </em>以确保文件的内容没有改变。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="fe ff ma"><img src="../Images/3e4fbb9e80e0b6756d9062cb57342f12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pIcw44j9O_AfG-Mj."/></div></div></figure><p id="2bbc" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">通过这种设置，系统能够在我们的负载测试期间轻松处理超过100万用户的JSON文件(抱歉，苹果和谷歌发送了所有这些假的设备令牌:-P)。</p></div><div class="ab cl mp mq hc mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="hn ho hp hq hr"><p id="3e1d" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">喜欢您正在阅读的内容，但需要更多帮助？我很乐意作为一名<strong class="kl hv">独立顾问</strong>提供服务，帮助您完成无服务器项目——架构审查、代码审查、构建概念验证，或者提供关于领先实践和工具的建议。</p><p id="e3d4" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">我在<strong class="kl hv">伦敦，英国</strong>，目前唯一在英国的<a class="ae lf" href="https://aws.amazon.com/developer/community/heroes/yan-cui/" rel="noopener ugc nofollow" target="_blank"> <strong class="kl hv"> AWS无服务器英雄</strong> </a>。我有近<strong class="kl hv"> 10年</strong>的<a class="ae lf" href="https://www.linkedin.com/in/theburningmonk/" rel="noopener ugc nofollow" target="_blank">经验</a>在AWS中大规模运行生产工作负载。我主要在英国开展业务，但我愿意出差一周以上。要了解我们如何合作，请在这里告诉我更多关于您试图解决的问题的信息。</p><p id="fa31" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">我还可以举办一个内部研讨会，帮助您的无服务器架构进入生产准备阶段。您可以在这里找到关于为期两天的研讨会<a class="ae lf" href="https://theburningmonk.com/workshops/" rel="noopener ugc nofollow" target="_blank">的更多信息，该研讨会将带您从AWS Lambda的基础知识一直到日志聚合、分发跟踪和安全最佳实践的通用操作模式。</a></p><p id="2399" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">如果你喜欢按照自己的进度学习，那么你也可以找到与我为曼宁制作的<a class="ae lf" href="https://bit.ly/production-ready-serverless" rel="noopener ugc nofollow" target="_blank"> <strong class="kl hv">视频课程</strong> </a>相同的研讨会内容。我们将讨论的主题包括:</p><ul class=""><li id="27e5" class="lm ln hu kl b km lg kp lh ks lo kw lp la lq le lr ls lt lu dt translated">认证<em class="ll"> &amp; </em>授权与API网关<em class="ll"> &amp; </em>认知</li><li id="cb0f" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">本地测试<em class="ll"> &amp; </em>运行功能</li><li id="25ea" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">CI/CD</li><li id="3af2" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">日志聚合</li><li id="649a" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">监控最佳实践</li><li id="8c34" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">X射线分布式跟踪</li><li id="8d1b" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">跟踪相关id</li><li id="880c" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">性能<em class="ll"> &amp; </em>成本优化</li><li id="1377" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">错误处理</li><li id="916b" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">配置管理</li><li id="8f57" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">金丝雀部署</li><li id="5d40" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">VPC</li><li id="908b" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">安全</li><li id="a387" class="lm ln hu kl b km lv kp lw ks lx kw ly la lz le lr ls lt lu dt translated">Lambda、Kinesis和API网关的最佳实践</li></ul><p id="2e68" class="pw-post-body-paragraph kj kk hu kl b km lg iv ko kp lh iy kr ks li ku kv kw lj ky kz la lk lc ld le hn dt translated">代码<strong class="kl hv"> ytcui </strong>也可以获得<strong class="kl hv">票面价格6折优惠</strong>。不过，这个数字只有在我们参加曼宁的早期访问计划(MEAP)时才有效。</p></div></div>    
</body>
</html>