<html>
<head>
<title>React/Redux with Mapbox</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用地图框反应/还原</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/react-redux-with-mapbox-78fa3767211e?source=collection_archive---------8-----------------------#2017-10-11">https://medium.com/hackernoon/react-redux-with-mapbox-78fa3767211e?source=collection_archive---------8-----------------------#2017-10-11</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/9d8098b2f6fb12c18b994c67a234817a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pz6C_MRPW17bpbrk26iY-A.png"/></div></div></figure><blockquote class="jc"><p id="e0db" class="jd je hu bd jf jg jh ji jj jk jl jm ek translated"><em class="jn">想为Mapbox应用程序使用React/Redux，但不确定从哪里开始？请继续阅读！</em></p></blockquote><h2 id="cfed" class="jo jp hu bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl dt translated">动机</h2><p id="1df3" class="pw-post-body-paragraph km kn hu ko b kp kq kr ks kt ku kv kw jz kx ky kz kd la lb lc kh ld le lf jm hn dt translated">我在R&amp;D的建筑和房地产开发领域工作，在<a class="ae lg" href="http://www.ankrommoisan.com" rel="noopener ugc nofollow" target="_blank"> Ankrom Moisan建筑师事务所</a>。这意味着两件事:</p><ol class=""><li id="f6cc" class="lh li hu ko b kp lj kt lk jz ll kd lm kh ln jm lo lp lq lr dt translated">我用地图。很多。我们做的大多数事情都是面向地理空间的。Mapbox在这方面发挥了不可估量的作用。我可以控制地图外观的每一个方面(表现就是一切，尤其是对建筑来说)，当我向它扔进<a class="ae lg" href="https://github.com/mapbox/tippecanoe" rel="noopener ugc nofollow" target="_blank">大量的数据时，它也不会抱怨。</a></li><li id="0f8f" class="lh li hu ko b kp ls kt lt jz lu kd lv kh lw jm lo lp lq lr dt translated">经常需要快速迭代几个复杂的应用，强迫大脑频繁换挡(我也在做<a class="ae lg" href="https://hackernoon.com/tagged/design" rel="noopener ugc nofollow" target="_blank">设计</a>和构造工作)。</li></ol><p id="9243" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated">使用mapbox示例中典型的命令式和过程式技术构建大型应用程序会很快使应用程序流难以理解，状态难以跟踪。第二点成为了这些挑战之上的力量倍增器，减缓了开发，并使错误更有可能发生。</p><p id="bdd3" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated">最终对我来说完美的解决方案是过渡到用<a class="ae lg" href="https://hackernoon.com/tagged/react" rel="noopener ugc nofollow" target="_blank"> React </a>和Redux构建应用程序；但目前还不清楚如何将Mapbox整合到这个框架中。</p><p id="ae89" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated">幸运的是，Mapbox的优秀员工实际上已经考虑了很多，Tom MacWright就这个问题写了一篇非常有用的文章。我觉得让其他地理开发者看看更具体的例子可能会有帮助。因此，我有一个简短的教程:</p><h1 id="682d" class="mc jp hu bd jq md me mf ju mg mh mi jy mj mk ml kc mm mn mo kg mp mq mr kk ms dt translated">构建一个简单的React/Redux/Mapbox应用程序:</h1><p id="8097" class="pw-post-body-paragraph km kn hu ko b kp kq kr ks kt ku kv kw jz kx ky kz kd la lb lc kh ld le lf jm hn dt translated">我最近收集了一个数据集，其中包含了大量关于俄勒冈州波特兰市建筑及其3D几何图形的元数据。我需要构建一个简单的界面，以便用户可以在可视化中切换数据属性，如平方英尺和单位计数。<a class="ae lg" href="http://ryantm.io/buildings" rel="noopener ugc nofollow" target="_blank">你可以在这里看到最终产品。</a></p><p id="c129" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated">整个应用程序非常简单，我已经把它放到了github上。在这篇文章中，我将详细介绍围绕mapbox制作一个灵活的React/Redux包装器所需的步骤。<em class="mt">补充说明:这个例子非常简单，不需要react/redux，但是这个过程可以很好地扩展。</em></p></div><div class="ab cl mu mv hc mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hn ho hp hq hr"><h2 id="37f8" class="jo jp hu bd jq jr nb jt ju jv nc jx jy jz nd kb kc kd ne kf kg kh nf kj kk kl dt translated">样式表</h2><p id="5c6d" class="pw-post-body-paragraph km kn hu ko b kp kq kr ks kt ku kv kw jz kx ky kz kd la lb lc kh ld le lf jm hn dt translated">在我们编码之前，当试图用Mapbox管理应用程序状态时，有一件重要的事情要记住:<strong class="ko hv">地图的样式表是所有事情的唯一来源。</strong>如果您有当前的样式表，您就能确切地知道映射处于什么状态。</p><p id="46db" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated">为了遵循React的声明式编程哲学，我们希望获取样式表并对其进行修改以反映我们想要看到的内容，然后将其交还给地图进行渲染。</p><p id="4361" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated">mapbox本身不接受样式表作为更新。然而，正如他们在上面链接的Tom的帖子中概述的那样，Mapbox开发人员为存在于<a class="ae lg" href="https://github.com/mapbox/mapbox-gl-js/blob/master/src/style-spec/diff.js" rel="noopener ugc nofollow" target="_blank">样式规范github repo </a>中的样式表编写了一个不同的算法。它接受两个样式表，一个表示地图现在的样子，另一个表示您想要的样子，并生成一组命令，将地图从一种样式转换为另一种样式。</p><h2 id="ba02" class="jo jp hu bd jq jr nb jt ju jv nc jx jy jz nd kb kc kd ne kf kg kh nf kj kk kl dt translated">过程</h2><p id="a57d" class="pw-post-body-paragraph km kn hu ko b kp kq kr ks kt ku kv kw jz kx ky kz kd la lb lc kh ld le lf jm hn dt translated">有了这些知识和diffStyles函数，我们可以概括包装Mapbox的过程:</p><ol class=""><li id="4ea8" class="lh li hu ko b kp lj kt lk jz ll kd lm kh ln jm lo lp lq lr dt translated">在React组件中使用mapbox-gl-js创建一个“map”对象。</li><li id="02d0" class="lh li hu ko b kp ls kt lt jz lu kd lv kh lw jm lo lp lq lr dt translated">当map加载后，获取它的样式表对象并将其放入应用程序状态。</li><li id="95d4" class="lh li hu ko b kp ls kt lt jz lu kd lv kh lw jm lo lp lq lr dt translated">当用户交互需要改变样式时，让一个reducer获取一个样式状态的副本，并在其中更改您希望的属性。</li><li id="fb36" class="lh li hu ko b kp ls kt lt jz lu kd lv kh lw jm lo lp lq lr dt translated">对状态树的这一更改将触发一个更新，该更新可以与地图组件中的“componentWillRecieveProps”挂钩。在这个函数中，您可以获取当前样式表和新样式表(来自nextProps)。然后用diffStyles区分两者，并应用更改。</li></ol><p id="5d30" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt ng translated"><span class="l nh ni nj bm nk nl nm nn no di"> 1 </span>我们将从一个组件开始，它只返回一个标识为“map”的空div，就像传统的html一样:</p><figure class="np nq nr ns fq iv"><div class="bz el l di"><div class="nt nu l"/></div></figure><p id="5854" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated">在非react设置中，我们将有一个标识这个div并实例化地图画布的脚本。这也正是我们在这里要做的，但是我们需要确保它在React生命周期中的适当时间发生，所以我们将它放在“componentDidMount”中:</p><figure class="np nq nr ns fq iv"><div class="bz el l di"><div class="nt nu l"/></div></figure><p id="50f1" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt ng translated">现在我们的变量中有了名为“style”的初始样式表，我们需要将它保存到应用程序状态中。</p><blockquote class="nv nw nx"><p id="d211" class="km kn mt ko b kp lj kr ks kt lk kv kw ny lx ky kz nz ly lb lc oa lz le lf jm hn dt translated">首先简单介绍一下这个变量的内容:如果您以前从未真正看过样式表(我没有)，继续在控制台中研究它，您会看到它是一个<em class="hu">深度</em>嵌套的JSON文档，其结构可以根据层顺序和属性选择而变化。</p></blockquote><p id="1577" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated">由于这个原因(以及其他无数的好处)，我非常推荐在存储样式表之前使用Immutable.js来包装它。Immutable有许多方法可以在深度嵌套的对象和列表中找到特定的属性，这将为您节省大量时间。这也会给你信心，只有你想要的东西<strong class="ko hv"><em class="mt"/></strong>改变风格就能做到。</p><p id="27d7" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated">因此，让我们编写一个action和reducer来接收JSON样式表，并将其作为不可变对象保存到应用程序状态:</p><figure class="np nq nr ns fq iv"><div class="bz el l di"><div class="nt nu l"/></div></figure><p id="6a84" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt ng translated">现在让我们假设在一些其他的React组件中，我们有一些按钮，用户可以点击这些按钮来改变控制建筑物颜色的属性。按钮将触发一个名为“CHANGE_VIZ”的动作，有效负载将只是按钮的“value”属性。为了简单起见，我将在这里展示两种情况，用“平方英尺”着色和用“单位数”着色:</p><figure class="np nq nr ns fq iv"><div class="bz el l di"><div class="nt nu l"/></div></figure><p id="bfbc" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt ng translated">太好了，现在Redux包含了一个样式表，显示了我们想要的地图的外观！最后一步是改变当前地图的外观，并应用这些改变。这发生在我们的map React组件的“componentWillRecieveProps”方法中，如下所示:</p><figure class="np nq nr ns fq iv"><div class="bz el l di"><div class="nt nu l"/></div></figure><p id="e1b2" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated">对于奖励积分，我们还可以捕获地图点击事件，并将其作为一个动作发送出去，供您使用！我们只是将它添加到我们的地图组件中的“this.map.on('load'…)”中，我们还将在这里添加用于保存初始样式状态的动作创建器:</p><figure class="np nq nr ns fq iv"><div class="bz el l di"><div class="nt nu l"/></div></figure><p id="e6e1" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated">就是这样！这可以扩展到添加更多的功能(延迟源代码加载，挂钩其他事件，如移动和缩放等)，但这确实是拥有一个非常灵活的React包装器所需要的。与action / reducer / re-render范例相结合，它允许我非常快速地构建接口，我可以在以后轻松地修改这些接口，而不必每次都真正地跟踪所有东西是如何连接在一起的。</p><p id="374e" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated">这样就有更多的时间进行实验和做重要的工作！</p></div><div class="ab cl mu mv hc mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hn ho hp hq hr"><p id="b764" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated">如果你想了解关于reducers、actions和UI的所有内容，完整的项目在github 上。</p><p id="b739" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated">最后，这里是我们完成的ReactMap组件、样式表缩减器和动作创建器:</p><p id="df94" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated"><a class="ae lg" href="https://gist.github.com/McCulloughRT/95ab459cd0a3ffcaf071e6f7de727978" rel="noopener ugc nofollow" target="_blank"> <strong class="ko hv"> ReactMap组件</strong> </a></p><p id="82f2" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated"><a class="ae lg" href="https://gist.github.com/McCulloughRT/9afae4b7aae6e5e6a78e59886426bec8" rel="noopener ugc nofollow" target="_blank"> <strong class="ko hv">样式减速器</strong> </a></p><p id="248c" class="pw-post-body-paragraph km kn hu ko b kp lj kr ks kt lk kv kw jz lx ky kz kd ly lb lc kh lz le lf jm hn dt translated"><a class="ae lg" href="https://gist.github.com/McCulloughRT/2a2bec86c5c2454f5979904f3f2ec3ae" rel="noopener ugc nofollow" target="_blank"> <strong class="ko hv">动作创作者</strong> </a></p><figure class="np nq nr ns fq iv"><div class="bz el l di"><div class="ob nu l"/></div></figure></div></div>    
</body>
</html>