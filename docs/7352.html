<html>
<head>
<title>Serverless Telegram bot on AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Lambda上的无服务器电报机器人</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/serverless-telegram-bot-on-aws-lambda-851204d4236c?source=collection_archive---------0-----------------------#2017-10-25">https://medium.com/hackernoon/serverless-telegram-bot-on-aws-lambda-851204d4236c?source=collection_archive---------0-----------------------#2017-10-25</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/54f929b7d0fcbd686befb5434a264ed2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L3QrTrR1RG-Fq3If5za0cQ.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Serverless Telegram bot on AWS Lambda and Python 3</figcaption></figure><p id="329e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在本文中，我将向您展示如何在用Python 3编写的webhooks上创建简单的echo <a class="ae ke" href="https://hackernoon.com/tagged/telegram" rel="noopener ugc nofollow" target="_blank"> Telegram </a> bot，并使用无服务器框架将其部署到<a class="ae ke" href="https://hackernoon.com/tagged/aws" rel="noopener ugc nofollow" target="_blank"> AWS </a> Lambda。</p><p id="74b0" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我叫Andrii Dvoiak，是preply.com<a class="ae ke" href="https://preply.com/en/" rel="noopener ugc nofollow" target="_blank">公司的团队领导和全栈工程师。</a></p><p id="2d3c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们已经在生产中使用了AWS Lambda，所以我决定展示一下它可以有多简单。放松，坐下来享受。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h2 id="e469" class="km kn hu bd ko kp kq kr ks kt ku kv kw jr kx ky kz jv la lb lc jz ld le lf lg dt translated">这是一个计划</h2><ul class=""><li id="82a6" class="lh li hu ji b jj lj jn lk jr ll jv lm jz ln kd lo lp lq lr dt translated">设置服务器框架</li><li id="dca2" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">获取AWS凭据</li><li id="ff16" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">在Python 3上编写电报机器人的后端</li><li id="b557" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">将后端部署到Lambda</li><li id="5103" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">将你的后端连接到电报机器人</li><li id="c215" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">启动</li></ul><h2 id="2fa9" class="km kn hu bd ko kp kq kr ks kt ku kv kw jr kx ky kz jv la lb lc jz ld le lf lg dt translated">开始之前</h2><p id="6a63" class="pw-post-body-paragraph jg jh hu ji b jj lj jl jm jn lk jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd hn dt translated">为了完成本教程，请确保您已经:</p><ul class=""><li id="2918" class="lh li hu ji b jj jk jn jo jr ma jv mb jz mc kd lo lp lq lr dt translated">已安装Python 3</li><li id="04c8" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">已安装的Node.js <code class="eh md me mf mg b">v6.5.0</code>或更高版本</li><li id="9820" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">拥有管理员权限的AWS帐户(<em class="mh">您可以免费创建一个</em> <a class="ae ke" href="https://portal.aws.amazon.com/gp/aws/developer/registration/index.html" rel="noopener ugc nofollow" target="_blank"> <em class="mh">就在这里</em> </a>)</li></ul><h2 id="b6aa" class="km kn hu bd ko kp kq kr ks kt ku kv kw jr kx ky kz jv la lb lc jz ld le lf lg dt translated">步骤1:无服务器框架</h2><p id="24d4" class="pw-post-body-paragraph jg jh hu ji b jj lj jl jm jn lk jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd hn dt translated">让我们从头开始。为了轻松编写和部署我们的lambda，我们将使用这个名为<a class="ae ke" href="https://serverless.com" rel="noopener ugc nofollow" target="_blank">无服务器</a>的令人敬畏的框架。它写在NodeJS上，所以我们需要<code class="eh md me mf mg b">npm</code>来安装它。我们走吧:</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="6744" class="km kn hu mg b fv mq mr l ms mt">npm install -g serverless</span></pre><p id="83b2" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">之后，让我们从模板创建一个新项目:</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="dfbd" class="km kn hu mg b fv mq mr l ms mt">serverless create --template aws-python3 --path my-telegram-bot</span></pre><p id="4920" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">它将创建一个包含两个文件的新文件夹<em class="mh"> my-telegram-bot </em>:</p><ol class=""><li id="5265" class="lh li hu ji b jj jk jn jo jr ma jv mb jz mc kd mu lp lq lr dt translated"><em class="mh">handler . py</em>—Python代码的模板</li><li id="9ac7" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd mu lp lq lr dt translated"><em class="mh"> serverless.yml </em> —配置文件</li></ol><h2 id="3533" class="km kn hu bd ko kp kq kr ks kt ku kv kw jr kx ky kz jv la lb lc jz ld le lf lg dt translated">步骤2: AWS凭证</h2><p id="7fde" class="pw-post-body-paragraph jg jh hu ji b jj lj jl jm jn lk jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd hn dt translated">这是这个过程中最好的部分，因为一旦你获得了证书，你就再也不用和AWS打交道了。这非常简单:</p><ul class=""><li id="d6f6" class="lh li hu ji b jj jk jn jo jr ma jv mb jz mc kd lo lp lq lr dt translated">登录到您的AWS控制台，转到我的安全凭证&gt;用户，然后单击“添加用户”蓝色按钮。</li><li id="426d" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">指定用户名(类似“无服务器管理”)并只选择“编程访问”复选框。</li><li id="bf84" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">在第二页上，选择“直接附加现有策略”并查找“管理员访问”。</li><li id="e85e" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd lo lp lq lr dt translated">创建用户后，复制您的“访问密钥ID”和“秘密访问密钥”。这才是你真正需要继续下去的。</li></ul><p id="ccdc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">恭喜你。你已经拿到钥匙了。打开您的终端并执行:</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="ddbd" class="km kn hu mg b fv mq mr l ms mt">export AWS_ACCESS_KEY_ID=&lt;Access key ID&gt;</span><span id="bbc9" class="km kn hu mg b fv mv mr l ms mt">export AWS_SECRET_ACCESS_KEY=&lt;Secret access key&gt;</span></pre><h2 id="1610" class="km kn hu bd ko kp kq kr ks kt ku kv kw jr kx ky kz jv la lb lc jz ld le lf lg dt translated">第三步:在Python 3上编写电报机器人</h2><p id="86b5" class="pw-post-body-paragraph jg jh hu ji b jj lj jl jm jn lk jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd hn dt translated">我不打算教你如何用Python编写，所以只需复制这段代码并粘贴到您的`<em class="mh"> handler.py </em>'文件中:</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="aa00" class="km kn hu mg b fv mq mr l ms mt"><strong class="mg hv">import </strong>json<br/><strong class="mg hv">import </strong>os<br/><strong class="mg hv">import </strong>sys</span><span id="bcd1" class="km kn hu mg b fv mv mr l ms mt">here = os.path.dirname(os.path.realpath(__file__))<br/>sys.path.append(os.path.join(here, "./vendored"))<br/><br/><strong class="mg hv">import </strong>requests<br/><br/>TOKEN = os.environ['TELEGRAM_TOKEN']<br/>BASE_URL = "https://api.telegram.org/bot{}".format(TOKEN)<br/><br/><br/><strong class="mg hv">def hello</strong>(event, context):<br/>    <strong class="mg hv">try</strong>:<br/>        data = json.loads(event["body"])<br/>        message = str(data["message"]["text"])<br/>        chat_id = data["message"]["chat"]["id"]<br/>        first_name = data["message"]["chat"]["first_name"]<br/><br/>        response = "Please /start, {}".format(first_name)<br/><br/>        <strong class="mg hv">if </strong>"start" <strong class="mg hv">in </strong>message:<br/>            response = "Hello {}".format(first_name)<br/><br/>        data = {"text": response.encode("utf8"), "chat_id": chat_id}<br/>        url = BASE_URL + "/sendMessage"<br/>        requests.post(url, data)<br/><br/>    <strong class="mg hv">except </strong>Exception <strong class="mg hv">as </strong>e:<br/>        <strong class="mg hv">print</strong>(e)<br/><br/>    <strong class="mg hv">return </strong>{"statusCode": 200}</span></pre><p id="f0aa" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如果你够懒，就从我的GitHub <a class="ae ke" href="https://github.com/Andrii-D/serverless-telegram-bot" rel="noopener ugc nofollow" target="_blank"> repo </a>中派生或克隆它。</p><p id="c468" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">此外，您需要创建一个只有一行的文件<code class="eh md me mf mg b">requirements.txt</code>:“requests ”,并执行以下命令在本地安装它:</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="ca2d" class="km kn hu mg b fv mq mr l ms mt">pip install -r requirements.txt -t vendored</span></pre><h2 id="178c" class="km kn hu bd ko kp kq kr ks kt ku kv kw jr kx ky kz jv la lb lc jz ld le lf lg dt translated">步骤4:部署到AWS Lambda</h2><p id="19ed" class="pw-post-body-paragraph jg jh hu ji b jj lj jl jm jn lk jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd hn dt translated">就像在Heroku上一样，你只需要一个配置文件“serverless.yml”。继续编辑您的，使它看起来像这样:</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="b1d2" class="km kn hu mg b fv mq mr l ms mt"><strong class="mg hv">service: </strong>my-telegram-bot<br/><br/><strong class="mg hv">provider:<br/>  name: </strong>aws<br/>  <strong class="mg hv">runtime: </strong>python3.6<br/>  <strong class="mg hv">stage: </strong>dev<br/>  <strong class="mg hv">region: </strong>us-east-1<br/>  <strong class="mg hv">environment:<br/>    TELEGRAM_TOKEN: </strong>${env:TELEGRAM_TOKEN}<br/><br/><br/><br/><strong class="mg hv">functions:<br/>  post:<br/>    handler: </strong>handler.hello<br/>    <strong class="mg hv">events:<br/>      </strong>- <strong class="mg hv">http:<br/>          path: </strong>my-custom-url<br/>          <strong class="mg hv">method: </strong>post<br/>          <strong class="mg hv">cors: </strong>true</span></pre><p id="271d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">当您在终端中执行这个命令时，神奇的事情发生了:</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="c44c" class="km kn hu mg b fv mq mr l ms mt">serverless deploy</span></pre><p id="58f9" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">它会把你所有的文件打包到。zip存档并上传到AWS，然后它将为您创建AWS API网关并返回API端点。您将收到类似这样的内容:</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="b56e" class="km kn hu mg b fv mq mr l ms mt">endpoints:</span><span id="8c79" class="km kn hu mg b fv mv mr l ms mt">POST - https://u3ir5tjcsf.execute-api.us-east-1.amazonaws.com/dev/my-custom-url</span></pre><p id="a47c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">你的机器人的无服务器后端已经可以使用了。在下一步中，您将需要此URL。</p><h2 id="e6ea" class="km kn hu bd ko kp kq kr ks kt ku kv kw jr kx ky kz jv la lb lc jz ld le lf lg dt translated">第五步:连接你的后端到电报机器人</h2><p id="8c3d" class="pw-post-body-paragraph jg jh hu ji b jj lj jl jm jn lk jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd hn dt translated">让我们创建新的电报机器人，当然，使用另一个机器人。去web.telegram.org的<a class="ae ke" href="https://web.telegram.org" rel="noopener ugc nofollow" target="_blank">给这个家伙</a><a class="ae ke" href="https://web.telegram.org/#/im?p=@BotFather" rel="noopener ugc nofollow" target="_blank"> @BotFather </a>写信。他会指导你完成整个过程，你会得到这样的结果:</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="efa8" class="km kn hu mg b fv mq mr l ms mt">Use this token to access the HTTP API:<br/>459903168:APHruyw7ZFj5qOJmJGeYEmfFJxil-z5uLS8</span></pre><p id="95e7" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">首先，将其设置为您的环境变量:</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="f85d" class="km kn hu mg b fv mq mr l ms mt">export TELEGRAM_TOKEN="<!-- -->459903168:APHruyw7ZFj5qOJmJGeYEmfFJxil-z5uLS8<!-- -->"</span></pre><p id="1992" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然后，我们需要设置webhook(注册你后端的API url)。为此，您需要发送这个有效载荷:</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="54c0" class="km kn hu mg b fv mq mr l ms mt">{<br/>    "url": "&lt;Your API Gateway endpoint&gt;"<br/>}</span></pre><p id="2000" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">到此url:</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="04d8" class="km kn hu mg b fv mq mr l ms mt">https://api.telegram.org/bot&lt;Your Telegram TOKEN&gt;/setWebhook</span></pre><p id="cb23" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">再次转到您的终端，执行以下代码行(输入您的url和令牌):</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="896d" class="km kn hu mg b fv mq mr l ms mt">curl --request POST --url <a class="ae ke" href="https://api.telegram.org/botAPHruyw7ZFj5qOJmJGeYEmfFJxil-z5uLS8/setWebhook" rel="noopener ugc nofollow" target="_blank">https://api.telegram.org/bot</a>459903168:<a class="ae ke" href="https://api.telegram.org/botAPHruyw7ZFj5qOJmJGeYEmfFJxil-z5uLS8/setWebhook" rel="noopener ugc nofollow" target="_blank">APHruyw7ZFj5qOJmJGeYEmfFJxil-z5uLS8</a><a class="ae ke" href="https://api.telegram.org/botAPHruyw7ZFj5qOJmJGeYEmfFJxil-z5uLS8/setWebhook" rel="noopener ugc nofollow" target="_blank">/setWebhook</a> --header 'content-type: application/json' --data '{"url": "https://u3ir5tjcsf.execute-api.us-east-1.amazonaws.com/dev/my-custom-url"}'</span></pre><p id="a4b4" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如果你做的一切都是正确的，你会收到这样的东西:</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="62b5" class="km kn hu mg b fv mq mr l ms mt">{<br/>  "ok": true,<br/>  "result": true,<br/>  "description": "Webhook was set"<br/>}</span></pre><h2 id="aeb4" class="km kn hu bd ko kp kq kr ks kt ku kv kw jr kx ky kz jv la lb lc jz ld le lf lg dt translated">第六步:上线</h2><p id="3823" class="pw-post-body-paragraph jg jh hu ji b jj lj jl jm jn lk jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd hn dt translated">我们差不多完成了，让我们再部署一次，将您的秘密电报令牌传播到lambda:</p><pre class="mi mj mk ml fq mm mg mn mo aw mp dt"><span id="8dbf" class="km kn hu mg b fv mq mr l ms mt">serverless deploy</span></pre><p id="b434" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">现在直播了！恭喜你。你可以开始和你的机器人聊天了。</p><h2 id="3dc0" class="km kn hu bd ko kp kq kr ks kt ku kv kw jr kx ky kz jv la lb lc jz ld le lf lg dt translated">附言</h2><ol class=""><li id="7677" class="lh li hu ji b jj lj jn lk jr ll jv lm jz ln kd mu lp lq lr dt translated">不要忘记将所有导出的变量保存在<code class="eh md me mf mg b">~/.bash_profile</code>中</li><li id="2dac" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd mu lp lq lr dt translated">永远不要将任何api密钥提交到您的存储库中</li><li id="9228" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd mu lp lq lr dt translated">开始时，它不会花费你什么，因为AWS Lambda有每月100，00 0次调用的免费层，API Gateway每月免费给你1百万次API调用</li><li id="fa26" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd mu lp lq lr dt translated">您可以从GitHub <a class="ae ke" href="https://github.com/Andrii-D/serverless-telegram-bot" rel="noopener ugc nofollow" target="_blank">库</a>派生这个例子</li><li id="8ea4" class="lh li hu ji b jj ls jn lt jr lu jv lv jz lw kd mu lp lq lr dt translated">你可以在这里找到lambdas <a class="ae ke" href="https://github.com/serverless/examples" rel="noopener ugc nofollow" target="_blank">的很多例子</a></li></ol><h2 id="de0d" class="km kn hu bd ko kp kq kr ks kt ku kv kw jr kx ky kz jv la lb lc jz ld le lf lg dt translated">结论</h2><p id="edf5" class="pw-post-body-paragraph jg jh hu ji b jj lj jl jm jn lk jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd hn dt translated">无服务器方法在某些情况下非常方便，因为它允许您构建非常可伸缩的解决方案。它还会改变您对服务器管理和付费的思维模式。</p><p id="0de6" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">无服务器框架为您提供了非常简单的工具来部署您的功能，无需了解AWS或任何其他云提供商。</p><p id="f159" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">AWS给你很好的免费服务期，所以你可以完全免费建立你的MVP，只有当你达到一定数量的用户时才开始付费。</p><h2 id="1c02" class="km kn hu bd ko kp kq kr ks kt ku kv kw jr kx ky kz jv la lb lc jz ld le lf lg dt translated">下一步是什么</h2><p id="abe6" class="pw-post-body-paragraph jg jh hu ji b jj lj jl jm jn lk jp jq jr lx jt ju jv ly jx jy jz lz kb kc kd hn dt translated">下一篇文章将讲述如何使用AWS Step函数链接多个lambdas，并将其连接到AWS DynamoDB。</p><figure class="mi mj mk ml fq iv"><div class="bz el l di"><div class="mw mx l"/></div></figure></div></div>    
</body>
</html>