<html>
<head>
<title>Replicating data from Hacker News (Firebase) to RethinkDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将数据从Hacker News (Firebase)复制到RethinkDB</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/replicating-data-from-hacker-news-firebase-to-rethinkdb-8e62a3848863?source=collection_archive---------7-----------------------#2017-03-08">https://medium.com/hackernoon/replicating-data-from-hacker-news-firebase-to-rethinkdb-8e62a3848863?source=collection_archive---------7-----------------------#2017-03-08</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/1b85a2e63ffb4b2f1af01f88d870b8ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RghQ3ZiYBI1jbGfpXHXsfw.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Image courtesy of the <a class="ae jg" href="https://www.amon.cx/blog/rethinkdb-reviewed-by-a-mongo-fan/" rel="noopener ugc nofollow" target="_blank">amon.cx</a> blog</figcaption></figure><p id="e1bc" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">几天前，我<a class="ae jg" href="https://hackernoon.com/tophn-a-fun-side-project-built-with-vue-js-and-rethinkdb-f22159641c1b#.7rb5gidmh" rel="noopener ugc nofollow" target="_blank">发布了我的有趣的兼职项目</a>，叫做<a class="ae jg" href="https://tophn.info" rel="noopener ugc nofollow" target="_blank">拓丰</a>。基本上，实时显示<a class="ae jg" href="https://news.ycombinator.com/" rel="noopener ugc nofollow" target="_blank">黑客新闻</a>头条新闻。事实证明，这篇文章在黑客社区中非常受欢迎，我收到了大量关于它的消息和推文，要求我扩展我的项目。</p><p id="526f" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">嗯，我非常乐意这样做，所以我想我会再发表两到三篇博文，深入研究代码和我是如何构建我的项目的。</p><h1 id="8f7d" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">组件</h1><p id="6a09" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">我的TopHN项目基本上有两个主要部分，实际上，它们运行在两个独立的虚拟服务器上。一台服务器基本上是我的RethinkDB服务器，我在Digital Ocean每月10美元的运行Ubuntu Linux的VPS上安装了它。该服务器还运行一个简短的(~100行)<a class="ae jg" href="https://hackernoon.com/tagged/nodejs" rel="noopener ugc nofollow" target="_blank"> Node.js </a>应用程序，它纯粹用于从黑客新闻Firebase feed中读取数据，并将一个复制副本存储在<a class="ae jg" href="https://hackernoon.com/tagged/rethinkdb" rel="noopener ugc nofollow" target="_blank"> RethinkDB </a>中。</p><p id="cfd1" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">另一个服务器是“表示层”，也运行一个小的Node.js应用程序，该应用程序用于提供网站的首页，并实时监听RethinkDB服务器，并将更改的信息推送到连接的web浏览器。</p><p id="b2cf" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">今天，我想谈谈托管我的RethinkDB数据库的第一台服务器，以及从黑客新闻获取数据的“feeder”node . js应用程序。</p><h1 id="c385" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">安装RethinkDB</h1><p id="0d1e" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">我不会在这里过多地讨论实际的安装步骤，因为在RethinkDB网站上已经有了<a class="ae jg" href="https://rethinkdb.com/docs/install/ubuntu/" rel="noopener ugc nofollow" target="_blank">很棒的说明。基本上，一旦设置了Digital Ocean(或任何其他Linux VPS ),您只需获得root控制台访问权限，并按照RethinkDB站点上的逐步说明进行设置和运行。这真的很简单，这也是我在这个项目中使用这个数据库的原因之一。</a></p><p id="5342" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">一旦安装并启动了RethinkDB服务器，您就可以访问控制面板，方法是</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="6214" class="lr kg hu ln b fv ls lt l lu lv">http://&lt;your VPS IP Address&gt;:8081</span></pre><p id="8cf1" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">提示:我会在反向代理后面保护这个管理门户，并设置管理员密码，这样互联网上发现您的RethinkDB服务器的人就不能登录并操纵您的数据。再次，优秀的<a class="ae jg" href="https://rethinkdb.com/docs/security/" rel="noopener ugc nofollow" target="_blank">这样做的指示是在他们的网站</a>。我强烈建议你在继续之前这样做，但是如果时间紧迫，你可以继续这篇文章中的指导，稍后再回到这个话题。</p><h1 id="e140" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">设置数据表</h1><p id="9037" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">有几种方法可以做到这一点，通过代码，或在管理控制台中手动完成。我将在控制台中完成它，因为这确实是一个“一次性”的练习，并且节省了几行以后可能会使人迷惑的代码。</p><p id="2b91" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在管理控制台中点击顶部的'<strong class="jj hv"> <em class="lw">表</em> </strong>'菜单，然后点击'<strong class="jj hv"> <em class="lw"> +添加数据库</em> </strong>'。给数据库一个名称。对于黑客新闻数据，我将把它称为<strong class="jj hv"> hn_data </strong>，但是你可以把它称为任何你想要的东西(只要你在代码的后面记住它)。</p><p id="00ef" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">创建空数据库后，点击几次'<strong class="jj hv"> <em class="lw"> +添加表格</em> </strong>'并创建三个表格，名称为:</p><p id="75b0" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv"> hn_feed </strong> —这将包含文章和评论的实际feed。</p><p id="0db1" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">hn_lists  —这将包含最新的“热门故事”、“最佳故事”、“问问hn”、“乔布斯”等列表。黑客新闻的故事。</p><p id="0d82" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv"> hn_users </strong> —这将包含从黑客新闻中读取的用户资料。</p><figure class="li lj lk ll fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lx"><img src="../Images/f6d861e3eebd974c349e948a60de383f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*68wEe7mFaVIrZE-8NtR4Hg.png"/></div></div></figure><p id="dcb2" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在不需要用数据填充这些表——在未来的步骤中，我们可以用纯代码来完成。</p><h1 id="fe96" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">创建RethinkDB用户</h1><p id="dfb9" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">在我们继续深入之前，我们需要为RethinkDB创建一个唯一的用户，该用户将对我们刚刚创建的数据库具有读/写访问权限。这是我们稍后将从Node.js应用程序调用的用户，用于将黑客新闻数据推送到我们的数据库中。</p><p id="f0dd" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">最好不要使用默认的admin用户，而是创建一个只能访问这个数据库的新用户。这样，如果用户名被泄露，您可以轻松地更改他们的密码来再次保护您的提要。</p><p id="6327" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">要创建用户，我们可以在RethinkDB控制台中使用ReQL查询。点击顶部的'<strong class="jj hv"> <em class="lw">'数据浏览器</em> </strong>'菜单选项，并输入以下ReQL命令:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="7f12" class="lr kg hu ln b fv ls lt l lu lv">r.db('rethinkdb').table('users').insert({id: 'hnfeeder', password: 'verysecretpassword'})</span></pre><figure class="li lj lk ll fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ly"><img src="../Images/c96e0d280292890c2c0678bdf63b0f1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iC1cx6DIkkBfbSWLL-TpCQ.png"/></div></div></figure><p id="aee0" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在你输入这个命令后，不要忘记点击<em class="lw"> Run </em>来执行它。并且不要忘记用你自己选择的来替换<code class="eh lz ma mb ln b">id</code>和<code class="eh lz ma mb ln b">password</code>(并且记住它们以备后用)。</p><p id="1ae8" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">接下来，我们想给这个新用户对我们刚刚创建的<strong class="jj hv"> hn_data </strong>表的完全读/写权限，使用下面的ReQL命令:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="5ce0" class="lr kg hu ln b fv ls lt l lu lv">r.db('hn_data').grant('hnfeeder', {read: <strong class="ln hv">true</strong>, write: <strong class="ln hv">true</strong>, config: <strong class="ln hv">true</strong>});</span></pre><p id="39a4" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">不要忘记再次点击<em class="lw">运行</em>。现在，您的用户<code class="eh lz ma mb ln b">hnfeeder</code>拥有了数据库中的读、写和配置权限。配置权限基本上意味着创建新表等的能力。，所以你现在可以把它保留为<code class="eh lz ma mb ln b">false</code>,因为我们目前不会通过应用程序做任何类似的事情。</p><p id="bd35" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这就是数据库控制台目前的基本情况。</p><h1 id="ab5e" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">安装Node.js</h1><p id="2595" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">在这篇文章中，数字海洋实际上有一些关于在Ubuntu上安装Node.js的很好的说明。遵循它一步一步地达到最佳效果，然后再回到这篇文章。</p><p id="9435" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这里我们唯一需要添加的是这个项目需要的节点模块。只有两个—(a)RethinkDB模块和(Firebase模块。</p><p id="10d2" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">首先，切换到您将创建实际应用程序的文件夹。我只是在<code class="eh lz ma mb ln b">/root</code>创建了我的，但是为了更安全，你可能想在<code class="eh lz ma mb ln b">/var/app</code>或者类似的地方创建它。现在让我们继续关注<code class="eh lz ma mb ln b">/root</code>:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="77c1" class="lr kg hu ln b fv ls lt l lu lv">cd /root</span><span id="1d8f" class="lr kg hu ln b fv mc lt l lu lv">npm install --save rethinkdb firebase</span></pre><h1 id="d095" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">创建应用程序</h1><p id="e459" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">现在我们已经准备好创建Node.js应用程序本身了。在<code class="eh lz ma mb ln b">/root</code>文件夹中(或者你将要创建应用的任何地方)，创建一个名为<code class="eh lz ma mb ln b">feeder.js</code>的文件，使用你最喜欢的编辑器，输入(或者复制粘贴)以下代码:</p><figure class="li lj lk ll fq iv"><div class="bz el l di"><div class="md me l"/></div></figure><p id="05c8" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">让我们仔细阅读这段代码，看看发生了什么。</p><p id="7eb2" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">前两行只是激活我们之前安装的节点模块。</p><p id="5622" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">第4到7行启动了到Hacker News API的Firebase连接。你可以把<code class="eh lz ma mb ln b">appName</code>设置成你喜欢的任何值，但是<code class="eh lz ma mb ln b">databaseURL</code>必须保持原样。</p><p id="6df1" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">第9行只是将存储在<code class="eh lz ma mb ln b">rdbconn</code>中的RethinkDB连接的占位符。稍后，在整个应用程序中，我们会使用它与我们的RethinkDB服务器进行对话。</p><p id="eaf6" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">第11到14行启动到我们的RethinkDB服务器的链接。记住将<code class="eh lz ma mb ln b">host</code>、<code class="eh lz ma mb ln b">user</code>和<code class="eh lz ma mb ln b">password</code>替换为之前设置的值。如果您在安装RethinkDB的同一台服务器上运行这个应用程序(就像我们一样)，那么<code class="eh lz ma mb ln b">host</code>可以简单地使用值<code class="eh lz ma mb ln b">localhost</code>。</p><p id="8313" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这是所有的初步连接的东西了。现在我们开始了解应用程序的本质。</p><p id="a8ba" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">第16到23行是我们为HN API设置各种Firebase提要的引用的地方。我们需要为我们想要的每个单独的提要设置一个<em class="lw">引用</em>。关于提要位置的更多信息在<a class="ae jg" href="https://github.com/HackerNews/API" rel="noopener ugc nofollow" target="_blank">黑客新闻API文档</a>网站上，但是基本上，他们发布的每个提要都有一个唯一的端点。</p><p id="74b8" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">例如，在<code class="eh lz ma mb ln b">/v0/newstories</code>发布“新故事”提要等。</p><p id="73bc" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在我们的示例中，我们实际上只设置了新的故事提要，但是如果您需要额外的内容，只需添加带有您需要/想要的独特提要端点的额外行。</p><p id="347b" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">第23行非常重要。这是一个来自Firebase/HN的特别供稿，包含了自上次推送更新以来发生变化的故事、评论和用户列表。此<em class="lw">更新</em>进给每隔20秒左右推出一次。你可以想象，黑客新闻的活跃程度，这个<em class="lw">更新</em> feed的每次推送可以包含数百个已经更改的文章&amp;评论id，以及几十个已经更改的用户配置文件。</p><p id="bd4d" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这是我们将主要收听的提要，以便了解黑客新闻的新内容，并相应地更新我们的本地数据库。</p><p id="5e99" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">第26到43行是<code class="eh lz ma mb ln b">pullUser()</code>函数。这是我们调用的函数，使用用户ID从Firebase读取单个用户，然后将其插入到我们的本地数据库中。我们为我上面提到的更新提要中推送给我们的每个用户ID调用这个函数。</p><p id="cfeb" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这里的第28行调用了Firebase <code class="eh lz ma mb ln b">once()</code>函数，只读取一次特定的用户ID。如果成功找到用户，那么第31行执行一个<code class="eh lz ma mb ln b">insert()</code>调用，将其保存到本地数据库中的<strong class="jj hv"> hn_users </strong>表中。注意这个命令中的<code class="eh lz ma mb ln b">{conflict: "update"}</code>限定符。这基本上意味着，如果数据库中不存在记录，那么创建它，但是如果用户ID已经存在，那么更新现有的记录，而不是抛出错误。它本质上是一个“<em class="lw"> insert或update if exists </em>”命令，使事情变得如此容易管理，这也是我喜欢RethinkDB的原因之一。</p><p id="9105" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">该功能的其余部分基本上是内务处理，输出一个带有已添加或更新的用户ID的<em class="lw"> console.log </em>消息。</p><p id="ed2e" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">第46到67行是<code class="eh lz ma mb ln b">pullItem()</code>函数，它与<code class="eh lz ma mb ln b">pullUser()</code>函数完全相同，只是针对黑客新闻文章和评论。注意:文章和评论在HN存储在同一个表中)。</p><figure class="li lj lk ll fq iv fe ff paragraph-image"><div class="fe ff mf"><img src="../Images/3e48ce5a41d0901b767323af44f691a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:520/format:webp/1*WPCv7UYWaNb05d6BzAzyZg.png"/></div></figure><p id="a76c" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">此时您可能会想——为什么我们在保存到本地数据库时不保存或映射单个字段呢？这个问题其实很容易回答。Firebase以JSON结构的形式返回数据，而RethinkDB作为一个NoSQL系统，希望数据以JSON结构的形式发送给它。</p><p id="8544" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">所以真的没有额外的操作要做。我们只是将Firebase返回给我们的JSON数据直接传递给RethinkDB。所有字段及其值都“按原样”发送。</p><p id="7499" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">70号线到82号线是整个app最忙的线。这是等待从Firebase推送更新事件的函数。<code class="eh lz ma mb ln b">on("value" ...)</code>函数基本上是一个等待来自Firebase值变化事件，然后运行的函数。</p><p id="8035" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">该函数检查两个数组的传入更新。<code class="eh lz ma mb ln b">items[]</code>数组包含已经更改的文章和评论id的列表，而<code class="eh lz ma mb ln b">users[]</code>数组包含已经更改的用户id的列表。我们简单地遍历这些数组，然后调用<code class="eh lz ma mb ln b">pullItem()</code>和<code class="eh lz ma mb ln b">pullUser()</code>来读取单个的id并将它们导入到我们的本地数据库中。</p><p id="cb29" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">第87到93行类似，但是是一个<code class="eh lz ma mb ln b">on("value" ...)</code>函数，它监听从Firebase推出的一系列新故事。我们在这里所做的就是获取新故事id的数组，并将它们保存到<strong class="jj hv"> hn_lists </strong>数据库中以备后用。</p><p id="4bd8" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">重要提示:您需要为每个想要保存数据的提要设置一个单独的监听器函数。基本上，对于您之前在应用程序中设置的每个<em class="lw">引用</em>(第17行到第23行)，您需要针对该引用创建一个<code class="eh lz ma mb ln b">on("value ...)</code>函数来读取和处理数据。</p><p id="c875" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">就是这样！一个只有100行左右的简短应用程序，但它做了很多。让我们运行它。保存文件并返回命令行，键入:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="bc69" class="lr kg hu ln b fv ls lt l lu lv">node feeder.js</span></pre><p id="3a43" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您应该会看到控制台消息，显示正在传输的用户、文章和评论。</p><p id="034a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果您仍然在浏览器中打开RethinkDB控制台窗口，您应该会看到每隔15到20秒就会出现一次活动图峰值，因为从Firebase推送的数据流被读取和保存。</p><p id="24ea" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">提示:您现在可以将Node.js应用程序设置为作为服务运行，这样即使您的服务器重新启动，它也会自动启动并运行。在Node.js上将PM2设置为<a class="ae jg" href="https://www.digitalocean.com/community/tutorials/how-to-use-pm2-to-setup-a-node-js-production-environment-on-an-ubuntu-vps" rel="noopener ugc nofollow" target="_blank">作为服务运行的详细信息在本详细的数字海洋指南</a>中。</p><p id="cb94" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">一旦你做到了这一点，你就可以“启动并忘记”你的feed刷新服务器。注意:随着时间的推移，您的RethinkDB将被填满，因此请确保您的虚拟服务器有足够的磁盘空间。您可能希望将RethinkDB数据指向一个单独的块存储设备。我发现我的数据库每天至少增加100–150 MB。大约每10天就有1000MB的数据！</p><h1 id="5931" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">检查数据</h1><p id="cf71" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">你可能会有点怀疑一切都在正常运行，我不怪你。这一切似乎很容易，不是吗？；)</p><p id="148a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">嗯，有一个简单的方法来检查发生了什么，这是通过RethinkDB控制台中的<em class="lw">数据浏览器</em>选项卡。您可以运行简单的ReQL查询来检查这些表。例如，要从feeds表中读取前40条左右的记录，可以运行以下命令:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="b044" class="lr kg hu ln b fv ls lt l lu lv">r.db('hn_data').table('hn_feed')</span></pre><p id="3e9c" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这将向您显示如下内容:</p><figure class="li lj lk ll fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mg"><img src="../Images/be40a50cff72a4859179645e5990e4e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ksIU56xDh1fn6ssE6UQujg.png"/></div></div></figure><p id="e1ba" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">您甚至可以进行一些有趣的查询，比如通过查询以下内容，按日期倒序返回最后10篇文章:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="2d99" class="lr kg hu ln b fv ls lt l lu lv">r.db('hn_data').table('hn_feed').orderBy({index: r.desc('time')}).limit(10)</span></pre><p id="326d" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">(注意:为了有效地工作，您必须在RethinkDB的<code class="eh lz ma mb ln b">time</code>列中创建一个二级索引)。您可以通过以下命令直接在ReQL中创建一个二级索引:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="0ccb" class="lr kg hu ln b fv ls lt l lu lv">r.db('hn_data').table('hn_feed').indexCreate('time')</span></pre><p id="7fdb" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">请耐心等待——完全索引该表可能需要几分钟的时间(您可以从仪表板上查看重新索引的进度),但之后，上面排序的ReQL查询应该会工作。</p><h1 id="5e68" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">结论</h1><p id="271c" class="pw-post-body-paragraph jh ji hu jj b jk ld jm jn jo le jq jr js lf ju jv jw lg jy jz ka lh kc kd ke hn dt translated">就是这样！您现在有了一个完全正常工作的RethinkDB服务器，它正忙于半实时地复制来自Hacker News的数据。我将发布的下一篇文章将讨论我们实际上如何处理这些数据，即使用<a class="ae jg" href="https://vuejs.org/" rel="noopener ugc nofollow" target="_blank"> Vue.js </a>作为前端框架在实时网页中显示这些数据。到时候见！</p><div class="li lj lk ll fq ab cb"><figure class="mh iv mi mj mk ml mm paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mh iv mi mj mk ml mm paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mh iv mi mj mk ml mm paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mn mo mp"><p id="f922" class="jh ji lw jj b jk jl jm jn jo jp jq jr mq jt ju jv mr jx jy jz ms kb kc kd ke hn dt translated"><a class="ae jg" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客们下午的开始。我们是<a class="ae jg" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jg" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jg" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jh ji lw jj b jk jl jm jn jo jp jq jr mq jt ju jv mr jx jy jz ms kb kc kd ke hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jg" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jg" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="li lj lk ll fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mt"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="li lj lk ll fq iv"><div class="bz el l di"><div class="mu me l"/></div></figure></div></div>    
</body>
</html>