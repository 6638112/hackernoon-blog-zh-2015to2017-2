<html>
<head>
<title>Writing a Blog Engine in Phoenix and Elixir: Part 7, Adding Comments Support</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Phoenix和Elixir编写博客引擎:第7部分，添加评论支持</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/writing-a-blog-engine-in-phoenix-and-elixir-part-7-adding-comments-support-7dfc17dd474e?source=collection_archive---------3-----------------------#2016-02-04">https://medium.com/hackernoon/writing-a-blog-engine-in-phoenix-and-elixir-part-7-adding-comments-support-7dfc17dd474e?source=collection_archive---------3-----------------------#2016-02-04</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/8243876914060b794b5c1e5175b13470.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T6HPJU_hlrypOL9GqZUdCg.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Let me tell you what I thought of that last post of yours!</figcaption></figure><p id="9204" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">最新更新</strong>:2016年8月2日</p><h2 id="571e" class="ke kf hu bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">本系列的前一篇文章</h2><div class="kz la fm fo lb lc"><a rel="noopener follow" target="_blank" href="/@diamondgfx/writing-a-blog-engine-in-phoenix-and-elixir-part-5-markdown-support-fde72badd8e1"><div class="ld ab ej"><div class="le ab lf cl cj lg"><h2 class="bd hv fv z el lh eo ep li er et ht dt translated">用Phoenix和Elixir编写博客引擎:第6部分，降价支持</h2><div class="lj l"><h3 class="bd b fv z el lh eo ep li er et ek translated">最新更新:2016年8月2日</h3></div><div class="lk l"><p class="bd b gc z el lh eo ep li er et ek translated">medium.com</p></div></div><div class="ll l"><div class="lm l ln lo lp ll lq ja lc"/></div></div></a></div><h2 id="73b4" class="ke kf hu bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">当前版本</h2><ul class=""><li id="d2c0" class="lr ls hu ji b jj lt jn lu jr lv jv lw jz lx kd ly lz ma mb dt translated"><strong class="ji hv">仙丹</strong> : v1.3.1</li><li id="4a40" class="lr ls hu ji b jj mc jn md jr me jv mf jz mg kd ly lz ma mb dt translated"><strong class="ji hv">凤凰:</strong> v1.2.0</li><li id="62e0" class="lr ls hu ji b jj mc jn md jr me jv mf jz mg kd ly lz ma mb dt translated"><strong class="ji hv"> Ecto: </strong> v2.0.2</li></ul><h2 id="bdd1" class="ke kf hu bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">我们离开的地方</h2><p id="429d" class="pw-post-body-paragraph jg jh hu ji b jj lt jl jm jn lu jp jq jr mh jt ju jv mi jx jy jz mj kb kc kd hn dt translated">我们的博客应用程序现在支持使用一个漂亮的小markdown编辑器来使我们的帖子更加漂亮，所以它真的开始看起来像一个功能齐全的项目了！然而，我们没有的一件事是，我们写的任何帖子都无法获得任何形式的反馈。好消息是，这是一个非常简单的东西添加，只是建立在我们已经建立了大量的关联工作！</p><p id="3013" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们将从这个简单的初始方法开始。我们不会担心要求用户注册；相反，我们将有新的评论被添加到“待定”状态。评论不会显示在帖子上，除非它们已经被批准脱离待定状态，除非访问我们博客的用户勾选了“显示未批准”按钮。</p><h2 id="554b" class="ke kf hu bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">添加我们的评论模型</h2><p id="e70f" class="pw-post-body-paragraph jg jh hu ji b jj lt jl jm jn lu jp jq jr mh jt ju jv mi jx jy jz mj kb kc kd hn dt translated">让我们首先为我们的评论添加一个模型。我们希望收到以下评论:</p><ul class=""><li id="42b7" class="lr ls hu ji b jj jk jn jo jr mk jv ml jz mm kd ly lz ma mb dt translated">作者(我们将使用字符串)</li><li id="3693" class="lr ls hu ji b jj mc jn md jr me jv mf jz mg kd ly lz ma mb dt translated">正文(我们将为此使用文本)</li><li id="1785" class="lr ls hu ji b jj mc jn md jr me jv mf jz mg kd ly lz ma mb dt translated">批准标志(我们将使用布尔值，默认为false)</li><li id="84f2" class="lr ls hu ji b jj mc jn md jr me jv mf jz mg kd ly lz ma mb dt translated">评论所针对的帖子(我们将使用引用)</li></ul><p id="7e79" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们不想创建完整的模板套件和所有东西，所以我们将坚持使用<strong class="ji hv"> mix phoenix.gen.model </strong>来实现这一点。</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="5828" class="ke kf hu ms b fv mw mx l my mz">mix phoenix.gen.model Comment comments author:string body:text approved:boolean post_id:references:posts</span></pre><p id="ca8d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然后我们将迁移我们的数据库:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="5ddd" class="ke kf hu ms b fv mw mx l my mz">mix ecto.migrate</span></pre><h2 id="8451" class="ke kf hu bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">将评论与帖子相关联</h2><p id="398b" class="pw-post-body-paragraph jg jh hu ji b jj lt jl jm jn lu jp jq jr mh jt ju jv mi jx jy jz mj kb kc kd hn dt translated">如果你打开<strong class="ji hv"> web/models/comment.ex </strong>你可以看到评论现在已经与帖子相关联，但是我们没有做任何事情来反向设置。</p><p id="1cea" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在<strong class="ji hv"> web/models/post.ex </strong>中，将以下内容添加到您的“posts”模式定义中:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="9860" class="ke kf hu ms b fv mw mx l my mz">has_many :comments, Pxblog.Comment</span></pre><p id="e7a7" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">现在，为了确保一切如我们预期的那样工作，运行<strong class="ji hv">混合测试</strong>以验证一切仍然是绿色的(应该是在这一点上)！现在让我们稍微修改一下我们的测试，这样我们就可以测试文章和评论之间的关联。</p><p id="3fb1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">首先打开<strong class="ji hv">test/support/factory . ex</strong>添加一个注释工厂。将以下内容与我们的别名声明一起添加到顶部:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="148e" class="ke kf hu ms b fv mw mx l my mz">alias Pxblog.Comment</span></pre><p id="c7b5" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">并在项目底部添加以下内容:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="1dce" class="ke kf hu ms b fv mw mx l my mz">def comment_factory do<br/>  %Comment{<br/>    author: "Test User",<br/>    body: "This is a sample comment",<br/>    approved: false,<br/>    post: build(:post)<br/>  }<br/>end</span></pre><p id="b796" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">因此，我们需要添加一些测试来利用这个新工厂。打开<strong class="ji hv">test/models/comment _ test . exs</strong>并将以下内容添加到文件中:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="6abb" class="ke kf hu ms b fv mw mx l my mz">import Pxblog.Factory</span><span id="dd22" class="ke kf hu ms b fv na mx l my mz"># ...</span><span id="dee1" class="ke kf hu ms b fv na mx l my mz">test "creates a comment associated with a post" do<br/>  comment = insert(:comment)<br/>  assert comment.post_id<br/>end</span></pre><p id="f71d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">再次运行我们的测试，我们应该保持绿色！</p><h2 id="2b17" class="ke kf hu bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">添加我们的路线以供评论</h2><p id="f9d4" class="pw-post-body-paragraph jg jh hu ji b jj lt jl jm jn lu jp jq jr mh jt ju jv mi jx jy jz mj kb kc kd hn dt translated">我们将从设置初始路线开始，我们将使用这些路线来征求意见，这将有助于我们创建各种初始技术设计。打开<strong class="ji hv"> web/router.ex </strong>:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="68f7" class="ke kf hu ms b fv mw mx l my mz">resources "/posts", PostController, only: [] do<br/>  resources "/comments", CommentController, only: [:create, :delete, :update]<br/>end</span></pre><p id="b3a0" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">评论只在文章的上下文中有意义，所以我们将把评论嵌套在文章下面。然而，在其他路由中，我们已经定义了嵌套在users下的Posts资源！我们不想公开一堆仅发布的路由，所以我们使用仅<strong class="ji hv">:[]</strong>代码来锁定任何根级别的发布路由。然后我们添加评论资源，但是现在，我们只允许<strong class="ji hv">:创建</strong>、<strong class="ji hv">:删除</strong>，以及<strong class="ji hv">:更新</strong>。“创建”将是匿名用户用来创建评论(最初未被批准)的工具。删除将用于帖子的作者或管理员删除帖子，而更新将用于允许管理员或作者将评论更新为已批准，以便公众可以看到。</p><h2 id="92b4" class="ke kf hu bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">添加我们的注释控制器和视图</h2><p id="9b90" class="pw-post-body-paragraph jg jh hu ji b jj lt jl jm jn lu jp jq jr mh jt ju jv mi jx jy jz mj kb kc kd hn dt translated">既然我们的模型已经设置好了，我们需要构建一个带有几个动作的控制器。大多数显示/查看评论将通过Posts控制器，但我们需要能够及时从这个控制器中删除/更新/创建评论。我们将从创建<strong class="ji hv">web/controllers/comment _ controller . ex</strong>开始:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="9aa5" class="ke kf hu ms b fv mw mx l my mz">defmodule Pxblog.CommentController do<br/>  use Pxblog.Web, :controller<br/>end</span></pre><p id="f10f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们还将创建一个视图来让菲尼克斯满意。创建<strong class="ji hv">web/views/comment _ view . ex</strong>:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="d4a2" class="ke kf hu ms b fv mw mx l my mz">defmodule Pxblog.CommentView do<br/>  use Pxblog.Web, :view<br/>end</span></pre><p id="83a9" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">现在我们回到控制器，从我们三个动作的基本结构开始，<strong class="ji hv">创建</strong>、<strong class="ji hv">更新</strong>和<strong class="ji hv">删除</strong>。</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="0df6" class="ke kf hu ms b fv mw mx l my mz">def create(conn, _), do: conn<br/>def update(conn, _), do: conn<br/>def delete(conn, _), do: conn</span></pre><p id="0da8" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">接下来，我们需要一个评论表单模板，可以在Show Post页面上使用。创建一个新目录供我们使用:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="daa7" class="ke kf hu ms b fv mw mx l my mz">$ mkdir web/templates/comment</span></pre><h2 id="1af0" class="ke kf hu bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">允许用户发表评论</h2><p id="3ebc" class="pw-post-body-paragraph jg jh hu ji b jj lt jl jm jn lu jp jq jr mh jt ju jv mi jx jy jz mj kb kc kd hn dt translated">我们将从创建<strong class="ji hv">web/templates/comment/form . html . eex</strong>开始:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="f035" class="ke kf hu ms b fv mw mx l my mz">&lt;%= form_for @changeset, @action, fn f -&gt; %&gt;<br/>  &lt;%= if @changeset.action do %&gt;<br/>    &lt;div class="alert alert-danger"&gt;<br/>      &lt;p&gt;Oops, something went wrong! Please check the errors below.&lt;/p&gt;<br/>    &lt;/div&gt;<br/>  &lt;% end %&gt;</span><span id="76c6" class="ke kf hu ms b fv na mx l my mz">  &lt;div class="form-group"&gt;<br/>    &lt;%= label f, :author, class: "control-label" %&gt;<br/>    &lt;%= text_input f, :author, class: "form-control" %&gt;<br/>    &lt;%= error_tag f, :author %&gt;<br/>  &lt;/div&gt;</span><span id="b0fc" class="ke kf hu ms b fv na mx l my mz">  &lt;div class="form-group"&gt;<br/>    &lt;%= label f, :body, class: "control-label" %&gt;<br/>    &lt;%= textarea f, :body, class: "form-control", id: "body-editor" %&gt;<br/>    &lt;%= error_tag f, :body %&gt;<br/>  &lt;/div&gt;</span><span id="7d62" class="ke kf hu ms b fv na mx l my mz">  &lt;div class="form-group"&gt;<br/>    &lt;%= submit "Submit", class: "btn btn-primary" %&gt;<br/>  &lt;/div&gt;<br/>&lt;% end %&gt;</span></pre><p id="2587" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">很标准的形式，所以我们不需要讨论太多。现在让我们前往展示帖子模板<strong class="ji hv">web/templates/post/show . html . eex</strong>，在这里我们将添加对评论表单的引用。请注意，在上面的模板中，我们定义了<strong class="ji hv"> @changeset </strong>和<strong class="ji hv"> @action </strong>，所以我们稍后需要循环回到<strong class="ji hv">web/controllers/post _ controller . ex</strong>。</p><p id="545e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">现在，让我们继续使用<strong class="ji hv">web/templates/post/show . html . eex</strong>。在帖子的属性列表后，添加以下行:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="8d1b" class="ke kf hu ms b fv mw mx l my mz">&lt;%= render Pxblog.CommentView, "form.html", changeset: @comment_changeset, action: post_comment_path(@conn, :create, @post) %&gt;</span></pre><p id="24f8" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们需要在我们的<strong class="ji hv"> CommentView </strong>视图中引用“form.html”呈现，所以我们将它指定为“render”调用的第一个参数。我们需要给它传递一个<strong class="ji hv"> @comment_changeset </strong>(我们还没有设置，但是很快就会设置)和一个action，评论应该发布到这个action。</p><p id="efce" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">现在我们将前往<strong class="ji hv">web/controllers/post _ controller . ex</strong>以使其全部工作。您需要更改“show”函数，如下所示:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="77eb" class="ke kf hu ms b fv mw mx l my mz">def show(conn, %{"id" =&gt; id}) do<br/>  post = Repo.get!(assoc(conn.assigns[:user], :posts), id)<br/>  comment_changeset = post<br/>    |&gt; build_assoc(:comments)<br/>    |&gt; Pxblog.Comment.changeset()<br/>  render(conn, "show.html", post: post, comment_changeset: comment_changeset)<br/>end</span></pre><p id="6238" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">现在让我们回到我们的comment controller(<strong class="ji hv">web/controllers/comment _ controller . ex</strong>)并进一步充实create函数。对于一个标准的create函数，我们需要在顶部添加一些东西，所以我们将从在顶部添加以下内容开始(就在我们的函数之前):</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="508c" class="ke kf hu ms b fv mw mx l my mz">alias Pxblog.Comment<br/>alias Pxblog.Post</span><span id="4693" class="ke kf hu ms b fv na mx l my mz">plug :scrub_params, "comment" when action in [:create, :update]</span></pre><p id="5983" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们在scrub_params调用中包含了“update ”,因为我们以后无论如何都需要它。现在，我们将跳到create函数，并用以下内容替换它:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="e9bd" class="ke kf hu ms b fv mw mx l my mz">def create(conn, %{"comment" =&gt; comment_params, "post_id" =&gt; post_id}) do<br/>  post      = Repo.get!(Post, post_id) |&gt; Repo.preload([:user, :comments])<br/>  changeset = post<br/>    |&gt; build_assoc(:comments)<br/>    |&gt; Comment.changeset(comment_params)</span><span id="f9d2" class="ke kf hu ms b fv na mx l my mz">  case Repo.insert(changeset) do<br/>    {:ok, _comment} -&gt;<br/>      conn<br/>      |&gt; put_flash(:info, "Comment created successfully!")<br/>      |&gt; redirect(to: user_post_path(conn, :show, post.user, post))<br/>    {:error, changeset} -&gt;<br/>      render(conn, Pxblog.PostView, "show.html", post: post, user: post.user, comment_changeset: changeset)<br/>  end<br/>end</span></pre><p id="1f39" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">首先，我们只想在获得comment params和post_id后尝试创建一个注释，因为没有这两个参数，我们就无法创建新的注释。接下来，我们获取相关的帖子(记住预加载用户和评论，因为我们的模板将开始引用这两者！)并开始创建新的关联变更集。我们从post开始，通过管道将它发送到<strong class="ji hv"> build_assoc </strong>，后者通过原子指定关联来构建关联模式。在这种情况下，我们想要构建一个关联的<strong class="ji hv">评论</strong>。然后，我们将它通过管道传输到Comment.changeset函数中，并使用我们模式匹配的comment_params。除了一个例外，其余的都是正常的:</p><p id="4886" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">错误情况有点复杂，因为我们再次尝试使用另一个视图的渲染。我们首先传递连接，然后使用合适的视图(<strong class="ji hv"> Pxblog)。在我们的例子中是PostView </strong>，我们想要呈现的模板，然后由于该模板使用了<strong class="ji hv"> @post </strong>、<strong class="ji hv"> @user </strong>和<strong class="ji hv"> @comment_changeset </strong>，我们需要提供这三个。现在您可以测试它了:如果它发布了错误，您将在页面上看到评论的错误列表。如果它发布没有错误，你会得到一个蓝色的闪光消息在顶部！进步很大！</p><h2 id="4d5d" class="ke kf hu bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">向我们的帖子添加评论显示</h2><p id="48b7" class="pw-post-body-paragraph jg jh hu ji b jj lt jl jm jn lu jp jq jr mh jt ju jv mi jx jy jz mj kb kc kd hn dt translated">接下来，我们需要创建它，这样我们就可以实际看到模板上的帖子。我们将创建一个共享模板，如果我们希望在其他地方显示不同内容的评论，可以使用该模板，因此我们将创建<strong class="ji hv">web/templates/comment/comment . html . eex</strong>并用以下内容填充它:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="ef85" class="ke kf hu ms b fv mw mx l my mz">&lt;div class="comment"&gt;<br/>  &lt;div class="row"&gt;<br/>    &lt;div class="col-xs-4"&gt;<br/>      &lt;strong&gt;&lt;%= @comment.author %&gt;&lt;/strong&gt;<br/>    &lt;/div&gt;<br/>    &lt;div class="col-xs-4"&gt;<br/>      &lt;em&gt;&lt;%= @comment.inserted_at %&gt;&lt;/em&gt;<br/>    &lt;/div&gt;<br/>    &lt;div class="col-xs-4 text-right"&gt;<br/>      &lt;%= unless @comment.approved do %&gt;<br/>        &lt;button class="btn btn-xs btn-primary approve"&gt;Approve&lt;/button&gt;<br/>      &lt;% end %&gt;<br/>      &lt;button class="btn btn-xs btn-danger delete"&gt;Delete&lt;/button&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>  &lt;div class="row"&gt;<br/>    &lt;div class="col-xs-12"&gt;<br/>      &lt;%= @comment.body %&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/div&gt;</span></pre><p id="4659" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这里不多解释了。批准/删除按钮尚未连接；我们将在本系列的下一篇教程中解决这个问题。我们还需要修改控制器来预加载评论，并修改帖子的显示模板来包含评论列表。首先，我们将处理控制器更新。在<strong class="ji hv">web/controllers/post _ controller . ex</strong>中，在<strong class="ji hv"> show </strong>函数中，我们将在获取帖子的行中添加一行(我已将新行加粗):</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="54c3" class="ke kf hu ms b fv mw mx l my mz">post = Repo.get!(assoc(conn.assigns[:user], :posts), id)<br/><strong class="ms hv">  |&gt; Repo.preload(:comments)</strong></span></pre><p id="98db" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这只是确保我们的评论作为帖子的一部分被加载。最后，我们将打开<strong class="ji hv">web/templates/post/show . html . eex</strong>，并添加模板中显示评论的部分:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="3cf0" class="ke kf hu ms b fv mw mx l my mz">&lt;div class="comments"&gt;<br/> &lt;h2&gt;Comments&lt;/h2&gt;<br/> &lt;%= for comment &lt;- @post.comments do %&gt;<br/>   &lt;%= render Pxblog.CommentView, "comment.html", comment: comment %&gt;<br/> &lt;% end %&gt;<br/>&lt;/div&gt;</span></pre><h2 id="1ae4" class="ke kf hu bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">添加用于注释的控制器测试</h2><p id="07b7" class="pw-post-body-paragraph jg jh hu ji b jj lt jl jm jn lu jp jq jr mh jt ju jv mi jx jy jz mj kb kc kd hn dt translated">我们还不能离开，因为我们还有一些条件没有通过测试！我们应该涵盖控制器的创建功能，我们将坚持一个积极的情况和一个消极的情况，因为这些是我们的代码将通过的路径。</p><p id="6208" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">创建<strong class="ji hv">test/controllers/comment _ controller _ test . exs</strong>，让我们开始吧:</p><pre class="mn mo mp mq fq mr ms mt mu aw mv dt"><span id="08c2" class="ke kf hu ms b fv mw mx l my mz">defmodule Pxblog.CommentControllerTest do<br/>  use Pxblog.ConnCase</span><span id="c4f9" class="ke kf hu ms b fv na mx l my mz">  import Pxblog.Factory</span><span id="789d" class="ke kf hu ms b fv na mx l my mz">  @valid_attrs %{author: "Some Person", body: "This is a sample comment"}<br/>  @invalid_attrs %{}</span><span id="6116" class="ke kf hu ms b fv na mx l my mz">  setup do<br/>    user = insert(:user)<br/>    post = insert(:post, user: user)</span><span id="75af" class="ke kf hu ms b fv na mx l my mz">    {:ok, conn: build_conn(), user: user, post: post}<br/>  end</span><span id="2f91" class="ke kf hu ms b fv na mx l my mz">  test "creates resource and redirects when data is valid", %{conn: conn, post: post} do<br/>    conn = post conn, post_comment_path(conn, :create, post), comment: @valid_attrs<br/>    assert redirected_to(conn) == user_post_path(conn, :show, post.user, post)<br/>    assert Repo.get_by(assoc(post, :comments), @valid_attrs)<br/>  end</span><span id="d20f" class="ke kf hu ms b fv na mx l my mz">  test "does not create resource and renders errors when data is invalid", %{conn: conn, post: post} do<br/>    conn = post conn, post_comment_path(conn, :create, post), comment: @invalid_attrs<br/>    assert html_response(conn, 200) =~ "Oops, something went wrong"<br/>  end<br/>end</span></pre><p id="d956" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们将继续使用Pxblog。工厂，因为它是如此方便。我们还将设置两个模块变量，<strong class="ji hv"> @valid_attrs </strong>和<strong class="ji hv"> @invalid_attrs </strong>，就像我们在其他地方做的一样。我们还创建了一个设置块，它将设置一个默认用户和post，供我们用来创建评论。</p><p id="a8b2" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">接下来，我们将创建我们的正面测试用例。我们发布到具有有效属性的嵌套post-&gt;comment路径，断言我们按照预期被重定向，并且评论是为该帖子创建的！</p><p id="ad14" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">最后，我们将做同样的事情，但是使用无效的数据，并验证当一些东西没有通过验证时，我们得到了HTML中出现的“哎呀，出问题了”消息！搞定了。</p><figure class="mn mo mp mq fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nb"><img src="../Images/980476f33b43465efe7afefc18df3302.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ba_eO77PVf_CYPApJcLq9Q.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Our current UI!</figcaption></figure><h2 id="4dcf" class="ke kf hu bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">后续步骤</h2><p id="9558" class="pw-post-body-paragraph jg jh hu ji b jj lt jl jm jn lu jp jq jr mh jt ju jv mi jx jy jz mj kb kc kd hn dt translated">我们的评论有很好的基础，但我们肯定可以进一步改进。例如，我们仍然不能批准或删除评论，我们还将获取帖子的每一条评论。在接下来的几篇文章中，我们将在把我们的评论系统变成一个由凤凰频道支持的实时评论系统之前，对其进行进一步的改进。</p><p id="b7bd" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">2016年2月29日更新:</strong>显然，我完全忽略了将评论添加到帖子实际显示中的部分！我已经更新了这个帖子，现在可以正确地反映这些变化了:)谢谢<a class="nc nd gr" href="https://medium.com/u/fea9fa4f2f7d?source=post_page-----7dfc17dd474e--------------------------------" rel="noopener" target="_blank">安德鲁·奔驰</a>！</p><h2 id="b5f4" class="ke kf hu bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky dt translated">本系列的下一篇文章</h2><div class="kz la fm fo lb lc"><a rel="noopener follow" target="_blank" href="/elixir-magic/writing-a-blog-engine-in-phoenix-and-elixir-part-8-finishing-comments-30ff95d44cea"><div class="ld ab ej"><div class="le ab lf cl cj lg"><h2 class="bd hv fv z el lh eo ep li er et ht dt translated">用Phoenix和Elixir编写博客引擎:第8部分，结束评论</h2><div class="lj l"><h3 class="bd b fv z el lh eo ep li er et ek translated">最新更新:2016年8月2日</h3></div><div class="lk l"><p class="bd b gc z el lh eo ep li er et ek translated">medium.com</p></div></div><div class="ll l"><div class="ne l ln lo lp ll lq ja lc"/></div></div></a></div><h1 id="800a" class="nf kf hu bd kg ng nh ni kk nj nk nl ko nm nn no kr np nq nr ku ns nt nu kx nv dt translated">看看我的新书！</h1><p id="8477" class="pw-post-body-paragraph jg jh hu ji b jj lt jl jm jn lu jp jq jr mh jt ju jv mi jx jy jz mj kb kc kd hn dt translated">嘿大家好！如果你喜欢你在这里读到的东西，并且想和我一起学习更多，可以看看我的新书《长生不老药和凤凰网开发》:</p><div class="kz la fm fo lb lc"><a href="https://www.packtpub.com/web-development/phoenix-web-development" rel="noopener  ugc nofollow" target="_blank"><div class="ld ab ej"><div class="le ab lf cl cj lg"><h2 class="bd hv fv z el lh eo ep li er et ht dt translated">凤凰网开发| PACKT图书</h2><div class="lj l"><h3 class="bd b fv z el lh eo ep li er et ek translated">学习使用Elixir和……从头开始构建投票web应用程序的高性能功能原型</h3></div><div class="lk l"><p class="bd b gc z el lh eo ep li er et ek translated">www.packtpub.com</p></div></div><div class="ll l"><div class="nw l ln lo lp ll lq ja lc"/></div></div></a></div><p id="1687" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我真的很兴奋终于可以把这个项目推向世界了！它的写作风格与我的其他教程一样，我们将从头到尾构建一个完整项目的框架，甚至涵盖一些更棘手的主题，如文件上传、Twitter/Google OAuth登录和API！</p><div class="mn mo mp mq fq ab cb"><figure class="nx iv ny nz oa ob oc paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="nx iv ny nz oa ob oc paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="nx iv ny nz oa ob oc paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="od oe of"><p id="f922" class="jg jh og ji b jj jk jl jm jn jo jp jq oh js jt ju oi jw jx jy oj ka kb kc kd hn dt translated"><a class="ae ok" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ok" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ok" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae ok" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jg jh og ji b jj jk jl jm jn jo jp jq oh js jt ju oi jw jx jy oj ka kb kc kd hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ok" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ok" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="mn mo mp mq fq iv fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff ol"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure></div></div>    
</body>
</html>