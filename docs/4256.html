<html>
<head>
<title>The Hydra Bug: Part I</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">九头蛇Bug:第一部分</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/the-hydra-bug-e4d3af2d61c0?source=collection_archive---------6-----------------------#2017-05-21">https://medium.com/hackernoon/the-hydra-bug-e4d3af2d61c0?source=collection_archive---------6-----------------------#2017-05-21</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div class="fe ff hs"><img src="../Images/74c04a68ce56873317483760c75a8a5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:928/1*zN0_CPZDqawHmGg5z8Biew.gif"/></div><figcaption class="hz ia fg fe ff ib ic bd b be z ek">Image copyright <a class="ae id" href="https://www.flickr.com/photos/andrew_jian" rel="noopener ugc nofollow" target="_blank">Andrew Jian</a> <a class="ae id" href="https://creativecommons.org/licenses/by/2.0/" rel="noopener ugc nofollow" target="_blank">CC-BY</a></figcaption></figure><div class=""/><div class=""><h2 id="5f17" class="pw-subtitle-paragraph jd if ig bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju ek translated">一夜平分使一个坚强的人变得谦卑</h2></div><p id="f0e7" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><a class="ae id" rel="noopener" href="/@vishvananda/the-hydra-bug-4a9ceb208436">介绍</a>解释了我如何设法让一个虚拟机使用虚函数在iSCSI上引导。一切似乎都很顺利，但是当我尝试完整的linux操作系统时，我发现了一个严重的问题。请继续阅读《九头蛇的发现》。</p></div><div class="ab cl kr ks hc kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hn ho hp hq hr"><p id="3734" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我有一个基于busybox的linux的工作启动，但是我需要尝试一个完整的linux操作系统。我拿起一个我知道能在真实硬件上与iSCSI一起工作的Oracle Linux，创建一个新的iSCSI LUN，并尝试引导它。</p><p id="0600" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">几秒钟之内，我兴奋地看到grub出现在我的虚拟控制台上。屏息静气，我等待着美丽的登录屏幕迎接我。我等啊，等啊，等啊…除了闪烁的光标什么也没有。起初，我怀疑镜像已经损坏，但是在真实硬件上从目标引导测试工作正常。</p><p id="f3d1" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我怀疑它在将iSCSI卷从iPXE传递到内核时遇到了某种问题。我在内核命令行中添加了各种调试选项，以查看在引导过程的早期可能会发生什么。还是一无所获。</p><p id="766b" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">无奈之下，我尝试early_printk=console。最后，一些文字！我从BIOS中看到关于内存分配的日志，一些关于ACPI启动的消息，然后是同样闪烁的光标。</p><p id="e958" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我尝试了内核命令行选项来关闭ACPI并禁用早期引导过程的其他部分，但似乎没有什么帮助。会不会是iPXE中的另一个错误导致了这个问题？回到git-平分。</p><p id="da7c" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我必须做的第一件事是找到一个有效的提交。我切换回虚拟模式，并验证它是否挂起。然后我从ipxe-roms包中尝试旧的iPXE版本。令人惊讶的是，它有效。</p><p id="fe16" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">几个小时的平分和测试之后，我发现了导致挂起的<a class="ae id" href="https://github.com/ipxe/ipxe/commit/5350b65a3ce727f20e9d9fa7b9c2c0af52cfb7bd" rel="noopener ugc nofollow" target="_blank">提交</a>。我检查了之前的提交并运行了虚函数的构建…失败。原来，中断提交是在我的网卡的驱动程序支持被添加之前。幸运的是，提交是关于改变压缩的，我认为我可以很容易地恢复它。我切换回最近的提交，添加一个损坏的恢复，并生成一个新的构建。</p><p id="a7e1" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">兴高采烈，确信我有一个解决方案在手，我开机…看到同样邪恶的闪烁光标。得意/泄气/g .我一定错过了什么！我反复检查我的构建和命令行选项。我切换回虚拟世界。没有骰子。恢复提交并不能解决问题。一定有另一个更近的提交导致了相同的挂起。时间不早了，但我烦得睡不着。我检查出有问题的提交，在它后面添加一个revert，并在它上面重新设置所有新提交的基础。然后我又把它一分为二。</p><p id="c256" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我很快找到了导致问题的第二个提交，它也是旧的。现在我有两个回复，光标仍然困扰着我。似乎每次我恢复一个提交，我都会找到另一个来代替它。显然，这种虫子就像九头蛇:每次我砍掉一个头，就会有一个新的代替它。</p><p id="a62d" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">接下来是整个晚上的二等分、重新基础化和测试。当太阳升起的时候，我有5个不同的提交，都导致了同样的问题。我有一个工作构建，有一大堆随机的恢复和重置。这个建筑完全无法维护。为了有机会维护它，我必须把所有的回复都放在树的顶端。不幸的是，它们都被最近的提交所改变，所以我不得不手工重写所有的回复，希望我没有破坏任何东西。</p><p id="3e87" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">此外，警钟长鸣。事情很可疑。5个完全不相关的提交怎么会导致同一个bug？其中一个<a class="ae id" href="https://github.com/ipxe/ipxe/commit/9aa8090d069eb0b36769f33544faf0e7e429e844" rel="noopener ugc nofollow" target="_blank">提交</a>只是给一个函数调用增加了一个额外的参数。这怎么会破坏内核启动呢？我决定制作一个最简单的工作版本和不完整版本的例子，看看有什么不同。</p><p id="910a" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我启动时启用了early_printk，无论有没有上面的提交。我对输出进行了比较，发现两次运行之间的差别非常小。在引导过程的早期，内核记录bios报告的空闲内存范围:</p><pre class="ky kz la lb fq lc ld le lf aw lg dt"><span id="a2b4" class="lh li ig ld b fv lj lk l ll lm">e820: BIOS-provided physical RAM map:<br/>BIOS-e820: [mem 0x0000000000000000–0x000000000009c3ff] usable<br/>BIOS-e820: [mem 0x00000000000f0000–0x00000000000fffff] reserved<br/>BIOS-e820: [mem 0x0000000000100000–0x000000007fef6fff] usable<br/>BIOS-e820: [mem 0x000000007ff95000–0x000000007ffdffff] usable</span></pre><p id="2a77" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">虚拟机分配了2G内存。请注意2G末尾附近的小间隙，据报告它是可用的。挂起的引导程序报告较少的可用内存。测试了各种版本后，我把它缩小到109页(4K)。如果有超过108页的空闲空间，内核就会启动。差距小一点就挂了。这似乎意味着内核正在重写iPXE的一些重要部分。</p></div><div class="ab cl kr ks hc kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hn ho hp hq hr"><h2 id="e48e" class="lh li ig bd ln lo lp lq lr ls lt lu lv ke lw lx ly ki lz ma mb km mc md me mf dt translated">简介:BIOS e820例程</h2><p id="e93e" class="pw-post-body-paragraph jv jw ig jx b jy mg jh ka kb mh jk kd ke mi kg kh ki mj kk kl km mk ko kp kq hn dt translated">BIOS使用了早期引导过程中的一些内存。如果引导装载程序或内核用自己的数据覆盖了BIOS的大部分，一切都会变得混乱，所以BIOS有一个接口，内核可以询问它正在使用什么内存。</p><p id="96ac" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">为了与BIOS通信，它将e820放在AX寄存器中，调用INT 15，BIOS给内核一个已用内存的映射。iPXE代码用自己的代码替换bios中断处理程序，并将自己添加到内存映射中。这样做的结果是，更大的iPXE版本将在内存映射中报告更多的保留内存。</p></div><div class="ab cl kr ks hc kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hn ho hp hq hr"><p id="c8df" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">不同数量的保留内存解释了多个修补程序如何会导致相同的问题。任何使iPXE二进制文件变得更大的改变都可能将差距缩小到要求的109页以下。不幸的是，它并没有真正告诉我们为什么这个差距的大小很重要。iPXE似乎正确地报告了保留的内存，所以内核不应该覆盖它。也许内核不尊重保留空间？事实上，一些日志在启动后显示内核使用了不应该使用的空间:</p><pre class="ky kz la lb fq lc ld le lf aw lg dt"><span id="7a40" class="lh li ig ld b fv lj lk l ll lm">No NUMA configuration found<br/>Faking a node at [mem 0x0000000000000000–0x000000007ffdffff]<br/>Initmem setup node 0 [mem 0x00000000–0x7ffdffff]<br/>NODE_DATA [mem 0x7ffb9000–0x7ffdffff]</span></pre><p id="eb68" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">节点存储器的开头(0x7ffb9000)与iPXE(结束于0x7ff95000)重叠。我们发现了一个内核错误吗？我的Oracle linux映像有一个旧的、修改过的内核(UEK，一个添加了dtrace和其他特性的3.8内核)，所以我的第一步是查看这个问题是否仍然存在于一个新的内核中。尝试标准的Oracle linux(基于3.10)内核在启动时打印相同的分配信息，但是，您瞧，它通过了挂起，并一直显示到登录提示符。</p><p id="d825" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我尝试了一个新的UEK(基于4.1)，它很好。我找到一个fedora 3.8内核，它也可以启动。看来，无论出了什么问题，都是这个老UEK特有的。此时，我有一个选择。我可以开始尝试调试这个特定的内核，或者尝试在iPXE端解决这个bug。如果我在iPXE之后在内存中保留这108页(或者更少，当前版本只保留75页)会怎么样？它只有400K的内存。今天，这只是沧海一粟。</p><p id="bb2d" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">对iPXE的修改很简单:</p><pre class="ky kz la lb fq lc ld le lf aw lg dt"><span id="55e5" class="lh li ig ld b fv lj lk l ll lm">--- a/src/arch/x86/interface/pcbios/hidemem.c<br/>+++ b/src/arch/x86/interface/pcbios/hidemem.c<br/>@@ -37,3 +37,3 @@ FILE_LICENCE ( GPL2_OR_LATER_OR_UBDL );<br/>/** Alignment for hidden memory regions */<br/>-#define ALIGN_HIDDEN 4096 /* 4kB page alignment should be enough */<br/>+#define ALIGN_HIDDEN 0x80000</span></pre><p id="d85b" class="pw-post-body-paragraph jv jw ig jx b jy jz jh ka kb kc jk kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">最后一次构建，瞧，内核启动得很好。我仍然想找到这个bug，但是我有更紧急的事情，所以只能等了(直到<a class="ae id" rel="noopener" href="/@vishvananda/the-hydra-bug-1e71347d6759">第三部分</a>)。你看，虚拟机工作完全正常，但如果我重新启动它，iPXE无法iSCSI启动。我的工作还没完成。故事在<a class="ae id" rel="noopener" href="/@vishvananda/the-hydra-bug-d98214029358">第二部</a>中继续。</p><div class="ky kz la lb fq ab cb"><figure class="ml hw mm mn mo mp mq paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="ml hw mm mn mo mp mq paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="ml hw mm mn mo mp mq paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mr ms mt"><p id="f922" class="jv jw mu jx b jy jz jh ka kb kc jk kd mv kf kg kh mw kj kk kl mx kn ko kp kq hn dt translated"><a class="ae id" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae id" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae id" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae id" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jv jw mu jx b jy jz jh ka kb kc jk kd mv kf kg kh mw kj kk kl mx kn ko kp kq hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae id" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae id" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="ky kz la lb fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="fe ff my"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>