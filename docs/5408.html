<html>
<head>
<title>Why we rewrote Lua in JS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么我们在JS中重写Lua</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/why-we-rewrote-lua-in-js-a66529a8278d?source=collection_archive---------4-----------------------#2017-07-25">https://medium.com/hackernoon/why-we-rewrote-lua-in-js-a66529a8278d?source=collection_archive---------4-----------------------#2017-07-25</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="ef8b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有一种潜在的愿望，在浏览器中使用JS以外的东西。是否有保证本身就是另一个话题。但是你不需要搜索很长时间就能找到各种旨在在浏览器中引入另一种语言的项目。</p><p id="4407" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Web Assembly的到来重新点燃了我们许多人的渴望。但是wasm离可用于生产还有很长的路要走，并且仍然不允许与所有的web apis完全交互。</p><h1 id="ee5b" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">Lua非常适合浏览器</h1><p id="8219" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">Lua是一种简单的语言，只有很少的概念需要理解，语法清晰易读。你可以在几个小时内熟练掌握它。然而，它提供了非常有用的功能。仅举几个例子:</p><ul class=""><li id="019b" class="kt ku hu it b iu iv iy iz jc kv jg kw jk kx jo ky kz la lb dt translated">一级函数和闭包</li><li id="eb2a" class="kt ku hu it b iu lc iy ld jc le jg lf jk lg jo ky kz la lb dt translated">一种通用的数据结构:<a class="ae jp" href="http://www.lua.org/pil/2.5.html" rel="noopener ugc nofollow" target="_blank">表</a></li><li id="02f5" class="kt ku hu it b iu lc iy ld jc le jg lf jk lg jo ky kz la lb dt translated">Vararg表达式</li><li id="c39a" class="kt ku hu it b iu lc iy ld jc le jg lf jk lg jo ky kz la lb dt translated">词法范围</li><li id="f278" class="kt ku hu it b iu lc iy ld jc le jg lf jk lg jo ky kz la lb dt translated">迭代器</li><li id="d078" class="kt ku hu it b iu lc iy ld jc le jg lf jk lg jo ky kz la lb dt translated">协程程序(见下文)</li></ul><p id="a049" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它有一个理智的强制系统(我在看着你JS！).没有人在每个版本中添加新的概念，这使得它成为一种稳定可靠的语言。</p><p id="366d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://hackernoon.com/tagged/lua" rel="noopener ugc nofollow" target="_blank"> Lua </a>已经在服务器端成功使用，令人敬畏的<a class="ae jp" href="https://openresty.org/en/" rel="noopener ugc nofollow" target="_blank"> OpenResty </a>为像<a class="ae jp" href="https://itch.io/" rel="noopener ugc nofollow" target="_blank"> itch.io </a>这样的网站提供动力。甚至有一些很棒的web框架，如<a class="ae jp" href="http://leafo.net/lapis/" rel="noopener ugc nofollow" target="_blank">lapi</a>。</p><p id="6d52" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Lua可以在许多不同的环境中找到，因为它很容易嵌入。多亏了Lua C api，你可以用它写一个完整的程序，或者简单地把它作为一种<em class="lh">胶合</em>语言。</p><h1 id="5aae" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">协同程序</h1><p id="9efc" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">浏览器的主要卖点之一是协程。协程完美地解决了编写异步代码的问题。不再有承诺，发电机等等。您可以像编写常规代码一样轻松地编写异步代码。</p><p id="7a2a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里有一个简单的例子(全功能版本<a class="ae jp" href="https://gist.github.com/6a1cc45e36dd10afae30744f9b8193ac" rel="noopener ugc nofollow" target="_blank">这里是</a>):</p><figure class="li lj lk ll fq lm"><div class="bz el l di"><div class="ln lo l"/></div></figure><p id="aada" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用async/await的类似版本可以是:</p><figure class="li lj lk ll fq lm"><div class="bz el l di"><div class="ln lo l"/></div></figure><p id="3986" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这很接近，但是注意在Lua版本中，你不需要在<code class="eh lp lq lr ls b">async</code>函数中。在JS中，你必须经常有意识地选择是否标记一个函数<code class="eh lp lq lr ls b">async</code>。在Lua中，<strong class="it hv">任何</strong>函数都可以被中断，只要它运行在协程中。Bob Nystrom写了一篇关于它的很棒的文章<a class="ae jp" href="http://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/" rel="noopener ugc nofollow" target="_blank">在这里</a>。</p><p id="4cc8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当你用JS编写异步代码时，你实际上是在堆积函数调用。这些回调都保留它们的upvalues，这会导致高内存使用率。使用协程，您的函数实际上可以被挂起和恢复，而不必从闭包的金字塔中下降，因为它们运行在单独的lua状态中。</p><h1 id="f3d2" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">在浏览器中使用Lua的现有方式</h1><p id="fd60" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">已经有一些项目在某种程度上在浏览器中使用Lua:</p><ul class=""><li id="0444" class="kt ku hu it b iu iv iy iz jc kv jg kw jk kx jo ky kz la lb dt translated"><a class="ae jp" href="http://moonshinejs.org/" rel="noopener ugc nofollow" target="_blank">月光</a>是JS中Lua的再实现。可悲的是，它不再被积极开发了。</li><li id="9a24" class="kt ku hu it b iu lc iy ld jc le jg lf jk lg jo ky kz la lb dt translated"><a class="ae jp" href="http://starlight.paulcuth.me.uk/" rel="noopener ugc nofollow" target="_blank">同一作者的星光</a>是Lua to JS transpiler。不幸的是，用这种方法无法有效地实现协程。</li><li id="de32" class="kt ku hu it b iu lc iy ld jc le jg lf jk lg jo ky kz la lb dt translated"><a class="ae jp" href="https://daurnimator.github.io/lua.vm.js/lua.vm.js.html" rel="noopener ugc nofollow" target="_blank"> lua.vm.js </a>使用Emscripten将原来的lua实现移植到js。它速度很快，运行良好，但是它与JS的互操作性受到这样一个事实的影响，即我们最终用两个垃圾收集器来管理同一个内存。</li></ul><h1 id="33a1" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">丰加里</h1><p id="7ea5" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated"><a class="ae jp" href="http://fengari.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv"> Fengari </strong> </a>(希腊语中的月亮)是用<a class="ae jp" href="https://hackernoon.com/tagged/javascript" rel="noopener ugc nofollow" target="_blank"> Javascript </a>编写的Lua VM，以浏览器为主要目标。</p><p id="c7e3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Fengari的目标是100%符合最新的Lua语义。它尽可能接近Lua的代码库，如果你熟悉它，你会很容易理解Fengari。目前已经覆盖了Lua范围的99% ,所以只要稍加调整，你就可以运行任何Lua项目。</p><p id="f1c3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有了C API(而不是JS API)，您可以决定用Lua编写任何东西，或者将它用作调用JS代码库来完成繁重工作的高级语言。这也意味着您可以将您的代码隔离在单独的隔离Lua状态中。</p><p id="d474" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您还可以使用<a class="ae jp" href="https://github.com/fengari-lua/fengari-interop" rel="noopener ugc nofollow" target="_blank"> fengari-interop </a>模块毫不费力地直接从Lua代码与JS端进行交互。它确保操作JS对象或函数总是按照您期望的方式进行:</p><figure class="li lj lk ll fq lm"><div class="bz el l di"><div class="ln lo l"/></div></figure><p id="67f0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你在<a class="ae jp" href="http://fengari.io/" rel="noopener ugc nofollow" target="_blank"> fengari.io </a>上看到的REPL本身就是用Lua 写的<a class="ae jp" href="https://github.com/fengari-lua/fengari-web-cli/blob/master/src/web-cli.lua" rel="noopener ugc nofollow" target="_blank">，JS只用来创建Lua状态和运行主脚本。</a></p><p id="d2f3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Fengari仍在开发中，欢迎任何<a class="ae jp" href="https://github.com/fengari-lua/fengari/issues" rel="noopener ugc nofollow" target="_blank">反馈</a>！</p><figure class="li lj lk ll fq lm"><div class="bz el l di"><div class="lt lo l"/></div></figure></div></div>    
</body>
</html>