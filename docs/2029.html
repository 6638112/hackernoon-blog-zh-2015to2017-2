<html>
<head>
<title>Systematize your database— The Ruby way to be the croupier of migrations.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">系统化您的数据库——成为迁移管理员的Ruby方法。</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/systematize-your-database-the-ruby-way-to-be-the-croupier-of-migrations-7c9d56bc628d?source=collection_archive---------15-----------------------#2017-01-02">https://medium.com/hackernoon/systematize-your-database-the-ruby-way-to-be-the-croupier-of-migrations-7c9d56bc628d?source=collection_archive---------15-----------------------#2017-01-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="f700" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">想知道赌台管理员是如何洗牌的吗？他们把牌分成两副，然后把两副牌混为一副。我已经试过很多次了，卡片到处乱飞😞。但是现在想象一下，您可以对您的数据和结构迁移进行洗牌，让它们按照应该的顺序运行……那将是一件很酷的事情！</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/657dee528927bd053984161e4f9eb297.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*is15EmLbOlr5DRzvlG8k2w.gif"/></div></div></figure><p id="d87f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当您的应用程序开始变得越来越大时，您的迁移文件夹可能也会变得越来越大，因此您可能需要在不同的表之间移动一些数据，或者甚至更改这些数据，因为您的结构也发生了变化。</p><p id="414a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您何时进行迁移？首先是数据迁移，然后是结构迁移，还是反过来？</p><p id="e11d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用这些方法中的任何一种，都容易发生一些错误:</p><ul class=""><li id="9b8f" class="kb kc hu it b iu iv iy iz jc kd jg ke jk kf jo kg kh ki kj dt translated">在第一种方法(数据→结构)中，如果您需要的字段还没有创建(因为结构迁移还没有运行)，您会怎么做？</li><li id="30e4" class="kb kc hu it b iu kk iy kl jc km jg kn jk ko jo kg kh ki kj dt translated">在第二种方法(结构→数据)中，如果您想要填充的字段需要在结构迁移中被删除的另一个字段中的数据，您会怎么做？</li></ul><p id="9803" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我给你看一个例子:</p><ul class=""><li id="fe8a" class="kb kc hu it b iu iv iy iz jc kd jg ke jk kf jo kg kh ki kj dt translated">假设您有一个<code class="eh kp kq kr ks b">Post</code>模型，它有一个名为<code class="eh kp kq kr ks b">:deleted</code>的布尔属性，代表被删除的<code class="eh kp kq kr ks b">Posts</code>；</li><li id="c7b1" class="kb kc hu it b iu kk iy kl jc km jg kn jk ko jo kg kh ki kj dt translated">一段时间后，一些<code class="eh kp kq kr ks b">Posts</code>被删除，你被要求不仅仅知道一个<code class="eh kp kq kr ks b">Post</code>被删除，我们还需要知道<code class="eh kp kq kr ks b">Post</code>何时被删除。因此您创建了包含删除日期的<code class="eh kp kq kr ks b">:deleted_at</code>字段；</li><li id="6fab" class="kb kc hu it b iu kk iy kl jc km jg kn jk ko jo kg kh ki kj dt translated">现在您创建了数据迁移，它搜索所有被删除的<code class="eh kp kq kr ks b">Posts</code>并给<code class="eh kp kq kr ks b">:deleted_at</code>字段加上时间戳。到目前为止还不错；</li><li id="c430" class="kb kc hu it b iu kk iy kl jc km jg kn jk ko jo kg kh ki kj dt translated">完成后，您可以安全地删除旧的和过时的<code class="eh kp kq kr ks b">:deleted </code>字段。</li></ul><p id="320b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，在本例中，我们有2次结构迁移(创建<code class="eh kp kq kr ks b">:deleted_at</code>字段并删除<code class="eh kp kq kr ks b">:deleted</code>字段)和1次数据迁移(填充<code class="eh kp kq kr ks b">:deleted_at</code>字段)。在您运行您的迁移之前，这一切都很美好，因为当您运行完结构化迁移时，您将没有一个<code class="eh kp kq kr ks b">:deleted</code>字段来查询被删除的<code class="eh kp kq kr ks b">Posts</code>。</p><p id="8878" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">考虑到这一点，让我向你介绍<a class="ae kt" href="https://github.com/RicardoBrazao/systematize" rel="noopener ugc nofollow" target="_blank">系统化</a>，它是让痛苦消失的宝石。</p></div><div class="ab cl ku kv hc kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hn ho hp hq hr"><h1 id="2957" class="lb lc hu bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly dt translated">它是如何工作的？</h1><p id="1ea5" class="pw-post-body-paragraph ir is hu it b iu lz iw ix iy ma ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">只需将它添加到您的gem文件中:</p><pre class="jq jr js jt fq me ks mf mg aw mh dt"><span id="d183" class="mi lc hu ks b fv mj mk l ml mm">#Gemfile<br/>gem 'systematize', '~&gt; 0.0.1'</span></pre><p id="8859" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">或者通过<code class="eh kp kq kr ks b">bundler</code>安装</p><pre class="jq jr js jt fq me ks mf mg aw mh dt"><span id="f506" class="mi lc hu ks b fv mj mk l ml mm">bundle install 'systematize'</span></pre><p id="df15" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">惊喜吧，惊喜吧，你有新任务了！</p><pre class="jq jr js jt fq me ks mf mg aw mh dt"><span id="bc42" class="mi lc hu ks b fv mj mk l ml mm">$&gt; bundle exec rake -T<br/>rake systematize:migrate       # Migrate the database<br/>rake systematize:rollback      # Rollback the database (options: STEP=x, VERBOSE=false)<br/>rake systematize:rollback_all  # Rollback all the database</span></pre><p id="c307" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有了这个，你的迁移将被重新安排，它们将按时间跨度运行，以确保一切顺利！</p><h1 id="2a83" class="lb lc hu bd ld le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly dt translated">这不全是娱乐和游戏，你知道吗？</h1><p id="bfd5" class="pw-post-body-paragraph ir is hu it b iu lz iw ix iy ma ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">为了顺利进行，你只需要遵守一些规则:</p><ul class=""><li id="4951" class="kb kc hu it b iu iv iy iz jc kd jg ke jk kf jo kg kh ki kj dt translated">迁移需要在正确的文件夹中，对于结构化迁移，应该在<code class="eh kp kq kr ks b">db/migrate</code>中，数据迁移应该在<code class="eh kp kq kr ks b">db/data</code>中。像这样:</li></ul><pre class="jq jr js jt fq me ks mf mg aw mh dt"><span id="24eb" class="mi lc hu ks b fv mj mk l ml mm">- app<br/>  |<br/>  |-db<br/>    |-data<br/>    |-migrate</span></pre><ul class=""><li id="3546" class="kb kc hu it b iu iv iy iz jc kd jg ke jk kf jo kg kh ki kj dt translated">迁移需要遵循<a class="ae kt" href="https://hackernoon.com/tagged/rails" rel="noopener ugc nofollow" target="_blank"> Rails </a>约定<code class="eh kp kq kr ks b">YYYYMMDDHHMMSS_create_products.rb</code></li></ul><h1 id="ea63" class="lb lc hu bd ld le mn lg lh li mo lk ll lm mp lo lp lq mq ls lt lu mr lw lx ly dt translated">闪耀的时刻到了</h1><p id="0431" class="pw-post-body-paragraph ir is hu it b iu lz iw ix iy ma ja jb jc mb je jf jg mc ji jj jk md jm jn jo hn dt translated">现在，如果您需要迁移<a class="ae kt" href="https://hackernoon.com/tagged/database" rel="noopener ugc nofollow" target="_blank">数据库</a>，您只需运行:</p><pre class="jq jr js jt fq me ks mf mg aw mh dt"><span id="e51d" class="mi lc hu ks b fv mj mk l ml mm">bundle exec rake systematize:migrate</span></pre><p id="143a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">需要回滚之前的迁移吗？没问题。</p><pre class="jq jr js jt fq me ks mf mg aw mh dt"><span id="9424" class="mi lc hu ks b fv mj mk l ml mm">bundle exec rake systematize:rollback</span></pre><p id="ad60" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">需要回滚2/3/4迁移吗？我抓住你了。</p><pre class="jq jr js jt fq me ks mf mg aw mh dt"><span id="f276" class="mi lc hu ks b fv mj mk l ml mm">bundle exec rake systematize:rollback STEP=2</span></pre><p id="b926" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">搞得一团糟，你需要重新开始？动手吧。(迁移需要是可逆的😅)</p><pre class="jq jr js jt fq me ks mf mg aw mh dt"><span id="4662" class="mi lc hu ks b fv mj mk l ml mm">bundle exec rake systematize:rollback_all</span></pre></div><div class="ab cl ku kv hc kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hn ho hp hq hr"><p id="c213" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">别忘了打碎它💚按钮，如果你有什么要说的，就像它是热的一样下降<a class="ae kt" href="https://twitter.com/RicBrazao" rel="noopener ugc nofollow" target="_blank"> @RicBrazao </a>！</p><div class="jq jr js jt fq ab cb"><figure class="ms ju mt mu mv mw mx paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="ms ju mt mu mv mw mx paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="ms ju mt mu mv mw mx paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="my mz na"><p id="f922" class="ir is nb it b iu iv iw ix iy iz ja jb nc jd je jf nd jh ji jj ne jl jm jn jo hn dt translated"><a class="ae kt" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是这个家庭的一员。我们现在<a class="ae kt" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae kt" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is nb it b iu iv iw ix iy iz ja jb nc jd je jf nd jh ji jj ne jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kt" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kt" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff nf"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>