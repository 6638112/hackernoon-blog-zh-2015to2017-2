<html>
<head>
<title>Poisonous Interface Type Domains</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有毒界面类型域</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/poisonous-interface-type-domains-7b7a0b21b049?source=collection_archive---------10-----------------------#2017-02-13">https://medium.com/hackernoon/poisonous-interface-type-domains-7b7a0b21b049?source=collection_archive---------10-----------------------#2017-02-13</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div class="fe ff hs"><img src="../Images/c3a29211aabf5c12b071ea5628a5b923.png" data-original-src="https://miro.medium.com/v2/resize:fit:272/format:webp/1*0fxTeG3xfUSoFhTS6uGuQg.png"/></div></figure><div class=""/><div class=""><h2 id="70c2" class="pw-subtitle-paragraph iy ia ib bd b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp ek translated">在接口契约中使用具有雄心勃勃的域的类型可以鼓励观察到的范围依赖并创建隐式契约。</h2></div><p id="4bd5" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">我想副标题所说的是，实现与int64s(除了时间值或内存地址)、字符串id或其他宽域原语一起工作的API的服务和客户端可能充满了错误，这些错误将显式接口契约与隐式契约分开。隐式契约会使服务实现的迭代变得非常困难(这对未来的你是不利的)。</p><p id="2445" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">一个说明性的例子将有助于进一步的教训。留下来看看最佳实践和最后的坏消息。下面的片段来自于Docker API 的<a class="ae km" href="https://github.com/docker/docker/blob/master/api/swagger.yaml#L2158-L2160" rel="noopener ugc nofollow" target="_blank"> Swagger定义:</a></p><pre class="kn ko kp kq fq kr ks kt ku aw kv dt"><span id="f6b1" class="kw kx ib ks b fv ky kz l la lb">ServiceSpec:<br/>  ...<br/>  properties:<br/>    ...<br/>    Mode:<br/>      properties:<br/>        ...<br/>        Replicas:<br/>          type: "integer"<br/>          format: "int64"</span></pre><p id="d36e" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">暗示可能会有一个扩展到2⁶⁴附近的任何地方的用例服务的复制品——从这个词的任何定义来看——都是雄心勃勃的。这样的接口定义有两个问题。</p><p id="d23a" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">首先，任何人使用全值域的概率非常低。事实上，我敢打赌，观察值超过几百是非常罕见的。大于2 ⁶的值几乎不会发生。这种差异迫使服务提供商要么接受并适当地处理任何地方的int64，要么实现额外的输入验证并尝试传达那些域约束(顺便说一句，没人阅读文档)。在大多数情况下，会实现基本的边界检查(比如“大于零”检查)，但我很少看到代码验证上限。你认为一个<a class="ae km" href="https://hackernoon.com/tagged/docker" rel="noopener ugc nofollow" target="_blank"> Docker </a> Swarm Manager被要求创建一个服务的2个(4，294，967，296)副本会处理得怎么样？它会尝试吗？它的内部依赖项能够处理这么多副本吗？它聪明的容器名生成器如何处理压力？我不确定。</p><p id="cd9f" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">第二个问题在客户端。Docker <a class="ae km" href="https://hackernoon.com/tagged/api" rel="noopener ugc nofollow" target="_blank"> API </a>的大多数消费者不会存储或执行关于服务副本数量的边界推动数学。但是，让我们假设你是。假设您想要构建一些自动缩放逻辑，并且需要增加或减少当前的副本数量。消费者<em class="lc">应该</em>立即注意到潜在输入域荒谬的一面，并在进行任何类型转换或上/下溢敏感操作之前将实际值拟合到某个合理的子域。如果他们将值存储在数据库中，那么他们需要确保目标列的大小适当。事实上，这两个最佳实践经常被忽略。对于无类型语言或模式生成ORM的用户来说，这个问题更糟糕。</p><p id="b2a3" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">这个例子并不独特。最常被滥用的原始类型之一是字符串。字符串几乎可以容纳任何东西，通常只受长度的限制。在90年代和21世纪初的一段时间里，人们都在谈论数字身份证。自动递增主键主导了关系表设计。当服务处理的事务数量开始激增时，人们开始越来越多地考虑如何避免在插入和更新期间锁定这些计数器。他们开始思考如果ID空间耗尽会发生什么。出现了稀疏地使用这些ID空间并回收在间隙中丢失的ID的方案。</p><p id="5ac5" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">在某个时候，人们发现了GID和UUIDs。它们被认为是很酷的工具，甚至可以节省CRUD应用程序往返数据库的时间。人们开始定义他们所有的id字符串。问题是定义字符串ID的接口经常在后端“最初”用数字ID实现。你可能会猜到接下来发生了什么。</p><p id="7b77" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">API消费者点击了几次该服务，并注意到ID总是以数字的形式返回。或者他们可能使用了无类型语言的数据库模式生成器。或者API愚蠢地出售有序的数字id(这也成为隐式契约的一部分),消费者从字符串中解析数字进行比较。不管是什么原因，字符串在服务接口中很难处理。</p><p id="f42d" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">不过，我明白了。宽字体吸引人有几个原因。雄心和“未来证明”似乎是最常见的。宽类型也迎合了某些“保持简单愚蠢”或“懒惰工程师”的心态。使用较窄的类型需要对您正在构建的产品有深入的了解。确保它经得起未来的考验需要具体的工程工作和对潜在迭代和迁移工作流的洞察。选择更宽的字体可以让你快速前进。有一件重要的事情要记住…</p><p id="35f3" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">除非你是一名律师，不介意破坏你的API的消费者的业务:<strong class="js ic">随着时间的推移，你的服务所处理的观察到的值的范围成为你的服务的隐含契约的一部分。</strong></p><h2 id="89f0" class="kw kx ib bd ld le lf lg lh li lj lk ll jz lm ln lo kd lp lq lr kh ls lt lu lv dt translated">最佳实践是什么？</h2><p id="4ad7" class="pw-post-body-paragraph jq jr ib js b jt lw jc jv jw lx jf jy jz ly kb kc kd lz kf kg kh ma kj kk kl hn dt translated"><strong class="js ic">使用你的接口类型的完整域</strong>。如果你出售一个int64，你应该使用完整的域名。除非你想让消费者依赖于某个标识字段中的递增数字，否则避免使用“相对”数字。如果你使用一个字符串，你应该出售至少包含每个主要字符类的一部分的值。这意味着数字、字母(大小写混合)以及你能想到的所有符号。</p><p id="e53c" class="pw-post-body-paragraph jq jr ib js b jt ju jc jv jw jx jf jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">如果这听起来很痛苦，你可以一直<strong class="js ic">使用较小的型号</strong>。当您谈论服务副本的数量时，是否可以使用int8或int16？这实际上取决于您的用例，但关键是尽可能多地将输入验证转化为领域问题(有点像容器将访问控制问题转化为领域问题)。</p><h2 id="6dbb" class="kw kx ib bd ld le lf lg lh li lj lk ll jz lm ln lo kd lp lq lr kh ls lt lu lv dt translated">坏消息是</h2><p id="5366" class="pw-post-body-paragraph jq jr ib js b jt lw jc jv jw lx jf jy jz ly kb kc kd lz kf kg kh ma kj kk kl hn dt translated">坏消息是，一旦你在一个发布的API中“扩大”了服务类型的有效域，就很难缩小它们。这样做通常需要对整个API进行版本控制，这在SaaS场景中意味着运行服务的两个版本。如果你可以缩小范围，那么你应该尽快这样做。在你面对一个不能迁移也不能被击垮的消费者之前，就这样做吧。在你为自己赢得SaaS监狱服刑之前做它。</p><div class="kn ko kp kq fq ab cb"><figure class="mb hw mc md me mf mg paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mb hw mc md me mf mg paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mb hw mc md me mf mg paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mh mi mj"><p id="f922" class="jq jr lc js b jt ju jc jv jw jx jf jy mk ka kb kc ml ke kf kg mm ki kj kk kl hn dt translated"><a class="ae km" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae km" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae km" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae km" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jq jr lc js b jt ju jc jv jw jx jf jy mk ka kb kc ml ke kf kg mm ki kj kk kl hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae km" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae km" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kn ko kp kq fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="fe ff mn"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="kn ko kp kq fq hw"><div class="bz el l di"><div class="ms mt l"/></div></figure></div></div>    
</body>
</html>