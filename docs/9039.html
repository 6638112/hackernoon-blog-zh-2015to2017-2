<html>
<head>
<title>Can you run ChefDK and kitchen-docker inside of a Docker container?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你能在docker容器中运行ChefDK和kitchen-docker吗？</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/can-you-run-chefdk-and-kitchen-docker-inside-of-a-docker-container-10c384571f34?source=collection_archive---------8-----------------------#2017-12-23">https://medium.com/hackernoon/can-you-run-chefdk-and-kitchen-docker-inside-of-a-docker-container-10c384571f34?source=collection_archive---------8-----------------------#2017-12-23</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="9e3f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我想把我的ChefDK设置放在一个容器中，这样它的所有依赖项都与主机上的Ruby安装隔离开来，并允许我轻松地并行运行不同的版本来测试升级。</p><p id="9284" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以我从一个基本的Dockerfile开始安装ChefDK…</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="5550" class="jz ka hu jv b fv kb kc l kd ke">from ubuntu:16.04</span><span id="31b3" class="jz ka hu jv b fv kf kc l kd ke">RUN apt-get update</span><span id="d12b" class="jz ka hu jv b fv kf kc l kd ke">RUN apt-get install -y curl<br/>RUN curl -O <a class="ae jp" href="https://packages.chef.io/files/stable/chefdk/2.4.17/ubuntu/16.04/chefdk_2.4.17-1_amd64.deb" rel="noopener ugc nofollow" target="_blank">https://packages.chef.io/files/stable/chefdk/2.4.17/ubuntu/16.04/chefdk_2.4.17-1_amd64.deb</a><br/>RUN dpkg -i chefdk_2.4.17-1_amd64.deb</span></pre><p id="c4e8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果我们构建这个，然后在里面放一个bash shell</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="56e9" class="jz ka hu jv b fv kb kc l kd ke">docker build -t chefdk .<br/>docker run -it chefdk bash</span></pre><p id="2db4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们安装了厨师和刀！</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="d671" class="jz ka hu jv b fv kb kc l kd ke">root@6bb552c50752:/# which chef<br/>/usr/bin/chef<br/>root@6bb552c50752:/# which knife<br/>/usr/bin/knife</span></pre><p id="9310" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">太好了，现在我需要将我的烹饪书安装到容器中，这样我就可以运行测试厨房了，我将在<code class="eh kg kh ki jv b">/cookbooks</code>安装它们</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="58e9" class="jz ka hu jv b fv kb kc l kd ke">docker run -it -v /Users/aaronkalair/cookbooks:/cookbooks chefdk</span></pre><p id="2472" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是可行的，但是因为我们没有在docker文件中指定用户，所以我们是root用户，所以容器中的每个新文件也是root用户所有。</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="0284" class="jz ka hu jv b fv kb kc l kd ke">root@d374bab13add:/cookbooks/teabot# touch test.txt<br/>root@d374bab13add:/cookbooks/teabot# ls -lah test.txt<br/>-rw-r--r-- 1 root root 0 Dec 23 15:28 test.txt</span></pre><p id="3397" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了避免这里的任何问题，让我们在容器中创建一个用户，该用户与主机上的用户具有相同的UID</p><p id="619b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在主机上，我的UID是501，这在我测试的3台机器上是一致的，所以看起来Mac将501分配给创建的第一个用户帐户。</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="fba0" class="jz ka hu jv b fv kb kc l kd ke">Aarons-iMac:chefdk aaronkalair$ id<br/>uid=501(aaronkalair) ...</span></pre><p id="b82a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，我们可以在带有<code class="eh kg kh ki jv b">uid 501</code>的容器中创建一个名为<code class="eh kg kh ki jv b">aaronkalair</code>的用户，方法是将其添加到Dockerfile的末尾</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="37be" class="jz ka hu jv b fv kb kc l kd ke">RUN useradd -u 501 aaronkalair<br/>RUN mkdir -p /home/aaronkalair<br/>RUN chown aaronkalair:aaronkalair /home/aaronkalair<br/>USER aaronkalair</span></pre><p id="2114" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在让我们为我的teabot食谱试着搭建一个测试厨房。首先我们需要安装宝石</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="c3d6" class="jz ka hu jv b fv kb kc l kd ke">root@6c602759d146:/cookbooks/teabot# bundle install<br/>bash: bundle: command not found</span></pre><p id="484f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">嗯，我们没有安装Ruby或者任何相关的工具，但是我们不需要安装，因为Chef自带了它们的嵌入版本。</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="39e4" class="jz ka hu jv b fv kb kc l kd ke">root@6c602759d146:/cookbooks/teabot# ls /opt/chefdk/embedded/bin/</span><span id="2a58" class="jz ka hu jv b fv kf kc l kd ke">... &lt;124 packages including, bundle, gem, ruby etc... &gt;</span></pre><p id="b8cc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，让我们通过将它添加到docker文件中，将它放到我们的路径中</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="8a2e" class="jz ka hu jv b fv kb kc l kd ke">ENV PATH="/opt/chefdk/embedded/bin:${PATH}"</span></pre><p id="5a5e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在让我们再试一次<code class="eh kg kh ki jv b">bundle install</code>。</p><p id="617c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因为我在不同的食谱中使用不同版本的Gems，所以让我们把它们安装到这本食谱的文件夹中，而不是根据我上一次工作的食谱在全球范围内安装不同版本的大杂烩</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="f2f8" class="jz ka hu jv b fv kb kc l kd ke">bundle install --path vendor --binstubs</span></pre><p id="4b63" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不幸的是，这会引发一个关于extconf失败的错误</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="dabb" class="jz ka hu jv b fv kb kc l kd ke">Gem::Ext::BuildError: ERROR: Failed to build gem native extension.</span><span id="7995" class="jz ka hu jv b fv kf kc l kd ke">current directory: /cookbooks/teabot/vendor/ruby/2.4.0/gems/libyajl2-1.2.0/ext/libyajl2<br/>/opt/chefdk/embedded/bin/ruby -r ./siteconf20171223-8-1u0q211.rb extconf.rb<br/>creating Makefile<br/>/cookbooks/teabot/vendor/ruby/2.4.0/gems/libyajl2-1.2.0/ext/libyajl2<br/>extconf.rb:104:in `makemakefiles': unhandled exception<br/> from extconf.rb:138:in `&lt;main&gt;'</span><span id="9c5c" class="jz ka hu jv b fv kf kc l kd ke">extconf failed, exit code 1</span></pre><p id="0295" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本机扩展、Makefiles和extconf听起来好像我们缺少一些依赖项来安装C依赖项，让我们抓住<code class="eh kg kh ki jv b">build-essentials</code>看看会发生什么，当我们编辑Dockerfile时，让我们别名bundle命令。</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="93b5" class="jz ka hu jv b fv kb kc l kd ke">RUN apt-get install -y curl <strong class="jv hv">build-essential</strong></span><span id="782c" class="jz ka hu jv b fv kf kc l kd ke"><strong class="jv hv">RUN echo "alias bundle-install='/opt/chefdk/embedded/bin/bundle install --path vendor --binstubs'" &gt;&gt; /home/aaronkalair/.bashrc</strong></span></pre><p id="8fc7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好了，成功了</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="631f" class="jz ka hu jv b fv kb kc l kd ke">aaronkalair@3ac49ab61513:/cookbooks/teabot$ bundle-install<br/>....<br/>Bundle complete! 3 Gemfile dependencies, 104 gems now installed.<br/>Bundled gems are installed into ./vendor.</span></pre><p id="33fe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我们需要Docker从容器内可用，这样厨房-docker可以制造容器。最简单的方法似乎是将套接字从主机安装到容器中。</p><p id="ba20" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，让我们将运行命令改为:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="a0a3" class="jz ka hu jv b fv kb kc l kd ke">docker run -it -v /Users/aaronkalair/cookbooks:/cookbooks -v <strong class="jv hv">/var/run/docker.sock:/var/run/docker.sock</strong> chefdk</span></pre><p id="6b34" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">并在容器中安装Docker cli</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="b26e" class="jz ka hu jv b fv kb kc l kd ke">RUN apt-get install -y curl build-essential <strong class="jv hv">docker.io</strong></span></pre><p id="8132" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这使我们能够访问容器内部的Docker CLI，但它似乎无法与主机上的守护程序对话</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="f773" class="jz ka hu jv b fv kb kc l kd ke">aaronkalair@4280bf11224b:/$ docker ps<br/>Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get <a class="ae jp" href="http://%2Fvar%2Frun%2Fdocker.sock/v1.26/containers/json" rel="noopener ugc nofollow" target="_blank">http://%2Fvar%2Frun%2Fdocker.sock/v1.26/containers/json</a>: dial unix /var/run/docker.sock: connect: permission denied</span></pre><p id="25d0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">看看它的权限就知道为什么了</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="3196" class="jz ka hu jv b fv kb kc l kd ke">aaronkalair@4280bf11224b:/$ ls -lah /var/run/docker.sock<br/>srw-rw---- 1 root staff 0 Dec 22 11:32 /var/run/docker.sock</span></pre><p id="e7d2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">只有<code class="eh kg kh ki jv b">root</code>用户或<code class="eh kg kh ki jv b">staff</code>组中的用户可以读写套接字，我将通过将我的<code class="eh kg kh ki jv b">aaronkalair</code>用户添加到staff组来修复这个问题。但是要小心你在这里做的事情，因为任何访问Docker套接字的人都有对主机的根访问权。</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="6fdb" class="jz ka hu jv b fv kb kc l kd ke">RUN usermod -a -G staff aaronkalair</span></pre><p id="29e7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们可以和码头工人对话了</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="13ed" class="jz ka hu jv b fv kb kc l kd ke">aaronkalair@43db476d04f7:/$ docker ps<br/>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES<br/>43db476d04f7        chefdk              "/bin/bash"         2 seconds ago       Up 1 second                             upbeat_panini</span></pre><p id="a5e7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以，让我们试着融合我们的测试厨房吧！</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="c0a5" class="jz ka hu jv b fv kb kc l kd ke">aaronkalair@43db476d04f7:/cookbooks/teabot$ ./bin/kitchen converge<br/>....Lots of Good Things...<br/> <strong class="jv hv">Failed to complete #create action: [Cannot assign requested address - connect(2) for [::1]:32776] on default-ubuntu-1604</strong></span></pre><p id="ab4d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">奇怪了，<code class="eh kg kh ki jv b">kitchen list</code>光说<code class="eh kg kh ki jv b">Errno::EADDRNOTAVAIL</code>也没多大帮助</p><p id="8f5f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">难道我真的很不走运，别的什么东西用了32776作为它的重要端口？让我们安装<code class="eh kg kh ki jv b">netstat</code>看看。</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="335d" class="jz ka hu jv b fv kb kc l kd ke">aaronkalair@43db476d04f7:/cookbooks/teabot$ apt-get install net<br/>-tools</span><span id="85de" class="jz ka hu jv b fv kf kc l kd ke">E: Could not open lock file /var/lib/dpkg/lock - open (13: Permission denied)<br/>E: Unable to lock the administration directory (/var/lib/dpkg/), are you root?</span></pre><p id="3cce" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">糟糕，我们需要以root身份进入容器来调试这个问题</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="75b5" class="jz ka hu jv b fv kb kc l kd ke">docker run -it <strong class="jv hv">-u root</strong> -v /Users/aaronkalair/cookbooks:/cookbooks -v /var/run/docker.sock:/var/run/docker.sock chefdk</span></pre><p id="95ae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后<code class="eh kg kh ki jv b">netstat</code>只显示了端口<code class="eh kg kh ki jv b">50332</code>上的一个连接</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="1c89" class="jz ka hu jv b fv kb kc l kd ke">root@e075956d7a2b:/# netstat<br/>Active Internet connections (w/o servers)<br/>Proto Recv-Q Send-Q Local Address           Foreign Address         State<br/>tcp        0      0 e075956d7a2b:50332      keeton.canonical.c:http TIME_WAIT<br/>Active UNIX domain sockets (w/o servers)<br/>Proto RefCnt Flags       Type       State         I-Node   Path</span></pre><p id="11ba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有趣的是，我们正在Docker里面做一些奇怪的Docker东西，也许它在主机上使用？</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="b9e6" class="jz ka hu jv b fv kb kc l kd ke">Aarons-iMac:~ aaronkalair$ netstat | grep 32776<br/></span></pre><p id="3eb9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不，那里也没用。</p><p id="0a70" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们能在厨房外自己绑定到端口<code class="eh kg kh ki jv b">32776</code>吗？</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="eefa" class="jz ka hu jv b fv kb kc l kd ke">root@e075956d7a2b:/# nc -l 32776</span><span id="6fa2" class="jz ka hu jv b fv kf kc l kd ke">root@e075956d7a2b:/# nc -l 0.0.0.0 32776<br/></span></pre><p id="d227" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">是的，这一切都很好</p><p id="27b1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们能不能<code class="eh kg kh ki jv b">curl</code>这个霸占端口的神奇东西<code class="eh kg kh ki jv b">32776</code>？</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="4184" class="jz ka hu jv b fv kb kc l kd ke">root@e075956d7a2b:/# curl -v localhost:32776<br/>* Rebuilt URL to: localhost:32776/<br/>*   Trying 127.0.0.1...<br/>* TCP_NODELAY set<br/>* connect to 127.0.0.1 port 32776 failed: Connection refused<br/>*   Trying ::1...<br/>* TCP_NODELAY set<br/><strong class="jv hv">* Immediate connect fail for ::1: Cannot assign requested address<br/>*   Trying ::1...<br/></strong>* TCP_NODELAY set<br/>* Immediate connect fail for ::1: Cannot assign requested address<br/>* Failed to connect to localhost port 32776: Connection refused<br/>* Closing connection 0<br/>curl: (7) Failed to connect to localhost port 32776: Connection refused</span></pre><p id="0542" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有趣的是，<code class="eh kg kh ki jv b">::1:</code>给了我们和测试厨房一样的错误，这是一些奇怪的IPv6东西吗？</p><p id="cc5b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">快速谷歌确认IPv6仅在你指定一个特殊标志的情况下才在Docker中工作—<a class="ae jp" href="https://docs.docker.com/engine/userguide/networking/default_network/ipv6/" rel="noopener ugc nofollow" target="_blank">https://docs . Docker . com/engine/user guide/networking/default _ network/IPv6/</a></p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="cbba" class="jz ka hu jv b fv kb kc l kd ke">By default, the Docker daemon configures the container network for IPv4 only. You can enable IPv4/IPv6 dualstack support by running the Docker daemon with the <!-- -->--ipv6<!-- -->flag.</span></pre><p id="9846" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好吧，我实际上并不需要IPv6，那么我如何阻止它尝试使用它呢？井<code class="eh kg kh ki jv b">localhost</code>在<code class="eh kg kh ki jv b">/etc/hosts</code>中定义为</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="7560" class="jz ka hu jv b fv kb kc l kd ke">root@e075956d7a2b:/# cat /etc/hosts<br/>127.0.0.1 localhost<br/>::1 localhost ip6-localhost ip6-loopback<br/>fe00::0 ip6-localnet<br/>ff00::0 ip6-mcastprefix<br/>ff02::1 ip6-allnodes<br/>ff02::2 ip6-allrouters<br/>172.17.0.2 e075956d7a2b</span></pre><p id="98e9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以，如果我只是用核武器攻击那些IPv6线路，也许会没事？</p><p id="410b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">(旁注:显然编辑<code class="eh kg kh ki jv b">/etc/gai.conf</code>可以在IPv4行为之前改变IPv6—<a class="ae jp" href="https://askubuntu.com/a/38468" rel="noopener ugc nofollow" target="_blank">https://askubuntu.com/a/38468</a>)</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="d39c" class="jz ka hu jv b fv kb kc l kd ke">root@e075956d7a2b:/# vi /etc/hosts<br/>root@e075956d7a2b:/# cat /etc/hosts<br/>127.0.0.1 localhost<br/>172.17.0.2 e075956d7a2b</span></pre><p id="6c08" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们再次尝试收敛(调试日志记录可能会有所帮助)</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="bfe9" class="jz ka hu jv b fv kb kc l kd ke">root@e075956d7a2b:/cookbooks/teabot# ./bin/kitchen converge -l debug<br/>...<br/>D      [SSH] opening connection to kitchen@localhost&lt;{:user_known_hosts_file=&gt;"/dev/null", :port=&gt;32776, :compression=&gt;false, :compression_level=&gt;0, :keepalive=&gt;true, :keepalive_interval=&gt;60, :timeout=&gt;15, :keys_only=&gt;true, :keys=&gt;["/cookbooks/teabot/.kitchen/docker_id_rsa"], :auth_methods=&gt;["publickey"], :verify_host_key=&gt;false}&gt;<br/>$$$$$$ [SSH] connection failed, terminating (#&lt;Errno::ECONNREFUSED: Connection refused - connect(2) for 127.0.0.1:32776&gt;)</span></pre><p id="deed" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好吧，那么这证实了上述问题是由于试图在一个Docker环境中使用IPv6，而不是为它配置的。</p><p id="bcb7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们有了一个新问题，到端口<code class="eh kg kh ki jv b">32776</code>的SSH连接被拒绝。</p><p id="8cf4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有什么东西在本地监听那个端口吗？回到我们的朋友<code class="eh kg kh ki jv b">netstat</code></p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="f401" class="jz ka hu jv b fv kb kc l kd ke">root@e075956d7a2b:/cookbooks/teabot# netstat --listening<br/>Active Internet connections (only servers)<br/>Proto Recv-Q Send-Q Local Address           Foreign Address         State<br/>Active UNIX domain sockets (only servers)<br/>Proto RefCnt Flags       Type       State         I-Node   Path</span></pre><p id="8ff5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">没有。</p><p id="eebe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">test-kitchen真的成功制作了一个运行SSH守护进程的容器吗？</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="e15a" class="jz ka hu jv b fv kb kc l kd ke">root@e075956d7a2b:/cookbooks/teabot# docker ps<br/>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                   NAMES<br/>9ca4e56ab0b4        2fe546b254ce        "/usr/sbin/sshd -D..."   56 minutes ago      Up About an hour    0.0.0.0:32776-&gt;22/tcp   defaultubuntu1604-nologin-43db476d04f7-hds4zcup</span></pre><p id="1d8d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">看起来确实是这样，如果我们执行到那个容器中，那么<code class="eh kg kh ki jv b">sshd</code>实际上正在运行吗？</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="3b65" class="jz ka hu jv b fv kb kc l kd ke">root@e075956d7a2b:/cookbooks/teabot# docker exec -it 9ca4e56ab0b4 bash<br/>root@9ca4e56ab0b4:/# ps -ef<br/>UID        PID  PPID  C STIME TTY          TIME CMD<br/>root         1     0  0 16:17 ?        00:00:00 /usr/sbin/sshd -D -o UseDNS=no -o UsePAM=no -o PasswordAuthentication=yes<br/>root         6     0  0 17:15 pts/0    00:00:00 bash<br/>root        16     6  0 17:15 pts/0    00:00:00 ps -ef</span></pre><p id="617b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">没错。</p><p id="10d9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">查看上面<code class="eh kg kh ki jv b">docker ps</code>的输出，我们可以看到<code class="eh kg kh ki jv b">32776</code>来自哪里，它是容器中的22映射到主机上的端口。</p><p id="431a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但我们不是在主机上，而是在Dockers自己网络的一个容器内。</p><p id="5434" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好了，这就是我们的情况:</p><ul class=""><li id="4049" class="kj kk hu it b iu iv iy iz jc kl jg km jk kn jo ko kp kq kr dt translated">kitchen-docker制作了一个容器，它可以在里面运行<code class="eh kg kh ki jv b">chef</code>,但是它假设我们在主机上运行，并且会有<code class="eh kg kh ki jv b">sshd </code>在端口处监听docker映射的<code class="eh kg kh ki jv b">22</code>在<code class="eh kg kh ki jv b">localhost</code>上</li><li id="d7b5" class="kj kk hu it b iu ks iy kt jc ku jg kv jk kw jo ko kp kq kr dt translated">我们在Docker创建的网络上的Docker容器中，而不是主机中，因此不能使用端口映射<code class="eh kg kh ki jv b">22 -&gt; 32776</code>,无论它在哪个端口上，对我们来说都不在本地主机上</li></ul><p id="2b8a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">幸运的是，所有这些问题都是可以解决的，我们与运行<code class="eh kg kh ki jv b">sshd</code>的容器在同一个网络上，所以我们应该能够通过IP地址与IP对话。</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="3329" class="jz ka hu jv b fv kb kc l kd ke">root@e075956d7a2b:/cookbooks/teabot# docker inspect 9ca4e56ab0b4 | grep -i ipaddress<br/>            "SecondaryIPAddresses": null,<br/>            "IPAddress": "172.17.0.3",<br/>                    "IPAddress": "172.17.0.3",</span></pre><p id="f9e9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一个快速的理智检查，看看我们是否能和它说话</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="a689" class="jz ka hu jv b fv kb kc l kd ke">In the container created by kitchen-docker</span><span id="8ded" class="jz ka hu jv b fv kf kc l kd ke">root@9ca4e56ab0b4:/# nc -l -p 5000<br/>PING<br/>^C</span></pre><p id="0893" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在运行chefdk的容器中</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="72ff" class="jz ka hu jv b fv kb kc l kd ke">root@e075956d7a2b:/cookbooks/teabot# telnet 172.17.0.3 5000<br/>Trying 172.17.0.3...<br/>Connected to 172.17.0.3.<br/>Escape character is '^]'.<br/>PING</span></pre><p id="2bd4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">太好了，现在来修改厨房码头</p><p id="a944" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里设置端口和主机名—<a class="ae jp" href="https://github.com/test-kitchen/kitchen-docker/blob/master/lib/kitchen/driver/docker.rb#L124" rel="noopener ugc nofollow" target="_blank">https://github . com/test-kitchen/kitchen-docker/blob/master/lib/kitchen/driver/docker . Rb # L124</a></p><p id="9ead" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，让我们快速黑入IP地址和端口22，检查它是否工作</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="ee94" class="jz ka hu jv b fv kb kc l kd ke">root@e075956d7a2b:/cookbooks/teabot# vi vendor/ruby/2.4.0/gems/kitchen-docker-2.6.0/lib/kitchen/driver/docker.rb</span><span id="2c38" class="jz ka hu jv b fv kf kc l kd ke">&lt;some quick edits&gt;</span></pre><p id="322e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们看看这是否可行:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="1606" class="jz ka hu jv b fv kb kc l kd ke">root@e075956d7a2b:/cookbooks/teabot# ./bin/kitchen converge -l debug<br/>...</span><span id="5212" class="jz ka hu jv b fv kf kc l kd ke">D      [SSH] kitchen@172.17.0.3&lt;{:user_known_hosts_file=&gt;"/dev/null", :port=&gt;"22", :compression=&gt;false, :compression_level=&gt;0, :keepalive=&gt;true, :keepalive_interval=&gt;60, :timeout=&gt;15, :keys_only=&gt;true, :keys=&gt;["/cookbooks/teabot/.kitchen/docker_id_rsa"], :auth_methods=&gt;["publickey"], :verify_host_key=&gt;false}&gt; (sudo -E sh -c '</span><span id="7c6c" class="jz ka hu jv b fv kf kc l kd ke">[SSH] Established<br/>...</span></pre><p id="0bde" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好了，成功了！</p><p id="a629" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我为kitchen-docker编写了这个补丁来完成上述工作，而无需在IP地址中进行硬编码—<a class="ae jp" href="https://github.com/test-kitchen/kitchen-docker/pull/283/files" rel="noopener ugc nofollow" target="_blank">https://github . com/test-kitchen/kitchen-docker/pull/283/files</a></p><p id="6978" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">(旁注:给定Docker容器的ID，获取其IP地址的一个非常简单的方法是)</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="898c" class="jz ka hu jv b fv kb kc l kd ke">docker inspect --format '{{ .NetworkSettings.IPAddress }}' &lt;container id&gt;</span></pre><p id="9172" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以我们可以在docker容器中运行ChefDK和kitchen-docker(对kitchen-docker做了一些小的改动)。为了完成这个任务，我在容器中安装了<code class="eh kg kh ki jv b">vim</code>，并把我的<code class="eh kg kh ki jv b">vim</code>、<code class="eh kg kh ki jv b">git</code>和<code class="eh kg kh ki jv b">chef</code>配置从主机安装到容器中，这样我就不用离开容器在编辑和测试之间切换了。</p><p id="b18c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">(虽然cookbooks是从主机挂载的，所以您可以在主机上编辑它们，然后切换到容器进行测试，如果您愿意的话)</p><p id="c60d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可以在我的Github repo上看到最终的docker文件和运行命令，这里是<a class="ae jp" href="https://github.com/AaronKalair/docker_apps/tree/master/chefdk" rel="noopener ugc nofollow" target="_blank">https://Github . com/AaronKalair/docker _ apps/tree/master/chef dk</a></p><p id="fbe1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://twitter.com/aaronkalair" rel="noopener ugc nofollow" target="_blank">在Twitter @AaronKalair上关注我</a></p><figure class="jq jr js jt fq kx"><div class="bz el l di"><div class="ky kz l"/></div></figure></div></div>    
</body>
</html>