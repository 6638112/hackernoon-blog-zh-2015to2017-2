<html>
<head>
<title>Writing the second video game for the Micro:bit in Rust</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为微处理器写第二个视频游戏:生锈的钻头</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/writing-the-second-video-game-for-the-micro-bit-in-rust-3cd8b5ab22d3?source=collection_archive---------4-----------------------#2017-05-22">https://medium.com/hackernoon/writing-the-second-video-game-for-the-micro-bit-in-rust-3cd8b5ab22d3?source=collection_archive---------4-----------------------#2017-05-22</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/e8c5729a2457a0c6b150d02206efff1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*uHEt8Fml5bodo5Wqr4OHmw.gif"/></div></div></figure><div class=""/><p id="025a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我最近发表了一个关于<a class="ae ka" href="https://hackernoon.com/the-first-video-game-on-the-bbc-micro-bit-probably-4175fab44da8" rel="noopener ugc nofollow" target="_blank"> bitflyer的故事，这是BBC micro:bit </a>的一个简单游戏。</p><p id="6c1f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在它的背面，<a class="ae ka" href="https://twitter.com/ZbitConnect" rel="noopener ugc nofollow" target="_blank"> @ZbitConnect </a>的开发者Zbit先生取得了联系，并友好地发来了他的一些电路板让他玩。</p><figure class="kc kd ke kf fq hw fe ff paragraph-image"><div class="fe ff kb"><img src="../Images/d9e6d898b7116a35ba7f2931946fccf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*uMXAtDXAIK0zyi0yQlM5yA.png"/></div></figure><p id="540a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这些板使得给micro:bit添加不同的附件变得很简单，并且被聪明地<a class="ae ka" href="https://hackernoon.com/tagged/designed" rel="noopener ugc nofollow" target="_blank">设计成</a>可以链接。</p><p id="7a39" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它们的工作原理是将一块(我认为)导电弹性体夹在各种电路板的触点之间。橡胶需要一定的压力来连接，因此所有的螺丝和螺栓。</p><p id="8899" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">基本的zbit:builder提供了许多标准的通孔连接来焊接东西，但创造者也在开发其他几个做不同事情的板，包括一个<a class="ae ka" href="http://www.nevilhunt.com/zbit-connect/zbitspeaker.html" rel="noopener ugc nofollow" target="_blank">扬声器板</a>。</p><p id="286d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我掸掉<a class="ae ka" href="https://hackernoon.com/tagged/bitflyer" rel="noopener ugc nofollow" target="_blank"> bitflyer </a>代码，加载进去，第一次就成功了。大约30秒。在它耗尽内存，整个系统崩溃之前。经过几个小时的代码层，剥离任何可以去的东西，修剪东西，我放弃了，并决定采用一种更激进的方法:Rust。</p><h2 id="173e" class="kg kh if bd ki kj kk kl km kn ko kp kq jn kr ks kt jr ku kv kw jv kx ky kz la dt translated">TL；博士；医生</h2><figure class="kc kd ke kf fq hw"><div class="bz el l di"><div class="lb lc l"/></div></figure><figure class="kc kd ke kf fq hw fe ff paragraph-image"><div class="fe ff ld"><img src="../Images/74752f1230b6d85477ac6004ad48b61b.png" data-original-src="https://miro.medium.com/v2/resize:fit:288/format:webp/1*hezbs0C0NCGF9Su2UezfUg.png"/></div></figure><h2 id="d39d" class="kg kh if bd ki kj kk kl km kn ko kp kq jn kr ks kt jr ku kv kw jv kx ky kz la dt translated">为什么<a class="ae ka" href="https://www.rust-lang.org/" rel="noopener ugc nofollow" target="_blank">会生锈</a>？</h2><p id="0495" class="pw-post-body-paragraph jc jd if je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">在我考虑的语言中，Rust最有意义。列表大概是这样的:</p><ul class=""><li id="9128" class="lj lk if je b jf jg jj jk jn ll jr lm jv ln jz lo lp lq lr dt translated"><strong class="je ig"> C </strong>:代码行太多</li><li id="d6c4" class="lj lk if je b jf ls jj lt jn lu jr lv jv lw jz lo lp lq lr dt translated"><strong class="je ig"> C++ </strong>:太过时了</li><li id="5e00" class="lj lk if je b jf ls jj lt jn lu jr lv jv lw jz lo lp lq lr dt translated"><strong class="je ig"> Python </strong>:太内存</li><li id="05cb" class="lj lk if je b jf ls jj lt jn lu jr lv jv lw jz lo lp lq lr dt translated">走:太基础了——我为语言中缺乏句法糖而挣扎</li><li id="fbc5" class="lj lk if je b jf ls jj lt jn lu jr lv jv lw jz lo lp lq lr dt translated"><strong class="je ig"> Java </strong>:太Java了</li><li id="ffde" class="lj lk if je b jf ls jj lt jn lu jr lv jv lw jz lo lp lq lr dt">…</li><li id="38da" class="lj lk if je b jf ls jj lt jn lu jr lv jv lw jz lo lp lq lr dt translated">Rust:新的、闪亮的、针对系统级编程的</li></ul><h2 id="a774" class="kg kh if bd ki kj kk kl km kn ko kp kq jn kr ks kt jr ku kv kw jv kx ky kz la dt translated">锌</h2><p id="c563" class="pw-post-body-paragraph jc jd if je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">选择了rust之后，我必须想办法让Rust在嵌入式主板上运行。幸运的是，有一个项目可以做到这一点:锌。</p><p id="86a7" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">锌的目标是一个项目，生产编译后的rust二进制文件，可以直接在计算机上运行，无需操作系统的帮助(裸机)。该项目支持许多ARM芯片/嵌入式板，但不支持micro:bit nrf51822(还没有！).</p><p id="e254" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它提供了一个很好的入门平台，提供了示例，以及一个名为<code class="eh lx ly lz ma b">xargo</code>的构建工具来处理链接和组织。它们有一个轻量级的HAL模块和宏来帮助电路板配置。</p><h2 id="61c8" class="kg kh if bd ki kj kk kl km kn ko kp kq jn kr ks kt jr ku kv kw jv kx ky kz la dt translated">hal/nrf51822</h2><p id="381d" class="pw-post-body-paragraph jc jd if je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">如前所述，zinc有一些很好的宏来配置对各种东西的安全访问，包括外围设备访问。</p><p id="ca7c" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这些芯片通常允许访问它们不同的系统(I/O、RNG、时钟等..)通过读取和写入魔术存储器位置。</p><p id="e7ab" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">以下代码片段显示了micro:bit的GPIO引脚定义:</p><figure class="kc kd ke kf fq hw"><div class="bz el l di"><div class="mb lc l"/></div></figure><p id="f4e9" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后可用于控制GPIO引脚:</p><figure class="kc kd ke kf fq hw"><div class="bz el l di"><div class="mb lc l"/></div></figure><p id="a011" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我花了很长时间研究诸如中断处理之类的东西是如何工作的，以及外围设备控制的微妙之处(结果是micro:bit实际上没有systick中断，文档也没有完全弄清楚这一点！).但是一旦我理解了细节，以及如何用zinc宏来表达它们，实现就非常简单直接了。</p><h2 id="4b3a" class="kg kh if bd ki kj kk kl km kn ko kp kq jn kr ks kt jr ku kv kw jv kx ky kz la dt translated">音乐</h2><p id="3aef" class="pw-post-body-paragraph jc jd if je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">Zbit先生还送来了一块板子，上面有一个微型扬声器和放大器。扬声器连接到一个gpio引脚，允许它播放非常基本的方波声音。</p><p id="41b5" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">中断向量总是让我有点害怕，所以这样做是一个很好的学习练习。ARM芯片通常有一个函数指针表，保存在内存中的一个已知位置，当中断触发时，芯片保存所有CPU状态，并跳转到该表中相应条目所指向的地址。中断函数返回后，状态恢复，一切照常继续。</p><p id="d743" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这个生锈了看起来怎么样？</p><figure class="kc kd ke kf fq hw"><div class="bz el l di"><div class="mb lc l"/></div></figure><p id="ef55" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最困难的部分是计算出中断表的确切顺序/偏移量。一旦完成，我的isr_rtc0函数就会每隔几毫秒被调用一次。</p><p id="7f1c" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">剩下的只是将MIDI文件转换成一个频率和时间的rust数组，并编写一个简单的函数以正确的速度切换GPIO 1来制作音符。</p><h2 id="4054" class="kg kh if bd ki kj kk kl km kn ko kp kq jn kr ks kt jr ku kv kw jv kx ky kz la dt translated">代码</h2><p id="ac37" class="pw-post-body-paragraph jc jd if je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">代码不是很干净，应该被整理/显著重构(因此不会被推到上游)。但可能在这里找到:</p><p id="a4bc" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae ka" href="https://github.com/stestagg/zinc/tree/bitflyer/examples/bitflyer" rel="noopener ugc nofollow" target="_blank">https://github . com/stestagg/zinc/tree/bit flyer/examples/bit flyer</a></p><h2 id="fa2c" class="kg kh if bd ki kj kk kl km kn ko kp kq jn kr ks kt jr ku kv kw jv kx ky kz la dt translated">关于铁锈的思考</h2><p id="a0fc" class="pw-post-body-paragraph jc jd if je b jf le jh ji jj lf jl jm jn lg jp jq jr lh jt ju jv li jx jy jz hn dt translated">我真的很喜欢用Rust写这个。在裸机上编程意味着我被迫对<code class="eh lx ly lz ma b">unsafe</code>有点漫不经心(对工作来说，这本来可以减少)，并且所有事情都发生在芯片上，几乎没有反馈(扬声器&amp;显示器都严格地只写)，我不必过多地处理选项。共享全局状态避免了所有权的复杂性(这种芯片永远不会在多任务处理方面做太多)</p><p id="a577" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">鉴于我能够避免上面提到的许多痛点，并且每晚运行给宏提供了提供良好抽象的能力，代码变得有趣，使用起来也很愉快。</p><p id="e905" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当然，速度和内存使用比Python快得多，并且(有时被迫)查看和遍历生成的程序集，零成本抽象的真正价值变得非常明显。</p><div class="kc kd ke kf fq ab cb"><figure class="mc hw md me mf mg mh paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mc hw md me mf mg mh paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mc hw md me mf mg mh paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mi mj mk"><p id="f922" class="jc jd ml je b jf jg jh ji jj jk jl jm mm jo jp jq mn js jt ju mo jw jx jy jz hn dt translated"><a class="ae ka" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ka" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ka" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ka" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jc jd ml je b jf jg jh ji jj jk jl jm mm jo jp jq mn js jt ju mo jw jx jy jz hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ka" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ka" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kc kd ke kf fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mp"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="kc kd ke kf fq hw"><div class="bz el l di"><div class="mq lc l"/></div></figure></div></div>    
</body>
</html>