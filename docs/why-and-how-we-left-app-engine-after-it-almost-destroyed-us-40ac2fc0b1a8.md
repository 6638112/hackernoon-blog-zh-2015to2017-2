# 为什么(以及如何)在 App Engine 几乎毁了我们之后，我们离开了它

> 原文：<https://medium.com/hackernoon/why-and-how-we-left-app-engine-after-it-almost-destroyed-us-40ac2fc0b1a8>

上周我看到了[这篇文章](/@contact_16315/firebase-costs-increased-by-7-000-81dc0a27271d?r=r)，它让我想起了几年前我们在 App Engine 上的许多经历。我在一个评论中分享了这一点，引起了一些关注，所以我认为有必要描述一下我们经历了什么，以及我们是如何(几乎)走出谷歌应用引擎这个沙坑的。

首先介绍一些背景，[我们的初创公司](https://www.codenameone.com/)使用了一套非常复杂的服务器，这些年来几乎在任何地方都有托管……从 Azure 到 AWS、Linode、Digital Ocean 等等……这种复杂性的原因与我们的核心产品有关，它需要特定领域的服务器。

为了简化我们的初始发布和适当扩展，我们选择了 App Engine。因为我们是 Java 人，这很有意义。选择 PaaS 而不是 IaaS 的主要目标是简单性。我们认为这是一条捷径，这样我们就可以专注于我们的移动平台，而不是管理服务器。

# 蜜月

在最初的几年里，一切都很好，我们有一些问题需要确定，例如 Eclipse 插件中的一个 bug(我们使用 Eclipse 是因为我们很早就开始了，这是推荐的方法)导致了一个糟糕的部署(选择了 IDE JDK，没有指定类版本)。我们的服务器停机了几个小时，日志完全加密。

在那之后，我们仍然喜欢 app engine，我们甚至在 JavaOne 大会上做了一次演讲，讨论它对我们快速扩展业务的帮助。

为了防止类似停机这样的问题再次发生，我们决定支付金牌支持(每月额外 400 美元)，这样这样的问题就不会再发生。一名谷歌代表写信给我，试图安排一次通话，但由于时间安排冲突，什么也没有发生，我也从未就金牌支持与谷歌代表进行过实际交谈。在升级到 gold 之前，我确实在他们当地的办公室会见了一些谷歌代表，并与他们讨论了一些关于应用引擎的问题，但大多是抽象的业务对话。

# “灾难”

2015 年 3 月，我们每月的“数据读取操作”支出突然从 70 美元跃升至 4 位数。作为一个繁忙的创业公司，我们没有注意到这一点，直到法案到来，我们已经在四月的法案！

问题是我们没有改变任何东西，或者至少没有注意到任何变化，因为我们在那段时间非常忙。直到今天，我也不知道哪里出了问题，但我正在超越自己…

“App Engine Datastore Read Ops”计费行项目非常不透明，这实际上意味着我们从数据存储中读取的次数太多了。Google 推荐使用 memcache 进行频繁的数据访问，我们这样做了，但是“某处”memcache 不起作用。问题是这是大海捞针！

如果我们记录了每个数据存储访问，我们将有大量不可读的日志要处理。这不是可以在 app engine 中调试的。在常规数据库中，我们可以在表上放置触发器，至少可以看到哪个表导致了问题，但是在这里，我们没有这种级别的报告。谷歌有一些你可以安装的监视器，但是他们提供的报告一点用都没有。

很自然，我们联系了金牌支持，我们甚至向他们发送了完整的项目源代码。他们得出结论(查看日志后),问题出在我们这边…

我对此没有异议。我反对的是对你不可能控制或监控的东西收费！

这是一场灾难，因为我们收到的账单太大了，几乎耗尽了我们的收入。由于是自举，而且处于货币化的早期阶段，这有可能让我们破产。谷歌建议对账户进行收费限制，这实际上意味着关闭网站，对于一个以“规模”为存在目的的服务来说，这是一个疯狂的建议。

# 解决方案

问题是，谷歌每天只更新一次账单(或者 12 个小时，我不记得了，因为我在讲述 2015 年的细节)，所以在第二天获得账单数据之前，我们根本无法知道我们做出的修复是否有效。

我们只是缓存了所有可能的东西，一遍又一遍地删除了所有不重要的东西。因为没有办法调试它，所以它包含了大量的猜测和祈祷，希望我们不会让事情变得更糟。

账单最终下降了，但是直到今天我们也不知道我们的哪一个改变解决了这个问题。

# 为什么这是谷歌的错？

显然我们的代码出了问题，对吧？

我将承担一些责任，主要是选择应用引擎，而不是这个问题。

公司和个人选择 app engine 的原因是相对容易实现“谷歌规模”的业务。这就是我们选择它们的原因，我们希望避免部署和管理单个服务器带来的大量复杂性。

谷歌方面的主要错误在于不透明的账单。当我收到电话账单时，我会得到关于为什么要收费的明细。这一点很重要，所以如果我的小孩拿着电话开始乱拨号码，那是我的错，电话公司会告诉我有问题的号码。

谷歌没有这样做。他们在行项目中列出了一个不透明的项目，没有关于实际来源或调试方法的信息(至少在 2015 年没有)。金牌支持没有帮助，所以即使有办法做到这一点，他们的付费支持层没有帮助是一个重要的事实。

# 迁移到别处——替代方案更好

我们在 app engine 中仍然有一些代码，因为迁移数据库非常困难，这不是我们的首要任务。然而，尽管如此，从 app engine 迁移给我们带来了巨大的不可预见的优势:

*   简单性——重写代码有点乏味，但事实证明要简单得多。摆脱应用引擎的限制确实简化了很多代码。最近，我们开始与 Spring Boot 合作，这使得代码更加简单
*   价格——当 Linode 推出 5 美元的服务器时，我有过疑虑，但我们已经在这样的服务器上运行了一个带有 MySQL 的 Spring Boot 应用程序，到目前为止，它运行得非常好。我们的大多数服务器都有更高的规格，但是使用物理独立服务器的能力是巨大的
*   可扩展性—这让我很惊讶，但今天我认为我们的新架构比 app engine 更具可扩展性。为了简化迁移，我们将各个部分分割成单独的服务器，并对新服务采用微服务方法。这意味着单个服务故障不会导致整个系统瘫痪。更好的是，性能问题只会使速度变慢，而不是倾家荡产……
    我们还可以利用 cloudflare 等 CDN 来提供相当高的可用性水平&性能。这显然很难衡量，但我们没有因为从应用引擎中移除功能而出现与服务器相关的停机。唯一失败过一次的是我们的一些使用 S3 的代码，这些代码在最近亚马逊 S3 宕机期间出现了故障
*   更简单的报告/调试—我可以在常规数据库上使用标准的报告工具。我可以远程连接到数据库并调试生产数据，以查看用户面临的问题。这两个都很大。
*   中国——App engine 在中国存在严重问题

当我写下最初的评论时，有人问起了 AppScale T2。我们在 2015 年调查了他们，发现了一些我记不清的问题。我相信这些问题现在已经解决了，但是当时我们无法让它为我们工作。

# 经验教训

我早期的工作之一是建造飞行模拟器，我们和许多军事飞行员一起工作，他们给我灌输了一种“汇报”仪式。当你做某件事的时候，你需要诚实地、有条理地检查你的失败，看看将来如何避免失败:

*   计费——对于新服务，我们现在试图避免灵活计费，我们仍然使用 AWS 的 S3，但理想情况下，我们希望删除它。我宁愿以固定价格支付更多费用，尽管从我们的使用案例来看，S3 的一些替代方案似乎很昂贵
*   避免 PaaS——是的，这可能是把婴儿和洗澡水一起倒掉，但是要正确使用 PaaS 真的很难。我们也有一个解析关闭的问题，所以如果 PaaS 暴露给最终用户(需要他们端的软件更新)，这是一个问题。
*   微服务—我们最初的实施是整体式的。它帮助我们快速启动，所以我不后悔，也不认为这是一个错误，但向前迈进，我们简化和分发。
*   初创公司和小公司比大公司更好——我可能有偏见，但我和很多供应商合作过，让我们讨论一下我们的其他经验。Azure:有多次崩溃和超额计费(虽然没有上面那么严重，只是价格政策不明确)，没有真正的支持。AWS:最令人困惑和迟钝的计费之一(预订实例既昂贵又困难)。另一方面，数字海洋比谷歌和 AWS 便宜。有良好的服务，当我们选择迁移到 Linode(更便宜)，他们非常有帮助，甚至退还剩余的信用！Linode 也立即退还了一个账单错误(在我们这边),帮了很大的忙。原因很明显:一个为谷歌/亚马逊工作的人是一个大型匿名组织中的小隔间居民。对他来说，我们只是人群中的一员。对于一家初创公司，我们是你所关心的“业务”,服务是匹配的。
    我不担心初创公司消失，对我们来说，产品消失的唯一情况是 Parse 和 App Engine 中的一些功能(blob 支持)被弃用。

尽管业务有所增长，但我们每年在基础设施上的支出保持相对稳定。事实上，在某些方面，我们在服务器上的花费比 app engine 正常运行且可扩展性不受影响时要少。

> [黑客中午](http://bit.ly/Hackernoon)是黑客如何开始他们的下午。我们是 [@AMI](http://bit.ly/atAMIatAMI) 家庭的一员。我们现在[接受投稿](http://bit.ly/hackernoonsubmission)并乐意[讨论广告&赞助](mailto:partners@amipublications.com)机会。
> 
> 要了解更多信息，请[阅读我们的“关于”页面](https://goo.gl/4ofytp)、[在脸书上点赞/给我们发消息](http://bit.ly/HackernoonFB)，或者简单地说， [tweet/DM @HackerNoon。](https://goo.gl/k7XYbx)
> 
> 如果你喜欢这个故事，我们推荐你阅读我们的[最新科技故事](http://bit.ly/hackernoonlatestt)和[趋势科技故事](https://hackernoon.com/trending)。直到下一次，不要把世界的现实想当然！