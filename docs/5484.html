<html>
<head>
<title>Whitelists and Indirection Go Together Like Chocolate and Peanut Butter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">白名单和间接就像巧克力和花生酱一样</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/whitelists-and-indirection-go-together-like-chocolate-and-peanut-butter-a350786f8381?source=collection_archive---------11-----------------------#2017-07-28">https://medium.com/hackernoon/whitelists-and-indirection-go-together-like-chocolate-and-peanut-butter-a350786f8381?source=collection_archive---------11-----------------------#2017-07-28</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="5cec" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">味道不错的应用程序和API安全性</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/ffbb1b5dc964b2a4160c1f9fcfaa2c52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VVyVXcokyvxhbZbDCdXweA.jpeg"/></div></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">source: <a class="ae jz" href="https://www.nourishmovelove.com/peanut-butter-chocolate-crunch-cookies/" rel="noopener ugc nofollow" target="_blank">nourishmorelove</a></figcaption></figure><p id="eb6e" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">如果使用得当，<a class="ae jz" href="https://en.wikipedia.org/wiki/Whitelist" rel="noopener ugc nofollow" target="_blank">白名单</a>是一种简单有效的安全策略，可以最大限度地减少攻击面。如果你不在名单上，你就进不去。没有例外。像巧克力一样光滑。如果你很容易在列表中找到并伪造一个名字，使用<a class="ae jz" href="https://en.wikipedia.org/wiki/Indirection" rel="noopener ugc nofollow" target="_blank">间接</a>来增加难度。像花生酱一样粘。它们放在一起味道很棒。</p><h1 id="3cc5" class="kw kx hu bd ky kz la lb lc ld le lf lg ja lh jb li jd lj je lk jg ll jh lm ln dt translated">应用白名单</h1><p id="585c" class="pw-post-body-paragraph ka kb hu kc b kd lo iv kf kg lp iy ki kj lq kl km kn lr kp kq kr ls kt ku kv hn dt translated">白名单是仅允许访问特定资源的实体的列表。每个实体由一个或多个标识符标识，例如用户id、ip地址、端口号或API密钥。重要的是，这些标识符指定唯一的实体，并且这些标识符不能被其他实体轻易模仿。</p><p id="3da7" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">如果允许的实体列表很小并且变化很慢，那么维护列表是非常实用的。例如，如果您提供一个通过API与后端服务通信的医疗保健移动应用程序，那么您的授权应用程序白名单由您的移动应用程序的已发布和已批准版本组成。随着功能的添加和停用，可以在列表中添加和删除版本。只有当API调用包含白名单中的应用版本标识符时，才会被允许。</p><p id="a579" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">应用程序经常对各种不同的服务进行API调用。什么是好的白名单标识符？</p><h1 id="0dcb" class="kw kx hu bd ky kz la lb lc ld le lf lg ja lh jb li jd lj je lk jg ll jh lm ln dt translated">谷歌地图Android API</h1><p id="e625" class="pw-post-body-paragraph ka kb hu kc b kd lo iv kf kg lp iy ki kj lq kl km kn lr kp kq kr ls kt ku kv hn dt translated">要使用<a class="ae jz" href="https://developers.google.com/maps/" rel="noopener ugc nofollow" target="_blank">谷歌地图应用编程接口</a>，你必须在谷歌应用编程接口控制台上注册你的应用程序项目，并获得一个谷歌应用编程接口密钥，你可以将它添加到你的应用程序中。在网页上，您可以调用地图服务，并附加您的_API_KEY:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div class="fe ff lt"><img src="../Images/9454d0a471f6d45790a899108573be31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*ViHX3IscbxM82yu4."/></div></figure><pre class="jk jl jm jn fq lu lv lw lx aw ly dt"><span id="1120" class="lz kx hu lv b fv ma mb l mc md"><a class="ae jz" href="https://maps.googleapis.com/maps/api/staticmap?" rel="noopener ugc nofollow" target="_blank">https://maps.googleapis.com/maps/api/staticmap?</a><br/>     center=Brooklyn+Bridge,New+York,NY<br/>    &amp;zoom=13&amp;size=600x300&amp;maptype=roadmap<br/>    &amp;markers=color:blue%7Clabel:S%7C40.702147,-74.015794<br/>    &amp;markers=color:green%7Clabel:G%7C40.711614,-74.012318<br/>    &amp;markers=color:red%7Clabel:C%7C40.718217,-73.998284<br/>    &amp;key=<strong class="lv hv">YOUR_API_KEY</strong></span></pre><p id="252a" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">使用静态API键作为应用程序或开发人员标识符是非常常见的，但它有多安全呢？有两种基本类型的攻击，对应用程序代码进行逆向工程以找到API密钥，以及在API调用期间观察传输中的API密钥。</p><p id="ffb2" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">在网页上，找到API键可能就像在浏览器中查看页面源代码一样简单。在Android应用程序中，谷歌建议将密钥放在清单文件中，但这很容易被反编译APK的<a class="ae jz" href="https://ibotpeaches.github.io/Apktool/" rel="noopener ugc nofollow" target="_blank">读取。即使谷歌地图API调用使用HTTPS，如果你能发动一次</a><a class="ae jz" href="https://www.owasp.org/index.php/Man-in-the-middle_attack" rel="noopener ugc nofollow" target="_blank">中间人攻击</a>，你就能直接观察到正在传输的API密钥。</p><p id="556b" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">你可以试着通过混淆或编码来隐藏API密钥，但这只会减慢坚定的攻击者的速度。对于Android maps API，谷歌建议限制访问签名应用的指纹，但这最终只是第二个静态密钥来确定，更困难，但不是不可能。</p><h1 id="296a" class="kw kx hu bd ky kz la lb lc ld le lf lg ja lh jb li jd lj je lk jg ll jh lm ln dt translated">API网关</h1><p id="ebac" class="pw-post-body-paragraph ka kb hu kc b kd lo iv kf kg lp iy ki kj lq kl km kn lr kp kq kr ls kt ku kv hn dt translated">人们经常引用大卫·惠勒的话<a class="ae jz" href="https://en.wikipedia.org/wiki/Fundamental_theorem_of_software_engineering" rel="noopener ugc nofollow" target="_blank">“计算机科学中的所有问题都可以通过另一种间接方式来解决。”</a>所以，如果隐藏静态API键很难，为什么不把它们从应用程序中移走，放在代理服务器后面，这样可以间接为你调用？</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff me"><img src="../Images/af71fe485ebcf889ca61ebe2bb2768d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fIKoEQtfBQae8WRFQN_B7w.png"/></div></div></figure><p id="fe3d" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">使用这种配置，客户端应用程序在没有API键的情况下进行API调用，代理服务器重定向API调用，附加适当的API键。密钥不会存储在应用程序中，也不会在客户端和代理之间传输。</p><p id="6bef" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">这是一个好的开始，但我们真的有所收获吗？虽然我们已经从应用程序中删除了API密钥，但现在任何人都可以调用代理，除非我们为代理服务器创建一个新的应用程序白名单，这意味着一个新的静态标识符，我们将称之为共享应用程序秘密。听起来好像又是同样的问题。</p><p id="72f8" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">然而，大多数应用程序对多个第三方服务进行API调用。现在，至少所有这些服务的API密钥都可以在代理后面得到保护。这使得单个应用程序的安全性变得更加重要，但现在所有的API服务都可以集中管理。API密钥可以独立于应用程序进行更新，使用情况可以集中记录并限制费率。大多数商业和开源API网关都提供了这些特性的最佳实践实现。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff me"><img src="../Images/e063e9836b441f1f7514e05be1a3d42a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AEp0W5LB8srasQ5u7MZvUA.png"/></div></div></figure><h1 id="45f6" class="kw kx hu bd ky kz la lb lc ld le lf lg ja lh jb li jd lj je lk jg ll jh lm ln dt translated">应用认证服务</h1><p id="2bb2" class="pw-post-body-paragraph ka kb hu kc b kd lo iv kf kg lp iy ki kj lq kl km kn lr kp kq kr ls kt ku kv hn dt translated">让我们为剩下的共享应用程序秘密再尝试一个间接级别。这一次，我们将对真实应用程序的识别委托给外部服务。</p><p id="871f" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">API代理和认证服务都知道app secret，但不会直接与app本身共享。相反，如果认证成功，应用程序秘密被用于<a class="ae jz" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank">加密签名</a>应用程序认证令牌，该令牌被返回给应用程序。然后，应用程序通过每次API调用将令牌传递给API网关。在将API调用以及适当的API密钥重定向到第三方服务之前，API网关使用app secret验证令牌签名。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mf"><img src="../Images/c9d744062b2533425c63cd29f33ef79e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8L44YHLMXcstYIIWMXaK9w.png"/></div></div></figure><p id="0475" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">虽然秘密是静态的，但令牌却不是。通过设置到期时间、限制令牌的使用次数或两者兼而有之，令牌的生命周期可能会非常短。这样，如果令牌不知何故被盗，它的价值就相当有限。当每个令牌过期时，应用程序可以请求新的身份验证并接收新的令牌。</p><p id="7abb" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">此外，认证服务本身可以随时间发展，改进认证策略和/或向令牌添加额外的二级标识符。</p><p id="3e6d" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">定期验证应用程序身份并返回有时间限制的令牌是间接方式优于静态标识键的一大优势。</p><h1 id="4537" class="kw kx hu bd ky kz la lb lc ld le lf lg ja lh jb li jd lj je lk jg ll jh lm ln dt translated">实用的实现</h1><p id="a1ff" class="pw-post-body-paragraph ka kb hu kc b kd lo iv kf kg lp iy ki kj lq kl km kn lr kp kq kr ls kt ku kv hn dt translated">在CriticalBlue，我们将白名单与间接相结合，为移动应用构建了<a class="ae jz" href="https://approov.io" rel="noopener ugc nofollow" target="_blank">approv</a>应用认证服务。使用Approov，只有正版授权的app才能调用你的后端API。</p><p id="7049" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">首先将Approov SDK放入应用程序中，以启用与身份验证服务的通信。接下来，将您的应用程序注册到身份验证服务，该服务支持强应用程序证明，并生成在服务和后端服务器或API网关之间共享的应用程序机密。</p><p id="5556" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">要观看它的运行，你可以下载并尝试安卓或iOS版的<a class="ae jz" href="https://approov.io" rel="noopener ugc nofollow" target="_blank">应用程序演示</a>。要了解更多细节，你可以跟随<a class="ae jz" href="https://hackernoon.com/hands-on-mobile-api-security-get-rid-of-client-secrets-a79f111b6844" rel="noopener ugc nofollow" target="_blank">的移动API安全实践教程</a>，该教程展示了如何使用API代理服务器和认证服务来移除应用程序中的所有秘密。</p><p id="74e1" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">将应用认证服务与用户认证服务(如<a class="ae jz" href="http://openid.net/connect/" rel="noopener ugc nofollow" target="_blank">OpenID-Connect</a>/<a class="ae jz" href="https://oauth.net/2/" rel="noopener ugc nofollow" target="_blank">oauth 2</a>)相结合，可以极大地减少单独使用用户认证时出现的攻击面。</p><p id="c8cd" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">Android可能有它的好处，但对于应用程序和API安全来说，白名单和间接是它们自己的味道。</p></div><div class="ab cl mg mh hc mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="hn ho hp hq hr"><p id="b513" class="pw-post-body-paragraph ka kb hu kc b kd ke iv kf kg kh iy ki kj kk kl km kn ko kp kq kr ks kt ku kv hn dt translated">感谢阅读！如果你能推荐这篇文章(点击❤按钮)，让其他人也能找到，我将不胜感激。</p></div></div>    
</body>
</html>