<html>
<head>
<title>Dealing with Data Migrations on Multi Tenant — Laravel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">处理多租户上的数据迁移— Laravel</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/abstract-upgrade-command-for-multi-tenant-71089b9a838f?source=collection_archive---------7-----------------------#2017-10-06">https://medium.com/hackernoon/abstract-upgrade-command-for-multi-tenant-71089b9a838f?source=collection_archive---------7-----------------------#2017-10-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/a4934077f2e96f8932b7217f794d66b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*JpnHBa5W4_vSQV2x9jR3Kw.png"/></div></figure><p id="cc07" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我从事的一个项目有时需要对所有客户的数据进行更改。因为每个客户都有自己的数据库，所以我们最终总是会编写一个脚本来在整个客户群中运行它。</p><p id="afa8" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在这些脚本开发过程中，另一件常见的事情是，您希望首先为特定的客户运行(测试数据库)，在为每个客户推广之前看到结果。在本文中，我将展示如何构建一个抽象命令来简化这些过程。</p><h2 id="c070" class="jw jx hu bd jy jz ka kb kc kd ke kf kg jj kh ki kj jn kk kl km jr kn ko kp kq dt translated">1-抽象命令</h2><p id="77b2" class="pw-post-body-paragraph iy iz hu ja b jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv hn dt translated">抽象命令将是真正实现<code class="eh kw kx ky kz b">handle</code>方法的命令。它包括为特定的<em class="la">租户</em>运行一个作业(同步),或者为每个<em class="la">租户分派一个作业。</em>这允许在测试期间立即检查脚本的结果，同时能够在准备推出时运行多个工作线程来并行处理每个<em class="la">租户</em>。</p><figure class="lb lc ld le fq iv"><div class="bz el l di"><div class="lf lg l"/></div></figure><h2 id="1626" class="jw jx hu bd jy jz ka kb kc kd ke kf kg jj kh ki kj jn kk kl km jr kn ko kp kq dt translated">2-具体命令</h2><p id="ad6e" class="pw-post-body-paragraph iy iz hu ja b jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv hn dt translated">一个具体的命令必须做两件事:</p><ul class=""><li id="eb60" class="lh li hu ja b jb jc jf jg jj lj jn lk jr ll jv lm ln lo lp dt translated">设置命令签名；</li><li id="b114" class="lh li hu ja b jb lq jf lr jj ls jn lt jr lu jv lm ln lo lp dt translated">实例化要执行的作业；</li></ul><p id="1b40" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">以下代码片段是一个示例，说明创建新的升级命令是多么简单。</p><figure class="lb lc ld le fq iv"><div class="bz el l di"><div class="lf lg l"/></div></figure><h2 id="c508" class="jw jx hu bd jy jz ka kb kc kd ke kf kg jj kh ki kj jn kk kl km jr kn ko kp kq dt translated">3-抽象的工作</h2><p id="edb5" class="pw-post-body-paragraph iy iz hu ja b jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv hn dt translated">就像upgrade命令一样，每个作业类都会有一些我不想复制的代码。让我们将所有这些提取到一个抽象的作业中。这项工作的职责是:</p><ul class=""><li id="673f" class="lh li hu ja b jb jc jf jg jj lj jn lk jr ll jv lm ln lo lp dt translated">确保提供了租户。</li><li id="46d3" class="lh li hu ja b jb lq jf lr jj ls jn lt jr lu jv lm ln lo lp dt translated">在数据库事务中运行迁移过程。</li><li id="e333" class="lh li hu ja b jb lq jf lr jj ls jn lt jr lu jv lm ln lo lp dt translated">定义仅尝试一次的次数。</li></ul><figure class="lb lc ld le fq iv"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="7a74" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如果您想了解我是如何建立数据库连接的，请查看本文:<a class="ae lv" href="https://hackernoon.com/simple-multi-tenancy-with-laravel-b3f84fc13c39" rel="noopener ugc nofollow" target="_blank">使用Laravel的多租户</a>。</p><h2 id="7713" class="jw jx hu bd jy jz ka kb kc kd ke kf kg jj kh ki kj jn kk kl km jr kn ko kp kq dt translated">4-具体工作</h2><p id="1452" class="pw-post-body-paragraph iy iz hu ja b jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv hn dt translated">具体的工作应该扩展抽象(显然)并实现<code class="eh kw kx ky kz b">run</code>方法，该方法应该包含数据迁移逻辑。</p><figure class="lb lc ld le fq iv"><div class="bz el l di"><div class="lf lg l"/></div></figure><h2 id="9771" class="jw jx hu bd jy jz ka kb kc kd ke kf kg jj kh ki kj jn kk kl km jr kn ko kp kq dt translated">5-结束它</h2><p id="a685" class="pw-post-body-paragraph iy iz hu ja b jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr kv jt ju jv hn dt translated">要让一切正常运行，只需确保在<code class="eh kw kx ky kz b">App\Console\Kernel.php</code>类上注册<code class="eh kw kx ky kz b">commands</code>，并通过artisan运行它。</p><pre class="lb lc ld le fq lw kz lx ly aw lz dt"><span id="e1c7" class="jw jx hu kz b fv ma mb l mc md">php artisan upgrade:menu --database=my_test_database</span></pre><p id="b91d" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">一旦脚本准备好上线，就用<code class="eh kw kx ky kz b">--all</code>旗运行它，并让工人们起来。</p><pre class="lb lc ld le fq lw kz lx ly aw lz dt"><span id="1231" class="jw jx hu kz b fv ma mb l mc md">php artisan upgrade:menu --all<br/>php artisan queue:work</span></pre><p id="5436" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">当然，你总是可以运行多个<code class="eh kw kx ky kz b">queue:work</code>来并行运行它。</p></div></div>    
</body>
</html>