<html>
<head>
<title>Monitor your Infrastructure with TIG Stack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用TIG Stack监控您的基础设施</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/monitor-your-infrastructure-with-tig-stack-b63971a15ccf?source=collection_archive---------4-----------------------#2017-10-27">https://medium.com/hackernoon/monitor-your-infrastructure-with-tig-stack-b63971a15ccf?source=collection_archive---------4-----------------------#2017-10-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/91b80b5e5bdb296a01951303aad76098.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/0*AV7wlg4E8DMFc6Db."/></div></figure><p id="6811" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在本教程中，我将向您展示如何为您的基础设施设置一个监控堆栈。所以你可以从你的<strong class="ja hv">服务器</strong>、<strong class="ja hv"> docker容器</strong>和其他种类的<strong class="ja hv">网络设备</strong>收集数据，这样你就可以分析它的趋势或问题。</p><p id="2813" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">注:所有模板在我的<a class="ae jw" href="https://github.com/mlabouardy/telegraf-influxdb-grafana" rel="noopener ugc nofollow" target="_blank"> <strong class="ja hv"> Github </strong> </a>上都有。</p><p id="ad90" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 1 —它是如何工作的？</strong></p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff jx"><img src="../Images/543f1bd16d9ba95df8a39b717cc651d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*Aw1A7GHp8-KMHpWY."/></div></figure><p id="bd8d" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 1.1 — Telegraf </strong></p><p id="cb14" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在<strong class="ja hv">中编写的数据收集器转到</strong>中，用于收集、处理、汇总和写入指标。这是一个插件驱动的工具，我们将使用一些插件来实现我们的用例。</p><p id="5b06" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 1.2 — InfluxDB </strong></p><p id="f2ef" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">用于度量、事件和实时分析的可扩展时间序列数据库。</p><p id="a573" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 1.3 — Grafana </strong></p><p id="6981" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">数据可视化和探索工具。它可以让你根据来自不同数据源的数据创建图表和仪表盘(<strong class="ja hv"> InfluxDB </strong>、<strong class="ja hv"> Prometheus </strong>、<strong class="ja hv"> Elasticsearch </strong>、<strong class="ja hv"> Cloudwatch </strong> …)</p><p id="8581" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 2 —设置</strong></p><p id="139b" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">克隆存储库:</p><p id="ffbc" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">|git克隆<a class="ae jw" href="https://github.com/mlabouardy/telegraf-influxdb-grafana.git" rel="noopener ugc nofollow" target="_blank">https://github.com/mlabouardy/telegraf-influxdb-grafana.git</a></p><p id="bb9e" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">为了启动所有这些容器，我使用了<strong class="ja hv"> docker-compose </strong>:</p><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="44f3" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">docker-compose调出3个容器:</p><p id="36d1" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 1 — Influxdb: </strong></p><p id="6219" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">由于容器的短暂特性。我们将<strong class="ja hv"> InfluxDB </strong>数据文件夹暴露给我们的主机系统。因此，如果容器重启或停止，我们的数据不会消失。</p><p id="b918" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">端口映射包含3个端口:</p><p id="bdc7" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 8083 </strong>:这是管理web服务器的端口，您可以通过<a class="ae jw" href="http://localhost:8083" rel="noopener ugc nofollow" target="_blank">打开管理页面<strong class="ja hv">http://localhost:8083</strong>T45】</a></p><p id="322d" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 8086 </strong>:这是<strong class="ja hv"> HTTP API </strong>端点端口，用于通过<strong class="ja hv"> Telegraf </strong>向Influxdb发送查询</p><p id="6344" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 2 —格拉夫纳</strong></p><p id="bee9" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">端口<strong class="ja hv"> 3000 </strong>是默认的网络服务器端口。</p><p id="5ffa" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们使用docker的<em class="ke"> link </em>特性将<strong class="ja hv"> Grafana </strong>容器与我们的<strong class="ja hv"> Influxdb </strong>容器链接起来，这样<strong class="ja hv"> Grafana </strong>就可以连接到<strong class="ja hv"> Influxdb </strong>并从中查询数据。</p><p id="1522" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 3 — Telegraf </strong></p><p id="f3a8" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> Telegraf </strong>从“<a class="ae jw" href="https://github.com/influxdata/telegraf/tree/master/plugins/inputs" rel="noopener ugc nofollow" target="_blank"> <strong class="ja hv">输入</strong> </a>”插件中收集指标，将其解析为正确的格式，然后发送给“<a class="ae jw" href="https://github.com/influxdata/telegraf/tree/master/plugins/outputs" rel="noopener ugc nofollow" target="_blank"> <strong class="ja hv">输出</strong> </a>”插件。有很多输入和输出插件，你只需要在<strong class="ja hv"> Telegraf配置文件</strong>中激活它们:</p><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="5171" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在这里，我使用<strong class="ja hv"> Docker输入</strong>插件从Docker守护进程获取所有统计数据(每个容器的资源使用情况),使用<strong class="ja hv">系统输入</strong>插件获取服务器指标(磁盘、CPU、RAM……)</p><p id="b7e0" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">为了启动所有这些服务，我们将使用<strong class="ja hv"> docker-compose </strong>:</p><p id="adc4" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如果您键入<strong class="ja hv">“docker PS</strong>”，您应该会看到<strong class="ja hv"> TIG容器</strong>:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff jx"><img src="../Images/5a7925997d6f518b25eb9181b7770576.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*UEWeX4id2-yaQ9iH."/></div></figure><p id="5e03" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 3 —配置</strong></p><p id="bb01" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">将你的浏览器指向<a class="ae jw" href="http://SERVER_IP:3000," rel="noopener ugc nofollow" target="_blank"><strong class="ja hv">http://SERVER _ IP:3000</strong>，</a>你应该会看到<strong class="ja hv"> Grafana仪表盘:</strong></p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff jx"><img src="../Images/fdff0181f61f2990c7e479a0e91059cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*7b3FlnHI85fxe_Hc."/></div></figure><p id="d604" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">默认凭证是<em class="ke">管理员</em>，密码为<em class="ke">管理员</em>。你会想尽快改变这种情况。</p><p id="c452" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">现在我们需要创建一个指向<strong class="ja hv"> InfluxDB </strong>容器的<strong class="ja hv"> Influxdb数据源</strong>。</p><p id="6e33" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 3.1 —虚拟机数据源</strong></p><p id="cea6" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">我们配置<strong class="ja hv"> Grafana </strong>从<strong class="ja hv"> vm_metrics </strong>数据库中提取数据:</p><p id="0d3a" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 3.2 — Docker数据源</strong></p><p id="d525" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">然后，我们创建另一个数据源，从<strong class="ja hv"> docker_metrics </strong>数据库获取数据。</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff jx"><img src="../Images/607ac1323ae4519d1094d42bbc5b430f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*iCXO-vcXdKFG7oW7."/></div></figure><p id="90aa" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">完成后，您就可以开始创建仪表板了。</p><p id="58b2" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4 —仪表板</strong></p><p id="5e31" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在左上方的菜单中，点击“<strong class="ja hv">添加新仪表板</strong>，然后点击“<strong class="ja hv">添加面板</strong>”:</p><p id="6d30" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4.1 —虚拟机</strong></p><p id="c113" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4.1.1 —存储器</strong></p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff jx"><img src="../Images/54a4294bc44bf0bc25c5adac14e983ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*SLkxwqvI4OPbXiSb."/></div></figure><p id="035b" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4.1.1 —圆盘</strong></p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff jx"><img src="../Images/834cc592f4c998d9beeea80624414283.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*Fub0HYa-27AN-uaS."/></div></figure><p id="4a32" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4.1.3 — CPU </strong></p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff jx"><img src="../Images/f895103d243b59ac26ab48647e41ee36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*_cZur-T1x483-Bry."/></div></figure><p id="7b03" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4.1.4 —网络</strong></p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="fe ff kf"><img src="../Images/72a9d9b8be3fc7156a80c15adb6cb7cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UrcAZzlA3GSksvYNjXJdyg.png"/></div></div></figure><p id="8ecd" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">所有图形组合:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff jx"><img src="../Images/ff9df6225c187a7b2f568069202561b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*f-rqZp1KrDlO5iVr."/></div></figure><p id="ae46" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4.2 —码头工人</strong></p><p id="904e" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4.2.1-创建容器过滤器</strong></p><p id="7bc2" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">为了通过容器名过滤我们的数据，我们将在Grafana中使用一个叫做模板化的概念，这使得我们的仪表板更具交互性和动态性。因此，我们不会在指标查询中硬编码容器的名称，而是使用一个变量。</p><p id="b6a8" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">所以要创建一个变量，点击<strong class="ja hv">设置图标，</strong>然后是<strong class="ja hv">模板</strong>:</p><p id="ff59" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">点击“<strong class="ja hv">新建</strong>”，并按如下所述填写字段:</p><p id="55ce" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">创建后，变量会显示为仪表板顶部的下拉选择框。这个下拉菜单可以很容易地改变你的仪表板上显示的数据。</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff jx"><img src="../Images/1dcadf68cc987ca47ea11bb01498d082.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*_oWZBIZGmUt6uTlo."/></div></figure><p id="65bc" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">现在我们的过滤器已经创建，我们可以跳转到创建我们的第一个图表:</p><p id="6fdf" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated"><strong class="ja hv"> 4.2.1 —内存</strong></p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff jx"><img src="../Images/447f78d79cd1e172bf220b6348b3e7b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*Vn4oVEcMX6G3mTvf."/></div></figure><p id="e0a2" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">以下是结果截图:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="fe ff kf"><img src="../Images/0f6a324a550e90dd32420308bf15ad13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dhAi80p6TAgA-1P62srmOg.png"/></div></div></figure></div></div>    
</body>
</html>