<html>
<head>
<title>Tutorial: Faster AI Development with Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">教程:使用无服务器实现更快的人工智能开发</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/tutorial-faster-ai-development-with-serverless-684f3701b004?source=collection_archive---------13-----------------------#2017-12-06">https://medium.com/hackernoon/tutorial-faster-ai-development-with-serverless-684f3701b004?source=collection_archive---------13-----------------------#2017-12-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="f066" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">两个最热门的技术是人工智能和无服务器，你猜怎么着？他们甚至很配。在进入一些很酷的例子之前，让我们从一些AI基础知识开始:</p><p id="53f6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">人工智能涉及一个<a class="ae jp" href="https://hackernoon.com/tagged/learning" rel="noopener ugc nofollow" target="_blank">学习</a>阶段，在这个阶段中，我们观察历史数据集中的模式，通过训练识别或学习模式，并建立机器学习模型。一旦创建了模型，我们就用它来进行推理(服务)以预测一些结果或对一些输入或图像进行分类。</p><p id="2b23" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">传统的机器学习方法包括长时间的批处理或迭代过程，但我们看到了向更连续的过程或强化学习的转变。推理部分变得越来越受事件驱动，例如，一个机器人接受来自聊天的一行文本，并立即做出响应；电子商务网站接受客户特征并提供购买建议；交易平台监控市场反馈并以交易来响应；或者对一个图像进行实时分类，打开一扇智能门。</p><p id="5f7b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">AI有很多类别。不同的库和<a class="ae jp" href="https://hackernoon.com/tagged/tools" rel="noopener ugc nofollow" target="_blank">工具</a>可能更擅长某些任务，或者只支持特定的编码语言，所以我们需要学习如何开发和部署它们。扩展推理逻辑，使其高度可用，解决持续的开发、测试和操作使其更加困难。</p><p id="e187" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就是无服务器解决问题的地方，它提供了以下好处:</p><p id="9171" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">——加速发展</p><p id="499d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">-简化部署和操作</p><p id="4c5d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">-集成事件触发器和自动缩放</p><p id="05d3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">-支持多种编码语言和简化的包依赖关系</p><p id="ffb3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">无服务器也有一些性能和可用性方面的缺点(<a class="ae jp" href="https://www.iguazio.com/nuclio-future-serverless-computing/" rel="noopener ugc nofollow" target="_blank">在早先的帖子</a>中提到过)，但这些都可以通过新的高性能和开源无服务器平台<a class="ae jp" href="https://nuclio.io/" rel="noopener ugc nofollow" target="_blank"> nuclio </a>来解决。</p><p id="4cb4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们使用<a class="ae jp" href="https://www.tensorflow.org/" rel="noopener ugc nofollow" target="_blank"> TensotFlow </a>、Azure APIs和VADER编写了几个nuclio函数，以展示用无服务器构建一个人工智能解决方案是多么简单。这些解决方案将快速、自动扩展且易于部署。</p><p id="c20c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://nuclio.io/" rel="noopener ugc nofollow" target="_blank"> nuclio </a>的独立版本可以在笔记本电脑上通过一个Docker命令进行部署，这使得使用下面的示例更加简单。这些函数可以用于其他无服务器平台，如AWS Lambda，只需做一些简单的修改。</p><h1 id="13ff" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">情感分析</h1><p id="54c5" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">在下面的例子中，我们使用了<a class="ae jp" href="https://github.com/cjhutto/vaderSentiment" rel="noopener ugc nofollow" target="_blank">Vader perspection</a>，这是一个用于检测文本情感的Python库。我们通过像HTTP这样的事件源输入一个文本字符串，并用一个分类结果进行响应。</p><p id="f81c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在nuclio中，我们可以通过在函数头中添加特殊注释来指定构建依赖关系，如下所示，这可以节省很多麻烦。请注意nuclio中内置的日志记录功能，它有助于我们调试和自动化功能测试。</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="35bb" class="lc jr hu ky b fv ld le l lf lg"># @nuclio.configure<br/>#<br/># function.yaml:<br/>#   spec:<br/>#     runtime: "python"<br/>#     build:<br/>#       commands:<br/>#       - "pip install requests vaderSentiment"<br/><br/>from vaderSentiment.vaderSentiment import SentimentIntensityAnalyzer<br/><br/>def handler(context, event):<br/>    body = event.body.decode('utf-8')<br/>    context.logger.debug_with('Analyzing ', 'sentence', body)<br/><br/>    analyzer = SentimentIntensityAnalyzer()<br/><br/>    score = analyzer.polarity_scores(body)<br/><br/>    return str(score)</span></pre><p id="28fb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">可以使用带有正文的HTTP post来激活该功能，并且该功能可能会以下面的格式用情感来响应:</p><p id="9b53" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">{'neg': 0.0，' neu': 0.323，' pos': 0.677，' compound': 0.6369}</p><p id="4693" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了测试这个功能，使用下面的Docker命令运行nuclio的playground，并通过浏览到<host-ip> :8070(端口8070)来访问UI。在GitHub 或预填充函数列表中找到这个和其他例子<a class="ae jp" href="https://github.com/nuclio/nuclio/tree/master/hack/examples" rel="noopener ugc nofollow" target="_blank">。根据您的需要修改它，然后按deploy来构建它。</a></host-ip></p><p id="94ad" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">docker run-p 8070:8070-v/var/run/docker . sock:/var/run/docker . sock-v/tmp:/tmp nucl io/playground:stable-amd64</strong></p><figure class="kt ku kv kw fq li fe ff paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="fe ff lh"><img src="../Images/db765209299e66be858c399f513385ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5kg_aLiZHa-wNmZR1fJyJw.png"/></div></div><figcaption class="lp lq fg fe ff lr ls bd b be z ek">nuclio playground UI (in port 8070)</figcaption></figure><p id="011b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有关在不同配置中使用和安装nuclio的更多详细信息，请参见<a class="ae jp" href="https://nuclio.io/" rel="noopener ugc nofollow" target="_blank"> nuclio的网站</a>。</p><h1 id="1eee" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">张量流图像分类</h1><p id="9e58" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">最受欢迎的人工智能工具之一是谷歌开发的TensorFlow。它实现了神经网络算法，可用于分类图像，语音和文本。</p><p id="b6f6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在下面的例子中，我们将使用预先训练的初始模型来确定图片中的内容。参见<a class="ae jp" href="https://github.com/nuclio/nuclio/tree/master/hack/examples" rel="noopener ugc nofollow" target="_blank"> nuclio范例库</a>中的完整源代码。</p><p id="f8ac" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://www.tensorflow.org/" rel="noopener ugc nofollow" target="_blank"> TensorFlow </a>为我们带来了一些挑战，因为我们需要使用更大的基线Docker映像，如带有更多工具的“Jessie ”( nucl io默认使用微小的alpine映像，以最大限度地减少占用空间和函数加载时间),我们需要添加添加请求、TensorFlow和numpy python包。</p><p id="d47d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">AI模型可以是一个大文件，加载和解压缩一次比每晚一次更实际。我们将通过在函数头添加以下注释/声明，通过构建指令将模型加载到函数映像中，或者我们可以在函数配置UI选项卡中指定构建指令:</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="74b9" class="lc jr hu ky b fv ld le l lf lg"># @nuclio.configure<br/>#<br/># function.yaml:<br/>#   spec:<br/>#     runtime: "python:3.6"<br/>#     build:<br/>#       baseImageName: jessie<br/>#       commands:<br/>#       - "apt-get update &amp;&amp; apt-get install -y wget"<br/>#       - "wget http://download.tensorflow.org/models/image/imagenet/inception-2015-12-05.tgz"<br/>#       - "mkdir -p /tmp/tfmodel"<br/>#       - "tar -xzvf inception-2015-12-05.tgz -C /tmp/tfmodel"<br/>#       - "rm inception-2015-12-05.tgz"<br/>#       - "pip install requests numpy tensorflow"</span></pre><p id="8ce5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们还将使用一个线程在第一次调用时将模型加载到内存中，并在随后的调用中保存它。我们通过使用可选的环境变量来指定各种参数，使我们的函数更加灵活。</p><p id="b1e7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">函数的主要部分(参见<a class="ae jp" href="https://github.com/nuclio/nuclio/blob/master/hack/examples/python/tensorflow/tensor.py" rel="noopener ugc nofollow" target="_blank">完整代码</a>的链接):</p><pre class="kt ku kv kw fq kx ky kz la aw lb dt"><span id="825d" class="lc jr hu ky b fv ld le l lf lg">def classify(context, event):<br/><br/>    # create a unique temporary location to handle each event,<br/>    # as we download a file as part of each function invocation<br/>    temp_dir = Helpers.create_temporary_dir(context, event)<br/><br/>    # wrap with error handling such that any exception raised<br/>    # at any point will still return a proper response<br/>    try:<br/><br/>        # if we're not ready to handle this request yet, deny it<br/>        if not FunctionState.done_loading:<br/>            context.logger.warn_with('Model data not done loading yet, denying request')<br/>            raise NuclioResponseError('Model data not loaded yet, cannot serve this request',<br/>                                      requests.codes.service_unavailable)<br/><br/>        # read the event's body to determine the target image URL<br/>        # TODO: in the future this can also take binary image data<br/>        # if provided with an appropriate content-type<br/>        image_url = event.body.decode('utf-8').strip()<br/><br/>        # download the image to our temporary location<br/>        image_target_path = os.path.join(temp_dir, 'downloaded_image.jpg')<br/>        Helpers.download_file(context, image_url, image_target_path)<br/><br/>        # run the inference on the image<br/>        results = Helpers.run_inference(context, image_target_path, 5, 0.3)<br/><br/>        # return a response with the result<br/>        return context.Response(body=str(results),<br/>                                headers={},<br/>                                content_type='text/plain',<br/>                                status_code=requests.codes.ok)<br/><br/>    # convert any NuclioResponseError to a response.<br/>    # the response's description and status will appropriately<br/>    # convey the underlying error's nature<br/>    except NuclioResponseError as error:<br/>        return error.as_response(context)<br/><br/>    # in case of any error, respond with internal server error<br/>    except Exception as error:<br/>        context.logger.warn_with('Unexpected error occurred, responding with internal server error',<br/>                                 exc=str(error))<br/><br/>        message = 'Unexpected error occurred: {0}\n{1}'.format(error, traceback.format_exc())<br/>        return NuclioResponseError(message).as_response(context)<br/><br/>    # clean up regardless of whether we succeeded or failed<br/>    finally:<br/>        shutil.rmtree(temp_dir)</span></pre><p id="7077" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用nuclio上下文和事件详细信息对每个事件执行“分类”功能。该事件可以由各种来源触发(例如HTTP、RabbitMQ、Kafka、Kinesis等。)并在正文中包含一个图像的URL，它是通过以下方式获得的:</p><p id="5aa7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">image _ URL = event . body . decode(' utf-8 ')。条状()</p><p id="8ee9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该函数将图像下载到新创建的临时目录中，对其进行分类(Helpers.run_inference ),并在响应中返回最高分数及其概率。</p><p id="76d0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们通过调用shutil.rmtree(temp_dir)在调用结束时删除临时文件，以确保该函数不会占用内存。</p><p id="3912" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意nuclio函数中结构化和非结构化日志记录的广泛使用，因为我们可以在其中一个级别(调试、信息、警告、错误)记录每一步，并向日志事件添加参数。日志条目可用于在开发和生产过程中控制功能执行和调试。我们可以在运行时或每个函数调用时定义所需的日志记录级别(例如，通过playground)，例如，仅在诊断问题时打印调试消息，从而避免正常生产操作中的性能和存储开销。</p><p id="ff65" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">日志使用示例:</p><p id="0964" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">context.logger.debug_with('创建的临时目录'，path=temp_dir)</p><p id="cf51" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意，拥有结构化日志简化了功能监控或测试。当运行回归测试时，我们使用结构化的调试消息来自动验证函数行为。</p><p id="337f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">nuclio支持二进制内容。可以修改每个函数，通过HTTP POST事件直接接受JPEG图像，而不是通过较慢的获取URL和获取其内容的过程。详见<a class="ae jp" href="https://github.com/nuclio/nuclio/blob/master/hack/examples/golang/image/main.go" rel="noopener ugc nofollow" target="_blank">图片大小调整示例</a>。</p><p id="730f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们计划使用nuclio进一步简化这一过程，并添加“卷数据绑定”，这将允许在函数中安装文件共享，并允许我们动态更改模型。我们还计划在Kubernetes中添加GPU支持，从而实现更快、更具成本效益的分类。敬请关注。</p><h1 id="9957" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">使用nuclio的云人工智能服务(Azure Face API)</h1><p id="b281" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">领先的云提供商现在正在提供可以通过API访问的预学习人工智能模型。一个这样的例子是<a class="ae jp" href="https://azure.microsoft.com/en-us/services/cognitive-services/face/" rel="noopener ugc nofollow" target="_blank"> Azure的Face API </a>，它接受一个图片URL，并返回在图片中找到的Face对象列表。</p><p id="b483" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们创建了一个nuclio函数，它接受一个URL，用适当的凭证将它传递给Azure的Face APIs，解析结果，并以Face对象表的形式返回它们，这些对象按照它们在给定图片中的中心位置排序，从左到右，然后从上到下。对于每张脸，该函数返回该脸的矩形位置、估计年龄、性别、情绪以及是否包含眼镜。</p><p id="d4c9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们使用构建指令来指定库依赖项，使用环境变量来指定所需的凭证。在家里尝试之前，请确保您获得并设置了自己的Azure密钥(参见代码注释中的说明)。</p><p id="ccbb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里有<a class="ae jp" href="https://github.com/nuclio/nuclio/blob/master/hack/examples/python/facerecognizer/face.py" rel="noopener ugc nofollow" target="_blank">源</a>，或者在我们的预装操场示例列表中找到它们(称为“face”)。</p><h1 id="5349" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">摘要</h1><p id="0cd0" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">nuclio等无服务器平台有助于更快地测试、开发和产品化AI。我们计划定期向nuclio添加更多人工智能示例，允许开发人员获取预先开发和测试的代码，并根据他们的需求进行修改。</p><p id="affa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注册我们的<a class="ae jp" href="https://nuclio.devpost.com/" rel="noopener ugc nofollow" target="_blank">在线黑客马拉松</a>，在nuclio上构建最棒的无服务器应用，帮助我们扩展nuclio的函数库示例。你可能会赢得一架Phantom 4 Pro无人机…更多详情请访问<a class="ae jp" href="https://nuclio.devpost.com/" rel="noopener ugc nofollow" target="_blank"> devpost nuclio网站</a>。也在Github上给nuclio一颗<a class="ae jp" href="https://github.com/nuclio/nuclio" rel="noopener ugc nofollow" target="_blank">星</a>和<a class="ae jp" href="https://lit-oasis-83353.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">加入我们的Slack </a>社区。</p><p id="84ee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">特别感谢Omri Harel实现并调试了上面的AI函数。</p><figure class="kt ku kv kw fq li"><div class="bz el l di"><div class="lt lu l"/></div></figure></div></div>    
</body>
</html>