<html>
<head>
<title>How I destroyed the staging database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我是如何摧毁临时数据库的</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-i-destroyed-the-staging-database-b435f98569ab?source=collection_archive---------11-----------------------#2017-10-19">https://medium.com/hackernoon/how-i-destroyed-the-staging-database-b435f98569ab?source=collection_archive---------11-----------------------#2017-10-19</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/20e8c22d0737afff27e53b3e3a0d47e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E3yykmiJoG-lLuq18CUKMQ.png"/></div></div></figure><div class=""/><div class=""><h2 id="b4f5" class="pw-subtitle-paragraph jc ie if bd b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ek translated">以及我将如何防止它再次发生</h2></div><p id="a6db" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated"><em class="kq">在此次事故中，没有客户数据受损。Amazon RDS快照在20分钟内恢复了临时数据库，该数据库仅供内部使用。</em></p><p id="6819" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">今天我犯了一个错误。这导致临时数据库中的每个表都被删除。好的一面是，这不是生产数据。</p><h2 id="e39b" class="kr ks if bd kt ku kv kw kx ky kz la lb kd lc ld le kh lf lg lh kl li lj lk ll dt translated">特性1:配置:缓存</h2><p id="eb34" class="pw-post-body-paragraph ju jv if jw b jx lm jg jz ka ln jj kc kd lo kf kg kh lp kj kk kl lq kn ko kp hn dt translated">如果您在您的Laravel应用程序中运行<code class="eh lr ls lt lu b">php artisan config:cache</code>，它将生成一个包含您的<code class="eh lr ls lt lu b">config/*.php</code>文件夹中所有配置的<code class="eh lr ls lt lu b">bootstrap/cache/config.php</code>文件。目标是通过在准备就绪的状态下缓存设置来加速Laravel的引导过程。</p><h2 id="e3e3" class="kr ks if bd kt ku kv kw kx ky kz la lb kd lc ld le kh lf lg lh kl li lj lk ll dt translated">特性2:刷新数据库</h2><p id="3646" class="pw-post-body-paragraph ju jv if jw b jx lm jg jz ka ln jj kc kd lo kf kg kh lp kj kk kl lq kn ko kp hn dt translated">Laravel 5.5附带了一个名为<code class="eh lr ls lt lu b">RefreshDatabase</code>的新特性和一个名为<code class="eh lr ls lt lu b">migrate:fresh</code>的优秀迁移命令。trait将只迁移一次，然后使用事务来加速测试套件，但是它将在开始之前删除所有现有的表。当然，这意味着使用<code class="eh lr ls lt lu b">sqlite :memory:</code>或本地数据库。</p><h2 id="1f1b" class="kr ks if bd kt ku kv kw kx ky kz la lb kd lc ld le kh lf lg lh kl li lj lk ll dt translated">冲突</h2><p id="5d5b" class="pw-post-body-paragraph ju jv if jw b jx lm jg jz ka ln jj kc kd lo kf kg kh lp kj kk kl lq kn ko kp hn dt translated">您的本地环境设置为使用每个开发人员共享的临时数据库。您这样做的原因是因为您想要测试一个特性的性能，而临时数据库有一些很好的数据集来测试这一点。但是既然你想测试性能，你显然想用<strong class="jw ig">缓存</strong>路由<em class="kq">和<em class="kq">配置</em>。</em></p><p id="7e60" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">你对结果很满意。是时候进入下一个专题了。作为一个TDD爱好者，您编写一个新的测试并运行它，看看哪里出了问题。它失败了。太好了，现在就实施吧。房间里有人喊道— <em class="kq">伙计们，临时数据库怎么了？</em></p><p id="7d68" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">您的测试套件没有从您的<code class="eh lr ls lt lu b">phpunit.xml</code>加载您的<code class="eh lr ls lt lu b">:memory:</code>值。这是不必要的，因为<code class="eh lr ls lt lu b">bootstrap/cache/config.php</code>有所有必要的设置。遗憾的是，设置不正确。</p><p id="4994" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">你进入亚马逊控制台，恢复5分钟前的快照。在15~20分钟内，转移环境将再次运行，不会造成永久性损坏。</p><h2 id="398f" class="kr ks if bd kt ku kv kw kx ky kz la lb kd lc ld le kh lf lg lh kl li lj lk ll dt translated">余波</h2><p id="9409" class="pw-post-body-paragraph ju jv if jw b jx lm jg jz ka ln jj kc kd lo kf kg kh lp kj kk kl lq kn ko kp hn dt translated">在学习了如何炸毁一个非预期的数据库之后，让我们学习如何保护它。</p><h2 id="8632" class="kr ks if bd kt ku kv kw kx ky kz la lb kd lc ld le kh lf lg lh kl li lj lk ll dt translated">1- 101:删除权限</h2><p id="d125" class="pw-post-body-paragraph ju jv if jw b jx lm jg jz ka ln jj kc kd lo kf kg kh lp kj kk kl lq kn ko kp hn dt translated">不要偷懒。为您的项目设置一个新的数据库用户，该用户在登台环境中没有<code class="eh lr ls lt lu b">DROP</code>权限。</p><h2 id="27b4" class="kr ks if bd kt ku kv kw kx ky kz la lb kd lc ld le kh lf lg lh kl li lj lk ll dt translated">2-测试设置白名单</h2><p id="cd99" class="pw-post-body-paragraph ju jv if jw b jx lm jg jz ka ln jj kc kd lo kf kg kh lp kj kk kl lq kn ko kp hn dt translated"><code class="eh lr ls lt lu b">CreatesApplication</code>特性是检查特定设置是否是预期的最佳地方。它在测试套件之间共享，并在建立数据库之前执行。</p><figure class="lv lw lx ly fq hw"><div class="bz el l di"><div class="lz ma l"/></div></figure><p id="fb90" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">这将确保如果你搞砸了，意外的环境不会受到影响。</p><h2 id="a300" class="kr ks if bd kt ku kv kw kx ky kz la lb kd lc ld le kh lf lg lh kl li lj lk ll dt translated">3-[好处]使调试更容易</h2><p id="2af7" class="pw-post-body-paragraph ju jv if jw b jx lm jg jz ka ln jj kc kd lo kf kg kh lp kj kk kl lq kn ko kp hn dt translated">你的环境受到保护。一切都准备好了。这种事不会再发生了。但是下一次你缓存你的设置并忘记它的时候，你的测试会告诉你你有错误的设置。你可能会看着<code class="eh lr ls lt lu b">phpunit.xml</code>文件困惑于这怎么可能。为了让未来的你更清楚和容易，多3行代码可以节省一些调试时间。</p><figure class="lv lw lx ly fq hw"><div class="bz el l di"><div class="lz ma l"/></div></figure><h2 id="4f38" class="kr ks if bd kt ku kv kw kx ky kz la lb kd lc ld le kh lf lg lh kl li lj lk ll dt translated">4-结论</h2><p id="96a7" class="pw-post-body-paragraph ju jv if jw b jx lm jg jz ka ln jj kc kd lo kf kg kh lp kj kk kl lq kn ko kp hn dt translated">第二天，我在站立会议上报告说，我已经测试了我们的数据库备份系统。他们工作得非常出色。好的一面是，我还报告说，我不会意外地再次测试它。</p><p id="7ff6" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">无论如何，要小心生产状态命令。在开发阶段缓存配置和路由通常会导致意外的行为。当您没有清除路由缓存时，可能会浪费一些时间来理解为什么会出现404页面未找到。配置缓存是一个有趣的发现。</p></div></div>    
</body>
</html>