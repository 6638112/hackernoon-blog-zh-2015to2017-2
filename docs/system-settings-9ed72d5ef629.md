# 系统设置

> 原文：<https://medium.com/hackernoon/system-settings-9ed72d5ef629>

## Inaka 从代码中移除*文字*的方法

至此，对于大多数开发者来说，我们为什么不喜欢 [*幻数*](https://en.wikipedia.org/wiki/Magic_number_(programming)) 应该很清楚了。

![](img/d8c728944d83493eb35f6a740785db99.png)

Sorry guys, nothing personal.

代码中出现的幻数或其他文字值(数字、字符串或任何东西)通常被[认为是*不良气味*](http://www.techrepublic.com/article/avoid-using-magic-numbers-and-string-literals-in-your-code/) 。然而，*默认的*解决方案并不总能完全解决*问题*。在这篇文章中，我将向你展示我们在 Inaka 的方式，不管构建每个特定的系统使用什么语言，我们都喜欢处理这种情况。

# 场景

首先，我的解决方案(和任何解决方案一样)并不适用于*所有场景*。要使此方法适用于您的系统，应满足以下条件:

1.  该系统必须包括数据库、键/值存储或一些其他持久层。
2.  该系统必须包括一个可以访问持久层的管理界面。
3.  系统不应该有超严格的实时约束。如果是这种情况，您应该寻找编译时解决方案，我的是运行时解决方案。

如果您的系统不满足这个标准，您可以放心地跳过本文的其余部分。下周见:)

为了让您更好地了解推荐技术背后的动机，我将向您展示我在代码中看到的一些文字。这些显然不是最终可能成为*神奇文字*的所有**东西，但这些是促使我在公司内部推广*系统设置方法*的东西:**

*   **用户凭证/应用令牌:**当处理第三方 API 时，比如脸书或 Twitter(特别是如果这涉及到 OAuth)，你通常必须注册一个应用，并获得一个应用令牌，你必须在所有请求中使用它。那个 app token 或者用户 id 或者 app id 在开发者眼里可能看起来是*不变的*。
*   **页面大小或其他 API 配置:**例如，在提供或使用分页 API 时，页面大小往往也被视为一个*常量*。
*   默认值:当你的应用程序提供默认值给你的用户，当他们要输入一些东西的时候，有时候直接用代码写这些默认值是很诱人的。
*   **内部系统配置:**例如，如果发生错误，系统将向其报告错误的电子邮件。在代码中保留这个值似乎不是一个坏主意，因为它会一直被使用，最终用户*不会看到它，也不会被它影响*。那封邮件甚至可能是*毕竟只是你的邮件*。

您可能会明白为什么将这些东西(以及许多类似的东西)保存在代码中不是一个好主意。它们往往会在你最意想不到的时候发生变化，例如，客户希望改变他们的品牌，因此他们创建了一个新的 FB 应用程序，使用信息确定为了获得更好的 UX，页面的大小应该缩小/扩大，系统管理电子邮件的所有者刚刚离开公司或被转移到其他团队，等等。如果这些值是硬编码的，更改它们需要代码更改、测试、拉式请求、代码审查、在不同环境中部署、QA 测试等等…

有更好的方法来实现这些事情。

# 通常的嫌疑人

现在，在深入研究建议的方法之前，让我们看一些替代方案。因为，正如我所说的，这个问题是众所周知的，大多数语言都提供了一种机制来很好地从代码中提取这些文字。我记得我用过的那些:

*   Visual Basic 的 ini 文件。哦耶，宝贝！我也写了几年 VB6 代码。
*   C# / ASP。NET 的资源文件(resx，如果我没记错的话)。
*   露比的。环境和秘密文件。
*   Erlang 的 sys.config 文件。
*   Elixir 的 config.exs 文件。
*   Swift / Objective-C .plist 文件。

你看到了共同的模式，对吗？它们都是文本文件，你把所有的常量/文字放在里面。然后，它们会与您的系统捆绑在一起发布。它们很容易编辑，并且通常带有智能机制，允许 DevOps 根据系统部署的不同环境来调整它们。这些语言/库也为开发人员提供了访问这些文件中的信息的超级简单的方法。但是编辑这些文件中的某些内容可能会带来一些挑战:

*   它通常需要系统重启和/或重新部署。如果没有，至少应该部署编辑过的文件并重新加载配置。
*   非技术人员通常无法访问这些文件，而大多数时候他们才是需要更改的人。更改参数需要 DevOps 或 SysAdmin 人员的干预。
*   即使有时通过注释添加，每个字段的文档也不是必需的，有时甚至会被忽略。
*   通常情况下，对这些文件的编辑没有保留任何听觉线索。
*   在分布式系统中，您也必须将文件分发到所有节点。

当然，这些问题中的每一个都可以用不同的解决方法或工具来解决。我们在系统中使用的是一种更通用的方法，试图一次解决所有这些问题。

![](img/ef4eb8c910e9e41acf5fb9b5124d08a5.png)

Gears #1 (by Steve Gadomski)

# 系统设置

那么，我们该怎么办？从概念上讲，我们的想法是将这些常量/文字作为我们系统模型的一等公民。因此，如果我们在 OOP 中工作，我们添加对象/类来表示这些系统设置。如果我们用函数式语言工作，我们用它们自己的*抽象数据类型*来表示这些设置，正如这里的[所描述的](/tech-lead-talks/7-heuristics-for-development-f8646d4a5219#.sd6d6slmv)。

实际上，它最终被保存在我们数据库的一个表中。正如所料，该表/模型有一个**键**和一个**值**。但是该模型还包括每个键的强制**描述**(从而提供适当的文档)和额外的**元数据**(在同一模型或另一个相关模型中)以跟踪谁在何时修改了值。它甚至可能包括以前的值，因此任何更改都可以很容易地回滚。

为了编辑这些值，我们在管理界面中添加了一个面板(通常是只有系统管理员才能访问的私有 web 应用程序)。根据系统和要配置的参数，该面板可提供或多或少的灵活性。一般来说，它提供了一个设置列表，每个设置都有它的关键字、描述和一个输入控件，管理员用户可以在其中编辑相应的值。

然后，我们的系统从数据库表中获取这些值，尽管我们通常会在其上添加一个缓存层，以避免不断地在数据库中查询相同的值。为了处理缓存层，我们为管理面板添加了一个内部机制，让服务器知道它必须刷新缓存。每当设置发生变化时，就会执行该机制(通常是 REST 端点)。

## 对等

*   非技术用户现在可以访问设置。他们不需要要求 DevOps 改变什么。
*   我们通过正确地建模我们领域的所有实体来遵循 [7 开发启发法](/tech-lead-talks/7-heuristics-for-development-f8646d4a5219#.sd6d6slmv)。
*   我们可以很容易地将所有想要的元数据添加到设置对象中(如描述、以前的值等。).
*   很容易保持所有变化的听觉记录。有时候我们可以使用外部库，比如 Ruby 的 [PaperTrail](https://github.com/airblade/paper_trail)
*   重建和重新部署的需求大大减少。它并没有被完全消除(见下面的缺点),但是大多数时候不再需要它了，因为服务器可以在需要的时候获取新值。
*   以这种方式开发系统在系统交付后需要更少的努力。换句话说，系统所有者可以自己管理它，这是系统所有者和开发人员都应该期望的。

## 下降趋势

*   非技术用户现在可以访问设置。他们可能会因失误而严重扰乱系统。强大的力量伴随着巨大的责任。
*   有些设置不能存储在数据库表或键/值存储中(例如，数据库 url 和端口)，因此配置文件或其他机制仍然必须用于此。
*   所有设置的初始值仍然需要包含在某个地方(例如，在 Ruby 中，我们仍然需要将所有的 used-to-be-literals 添加到 seeds.rb 文件中，有时仍然从。env 文件也是)。
*   改变一些值*可能需要*服务器重启(例如，它监听的 TCP 端口)。对于这些值，您需要仔细考虑它们是否不应该出现在这个表中，或者更改它们是否会触发重启机制。
*   以这种方式开发系统需要更多的前期工作。

# 结论

我们第一次想出这种技术，是因为我们已经厌倦了在凌晨 1 点被叫去(我们大多数人在布宜诺斯艾利斯为美国西海岸的公司工作)改变单个参数并再次部署系统。我们知道我们可以告诉客户在适当的配置文件中更改该值，并且我们可以教他们如何重启系统。实际上，我们不止一次地写了相关的文档。这并没有奏效:他们仍然觉得配置文件在某种程度上是我们的*领地*。事实上，他们离真相并不远。

我很确定在我们之前很多人都知道这件事，你们中的很多人在读完这篇文章后会想*嗯，伙计…当然！我已经用这种方式构建系统 30 年了！*。但是也许，希望，你们中的一些人还没有想到它，它可能会改善你们的生活，就像它改善了我们的生活一样。

这个解决方案当然不创新，但是很管用！

客户仍然会在奇怪的时间打电话给我们要求更改一些东西，但是现在我们很高兴地告诉他们“是的，就在你的系统设置页面里。你可以自己改！”然后开心自豪的挂掉电话:)

[![](img/50ef4044ecd4e250b5d50f368b775d38.png)](http://bit.ly/HackernoonFB)[![](img/979d9a46439d5aebbdcdca574e21dc81.png)](https://goo.gl/k7XYbx)[![](img/2930ba6bd2c12218fdbbf7e02c8746ff.png)](https://goo.gl/4ofytp)

> [黑客中午](http://bit.ly/Hackernoon)是黑客如何开始他们的下午。我们是阿妹家庭的一员。我们现在[接受投稿](http://bit.ly/hackernoonsubmission)并乐意[讨论广告&赞助](mailto:partners@amipublications.com)机会。
> 
> 如果你喜欢这个故事，我们推荐你阅读我们的[最新科技故事](http://bit.ly/hackernoonlatestt)和[趋势科技故事](https://hackernoon.com/trending)。直到下一次，不要把世界的现实想当然！

[![](img/be0ca55ba73a573dce11effb2ee80d56.png)](https://goo.gl/Ahtev1)