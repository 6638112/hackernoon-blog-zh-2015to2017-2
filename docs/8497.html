<html>
<head>
<title>Don’t “Go Freaking Do It“ - Smart Contract Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不要“去他妈的做吧”——聪明的合同分析</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/dont-go-freaking-do-it-5da4df4d4b44?source=collection_archive---------20-----------------------#2017-12-04">https://medium.com/hackernoon/dont-go-freaking-do-it-5da4df4d4b44?source=collection_archive---------20-----------------------#2017-12-04</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/052abbccc65bf37d642c906cdad57062.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tjj0qJwxs1ICsqjdPA_Y5w.png"/></div></div></figure><p id="c642" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">刚刚在<a class="ae ka" href="https://news.ycombinator.com/item?id=15843738" rel="noopener ugc nofollow" target="_blank">黑客新闻</a>上看到一个关于一个叫做“<a class="ae ka" href="https://gofreakingdoit.com/" rel="noopener ugc nofollow" target="_blank">去他妈的做吧</a>”的<a class="ae ka" href="https://www.ethereum.org/" rel="noopener ugc nofollow" target="_blank">以太坊</a>智能合约的好主意，于是决定看看它是如何运作的。这篇文章描述了我们发现的一些错误。</p><h1 id="f333" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">介绍</h1><p id="e11b" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">我的朋友<a class="ae ka" href="https://hamstah.com/" rel="noopener ugc nofollow" target="_blank"> Nico </a>和<a class="ae ka" href="https://tandem.engineering" rel="noopener ugc nofollow" target="_blank"> I </a>都对信息/网络安全感兴趣，最近注意到智能合同中可用的攻击面。目前，我们主要着眼于可靠性和EVM字节码，试图自动化寻找漏洞的过程，以及做一些手工代码审计。</p><p id="7472" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该合同的代码在Etherscan 上<a class="ae ka" href="https://etherscan.io/address/0x2d4991d05131cbf3cdf81439e96b11a93ccb7af0#code" rel="noopener ugc nofollow" target="_blank">，可以直接在那里进行审计。如果你对可靠性不熟悉，看看这个备忘单</a>。感谢合同的作者Karolis Ramanauskas ，他执行了一个如此巧妙的想法。</p><h1 id="70f6" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">什么是“去他妈的做吧”</h1><p id="198b" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">这个概念很简单:你把$$$和你想要完成的目标一起存入合同，还有一个可选的“主管”联系人，他将核实你是否在给定的日期完成了目标。如果他们说你做到了，那么你可以拿回你的美元。如果没有，“去他妈的做吧”会保留它，所有者会为他们建造它的努力赚些钱。</p><h1 id="264e" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">发现低严重性问题</h1><p id="3770" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated"><strong class="je hv">数据丢失。</strong>不检查目标是否已经包含给定的散列。如果提交了具有相同发件人/描述/价值/截止日期的目标，可能会导致目标丢失(和$$$)。</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="cccb" class="ln kc hu lj b fv lo lp l lq lr">function setGoal() {<br/>    (...snip for brevity...)</span><span id="e335" class="ln kc hu lj b fv ls lp l lq lr">    bytes32 hash = keccak256(msg.sender, _description, msg.value, _deadline);</span><span id="07a8" class="ln kc hu lj b fv ls lp l lq lr">    Goal memory goal = Goal(...snip for brevity...);</span><span id="fa6b" class="ln kc hu lj b fv ls lp l lq lr">    goals[hash] = goal;</span><span id="6421" class="ln kc hu lj b fv ls lp l lq lr">    (...snip for brevity...)<br/>}</span></pre><p id="d424" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="lt">解决方案:要么拒绝重复项，要么在哈希中添加一个随机数。</em></p><p id="54ed" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一个超级用户负责所有任务。 <em class="lt"> </em>这个契约有两类用户，“所有者”和其他所有人。这样做的问题是，契约有一些内务处理功能，这些功能可能运行在某个外部系统上(比如setEmailSent())，然后这个系统将可以访问凭证，这些凭证可以对契约做任何事情。(虹吸钱，转移所有权，销毁它。).</p><p id="f7fb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="lt">解决方案:最好将权限分层，并有一个额外的帐户，“会计”或类似的帐户。</em></p><p id="9a39" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">数据泄露。</strong>因为所有目标都是公开的，所以您可以看到所有用户输入的电子邮件地址、目标和金额。</p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="cba9" class="ln kc hu lj b fv lo lp l lq lr">Goal[] public activeGoals;</span></pre><p id="0fd5" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="lt">解决方案:不要标记为public。</em></p><h1 id="f7e0" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated"><strong class="ak">发现高严重性问题</strong></h1><p id="178e" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated"><strong class="je hv">不允许将目标设置为失败。setGoalFailed缺少“onlyOwner”保护。这意味着任何人都可以在任何时候“辜负”合同中每个用户的目标，实质上是将他们所有的钱都捐给了合同所有者。</strong></p><pre class="le lf lg lh fq li lj lk ll aw lm dt"><span id="e845" class="ln kc hu lj b fv lo lp l lq lr">function setGoalFailed(uint _index, bytes32 _hash) {<br/>    assert(goals[_hash].amount &gt; 0);<br/>    // assert(goals[_hash].emailSent == true);</span><span id="9fdb" class="ln kc hu lj b fv ls lp l lq lr">    goals[_hash].completed = false;<br/>    activeGoals[_index].completed = false;</span><span id="5639" class="ln kc hu lj b fv ls lp l lq lr">    owner.transfer(goals[_hash].amount); // send ether to contract owner</span><span id="1bec" class="ln kc hu lj b fv ls lp l lq lr">    setGoalFailedEvent(_hash, false);<br/>}</span></pre><p id="52b9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="lt">解决方案:在函数声明中添加onlyOwner守护。</em></p><p id="1323" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je hv">没有版本控制或升级的可能性。</strong>因为所有的状态都存储在契约本身中，所以升级是不可能的。</p><p id="4776" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="lt">解决方案:拥有独立的业务和数据逻辑，或者使用delegatecall会有所帮助。参见</em> <a class="ae ka" href="https://blog.colony.io/writing-upgradeable-contracts-in-solidity-6743f0eecc88" rel="noopener ugc nofollow" target="_blank"> <em class="lt">此处</em> </a> <em class="lt">和</em> <a class="ae ka" rel="noopener" href="/aigang-network/upgradable-smart-contracts-what-weve-learned-at-aigang-b181d3d4b668"> <em class="lt">此处</em> </a> <em class="lt">关于可升级合同的精彩文章。</em></p><h1 id="1b08" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">我们是谁</h1><p id="b623" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">英国伦敦的两名金融科技首席技术官。</p><p id="3a24" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">更多关于<a class="ae ka" href="https://tandem.engineering" rel="noopener ugc nofollow" target="_blank">杰斯珀</a> |更多关于<a class="ae ka" href="https://hamstah.com" rel="noopener ugc nofollow" target="_blank">尼科</a>。</p><h1 id="ddcc" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">笔记</h1><p id="28d1" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">在发表这篇帖子前不久，HN <a class="ae ka" href="https://news.ycombinator.com/item?id=15845374" rel="noopener ugc nofollow" target="_blank">上的用户“mpeg”发现了同样的setGoalFailed() bug </a>。</p><h1 id="4af6" class="kb kc hu bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky dt translated">更新</h1><p id="52e3" class="pw-post-body-paragraph jc jd hu je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz hn dt translated">好消息！😎作者指出，他正在研究V2，并将解决悬而未决的问题。</p></div></div>    
</body>
</html>