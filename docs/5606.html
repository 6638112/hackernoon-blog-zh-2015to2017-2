<html>
<head>
<title>Container resource consumption—too important to ignore</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">容器资源消耗—太重要了，不容忽视</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/container-resource-consumption-too-important-to-ignore-7484609a3bb7?source=collection_archive---------3-----------------------#2017-08-05">https://medium.com/hackernoon/container-resource-consumption-too-important-to-ignore-7484609a3bb7?source=collection_archive---------3-----------------------#2017-08-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/d08fd89cdeba1a152c4c0b30c6774411.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*__3P3R2PkWpr-SihqlLdhA.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Screen shot of Prometheus expression browser showing CPU (top) and memory (bottom) usage of an NGINX container.</figcaption></figure><div class=""/><blockquote class="jg"><p id="a5da" class="jh ji ij bd jj jk jl jm jn jo jp jq ek translated">快速问题:你知道你的应用消耗多少内存吗？CPU时间怎么样？交通高峰怎么办？在资源消耗的背景下，你如何处理这个问题？</p><p id="ead1" class="jh ji ij bd jj jk jr js jt ju jv jq ek translated">您是否手动管理每个容器的内存和CPU限制？或者，也许你还不在那里。也许这整个资源消耗和约束对你来说是全新的。请继续阅读。</p></blockquote><p id="06d9" class="pw-post-body-paragraph jw jx ij jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks jq hn dt translated"><strong class="jy ik">TL；DR:在Kubernetes中，设置容器的CPU和内存资源需求是很重要的，我们现在要自动化这个过程。</strong></p></div><div class="ab cl kt ku hc kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hn ho hp hq hr"><h1 id="55c3" class="la lb ij bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">何必呢？</h1><p id="cf53" class="pw-post-body-paragraph jw jx ij jy b jz ly kb kc kd lz kf kg kh ma kj kk kl mb kn ko kp mc kr ks jq hn dt translated">为什么您真的要担心Kubernetes集群中的容器消耗了多少内存和CPU呢？让我们看看从业者对这个话题有什么看法:</p><blockquote class="md me mf"><p id="85ad" class="jw jx mg jy b jz mh kb kc kd mi kf kg mj mk kj kk ml mm kn ko mn mo kr ks jq hn dt translated">不幸的是，Kubernetes还没有实现动态资源管理，这就是为什么我们必须为我们的容器设置资源限制。<br/>我想象在某个时候，Kubernetes将开始实施一种更少人工的方式来管理资源，但这是我们目前所拥有的一切。</p></blockquote><p id="8e14" class="pw-post-body-paragraph jw jx ij jy b jz mh kb kc kd mi kf kg kh mk kj kk kl mm kn ko kp mo kr ks jq hn dt translated">Ben Visser，2016年12月:<a class="ae mp" href="http://www.noqcks.io/note/kubernetes-resources-limits/" rel="noopener ugc nofollow" target="_blank"> Kubernetes —了解资源</a></p><blockquote class="md me mf"><p id="1d75" class="jw jx mg jy b jz mh kb kc kd mi kf kg mj mk kj kk ml mm kn ko mn mo kr ks jq hn dt translated"><a class="ae mp" href="https://hackernoon.com/tagged/kubernetes" rel="noopener ugc nofollow" target="_blank"> <em class="ij"> Kubernetes </em> </a> <em class="ij">没有动态资源分配，这意味着请求和限制必须由用户决定和设置。对于一个</em> <a class="ae mp" href="https://hackernoon.com/tagged/service" rel="noopener ugc nofollow" target="_blank"> <em class="ij">服务</em> </a> <em class="ij">来说，当这些数字不精确时，一个好的方法是用高估的资源请求和无限制来启动它，然后让它在正常的生产负载下运行一段时间:根据服务的性质是几小时、几天、几周。</em></p></blockquote><p id="4fb4" class="pw-post-body-paragraph jw jx ij jy b jz mh kb kc kd mi kf kg kh mk kj kk kl mm kn ko kp mo kr ks jq hn dt translated">Antoine Cotten，2016年5月:<a class="ae mp" href="https://acotten.com/post/1year-kubernetes" rel="noopener ugc nofollow" target="_blank"> 1年，从0到Kubernetes转型的经验教训</a></p><p id="6a71" class="pw-post-body-paragraph jw jx ij jy b jz mh kb kc kd mi kf kg kh mk kj kk kl mm kn ko kp mo kr ks jq hn dt translated">现在，事实证明，谷歌——在<a class="ae mp" href="https://research.google.com/pubs/pub43438.html" rel="noopener ugc nofollow" target="_blank"> Borg </a>的背景下——有这样一个资源消耗预测器/调节器，叫做<em class="mg"> autopilot </em>，它实际上提供了一个自动的资源消耗管理。</p><p id="92c3" class="pw-post-body-paragraph jw jx ij jy b jz mh kb kc kd mi kf kg kh mk kj kk kl mm kn ko kp mo kr ks jq hn dt translated">在KubeCon 2016上提出这个话题的人是:<em class="mg"> Tim Hockin </em>，他是Kubernetes早期的委员之一，当时它还是一个谷歌内部项目:</p><figure class="mr ms mt mu fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mq"><img src="../Images/2411d2d2941b7e86a6a97bb41115bac1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AZyB4vi0NZPzagI8hLNF2w.png"/></div></div></figure><p id="eb28" class="pw-post-body-paragraph jw jx ij jy b jz mh kb kc kd mi kf kg kh mk kj kk kl mm kn ko kp mo kr ks jq hn dt translated">正如聪明的蒂姆在他的演讲<em class="mg">中所说的，关于资源调度</em>(同时，查看<a class="ae mp" href="https://speakerdeck.com/thockin/everything-you-ever-wanted-to-know-about-resource-scheduling-dot-dot-dot-almost" rel="noopener ugc nofollow" target="_blank">幻灯片</a>和<a class="ae mp" href="https://www.youtube.com/watch?v=nWGkvrIPqJ4" rel="noopener ugc nofollow" target="_blank">视频</a>):</p><blockquote class="jg"><p id="e4f5" class="jh ji ij bd jj jk jr js jt ju jv jq ek translated">大约2/3的博格用户使用自动驾驶仪。</p></blockquote><p id="156c" class="pw-post-body-paragraph jw jx ij jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks jq hn dt translated">这听起来挺有说服力的；超过一半的Borg用户似乎不仅乐于明确设置资源消耗，而且乐于将这项工作委托给autopilot。</p><p id="5144" class="pw-post-body-paragraph jw jx ij jy b jz mh kb kc kd mi kf kg kh mk kj kk kl mm kn ko kp mo kr ks jq hn dt translated"><em class="mg">回到Kubernetes。</em></p><p id="e382" class="pw-post-body-paragraph jw jx ij jy b jz mh kb kc kd mi kf kg kh mk kj kk kl mm kn ko kp mo kr ks jq hn dt translated">早在2015年年中，我们就发现Kubernetes社区——从谷歌的<em class="mg">自动驾驶</em>体验中获得信息——提出了一个<a class="ae mp" href="https://github.com/kubernetes/kubernetes/issues/10782" rel="noopener ugc nofollow" target="_blank">问题</a>,以捕捉对自动化资源消耗管理的需求。在2017年初，相应的<a class="ae mp" href="https://github.com/kubernetes/community/pull/338" rel="noopener ugc nofollow" target="_blank">设计方案</a>已经完成，现在关于由此产生的垂直吊舱自动定标器(<a class="ae mp" href="https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler" rel="noopener ugc nofollow" target="_blank"> VPA </a>)的初步工作正在进行中。</p><h1 id="22a7" class="la lb ij bd lc ld mw lf lg lh mx lj lk ll my ln lo lp mz lr ls lt na lv lw lx dt translated">一个演示者:resorcerer</h1><p id="a3cb" class="pw-post-body-paragraph jw jx ij jy b jz ly kb kc kd lz kf kg kh ma kj kk kl mb kn ko kp mc kr ks jq hn dt translated">为了收集问题领域的经验——评估容器资源消耗并相应地调整容器——我们建立了一个POC，一个名为<a class="ae mp" href="https://github.com/mhausenblas/resorcerer" rel="noopener ugc nofollow" target="_blank">resource rer</a>的演示器。</p><p id="076d" class="pw-post-body-paragraph jw jx ij jy b jz mh kb kc kd mi kf kg kh mk kj kk kl mm kn ko kp mo kr ks jq hn dt translated">查看resorcerer的<a class="ae mp" href="https://www.useloom.com/share/41e14ed4a4d349e294ad717dfda58956" rel="noopener ugc nofollow" target="_blank">视频演练</a>，我将向您展示如何在Kubernetes集群中使用它(实际上是在一个名称空间中)，它是如何工作的以及有哪些限制:</p><figure class="mr ms mt mu fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nb"><img src="../Images/c4379b76a6af062ba0a2e5ac93ee910c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rzeem44nMyXaIvboQom_-g.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">A <a class="ae mp" href="https://www.useloom.com/share/41e14ed4a4d349e294ad717dfda58956" rel="noopener ugc nofollow" target="_blank">video walkthrough</a> of resorcerer, its features and inner workings (~27min).</figcaption></figure><h1 id="fe25" class="la lb ij bd lc ld mw lf lg lh mx lj lk ll my ln lo lp mz lr ls lt na lv lw lx dt translated">引擎盖下:繁重的工作由普罗米修斯完成</h1><p id="d866" class="pw-post-body-paragraph jw jx ij jy b jz ly kb kc kd lz kf kg kh ma kj kk kl mb kn ko kp mc kr ks jq hn dt translated">为了提出资源消耗限制的建议，resorcerer演示者利用了<a class="ae mp" href="https://prometheus.io" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>。例如，要确定某个容器在过去30分钟内的CPU使用率，我们可以使用以下PromQL查询:</p><pre class="mr ms mt mu fq nc nd ne nf aw ng dt"><span id="f361" class="nh lb ij nd b fv ni nj l nk nl">sum(rate(container_cpu_usage_seconds_total{pod_name=~"nginx.+", container_name="nginx"}[30m]))</span></pre><p id="a5c8" class="pw-post-body-paragraph jw jx ij jy b jz mh kb kc kd mi kf kg kh mk kj kk kl mm kn ko kp mo kr ks jq hn dt translated">这将导致如下结果:</p><figure class="mr ms mt mu fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nm"><img src="../Images/8db55676f34f3d18070956ece5bea525.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*voArC9zaThZx9jqUYbp0tg.png"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Screen shot of Prometheus, showing container CPU usage over time.</figcaption></figure><p id="c6e2" class="pw-post-body-paragraph jw jx ij jy b jz mh kb kc kd mi kf kg kh mk kj kk kl mm kn ko kp mo kr ks jq hn dt translated">这里棘手的部分是选择有意义的PromQL查询以及观察时间段的正确参数。首先，考虑三种情况:</p><ul class=""><li id="4525" class="nn no ij jy b jz mh kd mi kh np kl nq kp nr jq ns nt nu nv dt translated"><em class="mg">空闲</em>—容器上没有负载，这是所需的CPU/内存资源的最小<em class="mg">数量</em>。</li><li id="d60c" class="nn no ij jy b jz nw kd nx kh ny kl nz kp oa jq ns nt nu nv dt translated"><em class="mg">正常</em>—对容器进行更长时间(数天或数周)的观察，并计算出基线；这是<em class="mg">运营所需资源的典型案例</em>。</li><li id="c5cb" class="nn no ij jy b jz nw kd nx kh ny kl nz kp oa jq ns nt nu nv dt translated"><em class="mg">秒杀</em>——想想一个外部事件，比如一个半价销售活动或在一个受欢迎的新闻媒体上提及，为你的应用程序带来大量流量；这是您仍然希望能够适应的资源消耗的例外情况。</li></ul><p id="26ad" class="pw-post-body-paragraph jw jx ij jy b jz mh kb kc kd mi kf kg kh mk kj kk kl mm kn ko kp mo kr ks jq hn dt translated">在上面的案例区分中，我们方便地只考虑了无状态应用程序的简单情况，比如应用服务器或Web服务器。对于有状态服务来说，事情确实变得相当复杂，例如，涉及到数据库。</p><p id="5030" class="pw-post-body-paragraph jw jx ij jy b jz mh kb kc kd mi kf kg kh mk kj kk kl mm kn ko kp mo kr ks jq hn dt translated">在resorcerer的背景下，我们要感谢<a class="ae mp" href="https://twitter.com/juliusvolz" rel="noopener ugc nofollow" target="_blank">朱利叶斯·沃尔茨</a>对Prometheus scraping和PromQL的支持，以及<a class="ae mp" href="https://twitter.com/the1stein" rel="noopener ugc nofollow" target="_blank">斯蒂芬·希曼斯基</a>，他帮助导航了Kubernetes <a class="ae mp" href="https://godoc.org/k8s.io/client-go" rel="noopener ugc nofollow" target="_blank"> client-go </a>库的棘手部分。</p></div><div class="ab cl kt ku hc kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hn ho hp hq hr"><h1 id="d6e2" class="la lb ij bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx dt translated">前方的路</h1><p id="ec22" class="pw-post-body-paragraph jw jx ij jy b jz ly kb kc kd lz kf kg kh ma kj kk kl mb kn ko kp mc kr ks jq hn dt translated">容器资源消耗的话题是一个重要的话题，我希望我的上述观点能引起你的注意。在Kubernetes中，我们正处于旅程的起点，我们需要收集更多关于资源消耗管理自动化的经验。</p><p id="ed7c" class="pw-post-body-paragraph jw jx ij jy b jz mh kb kc kd mi kf kg kh mk kj kk kl mm kn ko kp mo kr ks jq hn dt translated">Kubernetes垂直Pod自动缩放器(VPA)的官方工作现在正在<a class="ae mp" href="https://github.com/kubernetes/community/tree/master/sig-autoscaling" rel="noopener ugc nofollow" target="_blank"> SIG自动缩放</a>中进行，所以现在是开始贡献用例和/或分享您的需求以及经验的好时机。您可以加入我们的<a class="ae mp" href="http://slack.k8s.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes Slack </a>社区、#sig-autoscaling频道，也可以通过<a class="ae mp" href="https://groups.google.com/forum/#!forum/kubernetes-sig-autoscaling" rel="noopener ugc nofollow" target="_blank">邮件列表</a>参与，或者参加大约每两周举行一次的<a class="ae mp" href="https://docs.google.com/document/d/1RvhQAEIrVLHbyNnuaT99-6u9ZUMp7BfkPupT2LAZK7w/" rel="noopener ugc nofollow" target="_blank">周四在线会议</a>。</p><figure class="mr ms mt mu fq hw"><div class="bz el l di"><div class="ob oc l"/></div></figure></div></div>    
</body>
</html>