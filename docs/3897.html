<html>
<head>
<title>Let’s Build a Web App with Vue, Chart.js and an API Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们用Vue、Chart.js和API Part II构建一个Web应用程序</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/lets-build-a-web-app-with-vue-chart-js-and-an-api-part-ii-39781b1d5acf?source=collection_archive---------3-----------------------#2017-04-30">https://medium.com/hackernoon/lets-build-a-web-app-with-vue-chart-js-and-an-api-part-ii-39781b1d5acf?source=collection_archive---------3-----------------------#2017-04-30</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/902c2af80f63d6ccdf0ded6afa8ceb4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rsTJUWzJ4SS0NNAI45USFw.png"/></div></div></figure><div class=""/><div class=""><h2 id="2a78" class="pw-subtitle-paragraph jc ie if bd b jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ek translated">构建与npm api交互并生成图表的webapp的第二部分</h2></div><p id="4f92" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt kq translated"><span class="l kr ks kt bm ku kv kw kx ky di">如果</span>你错过了第一部分，你可以在这里<a class="ae kz" href="https://hackernoon.com/lets-build-a-web-app-with-vue-chart-js-and-an-api-544eb81c4b44" rel="noopener ugc nofollow" target="_blank">找到</a>。首先哇！感谢所有的反馈和twitter消息！💝我从未想到会有如此广泛的观众。但是够了。让我们开始工作吧💪。</p><h2 id="4fff" class="la lb if bd lc ld le lf lg lh li lj lk kd ll lm ln kh lo lp lq kl lr ls lt lu dt translated">⚡快速入门</h2><p id="1907" class="pw-post-body-paragraph ju jv if jw b jx lv jg jz ka lw jj kc kd lx kf kg kh ly kj kk kl lz kn ko kp hn dt translated">所以，我们正在建造npm-stats.org。使用<a class="ae kz" href="https://vuejs.org/" rel="noopener ugc nofollow" target="_blank"> Vue.js </a>、<a class="ae kz" href="http://vue-chartjs.org/#/" rel="noopener ugc nofollow" target="_blank"> vue-chartjs </a>和<a class="ae kz" href="npmjs.org" rel="noopener ugc nofollow" target="_blank"> npm </a> API构建的小型web应用程序，用于获取软件包的下载统计数据并基于这些数据生成图表。</p><h2 id="801c" class="la lb if bd lc ld le lf lg lh li lj lk kd ll lm ln kh lo lp lq kl lr ls lt lu dt translated">我们到目前为止所做的</h2><p id="a71f" class="pw-post-body-paragraph ju jv if jw b jx lv jg jz ka lw jj kc kd lx kf kg kh ly kj kk kl lz kn ko kp hn dt translated">简单回顾一下我们在第1部分中构建的内容:</p><ul class=""><li id="f37d" class="ma mb if jw b jx jy ka kb kd mc kh md kl me kp mf mg mh mi dt translated">✅用<code class="eh mj mk ml mm b">vue-init</code>创建一个vue.js应用程序</li><li id="f1b5" class="ma mb if jw b jx mn ka mo kd mp kh mq kl mr kp mf mg mh mi dt translated">✅安装依赖项并设置<code class="eh mj mk ml mm b">vue-router</code></li><li id="c060" class="ma mb if jw b jx mn ka mo kd mp kh mq kl mr kp mf mg mh mi dt translated">✅用<code class="eh mj mk ml mm b">vue-chartjs</code>创建一个折线图组件</li><li id="8007" class="ma mb if jw b jx mn ka mo kd mp kh mq kl mr kp mf mg mh mi dt translated">✅对npm进行API调用，并呈现上个月的每日下载统计数据</li></ul><p id="4368" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">这已经很多了。最后我们运行了我们的应用程序。然而，总有改进的空间！</p><h2 id="63ed" class="la lb if bd lc ld le lf lg lh li lj lk kd ll lm ln kh lo lp lq kl lr ls lt lu dt translated">我们今天要做的事情:</h2><ul class=""><li id="b676" class="ma mb if jw b jx lv ka lw kd ms kh mt kl mu kp mf mg mh mi dt translated">⚙添加设置以更改开始和结束期间</li><li id="cec3" class="ma mb if jw b jx mn ka mo kd mp kh mq kl mr kp mf mg mh mi dt translated">📆集成外部日期选择器组件</li><li id="5d0b" class="ma mb if jw b jx mn ka mo kd mp kh mq kl mr kp mf mg mh mi dt translated">📈改变我们的数据，添加一个年度统计图</li><li id="b89f" class="ma mb if jw b jx mn ka mo kd mp kh mq kl mr kp mf mg mh mi dt translated">🔨重构我们的方法，稍微干燥一下，这样我们就可以轻松地添加更多的图表</li></ul><h2 id="70ed" class="la lb if bd lc ld le lf lg lh li lj lk kd ll lm ln kh lo lp lq kl lr ls lt lu dt translated">⚙设置</h2><p id="4553" class="pw-post-body-paragraph ju jv if jw b jx lv jg jz ka lw jj kc kd lx kf kg kh ly kj kk kl lz kn ko kp hn dt kq translated">现在我们的默认周期被设置为<code class="eh mj mk ml mm b">last-month</code>，但是如果我们可以设置开始周期和结束周期，那就太棒了。这样我们可以检查一整年或更长时间的统计数据。</p><p id="2940" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">为此，我们需要添加两个额外的输入字段和数据模型。但是为了更好的用户体验，我们将引入一个外部的日期选择器组件。我们不必重新发明轮子，对吗？👨‍🔬为了正确格式化我们的日期，我们还将引入moment.js</p><figure class="mw mx my mz fq hw fe ff paragraph-image"><div class="fe ff mv"><img src="../Images/797601e5a34fe265fe32b4aaf0857c36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/1*5efC00Bu1w0pX-UBlNFjug.png"/></div><figcaption class="na nb fg fe ff nc nd bd b be z ek">Datepicker</figcaption></figure><p id="1ac4" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated"><strong class="jw ig">📆安装依赖关系</strong></p><p id="a2bc" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated"><code class="eh mj mk ml mm b">yarn add vuejs-datepicker moment</code></p><p id="e49e" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">Todos为我们的<strong class="jw ig">开始。vue </strong>:</p><ul class=""><li id="3cdf" class="ma mb if jw b jx jy ka kb kd mc kh md kl me kp mf mg mh mi dt translated">导入日期选择器</li><li id="0595" class="ma mb if jw b jx mn ka mo kd mp kh mq kl mr kp mf mg mh mi dt translated">为开始和结束期间添加两个datepicker字段</li><li id="97a0" class="ma mb if jw b jx mn ka mo kd mp kh mq kl mr kp mf mg mh mi dt translated">添加两个数据模型</li></ul><pre class="mw mx my mz fq ne mm nf ng aw nh dt"><span id="154b" class="la lb if mm b fv ni nj l nk nl">// Start.vue<br/><br/>&lt;template&gt;<br/><br/>...<br/><br/>&lt;datepicker placeholder="Start Date" v-model="periodStart" name="start-date"&gt;&lt;/datepicker&gt;<br/>&lt;datepicker placeholder="Start Date" v-model="periodStart" name="start-date"&gt;&lt;/datepicker&gt;<br/><br/>...<br/><br/>&lt;/template&gt;<br/><br/>&lt;script&gt;<br/>  import axios from 'axios'<br/>  import Datepicker from 'vuejs-datepicker'<br/>  import LineChart from '@/components/LineChart'<br/>  <br/>  export default {<br/>    components: {<br/>      LineChart,<br/>      Datepicker<br/>    },<br/>    data () {<br/>      return {<br/>        package: null,<br/>        packageName: '',<br/>        loaded: false,<br/>        downloads: [],<br/>        labels: [],<br/>        showError: false,<br/>        errorMessage: 'Please enter a package name',<br/>        periodStart: '',<br/>        periodEnd: new Date()<br/>      }<br/>    },<br/>    <br/>    .....<br/>}<br/> <br/>&lt;/script&gt;</span></pre><p id="8648" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">我们还删除了旧的设置为<code class="eh mj mk ml mm b">last-month</code>的<code class="eh mj mk ml mm b">period</code>数据模型。因为周期现在将由<code class="eh mj mk ml mm b">periodStart</code>和<code class="eh mj mk ml mm b">periodEnd</code>组成。我们还将<code class="eh mj mk ml mm b">periodEnd</code>设置为当前日期。因为大多数时候你只会改变开始日期。</p><p id="4e87" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">我们需要这样的格式:<code class="eh mj mk ml mm b">2017-04-18:2017-04-30</code>。然而，如果我们现在选择一个日期，我们会得到这样的结果:<code class="eh mj mk ml mm b">2017-04-17T22:00:00.000Z</code>。带有时间属性的<code class="eh mj mk ml mm b">Date()</code>，这是我们不需要的。这对于<code class="eh mj mk ml mm b">moment.js</code>来说是一份不错的工作。</p><h2 id="9b30" class="la lb if bd lc ld le lf lg lh li lj lk kd ll lm ln kh lo lp lq kl lr ls lt lu dt translated">计算周期</h2><p id="03c0" class="pw-post-body-paragraph ju jv if jw b jx lv jg jz ka lw jj kc kd lx kf kg kh ly kj kk kl lz kn ko kp hn dt translated">对于这种情况，我们有<a class="ae kz" href="https://vuejs.org/v2/guide/computed.html" rel="noopener ugc nofollow" target="_blank">计算属性</a>，这是一种愉快的工作。为了让事情更清楚，我们将创建三个属性。格式化的开始日期、格式化的结束日期和合成周期。</p><pre class="mw mx my mz fq ne mm nf ng aw nh dt"><span id="79f5" class="la lb if mm b fv ni nj l nk nl">computed: {<br/>  _endDate () {<br/>    return moment(this.periodEnd).format('YYYY-MM-DD')<br/>  },<br/>  _startDate () {<br/>    return moment(this.periodStart).format('YYYY-MM-DD')<br/>  },<br/>  period () {<br/>    return this.periodStart ? <br/>           `${this._startDate}:${this._endDate}` : <br/>           'last-month'<br/>  }<br/>},</span></pre><p id="d06a" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">如果没有设置开始日期，我们希望保持获取上个月数据的默认行为，因此我们将我们的条件添加到<code class="eh mj mk ml mm b">period</code>属性中。</p><p id="9ae7" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">就是这样！我们不需要改变我们的请求，因为我们只是替换了我们在请求中使用的<code class="eh mj mk ml mm b">period</code>的内容。你可以在这个<a class="ae kz" href="https://github.com/apertureless/npm-stats/tree/feature/date_settings_%234" rel="noopener ugc nofollow" target="_blank">特性分支</a>中查看github上的代码</p><h2 id="b89c" class="la lb if bd lc ld le lf lg lh li lj lk kd ll lm ln kh lo lp lq kl lr ls lt lu dt translated">📈更多图表</h2><p id="f00f" class="pw-post-body-paragraph ju jv if jw b jx lv jg jz ka lw jj kc kd lx kf kg kh ly kj kk kl lz kn ko kp hn dt translated">嗯，有每日统计数据的图表很棒。但是我们可以产生更多！我们有所有需要的数据。我们不会转换和分组我们的数据，所以我们可以将它传递到另一个年度统计折线图。我们将重构一些代码。</p><h2 id="216d" class="la lb if bd lc ld le lf lg lh li lj lk kd ll lm ln kh lo lp lq kl lr ls lt lu dt translated">所有这些数据</h2><figure class="mw mx my mz fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nm"><img src="../Images/869cc4ca9cc222185c73257eb9949129.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dvc1IR3c1A13TZVyHpdbjA.jpeg"/></div></div></figure><p id="6a1a" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">因此，我们从npm api获得的数据如下所示:</p><pre class="mw mx my mz fq ne mm nf ng aw nh dt"><span id="0b7e" class="la lb if mm b fv ni nj l nk nl">data: [<br/>{day: "2017-04-18", downloads: 16280},<br/>{day: "2017-04-19", downloads: 14280},<br/>{day: "2017-04-20", downloads: 17280}<br/>]</span></pre><p id="f085" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">但是要将它传递给我们的图表，我们需要两个数组，一个是标签(<em class="nn">日</em>)和一个是数据(<em class="nn">下载</em>)。对于每日统计，这很容易。因为我们可以简单地使用<code class="eh mj mk ml mm b">map()</code>来获取数据和标签。然而，现在我们需要做更多的工作。</p><ol class=""><li id="9f0b" class="ma mb if jw b jx jy ka kb kd mc kh md kl me kp no mg mh mi dt translated">将我们的<code class="eh mj mk ml mm b">day</code>键格式化为年份。</li><li id="5563" class="ma mb if jw b jx mn ka mo kd mp kh mq kl mr kp no mg mh mi dt translated">对于标签，去掉重复的部分，这样我们就只有唯一的年份了</li><li id="925c" class="ma mb if jw b jx mn ka mo kd mp kh mq kl mr kp no mg mh mi dt translated">将同一年的所有下载量相加。</li></ol><p id="525d" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">☝:但首先，这是一个重构我们代码的好时机。我们看到第一步是将日期格式化为一年。之后，如果我们想要月度统计数据，我们需要将其格式化为月度格式，以此类推。所以现在是引入一个助手方法并从<strong class="jw ig"> Start.vue </strong>文件中提取逻辑的好时机。</p><p id="8f8c" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">所以我们创建了<code class="eh mj mk ml mm b">src/utils/dateFormatter.js</code>，它将帮助我们格式化我们的日期。</p><pre class="mw mx my mz fq ne mm nf ng aw nh dt"><span id="141a" class="la lb if mm b fv ni nj l nk nl">import moment from 'moment'<br/>  <br/>export const dateToYear = date =&gt; moment(date).format('YYYY')<br/>export const dateToMonth = date =&gt; moment(date).format('MMM YYYY')<br/>export const dateToWeek = date =&gt; moment(date).format('GGGG-[W]WW')<br/>export const dateToDay = date =&gt; moment(date).format('YYYY-MM-DD')<br/>export const dateBeautify = date =&gt; moment(date).format('Do MMMM YYYY')</span></pre><p id="8cf7" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">在我们的<strong class="jw ig"> Start.vue </strong>中，我们现在可以删除<code class="eh mj mk ml mm b">moment</code> import并导入我们的助手模块，并用它们替换moment语句。(在我们的<code class="eh mj mk ml mm b">_startPeriod</code>和<code class="eh mj mk ml mm b">_endPeriod</code>。我们添加了一个新的计算属性，它将替换图表容器中的<code class="eh mj mk ml mm b">period</code>。</p><pre class="mw mx my mz fq ne mm nf ng aw nh dt"><span id="07f0" class="la lb if mm b fv ni nj l nk nl">import { dateToYear, dateToDay, dateBeautify } from '../utils/dateFormatter'<br/>  <br/>  computed: {<br/>    _endDate () {<br/>      return dateToDay(this.periodEnd)<br/>    },<br/>    _startDate () {<br/>      return dateToDay(this.periodStart)<br/>    },<br/>    period () {<br/>      return this.periodStart ?  `${this._startDate}:${this._endDate}` : 'last-month'<br/>    },<br/>    formattedPeriod () {<br/>      return this.periodStart ? `${dateBeautify(this._startDate)} - ${dateBeautify(this._endDate)}` : 'last-month'<br/>    }<br/>  },</span></pre><figure class="mw mx my mz fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff np"><img src="../Images/612f2392a48d65f094c15ea99e760985.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ms5y_4ltcsMvWTv6tedMGQ.png"/></div></div><figcaption class="na nb fg fe ff nc nd bd b be z ek">Chart with formattedPeriod in title</figcaption></figure><h2 id="8847" class="la lb if bd lc ld le lf lg lh li lj lk kd ll lm ln kh lo lp lq kl lr ls lt lu dt translated">是时候转型了</h2><p id="ced6" class="pw-post-body-paragraph ju jv if jw b jx lv jg jz ka lw jj kc kd lx kf kg kh ly kj kk kl lz kn ko kp hn dt translated">现在我们创建三个新的数据模型<code class="eh mj mk ml mm b">rawData</code>，它们将保存我们从api调用<code class="eh mj mk ml mm b">downloadsYear: []</code>和<code class="eh mj mk ml mm b">labelsYear: []</code>中获得的下载数据。我们创建了一个叫做<code class="eh mj mk ml mm b">formatYear()</code>的新方法。</p><p id="917f" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">在我们的axios请求承诺中，我们然后将data.downloads分配给<code class="eh mj mk ml mm b">rawData</code>并调用<code class="eh mj mk ml mm b">formatYear()</code>。</p><pre class="mw mx my mz fq ne mm nf ng aw nh dt"><span id="d253" class="la lb if mm b fv ni nj l nk nl">axios.get(`https://api.npmjs.org/downloads/range/${this.period}/${this.package}`)<br/>    .then(response =&gt; {<br/>      this.rawData = response.data.downloads // 🆕<br/>      this.downloads = response.data.downloads.map(entry =&gt; entry.downloads)<br/>      this.labels = response.data.downloads.map(entry =&gt; entry.day)<br/>      this.packageName = response.data.package<br/>      this.formatYear() // 🆕<br/>      this.setURL()<br/>      this.loaded = true<br/>      <br/>    })</span></pre><p id="90cb" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">现在我们将创建两个额外的助手方法。因为我们希望将来有不同的数据转换。比如每周统计和每月统计。为了保持组件的整洁，我们将它们提取到一个单独的文件中。</p><p id="7348" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">所以我们创建了我们的<code class="eh mj mk ml mm b">src/utils/downloadFormatter.js</code>，它将包含两个方法:</p><ol class=""><li id="8aa1" class="ma mb if jw b jx jy ka kb kd mc kh md kl me kp no mg mh mi dt translated">removeDuplicate (a，b) {..}</li><li id="7969" class="ma mb if jw b jx mn ka mo kd mp kh mq kl mr kp no mg mh mi dt translated">getDownloadsPerYear(data) {…}</li></ol><p id="5857" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">在我们的<strong class="jw ig"> Start.vue </strong>中，我们导入了这两个模块，现在我们可以在我们的<code class="eh mj mk ml mm b">formatYear()</code>方法中使用它们。</p><pre class="mw mx my mz fq ne mm nf ng aw nh dt"><span id="99af" class="la lb if mm b fv ni nj l nk nl">formatYear () {<br/>  this.labelsYear = this.rawData<br/>    .map(entry =&gt; dateToYear(entry.day))<br/>    .reduce(removeDuplicate, [])<br/>  this.downloadsYear = getDownloadsPerYear(this.rawData)<br/>},</span></pre><p id="48c2" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">现在有点棘手了。通常我会写下我的方法，然后再清理。不过，我希望你能跟我到这里。</p><p id="cd7a" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">首先我们需要得到年份，对吗？因此，我们再次使用<code class="eh mj mk ml mm b">map()</code>来获取<code class="eh mj mk ml mm b">day</code>键，就像我们在请求每日统计数据时所做的那样。但是现在我们用我们的<code class="eh mj mk ml mm b">dateToYear()</code>助手来格式化它。所以现在我们的数据看起来像这样:</p><pre class="mw mx my mz fq ne mm nf ng aw nh dt"><span id="c948" class="la lb if mm b fv ni nj l nk nl">data: [<br/>{day: "2017", downloads: 16280},<br/>{day: "2017", downloads: 14280},<br/>{day: "2017", downloads: 17280}<br/>]</span></pre><p id="889a" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">现在我们将使用<code class="eh mj mk ml mm b">reduce()</code>删除重复的年份。因为我们的标签数组只有唯一的年份。因为我们可能不止一次使用它，所以我们将它提取到我们的<code class="eh mj mk ml mm b">downloadFormatter.js</code></p><p id="5a69" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">在我们的<strong class="jw ig"> downloadFormatter.js </strong>中，我们现在完成了removeDuplicate函数。</p><pre class="mw mx my mz fq ne mm nf ng aw nh dt"><span id="2f42" class="la lb if mm b fv ni nj l nk nl">export function removeDuplicate (a, b) {<br/>    if (a.indexOf(b) &lt; 0) {<br/>      a.push(b)<br/>    }<br/>    return a<br/>  }</span></pre><p id="828d" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">现在我们的<code class="eh mj mk ml mm b">this.labelYear</code>数组将只包含唯一的年份。是时候对我们的数据进行分组和转换了。为此，我们将再次使用<code class="eh mj mk ml mm b">map()</code>和<code class="eh mj mk ml mm b">reduce()</code>和<code class="eh mj mk ml mm b">filter()</code>。</p><p id="69f6" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated"><code class="eh mj mk ml mm b">rawData</code>看起来是这样的:</p><pre class="mw mx my mz fq ne mm nf ng aw nh dt"><span id="c51b" class="la lb if mm b fv ni nj l nk nl">data: [<br/>{day: "2017-04-18", downloads: 16280},<br/>{day: "2017-04-19", downloads: 14280},<br/>{day: "2017-04-20", downloads: 17280}<br/>]</span></pre><p id="2738" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">所以首先我们需要再次找到唯一的日期。我们用<code class="eh mj mk ml mm b">reduce()</code>做这个，然后我们把一个<code class="eh mj mk ml mm b">map()</code>链接到它，返回一个带有日期和该日期内的下载的对象。这就是为什么我们在那里使用<code class="eh mj mk ml mm b">filter()</code>和我们的<code class="eh mj mk ml mm b">dateToYear()</code>助手。</p><p id="6c72" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">然而，我们的数据现在看起来像这样:</p><figure class="mw mx my mz fq hw fe ff paragraph-image"><div class="fe ff nq"><img src="../Images/01f8c8d8bc3c71200d05747573a84c11.png" data-original-src="https://miro.medium.com/v2/resize:fit:504/format:webp/1*O49eVMPIRWNBVyZMoFExVA.png"/></div><figcaption class="na nb fg fe ff nc nd bd b be z ek">First reduce</figcaption></figure><p id="112d" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">但是因为我们现在不需要日期，我们<code class="eh mj mk ml mm b">map</code>它只用于下载，然后使用<code class="eh mj mk ml mm b">reduce()</code>来总结它。现在我们的对象将包含今年所有下载的总和。然而，它是嵌套的，我们仍然有日期键。</p><figure class="mw mx my mz fq hw fe ff paragraph-image"><div class="fe ff nr"><img src="../Images/16e3d1f8cd32de0e6d81015d653dc004.png" data-original-src="https://miro.medium.com/v2/resize:fit:444/format:webp/1*UwiR7ow8qxlBX3l1_sVbGA.png"/></div><figcaption class="na nb fg fe ff nc nd bd b be z ek">After map and second reduce</figcaption></figure><p id="0d66" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">但是最后一个<code class="eh mj mk ml mm b">map()</code>会解决这个问题。</p><pre class="mw mx my mz fq ne mm nf ng aw nh dt"><span id="46fb" class="la lb if mm b fv ni nj l nk nl">export const getDownloadsPerYear = (data) =&gt; {<br/>    // Find unique dates<br/>    return data.reduce((date, current) =&gt; {<br/>      if (date.indexOf(dateToYear(current.day)) &lt; 0) {<br/>        date.push(dateToYear(current.day))<br/>      }<br/>      return date<br/>    }, [])<br/>      .map((date) =&gt; {<br/>        return {<br/>          date: date,<br/>          downloads: data.filter(el =&gt; dateToYear(el.day) === date)<br/>            .map(el =&gt; el.downloads)<br/>            .reduce((total, download) =&gt; total + download)<br/>        }<br/>      })<br/>      .map(element =&gt; element.downloads)<br/>  }</span></pre><h2 id="25a6" class="la lb if bd lc ld le lf lg lh li lj lk kd ll lm ln kh lo lp lq kl lr ls lt lu dt translated">图表时间</h2><p id="5a25" class="pw-post-body-paragraph ju jv if jw b jx lv jg jz ka lw jj kc kd lx kf kg kh ly kj kk kl lz kn ko kp hn dt translated">现在我们已经完成了转换，可以复制第一个图表的模板并传入<code class="eh mj mk ml mm b">downloadsYear</code>道具。</p><figure class="mw mx my mz fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff ns"><img src="../Images/66bd730c403e9a535a8daede98123093.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WgX8Fm5LSM_YnUZazTCPVw.png"/></div></div><figcaption class="na nb fg fe ff nc nd bd b be z ek">Downloads per Year Chart</figcaption></figure><p id="9657" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated"><strong class="jw ig">您可以在此</strong> <a class="ae kz" href="https://github.com/apertureless/npm-stats/tree/feature/yearly_chart" rel="noopener ugc nofollow" target="_blank"> <strong class="jw ig">特征分支</strong> </a>查看到目前为止的源代码</p><h2 id="3dcb" class="la lb if bd lc ld le lf lg lh li lj lk kd ll lm ln kh lo lp lq kl lr ls lt lu dt translated">🔨重构和更多图表</h2><p id="7d99" class="pw-post-body-paragraph ju jv if jw b jx lv jg jz ka lw jj kc kd lx kf kg kh ly kj kk kl lz kn ko kp hn dt translated">现在我们已经完成了数据转换器，添加新图表非常容易。比如每周统计和每月统计。我们可以复制我们的<code class="eh mj mk ml mm b">getDownloadsPerYear()</code>方法，并将我们的<code class="eh mj mk ml mm b">dateToYear()</code>助手改为<code class="eh mj mk ml mm b">dateToMonth()</code>。但是，这不是很干。因为我们最终会有很多方法做着几乎相同的事情。</p><p id="5c80" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">因此，让我们将我们特定的<code class="eh mj mk ml mm b">getDownloadsPerYear()</code>方法重构为一个更通用的方法。唯一会改变它的是我们的dateFormatter助手。所以我们应该把它作为一个论点，你可以传递给我们的方法。</p><ol class=""><li id="7227" class="ma mb if jw b jx jy ka kb kd mc kh md kl me kp no mg mh mi dt translated">将我们的方法重命名为更一般的名称，如<code class="eh mj mk ml mm b">groupData</code></li><li id="2e10" class="ma mb if jw b jx mn ka mo kd mp kh mq kl mr kp no mg mh mi dt translated">添加第二个参数，这将是我们的帮助函数</li><li id="9102" class="ma mb if jw b jx mn ka mo kd mp kh mq kl mr kp no mg mh mi dt">???</li><li id="5c8f" class="ma mb if jw b jx mn ka mo kd mp kh mq kl mr kp no mg mh mi dt translated">利润！</li></ol><pre class="mw mx my mz fq ne mm nf ng aw nh dt"><span id="8b87" class="la lb if mm b fv ni nj l nk nl">export const groupData = (data, dateFormatter) =&gt; {<br/>  return data.reduce((date, current) =&gt; {<br/>    if (date.indexOf(dateFormatter(current.day)) &lt; 0) {<br/>      date.push(dateFormatter(current.day))<br/>    }<br/>    return date<br/>  }, [])<br/>    .map((date) =&gt; {<br/>      return {<br/>        date: date,<br/>        downloads: data.filter(el =&gt; dateFormatter(el.day) === date)<br/>          .map(el =&gt; el.downloads)<br/>          .reduce((total, download) =&gt; total + download)<br/>      }<br/>    })<br/>    .map(element =&gt; element.downloads)<br/>}</span></pre><p id="5419" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">在我们的<strong class="jw ig"> Start.vue </strong>中，我们现在需要传递我们的助手函数。</p><pre class="mw mx my mz fq ne mm nf ng aw nh dt"><span id="0fe6" class="la lb if mm b fv ni nj l nk nl">this.downloadsYear = groupData(this.rawData, dateToYear)</span></pre><p id="f2fb" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">现在，我们也可以对我们的月度和周数据这样做，只需交换掉<code class="eh mj mk ml mm b">dateToYear</code></p><p id="9ccb" class="pw-post-body-paragraph ju jv if jw b jx jy jg jz ka kb jj kc kd ke kf kg kh ki kj kk kl km kn ko kp hn dt translated">您可以在这个<a class="ae kz" href="https://github.com/apertureless/npm-stats/tree/feature/monthly_chart" rel="noopener ugc nofollow" target="_blank">特性分支</a>中找到到目前为止的源代码，其中添加了一些内容，比如加载指示器和如果datepicker值发生更改，则重新获取数据，我在这里没有介绍。</p></div><div class="ab cl nt nu hc nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="hn ho hp hq hr"><blockquote class="oa ob oc"><p id="f7a5" class="ju jv nn jw b jx jy jg jz ka kb jj kc od ke kf kg oe ki kj kk of km kn ko kp hn dt translated">我希望你喜欢它并且学到一些东西。请随时给我反馈！✌</p><p id="a014" class="ju jv nn jw b jx jy jg jz ka kb jj kc od ke kf kg oe ki kj kk of km kn ko kp hn dt translated">你可以在<a class="ae kz" href="https://www.twitter.com/apertureless" rel="noopener ugc nofollow" target="_blank"> twitter </a>和<a class="ae kz" href="https://github.com/apertureless" rel="noopener ugc nofollow" target="_blank"> github </a>上关注我。</p></blockquote><div class="mw mx my mz fq ab cb"><figure class="og hw oh oi oj ok ol paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="og hw oh oi oj ok ol paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="og hw oh oi oj ok ol paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="oa ob oc"><p id="f922" class="ju jv nn jw b jx jy jg jz ka kb jj kc od ke kf kg oe ki kj kk of km kn ko kp hn dt translated"><a class="ae kz" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae kz" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae kz" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae kz" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ju jv nn jw b jx jy jg jz ka kb jj kc od ke kf kg oe ki kj kk of km kn ko kp hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kz" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kz" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="mw mx my mz fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff om"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>