<html>
<head>
<title>From 0 to 100% Coverage Real Quick</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从0到100%的覆盖率非常快</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/from-0-to-100-coverage-real-quick-d71dda7069e5?source=collection_archive---------3-----------------------#2017-01-06">https://medium.com/hackernoon/from-0-to-100-coverage-real-quick-d71dda7069e5?source=collection_archive---------3-----------------------#2017-01-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/56069b0d414755f1a7a29e3585a9e7c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q26gw-kNzOXUqZKRr04T-g.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Jest — A JS testing framework used by Facebook</figcaption></figure><h2 id="013c" class="jg jh hu bd ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd dt translated">我的体验单元测试<a class="ae ke" href="http://pedsmoreira.github.io/premiere" rel="noopener ugc nofollow" target="_blank">首映</a></h2><p id="7afc" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp jr kq kr ks jv kt ku kv jz kw kx ky kz hn dt translated"><a class="ae ke" href="https://hackernoon.com/consuming-restful-apis-with-premiere-ae712d1bc935#.xxhq0vkez" rel="noopener ugc nofollow" target="_blank">我最近发布了关于Premiere </a>的文章，这是一个Javascript库，我发布它是为了方便使用RESTful APIs，我的目标之一是使这个库可靠，达到100%的测试覆盖率，或者至少接近这个水平。</p><p id="2335" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">要这样做，我的第一个选择是选择如何去做；于是我开始阅读流行的摩卡/柴/西农+伊斯坦布尔进行测试覆盖。虽然我设置了基本的测试环境和脚本，但我的经历非常痛苦；使用<a class="ae ke" href="http://www.typescriptlang.org/" rel="noopener ugc nofollow" target="_blank"> Typescript </a>使得测试更加困难。</p><blockquote class="lf lg lh"><p id="c38d" class="kf kg li kh b ki la kk kl km lb ko kp lj lc kr ks lk ld ku kv ll le kx ky kz hn dt translated">如果你习惯了Karma，Jasmine，Mocha/Chai/Sinon并且和他们在一起很开心，那也不错。这篇文章是关于我到目前为止对这些技术的体验。</p></blockquote><p id="5376" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">在经历了大量的忙乱、花费的时间和导入的包之后，测试<code class="eh lm ln lo lp b">watcher</code>和<code class="eh lm ln lo lp b">coverage</code>仍然不能为我工作。为了做简单的测试，我不得不从许多库中导入我的代码，有些来自<code class="eh lm ln lo lp b">chai</code>，有些来自<code class="eh lm ln lo lp b">sinon</code>，有些来自<code class="eh lm ln lo lp b">sinon-chai</code>，这看起来非常困难和混乱；此外，我正在处理打字稿，需要所有的打字工作。到最后，我非常沮丧，这一切都偏离了我的主要关注点，那就是写测试，而不是做配置。</p><p id="ec0d" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">在做一些研究时，我发现了Jest，一个由脸书创建和使用的测试框架。起初我以为它是为React项目设计的，但是通过查看Jest主页，我开始注意到它是多么强大和容易安装。更好的是，有一个<a class="ae ke" href="https://github.com/kulshekhar/ts-jest" rel="noopener ugc nofollow" target="_blank">不错的软件包</a>可以轻松处理打字稿。</p><p id="70a2" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">设置Jest像微风一样容易，它有一个很好的观察者，测试覆盖面开箱即用。整个流程感觉非常流畅，一切就绪使它变得容易多了，文档齐全的api也非常有用。</p><p id="421e" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">一旦一切就绪，接下来的事情就是仔细检查每个功能，确保所有功能都被覆盖，以获得<strong class="kh hv">期望的100%❤</strong>。基本功能、<code class="eh lm ln lo lp b">describe</code>、<code class="eh lm ln lo lp b">it</code>和<code class="eh lm ln lo lp b">expect</code>在大多数情况下已经足够，剩下的由对<code class="eh lm ln lo lp b">Promise</code>的支持来完成。为了帮助隔离每个测试，用<code class="eh lm ln lo lp b">jest.fn()</code>创建模拟也很有帮助。</p></div><div class="ab cl lq lr hc ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="hn ho hp hq hr"><p id="2cce" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">让我们看一些代码，所以这听起来不像是脸书的免费营销。以下代码写在<a class="ae ke" href="http://www.typescriptlang.org/" rel="noopener ugc nofollow" target="_blank">类型脚本</a>中，引用<a class="ae ke" href="http://pedsmoreira.github.io/premiere" rel="noopener ugc nofollow" target="_blank"> Premiere </a>的<a class="ae ke" href="https://github.com/pedsmoreira/premiere/blob/master/lib/premiere/Cache.ts" rel="noopener ugc nofollow" target="_blank">缓存类</a>。</p><p id="838b" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">首先，让我们导入主类。我遵循的模式是将<code class="eh lm ln lo lp b">.spec.ts</code>放在与“原始”文件相同的文件夹中。</p><pre class="lx ly lz ma fq mb lp mc md aw me dt"><span id="0983" class="jg jh hu lp b fv mf mg l mh mi"><strong class="lp hv">import </strong>Cache <strong class="lp hv">from </strong>'./Cache';</span></pre><p id="f21e" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">现在让我们设置我们的<code class="eh lm ln lo lp b">describe</code>块，并为我们的测试准备一些变量，这样我们的生活会更轻松。注意，我们使用的是类型为<code class="eh lm ln lo lp b">any</code>的变量，所以除了缓存之外，我们不需要导入更多的东西，目的是让我们的<code class="eh lm ln lo lp b">spec</code>更加独立。</p><pre class="lx ly lz ma fq mb lp mc md aw me dt"><span id="8145" class="jg jh hu lp b fv mf mg l mh mi">describe('Cache', () =&gt; {<br/>    <strong class="lp hv">let </strong>cache: Cache;<br/>    <strong class="lp hv">let </strong>model: <strong class="lp hv">any</strong>;<br/>    <strong class="lp hv">let </strong>list: <strong class="lp hv">any</strong>[];<br/>    <strong class="lp hv">let </strong>promise: <strong class="lp hv">any </strong>= 'promise instance';</span></pre><p id="c9f9" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">现在，在每次测试之前，我们将初始化我们的变量。</p><pre class="lx ly lz ma fq mb lp mc md aw me dt"><span id="b120" class="jg jh hu lp b fv mf mg l mh mi">beforeEach(() =&gt; {<br/>    cache = <strong class="lp hv">new </strong>Cache(<strong class="lp hv">null</strong>);<br/>    model = {key: jest.fn().mockReturnValue('id')};<br/>    list = [model];<br/>});</span></pre><p id="ead3" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">为了掌握它是如何工作的，让我们来看几个测试。</p><pre class="lx ly lz ma fq mb lp mc md aw me dt"><span id="0e35" class="jg jh hu lp b fv mf mg l mh mi">it('should set api on construct', () =&gt; {<br/>    cache = <strong class="lp hv">new </strong>Cache('api' as <strong class="lp hv">any</strong>);<br/>    expect(cache.api).toBe('api');<br/>});</span><span id="52ea" class="jg jh hu lp b fv mj mg l mh mi">it('should resolve key from object', () =&gt; {<br/>    expect(Cache.<em class="li">resolveKey</em>(model)).toBe('id');<br/>});</span><span id="1451" class="jg jh hu lp b fv mj mg l mh mi">it('should set list', () =&gt; {<br/>    cache.setList('list', list);<br/>    expect(cache.lists['list']).toBe(list);<br/>});</span></pre><p id="f8c2" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">如果您希望查看整个文件，请参考<a class="ae ke" href="https://github.com/pedsmoreira/premiere/blob/master/lib/premiere/Cache.spec.ts" rel="noopener ugc nofollow" target="_blank">https://github . com/pedsmoreira/premiere/blob/master/lib/premiere/cache . spec . ts</a></p></div><div class="ab cl lq lr hc ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="hn ho hp hq hr"><h1 id="1dca" class="mk jh hu bd ji ml mm mn jm mo mp mq jq mr ms mt ju mu mv mw jy mx my mz kc na dt translated">配置</h1><p id="81d4" class="pw-post-body-paragraph kf kg hu kh b ki kj kk kl km kn ko kp jr kq kr ks jv kt ku kv jz kw kx ky kz hn dt translated">Jest配置非常简单。只是把这些部分添加到了<a class="ae ke" href="https://github.com/pedsmoreira/premiere/blob/master/package.json" rel="noopener ugc nofollow" target="_blank"> package.json </a>中。</p><p id="898c" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">脚本:</p><pre class="lx ly lz ma fq mb lp mc md aw me dt"><span id="4e6a" class="jg jh hu lp b fv mf mg l mh mi">“test”: “jest — coverage — no-cache ${1}”,<br/>“test-watch”: “jest ${1} — watch”,</span></pre><p id="cdc2" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">开发依赖项:</p><pre class="lx ly lz ma fq mb lp mc md aw me dt"><span id="e294" class="jg jh hu lp b fv mf mg l mh mi">"@types/jest": "^16.0.2",<br/>"jest": "^18.0.0",<br/>"ts-jest": "^18.0.0",</span></pre><p id="5164" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">最后是“jest”块。</p><blockquote class="lf lg lh"><p id="dd5b" class="kf kg li kh b ki la kk kl km lb ko kp lj lc kr ks lk ld ku kv ll le kx ky kz hn dt translated">这一部分是必要的，因为项目使用Typescript。不要害怕，这主要是样板文件，被<a class="ae ke" href="https://github.com/kulshekhar/ts-jest" rel="noopener ugc nofollow" target="_blank"> ts-jest </a>很好地记录了下来。</p></blockquote><pre class="lx ly lz ma fq mb lp mc md aw me dt"><span id="d766" class="jg jh hu lp b fv mf mg l mh mi">"jest": {<br/>  "moduleFileExtensions": [<br/>    "ts",<br/>    "js"<br/>  ],<br/>  "transform": {<br/>    "\\.(ts)$": "&lt;rootDir&gt;/node_modules/ts-jest/preprocessor.js"<br/>  },<br/>  "testRegex": "lib/.*\\.spec.(ts|js)$",<br/>  "testResultsProcessor": "&lt;rootDir&gt;/node_modules/ts-jest/coverageprocessor.js",<br/>  "globals": {<br/>    "__TS_CONFIG__": {<br/>      "target": "es6",<br/>      "module": "commonjs",<br/>      "moduleResolution": "node"<br/>    }<br/>  }<br/>}</span></pre><p id="b06f" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">完整的package.json可从<a class="ae ke" href="https://github.com/pedsmoreira/premiere/blob/master/package.json" rel="noopener ugc nofollow" target="_blank">https://github . com/pedsmoreira/premiere/blob/master/package . JSON</a>获得</p><figure class="lx ly lz ma fq iv"><div class="bz el l di"><div class="nb nc l"/></div></figure></div><div class="ab cl lq lr hc ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="hn ho hp hq hr"><p id="ea32" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">所以，如果你有机会，不管有没有，试一试笑话，你可能会给自己带来惊喜。感觉事情“刚刚好”的感觉非常好\o/</p><p id="1542" class="pw-post-body-paragraph kf kg hu kh b ki la kk kl km lb ko kp jr lc kr ks jv ld ku kv jz le kx ky kz hn dt translated">希望你喜欢:)</p><div class="lx ly lz ma fq ab cb"><figure class="nd iv ne nf ng nh ni paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="nd iv ne nf ng nh ni paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="nd iv ne nf ng nh ni paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="lf lg lh"><p id="f922" class="kf kg li kh b ki la kk kl km lb ko kp lj lc kr ks lk ld ku kv ll le kx ky kz hn dt translated"><a class="ae ke" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ke" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ke" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ke" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="kf kg li kh b ki la kk kl km lb ko kp lj lc kr ks lk ld ku kv ll le kx ky kz hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ke" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ke" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lx ly lz ma fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nj"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>