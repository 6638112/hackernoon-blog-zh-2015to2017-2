<html>
<head>
<title>Go race condition trivia</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">去比赛条件琐事</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/go-race-condition-trivia-32cfe59df722?source=collection_archive---------2-----------------------#2016-11-15">https://medium.com/hackernoon/go-race-condition-trivia-32cfe59df722?source=collection_archive---------2-----------------------#2016-11-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="db04" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">有多私密</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/141bab457b07c724334e7902f01c0ffa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*enqVbjvkKUT6nxFvJeVbZw.png"/></div></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">Trivia time!</figcaption></figure><p id="cc34" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">我最近遇到了一个让我困惑了一段时间的a -race错误消息，所以我将在这里分阶段复述它，看看您是否能理解它。</p><h1 id="b2c1" class="kv kw hu bd kx ky kz la lb lc ld le lf ja lg jb lh jd li je lj jg lk jh ll lm dt translated">代码</h1><p id="aa23" class="pw-post-body-paragraph jz ka hu kb b kc ln iv ke kf lo iy kh ki lp kk kl km lq ko kp kq lr ks kt ku hn dt translated">代码<a class="ae ls" href="https://hackernoon.com/tagged/code" rel="noopener ugc nofollow" target="_blank">的意图</a>是一个服务抽象，它在后台运行一个goroutine，将运行时统计数据发送给<a class="ae ls" href="https://github.com/etsy/statsd" rel="noopener ugc nofollow" target="_blank">的stats TD</a>。下面是代码的一个小示例:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="0187" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">你可以100%确定我从来没有对同一个Stats结构运行Loop()。<br/>你100%确定我在程序中只创建了一个Stats{}结构。在继续阅读之前，检查一下上面的代码，看看是否可以找到我在使用Stats时遇到的<a class="ae ls" href="https://hackernoon.com/tagged/race" rel="noopener ugc nofollow" target="_blank">比赛</a>条件。</p></div><div class="ab cl lv lw hc lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hn ho hp hq hr"><h2 id="8e3d" class="mc kw hu bd kx md me mf lb mg mh mi lf ki mj mk lh km ml mm lj kq mn mo ll mp dt translated">一个暗示</h2><p id="e252" class="pw-post-body-paragraph jz ka hu kb b kc ln iv ke kf lo iy kh ki lp kk kl km lq ko kp kq lr ks kt ku hn dt translated">竞争情况发生在第19行。</p><pre class="jk jl jm jn fq mq mr ms mt aw mu dt"><span id="578d" class="mc kw hu mr b fv mv mw l mx my">p.prev = ms</span></pre><p id="474c" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">这有助于发现竞态条件吗？</p></div><div class="ab cl lv lw hc lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hn ho hp hq hr"><h2 id="7a05" class="mc kw hu bd kx md me mf lb mg mh mi lf ki mj mk lh km ml mm lj kq mn mo ll mp dt translated">第二个更大的暗示</h2><p id="a360" class="pw-post-body-paragraph jz ka hu kb b kc ln iv ke kf lo iy kh ki lp kk kl km lq ko kp kq lr ks kt ku hn dt translated">创建我的服务结构的代码如下所示。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lt lu l"/></div></figure></div><div class="ab cl lv lw hc lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hn ho hp hq hr"><h2 id="1762" class="mc kw hu bd kx md me mf lb mg mh mi lf ki mj mk lh km ml mm lj kq mn mo ll mp dt translated">私人并不意味着不可发现</h2><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/24d7a7d4541278342dc629c219c3b015.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FT9j5f0RH9Vz0FVtbA4V9g.png"/></div></div></figure><p id="c88a" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">当你试图用Sprint或Println系列操作在Go中打印一个结构时，它会检查它是否是一个格式化程序或Stringer，并通常使用这些方法，否则它会使用反射来发明一种打印结构的方法。您可以检查在print.go 中使用格式化程序或Stringer <a class="ae ls" href="https://github.com/golang/go/blob/release-branch.go1.7/src/fmt/print.go#L549" rel="noopener ugc nofollow" target="_blank">的条件。</a></p><p id="7852" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">这段特殊的代码难倒了我，因为我一直在查看Stats{}，心想这不可能是一场比赛。我保持<strong class="kb hv"><em class="mz">prev</em></strong><em class="mz">私有，从不引用它</em>。但是，使用Go，您可以使用反射来检查私有变量。该检查创建了导致竞争条件触发的读取操作。这非常合理，特别是因为您可以通过获取结构的值来触发对私有变量的读取，即使没有反射</p><pre class="jk jl jm jn fq mq mr ms mt aw mu dt"><span id="9002" class="mc kw hu mr b fv mv mw l mx my">s := Stats{}<br/>q := s // Will read stats to make a copy inside q</span></pre><p id="0ed3" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">谢天谢地，我们不能使用反射来设置私有变量。参见<a class="ae ls" href="https://golang.org/pkg/reflect/#Value.CanSet" rel="noopener ugc nofollow" target="_blank">值。CanSet </a>描述什么时候可以，什么时候不可以。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lt lu l"/></div></figure><p id="532f" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">这个小细节的寓意是记住私有变量可以通过复制和反射导致读竞争错误，即使看起来结构本身是安全的。</p><div class="jk jl jm jn fq ab cb"><figure class="na jo nb nc nd ne nf paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="na jo nb nc nd ne nf paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="na jo nb nc nd ne nf paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="ng nh ni"><p id="f922" class="jz ka mz kb b kc kd iv ke kf kg iy kh nj kj kk kl nk kn ko kp nl kr ks kt ku hn dt translated"><a class="ae ls" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ls" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ls" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae ls" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jz ka mz kb b kc kd iv ke kf kg iy kh nj kj kk kl nk kn ko kp nl kr ks kt ku hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ls" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ls" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jk jl jm jn fq jo fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff nm"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nn lu l"/></div></figure></div></div>    
</body>
</html>