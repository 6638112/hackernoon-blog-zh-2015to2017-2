<html>
<head>
<title>The Windows Event Forwarding Survival Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Windows事件转发生存指南</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/the-windows-event-forwarding-survival-guide-2010db7a68c4?source=collection_archive---------1-----------------------#2017-07-24">https://medium.com/hackernoon/the-windows-event-forwarding-survival-guide-2010db7a68c4?source=collection_archive---------1-----------------------#2017-07-24</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="b265" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一个<a class="ae jp" href="https://hackernoon.com/tagged/security" rel="noopener ugc nofollow" target="_blank">安全</a>工程师的考验和磨难试图理解一个最不为人知但最强大的<a class="ae jp" href="https://hackernoon.com/tagged/windows" rel="noopener ugc nofollow" target="_blank"> Windows </a>服务。</p><p id="8942" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在阅读本帖之前，请务必阅读<a class="ae jp" href="https://twitter.com/jepayneMSFT" rel="noopener ugc nofollow" target="_blank"> @jepayneMSFT </a>关于Windows事件转发的精彩帖子:<a class="ae jp" href="https://blogs.technet.microsoft.com/jepayne/2015/11/23/monitoring-what-matters-windows-event-forwarding-for-everyone-even-if-you-already-have-a-siem/" rel="noopener ugc nofollow" target="_blank">监控什么才是重要的——人人Windows事件转发</a></p><p id="cfd5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此外，还可以查看微软的<a class="ae jp" href="https://docs.microsoft.com/en-us/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection" rel="noopener ugc nofollow" target="_blank">使用Windows事件转发来帮助入侵检测</a></p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h1 id="a5ce" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">Windows事件转发简介</h1><p id="998d" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">如果您不熟悉Windows事件转发(WEF)的概念，长话短说，Windows中存在一种服务，您可以在其中指定一个或多个服务器作为Windows事件日志收集器。这些收集器充当订阅管理器，允许您挑选要从端点收集的事件日志，然后将转发的日志存储在收集器的存储桶中。使用Windows事件转发服务时，事件日志通过WinRM以本机方式传输，这意味着您不必担心在所有端点上安装任何类型的日志转发器软件(Splunk/WinLogBeat/etc)来将日志发送到一个集中的位置。</p><p id="712c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">除了不必部署任何额外软件的明显优势之外，使用WEF还有一些巨大的优势:</p><p id="459a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">默认情况下，事件通过Kerberos加密<br/>。订阅可以创建为XML文件，并由版本控制软件(如git)支持(只要确保验证XML即可！)<br/>新机器在加入域后会自动注册到日志记录基础架构中<br/>WEF可配置为推送或拉取模式<br/>转发间隔可修改</p><p id="0ccd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">尽管不乏强调使用WEF的好处的文档，但本文的主要重点是解释WEF正常运行所需的所有组件，并记录当事情不按预期运行时的故障排除策略。</p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h1 id="8bb2" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">WEF装置的核心组件</h1><p id="ac43" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">网上有无数不同质量的关于如何配置WEF的指南。该装置的核心组件包括:</p><ol class=""><li id="0e0e" class="la lb hu it b iu iv iy iz jc lc jg ld jk le jo lf lg lh li dt translated">一台或多台服务器作为订阅管理器和日志收集器，运行<strong class="it hv"> Windows事件日志收集器</strong>服务。</li><li id="ba2f" class="la lb hu it b iu lj iy lk jc ll jg lm jk ln jo lf lg lh li dt translated">所有端点和订阅管理器都必须启用WinRM。</li><li id="ccc3" class="la lb hu it b iu lj iy lk jc ll jg lm jk ln jo lf lg lh li dt translated">指定订阅管理器URL的GPO。我最近从Jessica的帖子中了解到的一个技巧是，您可以通过设置刷新间隔来指定这个GPO中的签入间隔，如下图所示。从长远来看，设置较短的时间间隔会使故障排除变得更加容易，但是对于生产来说可能会有太多的噪音。</li></ol><figure class="lp lq lr ls fq lt fe ff paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="fe ff lo"><img src="../Images/76c3c85e9d2773110d9bc91b5518ba7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9WvRx0zRSrWBm1u-wcjveQ.png"/></div></div><figcaption class="ma mb fg fe ff mc md bd b be z ek"><a class="ae jp" href="https://docs.microsoft.com/en-us/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection" rel="noopener ugc nofollow" target="_blank">https://docs.microsoft.com/en-us/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection</a></figcaption></figure><p id="84a9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">4.一个或多个事件日志订阅。订阅是基于事件ID或其他标准的事件集合，这些标准告诉端点要转发哪些事件日志。NSA的信息保障组有一组优秀的订阅作为基准:</p><figure class="lp lq lr ls fq lt fe ff paragraph-image"><div class="fe ff me"><img src="../Images/f0e4c9629359972a273cbd8ad1c49f56.png" data-original-src="https://miro.medium.com/v2/resize:fit:400/format:webp/1*z_VXLOYO66kPthdJkQ4l3w.png"/></div></figure><p id="e3d1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://github.com/iadgov/Event-Forwarding-Guidance/tree/master/Subscriptions/samples" rel="noopener ugc nofollow" target="_blank">https://github . com/IAD gov/Event-Forwarding-Guidance/tree/master/Subscriptions/samples</a></p><p id="c688" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">5.将<strong class="it hv">网络服务</strong>帐户添加到<strong class="it hv">事件日志阅读器</strong>组的GPO。</p><figure class="lp lq lr ls fq lt fe ff paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="fe ff mf"><img src="../Images/ddb3257103f267c31cd7143dce9a845d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DQAF6k7bajWccDzsZQKDcQ.png"/></div></div><figcaption class="ma mb fg fe ff mc md bd b be z ek"><a class="ae jp" href="https://docs.microsoft.com/en-us/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection" rel="noopener ugc nofollow" target="_blank">https://docs.microsoft.com/en-us/windows/threat-protection/use-windows-event-forwarding-to-assist-in-instrusion-detection</a></figcaption></figure><p id="03f3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">6.一个GPO，用于在所有相关的事件日志通道上设置ACL，以允许事件日志读取器组进行读取访问。默认情况下，许多通道包括该ACL，但是Microsoft/Windows服务日志下的安全和其他自定义日志不包括。关于创建GPO的更多信息，请点击此处:<a class="ae jp" href="https://support.microsoft.com/en-us/help/323076/how-to-set-event-log-security-locally-or-by-using-group-policy" rel="noopener ugc nofollow" target="_blank">https://support . Microsoft . com/en-us/help/323076/how-to-set-event-log-security-locally-or-by-using-group-policy</a></p><p id="3a07" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">7.任何重视安全的组织都应该有一个GPO，以便在整个组织中启用windows上的增强审核:<a class="ae jp" href="https://technet.microsoft.com/en-us/library/dn319056(v=ws.11).aspx" rel="noopener ugc nofollow" target="_blank">https://TechNet . Microsoft . com/en-us/library/dn 319056(v = ws . 11)。aspx </a></p><p id="faef" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这七项听起来相对简单，但是有很多地方很容易出错。此外，WEF的许多方面都不直观，使得使用起来不够用户友好。在下一节中，我们将介绍可用于更好地了解您的WEF配置的工具。</p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h1 id="5bd8" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">深入了解您的WEF基础设施</h1><p id="0593" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">在WEF基础设施上完成设置后，您可能会发现主机没有登记，或者某些事件没有转发。理解事情发生的原因可能会令人困惑，但是本节旨在为您提供有效地对安装进行故障诊断所需的工具。</p><h2 id="9347" class="mg jy hu bd jz mh mi mj kd mk ml mm kh jc mn mo kl jg mp mq kp jk mr ms kt mt dt translated">事件日志控制台</h2><p id="ac91" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">在您的WEF订阅管理器上，您可以通过事件查看器控制台查看有关您的订阅的实时统计数据，方法是选择一个订阅并单击“运行时状态”:</p><figure class="lp lq lr ls fq lt fe ff paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="fe ff mu"><img src="../Images/c28f66415d9b2bc75eb034033d0a6b42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lyWJ0sQQ0OKsx-9WH8z5gw.png"/></div></div></figure><p id="016d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">也可以通过选择“属性&gt;选择事件”来编辑订阅。<strong class="it hv">注意:</strong>有可能通过wecutil命令意外加载带有损坏的XML的订阅(问我怎么知道的)。</p><h2 id="5d60" class="mg jy hu bd jz mh mi mj kd mk ml mm kh jc mn mo kl jg mp mq kp jk mr ms kt mt dt translated">wecutil和wevtutil</h2><p id="5cc6" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">wecutil (Windows事件收集器实用程序)和wevtutil (Windows事件实用程序)还可以帮助您深入了解订阅的当前状态。</p><p id="bbb7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以通过从订阅管理器运行<strong class="it hv"> wecutil </strong>来查看主机最后一次签入特定订阅的时间:</p><pre class="lp lq lr ls fq mv mw mx my aw mz dt"><span id="46a8" class="mg jy hu mw b fv na nb l nc nd">PS C:\Windows&gt; wecutil gr DNS<br/> Subscription: DNS<br/> RunTimeStatus: Active<br/> LastError: 0<br/> EventSources:<br/> dc.windomain.local<br/> RunTimeStatus: Active<br/> LastError: 0<br/> LastHeartbeatTime: 2017–07–22T07:54:27.296</span></pre><p id="acf6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">提示:</strong>要从主机强制签入，运行<strong class="it hv"> gpupdate /force </strong>。</p><p id="b7c2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> wevtutil </strong>对于从端点端查看事件日志通道ACL等内容同样有用:</p><pre class="lp lq lr ls fq mv mw mx my aw mz dt"><span id="5a93" class="mg jy hu mw b fv na nb l nc nd">PS C:\Windows&gt; wevtutil get-log security<br/>name: security<br/>enabled: true<br/>type: Admin<br/>owningPublisher:<br/>isolation: Custom<br/>channelAccess: O:BAG:SYD:(A;;0xf0005;;;SY)(A;;0x5;;;BA)(A;;0x1;;;S-1–5–32–573)(A;;0x1;;;S-1–5–20)<br/>logging:<br/> logFileName: %SystemRoot%\System32\Winevt\Logs\security.evtx<br/> retention: false<br/> autoBackup: false<br/> maxSize: 20971520<br/>publishing:<br/> fileMax: 1</span></pre><p id="c8b1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">注意:</strong>如果您试图从中提取事件的通道不包含事件日志查看器的SID(A；；0x1；；s-1–5–32–573)，它将无法被读取，并且将在下面记录的日志通道中生成一条错误消息。</p><h2 id="01d7" class="mg jy hu bd jz mh mi mj kd mk ml mm kh jc mn mo kl jg mp mq kp jk mr ms kt mt dt translated">Microsoft-Windows-Event Log-forwarding插件事件日志通道</h2><p id="5a3d" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">当试图确定为什么来自特定订阅的事件没有进来时，这个频道是一个很好的地方。</p><figure class="lp lq lr ls fq lt fe ff paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="fe ff ne"><img src="../Images/f554bdaffb8aee75d4c29ddaa5fd7d3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DYYWxyAFCZG0sYk0jf5bhw.png"/></div></div><figcaption class="ma mb fg fe ff mc md bd b be z ek">Microsoft-Windows-Eventlog-ForwardingPlugin/Operational</figcaption></figure><p id="fbd3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该日志存在于记录windows事件转发运行时状态信息的每个注册端点的事件查看器深处。不幸的是，这些消息中显示的错误代码似乎没有在任何地方记录。对你来说幸运的是，我已经根据趣闻确定了其中一些的意思。</p><p id="404a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">以下是我在这个日志文件中遇到的错误:</p><p id="5716" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">错误消息:</strong>无法创建订阅$name。错误代码是15008。<br/> <strong class="it hv">问题</strong>:订阅XML格式不正确或订阅无效<br/> <strong class="it hv">解决方案</strong>:更新XML使其有效。</p><p id="141d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">错误消息:</strong>订阅$name已创建，但此时无法读取查询中的一个或多个频道。<br/> <strong class="it hv">问题:</strong>事件日志读取器组没有对订阅中指定通道的读取权限<br/> <strong class="it hv">解决方案</strong>:使用wevtutil查看相关通道上的当前ACL，并创建/更新GPO以允许对该日志通道的读取权限</p><p id="75ae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">错误消息:</strong>无法创建订阅$name。错误代码是5004。<br/> <strong class="it hv">问题:</strong>描述中指定的一个通道在主机上不存在<br/> <strong class="it hv">解决方案:</strong>这不一定是问题。如果您订阅了DNS服务器，并且只有您的域控制器运行DNS，您可能会在任何没有相应DNS服务器日志通道的服务器上看到此错误消息。</p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h1 id="bdbb" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">包装它</h1><p id="2511" class="pw-post-body-paragraph ir is hu it b iu kv iw ix iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo hn dt translated">妥善管理WEF的基础设施需要多种技能。用户应该对组策略、事件日志ACL、高级审核、Powershell和Active Directory有深入的了解。最初正确配置WEF很棘手，但根据我的经验，它非常可靠，性能也非常好。如果您的环境中有Windows域，我强烈推荐您配置WEF，我希望本指南能帮助您解决在此过程中可能遇到的任何问题！</p><figure class="lp lq lr ls fq lt"><div class="bz el l di"><div class="nf ng l"/></div></figure></div></div>    
</body>
</html>