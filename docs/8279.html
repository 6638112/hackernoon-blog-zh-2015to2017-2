<html>
<head>
<title>Hacking a Popular ICO Practice That Only Rewards the Richer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑客攻击一种流行的ICO做法，只奖励富人</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/hacking-a-popular-ico-practice-that-only-rewards-the-richer-7d10b2019f1e?source=collection_archive---------10-----------------------#2017-11-27">https://medium.com/hackernoon/hacking-a-popular-ico-practice-that-only-rewards-the-richer-7d10b2019f1e?source=collection_archive---------10-----------------------#2017-11-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/f7a8f8ed08ef6430cb79c383fac1c760.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RDNoP7bpsvddhLrqzcMZ-Q.jpeg"/></div></div></figure><div class=""/><p id="6d16" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你已经加入以太坊/加密货币生态系统至少几个月了，你可能会意识到ICO热潮正在蔓延。<br/>几乎每天都有几十起ICO/Token销售涌现，这可以在热门平台上看到——比如<a class="ae ka" href="https://www.icoalert.com/" rel="noopener ugc nofollow" target="_blank"> IcoAlert </a>或<a class="ae ka" href="https://tokenmarket.net/ico-calendar" rel="noopener ugc nofollow" target="_blank">Token market</a>——追踪ICO活动。</p><p id="4b50" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">ICO团队推广和激励代币销售的最常见做法之一是，根据<strong class="je ig">何时</strong>购买代币或<strong class="je ig">愿意投资多少</strong>向贡献者提供高额折扣或奖金。</p><figure class="kc kd ke kf fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff kb"><img src="../Images/9ed085f7753a3b54b7ac0812155673c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OMsqan7Bikp-3RSPJnAyVw.png"/></div></div><figcaption class="kg kh fg fe ff ki kj bd b be z ek">Why should the rich get richer?</figcaption></figure><p id="5976" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最近，有一些关于ico是否可以根据购买量/花费来提供奖金的激烈争论。</p><p id="e969" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这种做法的批评者认为，这违背了以太坊的精神——以及一般的加密——奖励拥有更多资源的人，以获得对其他资源较少的人的优势。</p><h1 id="182b" class="kk kl if bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">通过资源池访问批量折扣</h1><p id="7890" class="pw-post-body-paragraph jc jd if je b jf li jh ji jj lj jl jm jn lk jp jq jr ll jt ju jv lm jx jy jz hn dt translated">基于销量的奖金不会很快消失。那么…如果我们不能(或不愿)承诺ICO团队要求的最低额，我们如何利用这些奖金呢？</p><p id="e822" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">其中一种方法是找到几个对特定ICO也感兴趣的朋友，让他们将他们的以太发送给组中的一个成员，让他购买代币，然后在这组朋友中相应地分发获得的代币。</p><figure class="kc kd ke kf fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff ln"><img src="../Images/a9e9536755c2f172750d5dece19d14e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1VCJ0LYAvGRtERbhX2lUCA.jpeg"/></div></div><figcaption class="kg kh fg fe ff ki kj bd b be z ek">Love, Faith and Hope. These are much needed when investing together with friends. (Photo by <a class="ae ka" href="https://unsplash.com/photos/45W2fOHWxYo?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Jonathan Brinkhorst</a> on <a class="ae ka" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a>)</figcaption></figure><p id="069b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">理论上，这种方法非常简单明了，但是在实践中，它可能会有问题。首先，你必须相信这个人接受了所有人的以太，这已经是一个危险的提议。如果这个人带着钱消失了呢？如果他忘记了他的私人钥匙怎么办？如果他的私人钥匙被偷了怎么办？如果他犯了一个错误，把钱寄到一个不正确的地址怎么办？有太多的事情可能会出错。</p><p id="b590" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">此外，如果我们没有足够多的朋友有兴趣和你一起投资某个特定的投资组合怎么办？你可能还是想这么做，然后和完全陌生的人凑钱。有一些网站和论坛，人们可以找到其他人一起投资，但这对所有参与者来说都是一个巨大的风险。我不会盲目地给一个我不太了解的人送钱，你也不应该。</p><p id="95cf" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">那么，我们如何合作投资一个ICO，而不必把我们的钱托付给任何人呢？当然是用智能合同！📄</p><h1 id="4f26" class="kk kl if bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">建立投资池智能合同</h1><figure class="kc kd ke kf fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff lo"><img src="../Images/22f2e36363277e4435d567b5bde7fbfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R_r-Ju7fyK_IFJ0k4ugM8w.jpeg"/></div></div></figure><p id="7f45" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在接下来的几段中，我将描述如何构建一个智能的合同，允许几个参与者给它寄钱；当满足某些先决条件时，让它投资于选定的ICO最后让它按比例分配购买的代币。</p><p id="a7b1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该智能合同将充当中介，从多个账户中收集资金，然后在一次交易中将收集到的资金转发给ICO合同，以便获得团队提供的基于数量的奖金。</p><p id="ae18" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后，代币将通过合同购买，这允许参与投资池的参与者将代币提取到他们自己的账户中。</p><p id="1db2" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们看看允许这一切的智能合同。</p><h2 id="ce5d" class="lp kl if bd km lq lr ls kq lt lu lv ku jn lw lx ky jr ly lz lc jv ma mb lg mc dt translated"><strong class="ak">但首先，一些免责声明、警告和注意事项:</strong></h2><ul class=""><li id="f0f2" class="md me if je b jf li jj lj jn mf jr mg jv mh jz mi mj mk ml dt translated">在使用以下合同为ICO创建投资池之前，您应确保ICO允许您以后提取令牌。例如，一些ico在收取捐款时不会使用智能合同。一些ico也有白名单机制和需要完成的KYC步骤，这些步骤可能会阻止合同代表自然人投资。</li><li id="99cd" class="md me if je b jf mm jj mn jn mo jr mp jv mq jz mi mj mk ml dt translated">ICOPool合同无法了解其目标ICO的细节，因为crowdsale合同没有标准协议。这意味着，例如，它不知道奖金是否有截止日期，最低/最高贡献金额是多少，或者ICO是否已经完成等。因此，该合同依赖于其管理员来正确配置它，并在适当的时候触发令牌购买。</li><li id="c3c0" class="md me if je b jf mm jj mn jn mo jr mp jv mq jz mi mj mk ml dt translated">ICOPool契约通过对crowdsale契约进行外部调用，执行其回退功能，从而参与ICO。大多数crowdsale合同准备在没有任何其他数据的情况下接收到ether时执行buyTokens函数(或类似名称的函数)。你应该确保你投资的ICO以这种方式运作。</li><li id="58d0" class="md me if je b jf mm jj mn jn mo jr mp jv mq jz mi mj mk ml dt translated">不用说，所购买的令牌必须符合ERC20标准。如果没有，您将无法保证令牌可以从投资池转移到贡献者。</li><li id="f896" class="md me if je b jf mm jj mn jn mo jr mp jv mq jz mi mj mk ml dt translated">下面的代码还没有在现实项目中测试过。<em class="mr">使用自担风险，使用不当我不负责。</em>此外，确保您为投资池选择的ICO不是骗局。使用本合同的风险与通过向ICO发送以太网投资ICO的风险相同，本合同没有增加额外的安全机制。<strong class="je ig">谨慎从事。</strong></li></ul><h1 id="4215" class="kk kl if bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">ICOPool智能合同</h1><p id="520a" class="pw-post-body-paragraph jc jd if je b jf li jh ji jj lj jl jm jn lk jp jq jr ll jt ju jv lm jx jy jz hn dt translated">你可以在我的Github库中找到完整的源代码。 <strong class="je ig">请查看README.md文件，了解更多用法说明、更深入的信息和示例。</strong></p><p id="f4a4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">ICOPool合同有4个部分:</strong></p><ol class=""><li id="e4e5" class="md me if je b jf jg jj jk jn ms jr mt jv mu jz mv mj mk ml dt translated">配置投资池。</li><li id="32ca" class="md me if je b jf mm jj mn jn mo jr mp jv mq jz mv mj mk ml dt translated">接收来自贡献者的以太以形成池。</li><li id="1042" class="md me if je b jf mm jj mn jn mo jr mp jv mq jz mv mj mk ml dt translated">一旦池的要求得到满足，就投资目标ICO。</li><li id="18a4" class="md me if je b jf mm jj mn jn mo jr mp jv mq jz mv mj mk ml dt translated">允许贡献者获得所获得的代币。</li></ol><h2 id="ad7e" class="lp kl if bd km lq lr ls kq lt lu lv ku jn lw lx ky jr ly lz lc jv ma mb lg mc dt translated">配置投资池</h2><p id="eb44" class="pw-post-body-paragraph jc jd if je b jf li jh ji jj lj jl jm jn lk jp jq jr ll jt ju jv lm jx jy jz hn dt translated">为了建立一个投资池，首先我们必须部署带有几个参数的合同。部署ICOPool合同的帐户将成为其管理员。管理员的唯一目的是执行购买ICO的功能。</p><p id="988a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">下面是创建投资池所涉及的代码。</p><pre class="kc kd ke kf fq mw mx my mz aw na dt"><span id="ff4f" class="lp kl if mx b fv nb nc l nd ne">function ICOPool(address _targetICO,<br/>                    uint _minContribution,<br/>                    uint _maxContribution,<br/>                    uint _poolSoftCap,<br/>                    uint _poolHardCap,<br/>                    uint _contributorsSoftCap,<br/>                    uint _contributorsHardCap<br/>                    ) public {<br/>                        <br/>        require (_targetICO != address(0));<br/>        require (_minContribution &gt; 0);<br/>        require (_maxContribution &gt; _minContribution);<br/>        require (_poolHardCap &gt; _poolSoftCap);<br/>        require (_contributorsSoftCap &gt; 1);<br/>        require (_contributorsHardCap &gt;= _contributorsSoftCap);<br/>        <br/>        // Max people * their minimum contribution should be able to meet pool softcap<br/>        // For example, we can't allow having the max contributors (10 people) put $100 each when the softcap is $1500.<br/>        require(_contributorsHardCap * _minContribution &gt;= _poolSoftCap);<br/>        // Min people * their maximum contribution should be within pool hardcap<br/>        // For example, we can't allow 3 people to reach the hardcap if the minimum contributors is 5<br/>        require(_contributorsSoftCap * _maxContribution &lt;= _poolHardCap);<br/>        <br/>        targetICO = _targetICO;<br/>        poolAdmin = msg.sender;<br/>        minContribution = _minContribution;<br/>        maxContribution = _maxContribution;<br/>        <br/>        poolSoftCap = _poolSoftCap;<br/>        poolHardCap = _poolHardCap;<br/>        <br/>        contributorsSoftCap = _contributorsSoftCap;<br/>        contributorsHardCap = _contributorsHardCap;<br/>    }</span></pre><p id="1c85" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该协定接收相当多的构造函数参数:</p><ol class=""><li id="90b3" class="md me if je b jf jg jj jk jn ms jr mt jv mu jz mv mj mk ml dt translated"><strong class="je ig"> address _targetICO: </strong>这是投资池将向其投入资金的ICO。任何使用这个契约的人都应该仔细检查这个变量是否指向组织者所说的ICO。</li><li id="c5d2" class="md me if je b jf mm jj mn jn mo jr mp jv mq jz mv mj mk ml dt translated"><strong class="je ig">uint _ min contribution&amp;uint _ max contribution:</strong>这些是投资池的贡献者可以放入池中的最小和最大乙醚量(以wei表示)。</li><li id="175d" class="md me if je b jf mm jj mn jn mo jr mp jv mq jz mv mj mk ml dt translated"><strong class="je ig">uint _ poolSoftCap&amp;uint _ poolHardCap:</strong>这些是投资池为了能够投资目标ICO而允许的最小和最大乙醚量(以wei表示)。在管理员可以从ICO购买令牌之前，必须达到软上限。一旦达到硬性上限，就不接受任何捐款。</li><li id="f145" class="md me if je b jf mm jj mn jn mo jr mp jv mq jz mv mj mk ml dt translated"><strong class="je ig">uint _ contributorsSoftCap&amp;uint _ contributorsshardcap:</strong>这些是投资池可以接受的最低和最高出资额。</li></ol><p id="c137" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请注意，所有这些参数之间存在复杂的关系，因此我们不会冒投资池被卡住的风险:</p><ul class=""><li id="34d7" class="md me if je b jf jg jj jk jn ms jr mt jv mu jz mi mj mk ml dt translated">软上限(<strong class="je ig"> _poolSoftCap) </strong>应低于贡献者的最大金额(<strong class="je ig">_ contributorsshardcap)</strong>乘以他们的最小可能贡献(<strong class="je ig"> _minContribution)。<em class="mr">通过这种方式，ICOPool不可能在人员方面达到最大容量，但却无法达到最低以太网目标。(如果10人是允许的最大贡献者人数，如果软上限大于10个eth，则他们每人不能只投资1个eth)。</em> </strong></li><li id="e74a" class="md me if je b jf mm jj mn jn mo jr mp jv mq jz mi mj mk ml dt translated">同样，硬性上限应该高于缴款人的最低缴款额乘以他们的最大可能缴款额。这样，ICOPool就不可能达到以太网的最大容量，但却达不到所需的最低人数。(如果最低人数为3人或3人以上，则不应允许2人到达游泳池的硬顶盖)。T3】</li></ul><p id="56dc" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">注意到ICOPool合同没有办法知道触发奖金的最低贡献是多少也是非常重要的。这取决于管理员相应地正确设置软上限和硬上限。</p><h2 id="5727" class="lp kl if bd km lq lr ls kq lt lu lv ku jn lw lx ky jr ly lz lc jv ma mb lg mc dt translated">从贡献者接收以太</h2><p id="6217" class="pw-post-body-paragraph jc jd if je b jf li jh ji jj lj jl jm jn lk jp jq jr ll jt ju jv lm jx jy jz hn dt translated">一旦建立了投资池，创建合同的人就可以开始在其他人之间推广它，以汇集捐款。</p><p id="afd1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">向投资池投放乙醚的方式与众筹销售的方式相同。只要把乙醚转到给定的地址，合同会处理好的。</p><p id="03f7" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><strong class="je ig">*值得一提的是，贡献者应该采取与直接投资众筹时相同的措施。例如，他们必须从他们拥有私钥的账户中汇款。</strong></p><p id="0676" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">下面是当有人从他们的账户汇款时执行的代码。</p><pre class="kc kd ke kf fq mw mx my mz aw na dt"><span id="0307" class="lp kl if mx b fv nb nc l nd ne">function() payable public {<br/>        require(msg.value &gt; 0);<br/>        require(msg.value &gt;= minContribution &amp;&amp; msg.value &lt;= maxContribution); // Must send eth within min and max contributions<br/>        require(contributorsBalance[msg.sender].add(msg.value) &lt;= maxContribution); // msg.sender's balance can't exceed max contribution limit<br/>        <br/>        // Pool can't exceed hard cap<br/>        require(poolBalance.add(msg.value) &lt;= poolHardCap);<br/>        <br/>        //Register how much eth the pool has<br/>        poolBalance = poolBalance.add(msg.value);<br/>        <br/>        //If it is the first time this account contributes, increase num. of contributors<br/>        if (contributorsBalance[msg.sender] == 0){<br/>            amountOfContributors++;<br/>        }<br/>        // Pool can't exceed contributors hard cap<br/>        require(amountOfContributors &lt;= contributorsHardCap);<br/>        <br/>        //Register how much eth has each contributor put into the pool<br/>        contributorsBalance[msg.sender] = contributorsBalance[msg.sender].add(msg.value);<br/>    }</span></pre><p id="ca0b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先，我们确保所做的贡献在管理员定义的范围之内，并且没有超出人员/资金的硬限制。</p><p id="819c" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果捐款被接受，我们就把钱加到捐款人的账户上。贡献者不必一次投入所有的钱，但是每一笔贡献都应该达到管理员设定的最低要求。</p><h2 id="ba04" class="lp kl if bd km lq lr ls kq lt lu lv ku jn lw lx ky jr ly lz lc jv ma mb lg mc dt translated">投资目标ICO</h2><p id="8bac" class="pw-post-body-paragraph jc jd if je b jf li jh ji jj lj jl jm jn lk jp jq jr ll jt ju jv lm jx jy jz hn dt translated">在任何时间点，只要满足最低要求，管理员可以决定停止收集资金，并从ICO购买代币。</p><p id="3bf1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦他这样做，投资池合同可能不再接受以太网的转让。</p><p id="349e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">正如我之前提到的，这一步必须由管理员执行，尽管可以修改合同以允许任何贡献者执行。这种另一种做法，让契约少了对一个人的依赖，但也让契约更乱，更容易出问题。允许任何人购买令牌的主要问题是，这个ICOPool契约无法了解目标ICO的内部工作方式。为了避免冲突，管理员决定何时购买令牌，并对此负责。例如，合同无法检查ICO团队推广的批量奖励目前是否有效，因此由池管理员检查并继续购买令牌。或者什么都不做，这样捐献者就可以提取他们的资金。</p><pre class="kc kd ke kf fq mw mx my mz aw na dt"><span id="abda" class="lp kl if mx b fv nb nc l nd ne">function buyTokensFromICO() public {<br/>        require(!investedInICO);<br/>        require(poolBalance &gt;= poolSoftCap);<br/>        require(amountOfContributors &gt;= contributorsSoftCap);<br/>        require(this.balance &gt;= poolBalance);<br/>        <br/>        //Can be called only by the pool admin to avoid timing problems<br/>        // We'll need to trust the admin to execute this at the right moment<br/>        // Could be changed to allow any contributor to call it.<br/>        require(msg.sender == poolAdmin);<br/>        <br/>        investedInICO = true;<br/>        <br/>        // BE CAREFUL, OPENING RE-ENTRANCY DOOR<br/>        require(targetICO.call.value(poolBalance)());<br/>        <br/>        // **************<br/>        //If you are hesitant about using call() you can instead instantiate<br/>        //the target ICO and directly use whatever function it has to buy tokens<br/>        // ------<br/>        //Crowdsale c = Crowdsale(targetICO);<br/>        //c.buyTokens.value(poolBalance)();<br/>        // **************<br/>    }</span></pre><p id="8ff1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">将资金发送到目标ICO非常简单。一旦我们检查到满足软上限，我们就继续将以太网转发到目标ICO。使用call()函数并发送池余额将触发ICO的回退功能。</p><p id="da9a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在投资资金池之前，管理员(和贡献者)应该做的一件事是确保资金池确实能够投资目标ICO。该合约假设ICO具有回退功能，该功能触发合约自身的buyTokens(或无论它被称为什么)功能。</p><p id="5ec1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果目标ICO没有实现回退功能，或者您对使用call()函数执行潜在的不安全代码感到不安全，那么您可以使用我在代码中保留注释的另一种方法。您可以实例化目标ICO契约，并直接调用它的buyTokens函数。</p><p id="a31e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这个函数还设置了investedInICO标志，所以我们只能调用这个函数一次。如果相关人员想要筹集更多资金并进行第二次投资，他们必须创建一个新的ICOPool合同。</p><h2 id="b437" class="lp kl if bd km lq lr ls kq lt lu lv ku jn lw lx ky jr ly lz lc jv ma mb lg mc dt translated">收回代币</h2><p id="c7b0" class="pw-post-body-paragraph jc jd if je b jf li jh ji jj lj jl jm jn lk jp jq jr ll jt ju jv lm jx jy jz hn dt translated">完成上一步后，目标ICO的令牌应持有我们ICOPool的令牌余额。</p><p id="3cba" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您应该能够通过调用令牌的balanceOf()函数来检查这一点，方法是将ICOPool的地址传递给它。</p><p id="08a9" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">因此，每个贡献者还需要完成一个步骤；收回每个人有权得到的代币。</p><pre class="kc kd ke kf fq mw mx my mz aw na dt"><span id="02fd" class="lp kl if mx b fv nb nc l nd ne">function withdrawTokens(address _tokenAddress) public {<br/>        require(contributorsBalance[msg.sender] &gt; 0);<br/>        <br/>        ERC20 token = ERC20(_tokenAddress);<br/>        require (token.balanceOf(this) &gt; 0);<br/>        <br/>        // tokenBalance is always the max tokens the pool bought (balanceOf + already withdrawn)<br/>        uint tokenBalance = token.balanceOf(this).add(tokensWithdrawn);<br/>        <br/>        // Get contributor share based on his contribution vs total pool<br/>        // poolBalance (total wei pooled) -&gt; contributorsBalance[msg.sender] (wei put by msg.sender)<br/>        // tokenBalance (total tokens bought with poolBalance) -&gt; tokensToWithdraw (how many tokens corresponds to msg.sender)<br/>        uint tokensToWithdraw = tokenBalance.mul(contributorsBalance[msg.sender]).div(poolBalance);<br/>        tokensToWithdraw = tokensToWithdraw.sub(tokensWithdrawnByContributor[msg.sender]);<br/>        <br/>        require(tokensToWithdraw &gt; 0);<br/>        <br/>        // Keep track of tokens already withdrawn<br/>        tokensWithdrawn = tokensWithdrawn.add(tokensToWithdraw);<br/>        tokensWithdrawnByContributor[msg.sender] = tokensWithdrawnByContributor[msg.sender].add(tokensToWithdraw);<br/>        <br/>        // Transfer calculated tokens to msg.sender<br/>        require(token.transfer(msg.sender,tokensToWithdraw));<br/>    }</span></pre><p id="31a2" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">正如我上面提到的，ICOPool契约现在持有它购买的令牌。现在由每个贡献者调用withdraw tokens(address _ token address)函数来撤回他们自己的令牌。</p><p id="1278" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">请注意，该函数需要一个参数，即令牌的地址，不要与ICO的地址混淆。此时，ICO没有任何用处，我们需要的是改变令牌的所有权，因此我们需要获得令牌地址。</p><p id="4800" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当其中一个贡献者调用此函数时，它将根据该池收到的总金额以及此人的贡献代表多少来计算他们有权获得多少代币。例如，假设总池余额为100 eth，用于购买100.000个代币。如果我投资30以太，那么我将有权获得30.000代币。</p><p id="cc94" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该函数将计算出购买的所有令牌中有多少对应于贡献者，然后调用令牌上的转移函数，从合同向贡献者进行转移。</p><p id="b613" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您再次调用balanceOf()，那么贡献者现在应该拥有这么多令牌，而契约应该更少。</p><p id="6b1a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">需要注意的一点是，这个函数被设计成贡献者可以不止一次地调用它，如果有比以前更多的令牌，他将得到差额。如果我之前提到ICOPool契约只能购买一次令牌，您可能会奇怪我们为什么要这样做。嗯，除了购买代币，我们的ICOPool合同还有可能收到代币。一些ico最近正在实施一种流行的营销实践，称为空投，他们基本上是向随机地址发送令牌，以推广他们的产品。我们的withdrawTokens()函数的工作方式也允许贡献者获得他们的代币份额。</p><h1 id="1ff6" class="kk kl if bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">从这里去哪里</h1><p id="4133" class="pw-post-body-paragraph jc jd if je b jf li jh ji jj lj jl jm jn lk jp jq jr ll jt ju jv lm jx jy jz hn dt translated">这份合同有许多可以改进的地方。例如:</p><ul class=""><li id="3e38" class="md me if je b jf jg jj jk jn ms jr mt jv mu jz mi mj mk ml dt translated">部署合同的人(即管理员)将比其他贡献者产生更多的成本，因为他必须支付部署ICOPool合同所需的费用，而且他不会因此得到补偿。我们可以设计一些方案，奖励组织投资池的人更多的代币。</li><li id="5cab" class="md me if je b jf mm jj mn jn mo jr mp jv mq jz mi mj mk ml dt translated">我们可以给它加上一个截止日期，如果到那个日期还没有买到代币，这个池就被取消了。</li><li id="8299" class="md me if je b jf mm jj mn jn mo jr mp jv mq jz mi mj mk ml dt translated">如果众筹合同有一些标准或通用的协议，我们可以让我们的合同对贡献者更友好。</li><li id="413a" class="md me if je b jf mm jj mn jn mo jr mp jv mq jz mi mj mk ml dt translated">合同可以修改，允许投资于一个以上的ICO，甚至决定，以某种方式，投资于哪些ICO给他们的奖金计划。</li></ul><p id="062f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你有兴趣执行这份投资ICO的合同，请给我写信。请联系我，如果你发现任何错误或你想讨论这个代码的任何部分。</p></div><div class="ab cl nf ng hc nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="hn ho hp hq hr"><p id="1506" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我希望你喜欢读这篇文章，就像我喜欢写这篇文章一样。我目前正在从事与智能合同开发相关的咨询工作。如果你打算通过ICO筹集资金，或者开发基于区块链的产品，请随时与我联系。</p><figure class="kc kd ke kf fq hw"><div class="bz el l di"><div class="nm nn l"/></div></figure></div></div>    
</body>
</html>