<html>
<head>
<title>Highly Available Docker Registry on AWS with Nexus</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有Nexus的AWS高可用性码头工人登记处</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/highly-available-docker-registry-on-aws-with-nexus-2a4c661c8ddf?source=collection_archive---------10-----------------------#2017-12-16">https://medium.com/hackernoon/highly-available-docker-registry-on-aws-with-nexus-2a4c661c8ddf?source=collection_archive---------10-----------------------#2017-12-16</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/bb1ac3cba660270555bc85015b45a25a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a-0mOLWN9r9V7u950qmr6A.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Containers … Everywhere !</figcaption></figure><p id="a393" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">您是否想过如何构建一个高可用性和弹性的码头工人存储库来存储您的<strong class="ji hv">码头工人图像</strong>？</p><figure class="kf kg kh ki fq iv fe ff paragraph-image"><div class="fe ff ke"><img src="../Images/dfb97b6195594008f710ce14ba4442c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:582/0*jVSqIMqHHCFcTEdU."/></div></figure><p id="25a8" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在本文中，我们将在<strong class="ji hv">安全组</strong>内设置一个<strong class="ji hv"> EC2 </strong>实例，并创建一条指向服务器<strong class="ji hv">弹性IP </strong>地址的<strong class="ji hv"> A记录</strong>如下:</p><figure class="kf kg kh ki fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kj"><img src="../Images/d35b9793d3e0fcc6298ad59e51dc3d07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r3tkThA7TgYYwRVg.png"/></div></div></figure><p id="93d3" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">为了提供基础设施，我们将使用<strong class="ji hv"> Terraform </strong>作为<strong class="ji hv"> IaC </strong>(基础设施作为代码)工具。使用此类工具的优势在于，能够在发生事故(<strong class="ji hv">灾难恢复</strong>)时，在不同的<strong class="ji hv"> AWS区域</strong>(或不同的<strong class="ji hv"> IaaS </strong>提供商)快速构建新环境。</p><p id="e64b" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">首先克隆以下<strong class="ji hv"> Github </strong>存储库:</p><blockquote class="kk kl km"><p id="d4bb" class="jg jh kn ji b jj jk jl jm jn jo jp jq ko js jt ju kp jw jx jy kq ka kb kc kd hn dt translated">git克隆体<a class="ae kr" href="https://github.com/mlabouardy/terraform-aws-labs.git" rel="noopener ugc nofollow" target="_blank">https://github.com/mlabouardy/terraform-aws-labs.git</a></p></blockquote><p id="a7f3" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在<em class="kn"> docker-registry </em>文件夹中，用您自己的AWS凭据更新<em class="kn">vars</em>(确保您有正确的<strong class="ji hv"> IAM </strong>策略)。</p><figure class="kf kg kh ki fq iv"><div class="bz el l di"><div class="ks kt l"/></div></figure><p id="0a84" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我指定了一个shell脚本，在启动实例时用作<em class="kn"> user_data </em>。它只需安装最新版本的<strong class="ji hv"> Docker CE </strong>并将实例转换为<strong class="ji hv"> Docker Swarm模式</strong>(以受益于Nexus container的复制&amp;高可用性)</p><figure class="kf kg kh ki fq iv"><div class="bz el l di"><div class="ks kt l"/></div></figure><p id="233e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">注意:当然，您可以使用<strong class="ji hv">配置管理工具</strong>如<strong class="ji hv"> Ansible </strong>或<strong class="ji hv">大厨</strong>来配置创建后的服务器。</p><p id="d1f4" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然后，发出以下命令来创建基础架构:</p><blockquote class="kk kl km"><p id="df9a" class="jg jh kn ji b jj jk jl jm jn jo jp jq ko js jt ju kp jw jx jy kq ka kb kc kd hn dt translated">terra form apply-var-file = variables . tfvars</p></blockquote><p id="9b82" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">一旦创建，您应该会看到您的实例的<strong class="ji hv">弹性IP </strong>:</p><figure class="kf kg kh ki fq iv fe ff paragraph-image"><div class="fe ff ku"><img src="../Images/05a7bb1e6fd984c55e895a16c01cd1db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*oSdU6GRDMtxG8Aft."/></div></figure><p id="9695" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">通过SSH连接到您的实例:</p><blockquote class="kk kl km"><p id="b6e7" class="jg jh kn ji b jj jk jl jm jn jo jp jq ko js jt ju kp jw jx jy kq ka kb kc kd hn dt translated">宋承宪ec2-user@35.177.167.36</p></blockquote><p id="23ce" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">确认<strong class="ji hv">码头工人引擎</strong>正在<strong class="ji hv">集群模式</strong>下运行:</p><figure class="kf kg kh ki fq iv fe ff paragraph-image"><div class="fe ff ku"><img src="../Images/49bcd684ceaf9d22c255328febb9b9d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*wMcVG1WwHd8XuZZj."/></div></figure><p id="2343" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">检查<strong class="ji hv"> Nexus </strong>服务是否正在运行:</p><figure class="kf kg kh ki fq iv fe ff paragraph-image"><div class="fe ff ku"><img src="../Images/ee5948ff1d4c45fbcb82ebfa33df43b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*ir4tISfzBQRkznWo."/></div></figure><p id="4354" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如果您回到您的<strong class="ji hv"> AWS管理控制台</strong>。然后，导航到<strong class="ji hv"> Route53仪表盘</strong>，您会看到一条指向实例IP地址的新的A记录已经创建。</p><figure class="kf kg kh ki fq iv fe ff paragraph-image"><div class="fe ff kv"><img src="../Images/4372d8838538e6cc5764b57ef57453f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/0*XpHe5DMX9nhEM_oD."/></div></figure><p id="9c61" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">将您喜爱的浏览器指向<strong class="ji hv"> Nexus仪表盘URL</strong>(registry . slowcoder . com:8081)。登录并创建一个Docker托管的注册表，如下所示:</p><figure class="kf kg kh ki fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kw"><img src="../Images/3fce7b19b0f3137c0084d9377f172dc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4SWaBf9NcuKSo717."/></div></div></figure><p id="9d94" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">编辑<em class="kn">/etc/docker/daemon . JSON</em>文件，它应该有以下内容:</p><blockquote class="kk kl km"><p id="a189" class="jg jh kn ji b jj jk jl jm jn jo jp jq ko js jt ju kp jw jx jy kq ka kb kc kd hn dt">{</p><p id="8393" class="jg jh kn ji b jj jk jl jm jn jo jp jq ko js jt ju kp jw jx jy kq ka kb kc kd hn dt translated">"不安全-注册表":[" registry . slowcoder . com:5000 "]</p><p id="2e49" class="jg jh kn ji b jj jk jl jm jn jo jp jq ko js jt ju kp jw jx jy kq ka kb kc kd hn dt">}</p></blockquote><p id="f261" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">注意:对于生产，强烈建议使用由已知CA颁发的<strong class="ji hv"> TLS </strong>证书来保护您的注册表。</p><p id="8353" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">重新启动Docker以使更改生效:</p><blockquote class="kk kl km"><p id="9ddc" class="jg jh kn ji b jj jk jl jm jn jo jp jq ko js jt ju kp jw jx jy kq ka kb kc kd hn dt translated">服务docker重启</p></blockquote><p id="128b" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">使用Nexus凭证登录您的注册中心(<em class="kn"> admin/admin123 </em>):</p><figure class="kf kg kh ki fq iv fe ff paragraph-image"><div class="fe ff ku"><img src="../Images/673d80a0d6bd8b599e17c035823b24dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*E6a-A0xF0XxhF_AL."/></div></figure><p id="b046" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">要将新映像推送到注册表:</p><blockquote class="kk kl km"><p id="d84a" class="jg jh kn ji b jj jk jl jm jn jo jp jq ko js jt ju kp jw jx jy kq ka kb kc kd hn dt translated">docker推送registry . slow coder . com:5000/mlabouardy/movies-API:1 . 0 . 0-beta</p></blockquote><figure class="kf kg kh ki fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kx"><img src="../Images/25c87b3f178334cec647e298fab3a40e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KOCGv7zK0tlSM8eY."/></div></div></figure><p id="a1b1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">验证映像已被推送到远程存储库:</p><figure class="kf kg kh ki fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ky"><img src="../Images/9a741dfc133c19d25aada2af81e07f37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*64RHg_2doRQNeJaR."/></div></div></figure><p id="512f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">要提取Docker图像:</p><blockquote class="kk kl km"><p id="b9f0" class="jg jh kn ji b jj jk jl jm jn jo jp jq ko js jt ju kp jw jx jy kq ka kb kc kd hn dt translated">docker pull registry . slow coder . com:5000/mlabouardy/movies-API:1 . 0 . 0-beta</p></blockquote><figure class="kf kg kh ki fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kz"><img src="../Images/a18b6210ac8b8966b6f0a12e390713aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2dVyGUaEF0Muw86o."/></div></div></figure><p id="b8a7" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">注意:有时你会得到许多未使用的悬挂图像，这些图像会很快占用大量磁盘空间:</p><figure class="kf kg kh ki fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ky"><img src="../Images/c3a891dbcff9f031078733f4a576c375.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*op3wc4WpvKHtr-oA."/></div></div></figure><p id="041d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">您可以使用<a class="ae kr" href="https://github.com/mlabouardy/nexus-cli" rel="noopener ugc nofollow" target="_blank"> Nexus CLI </a>工具或创建<strong class="ji hv"> Nexus任务</strong>来清理旧的Docker映像:</p><figure class="kf kg kh ki fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff la"><img src="../Images/0364a871066a7ddaae7fbfaa3fd3bc92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Yd9tg1ewh-un6ee_."/></div></div></figure><p id="099b" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">按如下方式填充表单:</p><figure class="kf kg kh ki fq iv fe ff paragraph-image"><div class="fe ff ku"><img src="../Images/9b5a4be59b69fe81a0b93c23a72d5768.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*FQXIEcmMKnc7d5hB."/></div></figure><p id="93a1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">上述任务将在每天午夜运行，从“<strong class="ji hv"> mlabouardy </strong>”注册表中清除未使用的docker图像。</p></div></div>    
</body>
</html>