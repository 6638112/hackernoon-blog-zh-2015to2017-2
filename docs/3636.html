<html>
<head>
<title>Building a static website generator with React, AWS Lambda and Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用React、AWS Lambda和Terraform构建静态网站生成器</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/building-a-static-website-generator-with-react-and-terraform-823be0b24b12?source=collection_archive---------3-----------------------#2017-04-13">https://medium.com/hackernoon/building-a-static-website-generator-with-react-and-terraform-823be0b24b12?source=collection_archive---------3-----------------------#2017-04-13</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="ed8c" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">使用Terraform创建AWS云服务的指南</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/7ccc182668cd1e122d286741e3310223.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cAnDsVQAo_aZmxsnDJCuGw.png"/></div></div></figure><p id="01b2" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我周末的目标是最终发布一些东西到我的领域。我一直在玩<a class="ae kr" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank">地形</a>，一直在寻找一个借口来建立一个实际的项目，所以我决定扣动扳机，最终致力于它。</p><p id="3b34" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">在思考到底要做什么的时候，我意识到我没有太多典型的作品集内容，但我在其他服务上分享工作，比如Github和<a class="ae kr" href="https://hackernoon.com/tagged/twitter" rel="noopener ugc nofollow" target="_blank"> Twitter </a>。我知道我也不想花太多时间去考虑在上面放什么。</p><p id="f35c" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我最终建立的是一个自我更新的静态网站。web服务从<a class="ae kr" href="https://hackernoon.com/tagged/github" rel="noopener ugc nofollow" target="_blank"> Github </a>、Twitter和Medium汇总我的最新活动，生成一个静态网站，并将内容发布到我的域。除了作为一个过度设计的、不可转让的名片，当添加到iOS主屏幕时，它还是我最常用的应用程序的便捷启动器<a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/app/components/Template.tsx#L24" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="7952" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这是最终产品:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="ks kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek"><a class="ae kr" href="http://jschr.io" rel="noopener ugc nofollow" target="_blank">jschr.io</a> — Add to iOS home screen</figcaption></figure><p id="5207" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我用React、Webpack和Terraform搭建的。如果你想直接跳到代码，Github 上有<a class="ae kr" href="https://github.com/jschr/jschr.io" rel="noopener ugc nofollow" target="_blank">以及如何部署你自己版本的说明。</a></p><p id="21fd" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果您对所选堆栈和项目结构的深入概述感兴趣，请继续阅读。这些示例是用<a class="ae kr" href="https://www.typescriptlang.org/" rel="noopener ugc nofollow" target="_blank">类型脚本</a>编写的，并假设您对<a class="ae kr" href="https://facebook.github.io/react/" rel="noopener ugc nofollow" target="_blank"> React </a>和<a class="ae kr" href="https://webpack.js.org/" rel="noopener ugc nofollow" target="_blank"> Webpack </a>有所了解。</p><h1 id="fb98" class="ky kz hu bd la lb lc ld le lf lg lh li ja lj jb lk jd ll je lm jg ln jh lo lp dt translated">什么是Terraform？</h1><p id="5afd" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated"><a class="ae kr" href="https://www.terraform.io/intro/index.html" rel="noopener ugc nofollow" target="_blank"> Terraform </a>是一个用声明性配置文件创建基础设施代码的工具。将基础设施编写为代码的一个主要好处是免费的，您可以获得版本控制、代码审查和协作的所有功能。</p><p id="85fe" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">有了Terraform的声明式配置文件，您可以使用<a class="ae kr" href="https://www.terraform.io/docs/configuration/variables.html" rel="noopener ugc nofollow" target="_blank">变量</a>和<a class="ae kr" href="https://www.terraform.io/docs/configuration/modules.html" rel="noopener ugc nofollow" target="_blank">模块</a>来轻松创建和管理您的基础设施。Terraform类似于AWS的CloudFormation，除了它有一个<a class="ae kr" href="https://www.terraform.io/docs/providers/index.html" rel="noopener ugc nofollow" target="_blank">不断增长的提供商列表</a>，你可以使用它在许多其他云服务中创建资源。</p><p id="ca0e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">下面是一个地形配置的样子:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Terraform config to create an AWS S3 bucket.</figcaption></figure><p id="8c6c" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">查看<a class="ae kr" href="https://www.terraform.io/intro/index.html" rel="noopener ugc nofollow" target="_blank">介绍文档</a>了解更多使用案例和比较。Terraform是由Hashicorp的团队建造的。</p><h1 id="5dfc" class="ky kz hu bd la lb lc ld le lf lg lh li ja lj jb lk jd ll je lm jg ln jh lo lp dt translated">项目结构</h1><p id="2744" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">让我们从应用程序结构的概述开始:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">High-level view of the project structure.</figcaption></figure><h1 id="8c8a" class="ky kz hu bd la lb lc ld le lf lg lh li ja lj jb lk jd ll je lm jg ln jh lo lp dt translated">创建Webpack配置</h1><p id="5e39" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">第一步也是最神奇的一步是创建webpack配置。如果没有这个棒极了的webpack静态网站生成器插件<a class="ae kr" href="https://github.com/markdalgleish/static-site-generator-webpack-plugin" rel="noopener ugc nofollow" target="_blank">,这个项目就不会这么简单。</a></p><p id="5694" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">下面是一个使用插件的简单webpack配置:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Basic webpack config for generating a static website.</figcaption></figure><blockquote class="lw lx ly"><p id="5ad0" class="jv jw lz jx b jy jz iv ka kb kc iy kd ma kf kg kh mb kj kk kl mc kn ko kp kq hn dt translated"><strong class="jx hv">提示#1 </strong>:如果Webpack具有. ts扩展名，并且在本地为您的项目安装了<a class="ae kr" href="https://github.com/TypeStrong/ts-node" rel="noopener ugc nofollow" target="_blank"> ts-node </a>，那么它支持配置文件的Typescript。</p></blockquote><p id="d894" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">通过静态站点生成器插件的locals选项传递的每个属性都将被发送到服务器端的render函数。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Example server-side render function.</figcaption></figure><p id="8b69" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">每当我们生成一个新的静态网站时，使用本地选项是我们将如何传递应用程序的道具。</p><p id="1b1c" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">为了让我们的网站更加动态，下一步是将它与一些真实的数据联系起来。您可以从本地markdown文件中提取数据，或者从API中获取数据。在能够获取任何内容之前，我们需要对webpack配置进行一些更改。</p><p id="d468" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">为了利用<a class="ae kr" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function" rel="noopener ugc nofollow" target="_blank"> async/await </a>,我们将转换我们的配置以导出一个异步函数，该函数与webpack一起开箱即用。然后，我们可以从Github获取最新的活动，并使用getProps函数呈现应用程序。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">An async webpack config to fetch data for generating our static website, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/app/webpack.config.ts" rel="noopener ugc nofollow" target="_blank">view the full source</a>.</figcaption></figure><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Our getProps function to fetch the latest activity from Github, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/app/getProps.ts" rel="noopener ugc nofollow" target="_blank">view full the source</a>.</figcaption></figure><blockquote class="lw lx ly"><p id="0580" class="jv jw lz jx b jy jz iv ka kb kc iy kd ma kf kg kh mb kj kk kl mc kn ko kp kq hn dt translated">提示#2  : Webpack支持从配置文件中导出函数。它将接收您通过命令行设置的任何env选项。</p></blockquote><p id="687a" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">webpack配置的完整源代码可以在repo 中找到<a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/app/webpack.config.ts" rel="noopener ugc nofollow" target="_blank">。相同的配置用于启动dev服务器，并在我们的Lambda函数中生成一个新的静态网站。</a></p><h1 id="9a36" class="ky kz hu bd la lb lc ld le lf lg lh li ja lj jb lk jd ll je lm jg ln jh lo lp dt translated">服务器端渲染</h1><p id="7ec7" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">服务器端渲染函数接收我们在webpack配置中获取的应用程序属性以及一个<a class="ae kr" href="https://webpack.js.org/configuration/stats/" rel="noopener ugc nofollow" target="_blank">统计对象</a>，我们可以用它将javascript包注入html。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">The server-side rendering function, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/app/ssr.tsx" rel="noopener ugc nofollow" target="_blank">view the full source</a>.</figcaption></figure><p id="1342" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">该模板接收html字符串形式的初始应用渲染、客户端需要的来自服务器的任何数据(可通过<a class="ae kr" href="https://developer.mozilla.org/en-US/docs/Web/API/Window" rel="noopener ugc nofollow" target="_blank">窗口对象</a>访问)以及需要注入的任何javascript包。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">The template component, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/app/components/Template.tsx" rel="noopener ugc nofollow" target="_blank">view the full source</a>.</figcaption></figure><h1 id="7457" class="ky kz hu bd la lb lc ld le lf lg lh li ja lj jb lk jd ll je lm jg ln jh lo lp dt translated">登上大教堂</h1><p id="fec0" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">在呈现初始页面负载后，浏览器需要使用与呈现html相同的属性来引导React应用程序。这发生在mount函数中，我们需要确保只有在浏览器中运行时<strong class="jx hv">才会被调用。</strong></p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Bootstrapping React in the browser, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/app/mount.tsx" rel="noopener ugc nofollow" target="_blank">view the full source</a>.</figcaption></figure><p id="d9ac" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">请注意，index.ts <strong class="jx hv"> </strong>在<strong class="jx hv"> </strong>中运行，同时在<strong class="jx hv">节点</strong>和<strong class="jx hv">浏览器上下文</strong>中运行，因此<a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/app/components/App.tsx#L86" rel="noopener ugc nofollow" target="_blank">在导入依赖于浏览器API的库时，您需要格外小心</a>。</p><p id="ce28" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在我们已经设置了服务器端渲染和浏览器客户端，让我们添加一些样式。</p><h1 id="7860" class="ky kz hu bd la lb lc ld le lf lg lh li ja lj jb lk jd ll je lm jg ln jh lo lp dt translated">增添时尚魅力</h1><p id="a065" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">我选择了使用<a class="ae kr" href="https://github.com/threepointone/glamor" rel="noopener ugc nofollow" target="_blank"> glamor </a>进行造型，<a class="ae kr" href="https://github.com/Khan/aphrodite" rel="noopener ugc nofollow" target="_blank">一个</a> <a class="ae kr" href="https://github.com/styled-components/styled-components" rel="noopener ugc nofollow" target="_blank">的</a> <a class="ae kr" href="https://github.com/rtsao/styletron" rel="noopener ugc nofollow" target="_blank">多个</a> <a class="ae kr" href="https://github.com/gajus/babel-plugin-react-css-modules" rel="noopener ugc nofollow" target="_blank">伟大的</a> <a class="ae kr" href="https://github.com/MicheleBertoli/css-in-js" rel="noopener ugc nofollow" target="_blank">选项</a>进行css在React。</p><p id="cd5f" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">为什么魅力？</p><ul class=""><li id="5e04" class="md me hu jx b jy jz kb kc ke mf ki mg km mh kq mi mj mk ml dt translated">它支持服务器端渲染，尽管<a class="ae kr" href="https://github.com/jschr/jschr.io/issues/3" rel="noopener ugc nofollow" target="_blank">有些令人不快</a></li><li id="d5d4" class="md me hu jx b jy mm kb mn ke mo ki mp km mq kq mi mj mk ml dt translated">CSS模块<a class="ae kr" rel="noopener" href="/@mattvagni/server-side-rendering-with-css-modules-6b02f1238eb1">看起来更难设置服务器端</a></li><li id="9efd" class="md me hu jx b jy mm kb mn ke mo ki mp km mq kq mi mj mk ml dt translated">越来越喜欢用js编写css，因为你拥有javascript的所有特性</li></ul><p id="cde8" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">为项目增添魅力包括两个步骤:</p><ul class=""><li id="5896" class="md me hu jx b jy jz kb kc ke mf ki mg km mh kq mi mj mk ml dt translated">在服务器端呈现函数中生成css样式表，并将其传递给初始页面加载css的模板组件</li><li id="c7b3" class="md me hu jx b jy mm kb mn ke mo ki mp km mq kq mi mj mk ml dt translated">复水glamor的服务器状态浏览器端</li></ul><p id="666a" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">Glamor有自己的渲染功能，用于服务器端渲染，返回应用程序的初始html和渲染过程中创建的任何样式。当使用glamor进行服务器端渲染时，需要注意与导入顺序相关的几个问题<a class="ae kr" href="https://github.com/threepointone/glamor/blob/master/docs/server.md" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Adds styling via glamor to the ssr function and template component.</figcaption></figure><p id="6200" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在我们只需要在浏览器中恢复服务器状态:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Rehydrate glamor state in the browser.</figcaption></figure><p id="e3f0" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这里是你开始添加一堆组件的地方，但是我将跳过创建和样式化组件，转到实际的Lambda函数。如果你好奇的话，你可以在回购协议中看到我为我的网站<a class="ae kr" href="https://github.com/jschr/jschr.io/tree/master/app/components" rel="noopener ugc nofollow" target="_blank">制作的组件。</a></p><h1 id="0a79" class="ky kz hu bd la lb lc ld le lf lg lh li ja lj jb lk jd ll je lm jg ln jh lo lp dt translated">λ函数</h1><p id="aa03" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">对于我们的后端，我们将设置一个<a class="ae kr" href="https://aws.amazon.com/lambda/details/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>函数来运行webpack编译器，并将结果上传到S3桶。Lambda需要的只是一个javascript函数，AWS将为您提供和管理资源。</p><p id="a160" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这是整个Lambda函数:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">The Lambda handler, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/app/handler.tsx" rel="noopener ugc nofollow" target="_blank">view the full source</a>.</figcaption></figure><blockquote class="lw lx ly"><p id="49a3" class="jv jw lz jx b jy jz iv ka kb kc iy kd ma kf kg kh mb kj kk kl mc kn ko kp kq hn dt translated"><strong class="jx hv">提示#3 </strong>:您可以使用<a class="ae kr" href="https://github.com/webpack/memory-fs" rel="noopener ugc nofollow" target="_blank"> memory-fs </a>将webpack构建输出到内存，而不是文件系统</p></blockquote><p id="de1a" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">在编译步骤之后，Lambda会将文件上传到S3，并使CloudFront发行版失效。除了设置CloudFront，您还可以<a class="ae kr" href="http://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html" rel="noopener ugc nofollow" target="_blank">将bucket配置为一个静态网站</a>。</p><h1 id="35ed" class="ky kz hu bd la lb lc ld le lf lg lh li ja lj jb lk jd ll je lm jg ln jh lo lp dt translated">基础设施</h1><p id="4459" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">现在，我们准备开始创建基础架构。我将使用AWS Lambda、S3和CloudFront托管网站，并使用<a class="ae kr" href="https://www.mailgun.com/" rel="noopener ugc nofollow" target="_blank"> Mailgun </a>发送和接收电子邮件。</p><p id="edeb" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">以下是地形结构的概述:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Terraform infrastructure overview.</figcaption></figure><p id="e680" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">Terraform从您要部署的环境的目录中执行。在这种情况下，我们只有一个环境，从env-dev运行<em class="lz"> terraform apply </em>将部署开发基础设施。</p><p id="b6b5" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">每次部署后，Terraform sill会将所创建资源的状态保存到当前目录下的一个<a class="ae kr" href="https://www.terraform.io/docs/state/" rel="noopener ugc nofollow" target="_blank"> terraform.tfstate </a>文件中。在大型团队中工作时，您可能希望使用<a class="ae kr" href="https://www.terraform.io/docs/state/remote.html" rel="noopener ugc nofollow" target="_blank">远程状态</a>。</p><h2 id="5a86" class="mr kz hu bd la ms mt mu le mv mw mx li ke my mz lk ki na nb lm km nc nd lo ne dt translated">设置环境</h2><p id="f96f" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">为了部署环境，我们需要创建它的<a class="ae kr" href="https://www.terraform.io/intro/getting-started/variables.html#from-a-file" rel="noopener ugc nofollow" target="_blank">地形变量文件</a>。这是我们的精简版:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Terraform variables for dev, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/infrastructure/env-dev/vars.tfvars.sample" rel="noopener ugc nofollow" target="_blank">view the full source</a>.</figcaption></figure><p id="4d49" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">当您运行<em class="lz"> terraform apply </em>时，它将运行<strong class="jx hv">当前目录下的每个配置文件</strong>。因为我们从env-dev运行命令，所以只有一个文件——dev . TF。</p><p id="3922" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">dev配置文件通过AWS和Mailgun认证，然后创建应用程序的基础设施。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Terraform environment config, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/infrastructure/env-dev/dev.tf" rel="noopener ugc nofollow" target="_blank">view the full source</a>.</figcaption></figure><h2 id="0523" class="mr kz hu bd la ms mt mu le mv mw mx li ke my mz lk ki na nb lm km nc nd lo ne dt translated">应用程序模块</h2><p id="cea8" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated"><a class="ae kr" href="https://www.terraform.io/docs/modules/usage.html" rel="noopener ugc nofollow" target="_blank"> Terraform模块</a>让我们创建基础设施的可重用组件。Terraform可以使用来自文件系统、Github和<a class="ae kr" href="https://www.terraform.io/docs/modules/sources.html" rel="noopener ugc nofollow" target="_blank">其他远程资源</a>的模块。这个项目为整个应用程序使用一个本地模块，但是你可以根据你的需要用任意多的模块组成你的基础设施。</p><p id="ad6e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">要创建app模块，我们将从定义其输入变量开始:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Terraform config for the app module’s variables, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/infrastructure/modules/app/variables.tf" rel="noopener ugc nofollow" target="_blank">view the full source</a>.</figcaption></figure><p id="3e9d" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这种设置使我们能够在未来轻松创建更多环境，如环境暂存和环境生产。</p><p id="b971" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在我们可以开始为我们的应用程序创建所有的资源。</p><h2 id="2d2e" class="mr kz hu bd la ms mt mu le mv mw mx li ke my mz lk ki na nb lm km nc nd lo ne dt translated">添加Lambda函数</h2><p id="3f18" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">构建项目将打包我们的应用程序并上传到Lambda。当我们部署时，Terraform将使用包的散列来决定是否部署新版本的处理程序。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Lambda terraform config, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/infrastructure/modules/app/lambda.tf" rel="noopener ugc nofollow" target="_blank">view the full source</a>.</figcaption></figure><h2 id="3695" class="mr kz hu bd la ms mt mu le mv mw mx li ke my mz lk ki na nb lm km nc nd lo ne dt translated">添加S3桶</h2><p id="4226" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">为我们的领域创建一个私人S3桶。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">S3 bucket terraform config, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/infrastructure/modules/app/s3.tf" rel="noopener ugc nofollow" target="_blank">view the full source</a>.</figcaption></figure><h2 id="110e" class="mr kz hu bd la ms mt mu le mv mw mx li ke my mz lk ki na nb lm km nc nd lo ne dt translated">使用CloudWatch调度Lambda</h2><p id="7ce2" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">我们将使用<a class="ae kr" href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/events/WhatIsCloudWatchEvents.html" rel="noopener ugc nofollow" target="_blank"> CloudWatch事件</a>每15分钟触发一次我们的Lambda。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">CloudWatch terraform config, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/infrastructure/modules/app/cloudwatch.tf" rel="noopener ugc nofollow" target="_blank">view the source</a>.</figcaption></figure><h2 id="eda3" class="mr kz hu bd la ms mt mu le mv mw mx li ke my mz lk ki na nb lm km nc nd lo ne dt translated">添加CloudFront CDN</h2><p id="5bf9" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">为我们的S3桶创建一个CloudFront发行版。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">CloudFront terraform config, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/infrastructure/modules/app/cloudfront.tf" rel="noopener ugc nofollow" target="_blank">view the full source.</a></figcaption></figure><h2 id="44bd" class="mr kz hu bd la ms mt mu le mv mw mx li ke my mz lk ki na nb lm km nc nd lo ne dt translated">添加DNS记录</h2><p id="cab5" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">假设您已经在Route 53中注册了您的域，我们将使用<a class="ae kr" href="https://www.terraform.io/docs/configuration/data-sources.html" rel="noopener ugc nofollow" target="_blank">数据源</a>按名称获取我们的域的托管区域，并为我们的网站创建DNS条目。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Route 53 terraform config, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/infrastructure/modules/app/cloudfront.tf" rel="noopener ugc nofollow" target="_blank">view the full source</a>.</figcaption></figure><h2 id="1571" class="mr kz hu bd la ms mt mu le mv mw mx li ke my mz lk ki na nb lm km nc nd lo ne dt translated">添加电子枪</h2><p id="42a5" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">通过我们的域名收发电子邮件的最快方式是创建一个<a class="ae kr" href="https://www.mailgun.com/" rel="noopener ugc nofollow" target="_blank"> Mailgun </a>账户。从您的帐户配置文件中检索您的api密钥，并将其添加到dev.tfvars。</p><p id="413b" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">感谢Terraform的<a class="ae kr" href="https://www.terraform.io/docs/providers/mailgun/" rel="noopener ugc nofollow" target="_blank"> Mailgun供应商</a>，我们可以从配置文件中用Mailgun的API创建一个新的域资源:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Mailgun provider terraform config, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/infrastructure/modules/app/mailgun.tf" rel="noopener ugc nofollow" target="_blank">view the full source</a>.</figcaption></figure><p id="7933" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">创建Mailgun域所产生的terraform输出将如下所示:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Mailgun domain output from running <a class="ae kr" href="https://www.terraform.io/docs/commands/show.html" rel="noopener ugc nofollow" target="_blank">terraform show</a>.</figcaption></figure><p id="6855" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">理想情况下，我们可以告诉Terraform为每个接收记录和发送记录创建一个DNS条目，但是<a class="ae kr" href="https://github.com/hashicorp/terraform/issues/12570" rel="noopener ugc nofollow" target="_blank"> Terraform目前不支持使用带有计算值的count】。</a></p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Mailgun route 53 count issue.</figcaption></figure><p id="d695" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">因为记录的数量是已知的，所以我们可以手动创建每个记录作为解决方法:</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="lv kt l"/></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Mailgun route 53 terraform config, <a class="ae kr" href="https://github.com/jschr/jschr.io/blob/master/infrastructure/modules/app/mailgun.tf" rel="noopener ugc nofollow" target="_blank">view the full source</a>.</figcaption></figure><p id="2038" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">现在，我们所有的基础设施都是仅使用terraform配置文件设置的，您现在可以运行<a class="ae kr" href="https://www.terraform.io/docs/commands/plan.html" rel="noopener ugc nofollow" target="_blank"> <em class="lz"> terraform计划</em> </a> <em class="lz"> </em>来预览更改，然后<a class="ae kr" href="https://www.terraform.io/docs/commands/apply.html" rel="noopener ugc nofollow" target="_blank"> <em class="lz"> terraform应用</em> </a>来部署它们。</p><p id="9747" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果你不想在开始接收邮件前等待24小时，你需要在第一次部署后<a class="ae kr" href="https://app.mailgun.com/app/domains" rel="noopener ugc nofollow" target="_blank">触发Mailgun中的域验证</a>。</p><p id="4d02" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">最后一步是添加一个Mailgun路由转发电子邮件到我们的主要帐户。这是我的样子:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff nf"><img src="../Images/e0ac968cb2f5d3060a04670567c33270.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H8fEB-BWd94cwHw-PkZbjw.png"/></div></div><figcaption class="ku kv fg fe ff kw kx bd b be z ek">Mailgun catch-all route for email forwarding.</figcaption></figure><h1 id="88e1" class="ky kz hu bd la lb lc ld le lf lg lh li ja lj jb lk jd ll je lm jg ln jh lo lp dt translated">最后的想法</h1><p id="c96f" class="pw-post-body-paragraph jv jw hu jx b jy lq iv ka kb lr iy kd ke ls kg kh ki lt kk kl km lu ko kp kq hn dt translated">使用Terraform，对基础架构进行更改和构建新环境从未如此简单。我不认为我会很快登录AWS控制台。</p><p id="36df" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">非常欢迎您创建、修改和部署您自己版本的<a class="ae kr" href="https://github.com/jschr/jschr.io" rel="noopener ugc nofollow" target="_blank">源代码</a>。我很乐意听到你的任何改进建议或者我可以在后续文章中添加的酷功能。</p><div class="jk jl jm jn fq ab cb"><figure class="ng jo nh ni nj nk nl paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="ng jo nh ni nj nk nl paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="ng jo nh ni nj nk nl paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="lw lx ly"><p id="f922" class="jv jw lz jx b jy jz iv ka kb kc iy kd ma kf kg kh mb kj kk kl mc kn ko kp kq hn dt translated">黑客中午是黑客如何开始他们的下午。我们是这个家庭的一员。我们现在<a class="ae kr" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae kr" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jv jw lz jx b jy jz iv ka kb kc iy kd ma kf kg kh mb kj kk kl mc kn ko kp kq hn dt translated">如果您喜欢这个故事，我们建议您阅读我们的最新科技故事和<a class="ae kr" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实视为理所当然！</p></blockquote><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff nm"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nn kt l"/></div></figure></div></div>    
</body>
</html>