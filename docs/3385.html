<html>
<head>
<title>Benchmarking Kafka Performance Part 1: Write Throughput</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kafka性能基准测试第1部分:写吞吐量</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/benchmarking-kafka-performance-part-1-write-throughput-7c7a76ab7db1?source=collection_archive---------2-----------------------#2017-03-30">https://medium.com/hackernoon/benchmarking-kafka-performance-part-1-write-throughput-7c7a76ab7db1?source=collection_archive---------2-----------------------#2017-03-30</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="1b09" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://aiven.io/blog/benchmarking-kafka-write-throughput-performance-2019-update/" rel="noopener ugc nofollow" target="_blank"> <em class="jq">要获取我们最新的基准测试，请在此处查看我们2019年的更新</em> </a></p><p id="7811" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们提供完全托管的Kafka服务已经有一段时间了，我们经常被问及在选定的云上，您可以通过给定的服务计划层传输多少消息。因此，这里有一个我们进行的基准测试，让您大致了解Apache Kafka在公共云中的表现。</p><h1 id="24c8" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">卡夫卡是什么？</h1><p id="a10e" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">Apache Kafka是一个<em class="jq">高性能开源流处理平台</em>，用于实时收集和处理大量消息。它使您能够实时、大规模地接受流数据，如网站点击流、事件、交易或其他遥测数据，并将其提供给下游的流处理应用。Kafka是为可伸缩性和容错性而分布式构建的。添加更多水平节点来应对不断增长的负载相当简单，当节点出现故障时，多个节点上的数据自动复制可以保持可用性。<br/> <br/>卡夫卡中的基本概念是<strong class="it hv">生产者</strong>和<strong class="it hv">消费者</strong>。<br/><br/><strong class="it hv">生成器</strong>是一个应用程序，它生成数据，但只是将数据提供给其他应用程序。<br/><br/><strong class="it hv">生产者</strong>应用程序的一个例子可以是一个产生“页面点击”的web服务器，该“页面点击”告知何时从哪个IP地址访问了一个网页，该网页是什么，以及web服务器呈现该网页需要多长时间。<br/> <br/>在<strong class="it hv">消费者</strong>方，可能有多个系统对同一页面命中数据流感兴趣:</p><ul class=""><li id="0c29" class="ku kv hu it b iu iv iy iz jc kw jg kx jk ky jo kz la lb lc dt translated">一个时间序列数据库，用于绘制一段时间内的页面点击总数</li><li id="82b6" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">报告应用程序收集所访问页面的摘要，并将它们发送到数据仓库数据库系统</li><li id="3d7c" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">试图发现异常访问模式的DDoS检测系统</li><li id="cc7d" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">一种速率限制监视器，对来自特定源地址的命中次数进行计数</li><li id="c9c3" class="ku kv hu it b iu ld iy le jc lf jg lg jk lh jo kz la lb lc dt translated">诸如此类…</li></ul><p id="c876" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Kafka非常适合这类应用程序:它提供了一种快速、安全地将数据从生产应用程序手中取出的方法。一旦制作人把信息写给卡夫卡，它就可以确定自己的那部分工作已经完成了。producer应用程序不需要知道数据是如何被哪些应用程序使用的，它只是将数据存储在Kafka中，然后继续运行。<br/> <br/>在消费者方面，Kafka的一个强大特性是它允许多个消费者阅读相同的信息。在上面的web页面点击示例中，每个消费者应用程序都有自己的数据读取指针，它们可以按照自己的速度处理消息，而不会给生产者应用程序带来任何性能问题或延迟。<br/> <br/>大致是这样的:</p><figure class="lj lk ll lm fq ln fe ff paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="fe ff li"><img src="../Images/e2eb62971b1103efc18a13897234f00e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L7ZAk_uPpxUGwy6SLbU5xQ.png"/></div></div></figure><p id="de41" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">动物园管理员集群是保持卡夫卡健康运行的关键部分。它维护了卡夫卡的元数据，最重要的是，卡夫卡节点之间关于谁在做什么的共识。</p><h1 id="3fea" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">艾文·卡夫卡式服务</h1><p id="aa0c" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">Aiven Kafka是一个基于Apache Kafka技术的完全托管服务。我们的目标是尽可能简单地使用Kafka集群，尽可能减少操作工作量。我们为您处理Kafka和Zookeeper的设置和操作，因此您可以专注于增值应用程序逻辑，而不是基础架构维护。Aiven Kafka服务可以在几分钟内启动，我们将确保它们在任何时候都保持可操作、性能良好、最新和安全。节点会自动平均分布在可用的可用区域中，以最大限度地降低丢失任何区域的影响。<br/> <br/> Aiven Kafka在<strong class="it hv">亚马逊网络服务</strong>、<strong class="it hv">微软Azure </strong>、<strong class="it hv">谷歌云平台</strong>、<strong class="it hv"> UpCloud </strong>和<strong class="it hv"> DigitalOcean </strong>中可用，共覆盖53个云区域。在这次性能比较中，我们对除DigitalOcean之外的所有产品进行了基准测试，在digital ocean中，我们的Kafka产品受到可用计划的限制。<br/> <br/>这些测试中使用的每个Kafka服务都是Aiven提供的常规服务，其默认设置没有改变。</p><h1 id="3ae5" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">基准设置</h1><p id="f811" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">在这第一篇Kafka基准测试文章中，我们开始估算不同云中不同Aiven Kafka计划层的最大<em class="jq">写入吞吐率</em>。我们希望使用典型的客户消息大小和标准工具来产生负载。我们还希望通过网络从单独的系统生成负载，以确保负载尽可能模拟实际的客户工作负载。<br/> <br/>测试设置的高级视图，一个具有五个节点的Aiven Kafka服务，均匀分布在可用区域中:</p><figure class="lj lk ll lm fq ln fe ff paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="fe ff li"><img src="../Images/fbb5d24f9a466ab57ac4585ff891c399.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B3KukkBudmqJCgl-M5A1Ag.png"/></div></div></figure><p id="b9f8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们在测试中选择了512字节的消息大小。根据我们的经验，最典型的负载之一是JSON编码的消息，大小在100字节到10千字节之间。<br/> <br/>在这些测试中，我们使用单个主题，其分区计数与每个Aiven计划层的节点计数相匹配。对于更复杂的主题/分区设置，Aiven主动平衡分区的位置，试图实现分区的“完美”分布。在这个测试中，每个节点只有一个分区，所以这很简单。在本测试中，我们将复制因子设置为一(1)，这意味着每条消息只驻留在一个Kafka节点上。<br/>T3【阿帕奇】所用的卡夫卡版本是0.10.1.1。<br/> <br/>对于负载生成，我们从提供的示例中选择使用<a class="ae jp" href="https://github.com/edenhill/librdkafka" rel="noopener ugc nofollow" target="_blank"> librdkafka </a>和<a class="ae jp" href="https://github.com/edenhill/librdkafka/blob/master/examples/rdkafka_performance.c" rel="noopener ugc nofollow" target="_blank"> rdkafka_performance </a>。我们在很大程度上使用默认设置，但将单个请求超时提高到60秒，因为我们预计Kafka代理将处于极端负载下，请求处理将比正常负载水平下花费更长的时间。此外，由于Aiven Kafka服务仅通过加密的TLS连接提供，因此我们包括了这些服务的配置，即所需的证书和密钥。<br/> <br/> librdkafka默认最大批量为10000条消息，或者每个请求的最大请求大小为一百万字节，以最先满足的为准。在这些测试中，我们没有使用压缩。<br/> <br/>道具配置:</p><pre class="lj lk ll lm fq lu lv lw lx aw ly dt"><span id="bd90" class="lz js hu lv b fv ma mb l mc md">metadata.broker.list=target-kafka.benchmark.aivencloud.com:10947<br/>security.protocol=ssl<br/>ssl.key.location=client.key<br/>ssl.certificate.location=client.crt<br/>ssl.ca.location=ca.crt<br/>request.timeout.ms=60000</span></pre><p id="c4a6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们在不同于正被测试的云提供商的多个虚拟机上运行了几个rdkafka_performance实例。因此，所有的测试负载都是通过节点的公共网络接口来自互联网。我们不断增加实例的数量，直到我们能够找到每个计划的饱和点和最大消息速率。<br/> <br/>每个rdkafka_performance实例都是在命令行上使用以下命令启动的:</p><pre class="lj lk ll lm fq lu lv lw lx aw ly dt"><span id="4abe" class="lz js hu lv b fv ma mb l mc md">rdkafka_performance -P -s 512 -t target-topic -X file=producer.props</span></pre><h1 id="d805" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">基准测试结果</h1><p id="393e" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">第一组测试在Aiven Kafka Business-4计划上运行，这是一个三节点集群，是我们许多客户的共同起点。该计划中的每个节点都有4gb的RAM、一个CPU内核和200的磁盘，在集群中提供总共600的原始Kafka存储容量。<br/> <br/>写入性能(3个节点@ 4 GB RAM，1个CPU，每个200 GB磁盘):</p><figure class="lj lk ll lm fq ln fe ff paragraph-image"><div class="fe ff me"><img src="../Images/d0cfdc51ce703d5342151300b4b85586.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/0*PUkJANsc1giVScPQ.png"/></div></figure><p id="0906" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在UpCloud上，我们达到了每秒20万条消息。Azure和谷歌的计划达到每秒120，000和130，000条消息的饱和，亚马逊的部署达到每秒50，000条消息。</p><p id="3f95" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">表演相当不错。由于可用的节点类型，Amazon上的性能有点落后于其他产品，我们将在未来寻找优化的方法。正如您将在下一张图中看到的更大计划的测试，AWS的性能已经与其他提供商更加一致。<br/> <br/>接下来，我们使用Business-8计划测试了三个节点集群，但具有更大的底层实例。该计划的节点具有8gb的RAM、两个CPU核心和每个节点400的磁盘，也就是说，与Business-4计划相比，所有主要资源都增加了一倍。这个测试显示了Kafka如何随着资源的增加而纵向扩展。<br/> <br/>写性能(3个节点@ 8 GB RAM，2个CPU，每个400 GB磁盘):</p><figure class="lj lk ll lm fq ln fe ff paragraph-image"><div class="fe ff me"><img src="../Images/583be23f48c67fe8b9f46d7d90d70fa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/0*5ZSxKLuT7GWl5FHd.png"/></div></figure><p id="dd47" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们看到性能有了很好的提高，UpCloud每秒320，000条消息，Azure每秒205，000条，Google每秒170，000条，AWS每秒160，000条。<br/> <br/>在最后一个测试中，我们想验证卡夫卡的横向缩放有多好。在这个测试中，我们从业务计划层进入高级层，将节点数量从三个增加到五个，同时保持节点规格不变。此外，测试设置也进行了更新，以便在这个测试中使用五个分区(而不是三个)。<br/> <br/>写入性能(5个节点@ 8 GB RAM，2个CPU，每个400 GB磁盘):</p><figure class="lj lk ll lm fq ln fe ff paragraph-image"><div class="fe ff me"><img src="../Images/af77e01ebd7191ddbc117d6b9facb129.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/0*K1Gpv4z3DwIIRivj.png"/></div></figure><p id="a6d0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于Kafka来说，这里的结果是可靠的:节点数量增加了三分之二，写性能直接提高了三分之二。厉害！<br/><br/>up cloud上的Aiven Kafka Premium-8每秒处理53.5万条消息，Azure 40万条，Google 33万条，亚马逊28万条消息/秒。</p><h1 id="60d2" class="jr js hu bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dt translated">基准结论</h1><p id="3f75" class="pw-post-body-paragraph ir is hu it b iu kp iw ix iy kq ja jb jc kr je jf jg ks ji jj jk kt jm jn jo hn dt translated">Apache Kafka的性能与我们预期的一样好，并且随着资源的增加和集群规模的增大而很好地扩展。我们欢迎您使用Aiven对自己的工作负载进行基准测试，并分享您的结果。<br/> <br/>我们利用Kafka作为Aiven中的消息代理，并将其作为传输所有遥测指标和日志的媒介。我们对我们的技术选择很满意，可以推荐Apache Kafka来处理各种流数据。<br/> <br/>在<a class="ae jp" href="https://aiven.io/kafka" rel="noopener ugc nofollow" target="_blank">https://aiven.io/kafka</a>找到更多关于艾文·卡夫卡的信息。</p><div class="lj lk ll lm fq ab cb"><figure class="mf ln mg mh mi mj mk paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mf ln mg mh mi mj mk paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mf ln mg mh mi mj mk paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="ml mm mn"><p id="f922" class="ir is jq it b iu iv iw ix iy iz ja jb mo jd je jf mp jh ji jj mq jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是AMI家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is jq it b iu iv iw ix iy iz ja jb mo jd je jf mp jh ji jj mq jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lj lk ll lm fq ln fe ff paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="fe ff mr"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>