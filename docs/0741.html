<html>
<head>
<title>Pumba — Chaos Testing for Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">pumba——Docker的混沌测试</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/pumba-chaos-testing-for-docker-1b8815c6b61e?source=collection_archive---------0-----------------------#2016-04-09">https://medium.com/hackernoon/pumba-chaos-testing-for-docker-1b8815c6b61e?source=collection_archive---------0-----------------------#2016-04-09</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="e146" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">2016-7-28更新:</strong> Pumba <strong class="it hv"> cli </strong>变更；支持网络仿真。</p><h1 id="2d3f" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">介绍</h1><p id="3959" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">对意外失败的最佳防御是构建弹性服务。弹性测试使团队能够在客户注意到之前发现这些故障。作为弹性测试的一部分，通过有意地导致故障，您可以实施您的策略来构建弹性系统。系统的弹性可以定义为即使系统的某些组件出现故障，系统仍能继续运行的能力——T4的昙花一现。分布式和微服务架构越来越受欢迎，这使得弹性测试对于现在需要24x7x365运行的应用程序至关重要。弹性测试是一种方法，在这种方法中，您有意在基础架构级别(虚拟机、网络、容器和流程)注入不同类型的故障，并让系统尝试从生产中可能发生的这些意外故障中恢复。随时模拟真实的故障是实施高可用性和弹性系统的最佳方式。</p><h1 id="8357" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">Pumba是什么？</h1><figure class="kt ku kv kw fq kx fe ff paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="fe ff ks"><img src="../Images/b031ae9988b3d41dad5aeaa9a39f0ebf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dH4L3KwOYcft37Mz7tIAOA.png"/></div></div></figure><p id="2682" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，<a class="ae le" href="https://en.wikipedia.org/wiki/Timon_and_Pumbaa" rel="noopener ugc nofollow" target="_blank"> Pumba </a>(或Pumbaa)是迪士尼动画电影<em class="lf">狮子王</em>中的配角。在斯瓦希里语中，<em class="lf">彭彭</em>的意思是“愚蠢、愚蠢、懦弱、粗心、疏忽”。这实际上反映了我试图构建的应用程序的预期行为:-)</p><p id="8724" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Pumba的灵感来自非常受欢迎的<a class="ae le" href="https://github.com/Netflix/SimianArmy/wiki/Chaos-Monkey" rel="noopener ugc nofollow" target="_blank"> Netfix Chaos Monkey </a>用于<a class="ae le" href="https://hackernoon.com/tagged/aws" rel="noopener ugc nofollow" target="_blank"> AWS </a>云的弹性测试工具。Pumba采用了类似的方法，但是将其应用于容器级别。它连接到运行在某台机器(本地或远程)上的<a class="ae le" href="https://hackernoon.com/tagged/docker" rel="noopener ugc nofollow" target="_blank"> Docker </a>守护进程，并给它带来某种程度的混乱:“随机”杀死、停止和删除正在运行的容器。</p><p id="6025" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您的系统被设计为具有弹性，那么它应该能够从这种故障中恢复。“失败的”服务应该重新启动，丢失的连接应该恢复。这并不像听起来那么简单。你需要以不同的方式设计你的服务。请注意，服务可能会失败(无论什么原因)，或者它所依赖的服务可能会在任何时间点消失(但稍后会重新出现)。期待意想不到的事情！</p><h1 id="118f" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">为什么要经营Pumba？</h1><p id="8a49" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">失败时有发生，在最不需要的时候也不可避免地会发生。如果应用程序无法从系统故障中恢复，您将面临愤怒的客户，甚至可能失去他们。如果你想确保你的系统能够从意外的失败中恢复过来，那么更好的做法是掌控它们，自己注入失败，而不是等到它们发生。这不是一次性的努力。在“连续交付”时代，您需要确保对任何一项系统服务的每次更改都不会影响系统可用性。这就是为什么你应该练习<strong class="it hv">持续弹性测试</strong>。随着人们在生产环境中部署和运行集装箱集群，Docker越来越受欢迎。使用容器编排网络(例如Kubernetes、Swarm、CoreOS机队)，可以自动重新启动“失败”的容器。如何确保重新启动的服务和其他系统服务可以从故障中正确恢复？如果不使用容器业务流程框架，情况会更糟:您需要自己处理容器重新启动。</p><p id="7b9e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就是彭巴闪耀的地方。你可以在集群中的每台Docker主机上运行它，Pumba就会“随机”停止运行容器——也就是停止运行与指定名称或名称模式匹配的容器。您甚至可以指定将被发送以“杀死”容器的信号。</p><h1 id="0b5d" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">彭巴能做什么？</h1><p id="75dd" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">Pumba可以为您正在运行的Docker容器创建不同的失败。Pumba可以杀死，停止或删除运行的容器。它还可以将正在运行的容器中的所有进程暂停指定的时间段。Pumba还可以进行网络仿真，模拟不同的网络故障，如:延迟、数据包丢失/损坏/重新排序、带宽限制等。免责声明:netem命令正在开发中，Pumba <em class="lf"> v0.2.0 </em>仅支持<em class="lf">延迟</em>命令。</p><p id="62b0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">可以将容器列表传递给Pumba，或者只需编写一个正则表达式来选择匹配的容器。如果不指定容器，Pumba将尝试干扰所有正在运行的容器。使用<em class="lf"> - random </em>选项，从提供的列表中仅随机选择一个目标容器。</p><h1 id="a703" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">如何经营Pumba？</h1><p id="41f0" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">经营Pumba有两种方法。</p><p id="2228" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，您可以从项目<a class="ae le" href="https://github.com/gaia-adm/pumba/releases" rel="noopener ugc nofollow" target="_blank">发布页面</a>下载操作系统的Pumba应用程序(单个二进制文件)，然后运行<em class="lf"> pumba - help </em>查看支持的命令和选项列表。</p><pre class="kt ku kv kw fq lg lh li lj aw lk dt"><span id="e762" class="ll jq hu lh b fv lm ln l lo lp">$ pumba help</span><span id="5898" class="ll jq hu lh b fv lq ln l lo lp">Pumba version v0.2.0<br/>NAME:<br/>   Pumba - Pumba is a resilience testing tool, that helps applications tolerate random Docker container failures: process, network and performance.</span><span id="f935" class="ll jq hu lh b fv lq ln l lo lp">USAGE:<br/>   pumba [global options] command [command options] containers (name, list of names, RE2 regex)</span><span id="dd02" class="ll jq hu lh b fv lq ln l lo lp">VERSION:<br/>   v0.2.0</span><span id="5353" class="ll jq hu lh b fv lq ln l lo lp">COMMANDS:<br/>     kill     kill specified containers<br/>     netem    emulate the properties of wide area networks<br/>     pause    pause all processes<br/>     stop     stop containers<br/>     rm       remove containers<br/>     help, h  Shows a list of commands or help for one command</span><span id="cfd9" class="ll jq hu lh b fv lq ln l lo lp">GLOBAL OPTIONS:<br/>   --host value, -H value      daemon socket to connect to (default: "unix:///var/run/docker.sock") [$DOCKER_HOST]<br/>   --tls                       use TLS; implied by --tlsverify<br/>   --tlsverify                 use TLS and verify the remote [$DOCKER_TLS_VERIFY]<br/>   --tlscacert value           trust certs signed only by this CA (default: "/etc/ssl/docker/ca.pem")<br/>   --tlscert value             client certificate for TLS authentication (default: "/etc/ssl/docker/cert.pem")<br/>   --tlskey value              client key for TLS authentication (default: "/etc/ssl/docker/key.pem")<br/>   --debug                     enable debug mode with verbose logging<br/>   --json                      produce log in JSON format: Logstash and Splunk friendly<br/>   --slackhook value           web hook url; send Pumba log events to Slack<br/>   --slackchannel value        Slack channel (default #pumba) (default: "#pumba")<br/>   --interval value, -i value  recurrent interval for chaos command; use with optional unit suffix: 'ms/s/m/h'<br/>   --random, -r                randomly select single matching container from list of target containers<br/>   --dry                       dry runl does not create chaos, only logs planned chaos commands<br/>   --help, -h                  show help<br/>   --version, -v               print the version</span></pre><h2 id="5723" class="ll jq hu bd jr lr ls lt jv lu lv lw jz jc lx ly kd jg lz ma kh jk mb mc kl md dt translated">例子</h2><pre class="kt ku kv kw fq lg lh li lj aw lk dt"><span id="5239" class="ll jq hu lh b fv lm ln l lo lp"># stop random container once in a 10 minutes<br/>$ ./pumba --random --interval 10m kill --signal SIGSTOP</span><span id="9cb1" class="ll jq hu lh b fv lq ln l lo lp"># every 15 minutes kill `mysql` container and <br/># every hour remove containers starting with "hp"<br/>$ ./pumba --interval 15m kill --signal SIGTERM mysql &amp;<br/>$ ./pumba --interval 1h rm re2:^hp &amp;</span><span id="c54e" class="ll jq hu lh b fv lq ln l lo lp"># every 30 seconds kill "worker1" and "worker2" containers <br/># and every 3 minutes stop "queue" container<br/>$ ./pumba --interval 30s kill --signal SIGKILL worker1 worker2 &amp;<br/>$ ./pumba --interval 3m stop queue &amp;</span><span id="826e" class="ll jq hu lh b fv lq ln l lo lp"># Once in 5 minutes, Pumba will delay for 2 seconds (2000ms) <br/># egress traffic for some (randomly chosen) container,<br/># named `result...` (matching `^result` regexp) on `eth2` <br/># network interface.<br/># Pumba will restore normal connectivity after 2 minutes. <br/># Print debug trace to STDOUT too.<br/>$ ./pumba --debug --interval 5m --random netem --duration 2m --interface eth2 delay --amount 2000 re2:^result</span></pre><h1 id="ec64" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">在Docker Container中运行Pumba</h1><p id="8010" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">第二种方法是在Docker容器中运行它。</p><p id="c9d6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了让Pumba能够访问主机上的Docker守护程序，您需要安装<em class="lf">var/run/Docker . sock</em>UNIX套接字。</p><pre class="kt ku kv kw fq lg lh li lj aw lk dt"><span id="67a8" class="ll jq hu lh b fv lm ln l lo lp"># run latest stable Pumba docker image (from master repository)<br/>$ docker run -d \<br/>    -v /var/run/docker.sock:/var/run/docker.sock \<br/>   gaiaadm/pumba:master pumba \<br/>   kill --interval 10s --signal SIGTERM ^hp</span></pre><p id="5ea1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">美洲狮不会杀死自己的容器。</p><h1 id="8afc" class="jp jq hu bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dt translated">然后</h1><p id="6008" class="pw-post-body-paragraph ir is hu it b iu kn iw ix iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo hn dt translated">我刚刚创建了Pumba项目，并将欣然接受任何想法，拉请求，问题和其他贡献的项目。</p><p id="60a9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae le" href="https://github.com/gaia-adm/pumba" rel="noopener ugc nofollow" target="_blank"> Pumba GitHub库</a></p></div><div class="ab cl me mf hc mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="hn ho hp hq hr"><p id="199e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="lf">最初发表于</em><a class="ae le" href="http://blog.terranillius.com/post/pumba_docker_chaos_testing/" rel="noopener ugc nofollow" target="_blank">T5【blog.terranillius.com】</a><em class="lf">。</em></p><div class="kt ku kv kw fq ab cb"><figure class="ml kx mm mn mo mp mq paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="ml kx mm mn mo mp mq paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="ml kx mm mn mo mp mq paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mr ms mt"><p id="f922" class="ir is lf it b iu iv iw ix iy iz ja jb mu jd je jf mv jh ji jj mw jl jm jn jo hn dt translated"><a class="ae le" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是阿妹家庭的一员。我们现在<a class="ae le" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae le" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is lf it b iu iv iw ix iy iz ja jb mu jd je jf mv jh ji jj mw jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae le" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae le" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kt ku kv kw fq kx fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff mx"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure><figure class="kt ku kv kw fq kx"><div class="bz el l di"><div class="my mz l"/></div></figure></div></div>    
</body>
</html>