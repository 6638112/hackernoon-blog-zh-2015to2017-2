<html>
<head>
<title>Bundling Custom Assets with Sprockets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将自定义资产与链轮捆绑在一起</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/bundling-custom-assets-with-sprockets-c24f541f5527?source=collection_archive---------13-----------------------#2017-07-07">https://medium.com/hackernoon/bundling-custom-assets-with-sprockets-c24f541f5527?source=collection_archive---------13-----------------------#2017-07-07</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="5542" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">本文解释了如何通过定制链轮配置，使用Rails资产管道处理定制资产文件。</strong></p><p id="1f6c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们考虑一个使用客户端<a class="ae jp" href="https://hackernoon.com/tagged/mustache" rel="noopener ugc nofollow" target="_blank">小胡子</a>模板渲染的Rails应用程序的例子。从<a class="ae jp" href="https://hackernoon.com/tagged/javascript" rel="noopener ugc nofollow" target="_blank"> JavaScript </a>中访问模板的有效方法是什么？</p><p id="8fa6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里有许多方法。最基本的方法是将模板直接嵌套到HTML视图代码中。像这样:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="920f" class="jz ka hu jv b fv kb kc l kd ke">&lt;script type='text/template' id='post-template'&gt;<br/>  &lt;h2&gt;{{ title }}&lt;/h2&gt;<br/>  &lt;p&gt;{{ body }}&lt;/p&gt;<br/>&lt;/script&gt;</span></pre><p id="2293" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但这远非理想:</p><ol class=""><li id="8a6c" class="kf kg hu it b iu iv iy iz jc kh jg ki jk kj jo kk kl km kn dt translated">很可能会有更多的模板，您需要在不同的视图之间共享其中的一些。因此，保持模板有组织是有意义的，而不是把它们分散在HTML中。</li><li id="d141" class="kf kg hu it b iu ko iy kp jc kq jg kr jk ks jo kk kl km kn dt translated">嵌套模板是不必要的手动操作。最好能马上从JavaScript中获得模板，而不是依赖于您不会忘记添加一个模板。</li><li id="4370" class="kf kg hu it b iu ko iy kp jc kq jg kr jk ks jo kk kl km kn dt translated">有时在<em class="kt"> &lt;脚本&gt; </em>元素中嵌套一个模板会破坏语法高亮，因此将它们保存在单独的<em class="kt"> *中。小胡子</em>档通常效果更好。但是，这取决于文本编辑器的配置。</li></ol><p id="f21b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了解决这些问题，让我们让Rails资产管道在JavaScript bundle中生成一个JSON对象，并从位于<em class="kt"> app/assets/templates </em>的templates目录中填充这个对象。对于消费者来说，它看起来像这样:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="5d7b" class="jz ka hu jv b fv kb kc l kd ke">window.Templates = {<br/>  post: "&lt;h2&gt;{{ title }}&lt;/h2&gt;&lt;p&gt;{{ body }}&lt;/p&gt;",<br/>  comment: "..."<br/>}</span></pre><p id="81ee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过这种方式，模板将被预加载到公共包中，并且在使用它的每个视图中都是可用的。</p><p id="1bbd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">第一步。注册新的MIME类型</strong></p><p id="fe63" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在典型的Rails应用程序中，定制链轮配置应该在<em class="kt">应用程序</em>类中的<em class="kt">config . assets . configure</em>块下定义。所以下面的例子是基于这样一个假设，即在你的<em class="kt"> config/application.rb </em>中已经存在这样一个块:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="fbec" class="jz ka hu jv b fv kb kc l kd ke">module MyApplication<br/>  class Application &lt; Rails::Application<br/>    config.assets.configure do |env|</span><span id="e8af" class="jz ka hu jv b fv ku kc l kd ke">      <strong class="jv hv">// Custom Sprockets configuration should go here</strong></span><span id="ed3c" class="jz ka hu jv b fv ku kc l kd ke">    end<br/>  end<br/>end</span></pre><p id="a3aa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">MIME类型注册非常简单。只需定义新类型与您计划处理的文件扩展名列表之间的关联:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="b484" class="jz ka hu jv b fv kb kc l kd ke">env.register_mime_type('text/mustache', extensions: ['.mustache'])</span></pre><p id="c720" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">步骤二。注册新资产变压器</strong></p><p id="ad9b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里最重要的部分是回调。它是一个可调用对象，将资产文件内容从<em class="kt"> source_type </em>转换为不同的<em class="kt"> target_type。</em>回调应该返回一个散列，其中包含<em class="kt">中已处理的内容:数据</em>键:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="549a" class="jz ka hu jv b fv kb kc l kd ke">source_type = 'text/mustache'<br/>target_type = 'application/javascript'</span><span id="69af" class="jz ka hu jv b fv ku kc l kd ke"><strong class="jv hv">callback = -&gt; (input) { { data: '// HELLO ${input[:name]}' } }</strong></span><span id="dcd3" class="jz ka hu jv b fv ku kc l kd ke">env.register_transformer(source_type, target_type, callback)</span></pre><p id="eeb1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Lambda表达式可能不适合现实生活中的情况。在Rails配置之外定义的服务类将是更好的选择。但是现在让我们先完成样板文件。真实的变压器示例如下。</p><p id="642a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">第三步。启用自定义文件类型处理</strong></p><p id="1d16" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为此，在<em class="kt">资产</em>初始化器(<em class="kt">config/initializer/assets . Rb</em>)中的<em class="kt">预编译</em>数组中添加一个正则表达式:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="08a4" class="jz ka hu jv b fv kb kc l kd ke">Rails.application.config.assets.precompile += [/\.(?:mustache)\z/]</span></pre><p id="e971" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">第四步。捆绑转换的资产</strong></p><p id="aedd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在注册了新的transformer之后，<a class="ae jp" href="http://guides.rubyonrails.org/asset_pipeline.html#manifest-files-and-directives" rel="noopener ugc nofollow" target="_blank"> <em class="kt"> require </em>和<em class="kt"> require_tree </em> </a>指令都可以很好地使用自定义资产类型。</p><p id="c212" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您在<em class="kt"> app/assets/templates </em>下保留Mustache模板，那么将这一行添加到<em class="kt">app/assets/JavaScript s/application . js</em>将为每个<em class="kt"> *注入transformer回调输出。小胡子</em>文件:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="8be5" class="jz ka hu jv b fv kb kc l kd ke">//= require_tree ../templates</span></pre><p id="94c3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上一步中的虚拟lambda-transformer将用如下注释文件名列表替换这一行:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="6dd6" class="jz ka hu jv b fv kb kc l kd ke">// HELLO template_file_name<br/>// HELLO another_template_file_name<br/>// ...</span></pre><p id="2c98" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要看到它工作，不要忘记重启Rails服务器，并确保清除资产缓存。</p></div><div class="ab cl kv kw hc kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hn ho hp hq hr"><p id="6faf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是一个实际的transformer示例，它从Mustache模板文件生成JavaScript对象:</p><pre class="jq jr js jt fq ju jv jw jx aw jy dt"><span id="6010" class="jz ka hu jv b fv kb kc l kd ke">class MustacheTransformer<br/>  def self.call(input)<br/>    key = input[:name]<br/>    body = JSON.dump(input[:data])<br/>    obj = 'window.Templates'<br/>    { data: "#{obj} = #{obj} || {}; #{obj}['#{key}'] = #{body}" }<br/>  end<br/>end</span></pre><p id="7e5f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">除了<em class="kt">:数据、</em>之外，<em class="kt">输入</em>对象包含许多其他扩展字段，这些字段在内容转换过程中可能很有价值。查看<a class="ae jp" href="https://github.com/rails/sprockets/blob/master/guides/extending_sprockets.md#extension-keys" rel="noopener ugc nofollow" target="_blank">的官方参考，完整列表</a>。</p><p id="a9fd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本文中阐述的小胡子模板只是扩展链轮的一个具体例子。除了模板之外，还可以将任何其他资产与适合您需求的任意转换逻辑捆绑在一起。</p><p id="718e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">和平。</p></div><div class="ab cl kv kw hc kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hn ho hp hq hr"><p id="b950" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">参考资料:</p><ul class=""><li id="c9d2" class="kf kg hu it b iu iv iy iz jc kh jg ki jk kj jo lc kl km kn dt translated"><a class="ae jp" href="https://gorails.com/forum/extend-sprockets-to-bundle-mustache-templates" rel="noopener ugc nofollow" target="_blank">go rails论坛原创讨论</a>。</li><li id="3578" class="kf kg hu it b iu ko iy kp jc kq jg kr jk ks jo lc kl km kn dt translated"><a class="ae jp" href="https://github.com/rails/sprockets/blob/master/guides/extending_sprockets.md" rel="noopener ugc nofollow" target="_blank">延伸链轮</a>，官方指南。</li><li id="9de5" class="kf kg hu it b iu ko iy kp jc kq jg kr jk ks jo lc kl km kn dt translated"><a class="ae jp" href="http://www.rubydoc.info/github/rails/sprockets/Sprockets%2FTransformers%3Aregister_transformer" rel="noopener ugc nofollow" target="_blank">链轮::变压器</a> API参考。</li><li id="0ce8" class="kf kg hu it b iu ko iy kp jc kq jg kr jk ks jo lc kl km kn dt translated"><a class="ae jp" href="http://guides.rubyonrails.org/asset_pipeline.html#precompiling-assets" rel="noopener ugc nofollow" target="_blank">用Rails资产管道预编译资产</a>。</li><li id="ff75" class="kf kg hu it b iu ko iy kp jc kq jg kr jk ks jo lc kl km kn dt translated"><a class="ae jp" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Complete_list_of_MIME_types" rel="noopener ugc nofollow" target="_blank">MIME类型的完整列表</a>。</li><li id="6e3f" class="kf kg hu it b iu ko iy kp jc kq jg kr jk ks jo lc kl km kn dt translated"><a class="ae jp" href="https://github.com/leshill/handlebars_assets" rel="noopener ugc nofollow" target="_blank"> handlebars_assets </a> gem:一个现成的替代品，用于将模板嵌入Rails资产包的特殊情况。</li></ul><figure class="jq jr js jt fq ld"><div class="bz el l di"><div class="le lf l"/></div></figure></div></div>    
</body>
</html>