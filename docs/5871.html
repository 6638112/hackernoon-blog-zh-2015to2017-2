<html>
<head>
<title>Write recursive AWS Lambda functions the right way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以正确的方式编写递归AWS Lambda函数</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/write-recursive-aws-lambda-functions-the-right-way-4a4b5ae633b6?source=collection_archive---------6-----------------------#2017-08-21">https://medium.com/hackernoon/write-recursive-aws-lambda-functions-the-right-way-4a4b5ae633b6?source=collection_archive---------6-----------------------#2017-08-21</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="f5e8" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">您可能没有意识到，您可以用递归方式编写AWS Lambda函数来执行长时间运行的任务。这里有两个建议可以帮助你做好这件事。</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/fa88d33141cdb60575ba444fee126103.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SUZIJVOUf0zBXOIRVaGRQQ.png"/></div></div></figure><p id="d839" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">AWS Lambda <a class="ae kr" href="http://docs.aws.amazon.com/lambda/latest/dg/limits.html" rel="noopener ugc nofollow" target="_blank">将</a>单次调用的最大执行时间限制为<strong class="jx hv"> 5分钟</strong>。虽然这个限制在将来可能会提高，但是您可能仍然需要考虑任何长时间运行的任务的超时。出于这个原因，我个人认为对于许多长时间运行的任务来说，电流限制太低是一件好事——它迫使你尽早考虑边缘情况，避免陷入“it <em class="ks">应该</em>足够长以执行X”的思维陷阱，而不考虑可能的故障模式。</p><p id="7dd2" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">相反，你应该把执行长时间运行任务的Lambda函数写成<strong class="jx hv">递归函数</strong>——例如<a class="ae kr" href="https://hackernoon.com/yubls-road-to-serverless-part-4-building-a-scalable-push-notification-system-62b38924ed61" rel="noopener ugc nofollow" target="_blank">处理一个大的S3文件</a>。</p><div class="kt ku fm fo kv kw"><a href="https://hackernoon.com/yubls-road-to-serverless-part-4-building-a-scalable-push-notification-system-62b38924ed61" rel="noopener  ugc nofollow" target="_blank"><div class="kx ab ej"><div class="ky ab kz cl cj la"><h2 class="bd hv fv z el lb eo ep lc er et ht dt translated">Yubl的无服务器之路——第4部分，构建可伸缩的推送通知系统</h2><div class="ld l"><h3 class="bd b fv z el lb eo ep lc er et ek translated">我们构建了一个集成了BigQuery结果的系统，能够在一个月内发送数百万条推送通知</h3></div><div class="le l"><p class="bd b gc z el lb eo ep lc er et ek translated">hackernoon.com</p></div></div><div class="lf l"><div class="lg l lh li lj lf lk jt kw"/></div></div></a></div><p id="23bc" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">这里有两个小贴士可以帮你做好这件事。</p><h2 id="b1b7" class="ll lm hu bd ln lo lp lq lr ls lt lu lv ke lw lx ly ki lz ma mb km mc md me mf dt translated">使用上下文<strong class="ak">。</strong> getRemainingTimeInMillis()</h2><p id="cdfa" class="pw-post-body-paragraph jv jw hu jx b jy mg iv ka kb mh iy kd ke mi kg kh ki mj kk kl km mk ko kp kq hn dt translated">当您的函数被调用时，<code class="eh ml mm mn mo b">context</code>对象允许您找出当前调用还剩多少时间。</p><div class="kt ku fm fo kv kw"><a href="http://docs.aws.amazon.com/lambda/latest/dg/nodejs-prog-model-context.html" rel="noopener  ugc nofollow" target="_blank"><div class="kx ab ej"><div class="ky ab kz cl cj la"><h2 class="bd hv fv z el lb eo ep lc er et ht dt translated">上下文对象(Node.js) - AWS Lambda</h2><div class="ld l"><h3 class="bd b fv z el lb eo ep lc er et ek translated">当Lambda函数执行时，它可以与AWS Lambda交互以获得有用的运行时信息，例如:</h3></div><div class="le l"><p class="bd b gc z el lb eo ep lc er et ek translated">docs.aws.amazon.com</p></div></div></div></a></div><p id="3426" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">假设您有一个昂贵的任务，它可以被分解成可以批量处理的小任务。在每批结束时，使用<code class="eh ml mm mn mo b">context.getRemainingTimeInMillis()</code>检查是否还有足够的时间继续加工。否则，<code class="eh ml mm mn mo b">recurse</code>并沿着当前位置传递，以便下一个调用可以从它停止的地方继续。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mp mq l"/></div></figure><h2 id="75a4" class="ll lm hu bd ln lo lp lq lr ls lt lu lv ke lw lx ly ki lz ma mb km mc md me mf dt translated">使用本地状态进行优化</h2><p id="eeab" class="pw-post-body-paragraph jv jw hu jx b jy mg iv ka kb mh iy kd ke mi kg kh ki mj kk kl km mk ko kp kq hn dt translated">虽然Lambda函数在设计上是短暂的，但容器仍然被重用来进行优化，这意味着您仍然可以利用通过调用持久化的内存状态。</p><p id="947a" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">您应该利用这个机会避免在每次递归中加载相同的数据——例如，您可能正在处理一个大的S3文件，缓存S3文件的内容会更有效(也更便宜)。</p><p id="e2d8" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我注意到AWS也更新了他们的Lambda最佳实践页面，建议你利用容器重用:</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mr"><img src="../Images/a87bbe6f8e79aa0b36d198d69aa3be0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eLIUrczIC1-r6Aa3nVDkeQ.png"/></div></div></figure><p id="a710" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">然而，由于Lambda可以在递归之间回收容器，所以从一个调用到另一个调用，您可能会丢失缓存的状态。因此，您不应该假设缓存状态在递归期间总是可用的，并且总是首先检查是否有缓存状态。</p><p id="abd0" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">此外，在处理S3对象时，您需要保护自己免受内容更改的影响。S3对象被替换，但是容器实例仍然被重用，因此缓存数据仍然可用。当您调用S3的<a class="ae kr" href="http://docs.aws.amazon.com/AmazonS3/latest/API/RESTObjectGET.html" rel="noopener ugc nofollow" target="_blank"> GetObject </a>操作时，您应该用缓存数据的<code class="eh ml mm mn mo b">ETag</code>设置可选的<code class="eh ml mm mn mo b">If-None-Match</code>参数。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff ms"><img src="../Images/f1efcdbd11e265fed4d0955029bfed50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YhEygKl3totiAu6igLqY2A.png"/></div></div></figure><p id="bf8a" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">以下是你如何应用这种技术。</p><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="mp mq l"/></div></figure><p id="de89" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">看看这个<a class="ae kr" href="https://github.com/theburningmonk/lambda-recursive-s3-demo/blob/master/batch-processor.js" rel="noopener ugc nofollow" target="_blank">例子</a> Lambda函数，它递归地处理一个S3文件，使用了本文中概述的方法。</p><div class="kt ku fm fo kv kw"><a href="https://github.com/theburningmonk/lambda-recursive-s3-demo/blob/master/batch-processor.js" rel="noopener  ugc nofollow" target="_blank"><div class="kx ab ej"><div class="ky ab kz cl cj la"><h2 class="bd hv fv z el lb eo ep lc er et ht dt translated">burning monk/lambda-递归-S3-演示</h2><div class="ld l"><h3 class="bd b fv z el lb eo ep lc er et ek translated">演示用于处理大型s3文件的递归AWS Lambda函数</h3></div><div class="le l"><p class="bd b gc z el lb eo ep lc er et ek translated">github.com</p></div></div><div class="lf l"><div class="mt l lh li lj lf lk jt kw"/></div></div></a></div></div><div class="ab cl mu mv hc mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hn ho hp hq hr"><p id="dd83" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">喜欢您正在阅读的内容，但需要更多帮助？我很乐意作为独立顾问<strong class="jx hv">提供我的服务</strong>并帮助您完成您的无服务器项目——架构审查、代码审查、构建概念验证，或者提供关于领先实践和工具的建议。</p><p id="e3d4" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我在<strong class="jx hv">伦敦，英国</strong>目前唯一的英国<a class="ae kr" href="https://aws.amazon.com/developer/community/heroes/yan-cui/" rel="noopener ugc nofollow" target="_blank"> <strong class="jx hv"> AWS无服务器英雄</strong> </a>。我有近<strong class="jx hv"> 10年</strong>的<a class="ae kr" href="https://www.linkedin.com/in/theburningmonk/" rel="noopener ugc nofollow" target="_blank">经验</a>在AWS中大规模运行生产工作负载。我主要在英国开展业务，但我愿意出差一周以上。要了解我们如何合作，请在这里告诉我更多关于您试图解决的问题的信息。</p><p id="fa31" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我还可以在举办一个<strong class="jx hv">内部研讨会，帮助您的无服务器架构做好生产准备<strong class="jx hv">。您可以在这里找到关于为期两天的研讨会<a class="ae kr" href="https://theburningmonk.com/workshops/" rel="noopener ugc nofollow" target="_blank">的更多信息，该研讨会将带您从AWS Lambda的基础一直到日志聚合、分发跟踪和安全最佳实践的通用操作模式。</a></strong></strong></p><p id="2399" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果你喜欢按照自己的进度学习，那么你也可以找到所有与我为曼宁制作的<a class="ae kr" href="https://bit.ly/production-ready-serverless" rel="noopener ugc nofollow" target="_blank"><strong class="jx hv"/></a>视频课程相同的研讨会内容。我们将讨论的主题包括:</p><ul class=""><li id="27e5" class="nb nc hu jx b jy jz kb kc ke nd ki ne km nf kq ng nh ni nj dt translated">认证<em class="ks"> &amp; </em>授权与API网关<em class="ks"> &amp; </em>认知</li><li id="cb0f" class="nb nc hu jx b jy nk kb nl ke nm ki nn km no kq ng nh ni nj dt translated">本地测试<em class="ks"> &amp; </em>运行功能</li><li id="25ea" class="nb nc hu jx b jy nk kb nl ke nm ki nn km no kq ng nh ni nj dt translated">CI/CD</li><li id="3af2" class="nb nc hu jx b jy nk kb nl ke nm ki nn km no kq ng nh ni nj dt translated">日志聚合</li><li id="649a" class="nb nc hu jx b jy nk kb nl ke nm ki nn km no kq ng nh ni nj dt translated">监控最佳实践</li><li id="8c34" class="nb nc hu jx b jy nk kb nl ke nm ki nn km no kq ng nh ni nj dt translated">X射线分布式跟踪</li><li id="8d1b" class="nb nc hu jx b jy nk kb nl ke nm ki nn km no kq ng nh ni nj dt translated">跟踪相关id</li><li id="880c" class="nb nc hu jx b jy nk kb nl ke nm ki nn km no kq ng nh ni nj dt translated"><em class="ks">性能&amp;成本</em>优化</li><li id="1377" class="nb nc hu jx b jy nk kb nl ke nm ki nn km no kq ng nh ni nj dt translated">错误处理</li><li id="916b" class="nb nc hu jx b jy nk kb nl ke nm ki nn km no kq ng nh ni nj dt translated">配置管理</li><li id="8f57" class="nb nc hu jx b jy nk kb nl ke nm ki nn km no kq ng nh ni nj dt translated">金丝雀部署</li><li id="5d40" class="nb nc hu jx b jy nk kb nl ke nm ki nn km no kq ng nh ni nj dt translated">VPC</li><li id="908b" class="nb nc hu jx b jy nk kb nl ke nm ki nn km no kq ng nh ni nj dt translated">安全</li><li id="a387" class="nb nc hu jx b jy nk kb nl ke nm ki nn km no kq ng nh ni nj dt translated">Lambda、Kinesis和API网关的最佳实践</li></ul><p id="2e68" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">你还可以用代码<strong class="jx hv"> ytcui </strong>获得<strong class="jx hv">票面价格的6折优惠</strong>。不过，这个数字只有在我们参加曼宁的早期访问计划(MEAP)时才有效。</p></div></div>    
</body>
</html>