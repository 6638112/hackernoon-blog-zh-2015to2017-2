<html>
<head>
<title>Solving the Most Interesting Bug of My Career in 15 Steps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用15个步骤解决我职业生涯中最有趣的问题</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/solving-the-most-interesting-bug-of-my-career-in-15-steps-1a1ccd337c35?source=collection_archive---------7-----------------------#2017-11-17">https://medium.com/hackernoon/solving-the-most-interesting-bug-of-my-career-in-15-steps-1a1ccd337c35?source=collection_archive---------7-----------------------#2017-11-17</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/d7caae5fedce7e4394c68440fa42c8ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qv1sXwq0BWJHVhRHvPlwiA.jpeg"/></div></div></figure><blockquote class="jc jd je"><p id="cacf" class="jf jg jh ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">由乌达扬·班纳吉担任，在Quora工作。<a class="ae ke" href="https://www.quora.com/What-is-the-most-interesting-bug-you-have-ever-solved-in-a-computer-program/answer/Udayan-Banerji" rel="noopener ugc nofollow" target="_blank">原载</a>于<a class="ae ke" href="http://quora.com?ref=hackernoon" rel="noopener ugc nofollow" target="_blank"> Quora </a>。</p></blockquote><h2 id="9767" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated"><strong class="ak">TLDR；花了两周时间调查一个bug，修复只是一行代码的修改。</strong></h2><p id="e33f" class="pw-post-body-paragraph jf jg hu ji b jj ld jl jm jn le jp jq kq lf jt ju ku lg jx jy ky lh kb kc kd hn dt translated">在英特尔做编译工程师的时候，我曾经被分配了一个奇怪的bug。这是一个Android应用程序，基本上是一个Java基准，它会随机崩溃。这款应用只有一个按钮，点击这个按钮就开始了整个基准测试套件的长时间运行。</p><ol class=""><li id="a70c" class="li lj hu ji b jj jk jn jo kq lk ku ll ky lm kd ln lo lp lq dt translated">我没有应用程序的源代码，但我可以看到字节码。所以我首先尝试通过调试器运行它。我尝试了至少30次，它从来没有崩溃过。</li><li id="6a15" class="li lj hu ji b jj lr jn ls kq lt ku lu ky lv kd ln lo lp lq dt translated">我又正常运行app，随机死机。最终，我发现每运行20次基准测试，它就会崩溃一次。</li><li id="588f" class="li lj hu ji b jj lr jn ls kq lt ku lu ky lv kd ln lo lp lq dt translated">我在字节码中搜索任何包含20的代码。任何20度的循环，任何递归。没什么。程序一直崩溃。</li><li id="3f15" class="li lj hu ji b jj lr jn ls kq lt ku lu ky lv kd ln lo lp lq dt translated">现在事情越来越严重了。在这款安卓手机上，砸碎电脑键盘似乎更容易让疼痛消失。</li><li id="3c0d" class="li lj hu ji b jj lr jn ls kq lt ku lu ky lv kd ln lo lp lq dt translated">过了一个周末，我又回到了这个问题上。我回到了爪哇的坠机事件。核心问题是断言失败——大浮点数不等于NaN(“不是一个数”)。</li><li id="0665" class="li lj hu ji b jj lr jn ls kq lt ku lu ky lv kd ln lo lp lq dt translated">我回到字节码，寻找浮点除法。我一个接一个地分离出大约12个字节码序列，将它们转换成x86汇编，将每个序列放入一个长时间运行的循环中，并执行它们。最后每20次就有一个崩溃。我可以看到我腕管末端的光。</li><li id="e981" class="li lj hu ji b jj lr jn ls kq lt ku lu ky lv kd ln lo lp lq dt translated">我分析了汇编代码，看到了8除零运算。啊哈！除以零产生NaN！所以我们的编译器被0除坏了…嗯，不知何故？</li><li id="7f09" class="li lj hu ji b jj lr jn ls kq lt ku lu ky lv kd ln lo lp lq dt translated">除了没有，手写汇编除以零工作正常。沮丧的我做了一个20除以零的循环，它也通过了。然后我写了一堆随机的汇编指令，第一个给出了错误的结果。</li><li id="842f" class="li lj hu ji b jj lr jn ls kq lt ku lu ky lv kd ln lo lp lq dt translated">等等什么？</li><li id="0062" class="li lj hu ji b jj lr jn ls kq lt ku lu ky lv kd ln lo lp lq dt translated">最后，转到gdb并转储这些操作的所有CPU寄存器的值。</li><li id="843c" class="li lj hu ji b jj lr jn ls kq lt ku lu ky lv kd ln lo lp lq dt translated">就在那时，我注意到了一个趋势。x87寄存器堆栈慢慢填满，然后停留在最大容量(8项)</li><li id="9318" class="li lj hu ji b jj lr jn ls kq lt ku lu ky lv kd ln lo lp lq dt translated">原来，芯片中古老的x87处理器有一个bug，就是负责做浮点运算的那个。我们在编译器中使用它进行所有浮点运算，除了除零路径之外的所有路径都在使用后清空它。</li><li id="a626" class="li lj hu ji b jj lr jn ls kq lt ku lu ky lv kd ln lo lp lq dt translated">似乎在堆栈溢出时，它没有抛出一个错误，但是无论你运行什么都返回一个NaN值。这也是你除以0得到的值。(基本上堆栈溢出错误，称为堆栈错误，是粘性的。一旦发生就要在编译器中手动清除，不然就一直发生)。</li><li id="fbbf" class="li lj hu ji b jj lr jn ls kq lt ku lu ky lv kd ln lo lp lq dt translated">所以每隔8个被零除一次后，它就会补满，然后它会把任何一个操作都当作被零除，返回NaN。</li><li id="8df5" class="li lj hu ji b jj lr jn ls kq lt ku lu ky lv kd ln lo lp lq dt translated"><strong class="ji hv">修复只需要修改一行代码，</strong>清除除零路径上的堆栈。</li></ol><p id="8cdc" class="pw-post-body-paragraph jf jg hu ji b jj jk jl jm jn jo jp jq kq js jt ju ku jw jx jy ky ka kb kc kd hn dt translated">编辑:<a class="ae ke" href="https://www.quora.com/profile/Jay-Shah-6" rel="noopener ugc nofollow" target="_blank">杰伊·沙阿</a>问我实际的代码。就是这里:<a class="ae ke" href="https://android-review.googlesource.com/#/c/54874/3/vm/compiler/codegen/x86/LowerAlu.cpp" rel="noopener ugc nofollow" target="_blank"> Gerrit代码回顾</a>。请注意，大多数更改都是注释。有4行代码更改，但3行是相同的，1行是加载值。</p><blockquote class="jc jd je"><p id="d48b" class="jf jg jh ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">截止到<a class="ae ke" href="https://www.quora.com/profile/Udayan-Banerji" rel="noopener ugc nofollow" target="_blank">乌达扬·班纳吉</a>，在Quora工作。<a class="ae ke" href="https://www.quora.com/What-is-the-most-interesting-bug-you-have-ever-solved-in-a-computer-program/answer/Udayan-Banerji" rel="noopener ugc nofollow" target="_blank">原载</a>于<a class="ae ke" href="http://quora.com?ref=hackernoon" rel="noopener ugc nofollow" target="_blank"> Quora </a>上。</p><p id="c61a" class="jf jg jh ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">更多来自Quora<a class="lw lx gr" href="https://medium.com/u/3853f85f7d5e?source=post_page-----1a1ccd337c35--------------------------------" rel="noopener" target="_blank">的趋势科技答案，请访问</a><a class="ae ke" href="https://hackernoon.com/quora/home" rel="noopener ugc nofollow" target="_blank">HackerNoon.com/Quora</a>。</p></blockquote></div></div>    
</body>
</html>