<html>
<head>
<title>Using Core Node JS Modules in React Native Apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在React本地应用中使用核心节点JS模块</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/using-core-node-js-modules-in-react-native-apps-64acd4d07140?source=collection_archive---------1-----------------------#2017-07-02">https://medium.com/hackernoon/using-core-node-js-modules-in-react-native-apps-64acd4d07140?source=collection_archive---------1-----------------------#2017-07-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="069e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里有一个你在使用React Native时可能会遇到的问题:假设你想使用<code class="eh jp jq jr js b"><a class="ae jt" href="https://nodejs.org/api/crypto.html#crypto_crypto" rel="noopener ugc nofollow" target="_blank">crypto</a></code>模块创建一些散列。这样做似乎很自然:</p><figure class="ju jv jw jx fq jy"><div class="bz el l di"><div class="jz ka l"/></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">Just import a module and create a hash, right? Right? Nope!</figcaption></figure><p id="98e5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是<strong class="it hv">这个不行，</strong>因为<code class="eh jp jq jr js b">crypto</code>是核心的Node JS模块，也就是说很可能是捆绑了Node JS二进制的C++代码，而不是Javascript。React本机打包程序不能将它[1]与您的应用程序的Javascript包打包在一起，所以您会得到一个运行时错误:<code class="eh jp jq jr js b">Unable to resolve module 'crypto'</code>。</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="fe ff kf"><img src="../Images/e7906cf90a8909c5119cc2441ef6d5f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MoWUxM7ocVD0ten_gk7Iag.png"/></div></div></figure><p id="64d3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这使得核心模块像<code class="eh jp jq jr js b">crypto</code>、<code class="eh jp jq jr js b"><a class="ae jt" href="https://www.npmjs.com/package/stream" rel="noopener ugc nofollow" target="_blank">stream</a></code>等。以及依赖于它们的数千个npm模块无法从React Native使用。幸运的是，这个问题有一个解决方案，但是需要一些工作。</p><h2 id="d022" class="km kn hu bd ko kp kq kr ks kt ku kv kw jc kx ky kz jg la lb lc jk ld le lf lg dt translated">解决办法</h2><p id="b32c" class="pw-post-body-paragraph ir is hu it b iu lh iw ix iy li ja jb jc lj je jf jg lk ji jj jk ll jm jn jo hn dt translated">如果你熟悉模块捆绑器<a class="ae jt" href="http://browserify.org/" rel="noopener ugc nofollow" target="_blank"> Browserify </a>，你可能知道它允许你在使用poly fills【2】的浏览器中使用核心节点JS模块，比如<code class="eh jp jq jr js b">crypto</code>。因此，让我们尝试创建一个独立的Javascript文件，其中包含用于<code class="eh jp jq jr js b">crypto</code>模块的polyfill，并在我们的应用程序中使用它:</p><p id="a433" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">1.首先，安装<code class="eh jp jq jr js b">browserify</code>:</p><pre class="ju jv jw jx fq lm js ln lo aw lp dt"><span id="3611" class="km kn hu js b fv lq lr l ls lt">npm install -g browserify</span></pre><p id="37fc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">2.创建一个导入<code class="eh jp jq jr js b">crypto</code>模块并简单导出的文件<code class="eh jp jq jr js b">crypto-in.js</code>:</p><figure class="ju jv jw jx fq jy"><div class="bz el l di"><div class="jz ka l"/></div></figure><p id="6e1e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">3.使用<code class="eh jp jq jr js b">browserify</code>创建一个独立的Javascript包<code class="eh jp jq jr js b">crypto.js</code>:</p><pre class="ju jv jw jx fq lm js ln lo aw lp dt"><span id="2eda" class="km kn hu js b fv lq lr l ls lt">browserify crypto-in.js -o crypto.js</span></pre><p id="75db" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这创建了一个文件<code class="eh jp jq jr js b">crypto.js</code>，它包含大约21，500行代码(包含polyfills)。最后几行包含我们来自<code class="eh jp jq jr js b">crypto-in.js</code>的代码:</p><figure class="ju jv jw jx fq jy"><div class="bz el l di"><div class="jz ka l"/></div></figure><p id="aab6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这一点上，它可能看起来像我们完成了，但我们没有！如果您将应用程序代码中的行<code class="eh jp jq jr js b">const crypto = require('crypto');</code>替换为<code class="eh jp jq jr js b">const crypto = require('./crypto');</code>并尝试运行应用程序，您会得到以下错误:</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="fe ff lu"><img src="../Images/5ae9e6f577ca2d335c5c4a7ee59bcb06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pCvYyPEjZYQ-Bn-gUAM7kw.png"/></div></div></figure><p id="e0d6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">原来单词<code class="eh jp jq jr js b">require</code>被React本机打包程序给予了特殊处理，并且您不能将其重新定义为其他意思，这正是Browserify试图在包中做的。如果你仔细观察<code class="eh jp jq jr js b">crypto.js</code>内部，你会注意到它总是传入一个自定义的<code class="eh jp jq jr js b">require</code>函数作为参数，而从来没有真正使用全局的<code class="eh jp jq jr js b">require</code>。有一个简单的方法可以解决这个问题，解释如下。</p><p id="da42" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">4.在文本编辑器中打开文件<code class="eh jp jq jr js b">crypto.js</code>，用其他东西替换单词<code class="eh jp jq jr js b">require</code>的所有实例，例如<code class="eh jp jq jr js b">reqqq</code>。确保它是唯一的，这样它就不会与任何现有的代码冲突，也不会把事情弄糟。</p><p id="eefe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您现在保存<code class="eh jp jq jr js b">crypto.js</code>并重新加载应用程序，之前的错误将会消失，但会出现新的错误:</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="fe ff lv"><img src="../Images/0d1fe83092c299f482b373265e40acb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TP6leQIKcBgViGIdi1k9bQ.png"/></div></div></figure><p id="d992" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">打包程序无法找到方法<code class="eh jp jq jr js b">createHmac</code>，因为<code class="eh jp jq jr js b">crypto</code>没有从<code class="eh jp jq jr js b">crypto.js</code>中正确导出。如果你看看这个包的最后几行，你会发现这是因为我们没有在全局<code class="eh jp jq jr js b">modules</code>对象上设置<code class="eh jp jq jr js b">module.exports</code>，而是在作为函数参数传入的其他对象上:</p><figure class="ju jv jw jx fq jy"><div class="bz el l di"><div class="jz ka l"/></div></figure><p id="622f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">5.为了从<code class="eh jp jq jr js b">crypto.js</code>中正确导出<code class="eh jp jq jr js b">crypto</code>，我们需要对文件做一些修改:</p><ul class=""><li id="2125" class="lw lx hu it b iu iv iy iz jc ly jg lz jk ma jo mb mc md me dt translated">在文件顶部添加语句<code class="eh jp jq jr js b">var crypto;</code>来声明一个新变量。</li><li id="579a" class="lw lx hu it b iu mf iy mg jc mh jg mi jk mj jo mb mc md me dt translated">将语句<code class="eh jp jq jr js b">var crypto = require('crypto');</code>替换为<code class="eh jp jq jr js b">crypto = require('crypto');</code>来设置外部变量，而不是在函数体内创建局部变量。</li><li id="ceda" class="lw lx hu it b iu mf iy mg jc mh jg mi jk mj jo mb mc md me dt translated">将函数体外部的行<code class="eh jp jq jr js b">module.exports = crypto;</code>移动到文件的底部，使其引用全局<code class="eh jp jq jr js b">module</code>对象。</li></ul><p id="8ced" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">修改后，<code class="eh jp jq jr js b">crypto.js</code>应该是这样的:</p><figure class="ju jv jw jx fq jy"><div class="bz el l di"><div class="jz ka l"/></div></figure><p id="db3c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">就这样！</strong>如果你现在运行这个应用程序，它应该一切正常:</p><figure class="ju jv jw jx fq jy fe ff paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="fe ff mk"><img src="../Images/d5dd6691b757bd4aafdac16e8cd86e99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i8qjhSRBaGGlGTJUmkk9bA.png"/></div></div></figure><h2 id="d19c" class="km kn hu bd ko kp kq kr ks kt ku kv kw jc kx ky kz jg la lb lc jk ld le lf lg dt translated">摘要</h2><p id="01bc" class="pw-post-body-paragraph ir is hu it b iu lh iw ix iy li ja jb jc lj je jf jg lk ji jj jk ll jm jn jo hn dt translated">下面是在React本地应用中使用核心节点JS模块(如<code class="eh jp jq jr js b">crypto</code>(或依赖于它的东西))的步骤的简短总结:</p><ol class=""><li id="b9f4" class="lw lx hu it b iu iv iy iz jc ly jg lz jk ma jo ml mc md me dt translated">使用<a class="ae jt" href="http://browserify.org/" rel="noopener ugc nofollow" target="_blank"> browserify </a>创建一个包含核心模块聚合填充的独立Javascript包(参见<a class="ae jt" href="https://gist.github.com/aakashns/0542bbf75ccb0973b5297ed264127095" rel="noopener ugc nofollow" target="_blank"> crypto-in.js </a>和<a class="ae jt" href="https://gist.github.com/aakashns/d0ba72025e29691baca3318c7e4a4c3b" rel="noopener ugc nofollow" target="_blank"> crypto.js </a>)。</li><li id="665f" class="lw lx hu it b iu mf iy mg jc mh jg mi jk mj jo ml mc md me dt translated">用独特的东西替换包中关键字<code class="eh jp jq jr js b">require</code>的所有实例，例如<code class="eh jp jq jr js b">reqqq</code>，这样React本地包管理器就不用管它了。</li><li id="80c4" class="lw lx hu it b iu mf iy mg jc mh jg mi jk mj jo ml mc md me dt translated">通过将<code class="eh jp jq jr js b">crypto</code>模块导入一个全局变量，并将全局变量<code class="eh jp jq jr js b">module.exports</code>设置为该变量，从包中正确导出该模块(参见修改后的<a class="ae jt" href="https://gist.github.com/aakashns/1e1fc9f2daec75dfc229be7e8c2c10a2" rel="noopener ugc nofollow" target="_blank"> crypto.js </a>)。</li></ol><p id="ebf7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">警告:</strong>由<code class="eh jp jq jr js b">browserify</code>生成的包可能非常大。例如，上面生成的文件<code class="eh jp jq jr js b">crypto.js</code>超过500kb。所以要留意大捆的。考虑使用类似于<a class="ae jt" href="https://github.com/mishoo/UglifyJS" rel="noopener ugc nofollow" target="_blank"> Uglify </a>的工具来缩小捆绑包并减小其大小。</p><h2 id="7de2" class="km kn hu bd ko kp kq kr ks kt ku kv kw jc kx ky kz jg la lb lc jk ld le lf lg dt translated">参考</h2><p id="1e22" class="pw-post-body-paragraph ir is hu it b iu lh iw ix iy li ja jb jc lj je jf jg lk ji jj jk ll jm jn jo hn dt translated">[1]—<a class="ae jt" href="https://github.com/facebook/react-native/issues/1871" rel="noopener ugc nofollow" target="_blank">https://github.com/facebook/react-native/issues/1871</a><br/>【2】—<a class="ae jt" href="https://github.com/substack/browserify-handbook#builtins" rel="noopener ugc nofollow" target="_blank">https://github.com/substack/browserify-handbook#builtins</a><br/>【3】—<a class="ae jt" href="https://github.com/facebook/react-native/issues/6253" rel="noopener ugc nofollow" target="_blank">https://github.com/facebook/react-native/issues/6253</a></p><p id="163d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="mm">感谢阅读！我希望这篇文章对你有所帮助。请随意留下评论或建议。我很想知道是否有更好的方法来做到这一点。</em></p></div></div>    
</body>
</html>