<html>
<head>
<title>That time a dormant bug came alive and everything went wrong at the same time</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">那一次，一个休眠的bug复活了，所有的事情都同时出错了</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/that-time-a-dormant-bug-came-alive-and-everything-went-wrong-at-the-same-time-9669b289dece?source=collection_archive---------17-----------------------#2017-11-07">https://medium.com/hackernoon/that-time-a-dormant-bug-came-alive-and-everything-went-wrong-at-the-same-time-9669b289dece?source=collection_archive---------17-----------------------#2017-11-07</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="fcbc" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated"><strong class="ak"> Skyscanner工程验后，分享了</strong></h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/2dfc94d8852862c1ed690d85b1d00691.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YXtTkv-vCHgjsLfiTEwGmw.png"/></div></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">That time a dormant bug came alive and everything went wrong at the same time. Illustration by Skyscanner’s Gavin Spence.</figcaption></figure><p id="4d42" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated"><em class="kv">戴夫·阿彻和马特·海利</em></p><p id="6743" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">在<a class="ae kw" href="http://skyscanner.net?utm_medium=blog&amp;utm_source=engmediumblogpost&amp;utm_campaign=dormant_bug_came_alive" rel="noopener ugc nofollow" target="_blank"> Skyscanner </a>我们知道我们的技术或流程会在某个时候让我们失望，但这没关系。<a class="ae kw" rel="noopener" href="/@SkyscannerEng/post-mortems-are-for-learning-and-sharing-1b6a38526923">介绍了我们的事后分析系列</a>，这是我们希望在未来继续的系列的第二篇文章。</p><h1 id="1687" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated"><strong class="ak">背景</strong></h1><p id="b688" class="pw-post-body-paragraph jz ka hu kb b kc lp iv ke kf lq iy kh ki lr kk kl km ls ko kp kq lt ks kt ku hn dt translated">我们经常使用可以远程设置的配置标志来推出新功能。web节点(内部称为<strong class="kb hv">支架</strong>节点)轮询这些标志及其各自的约束(特定市场中的用户、服务的流量百分比等)，并在每个请求的基础上对它们进行评估。</p><h1 id="1480" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated"><strong class="ak">问题摘要</strong></h1><p id="9dc1" class="pw-post-body-paragraph jz ka hu kb b kc lp iv ke kf lq iy kh ki lr kk kl km ls ko kp kq lt ks kt ku hn dt translated">当我们试图推出一个更改来替换我们用于网络爬虫检测的提供者时，我们的scaffold代码库中一个长期休眠的bug浮出了水面。远程配置标志已启用，对它的评估触发了请求执行中的无限循环。这使我们所有的节点超载，导致整个舰队倒下。</p><p id="60db" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">在生产事故期间，我们的流程通常从恢复最近的更改(包括远程配置标志)开始，但这被证明是有问题的，原因如下:</p><ul class=""><li id="b612" class="lu lv hu kb b kc kd kf kg ki lw km lx kq ly ku lz ma mb mc dt translated">在第一个实例中，我们没有正确地回滚有问题的配置，这意味着我们花了几个小时才结束</li><li id="b9ff" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">我们的脚手架服务器运行在IIS下。对于这种灾难性故障，IIS在看到太多连续错误后关闭应用程序池，这意味着节点不会自动获取我们试图对远程配置标志所做的更改</li></ul><p id="a7b7" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">最终，违规的配置被正确还原，节点重新启动，秩序恢复。</p><h1 id="1da3" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated"><strong class="ak">事发期间</strong></h1><p id="95c1" class="pw-post-body-paragraph jz ka hu kb b kc lp iv ke kf lq iy kh ki lr kk kl km ls ko kp kq lt ks kt ku hn dt translated">这个问题的根本原因在下面的章节中有概述。这个问题更有意思的地方在于，事故期间的一系列事件导致这成为我们持续时间最长的中断之一。为简洁起见，这里以点的形式列出了顺序。</p><ul class=""><li id="5747" class="lu lv hu kb b kc kd kf kg ki lw km lx kq ly ku lz ma mb mc dt translated">为1%<strong class="kb hv">*</strong>个请求启用了“Crawler检测提供程序”标志</li><li id="dee0" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">Web节点在获取新配置并评估标志时崩溃</li><li id="b347" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">“爬网程序检测提供程序”被错误回滚。标志值从TRUE设置为FALSE，但约束保留在原位**。在这一点之后，我们基于错误的假设进行调查</li><li id="c5ce" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">不正确的假设是节点正在努力启动并获取更新的远程配置(参见下面的部分'<strong class="kb hv"> <em class="kv">为什么花了这么长时间…' </em> </strong> <em class="kv"> ) </em></li><li id="a3f8" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">已尝试保护服务器免受流量影响，以允许它们使用更新的远程配置启动</li><li id="163d" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">手动将更新的配置复制到部分节点。问题仍然存在，表明问题出在配置本身</li><li id="051d" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">已完全回滚远程配置设置</li><li id="42e2" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">节点开始成功恢复和服务流量</li></ul><p id="bbe3" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated"><strong class="kb hv"> <em class="kv"> * </em> </strong> <em class="kv">对所有节点上的所有请求评估1%标志，但该功能仅针对1%的请求激活</em></p><p id="360b" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated"><em class="kv"> **问题不在于新代码路径，而在于约束的评估</em></p><p id="85ae" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">影响完全诊断和解决问题的时间的其他因素包括:</p><ul class=""><li id="7e8e" class="lu lv hu kb b kc kd kf kg ki lw km lx kq ly ku lz ma mb mc dt translated">在断电期间，配置UI不可用。它还没有从monolithic scaffold代码库中移除(尽管底层服务已经移除)。</li><li id="15f3" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">由于我们的数据平台出现了一个不相关但不幸的时间问题，所有仪表盘都不可用。</li><li id="1206" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">试图在Akamai(我们的CDN)级别清空单个数据中心并没有达到预期效果；耗尽的数据中心继续接收流量。其根本原因不在本报告的讨论范围之内，尽管已经启动了一项单独的调查。</li></ul><h1 id="4d9e" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated"><strong class="ak">根本原因</strong></h1><p id="4c16" class="pw-post-body-paragraph jz ka hu kb b kc lp iv ke kf lq iy kh ki lr kk kl km ls ko kp kq lt ks kt ku hn dt translated">如上所述，我们正在改变爬虫检测的提供者。为了安全地做到这一点，我们选择将交换机放在一个配置标志之后，并使用一个“实验”(这里很少使用这个术语)约束来缓慢地增加到新提供商的流量。</p><ul class=""><li id="b762" class="lu lv hu kb b kc kd kf kg ki lw km lx kq ly ku lz ma mb mc dt translated">为了将请求识别为网络爬虫，脚手架必须评估配置标志以在两个爬虫检测提供者之间选择一个</li><li id="3059" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">评估需要检查配置服务中定义的所有约束；在这种情况下，实验约束是特别有趣的</li><li id="4cdf" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">为了避免网络调用，实验变量的分配由我们的Jekyll博士(我们的实验平台)的胖客户端根据所选的请求属性来执行</li><li id="970f" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">一个属性指示请求是否来自爬虫</li><li id="e456" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">但是，由于与此展开相关的一个类似标志，确定请求是否来自爬虫程序再次依赖于实验分配数据，这导致了一个循环依赖:爬虫程序信息需要实验数据，而实验数据是基于爬虫程序信息评估的</li><li id="33dc" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">在由互斥的、请求范围的锁定义的临界区内，每个网站请求计算一次分配参数。由爬网程序信息请求触发的参数的重复计算导致IIS应用程序池被停止。</li></ul><h1 id="c14e" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated"><strong class="ak">检测时间</strong></h1><p id="8181" class="pw-post-body-paragraph jz ka hu kb b kc lp iv ke kf lq iy kh ki lr kk kl km ls ko kp kq lt ks kt ku hn dt translated">目标是<strong class="kb hv"> 15分钟</strong>，实际是<strong class="kb hv">4分钟</strong>，而解决时间——目标是<strong class="kb hv"> 60分钟</strong>，实际是<strong class="kb hv"> 215分钟</strong>。我们的检测中心通过自动报告提出了问题，这是我们内部员工报告问题的备用渠道，同时我们还通过我们的用户满意度团队和Twitter渠道收到了用户报告。</p><h1 id="a505" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated"><strong class="ak">影响？</strong></h1><p id="1620" class="pw-post-body-paragraph jz ka hu kb b kc lp iv ke kf lq iy kh ki lr kk kl km ls ko kp kq lt ks kt ku hn dt translated">在我们的网络产品上，访问网站的旅行者会看到休斯顿错误页面。对于我们的移动应用，重定向到合作伙伴的用户通过浏览器发送，这意味着使用我们应用的旅行者无法完成任何预订。</p><p id="c905" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">我们也看到了在bug浮出水面的一个小时内对SEO的影响。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff mi"><img src="../Images/bae717a7d1d0a0a7186de1e75f3033d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XL9e1lR8XjCLs2w6X-QkkA.png"/></div></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">Our Houston error page</figcaption></figure><h1 id="c41e" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated"><strong class="ak">问题</strong></h1><p id="ad83" class="pw-post-body-paragraph jz ka hu kb b kc lp iv ke kf lq iy kh ki lr kk kl km ls ko kp kq lt ks kt ku hn dt translated"><strong class="kb hv"> <em class="kv">为什么这个问题在影响生产之前没有被发现？</em>T15】</strong></p><p id="2d89" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">新功能在生产前通过配置标志完全启用。然而，它不是以实验作为约束来启用的；仅通过配置将其从0%切换到100%。直到这次事件，这是我们相对标准的做法。</p><p id="d048" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">自动化测试覆盖还缺少配置和实验约束都启用的生产案例。</p><p id="825a" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated"><strong class="kb hv">T19】</strong></p><p id="5f6e" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">配置更新在早期就被确定为触发器。为了尝试修复它，条目从TRUE更改为FALSE。</p><p id="eabf" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">然而，(我们现在知道)根本问题是由仍然存在的约束引起的。</p><p id="d796" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">当团队试图让Scaffold服务器重新上线(通过重启IIS应用程序池)时，它们立即再次崩溃。当时(不正确的)假设是脚手架服务器在倒下之前没有获得最新的配置。</p><p id="946a" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">然后，团队在重启之前将最新的配置文件复制到Scaffold boxes中(以绕过Scaffold中的轮询机制)。然而，脚手架服务器在重启时仍然会倒下。</p><p id="5cb2" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">有了这个新的知识，配置条目被完全删除了(当没有可用的配置时，Scaffold有安全的缺省值可以使用)。</p><p id="9ae6" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">应用程序池被重启，这一次Scaffold服务器获得了新的配置并保持在线。</p><h1 id="7a4d" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated"><strong class="ak">主要经验</strong></h1><ul class=""><li id="1dda" class="lu lv hu kb b kc lp kf lq ki mj km mk kq ml ku lz ma mb mc dt translated">在生产前安全地测试配置+实验的组合(配置已经过测试，但没有后备实验)</li><li id="ee37" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">如果确定错误的配置/实验值是问题的原因，而不是向前修复，则恢复错误的配置/实验值</li><li id="0dd5" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">尽可能将系统分开，以限制停机的影响(在这种情况下，是脚手架+配置UI)</li><li id="5381" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">充分理解并考虑爆炸半径的变化——尽可能限制</li><li id="915f" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">网站稳定性可能会对用户性能指标(由于快速反弹而导致的搜索间隔时间)产生影响，并影响SEO</li></ul><h1 id="0c1b" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated"><strong class="ak">来自团队的反馈</strong></h1><p id="382e" class="pw-post-body-paragraph jz ka hu kb b kc lp iv ke kf lq iy kh ki lr kk kl km ls ko kp kq lt ks kt ku hn dt translated">不管这一事件的具体情况如何，我们需要确保我们限制了未来任何释放的爆炸半径和故障域。我们将流量限制在上面提到的1%的机制是基于软件的决定，它应该被物理地限制在运行在节点子集上的代码。</p><ul class=""><li id="2af7" class="lu lv hu kb b kc kd kf kg ki lw km lx kq ly ku lz ma mb mc dt translated">我们需要在停机期间冻结其他实验，以防止雪球效应和根本原因的混乱。</li><li id="5afe" class="lu lv hu kb b kc md kf me ki mf km mg kq mh ku lz ma mb mc dt translated">我们需要了解爆炸半径并限制它，以及如何在未来进行没有如此大风险的实验。</li></ul><p id="efba" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">以上所有问题现在都已解决。</p><p id="b40d" class="pw-post-body-paragraph jz ka hu kb b kc kd iv ke kf kg iy kh ki kj kk kl km kn ko kp kq kr ks kt ku hn dt translated">你怎么想呢?请在下面评论或发微博告诉我们你的理论、评论和想法。</p><h2 id="8925" class="mm ky hu bd kz mn mo mp ld mq mr ms lh ki mt mu lj km mv mw ll kq mx my ln mz dt translated"><strong class="ak">喜欢你听到的吗？与我们合作</strong></h2><p id="a603" class="pw-post-body-paragraph jz ka hu kb b kc lp iv ke kf lq iy kh ki lr kk kl km ls ko kp kq lt ks kt ku hn dt translated">我们在Skyscanner以不同的方式做事，我们正在全球办事处寻找更多的工程团队成员。看看我们的<a class="ae kw" href="https://www.skyscanner.net/jobs/" rel="noopener ugc nofollow" target="_blank"> Skyscanner职位</a>寻找更多空缺。</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff na"><img src="../Images/986ea3d9e2542000bd33035721b207c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zvfRkK8SIOuNFiFn_KcUUw.png"/></div></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek"><a class="ae kw" href="https://www.skyscanner.net/jobs/" rel="noopener ugc nofollow" target="_blank">Skyscanner Jobs</a></figcaption></figure><h1 id="7ff5" class="kx ky hu bd kz la lb lc ld le lf lg lh ja li jb lj jd lk je ll jg lm jh ln lo dt translated">关于作者</h1><p id="2627" class="pw-post-body-paragraph jz ka hu kb b kc lp iv ke kf lq iy kh ki lr kk kl km ls ko kp kq lt ks kt ku hn dt translated">大家好，我是Matt，是Skyscanner的工程经理，与Dave和我们核心web团队的其他成员一起工作。在第一线工作，没有一天是无聊的。随着我们继续在全球范围内扩大规模，我们在维护网站和开发对我们的成功至关重要的新系统之间周旋。在一家旅游公司工作，我喜欢旅游并不奇怪——中国是下一个目标！</p><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff nb"><img src="../Images/d3147727a84cf6f3a91aa7298a74d768.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jc6EsklkaL11X9cOeeIdLg.jpeg"/></div></div><figcaption class="jv jw fg fe ff jx jy bd b be z ek">Matt Hailey, Skyscanner</figcaption></figure></div></div>    
</body>
</html>