<html>
<head>
<title>5 Gotchas with Elastic Beanstalk and Django</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">弹性豆茎和Django的5个问题</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/5-gotchas-with-elastic-beanstalk-and-django-177896723d01?source=collection_archive---------25-----------------------#2017-07-25">https://medium.com/hackernoon/5-gotchas-with-elastic-beanstalk-and-django-177896723d01?source=collection_archive---------25-----------------------#2017-07-25</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/70cd5bb800272ea13370f6622b7d5c55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VovltObI5AGlS_7INpAwtQ.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">5 Gotchas with Elastic Beanstalk and Django</figcaption></figure><p id="19b8" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在<a class="ae ke" href="https://hashedin.com/" rel="noopener ugc nofollow" target="_blank">哈希丁</a>，我们通常在AWS Elastic Beanstalk上部署基于Django的应用程序。虽然EB很棒，但它也有一些边缘案例。如果您正在部署一个Django应用程序，下面是您应该知道的一些事情。</p><p id="7ada" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">旁白:如果你正在开始一个新项目，这个项目是为elastic beanstalk设计的，<a class="ae ke" href="https://github.com/hashedin/django-project-template" rel="noopener ugc nofollow" target="_blank"> Django项目模板</a>可以简化配置。</p><h1 id="2e74" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">陷阱#1:自动扩展组运行状况检查并不像您想象的那样工作</h1><p id="5833" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">Elastic Beanstalk允许您配置健康检查URL。弹性负载平衡器使用此健康检查URL来确定实例是否健康。但是，<a class="ae ke" href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/environmentconfig-autoscaling-healthchecktype.html" rel="noopener ugc nofollow" target="_blank">自动秤组不使用这种健康检查</a>。</p><p id="b687" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">因此，如果实例健康检查由于某种原因失败，弹性负载平衡器会将其标记为不健康，并将其从负载平衡器中删除。但是，自动缩放组仍然认为实例是健康的，并且不会重新启动实例。</p><p id="7e3c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">Elastic Beanstalk保持这种方式，让您有机会通过ssh进入机器，找出问题所在。如果自动缩放组立即终止机器，您将没有该选项。</p><p id="af2c" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">修复方法是将自动扩展组配置为使用基于弹性负载平衡器的运行状况检查。将以下内容添加到。ebextensions将解决这个问题。</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="ee16" class="lr kg hu ln b fv ls lt l lu lv">Resources:<br/>   AWSEBAutoScalingGroup:<br/>     Type: "AWS::AutoScaling::AutoScalingGroup"<br/>     Properties:<br/>       HealthCheckType: "ELB"<br/>       HealthCheckGracePeriod: "600"</span></pre><p id="3296" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">学分:</p><ol class=""><li id="0e1a" class="lw lx hu ji b jj jk jn jo jr ly jv lz jz ma kd mb mc md me dt translated"><a class="ae ke" href="https://github.com/ThoughtWorksStudios/eb_deployer/wiki/Elastic-Beanstalk-Tips-and-Tricks" rel="noopener ugc nofollow" target="_blank"> EB部署人员的技巧和诀窍</a></li><li id="27b3" class="lw lx hu ji b jj mf jn mg jr mh jv mi jz mj kd mb mc md me dt translated"><a class="ae ke" href="http://www.onegeek.com.au/articles/lessons-learned-configuring-a-ha-multi-docker-container-elastic-beanstalk" rel="noopener ugc nofollow" target="_blank">配置多码头集装箱弹性豆茎</a></li></ol><h1 id="9896" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">问题2:定制日志不能与弹性Beanstalk一起工作</h1><p id="6abe" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">默认情况下，wsgi帐户对当前工作目录没有写权限，因此您的日志文件将不起作用。<a class="ae ke" href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.logging.html" rel="noopener ugc nofollow" target="_blank">根据Beanstalk的文档</a>，窍门是将日志文件写在<code class="eh mk ml mm ln b">/opt/python/log directory</code>下。</p><p id="53bc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然而，这并不总是像预期的那样工作。当django在该目录中创建日志文件时，日志文件归root所有，因此django不能写入该文件。</p><p id="9fbf" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">诀窍是运行一个小脚本作为。ebextensions来修复这个问题。在<code class="eh mk ml mm ln b">.ebextensions/logging.config</code>中增加以下内容:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="0ef0" class="lr kg hu ln b fv ls lt l lu lv">commands:<br/>01_change_permissions:<br/>command: chmod g+s /opt/python/log<br/>02_change_owner:<br/>command: chown root:wsgi /opt/python/log</span></pre><p id="8a13" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">通过这一更改，您现在可以将自定义日志文件写入该目录。另外，当您使用elastic beanstalk控制台或eb工具获取日志时，您的自定义日志文件也将被下载。</p><h1 id="ed38" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">问题3:弹性负载平衡器运行状况检查不设置主机头</h1><p id="1e9a" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">Django的<code class="eh mk ml mm ln b">ALLOWED_HOSTS</code>设置要求您将允许的主机名列入白名单。问题是，弹性负载平衡器健康检查在发出请求时不会设置主机名。相反，它直接连接到实例的私有ip地址，因此主机头是实例的私有ip地址。</p><p id="f12d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这个问题有几个不太理想的解决方案</p><p id="d0d3" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">终止apache </strong>上的健康检查—例如，通过将健康检查url设置为apache提供的静态文件。这种方法的问题是，如果Django不工作，health check不会报告失败</p><p id="7caa" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">使用基于TCP/IP的健康检查</strong> —这只是检查端口80是否打开。这有同样的问题——如果Django不工作，健康检查不会报告失败</p><p id="ad92" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji hv">Set ALLOWED _ HOSTS =[' *]</strong>—这将完全禁用主机检查，从而引发安全问题。此外，如果您搞乱了DNS，您可以非常容易地发送QA流量到生产。</p><p id="f0e2" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">稍微好一点的解决方案是检测服务器的内部ip地址，并在启动时将其添加到ALLOWED_HOSTS中。不过，可靠地做到这一点有点复杂。假设您的EB环境是linux，下面是一个方便的脚本:</p><pre class="li lj lk ll fq lm ln lo lp aw lq dt"><span id="efe0" class="lr kg hu ln b fv ls lt l lu lv">def is_ec2_linux():<br/>    """Detect if we are running on an EC2 Linux Instance<br/>       See <a class="ae ke" href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/identify_ec2_instances.html" rel="noopener ugc nofollow" target="_blank">http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/identify_ec2_instances.html</a><br/>    """<br/>    if os.path.isfile("/sys/hypervisor/uuid"):<br/>        with open("/sys/hypervisor/uuid") as f:<br/>            uuid = f.read()<br/>            return uuid.startswith("ec2")<br/>    return False</span><span id="19db" class="lr kg hu ln b fv mn lt l lu lv">def get_linux_ec2_private_ip():<br/>    """Get the private IP Address of the machine if running on an EC2 linux server"""<br/>    import urllib2<br/>    if not is_ec2_linux():<br/>        return None<br/>    try:<br/>        response = urllib2.urlopen('<a class="ae ke" href="http://169.254.169.254/latest/meta-data/local-ipv4'" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/meta-data/local-ipv4'</a>)<br/>        return response.read()<br/>    except:<br/>        return None<br/>    finally:<br/>        if response:<br/>    response.close()</span><span id="7671" class="lr kg hu ln b fv mn lt l lu lv"># ElasticBeanstalk healthcheck sends requests with host header = internal ip<br/># So we detect if we are in elastic beanstalk, <br/># and add the instances private ip address<br/>private_ip = get_linux_ec2_private_ip()<br/>if private_ip:<br/>    ALLOWED_HOSTS.append(private_ip)</span></pre><p id="5dcb" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">根据您的情况，这可能比您所关心的工作更多—在这种情况下，您可以简单地将ALLOWED_HOSTS设置为['*']。</p><h1 id="b3a4" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">问题4:EB上的Apache服务器没有针对性能进行配置</h1><p id="6b5b" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">出于性能原因，您希望压缩文本文件，通常使用gzip。在内部，elastic beanstalk for python使用Apache web服务器，但是它没有配置为gzip内容。</p><p id="a601" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这很容易通过<a class="ae ke" href="http://www.tonmoygoswami.com/2013/05/how-to-enable-gzip-on-amazon-elastic.html" rel="noopener ugc nofollow" target="_blank">添加另一个配置文件</a>来解决。</p><p id="ff3e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">此外，如果您正在对静态文件进行版本控制，您可能希望设置强缓存头。默认情况下，Apache不设置这些头。<a class="ae ke" href="https://github.com/hashedin/django-project-template/blob/master/%7B%7Bcookiecutter.github_repository_name%7D%7D/.ebextensions/enable_cache_headers.conf" rel="noopener ugc nofollow" target="_blank">该配置文件将缓存控制头设置为任何嵌入了版本号的静态文件</a>。</p><h1 id="b865" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">问题5:当您终止环境时，Elastic Beanstalk将删除RDS数据库</h1><p id="32a8" class="pw-post-body-paragraph jg jh hu ji b jj ld jl jm jn le jp jq jr lf jt ju jv lg jx jy jz lh kb kc kd hn dt translated">因此，请始终独立创建RDS实例。将数据库参数设置为环境变量。在django设置中，使用<a class="ae ke" href="https://github.com/kennethreitz/dj-database-url" rel="noopener ugc nofollow" target="_blank"> dj_database_url </a>从环境变量中解析数据库凭证。</p></div><div class="ab cl mo mp hc mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="hn ho hp hq hr"><p id="1844" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><em class="mv">原载于2017年7月25日</em><a class="ae ke" href="https://hashedin.com/blog/5-gotchas-with-elastic-beanstalk-and-django/" rel="noopener ugc nofollow" target="_blank"><em class="mv">【hashedin.com</em></a><em class="mv">。</em></p></div></div>    
</body>
</html>