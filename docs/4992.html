<html>
<head>
<title>Using Normalizr to organize data in stores — practical guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Normalizr组织商店中的数据——实用指南</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/using-normalizr-to-organize-data-in-stores-practical-guide-82fa061b60fb?source=collection_archive---------1-----------------------#2017-07-04">https://medium.com/hackernoon/using-normalizr-to-organize-data-in-stores-practical-guide-82fa061b60fb?source=collection_archive---------1-----------------------#2017-07-04</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/ab292103022fc99f8659ce5aaab9484c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wk4ACd2qHhaTrCeKRDeJQw.jpeg"/></div></div></figure><p id="0734" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">React应用程序通常需要来自服务器的一些数据存储在本地以供立即使用，主要是显示在页面上。如果应用程序使用复杂的关系数据库，这可能会有点问题。在这里，我将尝试描述我们在<a class="ae ka" href="https://dashbouquet.com/" rel="noopener ugc nofollow" target="_blank"><strong class="je hv"/></a><strong class="je hv"/>的一个项目中遇到的数据组织问题，以及我们如何设法解决这些问题。</p><p id="ccb2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">先说个例子。比方说，我们有一个包含多个页面的应用程序，每个页面都需要来自服务器的一些数据。如果有足够多的页面，当应用程序加载时，数据量会变得太大而无法立即获取。所以每次我们加载页面时都会请求数据。对于每个页面，我们可能在存储中有一个分区来保存与页面相关的数据，所以我们可能也想把获取的数据放在那里。</p><p id="f41c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们的应用程序将有几个页面。第一份是大学教师名单，第二份是学生名单。通过点击老师的名字，用户可以进入某个老师的页面，上面有他的学生和课程的列表。对学生来说也是一样——通过点击名字，我们可以看到学生的页面，上面有教师和课程列表。</p><p id="8edb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">ER图应该是这样的:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kb"><img src="../Images/f9009b6cb048e51e8c56e78db5fe6321.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QO4TXjh5e7LtlC9YukeVTQ.png"/></div></div><figcaption class="kg kh fg fe ff ki kj bd b be z ek"><strong class="bd kk">Fig. 1. Entity-Relationship Diagram</strong></figcaption></figure><p id="c36c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们可以决定在哪个页面上需要什么数据:</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff kl"><img src="../Images/40c9ef84d5b314600718ecbd45b302cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qQ1dqP9dBY_f1BSP_0nJDg.png"/></div></div><figcaption class="kg kh fg fe ff ki kj bd b be z ek"><strong class="bd kk">Fig.2. Division of entities by pages</strong></figcaption></figure><p id="2346" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我将借助我们在项目中使用的堆栈来描述这个例子。后端是Loopback，前端是React、Redux和Redux-saga，与服务器交互是Axios。</p><p id="9de6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">正如我们所看到的，我们可能需要不同页面的相同数据。例如，我们需要教师页面上的所有教师和单个学生页面上的一些教师。那么我们把它们存放在哪里呢？也许我们并不总是需要在单个学生页面上获取教师。如果我们决定不去找老师，我们把数据带到哪里去呢？如果我们决定在两个页面上取数据，我们把数据放在哪里以避免重复？当数据分布在整个商店时，尤其是当应用程序超过四个页面并且有大量数据时，所有这些可能会非常混乱。</p><p id="89a7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">将所有数据保存在一个地方可能更好。还有一个怎么取的问题。我们绝对不希望单独获取实体，因为这样我们将很容易达到每页30-50个请求的程度，这将使页面加载速度太慢。我们希望在一个请求中获得尽可能多的数据(例如，在回送的情况下使用包含过滤器)。在对教师的响应中，我们得到类似这样的内容(<strong class="je hv">服务器响应的形状)</strong>:</p><pre class="kc kd ke kf fq km kn ko kp aw kq dt"><span id="5200" class="kr ks hu kn b fv kt ku l kv kw">    [<br/>       {<br/>            <strong class="kn hv">students</strong>: [<br/>                   {<br/>                          id,<br/>                          name,<br/>                          <strong class="kn hv">studentCourses</strong>: [<br/>                                 {<br/>                                       studentId,<br/>                                       courseId,<br/>                                       grande,<br/>                                 },<br/>                                 ...<br/>                           ],<br/>                    },<br/>                    ...<br/>            ],<br/>            <strong class="kn hv">courses</strong>: [<br/>                  {<br/>                           id,<br/>                           name,<br/>                  },<br/>                  ...<br/>            ],<br/>       },<br/>       ...<br/>    ]</span></pre><p id="c264" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae ka" href="http://loopback.io/doc/en/lb3/Include-filter.html" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv">在这里</strong> </a>你可以了解如何在查询中组合数据，如果你也使用回送的话。</p><p id="5554" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在这个特殊的例子中，这将为我们节省两个请求，但是如果我们谈论前端存储，这不是很有用。首先，如果数据库发生变化，例如为一名教师添加了新课程，该怎么办？我们必须重新安排课程和教师，而不是重新安排课程。其次，我们可能需要学生实体实例中的课程，但是当我们向服务器发出查询时，我们不包括这些课程以避免重复。</p><p id="0b4d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了解决上述问题，我们可以从Normalizr开始——一个用嵌套对象规范化数据的实用程序，就像我们的例子一样。我就不多说了:你可以在这里 找到所有信息<a class="ae ka" href="https://github.com/paularmstrong/normalizr" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv">。关键是在对Normalizr的工作结果进行一些简单的操作后，我们得到了可以保存的数据。</strong></a></p><p id="2958" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们需要定义几个传奇。如果你还没有在你的项目中使用redux-saga，我认为<a class="ae ka" href="https://redux-saga.js.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv">这个</strong> </a>应该会说服你这样做。</p><p id="e0d4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">第一个传奇将<strong class="je hv">获取数据</strong>:</p><pre class="kc kd ke kf fq km kn ko kp aw kq dt"><span id="558d" class="kr ks hu kn b fv kt ku l kv kw"><strong class="kn hv">const</strong> urls = {<br/>      teachers: '/teachers,<br/>      students: '/students’,<br/>      courses: '/courses',<br/>};</span><span id="224a" class="kr ks hu kn b fv kx ku l kv kw"><strong class="kn hv">export function</strong>* fetchModel(<em class="ky">model</em>, <em class="ky">ids</em>, <em class="ky">include</em>) {<br/>       <strong class="kn hv">const</strong> url = urls[<em class="ky">model</em>];<br/>       <strong class="kn hv">const</strong> where = {id: {inq: <em class="ky">ids</em>}};<br/>       <strong class="kn hv">const</strong> filter = {where, <em class="ky">include</em>};<br/>       <strong class="kn hv">const</strong> params = {filter};<br/>       <strong class="kn hv">return yield get</strong>({url, params});<br/>}</span></pre><p id="3836" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">第二个将<strong class="je hv">存储数据</strong>:</p><pre class="kc kd ke kf fq km kn ko kp aw kq dt"><span id="2205" class="kr ks hu kn b fv kt ku l kv kw"><strong class="kn hv">export function</strong>* queryModels(<em class="ky">modelName</em>, <em class="ky">ids</em>, <em class="ky">include</em>]) {<br/>       <strong class="kn hv">const</strong> singleModelSchema = schema[<em class="ky">modelName</em>];<br/>       <strong class="kn hv">const</strong> denormalizedData = yield fetchModel(<em class="ky">modelName</em>, <em class="ky">ids</em>, <em class="ky">include</em>);<br/>       <strong class="kn hv">const</strong> normalizedData = normalize(denormalizedData, [singleModelSchema]);</span><span id="b531" class="kr ks hu kn b fv kx ku l kv kw">       <strong class="kn hv">const</strong> {entities} = normalizedData;<br/>       <strong class="kn hv">yield put</strong>(addEntities(entities));<br/>}</span></pre><p id="7840" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">并且<strong class="je hv">缩减器</strong>将向已经获取的数据添加新的数据:</p><pre class="kc kd ke kf fq km kn ko kp aw kq dt"><span id="8298" class="kr ks hu kn b fv kt ku l kv kw">case ADD_ENTITIES: {<br/>     const models = <em class="ky">action</em>.entities;<br/>     const newState = cloneDeep(<em class="ky">state</em>);<br/>     return mergeWith(newState, models);<br/>}</span></pre><p id="6073" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这里的和方法mergeWith和cloneDeep <a class="ae ka" href="https://lodash.com/" rel="noopener ugc nofollow" target="_blank">都来自lodash。</a></p><p id="9523" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">完成所有这些后，我们可以用这种方式从服务器查询数据(<strong class="je hv">选择器</strong>):</p><pre class="kc kd ke kf fq km kn ko kp aw kq dt"><span id="ac76" class="kr ks hu kn b fv kt ku l kv kw">export function* fetchTeachers() {<br/>  yield queryModels('teachers', ids, [<br/>        {<br/>             relation: 'students',<br/>             scope: {<br/>                 include: ['studentCourses'],<br/>             }<br/>        },<br/>        {<br/>          relation: 'courses',<br/>        }<br/>  ]);<br/>}</span></pre><p id="2206" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">Normalizr使用一个规范化模式，如<a class="ae ka" href="https://github.com/paularmstrong/normalizr" rel="noopener ugc nofollow" target="_blank"> <strong class="je hv">这里</strong> </a>所述。</p><p id="4457" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最终，我们得到的<strong class="je hv">状态</strong>看起来像这样:</p><pre class="kc kd ke kf fq km kn ko kp aw kq dt"><span id="6193" class="kr ks hu kn b fv kt ku l kv kw">    <strong class="kn hv">state</strong>: {<br/>         ...<br/>         <strong class="kn hv">models</strong>: {<br/>               teachers: {...},<br/>               sudents: {...},<br/>               courses: {...},<br/>               studentCourses: {...},<br/>         },<br/>         ...<br/>    }</span></pre><p id="f28f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这基本上是我们商店中数据库的一个很好的小拷贝。不需要分派大量动作来将提取的数据放入存储的不同部分，也不需要记住每段数据应该存储在哪里。这是在queryModels saga中完成的，我们总是知道提取的数据将放在哪里。</p><p id="9e88" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">之后，我们可以在应用程序的任何页面中使用它，并根据需要在选择器中进行组合。</p><p id="a0a9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我们的例子中，如果需要，我们可以为教师获取一个像这样复杂的对象(<strong class="je hv">非规范化数据)</strong>:</p><pre class="kc kd ke kf fq km kn ko kp aw kq dt"><span id="47bd" class="kr ks hu kn b fv kt ku l kv kw">    {<br/>       <strong class="kn hv">students</strong>: [<br/>              {<br/>                     id,<br/>                     name,<br/>                     <strong class="kn hv">studentCourses</strong>: [...],<br/>                     <strong class="kn hv">courses</strong>: [...],<br/>              },<br/>              ...<br/>       ],<br/>       <strong class="kn hv">courses</strong>: [<br/>             {<br/>                     id,<br/>                     name,<br/>                     <strong class="kn hv">sudents</strong>: [...],<br/>                     <strong class="kn hv">teachers</strong>: [...],<br/>             },<br/>             ...<br/>       ],<br/>    }</span></pre><p id="6402" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">还有另一种方法。我们可以描述一个通用的API，在使用它之前对数据进行反规范化。这里的问题是我们需要一个API来反规格化数据，因为Normalizr包附带的反规格化函数只能将数据反规格化为它来自服务器时的形状，这不是我们想要的。如上所述，我们只在教师实体中获得课程，尽管我们可能在其他地方需要它们。对于较大的项目，我认为，花一些时间来想出一个定制的反规范化函数是值得的。然而，这是另一篇文章的主题。</p><p id="da45" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当我们开始在项目中使用这种方法时，对我来说是一种解脱。这里的主要优点是你总是知道在哪里可以找到你需要的东西。如果您决定以另一种方式聚合数据会更好，那么您不需要再修改查询，只需稍微更改一个选择器。一般来说，使用这种方法管理存储中的数据需要的工作量要少得多。</p></div><div class="ab cl kz la hc lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hn ho hp hq hr"><div class="kc kd ke kf fq lg"><a href="https://hackernoon.com/missing-part-of-redux-saga-experience-1d2d169ba765" rel="noopener  ugc nofollow" target="_blank"><div class="lh ab ej"><div class="li ab lj cl cj lk"><h2 class="bd hv fv z el ll eo ep lm er et ht dt translated">Redux Saga体验中缺失的部分</h2><div class="ln l"><h3 class="bd b fv z el ll eo ep lm er et ek translated">Redux saga是应用程序和redux store之间的中间件，由redux actions处理。这意味着，它可以…</h3></div><div class="lo l"><p class="bd b gc z el ll eo ep lm er et ek translated">hackernoon.com</p></div></div><div class="lp l"><div class="lq l lr ls lt lp lu ja lg"/></div></div></a></div><div class="lv lw fm fo lx lg"><a href="https://hackernoon.com/usage-of-reselect-in-a-react-redux-application-fcdca05cc00d" rel="noopener  ugc nofollow" target="_blank"><div class="lh ab ej"><div class="li ab lj cl cj lk"><h2 class="bd hv fv z el ll eo ep lm er et ht dt translated">在React-Redux应用程序中使用重选</h2><div class="ln l"><h3 class="bd b fv z el ll eo ep lm er et ek translated">为什么重选这么好</h3></div><div class="lo l"><p class="bd b gc z el ll eo ep lm er et ek translated">hackernoon.com</p></div></div><div class="lp l"><div class="ly l lr ls lt lp lu ja lg"/></div></div></a></div><div class="lv lw fm fo lx lg"><a href="https://hackernoon.com/using-normalizr-to-organize-data-in-store-part-2-d9646133b7df" rel="noopener  ugc nofollow" target="_blank"><div class="lh ab ej"><div class="li ab lj cl cj lk"><h2 class="bd hv fv z el ll eo ep lm er et ht dt translated">使用Normalizr组织存储中的数据。第二部分</h2><div class="ln l"><h3 class="bd b fv z el ll eo ep lm er et ek translated">文章的第二部分讲述了如何使用Normalizr来组织商店中的数据。</h3></div><div class="lo l"><p class="bd b gc z el ll eo ep lm er et ek translated">hackernoon.com</p></div></div><div class="lp l"><div class="lz l lr ls lt lp lu ja lg"/></div></div></a></div><div class="lv lw fm fo lx lg"><a href="https://hackernoon.com/how-to-stop-using-callbacks-and-start-living-1e5ed92e68e8" rel="noopener  ugc nofollow" target="_blank"><div class="lh ab ej"><div class="li ab lj cl cj lk"><h2 class="bd hv fv z el ll eo ep lm er et ht dt translated">如何停止使用回调，开始生活</h2><div class="ln l"><h3 class="bd b fv z el ll eo ep lm er et ek translated">Javascript有两种处理异步任务的主要方式——回调和承诺。一般来说，承诺是…</h3></div><div class="lo l"><p class="bd b gc z el ll eo ep lm er et ek translated">hackernoon.com</p></div></div><div class="lp l"><div class="ma l lr ls lt lp lu ja lg"/></div></div></a></div><p id="eee7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">作者:<a class="ae ka" href="https://github.com/iPhaeton" rel="noopener ugc nofollow" target="_blank">伊利亚·博哈斯洛克</a></p><div class="kc kd ke kf fq ab cb"><figure class="mb iv mc md me mf mg paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mb iv mc md me mf mg paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mb iv mc md me mf mg paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mh mi mj"><p id="f922" class="jc jd ky je b jf jg jh ji jj jk jl jm mk jo jp jq ml js jt ju mm jw jx jy jz hn dt translated"><a class="ae ka" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ka" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ka" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ka" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jc jd ky je b jf jg jh ji jj jk jl jm mk jo jp jq ml js jt ju mm jw jx jy jz hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ka" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ka" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mn"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>