<html>
<head>
<title>Creating a messenger bot with express</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用express创建信使机器人</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/creating-a-messenger-bot-with-express-134e7ec8ea07?source=collection_archive---------5-----------------------#2016-10-21">https://medium.com/hackernoon/creating-a-messenger-bot-with-express-134e7ec8ea07?source=collection_archive---------5-----------------------#2016-10-21</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="b561" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">最初发表在diff博客上，现在我忘记了之前放在媒体上，但是我希望它仍然有用。</em></p><p id="c1b9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">脸书最近宣布了为他们的信使平台创建<a class="ae jq" href="http://newsroom.fb.com/news/2016/04/messenger-platform-at-f8/" rel="noopener ugc nofollow" target="_blank">机器人的方案。</a></p><blockquote class="jr js jt"><p id="77e2" class="ir is jp it b iu iv iw ix iy iz ja jb ju jd je jf jv jh ji jj jw jl jm jn jo hn dt translated"><em class="hu">每个月，全球超过9亿人通过Messenger与朋友、家人和超过5000万家企业交流。这是iOS上第二大最受欢迎的应用，也是2015年美国增长最快的应用。</em></p></blockquote><p id="0baf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有一个接收和发送消息的应用编程接口，这样您就可以通过编程的方式与用户和客户交流，有几个步骤可以让它工作，所以我们建议从一个简单的应用程序开始。你作为一个页面而不是个人与用户互动，所以在这个过程中你会创建一个脸书应用程序和页面。</p><p id="8768" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有一个<a class="ae jq" href="https://github.com/dvidsilva/messenger-bot" rel="noopener ugc nofollow" target="_blank">示例应用程序</a>有两个端点，一个用于接收，另一个用于发送消息。在这个应用程序中，发送者将收到它发送的相同消息。我们对两者使用相同的url，当收到一条消息时，请求是GET，发送一条新消息时，它将使用POST请求。</p><h1 id="2393" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">概观</h1><ol class=""><li id="6fe7" class="kv kw hu it b iu kx iy ky jc kz jg la jk lb jo lc ld le lf dt translated">设置Nodejs应用程序。</li><li id="74dd" class="kv kw hu it b iu lg iy lh jc li jg lj jk lk jo lc ld le lf dt translated">脸书不喜欢自签名证书。使用LetsEncrypt中的一个。</li><li id="de72" class="kv kw hu it b iu lg iy lh jc li jg lj jk lk jo lc ld le lf dt translated">按照Facebook Messenger API文档中提到的步骤创建所需的应用程序和页面。</li><li id="f81c" class="kv kw hu it b iu lg iy lh jc li jg lj jk lk jo lc ld le lf dt translated">生成页面访问令牌。</li><li id="521a" class="kv kw hu it b iu lg iy lh jc li jg lj jk lk jo lc ld le lf dt translated">使用上一步生成的令牌，并将应用程序订阅到页面。</li><li id="5529" class="kv kw hu it b iu lg iy lh jc li jg lj jk lk jo lc ld le lf dt translated">你准备好了，机器人应该用发送的确切字符串来回应。</li><li id="407f" class="kv kw hu it b iu lg iy lh jc li jg lj jk lk jo lc ld le lf dt translated">其他步骤</li></ol><h1 id="8069" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">设置Nodejs应用程序</h1><p id="ed42" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc ll je jf jg lm ji jj jk ln jm jn jo hn dt translated">最简单的方法是在数字海洋中创建一个液滴，在创建液滴时，您可以选择一个小实例，并单击应用程序列表上的nodejs。您也可以通过点击<a class="ae jq" href="https://dashboard.heroku.com/new?button-url=https%3A%2F%2Fgithub.com%2Fdvidsilva%2Fmessenger-bot&amp;template=https%3A%2F%2Fgithub.com%2Fdvidsilva%2Fmessenger-bot" rel="noopener ugc nofollow" target="_blank">(这里是</a>)在Heroku上部署该应用程序，但是我还没有完全证明这一点，所以它可能需要额外的配置。</p><p id="a822" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">运行nodejs生产就绪应用程序对您来说应该是最简单的部分。克隆<a class="ae jq" href="https://github.com/dvidsilva/messenger-bot" rel="noopener ugc nofollow" target="_blank">样本应用程序</a>并使用<a class="ae jq" href="http://pm2.keymetrics.io/" rel="noopener ugc nofollow" target="_blank"> pm2 </a>运行。</p><p id="3fcc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以在<a class="ae jq" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-node-js-application-for-production-on-ubuntu-14-04" rel="noopener ugc nofollow" target="_blank">数字海洋指南</a>中找到更多信息。</p><p id="b22d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">应用程序需要有两个端点，一个get和一个post。</p><p id="f4dc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">脸书将在安装过程中使用Get来验证您是否拥有此端点。</p><p id="9f4b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每次用户向您发送消息时，都会使用Post，并附带消息的有效负载。</p><p id="ff66" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要发送消息，您需要向脸书发送一个包含内容的Post请求。</p><p id="190a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">验证端点如下所示:</p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="f626" class="lx jy hu lt b fv ly lz l ma mb">if (req.query['hub.verify_token'] === conf.VERIFY_TOKEN)<br/>  return res.send(req.query['hub.challenge']);</span></pre><p id="ef1e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它确保脸书发送的令牌与您配置中的令牌相匹配，稍后您将对此进行设置。</p><h1 id="fa28" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">从LetsEncrypt创建证书</h1><p id="4b3c" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc ll je jf jg lm ji jj jk ln jm jn jo hn dt translated"><a class="ae jq" href="https://github.com/dvidsilva/nodeconnect-post/blob/master/LetsEncrypt" rel="noopener ugc nofollow" target="_blank">https://letsencrypt.org/</a>让我们为ssl创建一个证书。它是免费的、自动化的、开放的。这个证书对你的机器人来说已经足够好了。</p><p id="ff35" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要为此过程做准备，请为要使用的域或子域创建一个A记录。</p><p id="5e9d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">克隆LetsEncrypt repo</p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="6157" class="lx jy hu lt b fv ly lz l ma mb">sudo git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt</span></pre><p id="eea6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">并生成证书</p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="90de" class="lx jy hu lt b fv ly lz l ma mb">cd /opt/letsencrypt<br/>./letsencrypt-auto certonly -a webroot --webroot-path=/usr/share/nginx/html -d your.domain.com</span></pre><p id="0802" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它会要求您输入一个电子邮件地址，以获取有关您的域和证书的信息，并同意服务条款。</p><p id="674f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用Webroot插件Webroot插件通过在/中放置一个特殊的文件来工作。您的文档根目录中众所周知的目录，可以通过Let's Encrypt服务打开(通过您的web服务器)进行验证。根据您的配置，您可能需要显式允许访问/。知名目录。</p><p id="5397" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过将它添加到服务器块来修改您的nginx配置</p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="e9e6" class="lx jy hu lt b fv ly lz l ma mb">sudo vi /etc/nginx/sites-available/default</span><span id="c4ca" class="lx jy hu lt b fv mc lz l ma mb">listen 443 ssl;</span><span id="b50f" class="lx jy hu lt b fv mc lz l ma mb">server_name  your.domain.com;</span><span id="3edf" class="lx jy hu lt b fv mc lz l ma mb">ssl_certificate /etc/letsencrypt/live/your.domain.com/fullchain.pem;<br/>ssl_certificate_key /etc/letsencrypt/live/your.domain.com/privkey.pem;</span></pre><p id="f37a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可以在数字海洋指南中找到更详细的步骤<a class="ae jq" href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encryp%0At-on-ubuntu-14-04" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="881c" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">遵循Facebook Messenger API文档中提到的步骤</h1><p id="7725" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc ll je jf jg lm ji jj jk ln jm jn jo hn dt translated">完整的脸书指南可以在<a class="ae jq" href="https://developers.facebook.com/docs/messenger-platform/implementation" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="89d3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你需要有一个页面，你的用户将是一个页面，而不是一个人，所以创建一个新的页面。特别是对于您的测试尝试，最好使用不重要的内容，不要冒险使用重要的业务页面。在我的例子中，我创建了<a class="ae jq" href="https://www.facebook.com/Messenger-Echo-Bot-1747759535458893" rel="noopener ugc nofollow" target="_blank">信使回声机器人</a></p><p id="d056" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在app configuration上，您将生成一个令牌，将这个令牌添加到<a class="ae jq" href="https://github.com/dvidsilva/messenger-bot/blob/master/conf.js" rel="noopener ugc nofollow" target="_blank"> conf.js </a>。</p><p id="57fe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要生成令牌，请转到应用程序配置的产品设置，选择添加产品并找到Messenger，它会让您选择您自己的页面并生成令牌。将此令牌作为配置中的值添加到<code class="eh md me mf lt b">PROFILE_TOKEN</code>。</p><p id="7e11" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以通过应用程序设置或运行以下命令，使用此令牌将页面与应用程序相关联:</p><pre class="lo lp lq lr fq ls lt lu lv aw lw dt"><span id="d658" class="lx jy hu lt b fv ly lz l ma mb">curl -ik  -X POST "https://graph.facebook.com/v2.6/me/subscribed_apps?access_token=&lt;PROFILE_TOKEN&gt;"</span></pre><p id="4c8e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">创建一个随机、安全的字符串，并将其添加到<code class="eh md me mf lt b">VERIFY_TOKEN</code>。在应用程序配置中，添加webhook时会提示您输入此信息。你的节点应用程序现在应该可以工作了，因为脸书只会让你添加webhook，如果这样的话</p><p id="0952" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当你的应用处于开发模式时，插件和API功能只对应用的管理员、开发者和测试者有效。在你的应用程序被批准并公开后，它将为普通大众服务。</p><p id="4cdd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">记得在编辑conf.js后重启你的应用，最快的方法是<code class="eh md me mf lt b">pm2 restart all</code>，但是如果有更多的应用在那个服务器上运行，要小心。</p><h1 id="0e07" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">尝试一下</h1><p id="f3c9" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc ll je jf jg lm ji jj jk ln jm jn jo hn dt translated">转到您创建的页面并选择消息选项，页面将回复您发送的相同文本。</p><p id="84c8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果有错误，调试应该很容易，可能出错的地方很少。</p><p id="55d4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">跟踪应用程序的日志，看看向页面发送消息时会发生什么。</p><p id="a036" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果日志中什么都没有，可能是因为:用户没有关联到应用程序，因此没有触发挂钩，或者挂钩没有正确配置。</p><p id="2cec" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">另一个常见错误是OAuthException，这意味着<code class="eh md me mf lt b">PROFILE_TOKEN</code>不正确。</p><p id="a9bc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你遇到其他你不能修复的错误，试着发表评论，开一张票或者联系我，我会试着看看。</p><h1 id="075e" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">其他步骤</h1><p id="3a53" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc ll je jf jg lm ji jj jk ln jm jn jo hn dt translated">要为用户准备好你的应用程序，你必须提供隐私政策、应用程序图标和关于你的机器人如何工作的视频。对于测试应用程序来说，工作量相当大，他们似乎很认真地对待这一点，并审查每一个提交的内容，所以请确保在申请前完成所有步骤。</p><p id="c1bd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果这就是你的应用的全部功能，你的应用可能会被拒绝，所以试着添加一些聪明的笑话或者更多的信息。</p><p id="6972" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以在脸书应用程序设置的应用程序查看部分找到详细说明。</p><p id="d0ee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">希望这有助于你开始，让我们知道你有什么很酷的机器人！</p></div></div>    
</body>
</html>