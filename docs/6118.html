<html>
<head>
<title>Iterating Through APIs with Multiple Pages</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过多个页面迭代API</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/iterating-through-apis-with-multiple-pages-bf9d4f8d029b?source=collection_archive---------10-----------------------#2017-09-04">https://medium.com/hackernoon/iterating-through-apis-with-multiple-pages-bf9d4f8d029b?source=collection_archive---------10-----------------------#2017-09-04</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="7bcb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">任何从API中提取数据的人都知道它对于为特定主题提取大量数据是多么有用。为此，您可以使用以下代码:</p><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="08c3" class="jy jz hu ju b fv ka kb l kc kd">all_characters = RestClient.get('<a class="ae ke" href="http://www.swapi.co/api/people/'" rel="noopener ugc nofollow" target="_blank">http://www.swapi.co/api/people/'</a>)<br/>character_hash = JSON.parse(all_characters)</span></pre><p id="5a45" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在那个例子中，我们正在调用《星球大战》中的角色<a class="ae ke" href="https://hackernoon.com/tagged/api" rel="noopener ugc nofollow" target="_blank"> API </a>。我们使用rest client . get((<a class="ae ke" href="http://www.swapi.co/api/people/'" rel="noopener ugc nofollow" target="_blank">http://www.swapi.co/api/people/</a>’)来实现这一点，我们将其设置为等于变量all_characters。这将返回一个字符串，然后我们使用JSON.parse将它解析成一个可用的散列。</p><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="dc5b" class="jy jz hu ju b fv ka kb l kc kd">{"count"=&gt;87,</span><span id="1235" class="jy jz hu ju b fv kf kb l kc kd">"next"=&gt;"http://www.swapi.co/api/people/?page=2",</span><span id="e82c" class="jy jz hu ju b fv kf kb l kc kd">"previous"=&gt;nil,</span><span id="1738" class="jy jz hu ju b fv kf kb l kc kd">"results"=&gt;</span><span id="3e80" class="jy jz hu ju b fv kf kb l kc kd">[{"name"=&gt;"Luke Skywalker",</span><span id="c771" class="jy jz hu ju b fv kf kb l kc kd">"height"=&gt;"172",</span><span id="6447" class="jy jz hu ju b fv kf kb l kc kd">"mass"=&gt;"77",</span><span id="c269" class="jy jz hu ju b fv kf kb l kc kd">"hair_color"=&gt;"blond",</span><span id="c462" class="jy jz hu ju b fv kf kb l kc kd">"skin_color"=&gt;"fair",</span><span id="67e0" class="jy jz hu ju b fv kf kb l kc kd">"eye_color"=&gt;"blue",</span><span id="8ccd" class="jy jz hu ju b fv kf kb l kc kd">"birth_year"=&gt;"19BBY",</span><span id="4df5" class="jy jz hu ju b fv kf kb l kc kd">"gender"=&gt;"male",</span><span id="2adf" class="jy jz hu ju b fv kf kb l kc kd">"homeworld"=&gt;"http://www.swapi.co/api/planets/1/",</span><span id="fb41" class="jy jz hu ju b fv kf kb l kc kd">"films"=&gt;</span><span id="898d" class="jy jz hu ju b fv kf kb l kc kd">["http://www.swapi.co/api/films/2/",</span><span id="9e93" class="jy jz hu ju b fv kf kb l kc kd">"http://www.swapi.co/api/films/6/",</span><span id="6f36" class="jy jz hu ju b fv kf kb l kc kd">"http://www.swapi.co/api/films/3/",</span><span id="78d2" class="jy jz hu ju b fv kf kb l kc kd">"http://www.swapi.co/api/films/1/",</span><span id="434b" class="jy jz hu ju b fv kf kb l kc kd">"http://www.swapi.co/api/films/7/"],</span><span id="41ef" class="jy jz hu ju b fv kf kb l kc kd">"species"=&gt;["http://www.swapi.co/api/species/1/"],</span><span id="c9c7" class="jy jz hu ju b fv kf kb l kc kd">"vehicles"=&gt;["http://www.swapi.co/api/vehicles/14/", "http://www.swapi.co/api/vehicles/30/"],</span><span id="5f2f" class="jy jz hu ju b fv kf kb l kc kd">"starships"=&gt;["http://www.swapi.co/api/starships/12/", "http://www.swapi.co/api/starships/22/"],</span><span id="1d35" class="jy jz hu ju b fv kf kb l kc kd">"created"=&gt;"2014-12-09T13:50:51.644000Z",</span><span id="526c" class="jy jz hu ju b fv kf kb l kc kd">"edited"=&gt;"2014-12-20T21:17:56.891000Z",</span><span id="fe1f" class="jy jz hu ju b fv kf kb l kc kd">"url"=&gt;"http://www.swapi.co/api/people/1/"},</span><span id="1560" class="jy jz hu ju b fv kf kb l kc kd">{"name"=&gt;"C-3PO",</span><span id="6fc2" class="jy jz hu ju b fv kf kb l kc kd">"height"=&gt;"167",</span><span id="8a8f" class="jy jz hu ju b fv kf kb l kc kd">"mass"=&gt;"75",</span><span id="b9a9" class="jy jz hu ju b fv kf kb l kc kd">"hair_color"=&gt;"n/a",</span><span id="5869" class="jy jz hu ju b fv kf kb l kc kd">"skin_color"=&gt;"gold",</span><span id="996c" class="jy jz hu ju b fv kf kb l kc kd">"eye_color"=&gt;"yellow",</span><span id="5498" class="jy jz hu ju b fv kf kb l kc kd">"birth_year"=&gt;"112BBY",</span><span id="a123" class="jy jz hu ju b fv kf kb l kc kd">"gender"=&gt;"n/a",</span><span id="0d81" class="jy jz hu ju b fv kf kb l kc kd">"homeworld"=&gt;"http://www.swapi.co/api/planets/1/",</span><span id="2072" class="jy jz hu ju b fv kf kb l kc kd">"films"=&gt;</span></pre><p id="24f1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我只包括了输出的前几行，但基本上它是一个散列，每个主要字符都有不同的信息。需要注意的一件重要事情是，即使我们提取了整个字符API，每个<a class="ae ke" href="https://hackernoon.com/tagged/page" rel="noopener ugc nofollow" target="_blank">页面</a>也只显示了大约10个字符。换句话说，为了查看/检查所有角色的信息，你必须遍历多个页面。</p><figure class="jp jq jr js fq kg"><div class="bz el l di"><div class="kh ki l"/></div></figure><p id="5dfb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们如何做到这一点？如果您查看character_hash，您会注意到其中一个键“next”显示下一页的URL是什么。如果我们可以设置URL，让RestClient拉下一页，我们将能够循环(提示)每个页面，直到我们找到我们想要的。</p><p id="431f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">出于我们实验室的目的，我们希望我们的方法接受一个字符的参数，并遍历散列来查找该字符，并返回该字符所在的电影的URL数组。结果代码是这样的:</p><pre class="jp jq jr js fq jt ju jv jw aw jx dt"><span id="3ab9" class="jy jz hu ju b fv ka kb l kc kd">def get_character_movies_from_api(character)<br/><br/>  all_characters = RestClient.get('<a class="ae ke" href="http://www.swapi.co/api/people/'" rel="noopener ugc nofollow" target="_blank">http://www.swapi.co/api/people/'</a>)<br/>  character_hash = JSON.parse(all_characters)</span><span id="4249" class="jy jz hu ju b fv kf kb l kc kd">while character_hash<br/>    film_urls = character_hash["results"].find do |hash|<br/>      hash["name"].downcase == character<br/>    end<br/>    if film_urls<br/>      return film_urls["films"].map do |film|<br/>        JSON.parse(RestClient.get(film))<br/>      end<br/>    end<br/>    character_hash = character_hash["next"] ? JSON.parse(RestClient.get(character_hash["next"])) : nil<br/>  end<br/>end</span></pre><p id="696f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们实现了一个“while”循环，当character_hash不为false或nil时，它将继续运行这个块。它调用#find方法来查找参数中传递的字符。如果找到了这个字符，它就获取得到的数组，并对其进行迭代以获得另一个电影数组。</p><p id="47ab" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一旦找到了字符，并对结果数组进行迭代，该方法就完成了。但是，如果在第一页找不到该字符，我们需要转到下一页。这就是下一行代码发挥作用的地方。如果character_hash中的“next”键有一个URL，那么我们解析这个URL来获得下一页的hash，并重复这个循环。如果“next”键的值是nil，那么character_hash被设置为nil，while循环被中断。</p><figure class="jp jq jr js fq kg"><div class="bz el l di"><div class="kj ki l"/></div></figure><figure class="jp jq jr js fq kg"><div class="bz el l di"><div class="kk ki l"/></div></figure></div></div>    
</body>
</html>