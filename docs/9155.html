<html>
<head>
<title>Five data models for sharding and which is right</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于分片的五种数据模型，哪一种是正确的</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/five-data-models-for-sharding-and-which-is-right-f5c3fa480b00?source=collection_archive---------14-----------------------#2017-12-28">https://medium.com/hackernoon/five-data-models-for-sharding-and-which-is-right-f5c3fa480b00?source=collection_archive---------14-----------------------#2017-12-28</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/8b71169a6f870473d8a3dee663f48db3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*ofDk2ypl4T4CIvQv9RSWCQ.png"/></div></figure><p id="6d48" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">当谈到<a class="ae jw" href="https://www.citusdata.com/product/" rel="noopener ugc nofollow" target="_blank">扩展您的数据库</a>时，存在挑战，但好消息是您有选择。当然，最简单的选择是扩展您的硬件。当你达到扩展的上限时，你有更多的选择:<a class="ae jw" href="http://www.craigkerstiens.com/2012/11/30/sharding-your-database/" rel="noopener ugc nofollow" target="_blank">分片</a>，删除你认为在<a class="ae jw" href="https://hackernoon.com/tagged/future" rel="noopener ugc nofollow" target="_blank">未来</a>可能不需要的数据，或者试图用<a class="ae jw" href="https://martinfowler.com/microservices/" rel="noopener ugc nofollow" target="_blank">微服务</a>来缩小问题。</p><p id="0b47" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如果你负担得起，删除部分数据是很简单的。关于分片，有许多方法，哪种方法是正确的取决于许多因素。在这里，我们将回顾对五种分片方法的调查，并探究是什么因素引导您采用每种方法。</p><h1 id="6419" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">客户或租户分片</h1><p id="c835" class="pw-post-body-paragraph iy iz hu ja b jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv hn dt translated">SaaS应用程序通常服务于许多客户(称为“租户”)，这就是为什么我们经常将这些应用程序称为“<a class="ae jw" href="https://www.citusdata.com/blog/2016/08/10/sharding-for-a-multi-tenant-app-with-postgres/" rel="noopener ugc nofollow" target="_blank">多租户应用程序</a>”如果你是一家SaaS企业，通常情况下，一个客户的数据不会与其他客户的数据发生交互。这与社交<a class="ae jw" href="https://hackernoon.com/tagged/network" rel="noopener ugc nofollow" target="_blank">网络</a>截然不同，后者在不同用户生成的数据之间有很多相互依赖关系。</p><p id="361a" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">对于多租户的SaaS应用程序，数据通常是事务性的。事实证明，付费用户不太喜欢你在这个过程中丢失他们的一些数据。由于许多此类事务性、多租户SaaS应用程序(比如:CRM软件、营销运营、web分析)的性质，您需要强有力的保证，即当数据保存到数据库中时，数据将保留在那里。并且您的客户希望您实施引用完整性。</p><figure class="lb lc ld le fq iv fe ff paragraph-image"><div class="fe ff la"><img src="../Images/c94954503e6afcdb0da94dcab4dda047.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*LaXH-hqQ27_dUcUAuxgflQ.png"/></div></figure><p id="8bfa" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">关于多租户应用程序的另一个有趣的事情是，它们的数据模型会随着时间的推移而发展，以提供越来越多的功能。与受益于网络效应增长的消费者应用程序不同，B2B应用程序通过为客户添加新的(理想的粘性)功能来增长。通常情况下，新特性意味着新的数据模型。最终结果是10到100个表，有时有复杂的连接。如果这听起来像你，那么按租户分片是一种安全的(也是推荐的)方法。</p><h1 id="410a" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">地理分片</h1><p id="37be" class="pw-post-body-paragraph iy iz hu ja b jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv hn dt translated">近几年来，另一类最受关注的应用是基于地理位置的应用:<em class="lf">感谢iPhone </em>。无论是Lyft、Instacart还是Postmates，这些应用都与位置有着重要的联系。你不会住在阿拉巴马州，从加州订购食品杂货。如果你要订购一辆从加州到阿拉巴马州的Lyft皮卡，你将会等上很长一段时间。</p><figure class="lb lc ld le fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="fe ff lg"><img src="../Images/03a33c3d6752d5f1fafd1ae4d2c28898.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*biKRBTzpWFNQLY90XTSxVQ.png"/></div></div></figure><p id="7112" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">但是，仅仅因为你有一个带有地理倾向的应用，并不意味着地理就是正确的碎片键。按区域进行分片的关键在于，特定地理区域内的数据不会与另一个地理区域发生交互。并非所有有地理数据的应用程序都意味着地理分片方法是有意义的。一些需要大量跨地理边界交互数据的应用程序(如Foursquare)不太适合按地理进行分片。</p><p id="489d" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">与上面的多租户应用程序类似，依赖于地理位置的应用程序的数据模型往往更加进化。我的意思是，对于依赖于位置的应用程序，你有许多相互之间有外键依赖的表，并且经常在它们的查询中相互连接。如果您能够将查询限制在一个地理位置，并且数据很少跨越地理边界，那么按地理位置分片可能是一个不错的方法。</p><h1 id="6898" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">按实体id分片(随机分布的数据)</h1><p id="daf2" class="pw-post-body-paragraph iy iz hu ja b jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv hn dt translated">我们的下一个数据模型可以适用于许多不同的数据库系统，这是因为它在你的数据模型之间没有很强的相互依赖性(读:没有连接)。由于不需要连接和<a class="ae jw" href="https://brandur.org/acid" rel="noopener ugc nofollow" target="_blank">经常性事务</a>(与关系数据库相同),有一系列数据库可能有帮助，也可能没有帮助。您正在解决的问题是，单个节点(或核心)的数据太多，无法快速处理。</p><p id="0444" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">当按实体id分片时，我们希望尽可能均匀地分布数据，以最大化系统内的<a class="ae jw" href="https://docs.citusdata.com/en/latest/tutorials/real-time-analytics-tutorial.html" rel="noopener ugc nofollow" target="_blank">并行性</a>。对于一个完全均匀的分布，你可以通过一个随机的id进行分片，本质上是循环数据。现实生活有点混乱。虽然您可能没有50个紧密耦合的表，但是有2-3个您想要连接的表是很常见的。我们认为实体id模型最有意义的地方是web分析用例。</p><p id="bbb6" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如果您的查询没有任何连接，那么使用uuid来分割您的数据会很有意义。如果有一些基本的连接可能与一个会话有关，那么用同一个shard键对相关的表进行分片可能是理想的。跨表共享一个shard键允许您<a class="ae jw" href="https://www.citusdata.com/blog/2016/12/22/scaling_out_sql_with-colocation/" rel="noopener ugc nofollow" target="_blank">协同定位数据</a>进行更复杂的报告，同时仍然提供相当均匀的并行分布。</p><h1 id="9989" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">分割图表</h1><p id="1267" class="pw-post-body-paragraph iy iz hu ja b jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv hn dt translated">现在我们来看也许是最独特的方法。在查看图形数据模型时，您会看到不同的缩放方法，以及对分片容易程度的不同看法。图表模式在流行的B2C应用中最为常见，如T2的脸书和Instagram，这些应用利用了社交图表。在这里，数据之间的边之间的关系可能就像数据本身一样是查询的关键。在这一类别中，<a class="ae jw" href="https://www.graphenedb.com/" rel="noopener ugc nofollow" target="_blank">图形数据库</a>开始独立成为社交图形和应用程序的有效解决方案，这些应用程序与数据之间有着非常高的联系。如果你想更深入地了解，内部数据库TAO上的<a class="ae jw" href="https://www.usenix.org/system/files/conference/atc13/atc13-bronson.pdf" rel="noopener ugc nofollow" target="_blank">文件</a>是一份很好的读物。</p><p id="f73f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">对于图形数据库，有两个关键项，即作为类型化节点的<em class="lf">对象</em>和指定到它们的连接的<em class="lf">关联</em>。对于对象，一个例子可能是Craig在Citus登记；关联将与丹尼尔，谁订阅克雷格的更新。对象通常是可以重复出现的东西，而关联捕捉诸如*谁*(谁订阅了更新，谁喜欢等等。)</p><p id="e982" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在这种模式下，数据通常以几种不同的形式复制。然后，应用程序负责映射到对获取数据最有用的表单。结果是，您有以不同方式分片的数据的多个副本，最终数据通常是一致的，然后您必须将一些应用程序逻辑映射到您的分片策略。对于脸书和Reddit这样的应用来说，除了采取这种方式别无选择，但这确实要付出一些代价。</p><h1 id="51fc" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">时间划分</h1><p id="b797" class="pw-post-body-paragraph iy iz hu ja b jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv hn dt translated">切分的最后一种方法是某些应用自然倾向的方法。如果您正在处理以时间为主轴的数据，那么按天、周、小时、月进行分区是正确的。在查看某种形式的事件数据时，时间划分非常常见。事件数据可以包括广告的点击/展示，它可以是网络事件数据，或者来自系统监控角度的数据。事实证明，大多数数据都有某种类型的时间叙述，但是按时间划分是正确的选择吗？</p><figure class="lb lc ld le fq iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/8b71169a6f870473d8a3dee663f48db3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*ofDk2ypl4T4CIvQv9RSWCQ.png"/></div></figure><p id="cb6d" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">在以下情况下，您可能希望使用基于时间的分区方法:</p><p id="4706" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">1.您可以通过以时间为轴对数据进行分析来生成报告/警报。<br/> 2。您定期删除数据，以便对其进行有限的保留。</p><p id="891b" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">时间划分确实有意义的一个例子是，当你是一个只报告30天数据的广告网络时。另一个例子:您正在监控网络日志，并且只查看最近7天的日志。当你混合了最近(过去7天)的数据和历史数据，比如一年前的数据时，困难就来了。</p><h1 id="3aaf" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dt translated">正确的分片方法取决于您的应用</h1><p id="861b" class="pw-post-body-paragraph iy iz hu ja b jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv hn dt translated">与许多关于架构和基础设施的决策一样，必须做出权衡，最好将方法与您的应用程序的需求(以及您的客户的需求)相匹配！)在分片的情况下，将分片的类型与应用程序的需求相匹配是能够有效伸缩的关键。当您将您的数据模型和用例与正确的分片类型相匹配时，许多困难的问题，如对应用程序重写的大量投资、确保数据一致性以及在问题变得更糟6个月后重新审视您的问题，都可以逐渐消失。</p><figure class="lb lc ld le fq iv"><div class="bz el l di"><div class="ll lm l"/></div></figure></div></div>    
</body>
</html>