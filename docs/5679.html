<html>
<head>
<title>Costs of a Real World Ethereum Contract</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">真实世界以太坊合约的成本</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/costs-of-a-real-world-ethereum-contract-2033511b3214?source=collection_archive---------1-----------------------#2017-08-10">https://medium.com/hackernoon/costs-of-a-real-world-ethereum-contract-2033511b3214?source=collection_archive---------1-----------------------#2017-08-10</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="3b0c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> <em class="jp">天然气价格PSA</em></strong><em class="jp">(2017–08–23):撰写本文时的天然气价格中值在20 Gwei的范围内，并将继续如此。这远远大于在</em><a class="ae jq" href="http://ethgasstation.info/" rel="noopener ugc nofollow" target="_blank"><em class="jp">eth asstation</em></a><em class="jp">上发现的典型平均值和安全低(分别为4和0.5 Gwei)。中位数如此之高，是因为许多钱包里都有糟糕的汽油价格违约。我</em> <strong class="it hv"> <em class="jp">强烈建议</em> </strong> <em class="jp">使用加油站的平均气价或更低的气价，以避免支付高额费用，并帮助降低气价的市场价格。</em></p><p id="f860" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我之前讨论过<a class="ae jq" href="https://hackernoon.com/ether-purchase-power-df40a38c5a2f" rel="noopener ugc nofollow" target="_blank">计算以太坊智能合约</a>的成本，方法是查看称为<a class="ae jq" href="https://docs.google.com/spreadsheets/d/1n6mRqkBz3iWcOlRem_mO09GtSKEKrAsfO7Frgx18pNU/edit?usp=sharing" rel="noopener ugc nofollow" target="_blank">操作码</a>的低级操作，以及运行这些操作码的市场价格(天然气价格)。给出的例子很简单，但有点做作，所以我决定采用上周的分析，并将它从头到尾应用到一个实际的智能合同中。</p><p id="7238" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我正在开发一系列免费开放使用的简单智能合同。我们将使用这个系列的第一个— <a class="ae jq" href="https://github.com/djrtwo/simple-contracts/blob/0a30f43929dcf6964b833348b62544977078cddb/contracts/escrow.sol" rel="noopener ugc nofollow" target="_blank">代管</a>——并深入探讨与之相关的成本。</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div class="fe ff jr"><img src="../Images/83a4c6d59752b4a42db160134d718ac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*8R2pxMXE_jl7NwYVFJRg4g.png"/></div></figure><h1 id="f535" class="jz ka hu bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">合同</h1><p id="26b4" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo hn dt translated">合同的快速背景分析。该合同涉及三方——发送方、接收方和商定的仲裁方。发送方<a class="ae jq" href="https://github.com/djrtwo/simple-contracts/blob/0a30f43929dcf6964b833348b62544977078cddb/contracts/escrow.sol#L22" rel="noopener ugc nofollow" target="_blank">用一些以太网初始化</a>合同，并指定接收方、仲裁人和截止日期。如果双方中的任何一方(发送方、接收方或仲裁方)通过<code class="eh lc ld le lf b"><a class="ae jq" href="https://github.com/djrtwo/simple-contracts/blob/0a30f43929dcf6964b833348b62544977078cddb/contracts/escrow.sol#L35" rel="noopener ugc nofollow" target="_blank">confirm</a></code>功能确认付款，资金将发放给接收方。如果在到期之前没有进行两次确认，那么发送者可以使托管协议无效，并通过<code class="eh lc ld le lf b"><a class="ae jq" href="https://github.com/djrtwo/simple-contracts/blob/0a30f43929dcf6964b833348b62544977078cddb/contracts/escrow.sol#L47" rel="noopener ugc nofollow" target="_blank">void</a></code>函数调用取回他们的资金。</p><h1 id="39af" class="jz ka hu bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">成本</h1><p id="1ed4" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo hn dt translated">我在Rinkeby testnet上部署了这个契约的一个实例，可以在<a class="ae jq" href="https://rinkeby.etherscan.io/address/0x5c7d041b04ac71bd4d6cafa8982586509ecd795f" rel="noopener ugc nofollow" target="_blank"> Etherscan </a>上看到。该合同有三个相关的交易，都使用20 Gwei的气价，这是在<a class="ae jq" href="http://ethgasstation.info/" rel="noopener ugc nofollow" target="_blank"> Eth加油站</a>看到的中间价格。</p><ul class=""><li id="bff2" class="lg lh hu it b iu iv iy iz jc li jg lj jk lk jo ll lm ln lo dt translated"><a class="ae jq" href="https://rinkeby.etherscan.io/tx/0xebd01c6f11b406ee3057c0f8085347ba2c3b96682d0b2f768ef781c5390c67a9" rel="noopener ugc nofollow" target="_blank">第一笔交易</a>初始化合约，并在合约中存入0.5乙醚。交易成本:0 <strong class="it hv">。</strong> 01072934乙醚(300美元/乙醚，3.21美元)</li><li id="d348" class="lg lh hu it b iu lp iy lq jc lr jg ls jk lt jo ll lm ln lo dt translated">在<a class="ae jq" href="https://rinkeby.etherscan.io/tx/0x6fe8db7d2831a3c096041fd2f00ce4917cf2467a627e1a2f56b93be6105844c6" rel="noopener ugc nofollow" target="_blank">第二笔交易</a>中，发送方呼叫<code class="eh lc ld le lf b">confirm</code>。交易成本:0 <strong class="it hv">。</strong> 00093492乙醚(300美元/乙醚，0.28美元)</li><li id="7435" class="lg lh hu it b iu lp iy lq jc lr jg ls jk lt jo ll lm ln lo dt translated">在<a class="ae jq" href="https://rinkeby.etherscan.io/tx/0x74f918d059132ff9c1fa11ad4f49d2be9b2686528a35e526cb2e1dc7acef4935" rel="noopener ugc nofollow" target="_blank">第三笔交易</a>中，仲裁员调用<code class="eh lc ld le lf b">confirm</code>，资金被分配给接收方。交易成本:0 <strong class="it hv">。</strong> 00164754乙醚(300美元/乙醚，0.49美元)</li></ul><p id="ca75" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果我愿意等待大约20分钟来处理我的交易，我可以以0.5 Gwei的价格在主网上获得这些交易(根据<a class="ae jq" href="http://ethgasstation.info/" rel="noopener ugc nofollow" target="_blank"> Eth加油站</a>的“安全低”)。在这种天然气价格下，部署合同的成本约为0.07美元，其他两项交易的成本为0.01美元或更少，价格为300美元/ETH。</p><p id="3fff" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">考虑到这是一个固定成本，在这个托管合同中持有任何数量的乙醚，这些费用似乎是合理的。您可能需要向仲裁人支付一定金额才能参与，但仲裁人的大量成本和风险(安全地持有和分散资金)已经消除。你将不得不单独为仲裁——决定——而不是所有的簿记付费。</p><p id="6f74" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你只是想要一个真实世界例子的直接成本，这是一个很好的地方。文章的其余部分深入探讨了这些成本的确切来源。</p><p id="8b8c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">继续读下去，后果自负！</em></p><h1 id="adfe" class="jz ka hu bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">部署成本</h1><p id="ecb6" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo hn dt translated">在目前用于智能合约的主要编程语言<a class="ae jq" href="http://solidity.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> solidity </a>中，合约通过构造函数初始化。您可以在<a class="ae jq" href="https://github.com/djrtwo/simple-contracts/blob/0a30f43929dcf6964b833348b62544977078cddb/contracts/escrow.sol#L22" rel="noopener ugc nofollow" target="_blank">托管构造函数</a>中看到，我们传入了4条数据——所涉及的三方的地址和一个未来合同可能失效的时间戳。</p><p id="9e00" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该契约的<a class="ae jq" href="https://rinkeby.etherscan.io/tx/0xebd01c6f11b406ee3057c0f8085347ba2c3b96682d0b2f768ef781c5390c67a9" rel="noopener ugc nofollow" target="_blank">初始化事务</a>是迄今为止开销最大的操作。它需要536467 gas来部署契约和执行构造器代码。在每种气体20 Gwei的情况下，部署合同成本为0 <strong class="it hv">。</strong> 01072934乙醚，按目前300美元/乙醚的汇率，约合3.21美元。</p><h2 id="d87f" class="lu ka hu bd kb lv lw lx kf ly lz ma kj jc mb mc kn jg md me kr jk mf mg kv mh dt translated">构造函数</h2><p id="7eaa" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo hn dt translated">为了进一步检查初始化，让我们看一下事务的<a class="ae jq" href="https://rinkeby.etherscan.io/vmtrace?txhash=0xebd01c6f11b406ee3057c0f8085347ba2c3b96682d0b2f768ef781c5390c67a9" rel="noopener ugc nofollow" target="_blank"> VM跟踪</a>。这显示了EVM在托管合同的构造函数中执行的操作码。这占了所用气体的113539。开销最大的操作是许多存储，用于存储参与者的地址、过期时间戳，以及初始化参与者数组和确认映射的一些内存位置。仅这些储气库操作就消耗了110000份天然气，约占建造商所用天然气的97%。其余的操作码用于检查时间戳的有效性和获取存储的所有内容的业务逻辑。</p><h2 id="27f9" class="lu ka hu bd kb lv lw lx kf ly lz ma kj jc mb mc kn jg md me kr jk mf mg kv mh dt translated">其余的呢？</h2><p id="5c72" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo hn dt translated">施工方仅占本次交易中使用的所有天然气的20%左右。剩下的80%都花在哪里了？</p><p id="9d66" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在该交易中，我们将允许使用的最大气体(“气体限制”)指定为1000000气体。EVM从这个数字开始，并随着每次操作倒计时，以确保有足够的剩余气体。如果EVM在代码执行过程中遇到零汽油，则交易失败，更改被撤消，与汽油相关的费用仍然支付给矿工。</p><p id="f763" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们可以在<a class="ae jq" href="https://rinkeby.etherscan.io/vmtrace?txhash=0xebd01c6f11b406ee3057c0f8085347ba2c3b96682d0b2f768ef781c5390c67a9" rel="noopener ugc nofollow" target="_blank"> VM跟踪</a>中看到，我们在剩余837872 gas处开始执行构造函数。这意味着当我们到达构造器时，162128 ( <code class="eh lc ld le lf b">1000000-837872</code>)或者总气体的大约30%已经被使用。</p><p id="43a9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们开始执行代码之前，什么东西花费了这么多？第一，有21000气基线交易费。这笔费用在<a class="ae jq" href="http://yellowpaper.io/" rel="noopener ugc nofollow" target="_blank">黄皮书</a>中被称为G <em class="jp">交易</em>，在以太坊网络的所有交易中支付。接下来是额外的32000 gas (G <em class="jp"> create </em>支付，因为这是一个合同创建交易。我们有53000个气体——在构造器之前还有109128个气体没有计算。这些气体的大部分用于支付在<a class="ae jq" href="https://rinkeby.etherscan.io/tx/0xebd01c6f11b406ee3057c0f8085347ba2c3b96682d0b2f768ef781c5390c67a9" rel="noopener ugc nofollow" target="_blank">以太网扫描</a>的“输入数据”字段中看到的交易数据的大小。这是3556个十六进制“半字节”或1778个字节的数据。如<a class="ae jq" href="http://yellowpaper.io/" rel="noopener ugc nofollow" target="_blank">黄皮书</a>第20页所示，G <em class="jp"> txdatazero </em>成本为4 gas/字节，G<em class="jp">txdata zero</em>成本为68 gas/字节。我们可以用下面的<a class="ae jq" href="https://www.wolframalpha.com/input/?i=(x+*+68)+%2B+(1778+-+x)+*+4+%3D+109128" rel="noopener ugc nofollow" target="_blank">等式</a> — <code class="eh lc ld le lf b">x * 68 + (1778-x) * 4 = 109128</code>来计算非零字节和零字节的个数，其中<code class="eh lc ld le lf b">x</code>是非零字节的个数，<code class="eh lc ld le lf b">1778-x</code>是零字节的个数。求解<code class="eh lc ld le lf b">x</code>得到<code class="eh lc ld le lf b">x = 1594</code>，所以有1594个非零字节和184个零字节。作为检查，我写了一个<a class="ae jq" href="https://gist.github.com/djrtwo/4b80f6dfebc5575e66508edd95a3b0c2" rel="noopener ugc nofollow" target="_blank"> python脚本</a>来计算txdata中的零和非零字节。这些数字加起来。</p><h2 id="3de1" class="lu ka hu bd kb lv lw lx kf ly lz ma kj jc mb mc kn jg md me kr jk mf mg kv mh dt translated">剩下的50%</h2><p id="1f76" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo hn dt translated">这仍然留下大约50%的气体在构造者之后<em class="jp">被使用。我们的汽油限额从1000000开始。构造器代码的最后一条指令留给我们724333可用气体。该交易总共使用了536467天然气，因此在整个交易结束时可用天然气为(<code class="eh lc ld le lf b">1000000–536467</code> ) 463533天然气。构造器代码<em class="jp">结束时的可用数量减去</em>交易结束时的可用数量<em class="jp">等于</em>构造器代码结束后的用气量— ( <code class="eh lc ld le lf b">72433–463533</code> ) 260800气。</em></p><p id="7b03" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此时，我们已经支付了交易数据和合同初始化的费用，但是对合同的<a class="ae jq" href="https://hackernoon.com/tagged/future" rel="noopener ugc nofollow" target="_blank">未来</a>调用怎么办？未来的调用将必须执行代码，因此代码必须在契约本身的状态中处于链上状态。黄皮书<a class="ae jq" href="http://yellowpaper.io/" rel="noopener ugc nofollow" target="_blank">的第9页讨论了为向</a><a class="ae jq" href="https://hackernoon.com/tagged/blockchain" rel="noopener ugc nofollow" target="_blank">区块链</a>状态添加字节码而支付的“代码押金”的成本。<code class="eh lc ld le lf b">cost = G<em class="jp">codedeposit</em> * |o|</code>其中<code class="eh lc ld le lf b">o</code>是“运行时字节码”，而<code class="eh lc ld le lf b">G<em class="jp">codedeposit</em></code>是200 gas/字节。运行时字节码是在事务中发送的原始字节码，但是去掉了构造函数和通用初始化代码。因为这个初始化代码只在初始化时执行，所以把它提取出来是为了省钱和节省节点操作符的存储空间。</p><p id="73c0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Solidity编译器输出字节码和运行时字节码。<a class="ae jq" href="https://ethereum.github.io/browser-solidity" rel="noopener ugc nofollow" target="_blank">浏览器内solidity编辑器/编译器Remix </a>也在“合同详情”下给你展示了这两个值。混音对于一些快速信息和健全检查来说是很棒的。</p><p id="904c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">从编译器输出中，我看到字节码的大小是1650字节，而运行时字节码的大小是1304字节。这意味着346字节(<code class="eh lc ld le lf b">1650–1304</code>)是初始化代码。因此，存放在运行时字节码上的代码成本是<code class="eh lc ld le lf b">1304 * 200 = 260800 gas</code>,这正是我们预期的金额。</p><p id="9ac7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">同样，契约初始化事务是迄今为止与托管契约相关的最昂贵的操作，并且可能是大多数契约的操作。我们发送一个充满字节码的事务，运行初始化内存中多个位置的构造器代码，然后为我们永久留在区块链上的所有代码付费。增加区块链(全球分布和复制的数据库)的大小是并且应该是昂贵的。</p><h1 id="8146" class="jz ka hu bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">要确认的成本</h1><p id="d0ec" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo hn dt translated"><strong class="it hv">确认#1 </strong></p><p id="8d47" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">托管合同上的<a class="ae jq" href="https://rinkeby.etherscan.io/tx/0x6fe8db7d2831a3c096041fd2f00ce4917cf2467a627e1a2f56b93be6105844c6" rel="noopener ugc nofollow" target="_blank">第一次确认</a>只是更新状态以显示用户已确认。这笔钱仍然持有，直到第二次确认才释放。</p><p id="2f93" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该交易的气体限制为90000气体，使用了46746气体。代码执行从68728 gas开始，到43254 gas结束，所以运行代码使用<code class="eh lc ld le lf b">68728 — 43254 = 25474</code> gas。如果你看一下<a class="ae jq" href="https://rinkeby.etherscan.io/vmtrace?txhash=0x6fe8db7d2831a3c096041fd2f00ce4917cf2467a627e1a2f56b93be6105844c6" rel="noopener ugc nofollow" target="_blank">的痕迹</a>，有一家店的汽油价格是20000英镑。这是为了存储用户发送确认的事实。这是代码执行成本的主要部分。下一个最昂贵的操作是大量的SLOADs，从内存中加载单词，每个花费200 gas。</p><p id="8f8b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因为代码执行从最初的90000气体限制的68728开始，所以在此之前使用了<code class="eh lc ld le lf b">90000 – 68728 = 21272 gas</code>。21000汽油是任何交易的基本成本，因此还有剩余的272汽油需要考虑。请记住，非零事务数据成本为68 gas/字节。这个事务有4个字节的数据开销<code class="eh lc ld le lf b">4 * 68 = 272 gas</code>。</p><p id="821d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">21272预执行气体<em class="jp">加上</em> 25474执行气体<em class="jp">等于</em> 46746气体，这是总数——所有气体都考虑在内。</p><p id="47b8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">确认#2 </strong></p><p id="58d4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">托管合同上的<a class="ae jq" href="https://rinkeby.etherscan.io/tx/0x74f918d059132ff9c1fa11ad4f49d2be9b2686528a35e526cb2e1dc7acef4935" rel="noopener ugc nofollow" target="_blank">第二次确认</a>既更新状态以显示用户已确认，又将资金发放给接收方。我们预计这次交易会比第一次确认要贵一点，因为它做的是第一次确认所做的事情，再加上发送以太网。</p><p id="ed6b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该交易的气体限制为90000气体，使用了82377气体。<a class="ae jq" href="https://rinkeby.etherscan.io/vmtrace?txhash=0x74f918d059132ff9c1fa11ad4f49d2be9b2686528a35e526cb2e1dc7acef4935" rel="noopener ugc nofollow" target="_blank">代码执行</a>从68728 gas开始，到7623 gas结束，所以运行代码使用<code class="eh lc ld le lf b">68728 – 7623 = 61105 gas</code>。代码执行开始于与第一次确认完全相同的gas计数，因此在代码执行之前使用了21272 gas，考虑了21000基本事务成本加上4字节的txdata。代码执行中使用的数量，61105气体，<em class="jp">加上</em>代码执行前使用的数量，21272气体，<em class="jp">等于</em> 82377气体——所有气体都计算在内。</p><p id="7833" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们更深入地看看<a class="ae jq" href="https://rinkeby.etherscan.io/vmtrace?txhash=0x74f918d059132ff9c1fa11ad4f49d2be9b2686528a35e526cb2e1dc7acef4935" rel="noopener ugc nofollow" target="_blank">虚拟机痕迹</a>。像前面的事务一样，有一个存储该用户确认的事实的存储库。剩余的41005 gas大部分用于名为CALL的操作码。这次行动使用了32400气体。</p><p id="7b6a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在跟踪中，看起来39981 gas被用于一个调用操作，但是这有点误导。这实际上只是分配给呼叫操作的气体量，而不是总消耗量。Gas被分配给调用操作，而不是简单地花费，因为如果接收地址是一个约定，调用可以执行代码，而运行代码所需的确切gas量在执行之前是不知道的。我们可以查看调用前后的操作来计算实际使用了多少。调用前的操作在40064 gas结束，调用后的操作在7664 gas开始。所以调用操作夹在uses(40064–7664)<code class="eh lc ld le lf b">40064 – 7664 = 32400 gas</code>之间。</p><p id="2d84" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们看一下<a class="ae jq" href="http://yellowpaper.io/" rel="noopener ugc nofollow" target="_blank">黄皮书</a>的第20页和第29页，以了解呼叫操作的成本。执行通话无论如何都要花700气(<code class="eh lc ld le lf b">G<em class="jp">call</em></code> ) <em class="jp"> </em>。使用CALL传输一个非零量的乙醚需要额外花费9000气(<code class="eh lc ld le lf b">G<em class="jp">callvalue</em></code>)。一个给区块链州增加新账户的呼叫操作需要额外花费25000燃气(<code class="eh lc ld le lf b">G<em class="jp">newaccount</em></code>)。在这种情况下，调用确实向区块链添加了一个新帐户，因为接收方地址以前没有与之相关联的值或合同。具有非零价值转移的调用操作也获得2300汽油(<code class="eh lc ld le lf b">G<em class="jp">callstipend</em></code>)的津贴，该津贴从与操作相关的其他成本中减去<em class="jp">。所以总的来说</em></p><pre class="js jt ju jv fq mi lf mj mk aw ml dt"><span id="8ca6" class="lu ka hu lf b fv mm mn l mo mp">700 (G<em class="jp">call</em>) + 9000 (Gcallvalue) + 25000 (G<em class="jp">newaccount</em>) - 2300 (G<em class="jp">callstipend</em>) = 32400 gas</span></pre><p id="1e47" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">呼叫气体被计算在内。</p><p id="2497" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">用于<code class="eh lc ld le lf b">G<em class="jp">newaccount</em></code>的昂贵的25000燃气有点让人吃惊。如果收款人以前是一个非空账户，我们的汽油费用会少得多。在进行天然气计算/估算时，根据当前状态，会有许多类似的复杂情况。</p><h1 id="5b01" class="jz ka hu bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">作废成本</h1><p id="41dd" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo hn dt translated">我将把计算和分析执行一个成功的<code class="eh lc ld le lf b"><a class="ae jq" href="https://github.com/djrtwo/simple-contracts/blob/0a30f43929dcf6964b833348b62544977078cddb/contracts/escrow.sol#L47" rel="noopener ugc nofollow" target="_blank">void</a></code>交易的成本留给读者。我们预计该操作的开销与第二次确认的开销类似，因为它通过调用操作进行了价值转移，但是它的开销应该会稍微小一些，因为它没有通过昂贵的存储更新确认的状态。</p><h1 id="1f3a" class="jz ka hu bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">进一步说明</h1><p id="4ebf" class="pw-post-body-paragraph ir is hu it b iu kx iw ix iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo hn dt translated">应该注意的是，本应该完全避免<code class="eh lc ld le lf b">confirm</code>中昂贵的调用操作。一个效果后直接发资金，其实是实打实的反模式。<a class="ae jq" href="https://solidity.readthedocs.io/en/develop/common-patterns.html#withdrawal-from-contracts" rel="noopener ugc nofollow" target="_blank">模式</a>是通过一个函数调用来更新状态，这个函数调用允许随后的撤销。在托管契约中，第二次确认应该将契约的状态更改为“已确认”，禁用对<code class="eh lc ld le lf b">void</code>的调用，并使接收者能够调用名为<code class="eh lc ld le lf b">withdraw</code>的新函数。这将避免与呼叫相关的意外费用或操作相关的问题。</p><p id="1c2f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该分析中的危险信号是，由于不知道将调用和执行什么样的帐户/代码，我们的运营可能会大幅增加汽油成本。这种未知会导致诸如<a class="ae jq" href="http://hackingdistributed.com/2016/07/13/reentrancy-woes/" rel="noopener ugc nofollow" target="_blank"> DAO重入错误</a>之类的错误。</p><p id="5fe2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">智能合约非常强大，但是，正如我们所看到的，可能非常复杂。围绕它们的语言、工具和最佳实践仍处于起步阶段。我敦促社区将大部分精力集中在构建底层工具和架构上，以确保我们能够创建正确且负担得起的智能合同。</p><p id="6827" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果我们要做这件事，那就好好做。</p><figure class="js jt ju jv fq jw"><div class="bz el l di"><div class="mq mr l"/></div></figure></div></div>    
</body>
</html>