<html>
<head>
<title>Silly R errors and the silly reasons I’m probably getting them</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">愚蠢的错误和我可能会犯的愚蠢的原因</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/silly-r-errors-and-the-silly-reasons-im-probably-getting-them-c6bd9ada59c?source=collection_archive---------9-----------------------#2017-10-08">https://medium.com/hackernoon/silly-r-errors-and-the-silly-reasons-im-probably-getting-them-c6bd9ada59c?source=collection_archive---------9-----------------------#2017-10-08</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="856b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们都喜欢认为，几年的经验意味着我们学到了一些东西:同样愚蠢的错误发生的次数减少了，当它们发生时，我们会在更短的时间内纠正它们。</p><p id="937c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">嗯，是的— <em class="jp">理想情况下。但是编码并不总是理想的，而且因为我通常在编码后立即调试，所以当我碰到这些事情时，我并不总是处于最佳状态。每当我的脚本崩溃时，我很容易陷入重新发明诊断轮的陷阱，因为我应该检查一些事情。</em></p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h2 id="5319" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated"><strong class="ak">命名空间问题</strong></h2><p id="60f2" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">使用<a class="ae kx" href="http://tidyverse.org/" rel="noopener ugc nofollow" target="_blank"> tidyverse </a>在很大程度上减少了这个列表。R的灵活但微妙的子集化语法意味着任何时候我在base R中，我都感觉我在调试DEFCON1。将这些句子换成容易记忆的动词，让普通任务变得更容易<em class="jp">和</em>更安全。</p><p id="ba7d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一个例外是每当我使用<code class="eh ky kz la lb b"><a class="ae kx" href="http://dplyr.tidyverse.org/reference/filter.html" rel="noopener ugc nofollow" target="_blank">filter</a></code>时，它给你一个数据框行的选择:</p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="fe ff lc"><img src="../Images/b06e76be3c71db2651bfd50e155a8c8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Q94X2iXPXOmcLh3eiIORWw.gif"/></div></div><figcaption class="lo lp fg fe ff lq lr bd b be z ek">“I’ll just filter this b — WHAAAA”</figcaption></figure><p id="1305" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我给我的专栏起的名字不好吗？忘记等号了吗？(那个应该也在这个名单上，BTW。)不:我根本不跑<code class="eh ky kz la lb b">dplyr::filter</code>。</p><p id="8fcc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果像我一样，您的<code class="eh ky kz la lb b">.RProfile</code>中有<code class="eh ky kz la lb b">library</code>语句，您会反常地在交互会话中运行<code class="eh ky kz la lb b">stats::filter</code>(统计数据显然是稍后加载的)。这导致了许多有趣的错误，表明输入了错误的变量或列名，但实际上只是运行了错误的函数。</p><p id="85fc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">简单但恼人的解决方法是，每当我在一个filter语句的几个邮政编码中遇到错误时，检查我是否显式地使用了<code class="eh ky kz la lb b">dplyr::filter</code>。</p><p id="9ab8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果我用RScript运行一个非交互式会话(比方说，在一个有作业队列的服务器上)，我指定<code class="eh ky kz la lb b">RScript --vanilla</code>来防止坏的概要文件开始起作用。但是大多数时候，我只是用类似<code class="eh ky kz la lb b">filter = dplyr::filter</code>的东西来遵循我的脚本的库声明——老实说，这感觉像是一个等待发生的愚蠢错误。</p><p id="404c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">还有其他一些有趣的例子:</p><ul class=""><li id="1d8b" class="ls lt hu it b iu iv iy iz jc lu jg lv jk lw jo lx ly lz ma dt translated"><code class="eh ky kz la lb b">MASS::select</code>与<code class="eh ky kz la lb b">dplyr::select</code>冲突</li><li id="9d3e" class="ls lt hu it b iu mb iy mc jc md jg me jk mf jo lx ly lz ma dt translated"><code class="eh ky kz la lb b">here::here</code>与<code class="eh ky kz la lb b">lubridate::here</code>冲突(已折旧但仍存在)</li></ul></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h2 id="8632" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated"><strong class="ak">失控错误</strong></h2><p id="3013" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">r的隐性多行语句，可以是福也可以是祸。每当我遇到一个似乎与它所在的行完全无关的错误时，我都会检查是否有更早的行在运行。</p><p id="b1e3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这通常发生在我修改管道或ggplot时——事实上，90%的探索性数据都是vis。我运行一个ggplot，返回去添加一个元素，忘记在末尾加一个+,然后奇怪为什么它都不运行。</p><p id="c043" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">另一种情况是字符串中缺少或放错了右引号。通常这种情况下，语法高亮会提示你，但是有时我们需要咖啡。</p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h2 id="b8b1" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">闭合误差</h2><p id="e469" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">这些错误包括:</p><p id="efa1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh ky kz la lb b">Evaluation error: invalid type (closure) for variable '***'</code></p><p id="f451" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh ky kz la lb b">Error in ***: object of type 'closure' is not subsettable</code></p><p id="e9fb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它们通常意味着当R期望另一种对象时，它已经被赋予了一个闭包(作为对象的函数)，反之亦然。需要检查两件明显的事情:</p><ul class=""><li id="453c" class="ls lt hu it b iu iv iy iz jc lu jg lv jk lw jo lx ly lz ma dt translated"><strong class="it hv">函数调用末尾有(括号)。使用<code class="eh ky kz la lb b">magrittr</code>管道时，很容易忘记它们(虽然我尽量不去忘记)，但是一般来说，如果你忽略它们，你是在操作函数本身(或者更确切地说，是闭包)，而不是调用它(这可能是你的本意)。</strong></li><li id="6807" class="ls lt hu it b iu mb iy mc jc md jg me jk mf jo lx ly lz ma dt translated"><strong class="it hv">您指定的变量或数据框列实际上已定义。</strong>如果不是，并且——和我一样——你使用的变量/列名(比如，<code class="eh ky kz la lb b">month</code>)可能和函数名(比如，<code class="eh ky kz la lb b">lubridate::month</code>)冲突，R将匹配后者并尝试使用闭包，而不是仅仅报告变量不存在。</li></ul><p id="bb3e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">事后看来，我可以通过使用不太可能冲突的变量名来避免这些错误(比如用<code class="eh ky kz la lb b">month_local</code>代替<code class="eh ky kz la lb b">month</code>)。</p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h2 id="f3f7" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">马格里特规则</h2><p id="2be9" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">在这个问题上我已经碰了几次头——事实上，我写了一个论坛帖子向人们询问了两次<em class="jp"/>，然后在发布两次之前大约五秒钟意识到发生了什么。</p><p id="615e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我还没有完全掌握如何使用<code class="eh ky kz la lb b">purrr</code>的<a class="ae kx" href="https://jennybc.github.io/purrr-tutorial/ls13_list-columns.html" rel="noopener ugc nofollow" target="_blank">工具来处理列表列</a>，但是我已经开始使用它们来完成一些常见的任务，比如批量导入或导出文件。但我时不时会碰到这样的事情:</p><pre class="ld le lf lg fq mg lb mh mi aw mj dt"><span id="d8fa" class="jx jy hu lb b fv mk ml l mm mn">library(tidyverse)<br/>library(purrr)</span><span id="df7e" class="jx jy hu lb b fv mo ml l mm mn"># example data set<br/>df = data_frame(<br/>  g = rep(letters[1:3], 20),<br/>  a = 1:60,<br/>  b = rnorm(60))</span><span id="886e" class="jx jy hu lb b fv mo ml l mm mn"># group, then write each group out to disk<br/>df %&gt;%<br/>  nest(-g) %&gt;%<br/>  mutate(g = paste0(g, '.csv')) %&gt;%<br/>  print() %&gt;%<br/>  walk2(data, g, write_csv)<br/>#&gt; # A tibble: 3 x 2<br/>#&gt;   g     data<br/>#&gt; &lt;chr&gt; &lt;list&gt;<br/>#&gt; 1 a.csv &lt;tibble [20 × 2]&gt;<br/>#&gt; 2 b.csv &lt;tibble [20 × 2]&gt;<br/>#&gt; 3 c.csv &lt;tibble [20 × 2]&gt;<br/>#&gt; Error in as_mapper(.f, ...) : object 'g' not found</span></pre><p id="4b70" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">没有:<code class="eh ky kz la lb b">g</code>没有找到。好了，也许这些没有使用tidyeval来识别列名，我需要在点代词<code class="eh ky kz la lb b">.</code>前面加上前缀，它代表管道数据帧:</p><p id="3ce0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">(注意:在本教程的<a class="ae kx" href="https://jennybc.github.io/purrr-tutorial/ls13_list-columns.html" rel="noopener ugc nofollow" target="_blank">中，</a><a class="mp mq gr" href="https://medium.com/u/d0c30100067c?source=post_page-----c6bd9ada59c--------------------------------" rel="noopener" target="_blank"> Jenny Bryan </a>使用了<code class="eh ky kz la lb b">map</code>的光秃秃的列名，我还没完全弄明白呢！)</p><pre class="ld le lf lg fq mg lb mh mi aw mj dt"><span id="4097" class="jx jy hu lb b fv mk ml l mm mn">df %&gt;%<br/>  nest(-g) %&gt;%<br/>  mutate(g = paste0(g, '.csv')) %&gt;%<br/>  print() %&gt;%<br/>  walk2(.$data, .$g, write_csv)<br/>#&gt; # A tibble: 3 x 2<br/>#&gt;   g     data<br/>#&gt; &lt;chr&gt; &lt;list&gt;<br/>#&gt; 1 a.csv &lt;tibble [20 × 2]&gt;<br/>#&gt; 2 b.csv &lt;tibble [20 × 2]&gt;<br/>#&gt; 3 c.csv &lt;tibble [20 × 2]&gt;<br/>#&gt; Error in recycle_args(.l) : all(lengths == 1L | lengths == n) is not TRUE</span></pre><p id="0f67" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不要。但是我的两列绝对是一样长的。绞尽脑汁，终于想起了<code class="eh ky kz la lb b">magrittr</code>的根本规律:最后一个返回值成为第一个参数，除非你也单独使用了点代词<em class="jp">。</em>如果你在一个表达式中使用它(比如<code class="eh ky kz la lb b">.$data</code>，管道仍然把<code class="eh ky kz la lb b">.</code>作为第一个参数输入。</p><p id="2a3d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以我的烟斗是偷偷的:</p><pre class="ld le lf lg fq mg lb mh mi aw mj dt"><span id="145e" class="jx jy hu lb b fv mk ml l mm mn">walk2(., .$data, .$g, write_csv)</span></pre><p id="3b14" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是我可以用括号把它包起来:</p><pre class="ld le lf lg fq mg lb mh mi aw mj dt"><span id="f1ab" class="jx jy hu lb b fv mk ml l mm mn">{ walk2(.$data, .$g, write_csv) }</span></pre><p id="e325" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不幸的是，这似乎在<code class="eh ky kz la lb b">purrr</code>工作流中经常发生——这不是任何人的错，错误只是有时以一种令人困惑的方式相互作用。</p><h1 id="979c" class="mr jy hu bd jz ms mt mu kd mv mw mx kh my mz na kk nb nc nd kn ne nf ng kq nh dt translated"><strong class="ak">首先避免问题</strong></h1><p id="ce98" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">所以我们注定要永远犯同样愚蠢的错误，对吗？不:我们可以犯<em class="jp">更好的错误！也就是说，我们可以采取一些措施来确保愚蠢的错误不再成为问题。</em></p><h2 id="0303" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated"><strong class="ak">使用棉绒</strong></h2><p id="ef26" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">Linters是检查你的代码是否有<a class="ae kx" href="https://en.wikipedia.org/wiki/Lint_%28software%29" rel="noopener ugc nofollow" target="_blank">‘可疑用法’</a>——奇怪的语法，可能导致意想不到的后果的代码，诸如此类。</p><figure class="ld le lf lg fq lh fe ff paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="fe ff ni"><img src="../Images/197980b0768d7da548516945e9021a75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*3TOWmvalzJ9EagQ43U4LjQ.gif"/></div></div><figcaption class="lo lp fg fe ff lq lr bd b be z ek">The excellent <a class="ae kx" href="https://marketplace.visualstudio.com/items?itemName=Ikuyadeu.r" rel="noopener ugc nofollow" target="_blank">R extension</a> for Visual Studio Code supports linting with <a class="ae kx" href="https://github.com/jimhester/lintr" rel="noopener ugc nofollow" target="_blank">lintr</a>. So does <a class="ae kx" href="https://www.rstudio.com/" rel="noopener ugc nofollow" target="_blank">RStudio</a>.</figcaption></figure><p id="0ee6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一个linter可能带来的许多标志可能只是非标准的风格——如果你对风格有一些…嗯，<em class="jp">分歧</em>(<a class="ae kx" href="http://www.win-vector.com/blog/2013/04/prefer-for-assignment-in-r/" rel="noopener ugc nofollow" target="_blank">猜猜我准备死在哪个山头</a>？).但是最坏的情况是，linters只是强迫你检查你的编码决策。在最好的情况下，他们在问题滚雪球般地占据你半个下午之前就发现了问题。</p><h2 id="d689" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated"><strong class="ak">编写可以快速测试的脚本</strong></h2><p id="183e" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">作为一名学者，我在远程服务器上做了很多工作。其中一些是资源受限的，所以如果我需要多一点的RAM或多几个CPU，我必须编写一个脚本，而不是排队等待并以非交互方式运行。</p><p id="3b29" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这对调试来说是个问题，因为作业系统可能会在脚本上停留几分钟到几个小时。即使只有几分钟，也要花上半天的时间来解决一些原本只需要15分钟就能解决的问题。</p><p id="242b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您编写的脚本可以让您自己运行(最好是交互式的，但是非此即彼)，那么修复早期出现的各种错误会非常快。如果所有的脚本代码都在函数内部，那么一旦定义了函数，就会出现一些错误，而不是在代码真正执行之前一直处于休眠状态(根据脚本的大小，可能是几个小时或几天之后)。</p><h2 id="42ca" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated"><strong class="ak">定期转储输出样本</strong></h2><p id="3af7" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">非交互工作的另一个令人沮丧的方面是，您不能只放下一个断点就检查您的数据结构。我知道有很多方法可以解决这个问题，但是对我来说，半定期地使用<code class="eh ky kz la lb b">print(head(data))</code>和<code class="eh ky kz la lb b">print(summary(data))</code>可能也是一个好习惯。这样，如果我的代码运行时，我打开了一个满是<code class="eh ky kz la lb b">NA</code>的列，我至少可以找出哪里出错了。</p><p id="cf54" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我的待办事项列表中，一个更好的选择是使用<a class="ae kx" href="http://rmarkdown.rstudio.com/" rel="noopener ugc nofollow" target="_blank"> RMarkdown </a>作为我的分析的一个看起来更好的日志文件。</p><h2 id="3d9e" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated"><strong class="ak">不要放弃未测试的代码</strong></h2><p id="e165" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">运行需要几分钟时间来设置的代码是一个去厕所、伸伸腿或泡一杯茶的好借口。但是运行你没有测试过的代码，在它崩溃之前离开它，是忘记可能导致它的变化的好方法。</p><p id="9f36" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">个人原则:从现在开始，如果我在调试时做了一些修改，然后开始测试，我不会离开，直到测试结束，除非我在便利贴上潦草地写下我所做的修改。这样，如果我在修复第一个错误时引入了另一个愚蠢的错误，至少我知道它在哪一行。</p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><p id="b23d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你有没有其他经常陷入的R陷阱或者最小化调试痛苦的技巧？我想更新这个，因为我继续犯愚蠢的错误，所以不要羞于告诉我你的错误！</p></div></div>    
</body>
</html>