<html>
<head>
<title>Getting started with microservices and Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">微服务和Kubernetes入门</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/getting-started-with-microservices-and-kubernetes-76354312b556?source=collection_archive---------1-----------------------#2017-12-24">https://medium.com/hackernoon/getting-started-with-microservices-and-kubernetes-76354312b556?source=collection_archive---------1-----------------------#2017-12-24</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/9a4d3275e617a078606420765ee12ec8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RFgiyi6NsdMTDFVt2JxQ8g.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">every microservices diagram ever</figcaption></figure><p id="4502" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如果只有一个服务，就不是微服务平台。所有这些服务都需要能够相互交流，需要在其中一些服务不舒服时进行处理，需要在真实的机器上运行，需要能够与外部世界联系等等。</p><p id="6d13" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这就是Kubernetes的用武之地——它编排了各个Docker容器的生命和时间，为我们提供了构建健壮和可伸缩系统所需的原语。</p><p id="8d27" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这些微服务现在是一件大事，但很少有一步一步的指导来启动和运行一个基本的系统。这部分是因为“基本微服务系统”的概念是一个矛盾。不管怎样，我们都要试试。</p><p id="52b0" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们确实需要一些必备的知识，特别是什么是<a class="ae kf" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>及其用途。之后你需要了解Kube的基本知识:<a class="ae kf" href="https://kubernetes.io/docs/concepts/workloads/pods/pod/" rel="noopener ugc nofollow" target="_blank">吊舱</a>，<a class="ae kf" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank">服务</a>，<a class="ae kf" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" rel="noopener ugc nofollow" target="_blank">部署</a>等等。</p><p id="3a59" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这个指南主要是针对那些已经在Kube上运行了一个单独的服务，并且正在思考"<em class="ke">现在该怎么办？"</em>。</p><h1 id="a1d8" class="kg kh hu bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">Tldr部分</h1><p id="b265" class="pw-post-body-paragraph jg jh hu ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">如果你是那种“给我看看代码”的人，你会非常喜欢这个git repo。否则请继续阅读。</p><h1 id="860e" class="kg kh hu bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">开始之前</h1><p id="4358" class="pw-post-body-paragraph jg jh hu ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">我们所有的微服务都将在<a class="ae kf" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> node.js </a> v8.x中编写，所以你会想先安装它。它们都非常简单，因此您不需要比最粗略的javascript /节点知识更多的知识。</p><p id="43d5" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们将在Minikube上运行所有这些，这是一个让kube在本地运行的好方法。你可以在这里找到安装说明<a class="ae kf" href="https://labs.consol.de/development/java/kubernetes/2017/02/10/minikube.html" rel="noopener ugc nofollow" target="_blank"/>。之后，你需要验证你的Minikube安装是否一切正常。</p><p id="2d8f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">首先创建一个Minikube集群:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="190d" class="ls kh hu lo b fv lt lu l lv lw">$ minikube start</span><span id="01c0" class="ls kh hu lo b fv lx lu l lv lw">Starting local Kubernetes v1.8.0 cluster...<br/>Starting VM...<br/>Getting VM IP address...<br/>Moving files into cluster...<br/>Setting up certs...<br/>Connecting to cluster...<br/>Setting up kubeconfig...<br/>Starting cluster components...<br/>Kubectl is now configured to use the cluster.<br/>Loading cached images from config file.</span></pre><p id="e9bc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然后检查Kube系统服务是否都正常:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="a253" class="ls kh hu lo b fv lt lu l lv lw">$ kubectl get services -n kube-system</span><span id="14b9" class="ls kh hu lo b fv lx lu l lv lw">NAME                   CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE<br/>kube-dns               10.96.0.10      &lt;none&gt;        53/UDP,53/TCP   1m<br/>kubernetes-dashboard   10.107.19.167   &lt;nodes&gt;       80:30000/TCP    1m</span></pre><p id="f34d" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">还有一件事，我们需要Minikube来共享我们的本地docker注册表，否则它将无法找到我们构建的docker映像。</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="9723" class="ls kh hu lo b fv lt lu l lv lw">$ eval $(minikube docker-env)</span></pre><p id="6a5e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">超级棒。现在让我们建立一些有趣的东西。</p><h1 id="1bb5" class="kg kh hu bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld dt translated">总发票管理！！！1!</h1><p id="a58b" class="pw-post-body-paragraph jg jh hu ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">让我们为一家公司构建一个管理发票的系统。听起来很简单，也是我能想到的最有趣的事情。我们的系统将包括:</p><ul class=""><li id="aaf4" class="ly lz hu ji b jj jk jn jo jr ma jv mb jz mc kd md me mf mg dt translated">一个<strong class="ji hv"> API网关</strong>将流量路由到我们的系统</li><li id="25a3" class="ly lz hu ji b jj mh jn mi jr mj jv mk jz ml kd md me mf mg dt translated">用于限制访问的<strong class="ji hv">认证服务</strong></li><li id="0fbc" class="ly lz hu ji b jj mh jn mi jr mj jv mk jz ml kd md me mf mg dt translated">前端<strong class="ji hv">发票服务</strong>返回发票信息</li><li id="2cd7" class="ly lz hu ji b jj mh jn mi jr mj jv mk jz ml kd md me mf mg dt translated">一个后端<strong class="ji hv">预期日期服务</strong>将告诉我们发票可能何时支付</li></ul><figure class="lj lk ll lm fq iv fe ff paragraph-image"><div class="fe ff mm"><img src="../Images/2b999dd49914224464f2e9248a7ec5f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:802/format:webp/1*SCcK71yEwP6wxYP7SxRVJg.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">the basics</figcaption></figure><p id="e5fd" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">第一步是让我们的文件夹结构排序。我们将为所有的kube配置文件建立一个文件夹，为我们的每个服务建立另外一个文件夹。</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="4d04" class="ls kh hu lo b fv lt lu l lv lw">- total_invoice_managment<br/>|<br/>| - kube<br/>| - invoices_svc</span></pre><h2 id="7f34" class="ls kh hu bd ki mn mo mp km mq mr ms kq jr mt mu ku jv mv mw ky jz mx my lc mz dt translated">发票服务</h2><p id="230a" class="pw-post-body-paragraph jg jh hu ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">我们的第一项服务是负责个人发票的<code class="eh na nb nc lo b">invoices_svc</code>。它将有一个端点<code class="eh na nb nc lo b">api/invoices/:id</code>,这个端点将交换发票数据的id。让我们使用节点包管理器(<a class="ae kf" href="http://npmjs.com" rel="noopener ugc nofollow" target="_blank"> npm </a>)快速搭建服务。</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="3422" class="ls kh hu lo b fv lt lu l lv lw">$ cd ./invoices_svc<br/>$ npm init <br/># then say yes to everything<br/>$ npm install express</span></pre><p id="4050" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">更新<code class="eh na nb nc lo b">package.json</code>以包含启动应用程序的脚本:</p><figure class="lj lk ll lm fq iv"><div class="bz el l di"><div class="nd ne l"/></div></figure><p id="2315" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">添加包含服务代码的<code class="eh na nb nc lo b">index.js</code>文件:</p><figure class="lj lk ll lm fq iv"><div class="bz el l di"><div class="nd ne l"/></div></figure><p id="347a" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">验证它是否在本地运行:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="d370" class="ls kh hu lo b fv lt lu l lv lw">$ PORT=3007 npm start</span><span id="e95f" class="ls kh hu lo b fv lx lu l lv lw">invoices_svc listening on 3007</span><span id="4ada" class="ls kh hu lo b fv lx lu l lv lw">$ curl localhost:3007/api/invoices/10</span><span id="b956" class="ls kh hu lo b fv lx lu l lv lw">{"id":10,"ref":"INV-10","amount":1000,"balance":990,"ccy":"GBP"}</span></pre><p id="5f38" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">有用！对我们的服务按预期工作感到满意后，我们现在可以通过制作一个<a class="ae kf" href="https://docs.docker.com/engine/reference/builder/#usage" rel="noopener ugc nofollow" target="_blank"> Dockerfile </a>来对它进行dockerize:</p><figure class="lj lk ll lm fq iv"><div class="bz el l di"><div class="nd ne l"/></div></figure><p id="8157" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然后我们可以构建Docker容器来确保一切正常:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="f5be" class="ls kh hu lo b fv lt lu l lv lw">$ docker build ./ -t invoices_svc:v1</span></pre><p id="d874" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">是时候让这项服务进入Kube了。让我们将目录切换到上一级的<code class="eh na nb nc lo b">kube</code>文件夹:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="f3c7" class="ls kh hu lo b fv lt lu l lv lw">$ cd ../kube</span></pre><p id="78e8" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">并添加我们的第一位kube配置。调用文件<code class="eh na nb nc lo b">invoices_svc.yaml</code></p><figure class="lj lk ll lm fq iv"><div class="bz el l di"><div class="nd ne l"/></div></figure><p id="a974" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这个配置定义了一个Kube <a class="ae kf" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank">服务</a>及其伴随的<a class="ae kf" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" rel="noopener ugc nofollow" target="_blank">部署</a>。我们可以让kube启动它</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="f0f3" class="ls kh hu lo b fv lt lu l lv lw">$ kubectl apply -f ./invoices_svc.yaml</span><span id="0e66" class="ls kh hu lo b fv lx lu l lv lw">deployment "invoices-svc" created<br/>service "invoices-svc" created</span></pre><p id="9481" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们应该看到它的服务:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="3417" class="ls kh hu lo b fv lt lu l lv lw">$ kubectl get services</span><span id="ab43" class="ls kh hu lo b fv lx lu l lv lw">NAME           CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE<br/>invoices-svc   10.104.86.220   &lt;none&gt;        80/TCP    3m<br/>kubernetes     10.96.0.1       &lt;none&gt;        443/TCP   1h</span></pre><p id="fdec" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">所有的豆荚也是:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="2102" class="ls kh hu lo b fv lt lu l lv lw">$ kubectl get pods</span><span id="018c" class="ls kh hu lo b fv lx lu l lv lw">NAME                            READY     STATUS    RESTARTS   AGE<br/>invoices-svc-65b5f7bbd4-ckr8d   1/1       Running   0          44s<br/>invoices-svc-65b5f7bbd4-gvk9s   1/1       Running   0          44s<br/>invoices-svc-65b5f7bbd4-z2kx7   1/1       Running   0          44s</span></pre><p id="a3ff" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">由于没有针对<code class="eh na nb nc lo b">invoices_svc</code>的外部IP，我们需要进入集群内的一个容器<em class="ke">，以便能够进行测试。特别是旋转一个看起来很奇怪，但这是一种非常酷的做事方式。Busyboxplus只是一个容器，有一个基本的外壳和一些常用工具。我们需要它来使用<code class="eh na nb nc lo b">curl</code>。</em></p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="30f0" class="ls kh hu lo b fv lt lu l lv lw">$ kubectl run curl --image=radial/busyboxplus:curl -i --tty</span><span id="efb1" class="ls kh hu lo b fv lx lu l lv lw">[ root@curl-696777f579-qwjcr:/ ]$ curl 10.104.86.220/api/invoices/1</span><span id="67c7" class="ls kh hu lo b fv lx lu l lv lw">{"id":1,"ref":"INV-1","amount":100,"balance":90,"ccy":"GBP"}</span></pre><p id="a1d1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">(要逃离容器，您需要按下<code class="eh na nb nc lo b">ctl-d)</code></p><p id="5de4" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">有用！算是吧。困在我们的集群中是没有用的——我们需要创建一个<em class="ke">入口</em>,这样流量就可以找到进入的途径。为此我们将使用<a class="ae kf" href="https://www.getambassador.io/" rel="noopener ugc nofollow" target="_blank">大使</a>。它是一个围绕<a class="ae kf" href="https://www.envoyproxy.io" rel="noopener ugc nofollow" target="_blank">特使代理</a>的便捷包装器，内置了许多优秀的API网关特性。路由似乎是一个很好的起点。</p><p id="8a98" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们需要让大使在我们的集群上运行。在<code class="eh na nb nc lo b">kube</code>文件夹中创建一个名为<code class="eh na nb nc lo b">ambassador.yaml</code>的文件:</p><figure class="lj lk ll lm fq iv"><div class="bz el l di"><div class="nd ne l"/></div></figure><p id="d954" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然后我们可以启动它:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="045a" class="ls kh hu lo b fv lt lu l lv lw">$ kubectl apply -f ./ambassador.yaml</span><span id="e1bb" class="ls kh hu lo b fv lx lu l lv lw">$ kubectl get services<br/>NAME               CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE<br/>ambassador         10.103.215.136   &lt;pending&gt;     80:32005/TCP     11s<br/>ambassador-admin   10.104.3.82      &lt;nodes&gt;       8877:31385/TCP   11s<br/>invoices-svc       10.104.86.220    &lt;none&gt;        80/TCP           45m<br/>kubernetes         10.96.0.1        &lt;none&gt;        443/TCP          2h</span></pre><p id="c6cc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们需要告诉大使关于我们的<code class="eh na nb nc lo b">invoices_svc</code>，我们通过给<code class="eh na nb nc lo b">invoices_svc.yaml</code>的<code class="eh na nb nc lo b">Service</code>部分添加一些注释来完成</p><figure class="lj lk ll lm fq iv"><div class="bz el l di"><div class="nd ne l"/></div></figure><p id="f5f4" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><code class="eh na nb nc lo b">prefix</code>键将流量从<code class="eh na nb nc lo b">/invoices/</code>路由到我们的服务。为了让事情保持整洁，<code class="eh na nb nc lo b">rewrite</code>键也做了一些转换，这样到<code class="eh na nb nc lo b">/invoices/:id</code>的流量被路由到我们在<code class="eh na nb nc lo b">/api/invoices/:id.</code>的服务</p><p id="0ece" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">添加配置后，我们可以应用它:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="223f" class="ls kh hu lo b fv lt lu l lv lw">$ kubectl apply -f ./invoices_svc.yaml</span></pre><p id="5269" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">大使监视着集群中发生的一切。当我们更新配置时，ambassador检测到了这一变化，并寻找任何注释。它发现了它们，现在会将流量路由到该服务。</p><p id="4729" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">理论上，我们现在有了一个到集群的外部api网关。在验证该假设之前，我们需要创建一个从本地主机到minikube集群的隧道:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="48e5" class="ls kh hu lo b fv lt lu l lv lw">$ minikube service ambassador --url</span><span id="7a60" class="ls kh hu lo b fv lx lu l lv lw"><a class="ae kf" href="http://192.168.99.100:32005" rel="noopener ugc nofollow" target="_blank">http://192.168.99.100:32005</a></span></pre><p id="8372" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这个特殊的url只适用于我的本地机器— <strong class="ji hv">你需要使用你自己的URL来完成后面的步骤</strong>。</p><p id="bb64" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们可以使用返回的url来访问我们的集群:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="182f" class="ls kh hu lo b fv lt lu l lv lw">$ curl <a class="ae kf" href="http://192.168.99.100:32005/invoices/42" rel="noopener ugc nofollow" target="_blank">http://192.168.99.100:32005/invoices/42</a></span><span id="7be6" class="ls kh hu lo b fv lx lu l lv lw">{"id":42,"ref":"INV-42","amount":4200,"balance":4190,"ccy":"GBP"}</span></pre><p id="96c1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">🎉有用！所以我们有服务和网关。</p><h2 id="888d" class="ls kh hu bd ki mn mo mp km mq mr ms kq jr mt mu ku jv mv mw ky jz mx my lc mz dt translated">添加身份验证</h2><p id="9908" class="pw-post-body-paragraph jg jh hu ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">让我们的服务提供给世界+狗并不太好。我们应该给我们的网关添加某种认证。当听到我们想要一个新的服务，或者它将被称为<code class="eh na nb nc lo b">auth_svc</code>时，没有人会感到惊讶。</p><ul class=""><li id="f64d" class="ly lz hu ji b jj jk jn jo jr ma jv mb jz mc kd md me mf mg dt translated">创建一个名为<code class="eh na nb nc lo b">auth_svc</code>的新文件夹</li><li id="947e" class="ly lz hu ji b jj mh jn mi jr mj jv mk jz ml kd md me mf mg dt translated">从<code class="eh na nb nc lo b">invoices_svc</code>复制<code class="eh na nb nc lo b">Dockerfile</code></li><li id="9a1e" class="ly lz hu ji b jj mh jn mi jr mj jv mk jz ml kd md me mf mg dt translated">重复我们为<code class="eh na nb nc lo b">invoices_svc</code>所做的npm步骤</li></ul><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="99df" class="ls kh hu lo b fv lt lu l lv lw">$ cd ../<br/>$ mkdir <!-- -->auth_svc<br/>$ cd ./<!-- -->auth_svc<br/>$ npm init<br/>$ npm install express<br/>$ cp ../invoices_svc/Dockerfile .</span><span id="61e2" class="ls kh hu lo b fv lx lu l lv lw"># don't forget to add "start": "node index.js" to your package.json!</span></pre><ul class=""><li id="be1d" class="ly lz hu ji b jj jk jn jo jr ma jv mb jz mc kd md me mf mg dt translated">创建<code class="eh na nb nc lo b">auth_svc</code>应用程序:</li></ul><figure class="lj lk ll lm fq iv"><div class="bz el l di"><div class="nd ne l"/></div></figure><ul class=""><li id="df6b" class="ly lz hu ji b jj jk jn jo jr ma jv mb jz mc kd md me mf mg dt translated">创建kube配置:</li></ul><figure class="lj lk ll lm fq iv"><div class="bz el l di"><div class="nd ne l"/></div></figure><ul class=""><li id="7f98" class="ly lz hu ji b jj jk jn jo jr ma jv mb jz mc kd md me mf mg dt translated">构建docker映像:</li></ul><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="da93" class="ls kh hu lo b fv lt lu l lv lw">$ docker build -t auth_svc:v1 ./auth_svc/</span></pre><ul class=""><li id="b4dc" class="ly lz hu ji b jj jk jn jo jr ma jv mb jz mc kd md me mf mg dt translated">应用kube配置:</li></ul><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="d2ab" class="ls kh hu lo b fv lt lu l lv lw">$  kubectl apply -f ./kube/auth_svc.yaml</span></pre><ul class=""><li id="99b9" class="ly lz hu ji b jj jk jn jo jr ma jv mb jz mc kd md me mf mg dt translated">看看是否有效:</li></ul><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="7d47" class="ls kh hu lo b fv lt lu l lv lw">$ curl <a class="ae kf" href="http://192.168.99.100:32005/invoices/42" rel="noopener ugc nofollow" target="_blank">http://192.168.99.100:32005/invoices/42</a></span><span id="7904" class="ls kh hu lo b fv lx lu l lv lw">{"ok":false}</span></pre><p id="4450" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">王牌，我们现在被锁在外面，除非我们知道这个神奇的词:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="2319" class="ls kh hu lo b fv lt lu l lv lw">$  curl <a class="ae kf" href="http://192.168.99.100:32005/invoices/42" rel="noopener ugc nofollow" target="_blank">http://192.168.99.100:32005/invoices/42</a> -H 'authorization: letmeinpleasekthxbye'</span><span id="1f50" class="ls kh hu lo b fv lx lu l lv lw">{"id":42,"ref":"INV-42","amount":4200,"balance":4190,"ccy":"GBP"}</span></pre><p id="b46f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们来盘点一下。我们有一个API网关来验证流量并将其路由到我们的服务。然而，我们不希望我们所有的服务都是公开的，那么我们的前端服务调用的后端服务呢？Kube也有办法做到这一点。</p><h2 id="7905" class="ls kh hu bd ki mn mo mp km mq mr ms kq jr mt mu ku jv mv mw ky jz mx my lc mz dt translated">我什么时候能拿到工资？</h2><p id="47b3" class="pw-post-body-paragraph jg jh hu ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">知道你的顾客什么时候会付钱给你总是很好的。我们将创建一个<em class="ke">非常复杂的算法推理引擎* </em>，它将告诉我们发票何时应该支付。这与最后两个服务类似:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="0fef" class="ls kh hu lo b fv lt lu l lv lw">$ cd ../<br/>$ mkdir expected_date_svc<br/>$ cd ./expected_date_svc<br/>$ npm init<br/>$ npm install express<br/>$ npm install moment <br/>$ cp ../invoices_svc/Dockerfile .</span><span id="99ab" class="ls kh hu lo b fv lx lu l lv lw"># don't forget to add "start": "node index.js" to your package.json!</span></pre><p id="6dc5" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">而<em class="ke">极高复杂度算法推理机</em>的代码是<em class="ke"> : </em></p><figure class="lj lk ll lm fq iv"><div class="bz el l di"><div class="nd ne l"/></div></figure><p id="c1f5" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">只剩下kube配置:</p><figure class="lj lk ll lm fq iv"><div class="bz el l di"><div class="nd ne l"/></div></figure><p id="34f1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">你知道规矩:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="4094" class="ls kh hu lo b fv lt lu l lv lw">$ docker build -t expected_date_svc:v1 .<br/>$ kubectl apply -f ../kube/expected_date_svc.yaml<br/>$ kubectl get services</span><span id="3cc9" class="ls kh hu lo b fv lx lu l lv lw">NAME                CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE<br/>ambassador          10.103.215.136   &lt;pending&gt;     80:32005/TCP     19h<br/>ambassador-admin    10.104.3.82      &lt;nodes&gt;       8877:31385/TCP   19h<br/>auth-svc            10.108.119.134   &lt;none&gt;        3000/TCP         18h<br/>expected-date-svc   10.101.227.50    &lt;none&gt;        80/TCP           1m<br/>invoices-svc        10.104.86.220    &lt;none&gt;        80/TCP           20h<br/>kubernetes          10.96.0.1        &lt;none&gt;        443/TCP          21h</span></pre><p id="8e0e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">所以现在我们已经运行了<code class="eh na nb nc lo b">expected_date_svc</code>，我们想要修改<code class="eh na nb nc lo b">invoices_svc</code>来使用它。</p><p id="eb96" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们需要一个新的依赖项来发出http请求:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="6e75" class="ls kh hu lo b fv lt lu l lv lw">$ cd ../invoices_svc<br/>$ npm install request-promise<br/>$ npm install request</span></pre><p id="0d2f" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">然后我们向<code class="eh na nb nc lo b">expected_date_svc</code>发出请求，并将结果添加到我们的invoice对象中。下面是更新后的<code class="eh na nb nc lo b">invoice_svc</code>:</p><figure class="lj lk ll lm fq iv"><div class="bz el l di"><div class="nd ne l"/></div></figure><p id="d17e" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们需要重建码头工人的形象:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="e422" class="ls kh hu lo b fv lt lu l lv lw">$ docker build -t invoices_svc:v2 .</span></pre><p id="4efc" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们还需要更新<code class="eh na nb nc lo b">invoices_svc</code>的kube配置</p><p id="4d62" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">首先，它需要引用新的docker图像:</p><figure class="lj lk ll lm fq iv"><div class="bz el l di"><div class="nd ne l"/></div></figure><p id="80c1" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我们还需要添加一个包含<code class="eh na nb nc lo b">expected_svc</code>URL的环境变量。这是绝妙的一点。Kubernetes使用内部DNS路由——你可以在这里了解更多信息。简而言之，kube为每个命名的服务创建一个特殊的url。它的格式是<code class="eh na nb nc lo b">SVCNAME.NAMESPACE.svc.cluster.local</code>，所以<code class="eh na nb nc lo b">expected_date_svc</code>可以在<code class="eh na nb nc lo b">expected-date-svc.default.svc.cluster.local</code>找到。让我们通过更新配置来设置环境变量:</p><figure class="lj lk ll lm fq iv"><div class="bz el l di"><div class="nd ne l"/></div></figure><p id="8797" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">现在，配置已全部更新，我们将其应用于集群:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="bb45" class="ls kh hu lo b fv lt lu l lv lw">$ kubectl apply -f ../kube/invoices_svc.yaml</span></pre><p id="e0fd" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">并检查是否添加了预期日期:</p><pre class="lj lk ll lm fq ln lo lp lq aw lr dt"><span id="d6db" class="ls kh hu lo b fv lt lu l lv lw">$ curl <a class="ae kf" href="http://192.168.99.100:32005/invoices/42" rel="noopener ugc nofollow" target="_blank">http://192.168.99.100:32005/invoices/42</a> -H 'authorization: letmeinpleasekthxbye'</span><span id="1fba" class="ls kh hu lo b fv lx lu l lv lw">{"id":42,"ref":"INV-42","amount":4200,"balance":4190,"ccy":"GBP","expectedDate":"2018-01-01T11:54:30.769Z"}</span></pre></div><div class="ab cl nf ng hc nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="hn ho hp hq hr"><p id="1690" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这对读者来说应该足够让集群运行了。接下来的步骤包括添加和删除副本以扩展服务，添加<a class="ae kf" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/#define-a-liveness-http-request" rel="noopener ugc nofollow" target="_blank">活跃度探测器</a>以便kubernetes知道服务是否静默失败，或者记录和监控以便我们可以在我们不注意时发现我们的服务在做什么。</p><figure class="lj lk ll lm fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nm"><img src="../Images/a00b914051842aa392090da8a1a246af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VdUh1Yv0BZ7NNZJ5yJasIw.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">How all the bits go togther</figcaption></figure><h2 id="87ed" class="ls kh hu bd ki mn mo mp km mq mr ms kq jr mt mu ku jv mv mw ky jz mx my lc mz dt translated">我喜欢！</h2><p id="d7bc" class="pw-post-body-paragraph jg jh hu ji b jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz li kb kc kd hn dt translated">太好了，我们也是。我们如此喜欢kube，以至于我们在<a class="ae kf" href="https://fluidly.com/" rel="noopener ugc nofollow" target="_blank">流畅地</a>使用它来满足我们最苛刻的基础设施需求，尤其是我们的数据科学模型。这是一个陡峭的学习曲线，但回报是巨大的。</p><p id="b2c6" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">如果你喜欢这类工作的声音，我们经常寻找令人惊讶的人。给我们写封短信:【jobs@fluidly.com】T2。</p></div><div class="ab cl nf ng hc nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="hn ho hp hq hr"><p id="c584" class="pw-post-body-paragraph jg jh hu ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">*我们的数据科学家真正做到了这一点！</p></div></div>    
</body>
</html>