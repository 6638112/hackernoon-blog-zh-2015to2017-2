<html>
<head>
<title>Background processing using Elixir, GenServer and the Erlang queue module</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Elixir、GenServer和Erlang队列模块进行后台处理</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/background-processing-using-elixir-genserver-and-the-erlang-queue-class-8d476d4942c2?source=collection_archive---------3-----------------------#2017-01-02">https://medium.com/hackernoon/background-processing-using-elixir-genserver-and-the-erlang-queue-class-8d476d4942c2?source=collection_archive---------3-----------------------#2017-01-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="1faa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我写Ruby代码已经很多年了，和我一样，你可能会使用Redis或Sidekiq等熟悉的工具来处理后台作业和数据。我想告诉你为什么有时候，纯粹的灵丹妙药足以完成任务。</p><p id="5d7b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是我如何用pure Elixir和Erlang :queue类替换Redis/Exq的故事。</p><figure class="jp jq jr js fq jt"><div class="bz el l di"><div class="ju jv l"/></div></figure><blockquote class="jw jx jy"><p id="eebd" class="ir is jz it b iu iv iw ix iy iz ja jb ka jd je jf kb jh ji jj kc jl jm jn jo hn dt translated">非常感谢<a class="ae kd" href="https://www.youtube.com/channel/UCp01DFl8kp-239gW289C0ew" rel="noopener ugc nofollow" target="_blank">omgnering</a>在GenServer上的视频。如果你理解GenServer有困难，这将是一个巨大的帮助。</p></blockquote><p id="f445" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我构建了<a class="ae kd" href="http://github.com/sergiotapia/magnetissimo" rel="noopener ugc nofollow" target="_blank">magnetismo</a>作为一个学习练习，以真正理解仙丹，并了解如何发布生产就绪代码。虽然Github上的版本现在可以工作，但它在我最初目标中列出的非常重要的方面有所欠缺。</p><p id="634d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jz">目标:</em></p><ul class=""><li id="140d" class="ke kf hu it b iu iv iy iz jc kg jg kh jk ki jo kj kk kl km dt translated"><em class="jz">抓取种子和磁铁链接的多个索引网站。——</em><strong class="it hv">正在工作！</strong></li><li id="8b61" class="ke kf hu it b iu kn iy ko jc kp jg kq jk kr jo kj kk kl km dt translated"><em class="jz">不拘泥于仪式的奔跑。不需要无意义的配置。— </em> <strong class="it hv"> <em class="jz"> </em>嗯……挺？</strong></li><li id="a4eb" class="ke kf hu it b iu kn iy ko jc kp jg kq jk kr jo kj kk kl km dt translated"><em class="jz">高性能，利用Elixir的GenServer和Erlang的BEAM VM。— </em> <strong class="it hv">正在工作！</strong></li><li id="02da" class="ke kf hu it b iu kn iy ko jc kp jg kq jk kr jo kj kk kl km dt translated"><em class="jz">测试单元的正确性。— </em> <strong class="it hv"> <em class="jz"> </em>正在工作！</strong></li></ul><p id="7138" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">人们运行这个项目并不容易，甚至开发人员都有疑问，而我想要零摩擦。</p><p id="4ee5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">运行<a class="ae kd" href="https://github.com/sergiotapia/magnetissimo" rel="noopener ugc nofollow" target="_blank">核磁共振</a>的步骤越少，采用率越高。</p><p id="3de6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我在Erlang的队列类和Elixir的GenServer中找到了我的解决方案。</p><figure class="jp jq jr js fq jt fe ff paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="fe ff ks"><img src="../Images/4a73bfb114f67e9fe9572b2339173914.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*buL2Mf--DHECoVDI8g-kXw.png"/></div></div></figure><p id="f7ef" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是迈向最终目标第一步。</p><p id="929f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我做的第一件事是制作爬虫，并为每个爬虫创建一个工人。全部由我的主管监督。</p><pre class="jp jq jr js fq kz la lb lc aw ld dt"><span id="9309" class="le lf hu la b fv lg lh l li lj">children = [<br/>  # Start the Ecto repository<br/>  supervisor(Magnetissimo.Repo, []),<br/>  # Start the endpoint when the application starts<br/>  supervisor(Magnetissimo.Endpoint, []),<br/>  worker(Magnetissimo.Crawler.ThePirateBay, []),<br/>  worker(Magnetissimo.Crawler.EZTV, []),<br/>  worker(Magnetissimo.Crawler.LimeTorrents, []),<br/>  worker(Magnetissimo.Crawler.Leetx, []),<br/>  worker(Magnetissimo.Crawler.Demonoid, []),<br/>]</span></pre><p id="ca98" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每个爬虫实际上是一个GenServer实现。例如，这是爬虫的PirateBay版本。</p><pre class="jp jq jr js fq kz la lb lc aw ld dt"><span id="2044" class="le lf hu la b fv lg lh l li lj">defmodule Magnetissimo.Crawler.ThePirateBay do<br/>  use GenServer<br/>  alias Magnetissimo.Torrent<br/>  alias Magnetissimo.Crawler.Helper<br/><br/>  def start_link do<br/>    queue = initial_queue<br/>    GenServer.start_link(__MODULE__, queue)<br/>  end<br/><br/>  def init(queue) do<br/>    schedule_work()<br/>    {:ok, queue}<br/>  end<br/><br/>  defp schedule_work do<br/>    Process.send_after(self(), :work, 1 * 1 * 300) # 5 seconds<br/>  end<br/><br/>  # Callbacks<br/><br/>  def handle_info(:work, queue) do<br/>    case :queue.out(queue) do<br/>      {{_value, item}, queue_2} -&gt;<br/>        queue = queue_2<br/>        queue = process(item, queue)<br/>      _ -&gt;<br/>        IO.puts "Queue is empty - restarting queue."<br/>        queue = initial_queue<br/>    end<br/>    schedule_work()<br/>    {:noreply, queue}<br/>  end<br/><br/>  def process({:page_link, url}, queue) do<br/>    IO.puts "Downloading page: #{url}"<br/>    html_body = Helper.download(url)<br/>    if html_body != nil do<br/>      torrents = torrent_links(html_body)<br/>      queue = Enum.reduce(torrents, queue, fn torrent, queue -&gt;<br/>        :queue.in({:torrent_link, torrent}, queue)<br/>      end)<br/>    end<br/>    queue<br/>  end<br/><br/>  def process({:torrent_link, url}, queue) do<br/>    IO.puts "Downloading torrent: #{url}"<br/>    html_body = Helper.download(url)<br/>    if html_body != nil do<br/>      torrent_struct = torrent_information(html_body)<br/>      Torrent.save_torrent(torrent_struct)<br/>    end<br/>    queue<br/>  end<br/><br/>  # Parser functions<br/><br/>  def initial_queue do<br/>    urls = for i &lt;- 1..6, j &lt;- 1..50 do<br/>      {:page_link, "https://thepiratebay.org/browse/#{i}00/#{j}/3"}<br/>    end<br/>    :queue.from_list(urls)<br/>  end<br/><br/>  def torrent_links(html_body) do<br/>    html_body<br/>    |&gt; Floki.find(".detName a")<br/>    |&gt; Floki.attribute("href")<br/>    |&gt; Enum.map(fn(url) -&gt; "https://thepiratebay.org" &lt;&gt; url end)<br/>  end<br/><br/>  def torrent_information(html_body) do<br/>    name = html_body<br/>      |&gt; Floki.find("#title")<br/>      |&gt; Floki.text<br/>      |&gt; String.trim<br/>      |&gt; HtmlEntities.decode<br/><br/>    magnet = html_body<br/>      |&gt; Floki.find(".download a")<br/>      |&gt; Floki.attribute("href")<br/>      |&gt; Enum.filter(fn(url) -&gt; String.starts_with?(url, "magnet:") end)<br/>      |&gt; Enum.at(0)<br/><br/>    size = html_body<br/>      |&gt; Floki.find("#detailsframe #details .col1 dd")<br/>      |&gt; Enum.at(2)<br/>      |&gt; Floki.text<br/>      |&gt; String.split(&lt;&lt;194, 160&gt;&gt;)<br/>      |&gt; Enum.at(2)<br/>      |&gt; String.replace("(", "")<br/><br/>    {seeders, _} = html_body<br/>      |&gt; Floki.find("#detailsframe #details .col2 dd")<br/>      |&gt; Enum.at(2)<br/>      |&gt; Floki.text<br/>      |&gt; Integer.parse<br/><br/>    {leechers, _} = html_body<br/>      |&gt; Floki.find("#detailsframe #details .col2 dd")<br/>      |&gt; Enum.at(3)<br/>      |&gt; Floki.text<br/>      |&gt; Integer.parse<br/><br/>    %{<br/>      name: name,<br/>      magnet: magnet,<br/>      size: size,<br/>      website_source: "thepiratebay",<br/>      seeders: seeders,<br/>      leechers: leechers<br/>    }<br/>  end<br/>end</span></pre><p id="78f2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Initial_queue是一个创建Erlang :queue对象的函数，该对象包含扩展的初始URL，并链接到其他分页页面或单个torrent链接。</p><p id="354e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">my :queue中的每个元素都是一个元组，由两部分组成:</p><pre class="jp jq jr js fq kz la lb lc aw ld dt"><span id="1554" class="le lf hu la b fv lg lh l li lj">{:torrent_link, “some_url”}<br/>{:page_link, "some_url"}</span></pre><p id="d007" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在上面的过程方法中使用函数模式匹配，我可以很容易地解析一个分页链接或者解析一个单独的torrent页面。</p><p id="047a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后，schedule_work函数调度下一个要处理的项目。</p></div><div class="ab cl lk ll hc lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="hn ho hp hq hr"><p id="ac55" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最终结果是代码更加内聚，间接性更低。现在向项目中添加一个新的爬虫要容易得多。也更容易知道到底在运行什么。更少的错误机会，更可预测的增长行为。这种方法的一个缺点是波动性。如果我的应用程序关闭，我将失去处理队列。但是对于这个特别的项目，我觉得这样很好。</p><p id="1862" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一个潜在的升级将是从handle_info更改为异步handle_call。</p><p id="8de7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我的下一步是使用<a class="ae kd" href="https://github.com/bitwalker/distillery" rel="noopener ugc nofollow" target="_blank"> Distillery </a>构建一个可部署的可执行文件，这样终端用户就可以运行它，并让<a class="ae kd" href="https://github.com/sergiotapia/magnetissimo" rel="noopener ugc nofollow" target="_blank">magnetismo</a>在本地主机上启动服务。</p><div class="jp jq jr js fq ab cb"><figure class="lr jt ls lt lu lv lw paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="lr jt ls lt lu lv lw paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="lr jt ls lt lu lv lw paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="jw jx jy"><p id="f922" class="ir is jz it b iu iv iw ix iy iz ja jb ka jd je jf kb jh ji jj kc jl jm jn jo hn dt translated"><a class="ae kd" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae kd" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae kd" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae kd" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is jz it b iu iv iw ix iy iz ja jb ka jd je jf kb jh ji jj kc jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kd" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kd" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jp jq jr js fq jt fe ff paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="fe ff lx"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>