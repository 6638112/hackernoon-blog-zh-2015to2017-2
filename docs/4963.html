<html>
<head>
<title>Notes on moving from etcd2 to etcd3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从etcd2迁移到etcd3的注意事项</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/notes-on-moving-from-etcd2-to-etcd3-dedb26057b90?source=collection_archive---------3-----------------------#2017-07-02">https://medium.com/hackernoon/notes-on-moving-from-etcd2-to-etcd3-dedb26057b90?source=collection_archive---------3-----------------------#2017-07-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/4fb6274eda5d13ffa5fe31634ec1a7dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uWq3c-QN54v6t7RXb9jkMg.png"/></div></div></figure><div class=""/><p id="b892" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">TL；DR:从etcd v2到v3的迁移通常都有很好的记录，但是有一些问题你可能需要注意。</p></div><div class="ab cl ka kb hc kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hn ho hp hq hr"><p id="1004" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我是ATM工作人员，从事<a class="ae kh" href="http://reshifter.info" rel="noopener ugc nofollow" target="_blank">ReShifter</a>——一个用于<a class="ae kh" href="https://hackernoon.com/tagged/backing-up" rel="noopener ugc nofollow" target="_blank">备份</a>和恢复<a class="ae kh" href="https://hackernoon.com/tagged/kubernetes" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>集群的工具——在这项工作的背景下，我遇到了一些与etcd相关的事情，这些事情确实花了我一些时间来整理，所以我想我在这里分享一下，以免你痛苦；)</p><p id="8cf2" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">总的来说，etcd v2到etcd v3的迁移故事是有据可查的，参见这里的这篇<a class="ae kh" href="https://coreos.com/blog/migrating-applications-etcd-v3.html" rel="noopener ugc nofollow" target="_blank">博文</a>以及<a class="ae kh" href="https://coreos.com/etcd/docs/latest/op-guide/v2-migration.html" rel="noopener ugc nofollow" target="_blank">官方文档</a>。从CLI的角度(即使用<code class="eh ki kj kk kl b">etcdctl</code>时)和API的角度(即从Go客户端库<a class="ae kh" href="https://godoc.org/github.com/coreos/etcd/client" rel="noopener ugc nofollow" target="_blank"> v2 </a>移动到<a class="ae kh" href="https://godoc.org/github.com/coreos/etcd/clientv3" rel="noopener ugc nofollow" target="_blank"> v3 </a>)来看，有几件事情需要注意:</p><ul class=""><li id="7e1c" class="km kn if je b jf jg jj jk jn ko jr kp jv kq jz kr ks kt ku dt translated">v2数据模型是一棵树，也就是说，一个键标识一个目录(可能作为子树的根)或树中的一个叶，在这种情况下，有效负载实际上可以是一个值。一个键不能同时是叶节点和目录。在v3中，数据模型已经扁平化，也就是说，条目之间不再有层次结构信息。所以，虽然你可以假装，但以下是真的，在v3中你真的在处理(flat) <a class="ae kh" href="https://github.com/coreos/etcd/blob/master/Documentation/dev-guide/interacting_v3.md#read-keys" rel="noopener ugc nofollow" target="_blank">键范围</a>:</li></ul><pre class="kv kw kx ky fq kz kl la lb aw lc dt"><span id="3cb1" class="ld le if kl b fv lf lg l lh li">/kubernetes.io/namespaces/kube-system --&gt;</span><span id="fde2" class="ld le if kl b fv lj lg l lh li">/kubernetes.io<br/> └──namespaces<br/>    └── kube-system</span></pre><ul class=""><li id="63ef" class="km kn if je b jf jg jj jk jn ko jr kp jv kq jz kr ks kt ku dt translated">数据模型变化的一个结果是查询和操作etcd2和etcd3的代码看起来不同了。在前一种情况下，例如，您可以利用层次结构信息递归地遍历树；对于etcd3，您可以有效地确定范围(start和end键，非常类似于您在HBase中所做的)，然后迭代结果集；例如参见<a class="ae kh" href="https://github.com/mhausenblas/reshifter/blob/master/pkg/discovery/visitors.go" rel="noopener ugc nofollow" target="_blank">换码器代码库</a>中的<code class="eh ki kj kk kl b">discovery.Visit2()</code>和<code class="eh ki kj kk kl b">discovery.Visit3()</code>。</li><li id="c8fd" class="km kn if je b jf lk jj ll jn lm jr ln jv lo jz kr ks kt ku dt translated">使用的有线协议(HTTP vs. gRPC)和使用的API版本/数据模型之间存在差异。例如，您可能正在运行etcd3服务器，但是在etcd2模式下使用它。请注意您是如何配置etcd的，以及在何种模式下与它通信。</li><li id="6bd4" class="km kn if je b jf lk jj ll jn lm jr ln jv lo jz kr ks kt ku dt translated">有一件事确实让我有些痛苦:忘记设置环境变量<code class="eh ki kj kk kl b">ETCDCTL_API=3</code>。这个不起眼的开关导致<code class="eh ki kj kk kl b">etcdctl</code>从通话v2切换到v3。在设置env变量之前和之后运行<code class="eh ki kj kk kl b">etcdctl</code>,比较你已经得到的可用命令，例如v2中的<code class="eh ki kj kk kl b">get/set</code>与v3中的<code class="eh ki kj kk kl b">get/put</code>(参见本文顶部的截屏，显示<code class="eh ki kj kk kl b">ls</code>仅在v2 API中可用)。</li><li id="009d" class="km kn if je b jf lk jj ll jn lm jr ln jv lo jz kr ks kt ku dt translated">在etcd3服务器中，v2和v3数据存储并行存在且相互独立，另请参见下面的终端会话。</li></ul><p id="86d1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在让我们看看与etcd3的简单交互，以及如何使用v2和v3 API。首先，我们推出了集装箱化的etcd3:</p><pre class="kv kw kx ky fq kz kl la lb aw lc dt"><span id="acc5" class="ld le if kl b fv lf lg l lh li">$ docker run --rm -p 2379:2379 --name test-etcd \<br/>  --dns 8.8.8.8 quay.io/coreos/etcd:v3.1.0 /usr/local/bin/etcd \<br/>  --advertise-client-urls <a class="ae kh" href="http://0.0.0.0:2379" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:2379</a> \<br/>  --listen-client-urls <a class="ae kh" href="http://0.0.0.0:2379" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:2379</a> \<br/>  --listen-peer-urls <a class="ae kh" href="http://0.0.0.0:2380" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:2380</a></span></pre><p id="c688" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，让我们使用v2 API向etcd中输入一个值:</p><pre class="kv kw kx ky fq kz kl la lb aw lc dt"><span id="08e0" class="ld le if kl b fv lf lg l lh li">curl <a class="ae kh" href="http://127.0.0.1:2379/v2/keys/kubernetes.io/namespaces/kube-system" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:2379/v2/keys/kubernetes.io/namespaces/kube-system</a> -XPUT -d value="value for v2"</span></pre><p id="07f0" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，我们切换到v3 API:</p><pre class="kv kw kx ky fq kz kl la lb aw lc dt"><span id="6ec6" class="ld le if kl b fv lf lg l lh li">$ export ETCDCTL_API=3</span></pre><p id="2dca" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，我们首先检查是否可以读取之前使用v2 API设置的值:</p><pre class="kv kw kx ky fq kz kl la lb aw lc dt"><span id="cbbd" class="ld le if kl b fv lf lg l lh li">$ etcdctl --endpoints=<a class="ae kh" href="http://127.0.0.1:2379" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:2379</a> get \<br/>  /kubernetes.io/namespaces/kube-system</span></pre><p id="7c4d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">返回empty，因此无法写入etcd2数据存储并通过v3读取。现在，让我们使用v3 API将一些内容放入etcd，并在它之后立即查询它以确认写入:</p><pre class="kv kw kx ky fq kz kl la lb aw lc dt"><span id="a80b" class="ld le if kl b fv lf lg l lh li">$ etcdctl --endpoints=<a class="ae kh" href="http://127.0.0.1:2379" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:2379</a> put \<br/>  /kubernetes.io/namespaces/kube-system "value for v3"<br/>$ etcdctl --endpoints=<a class="ae kh" href="http://127.0.0.1:2379" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:2379</a> get \<br/>  /kubernetes.io/namespaces/kube-system<br/>/kubernetes.io/namespaces/kube-system<br/>value for fv3</span></pre></div><div class="ab cl ka kb hc kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hn ho hp hq hr"><p id="e4db" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我将结束这篇文章，并希望你成功地从etcd v2迁移到etcd v3！如果你对上述内容有更多的见解或评论，请在这里分享，在<a class="ae kh" href="https://twitter.com/mhausenblas" rel="noopener ugc nofollow" target="_blank"> Twitter </a> (DMs开放)上联系我，或者来加入我们的<a class="ae kh" href="http://slack.k8s.io" rel="noopener ugc nofollow" target="_blank"> Kubernetes Slack </a>，在那里我经常在#sig-cluster-lifecycle和#sig-apps上闲逛。</p><p id="3de7" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="lp">最后但并非最不重要的一点，我想给CoreOS的</em><a class="ae kh" href="https://twitter.com/_surbaniak" rel="noopener ugc nofollow" target="_blank"><em class="lp">Serg</em></a><em class="lp">巨大的荣誉:他耐心地帮助我解决了我在使用v3 API时遇到的问题。谢谢你，我欠你一次！</em></p><div class="kv kw kx ky fq ab cb"><figure class="lq hw lr ls lt lu lv paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="lq hw lr ls lt lu lv paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="lq hw lr ls lt lu lv paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="lw lx ly"><p id="f922" class="jc jd lp je b jf jg jh ji jj jk jl jm lz jo jp jq ma js jt ju mb jw jx jy jz hn dt translated"><a class="ae kh" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是T21家庭的一员。我们现在<a class="ae kh" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae kh" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jc jd lp je b jf jg jh ji jj jk jl jm lz jo jp jq ma js jt ju mb jw jx jy jz hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kh" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kh" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kv kw kx ky fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mc"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="kv kw kx ky fq hw"><div class="bz el l di"><div class="md me l"/></div></figure></div></div>    
</body>
</html>