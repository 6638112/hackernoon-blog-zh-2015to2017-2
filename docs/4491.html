<html>
<head>
<title>From DigitalOcean to Linode to Google Cloud Platform: the Evolution of healthchecks.io Hosting Setup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从DigitalOcean到Linode再到Google云平台:healthchecks.io托管设置的演变</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/the-evolution-of-healthchecks-io-hosting-setup-4fa0d249a35a?source=collection_archive---------4-----------------------#2017-06-05">https://medium.com/hackernoon/the-evolution-of-healthchecks-io-hosting-setup-4fa0d249a35a?source=collection_archive---------4-----------------------#2017-06-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="381a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在这篇文章中，我将关注当前的healthchecks.io的托管设置，它在过去两年中是如何发展的，以及我在运行这个小而活跃的服务时所面临的挑战。</p><h2 id="de18" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">数字海洋</h2><p id="f799" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated">两年前，当我第一次将这项服务公之于众时，它是靠一滴5美元/月的数字海洋水滴运行的。它有一个CPU内核和512兆内存。droplet同时运行Django web应用程序和Postgres数据库。最初，这项服务几乎没有流量，所以一切都很好。几个月后，我换成了20美元/月的droplet(两个内核，2GB内存)。我用一个Fabric脚本部署代码，并让<a class="ae jp" rel="noopener" href="/@healthchecks/deploying-a-django-app-with-no-downtime-f4e02738ab06">考虑避免代码部署期间的停机时间</a>。</p><p id="9cee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">快进到2016年6月。基于特性的healthchecks.io已经很有用了，但是它的容错性很差。它托管在一台服务器上，每晚都有数据库备份。作为第一步，我决定拆分组件(数据库、healthchecks.io服务器、hchk.io服务器、后台任务),并在单独的虚拟机上运行它们。这有助于一些故障场景。例如，如果主网站宕机或流量过大，hchk.io仍会接受pings，通知仍会发出。然而，数据库服务器宕机仍然是灾难性的。</p><h2 id="66f6" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">compose.io</h2><p id="73ac" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated">数据库成为单点故障让我很不舒服，我一直在探索HA Postgres设置的选项。看起来好像管理容错数据库集群本身就是一项全职的系统管理工作。我查看了“付钱给别人做”选项。他们受到我预算紧张的限制。举例来说，我负担不起<a class="ae jp" href="https://www.heroku.com/postgres" rel="noopener ugc nofollow" target="_blank">与HA的Heroku Postgres </a>，因为它的起价是200美元/月。经过深思熟虑，我决定选择<a class="ae jp" href="https://www.compose.com/" rel="noopener ugc nofollow" target="_blank"> compose.io </a>。理论上，他们的规格和价格看起来不错，我用生产数据快照测试了他们的服务(但不是生产级别的流量！)我甚至亲眼目睹了他们的故障转移过程。在故障转移期间，数据库有几分钟不可用，但它确实恢复了，并且在没有我干预的情况下继续工作。</p><p id="6397" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">向compose.io的迁移并不顺利。在我将生产流量指向新数据库之后，我很快就开始看到各种关于数据库连接问题的哨兵报告。compose.io支持人员告诉我，我的数据库内存不足，并建议扩展它的RAM分配。使用他们方便的缩放滑块，我将RAM分配<em class="kq">和</em>增加了一个数量级。这样做之后，我发现数据库连接减少了，但是仍然相当正常。此时我在想:</p><ul class=""><li id="8cf7" class="kr ks hu it b iu iv iy iz jc kt jg ku jk kv jo kw kx ky kz dt translated">收到用户的投诉</li><li id="daf5" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo kw kx ky kz dt translated">晚上每隔3个小时左右醒来检查一下服务</li><li id="06a3" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo kw kx ky kz dt translated">支付比原计划多得多的费用</li><li id="1ff9" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo kw kx ky kz dt translated">没有从compose.io支持部门获得关于如何解决我的连接问题的可行建议</li></ul><h2 id="6450" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">利诺德</h2><p id="6f59" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated">如果有足够的时间使用tcpdump和WireShark，我可能已经解决了掉线问题。但我需要尽快解决问题。我放弃了HA需求，将数据库移回普通VPS。这次我和Linode一起去有两个原因:</p><ul class=""><li id="cf6b" class="kr ks hu it b iu iv iy iz jc kt jg ku jk kv jo kw kx ky kz dt translated">它的定价比DigitalOcean稍好。</li><li id="563e" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo kw kx ky kz dt translated">我打算使用TLS终端负载平衡器。数字海洋<em class="kq">刚刚</em>推出他们的。Linode的节点平衡器已经存在了一段时间，似乎是一个更安全的选择。而且，他们支持IPv6，不支持。</li></ul><p id="a78f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我更新了我的部署脚本，制定了一个迁移计划，做了一些测试，睡了一觉，然后迁移到Linode。错误报告停止了，我每月的账单又有了着落。但是数据库又一次成为单点故障。好的一面是，我现在正在对传入的HTTP请求进行负载平衡，我的服务可以容忍web服务器节点的丢失。</p><p id="4e40" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">hchk.io收到的流量是突发的。平均来说，它每秒接收大约30个请求，但是每五分钟有一个短暂的流量峰值(一次数百个请求)，每一个小时有一个更大的峰值，并且在每个午夜(UTC)有一段时间请求率升高。</p><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff lf"><img src="../Images/6f05e6d181b426ec202c237b8c726c74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4AoLVWZU5D28QHBjuNVhSg.png"/></div></div><figcaption class="lr ls fg fe ff lt lu bd b be z ek">Traffic spikes, as seen from Postgres</figcaption></figure><p id="f6ae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">hchk.io流量也不同寻常，因为每个请求都是“一次性的”,需要进行全新的TLS握手。我了解到单个节点平衡器每秒只能进行大约200次TLS握手。在流量高峰期间，负载均衡器成为瓶颈。请求有时需要3秒以上才能完成。使用积极超时设置的客户端会将它们视为失败的请求。权宜之计是添加第二个负载平衡器，并使用循环DNS在两者之间分配流量。</p><p id="3013" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我还了解到DigitalOcean的负载平衡器与Linode的TLS握手性能相似，所以它们也不好。进一步观察，我发现谷歌的<a class="ae jp" href="https://cloud.google.com/load-balancing/" rel="noopener ugc nofollow" target="_blank">云负载平衡器</a>可以处理我能扔给它的尽可能多的握手。而且它支持IPv6，尽管还处于alpha预览状态！所以我开始策划向谷歌云平台转移。</p><h2 id="2294" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">谷歌云平台</h2><p id="d9c6" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated">我再次经历了迁移过程，从2017年5月4日开始，healthchecks.io一直在谷歌云平台上运行。当前设置是:</p><ul class=""><li id="5e5d" class="kr ks hu it b iu iv iy iz jc kt jg ku jk kv jo kw kx ky kz dt translated">托管云SQL数据库。云SQL上的Postgres目前处于测试阶段，他们还没有高可用性选项，但希望未来会有</li><li id="4500" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo kw kx ky kz dt translated">三台应用服务器，由我的普通结构脚本提供</li><li id="4147" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo kw kx ky kz dt translated">谷歌的云负载平衡器在三个应用服务器之间分配流量</li></ul><p id="13bc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我用谷歌的托管版Kubernetes——GKE进行了试验，但最终选择保持简单明了:简单的虚拟机和简单的Fabric命令来完成各种管理任务。</p><p id="d868" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当我开始探索谷歌云平台的日志工具时，我遇到了关于来自负载均衡器的“502坏网关”日志消息。它们很少出现，所以需要很长时间来排除故障(进行配置更改—监控日志几天，看看错误是否消失—重复)，但我谨慎乐观地认为这些问题现在已经永久解决了。简而言之，我必须调整许多sysctl参数和nginx选项，这样我的应用服务器才能正确处理新连接的突发。以下资源很有帮助:</p><ul class=""><li id="dbb6" class="kr ks hu it b iu iv iy iz jc kt jg ku jk kv jo kw kx ky kz dt translated"><a class="ae jp" href="https://cloud.google.com/compute/docs/troubleshooting#communicatewithinternet" rel="noopener ugc nofollow" target="_blank">计算引擎:提示，故障排除&amp;已知问题</a></li><li id="cf75" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo kw kx ky kz dt translated"><a class="ae jp" href="https://blog.percy.io/tuning-nginx-behind-google-cloud-platform-http-s-load-balancer-305982ddb340" rel="noopener ugc nofollow" target="_blank">调优Google云平台HTTP(S)负载均衡器背后的NGINX】</a></li><li id="fe8e" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo kw kx ky kz dt translated"><a class="ae jp" href="https://tweaked.io/guide/kernel/" rel="noopener ugc nofollow" target="_blank">优化服务器——调优GNU/Linux内核</a></li><li id="a29b" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo kw kx ky kz dt translated"><a class="ae jp" href="https://www.nginx.com/blog/tuning-nginx/" rel="noopener ugc nofollow" target="_blank">针对性能调整NGINX】</a></li></ul><p id="d042" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了更新应用服务器上的代码，我使用了“滚动更新”模式:将一个应用服务器从负载均衡器循环中取出，更新它，将其放回循环中，然后移动到下一个应用服务器。以下是单台服务器的流程概述:</p><pre class="lg lh li lj fq lv lw lx ly aw lz dt"><span id="47c6" class="jq jr hu lw b fv ma mb l mc md">def update():<br/> # Going down...<br/> maintenance_on()<br/> stop_sendalerts()<br/> stop_sendreports()<br/> print("sleeping for 120s")<br/> # Wait for load balancer to fail us<br/> time.sleep(120)</span><span id="00f9" class="jq jr hu lw b fv me mb l mc md"> # Actual update<br/> www()<br/> hchk()<br/> nginx()</span><span id="2d44" class="jq jr hu lw b fv me mb l mc md"> # Coming up...<br/> print("sleeping for 30s")<br/> time.sleep(30)<br/> maintenance_off()<br/> start_sendalerts()<br/> start_sendreports()<br/> print("sleeping for 120s")<br/> # Wait for load balancer to declare us healthy<br/> time.sleep(120)</span></pre><p id="cc6f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">maintenance_on()将服务器置于“维护模式”。在维护模式下，服务器仍然可以处理传入的请求，但它开始向负载平衡器报告自己不正常，负载平衡器逐渐将流量从它那里转移出去。负载平衡器需要一段时间来更新，因此脚本在继续更新和重新启动之前会等待120秒。完整的更新需要一些时间，但是对最终用户来说是完全透明的…只要我没有部署向后不兼容的数据库模式更改！</p><p id="67d7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这就是healthchecks.io现在所在的位置。页面加载时间很短。负载平衡器日志中没有5xx错误(交叉手指！).该数据库目前<em class="kq">不具备</em>容错能力，但希望将来会有所改变。谷歌每月的账单在150-200美元之间。</p><h2 id="275d" class="jq jr hu bd js jt ju jv jw jx jy jz ka jc kb kc kd jg ke kf kg jk kh ki kj kk dt translated">经验教训</h2><p id="3b9c" class="pw-post-body-paragraph ir is hu it b iu kl iw ix iy km ja jb jc kn je jf jg ko ji jj jk kp jm jn jo hn dt translated">在评估产品或服务时，必须用生产级别的工作负载对其进行测试。我从compose.io的惨败中学到了这一点，当我达到NodeBalancer的容量极限时也是如此。</p><p id="0295" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我经常能自己解决的简单问题。当我需要帮助解决更困难的问题，并尝试联系支持时，可以说，我得到了我所支付的:</p><ul class=""><li id="1c9b" class="kr ks hu it b iu iv iy iz jc kt jg ku jk kv jo kw kx ky kz dt translated">来自compose.io支持的回复和<a class="ae jp" href="https://www.youtube.com/watch?v=NbESKH0t0zs&amp;feature=youtu.be&amp;t=15" rel="noopener ugc nofollow" target="_blank"> Richmond关于闪光灯的评论</a>一样有用。</li><li id="86af" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo kw kx ky kz dt translated">谷歌单独收取支持费用。白银计划的起价为150美元/月。</li><li id="20bc" class="kr ks hu it b iu la iy lb jc lc jg ld jk le jo kw kx ky kz dt translated">关于节点平衡器的局限性，Linode给了我一个直截了当的回答，对此我表示感谢。</li></ul><p id="1f55" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，当我在寻找解决方案时，我探索了许多工具和技术，但最终都没有使用。它们都进入了“锦囊妙计”，在未来的项目中可能会有用。</p><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff mf"><img src="../Images/7d8eee5cbefa46d96d45f11edc6c5177.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3tJAU3MjXQNGS49wkWVXGA.jpeg"/></div></div><figcaption class="lr ls fg fe ff lt lu bd b be z ek">Meet the healthchecks.io Ops Team!</figcaption></figure><p id="47d3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就这样，感谢阅读！而且，如果您还没有监视您的cron作业和后台任务的静默故障，我欢迎您查看<a class="ae jp" href="https://healthchecks.io/" rel="noopener ugc nofollow" target="_blank"> healthchecks.io </a>！</p><p id="d343" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">—p teris Caune，健康检查. io</p><div class="lg lh li lj fq ab cb"><figure class="mg lk mh mi mj mk ml paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mg lk mh mi mj mk ml paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mg lk mh mi mj mk ml paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mm mn mo"><p id="f922" class="ir is kq it b iu iv iw ix iy iz ja jb mp jd je jf mq jh ji jj mr jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is kq it b iu iv iw ix iy iz ja jb mp jd je jf mq jh ji jj mr jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lg lh li lj fq lk fe ff paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="fe ff ms"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>