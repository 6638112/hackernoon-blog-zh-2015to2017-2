<html>
<head>
<title>Handy R Markdown Hacks for email</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">方便的R Markdown电子邮件黑客</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/handy-r-markdown-hacks-e53b2bec956e?source=collection_archive---------1-----------------------#2016-09-12">https://medium.com/hackernoon/handy-r-markdown-hacks-e53b2bec956e?source=collection_archive---------1-----------------------#2016-09-12</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/ca3ef76e7c2dc8c88b34b710ad346fbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/1*gYQhlM7v6GyRuxaL8JtPIQ.png"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek"><strong class="bd jc">R markdown is awesome, but hacks are needed</strong></figcaption></figure><p id="c13f" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">我喜欢R和R降价。但是当我使用Rmd生成HTML电子邮件报告时，使用了如下简单的东西:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="75d7" class="kl km hu kh b fv kn ko l kp kq">rmd="my_report"</span><span id="f993" class="kl km hu kh b fv kr ko l kp kq">Rscript --vanilla -e "require(knitr); rmarkdown::render('$rmd.Rmd',params=list() )"</span><span id="59f8" class="kl km hu kh b fv kr ko l kp kq">cat $rmd.html | mail -a "From: <a class="ae kb" href="mailto:fromemail@server.com" rel="noopener ugc nofollow" target="_blank">fromemail@servername.com</a>" -a "MIME-Version: 1.0" -a "Content-Type: text/html" -s "$subject" $recip</span></pre><p id="d4e4" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">…我遇到了一些障碍。</p><p id="8212" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">以下是问题和解决方案或解决它们的方法。希望他们帮到你！</p><h1 id="aaca" class="ks km hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">通过电子邮件发送地块</h1><p id="072d" class="pw-post-body-paragraph jd je hu jf b jg lp ji jj jk lq jm jn jo lr jq jr js ls ju jv jw lt jy jz ka hn dt translated">我希望我的Rmd HTML报告的收件人可以在他们的电子邮件客户端查看它们。但是电子邮件客户端通常不喜欢嵌入base64字符串的图像。另一个选择是将图像保存在服务器上。但是怎么做呢？</p><p id="1dd3" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated"><strong class="jf hv">解决方案:</strong>将图片移动到一个公共的web文件夹中，并用bash和trusty coreutils重写图片链接。由于此报告可能有多个版本，请使用按确切报告时间命名的文件夹:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="b80f" class="kl km hu kh b fv kn ko l kp kq">#folder named by timestamp<br/>dt=`date +"%Y-%m-%d--%H-%M-%S-%N"`</span><span id="87de" class="kl km hu kh b fv kr ko l kp kq"># move external files<br/>mkdir /var/www/report_cache/$dt<br/>cp -r ${rmd}_files /var/www/report_cache_folder/$dt</span><span id="43b6" class="kl km hu kh b fv kr ko l kp kq"># rewrite image links<br/>cat $rmd.html | sed "s/img src=\"/img src=\"https:\/\/servername.com\/report_cache_folder\/$dt\//g" &gt; rw_$rmd.html</span></pre><p id="4462" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">现在，所有的图片都由公共的<a class="ae kb" href="https://hackernoon.com/tagged/webserver" rel="noopener ugc nofollow" target="_blank">网络服务器</a>提供，因此电子邮件客户端可以访问。</p><h1 id="a3e5" class="ks km hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">纲领性标题</h1><p id="ce15" class="pw-post-body-paragraph jd je hu jf b jg lp ji jj jk lq jm jn jo lr jq jr js ls ju jv jw lt jy jz ka hn dt translated">我想要数据驱动的标题和图表，但事先不知道会有多少。我发现pandoc.header限制太多，因为你必须在chunk选项中预先声明results='asis ',这完全限制了你在R块中可以做的事情。</p><p id="432d" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">现在，如果您在没有results='asis '的情况下调用pandoc.header("My pandoc header "，2)，您会在输出中得到如下内容:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="d005" class="kl km hu kh b fv kn ko l kp kq">## ## My pandoc header</span></pre><p id="93c9" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">…如果你在HTML中查找，它被<pre>和<code>标签包围着。其未处理的<a class="ae kb" href="https://hackernoon.com/tagged/markdown" rel="noopener ugc nofollow" target="_blank"> markdown </a>头，前缀为“##”。</code></pre></p><p id="dd1d" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated"><strong class="jf hv">解决方案:</strong>使用htmltools从R块中动态生成头(不需要结果=‘asis’):</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="896f" class="kl km hu kh b fv kn ko l kp kq">library(htmltools)</span><span id="513a" class="kl km hu kh b fv kr ko l kp kq">```{r echo=FALSE}</span><span id="b807" class="kl km hu kh b fv kr ko l kp kq">h1("main heading")<br/>h2("smaller heading")</span><span id="82f6" class="kl km hu kh b fv kr ko l kp kq">```</span></pre><p id="dd9d" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated"><strong class="jf hv">注意事项:</strong>新标题是缩进的，不像那些通过markdown直接生成的标题，它们不会出现在目录中。我只是确保有“常规的”高级标题，这样看起来就不会奇怪。</p><h1 id="fb73" class="ks km hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">电子邮件的内嵌样式</h1><p id="bba9" class="pw-post-body-paragraph jd je hu jf b jg lp ji jj jk lq jm jn jo lr jq jr js ls ju jv jw lt jy jz ka hn dt translated">我对R markdown提供的默认样式不太满意，尤其是表格。</p><p id="503a" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">现在我提到，对于电子邮件客户端，我们不希望图像数据直接内嵌。但是相比之下，为了让电子邮件客户端呈现样式，我们需要内嵌CSS。</p><p id="2828" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated"><strong class="jf hv">解决方案:</strong>使用python <a class="ae kb" href="https://pypi.python.org/pypi/premailer" rel="noopener ugc nofollow" target="_blank"> premailer </a>内联样式。然后unicode出现了一个问题，用PYTHONIOENCODING纠正了这个问题，如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="90df" class="kl km hu kh b fv kn ko l kp kq">cat rw2_$rmd.html  |  PYTHONIOENCODING=UTF-8  python -m premailer | mail -a "From: <a class="ae kb" href="mailto:fromemail@server.com" rel="noopener ugc nofollow" target="_blank">fromemail@server.com</a>" -a "MIME-Version: 1.0" -a "Content-Type: text/html" -s "$subject" $recip</span></pre><h1 id="6be6" class="ks km hu bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo dt translated">可重复使用的样式</h1><p id="e5bc" class="pw-post-body-paragraph jd je hu jf b jg lp ji jj jk lq jm jn jo lr jq jr js ls ju jv jw lt jy jz ka hn dt translated">我有多个报告，我想使用相同的风格。所以我在每个Rmd文件的顶部都有这样的内容:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="9ecc" class="kl km hu kh b fv kn ko l kp kq">&lt;STYLE TYPE="text/css"&gt;<br/>  td{<br/>    font-size: 8pt;<br/>  }<br/>  th {<br/>    font-size: 8pt;<br/>  }<br/>&lt;/STYLE&gt;</span></pre><p id="5f07" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">现在我们怎么把它弄干？</p><p id="a023" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated"><strong class="jf hv">解决方案:</strong>把上面的CSS放到样式里就可以了。Rmd，然后包括每个报告中文件，如下所示:</p><pre class="kc kd ke kf fq kg kh ki kj aw kk dt"><span id="cdd9" class="kl km hu kh b fv kn ko l kp kq">```{r child = 'styles.Rmd'}<br/>```</span></pre><p id="859e" class="pw-post-body-paragraph jd je hu jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hn dt translated">(好吧，这个问题不算是黑客，但我发现这个问题很难用书籍或谷歌来解决，而且它在许多其他情况下也很有用。)</p><figure class="kc kd ke kf fq iv fe ff paragraph-image"><div class="fe ff lu"><img src="../Images/f97aa8a0a37d89cb8ce472be6fc53c0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:636/format:webp/1*0PPrjNRwflcHg2FdFdwVBw.jpeg"/></div><figcaption class="iy iz fg fe ff ja jb bd b be z ek"><strong class="bd jc">After putting all these hacks together, I finally had lovely Rmd email reports</strong></figcaption></figure><div class="kc kd ke kf fq ab cb"><figure class="lv iv lw lx ly lz ma paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="lv iv lw lx ly lz ma paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="lv iv lw lx ly lz ma paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mb mc md"><p id="f922" class="jd je me jf b jg jh ji jj jk jl jm jn mf jp jq jr mg jt ju jv mh jx jy jz ka hn dt translated"><a class="ae kb" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae kb" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae kb" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae kb" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jd je me jf b jg jh ji jj jk jl jm jn mf jp jq jr mg jt ju jv mh jx jy jz ka hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kb" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kb" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kc kd ke kf fq iv fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff mi"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure></div></div>    
</body>
</html>