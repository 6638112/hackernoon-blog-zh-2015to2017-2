<html>
<head>
<title>Kubernetes, Ingress controllers and Traefik</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes、入口控制器和Traefik</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/kubernetes-ingress-controllers-and-traefik-a32648a4ae95?source=collection_archive---------0-----------------------#2016-10-21">https://medium.com/hackernoon/kubernetes-ingress-controllers-and-traefik-a32648a4ae95?source=collection_archive---------0-----------------------#2016-10-21</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="4040" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当在一个编排工具(如Kubernetes或Mesos with Marathon)上运行您的应用程序服务时，您需要满足一些常见的需求。您的应用程序通常包含两种类型的服务，一种是应该只能从集群内部看到的服务，另一种是您希望向外部世界公开的服务，在您的集群之外，可能会向<a class="ae jp" href="https://hackernoon.com/tagged/internet" rel="noopener ugc nofollow" target="_blank"> internet </a>(例如前端)公开。</p><p id="df2c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本文将关注如何在Kubernetes上实现这一点。在创建新的<a class="ae jp" href="https://hackernoon.com/tagged/service" rel="noopener ugc nofollow" target="_blank">服务</a>时，您可以利用Kubernetes为您提供的不同服务类型来实现您想要的。</p><ul class=""><li id="ceac" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated">ClusterIP:这是默认值。选择此值意味着您希望此服务只能从群集内部访问。</li><li id="ee0e" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">ExternalName:这是一种将别名返回到位于集群外部的外部服务的方法。</li><li id="c422" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">NodePort:在集群的每个节点上的一个端口上公开服务。</li><li id="42a2" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">负载平衡器:除了拥有一个集群内部IP和在一个节点端口上公开服务之外，还要向云提供商请求一个负载平衡器，它将请求转发给每个节点的公开为:NodePort的服务。如果云提供商不支持该功能，该字段将被忽略。</li></ul><p id="ad66" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，如果您的云不支持“负载平衡器”(例如，您运行本地私有云)，并且您需要比在集群的每个节点上公开端口更复杂的东西，那么过去您需要构建自己的定制解决方案。幸运的是，这不再是真的。</p><p id="b018" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">自从<a class="ae jp" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md#v120" rel="noopener ugc nofollow" target="_blank"> Kubernetes v1.2.0 </a>以来，您可以使用<a class="ae jp" href="http://kubernetes.io/docs/user-guide/ingress/" rel="noopener ugc nofollow" target="_blank"> Kubernetes ingress </a>，它支持TLS和L7基于http的流量路由。</p><p id="3319" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="ke">你也可以问</em><a class="ae jp" href="http://kuwit.io/" rel="noopener ugc nofollow" target="_blank"><em class="ke">Kuwit</em></a><em class="ke">“我如何向外部世界公开服务？”无论何时你需要记住这一点；-) </em></p><p id="f929" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">入口是允许入站连接到达群集服务的规则集合。它可以被配置为向服务提供外部可达的URL、负载平衡流量、终止SSL、提供基于名称的虚拟主机等。用户通过向API服务器发布入口资源来请求入口。</p><p id="052a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了让入口资源工作，群集必须运行入口控制器。入口控制器负责通过监视ApiServer的/ingresses端点来动态实现入口。</p><p id="0bc3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是得心应手！现在，您可以更进一步，在运行入口控制器的基础架构级别进行隔离，并将其视为“边缘路由器”,为您的集群实施防火墙策略。HA Kubernetes集群的情况如下所示:</p><figure class="kg kh ki kj fq kk fe ff paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="fe ff kf"><img src="../Images/2b4dd4735c6c85b874b8d82409f14be6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_ArjfIk34Op6qQWoYCPhOA.png"/></div></div></figure><p id="4da8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们将展示如何使用<a class="ae jp" href="https://traefik.io/" rel="noopener ugc nofollow" target="_blank"> Traefik </a>来达到这个目的。Traefik是一个现代的HTTP反向代理和负载平衡器，用于轻松部署微服务。它支持Mesos/Marathon和Kubernetes之间的几个后端，以自动和动态地管理其配置。</p><p id="be96" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们将部署一个类似于上图的Kubernetes集群，并将Traefik作为<a class="ae jp" href="http://kubernetes.io/docs/admin/daemons/" rel="noopener ugc nofollow" target="_blank"> DaemonSet </a>运行。</p><pre class="kg kh ki kj fq kr ks kt ku aw kv dt"><span id="e5c4" class="kw kx hu ks b fv ky kz l la lb"><strong class="ks hv">apiVersion: extensions/v1beta1<br/>kind: DaemonSet<br/>metadata:<br/>  name: traefik-ingress-controller-v1<br/>  namespace: kube-system<br/>  labels:<br/>    k8s-app: traefik-ingress-lb<br/>    kubernetes.io/cluster-service: "true"<br/>spec:<br/>  template:<br/>    metadata:<br/>      labels:<br/>        k8s-app: traefik-ingress-lb<br/>        name: traefik-ingress-lb<br/>    spec:<br/>      terminationGracePeriodSeconds: 60<br/>      containers:<br/>      - image: containous/traefik<br/>        name: traefik-ingress-lb<br/>        imagePullPolicy: Always<br/>        ports:<br/>          - containerPort: 80<br/>            hostPort: 80<br/>          - containerPort: 443<br/>            hostPort: 443<br/>          - containerPort: 8080<br/>            hostPort: 8080<br/>        volumeMounts:<br/>          - mountPath: /etc/traefik<br/>            name: traefik-volume<br/>            readOnly: false<br/>        args:<br/>        - --web<br/>        - --kubernetes<br/>        - --configFile=/etc/traefik/traefik.toml<br/>        - --logLevel=DEBUG<br/>      volumes:<br/>        - hostPath:<br/>            path: /etc/traefik<br/>          name: traefik-volume<br/>      nodeSelector:<br/>        role: edge-router</strong></span></pre><p id="5a07" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里的源代码是<a class="ae jp" href="https://github.com/Capgemini/kubeform/blob/master/roles/addons/files/traefik-ingress-controller.yaml" rel="noopener ugc nofollow" target="_blank">这里是</a></p><p id="4113" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://docs.traefik.io/toml/#acme-lets-encrypt-configuration" rel="noopener ugc nofollow" target="_blank">您可以配置Traefik使用自动TLS配置来按需提供服务</a>。</p><p id="ea17" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们的边缘路由器将只是另一个有一些限制的Kubernetes节点。</p><p id="895a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们不希望任何其他pod被调度到这个节点，所以我们在运行<a class="ae jp" href="http://kubernetes.io/docs/admin/kubelet/" rel="noopener ugc nofollow" target="_blank"> kubelet </a>时设置<code class="eh lc ld le ks b"><strong class="it hv">--register-schedulable=false</strong></code>，并给它一个方便的标签:<code class="eh lc ld le ks b"><strong class="it hv">--node-labels=edge-router</strong></code>。</p><p id="8f15" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Kubernetes将在集群的每个节点上运行DaemonSets，即使它们是不可调度的。我们只希望这个DaemonSet在边缘路由器节点上运行，所以我们使用“nodeSelector”来匹配我们之前添加的标签。</p><pre class="kg kh ki kj fq kr ks kt ku aw kv dt"><span id="1464" class="kw kx hu ks b fv ky kz l la lb"><strong class="ks hv">nodeSelector:<br/>  role: edge-router</strong></span></pre><p id="10c3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">请注意，使用这种方法，如果您想要向集群添加一个新的边缘路由器，您只需启动一个带有该标签的新节点，一个新的DaemonSet就会自动调度到该机器。不错！</p><p id="bc0f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是一个视频演示，展示了使用两种不同的云(DigitalOcean和AWS)部署两个Kubernetes集群的情况:</p><figure class="kg kh ki kj fq kk"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="60cc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最近我在<a class="ae jp" href="http://slack.k8s.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes slack </a>上看到很多用户在与入口控制器通信时遇到问题。这通常是由于一个已知的问题。</p><p id="7963" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">入口控制器可能想要使用<a class="ae jp" href="http://kubernetes.io/docs/api-reference/v1/definitions/#_v1_pod" rel="noopener ugc nofollow" target="_blank">主机端口</a>来暴露自己。</p><pre class="kg kh ki kj fq kr ks kt ku aw kv dt"><span id="2f8c" class="kw kx hu ks b fv ky kz l la lb"><strong class="ks hv">ports:<br/>  - containerPort: 80<br/>	hostPort: 80<br/>  - containerPort: 443<br/>	hostPort: 443</strong></span></pre><p id="82b2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您使用<a class="ae jp" href="https://github.com/containernetworking/cni" rel="noopener ugc nofollow" target="_blank"> CNI </a> <a class="ae jp" href="http://kubernetes.io/docs/admin/network-plugins/" rel="noopener ugc nofollow" target="_blank">网络插件</a>进行集群联网，主机端口尚不支持。</p><p id="84ea" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以在此处跟踪此问题的当前状态:</p><div class="lh li fm fo lj lk"><a href="https://github.com/kubernetes/kubernetes/issues/23920" rel="noopener  ugc nofollow" target="_blank"><div class="ll ab ej"><div class="lm ab ln cl cj lo"><h2 class="bd hv fv z el lp eo ep lq er et ht dt translated">主机端口似乎不工作问题#23920 kubernetes/kubernetes</h2><div class="lr l"><h3 class="bd b fv z el lp eo ep lq er et ek translated">我不确定我正在做的事情是否会奏效。但是我已经创建了以下pod: apiVersion: v1 kind: Pod…</h3></div><div class="ls l"><p class="bd b gc z el lp eo ep lq er et ek translated">github.com</p></div></div><div class="lt l"><div class="lu l lv lw lx lt ly kp lk"/></div></div></a></div><p id="e466" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">【https://github.com/kubernetes/kubernetes/issues/31307 T4】</p><p id="501e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://github.com/kubernetes/kubernetes/issues/23920" rel="noopener ugc nofollow" target="_blank">https://github.com/containernetworking/cni/issues/46</a></p><p id="b8ad" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">目前，潜在的解决方法是使用“主机网络”或使用前面提到的“节点端口”运行服务，以匹配作为DaemonSet运行的入口控制器。</p><p id="10d2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">希望这篇文章能让你对如何在Kubernetes上公开服务以及入口控制器的好处有所了解。</p><p id="37d0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这篇文章也发表在<a class="ae jp" href="https://capgemini.github.io/kubernetes/kube-traefik/" rel="noopener ugc nofollow" target="_blank">凯捷工程博客</a>上</p><div class="kg kh ki kj fq ab cb"><figure class="lz kk ma mb mc md me paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="lz kk ma mb mc md me paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="lz kk ma mb mc md me paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mf mg mh"><p id="f922" class="ir is ke it b iu iv iw ix iy iz ja jb mi jd je jf mj jh ji jj mk jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是阿妹家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is ke it b iu iv iw ix iy iz ja jb mi jd je jf mj jh ji jj mk jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kg kh ki kj fq kk fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff ml"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure><figure class="kg kh ki kj fq kk"><div class="bz el l di"><div class="mm lg l"/></div></figure></div></div>    
</body>
</html>