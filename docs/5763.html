<html>
<head>
<title>Start a Premium Content Business Using Node.js, React and Cosmic JS Extensions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Node.js、React和Cosmic JS扩展开始优质内容业务</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/start-a-premium-content-business-using-node-js-react-and-cosmic-js-extensions-8b5abe08ce59?source=collection_archive---------9-----------------------#2017-08-15">https://medium.com/hackernoon/start-a-premium-content-business-using-node-js-react-and-cosmic-js-extensions-8b5abe08ce59?source=collection_archive---------9-----------------------#2017-08-15</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/de2bfa72d960a909e60e761bc4a3cf86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_aAbFp-zaWY0gcVkBLul1g.jpeg"/></div></div></figure><h1 id="a196" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">TL；速度三角形定位法(dead reckoning)</h1><p id="2e03" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated"><a class="ae ky" href="https://cosmicjs.com/apps/premium-content-blog/demo" rel="noopener ugc nofollow" target="_blank">查看演示</a> <br/> <a class="ae ky" href="https://github.com/cosmicjs/premium-content-blog" rel="noopener ugc nofollow" target="_blank">查看源代码</a> <br/> <a class="ae ky" href="https://cosmicjs.com/apps/premium-content-blog" rel="noopener ugc nofollow" target="_blank">安装优质内容博客</a></p><p id="1927" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">你有很棒的想法。你的头脑中充满了你知道人们会付费阅读的内容。那么你从哪里开始呢？你可能倾向于选择一个像Wordpress这样的可信平台，但是因为你想为你的用户提供付费内容，你现在面临的问题是如何使一个麻烦的解决方案更加麻烦。</p><p id="ed4c" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">我们想要一个简单、直接的解决方案，功能不超过我们的需要，而不是调整一个平台来为我们工作。当然，这意味着我们要自己建造它。</p><p id="6c1f" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">本着简单、直接的解决方案的精神，我们将使用<a class="ae ky" href="https://cosmicjs.com" rel="noopener ugc nofollow" target="_blank"> Cosmic JS </a>来托管我们的博客，管理它的用户，并存储它的内容。</p><p id="00f2" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">我们的项目将分为两部分。首先，我们将使用Express和Cosmic JS构建我们的博客，并使用Stripe处理博客的支付和订阅。然后，我们将利用Cosmic JS的扩展特性来构建一个仪表板，让我们了解我们业务的后端。</p><h1 id="9af9" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">第1部分:构建博客</h1><h1 id="6b72" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">1.样板设置</h1><p id="1486" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">为了节省样板文件的时间，我们将使用Yeoman和Express Generator(构建在Express的“官方生成器”上)来开始。如果你没有安装Yeoman，运行<code class="eh lf lg lh li b">npm i -g yo</code>。然后用<code class="eh lf lg lh li b">npm i -g generator-express</code>安装发电机，用<code class="eh lf lg lh li b">yo express</code>运行发电机。按照说明在一个新目录下建立你的项目(比如说<code class="eh lf lg lh li b">CosmicUserBlog</code>，安装<em class="le">基础</em>版本，并为你的视图引擎使用手柄。</p><p id="4a53" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">您的目录结构现在如下:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="3484" class="lr jd hu li b fv ls lt l lu lv">CosmicUserBlog<br/>| <br/>|--bin<br/>|   |--www<br/>|--(node_modules)<br/>|--public<br/>|--routes<br/>|    |--users.js<br/>     |--index.js<br/>|--views<br/>     |--layouts<br/>     |--partials<br/>     |--error.handlebars<br/>     |--index.handlebars<br/>|--.bowerrc<br/>|--.gitignore<br/>|--app.js<br/>|--bower.json<br/>|--gruntfile.js<br/>|--package.json</span></pre><h1 id="2cec" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">2.装置</h1><p id="fc3d" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">我们将使用以下软件包:</p><ul class=""><li id="92bb" class="lw lx hu kc b kd kz kh la kl ly kp lz kt ma kx mb mc md me dt translated">async——一个强大的异步实用程序库</li><li id="8860" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">axios——简单、基于承诺的http请求</li><li id="789d" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">Cors——标准CORS中间件</li><li id="203f" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">brcypt —用于密码哈希。(如果你在Windows上，请阅读这些注释<a class="ae ky" href="https://www.npmjs.com/package/bcrypt#dependencies" rel="noopener ugc nofollow" target="_blank"/></li><li id="484b" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">CosmicJs —官方客户</li><li id="a96b" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">快速会话—以便我们的用户可以登录</li><li id="16f8" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">date format——我们将在文章中使用的直观的日期格式化程序</li><li id="2a01" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">Stripe —官方客户端</li><li id="39f1" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">TruncateHTML —用于帖子简介</li></ul><p id="0c8f" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">你可以用npm安装这些，但我主张用纱线。它明显更快，我们没有时间浪费。所以安装Yarn(在macOS上我们会做一个<code class="eh lf lg lh li b">brew install yarn</code>)然后运行<code class="eh lf lg lh li b">yarn add async axios cors bcrypt cosmicjs expres-session dateformat stripe truncate-html</code>。我们差不多准备好开始建造了。</p><h1 id="f8c9" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">3.设置宇宙JS</h1><p id="7eef" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">在我们开始构建之前，我们需要为我们的宇宙桶设计出模式。我们想要存储<code class="eh lf lg lh li b">Posts</code>、<code class="eh lf lg lh li b">Users</code>和<code class="eh lf lg lh li b">Configs</code>(以动态编辑站点配置)。</p><p id="3559" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">这三种对象类型将具有以下元数据字段(都是类型<em class="le">文本</em>，由它们的<em class="le">标题</em>给出):</p><h2 id="37e4" class="lr jd hu bd je mk ml mm ji mn mo mp jm kl mq mr jq kp ms mt ju kt mu mv jy mw dt translated">帖子:</h2><p id="f108" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">MetafieldValuePremium <strong class="kc hv">真</strong>或<strong class="kc hv">假</strong></p><h2 id="83fe" class="lr jd hu bd je mk ml mm ji mn mo mp jm kl mq mr jq kp ms mt ju kt mu mv jy mw dt translated">用户:</h2><p id="d1de" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">MetafieldValueFirst name string last name string password hashed string mailstring stripe idstring subscription Typestring</p><h2 id="7802" class="lr jd hu bd je mk ml mm ji mn mo mp jm kl mq mr jq kp ms mt ju kt mu mv jy mw dt translated">配置:</h2><p id="3263" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated"><strong class="kc hv">对象:订阅</strong>:| Metafield | Value | |————————————————:| |月价格|字符串|季度价格|字符串| |年价格|字符串| |取消|字符串|</p><p id="843d" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">对象:站点</strong>:| Metafield | Value | |—|——|——: | |站点标题|字符串| |域|字符串|</p><p id="200c" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">一旦您添加了您的<code class="eh lf lg lh li b">Post</code>、<code class="eh lf lg lh li b">User</code>和<code class="eh lf lg lh li b">Config</code>对象类型，并创建了您的<code class="eh lf lg lh li b">Subscriptions</code>和<code class="eh lf lg lh li b">Site</code>配置对象，我们就可以用Stripe进行设置了。</p><h1 id="ebce" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">4.配置条带</h1><p id="cdf4" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">由于我们将向用户收取额外费用，我们需要一个支付处理器。凭借强大的API、公平的现收现付价格和经过验证的安全性，使用Stripe是显而易见的。接下来，我们将需要Stripe API的“可发布”和“秘密”密钥，并且我们需要为每月、每年和每季度订阅设置订阅计划。按照Stripe的说明创建这些订阅，并相应地为他们提供ID的<em class="le">订阅-每月</em>、<em class="le">订阅-每季度</em>和<em class="le">订阅-每年</em>。</p><h1 id="b80b" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">5.配置快速应用程序</h1><p id="c134" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">我们已经安装了我们的软件包，制定了我们的数据模式，并且我们已经建立了一个Stripe帐户。现在我们需要配置我们的Express后端。</p><p id="35ee" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">样板Express代码是pre-ES5，所以为了保持一致的风格，我们将<code class="eh lf lg lh li b">require</code>我们需要的包。</p><p id="921c" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">在快速应用程序的顶部添加:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="d3a6" class="lr jd hu li b fv ls lt l lu lv">// app.js<br/>var session = require('express-session')<br/>var dateFormat = require('date-format')<br/>var truncate = require('truncate-html')<br/>var cors = require('cors')</span></pre><p id="a661" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">当我们部署我们的应用程序时，Cosmic JS将提供我们的桶密钥以及我们通过<code class="eh lf lg lh li b">process.env</code>提供的任何自定义密钥。在require语句下面，继续将它们存储在<code class="eh lf lg lh li b">app.locals</code>中，使它们在整个应用程序中都可以访问</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="9493" class="lr jd hu li b fv ls lt l lu lv">//app.js</span><span id="fca6" class="lr jd hu li b fv mx lt l lu lv">var config = {<br/>    bucket: {<br/>        slug: process.env.COSMIC_BUCKET,<br/>     read_key: process.env.COSMIC_READ_KEY,<br/>      write_key: process.env.COSMIC_WRITE_KEY<br/>    }<br/>}<br/>app.locals.config = config<br/>app.locals.stripeKeyPublishable = process.env.STRIPE_PUBLISHABLE_KEY<br/>app.locals.stripeKeySecret = process.env.STRIPE_SECRET_KEY</span></pre><p id="bdc9" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">最后一步是连接<code class="eh lf lg lh li b">cors</code>和<code class="eh lf lg lh li b">session</code>中间件，如下所示:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="10a6" class="lr jd hu li b fv ls lt l lu lv">//app.js</span><span id="d988" class="lr jd hu li b fv mx lt l lu lv">app.locals.stripeKeySecret = process.env.STRIPE_SECRET_KEY</span><span id="ad36" class="lr jd hu li b fv mx lt l lu lv">app.use(session({<br/>  secret: 'sjcimsoc',<br/>  resave: false,<br/>  saveUninitialized: true,<br/>  cookie: { secure: false }<br/>}))<br/>app.use(cors())</span></pre><p id="3ecc" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">在这一点上，我们有一个坚实的基础来建立我们的应用程序，并可以开始起草它的观点。</p><h1 id="0d4d" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">6.雕刻出景色</h1><p id="d0cd" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">有一个我们希望我们的博客看起来和感觉的模型将帮助我们思考如何连接它的路线。我们将从主要布局开始。</p><p id="e5c4" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">主要布局:</strong></p><p id="b8f5" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">在handlebars中，每个页面都会在默认布局的<code class="eh lf lg lh li b">body</code>标签中呈现。在我们的样板文件中，这是<code class="eh lf lg lh li b">/views/layouts/main.handlebars</code>。</p><p id="e259" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">我们需要做三处修改。</p><ol class=""><li id="1636" class="lw lx hu kc b kd kz kh la kl ly kp lz kt ma kx my mc md me dt translated">在<code class="eh lf lg lh li b">title</code>标签中，用<code class="eh lf lg lh li b">{{title}}</code>替换<code class="eh lf lg lh li b">{{config.site_title}}</code>，稍后我们将通过<code class="eh lf lg lh li b">res.locals</code>传递它。</li><li id="71f8" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">在<code class="eh lf lg lh li b">head</code>标记的末尾之前加上<code class="eh lf lg lh li b">&lt;script src="https://js.stripe.com/v3/"&gt;&lt;/script&gt;</code>。这是Stripe的浏览器客户端。我们只在结帐表单中需要它，但是Stripe建议在每一页都包含它，以帮助欺诈检测。</li><li id="f320" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">包括自举。在<code class="eh lf lg lh li b">head</code>标签中的某处添加<code class="eh lf lg lh li b">&lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /&gt;</code>并在<code class="eh lf lg lh li b">body</code>标签结束之前添加</li></ol><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="b84e" class="lr jd hu li b fv ls lt l lu lv">&lt;script src="https://code.jquery.com/jquery-3.2.1.min.js"<br/> integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="<br/> crossorigin="anonymous"&gt;&lt;/script&gt;<br/>&lt;script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"&gt;&lt;/script&gt;</span></pre><p id="b88b" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">主布局现在看起来像这样:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="3139" class="lr jd hu li b fv ls lt l lu lv">&lt;!-- views/layouts/main.handlebars --&gt;<br/>&lt;!doctype html&gt;<br/>&lt;html lang="en"&gt;<br/>  &lt;head&gt;<br/>    &lt;meta charset="UTF-8"&gt;<br/>    &lt;meta name="viewport" content="width=device-width"&gt;<br/>    &lt;title&gt;{{config.site_title}}&lt;/title&gt;<br/>    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /&gt;<br/>    {{#if ENV_DEVELOPMENT}}<br/>      &lt;script src="http://localhost:35729/livereload.js"&gt;&lt;/script&gt;<br/>    {{/if}}<br/>    &lt;script src="https://js.stripe.com/v3/"&gt;&lt;/script&gt;</span><span id="b7a3" class="lr jd hu li b fv mx lt l lu lv">  &lt;/head&gt;<br/>  &lt;body&gt;<br/></span><span id="010a" class="lr jd hu li b fv mx lt l lu lv">  {{{body}}}</span><span id="5155" class="lr jd hu li b fv mx lt l lu lv">  &lt;script<br/>    src="https://code.jquery.com/jquery-3.2.1.min.js"<br/>    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="<br/>    crossorigin="anonymous"&gt;&lt;/script&gt;<br/>  &lt;script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"&gt;&lt;/script&gt;<br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="7106" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">表头部分:</strong></p><p id="b1cb" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">Handlebars期望在默认情况下在<code class="eh lf lg lh li b">/views/partials</code>目录中找到partials，所以我们将在那里创建<code class="eh lf lg lh li b">header.handlebars</code>。它看起来会像这样:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="a15e" class="lr jd hu li b fv ls lt l lu lv">&lt;header&gt;<br/>  &lt;div class="container"&gt;<br/>    &lt;div class="row"&gt;<br/>      &lt;div class="col-xs-12 text-center"&gt;<br/>        &lt;h1&gt;{{config.site_title}}&lt;/h1&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/header&gt;</span><span id="9b2c" class="lr jd hu li b fv mx lt l lu lv">&lt;nav class="navbar navbar-default"&gt;<br/>  &lt;div class="container-fluid"&gt;<br/>    &lt;div class="navbar-header"&gt;<br/>      &lt;button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-header" aria-expanded="false"&gt;<br/>        &lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;<br/>        &lt;span class="icon-bar"&gt;&lt;/span&gt;<br/>        &lt;span class="icon-bar"&gt;&lt;/span&gt;<br/>        &lt;span class="icon-bar"&gt;&lt;/span&gt;<br/>      &lt;/button&gt;<br/>    &lt;/div&gt;</span><span id="71ab" class="lr jd hu li b fv mx lt l lu lv">    &lt;div class="collapse navbar-collapse" id="navbar-collapse-header"&gt;<br/>      &lt;ul class="nav navbar-nav"&gt;<br/>        &lt;li {{#if route_posts}}class="active"{{/if}}&gt;&lt;a href="/posts"&gt;Posts&lt;span class="sr-only"&gt;(current)&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;<br/>        &lt;li&gt;&lt;a href="/premium"&gt;Premium Content&lt;/a&gt;&lt;/li&gt;<br/>      &lt;/ul&gt;<br/>      &lt;ul class="nav navbar-nav navbar-right"&gt;<br/>        {{#if logged_in}}<br/>          &lt;li class="navbar-text text-center"&gt;Welcome Back, {{user.first_name}}!&lt;/li&gt;<br/>          &lt;li&gt;&lt;a href="/logout"&gt;Logout&lt;/a&gt;&lt;/li&gt;<br/>        {{/if}}</span><span id="5846" class="lr jd hu li b fv mx lt l lu lv">        {{#unless logged_in}}<br/>          &lt;li {{#if route_login}}class="active"{{/if}}&gt;&lt;a href="/login"&gt;Login&lt;/a&gt;&lt;/li&gt;<br/>          &lt;li {{#if route_signup}}class="active"{{/if}}&gt;&lt;a href="/plans"&gt;Sign Up&lt;/a&gt;&lt;/li&gt;<br/>        {{/unless}}<br/>      &lt;/ul&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/nav&gt;</span></pre><p id="7797" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">注意:</strong>在header partial中，我们利用手柄的内置<code class="eh lf lg lh li b">if</code>和<code class="eh lf lg lh li b">unless</code>助手来使我们的代码部分特定于路径。我们稍后将在路由处理程序中传递相对布尔值。</p><p id="21ff" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">帖子视图</strong></p><p id="59bd" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">在帖子页面上，我们希望:</p><ol class=""><li id="e81a" class="lw lx hu kc b kd kz kh la kl ly kp lz kt ma kx my mc md me dt translated">显示标题</li><li id="1a73" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">如果用户试图在没有帐户的情况下访问高级帖子，则显示错误消息</li><li id="d35f" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">将post显示逻辑抽象成它自己的部分，使我们的代码更加整洁和模块化。</li></ol><p id="fc09" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">对于错误消息，我们将像以前一样依赖Handlebars的<code class="eh lf lg lh li b">if</code>助手。为了显示帖子的摘要，我们将把帖子作为post对象的数组传递给视图。这让我们可以使用Handlebars <code class="eh lf lg lh li b">each</code> block助手来迭代数组(每个post都可以通过<code class="eh lf lg lh li b">this</code>访问)。我们的帖子视图将如下所示:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="d31a" class="lr jd hu li b fv ls lt l lu lv">{{&gt; header}}<br/>&lt;div class="container"&gt;<br/>  &lt;div class="row"&gt;<br/>    {{#if error}}<br/>      &lt;div class="alert alert-danger" role="alert"&gt;<br/>        {{error}}<br/>      &lt;/div&gt;<br/>    {{/if}}<br/>    {{#each posts}}<br/>      {{&gt; post-container this}}<br/>    {{/each}}<br/>  &lt;/div&gt;<br/>&lt;/div&gt;</span></pre><p id="af08" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">邮政集装箱局部:</strong></p><p id="8b03" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">下一个明显的步骤是构建容器，在Posts页面上显示每篇文章的摘要。除了显示文章的标题和内容(很容易通过<code class="eh lf lg lh li b">this.title</code>访问)等。)我们希望向用户显示帖子是否是premium，以及帖子正文及其创建日期的截断。</p><p id="b9c7" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">如果<code class="eh lf lg lh li b">this.metadata.premium</code>返回<code class="eh lf lg lh li b">true</code>，我们将再次求助于<code class="eh lf lg lh li b">if</code>助手在柱子旁边显示一颗星星，这很简单。对于导语和创建日期，我们需要修改Post对象的<code class="eh lf lg lh li b">content</code>和<code class="eh lf lg lh li b">created_at</code>属性；首先，要缩短它，在后者，因为宇宙存储的日期在ISO日期时间格式。为了让显示逻辑远离我们的视图，Handlebars为我们提供了编写自己的助手的功能。</p><p id="f097" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">首先，准备好视图代码:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="b343" class="lr jd hu li b fv ls lt l lu lv">&lt;!-- /views/partials/post-container.handlebars --&gt;</span><span id="5911" class="lr jd hu li b fv mx lt l lu lv">&lt;div style="border-bottom: 3px solid #337ab7" class="col-xs-12 col-md-8 col-md-offset-2"&gt;<br/>  &lt;h2&gt;<br/>    {{#if this.metadata.premium}}<br/>      &lt;span style="font-size: 0.5em" class="glyphicon glyphicon-star"&gt;&lt;/span&gt;<br/>    {{/if}}<br/>    &lt;a href="/post/{{this.slug}}"&gt;{{this.title}}&lt;/a&gt;<br/>  &lt;/h2&gt;<br/>  &lt;p style="margin: 35px 40px"&gt;<br/>    {{truncateText this.content 20}} &lt;a href="/post/{{this.slug}}"&gt;Read more&lt;/a&gt;<br/>  &lt;/p&gt;<br/>  &lt;em style="margin: 20px 0" class="pull-right"&gt;<br/>    {{date this.created_at}}<br/>  &lt;/em&gt;<br/>&lt;/div&gt;</span></pre><p id="a9e6" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">(提示:我们的车把助手将被命名为<em class="le"> truncateText </em>和<em class="le"> date </em>。)</p><p id="455c" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">打开<code class="eh lf lg lh li b">app.js</code>并找到将手柄设置为视图引擎的代码片段。<code class="eh lf lg lh li b">exphbs</code>是对<code class="eh lf lg lh li b">express-handlebars</code>的引用，传递给它的对象包含用于实例化引擎的参数。我们需要向该对象添加<code class="eh lf lg lh li b">helpers</code>属性。<code class="eh lf lg lh li b">helpers</code>属性将指向<code class="eh lf lg lh li b">date</code>和<code class="eh lf lg lh li b">truncateText</code>方法，如下所示:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="2374" class="lr jd hu li b fv ls lt l lu lv">// app.js</span><span id="4734" class="lr jd hu li b fv mx lt l lu lv">// etc...<br/>app.engine('handlebars', exphbs({<br/>  defaultLayout: 'main',<br/>  partialsDir: ['views/partials/'],<br/>  helpers: {<br/>    date: function(date) {<br/>      return dateFormat(new Date(date), "dddd, mmmm dS, yyyy")<br/>    },<br/>    truncateText: function(text, length) {<br/>      return truncate(text, length, { stripTags: true, byWords: true })<br/>    }<br/>  }<br/>}));<br/>app.set('views', path.join(__dirname, 'views'));<br/>app.set('view engine', 'handlebars');<br/>// etc...</span></pre><p id="0390" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">举例来说，<code class="eh lf lg lh li b">{{truncateText this.content 20}}</code>告诉Handlebars渲染<code class="eh lf lg lh li b">truncate(this.content, 20, {...} )</code>的结果。</p><p id="acf0" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">帖子查看:</strong></p><p id="d626" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">我们的用户需要能够阅读单个帖子，所以我们将构建一个简单的视图，get传递一个一个帖子长的数组。(在本指南范围之外的将来，我们可能会发现使用视图连续显示多个完整的帖子很有用。)</p><p id="4342" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">如果找不到帖子，我们还会显示一个错误。像这样创建你的帖子视图:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="e05f" class="lr jd hu li b fv ls lt l lu lv">&lt;!-- /views/post.handlebars --&gt;</span><span id="705d" class="lr jd hu li b fv mx lt l lu lv">{{&gt; header}}<br/>{{#if not_found}}<br/>  &lt;div class="container"&gt;<br/>    &lt;div class="row text-center"&gt;<br/>      &lt;div class="col-xs12 col-md-6 col-md-offset-3"&gt;<br/>        &lt;div class="alert alert-danger"&gt;<br/>          Post Not Found!<br/>        &lt;/div&gt;<br/>        &lt;a href="/posts"&gt;See All Posts&lt;/a&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>{{/if}}</span><span id="8608" class="lr jd hu li b fv mx lt l lu lv">{{#each post}}<br/>  &lt;article class="container"&gt;<br/>    &lt;div class="row"&gt;<br/>      &lt;div class="col-xs-12 col-sm-8 col-sm-offset-2"&gt;<br/>        &lt;h1&gt;{{this.title}}&lt;/h1&gt;<br/>        &lt;div class="lead" style="font-size: 1.5em"&gt;<br/>          {{{this.content}}}<br/>        &lt;/div&gt;<br/>        &lt;em class="pull-right"&gt;<br/>          &lt;time&gt;{{date this.created_at}}&lt;/time&gt;<br/>        &lt;/em&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>  &lt;/article&gt;<br/>{{/each}}</span></pre><p id="3499" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">登录页面:</strong></p><p id="fb6b" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">登录页面将是最简单的——一个发布到登录路径的基本表单。</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="994c" class="lr jd hu li b fv ls lt l lu lv">&lt;!-- /views/login.handlebars --&gt;</span><span id="c0b0" class="lr jd hu li b fv mx lt l lu lv">{{&gt; header}}</span><span id="adf1" class="lr jd hu li b fv mx lt l lu lv">&lt;div class="container"&gt;<br/>  &lt;div class="row"&gt;<br/>    &lt;div class="col-xs-12 col-sm-4 col-sm-offset-4"&gt;<br/>      &lt;h1&gt;Log In&lt;/h1&gt;<br/>      &lt;p class="text-muted"&gt;<br/>        Log in to view premium content.<br/>      &lt;/p&gt;</span><span id="6527" class="lr jd hu li b fv mx lt l lu lv">      &lt;form method="post"&gt;<br/>        &lt;input class="form-control" type="email" name="email" placeholder="Email" required/&gt;<br/>        &lt;input type="password" class="form-control" name="password" placeholder="Password" required /&gt;<br/>        &lt;button class="btn btn-lg btn-primary btn-block submit-btn" type="submit"&gt;Log in&lt;/button&gt;<br/>      &lt;/form&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/div&gt;</span><span id="517a" class="lr jd hu li b fv mx lt l lu lv">&lt;style&gt;<br/>  form &gt; input, button {<br/>    margin-top: 12px;<br/>  }<br/>&lt;/style&gt;</span></pre><p id="af76" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">计划页面:</strong></p><p id="cf83" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">显然，我们的用户需要在登录前注册，但由于我们给他们提供了从三个订阅计划中选择一个的选项，所以我们将构建一个视图，在结账前向他们显示他们的选项。稍后，我们需要将Subscriptions对象传递给这个视图，这样我们就可以从Cosmic中设置计划价格，而不是硬编码它们。该视图将如下所示:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="8f54" class="lr jd hu li b fv ls lt l lu lv">&lt;!-- /views/plans.handlebars --&gt;</span><span id="326f" class="lr jd hu li b fv mx lt l lu lv">{{&gt; header}}</span><span id="bba3" class="lr jd hu li b fv mx lt l lu lv">&lt;div class="container"&gt;<br/>  &lt;div class="row text-center lead"&gt;<br/>    &lt;h1&gt;Choose a Plan to Read Premium Content&lt;/h1&gt;<br/>    &lt;p&gt;<br/>      Sign up to view Premium Content on {{config.site_title}}<br/>    &lt;/p&gt;<br/>  &lt;/div&gt;</span><span id="c8ac" class="lr jd hu li b fv mx lt l lu lv">  &lt;div class="row"&gt;<br/>    &lt;div class="col-sm-4"&gt;<br/>      &lt;h3 class="text-center text-muted"&gt;<br/>        Monthly<br/>      &lt;/h3&gt;<br/>      &lt;p class="text-center"&gt;<br/>        &lt;strong&gt;Billed every month&lt;/strong&gt;<br/>      &lt;/p&gt;<br/>      &lt;h1 class="text-center text-success"&gt;{{subscriptions.monthly_price}}&lt;/h1 class="text-center text-success"&gt;<br/>      &lt;ul class="list-unstyled lead" style="padding: 0 20px"&gt;<br/>        &lt;li&gt;<br/>          &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;Here's a good benefit<br/>        &lt;/li&gt;<br/>        &lt;li&gt;<br/>          &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;A reason to buy<br/>        &lt;/li&gt;<br/>        &lt;li&gt;<br/>          &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;Why you have to have it<br/>        &lt;/li&gt;<br/>        &lt;li&gt;<br/>          &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;Why you shouldn't miss out<br/>        &lt;/li&gt;<br/>        &lt;li&gt;<br/>          &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;Believe it.<br/>        &lt;/li&gt;<br/>      &lt;/ul&gt;<br/>      &lt;a href="/signup?plan=monthly"&gt;&lt;button class="btn btn-block btn-default btn-lg"&gt;Sign Up&lt;/button&gt;&lt;/a&gt;<br/>    &lt;/div&gt;<br/>    &lt;div class="col-sm-4" style="border: 2px solid #3c763d"&gt;<br/>      &lt;h3 style="background: #3c763d;color: white;padding: 7px 0" class="text-center text-success"&gt;<br/>        Yearly<br/>      &lt;/h3&gt;<br/>      &lt;p class="text-center"&gt;<br/>        &lt;strong&gt;Billed every 12 months&lt;/strong&gt;<br/>      &lt;/p&gt;<br/>      &lt;h1 class="text-center text-success"&gt;{{subscriptions.yearly_price}}&lt;/h1&gt;<br/>        &lt;ul class="list-unstyled lead" style="padding: 0 20px"&gt;<br/>          &lt;li&gt;<br/>            &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;Here's a good benefit<br/>          &lt;/li&gt;<br/>          &lt;li&gt;<br/>            &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;A reason to buy<br/>          &lt;/li&gt;<br/>          &lt;li&gt;<br/>            &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;Why you have to have it<br/>          &lt;/li&gt;<br/>          &lt;li&gt;<br/>            &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;Why you shouldn't miss out<br/>          &lt;/li&gt;<br/>          &lt;li&gt;<br/>            &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;Believe it.<br/>          &lt;/li&gt;<br/>        &lt;/ul&gt;<br/>        &lt;a href="/signup?plan=yearly"&gt;&lt;button class="btn btn-block btn-default btn-lg"&gt;Sign Up&lt;/button&gt;&lt;/a&gt;<br/>    &lt;/div&gt;<br/>    &lt;div class="col-sm-4"&gt;<br/>      &lt;h3 class="text-center text-muted"&gt;<br/>        Quarterly<br/>      &lt;/h3&gt;<br/>      &lt;p class="text-center"&gt;<br/>        &lt;strong&gt;Billed every 3 months&lt;/strong&gt;<br/>      &lt;/p&gt;<br/>      &lt;h1 class="text-center text-success"&gt;{{subscriptions.quarterly_price}}&lt;/h1 class="text-center text-success"&gt;<br/>        &lt;ul class="list-unstyled lead" style="padding: 0 30px"&gt;<br/>          &lt;li&gt;<br/>            &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;Here's a good benefit<br/>          &lt;/li&gt;<br/>          &lt;li&gt;<br/>            &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;A reason to buy<br/>          &lt;/li&gt;<br/>          &lt;li&gt;<br/>            &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;Why you have to have it<br/>          &lt;/li&gt;<br/>          &lt;li&gt;<br/>            &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;Why you shouldn't miss out<br/>          &lt;/li&gt;<br/>          &lt;li&gt;<br/>            &lt;span class="glyphicon glyphicon-ok text-success"&gt;&lt;/span&gt;Believe it.<br/>          &lt;/li&gt;<br/>        &lt;/ul&gt;<br/>        &lt;a href="/signup?plan=quarterly"&gt;&lt;button class="btn btn-block btn-default btn-lg"&gt;Sign Up&lt;/button&gt;&lt;/a&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/div&gt;</span><span id="7fb4" class="lr jd hu li b fv mx lt l lu lv">&lt;style&gt;<br/>  form &gt; input, button {<br/>    margin-top: 12px;<br/>  }<br/>  ul.lead {<br/>    margin-top: 40px<br/>  }<br/>  .lead &gt; li {<br/>    margin: 8px 0<br/>  }<br/>  .glyphicon {<br/>    margin-right: 12px<br/>  }<br/>  .btn {<br/>    margin: 35px 0px;<br/>  }<br/>&lt;/style&gt;</span></pre><p id="8981" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><em class="le">注意，每个注册按钮都链接到</em> <code class="eh lf lg lh li b"><em class="le">signup</em></code> <em class="le">路线，传递一个与所选计划相关的查询参数。即</em> <code class="eh lf lg lh li b"><em class="le">/signup?plan={:plan}</em></code></p><p id="182f" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">报名页面:</strong></p><p id="a434" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">最后，但肯定不是最不重要的——赚钱机器。我们把最复杂的视图留到了最后。这些是我们的要求:</p><ol class=""><li id="d8e5" class="lw lx hu kc b kd kz kh la kl ly kp lz kt ma kx my mc md me dt translated">我们需要通过之前在<code class="eh lf lg lh li b">planName</code>页面上选择的计划。(稍后我们将在URL查询字符串中执行此操作)</li><li id="822f" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">我们需要使用Stripe Elements API来收集信用卡信息。这是我们早前在主布局中包含的<code class="eh lf lg lh li b">Stripe.js</code>。在我们结帐表格的最后，我们需要两个<code class="eh lf lg lh li b">div</code>;一个ID为<code class="eh lf lg lh li b">card-element</code>,另一个ID为<code class="eh lf lg lh li b">card-errors</code>,用于在初始DOM渲染后注入<code class="eh lf lg lh li b">Stripe.js</code>。</li><li id="ebb4" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">我们需要传递我们的可发布的条形密钥来使它工作。</li></ol><p id="b6d6" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">从HTML开始，我们有:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="cc45" class="lr jd hu li b fv ls lt l lu lv">&lt;!-- /views/signup.handlebars --&gt;<br/>{{&gt;header}}</span><span id="d4a4" class="lr jd hu li b fv mx lt l lu lv">&lt;div class="container"&gt;<br/>  &lt;div class="row"&gt;<br/>    &lt;form method="post" id="payment-form"&gt;<br/>      &lt;div class="col-xs-12 text-center"&gt;<br/>        &lt;h4 class="lead"&gt;&lt;em&gt;You're one step away from a &lt;u&gt;{{planName}}&lt;/u&gt; subscription to {{config.site_title}}!&lt;/em&gt;&lt;/h4&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>    &lt;div class="row"  style="margin-top: 30px"&gt;<br/>      &lt;div class="col-md-8 col-md-offset-2"&gt;<br/>        &lt;h4&gt;Enter your account details and payment information&lt;/h4&gt;</span><span id="86f2" class="lr jd hu li b fv mx lt l lu lv">        &lt;label for="first_name"&gt;First name:&lt;/label&gt;<br/>        &lt;input type="text" name="first_name" class="form-control" placeholder="First name" required /&gt;<br/>        &lt;label for="last_name"&gt;Last name:&lt;/label&gt;<br/>        &lt;input type="text" name="last_name" class="form-control" placeholder="Last name" required /&gt;<br/>        &lt;label for="email"&gt;Email:&lt;/label&gt;<br/>        &lt;input type="email" name="email" class="form-control" placeholder="Email" required /&gt;<br/>        &lt;label for="password"&gt;Password&lt;/label&gt;<br/>        &lt;input type="password" name="password" class="form-control" placeholder="Password" required /&gt;<br/>        &lt;label for="card-element"&gt;Credit or debit card&lt;/label&gt;<br/>        &lt;div class="form-control" id="card-element"&gt;&lt;/div&gt;<br/>        &lt;div id="card-errors" role="alert"&gt;&lt;/div&gt;<br/>        &lt;button id="submit-button" class="btn-success btn btn-lg btn-block btn-default" &gt;Submit Payment&lt;/button&gt;</span><span id="7ccc" class="lr jd hu li b fv mx lt l lu lv">      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>    &lt;/form&gt;<br/>&lt;/div&gt;</span></pre><p id="e17d" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">然后，为简单起见，我们将使用一个集成了Stripe的内联脚本:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="0d56" class="lr jd hu li b fv ls lt l lu lv">&lt;!-- views/signup.handlebars --&gt;</span><span id="fa19" class="lr jd hu li b fv mx lt l lu lv">&lt;script&gt;<br/>  var stripe = Stripe('{{stripeKeyPublishable}}')<br/>  var elements = stripe.elements()<br/>  var card = elements.create('card')<br/>  var style = {<br/>      base: {<br/>        color: '#32325d',<br/>        lineHeight: '24px',<br/>        fontFamily: '"Helvetica Neue", Helvetica, sans-serif',<br/>        fontSmoothing: 'antialiased',<br/>        fontSize: '16px',<br/>        '::placeholder': {<br/>          color: '#aab7c4'<br/>        }<br/>      },<br/>      invalid: {<br/>        color: '#fa755a',<br/>        iconColor: '#fa755a'<br/>      }<br/>    };</span><span id="02ca" class="lr jd hu li b fv mx lt l lu lv">  card.mount('#card-element', {style: style})</span><span id="a544" class="lr jd hu li b fv mx lt l lu lv">  // Handle real-time validation errors from the card Element.<br/>card.addEventListener('change', function(event) {<br/>  var displayError = document.getElementById('card-errors');<br/>  if (event.error) {<br/>    displayError.textContent = event.error.message;<br/>  } else {<br/>    displayError.textContent = '';<br/>  }<br/>});</span><span id="7871" class="lr jd hu li b fv mx lt l lu lv">// Handle form submission<br/>var form = document.getElementById('payment-form');<br/>var submitButton = document.getElementById('submit-button');<br/>form.addEventListener('submit', function(event) {<br/>  event.preventDefault();<br/>  submitButton.disabled=true<br/>  stripe.createToken(card).then(function(result) {<br/>    if (result.error) {<br/>      // Inform the user if there was an error<br/>      var errorElement = document.getElementById('card-errors');<br/>      errorElement.textContent = result.error.message;<br/>      submitButton.disabled=false<br/>    } else {<br/>      // Send the token to your server<br/>      stripeTokenHandler(result.token);<br/>    }<br/>  });<br/>});</span><span id="2f09" class="lr jd hu li b fv mx lt l lu lv">function stripeTokenHandler(token) {<br/>  // Insert the token ID into the form so it gets submitted to the server<br/>  var form = document.getElementById('payment-form');<br/>  var hiddenInput = document.createElement('input');<br/>  hiddenInput.setAttribute('type', 'hidden');<br/>  hiddenInput.setAttribute('name', 'stripeToken');<br/>  hiddenInput.setAttribute('value', token.id);<br/>  form.appendChild(hiddenInput);<br/>  // Submit the form<br/>  form.submit();<br/>}<br/>&lt;/script&gt;</span><span id="c42e" class="lr jd hu li b fv mx lt l lu lv">&lt;style&gt;<br/>  label,button {<br/>    margin-top: 22px;<br/>  }<br/>&lt;/style&gt;</span></pre><p id="9bdd" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">事情是这样的:</p><ol class=""><li id="45f8" class="lw lx hu kc b kd kz kh la kl ly kp lz kt ma kx my mc md me dt translated">我们用传递的可发布键实例化Stripe，将它的<code class="eh lf lg lh li b">elements</code>库赋给它自己的变量，用它来创建一个<code class="eh lf lg lh li b">card</code>元素，最后将它挂载到我们之前创建的<code class="eh lf lg lh li b">&lt;div id="card-element"&gt;</code>中。卡对象处理卡验证，打包了良好的UX特性，并实时向用户报告错误。</li><li id="b347" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">我们将一个事件侦听器附加到card对象，该对象响应用户输入的卡号、CCV或到期日期的任何变化。它将错误记录在<code class="eh lf lg lh li b">&lt;div id="card-errors"&gt;</code>上</li><li id="2c33" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">我们手动处理表单提交。首先，我们阻止默认操作，并禁用多次提交。然后，如果没有错误，我们将一个隐藏字段附加到包含Stripe的验证令牌的表单，由<code class="eh lf lg lh li b">Stripe.js</code>提供，<em class="le">然后</em>将表单提交给<code class="eh lf lg lh li b">Signup</code>路由。</li></ol><h1 id="f630" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">7.建造路线</h1><p id="78d3" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">随着视图的构建，我们确切地知道我们的应用程序需要什么样的路由。即:</p><ul class=""><li id="9e92" class="lw lx hu kc b kd kz kh la kl ly kp lz kt ma kx mb mc md me dt translated">邮件</li><li id="afaf" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">邮政</li><li id="ca52" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">溢价</li><li id="1346" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">注册</li><li id="2789" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">注销</li><li id="694d" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">注册</li><li id="a04f" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">计划</li></ul><p id="9a18" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">默认情况下，您的应用程序有一条<code class="eh lf lg lh li b">Users</code>路线和一条<code class="eh lf lg lh li b">Index</code>路线。删除<code class="eh lf lg lh li b">Users</code>并使<code class="eh lf lg lh li b">Index</code>重定向到<code class="eh lf lg lh li b">Posts</code>如下:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="5fb9" class="lr jd hu li b fv ls lt l lu lv">// /routes/index.js</span><span id="cdcf" class="lr jd hu li b fv mx lt l lu lv">var express = require('express')<br/>var router = express.Router()</span><span id="ba10" class="lr jd hu li b fv mx lt l lu lv">router.get('/', function(req, res) {<br/>  res.redirect('/posts')<br/>});</span><span id="467f" class="lr jd hu li b fv mx lt l lu lv">module.exports = router</span></pre><p id="9ede" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">发帖路线:</strong></p><p id="3ab1" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">post将使用<code class="eh lf lg lh li b">async</code>将一系列异步函数串在一起:一个使用Cosmic JS客户端获取我们的帖子，下一个使用Cosmic获取站点配置并呈现<code class="eh lf lg lh li b">posts</code>视图，传递相关的局部变量。如果用户不在认证会话中，我们将使用<code class="eh lf lg lh li b">lodash</code>过滤掉从Cosmic返回的<em class="le">没有</em>标记为高级(因此可以免费阅读)的帖子。我们将通过<code class="eh lf lg lh li b">res.locals</code>传递帖子、配置和特定于路由的视图数据。</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="b6f4" class="lr jd hu li b fv ls lt l lu lv">var express = require('express');<br/>var router = express.Router();<br/>var cosmic = require('cosmicjs');<br/>var async = require('async');<br/>var _ = require('lodash')</span><span id="513a" class="lr jd hu li b fv mx lt l lu lv">router.get('/', function(req, res) {<br/>  async.series([<br/>    function(cb) {<br/>      cosmic.getObjectType(req.app.locals.config, { type_slug: 'posts' }, function(err, response) {<br/>        (req.session.user) ? res.locals.posts = response.objects.all : res.locals.posts = _.filter(response.objects.all, function(post) {<br/>          return !post.metadata.premium<br/>        })<br/>        cb()<br/>      })<br/>    },<br/>    function(cb) {<br/>      cosmic.getObject(req.app.locals.config, { slug: 'site' }, function(err, response) {<br/>        res.locals.config = response.object.metadata<br/>        res.locals.user = req.session.user<br/>        res.locals.route_posts = true<br/>        if (req.session.user) res.locals.logged_in = true<br/>        return res.render('posts.handlebars')<br/>      })=<br/>    }<br/>  ])<br/>});</span><span id="cc77" class="lr jd hu li b fv mx lt l lu lv">module.exports = router;</span></pre><p id="7bcd" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">发布路线:</strong></p><p id="422b" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">有了一个针对所有帖子的路由，我们需要一个针对单个帖子的伴随路由，它将帖子段作为URL参数，如果找到了就返回该帖子，使用与<code class="eh lf lg lh li b">Posts</code>路由类似的逻辑。</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="9511" class="lr jd hu li b fv ls lt l lu lv">// routes/post.js</span><span id="5ec9" class="lr jd hu li b fv mx lt l lu lv">var express = require('express');<br/>var router = express.Router();<br/>var cosmic = require('cosmicjs');<br/>var async = require('async');<br/>var _ = require('lodash')</span><span id="7f4a" class="lr jd hu li b fv mx lt l lu lv">router.get('/:slug', function(req, res) {<br/>  async.series([<br/>    function(cb) {<br/>      cosmic.getObjectType(req.app.locals.config, { type_slug: 'posts' }, function(err, response) {<br/>        res.locals.post = _.filter(response.objects.all, function(post) {<br/>          return post.slug === req.params.slug<br/>        })<br/>        if (!res.locals.post) res.locals.not_found = true<br/>        cb()<br/>      })<br/>    },<br/>    function(cb) {<br/>      cosmic.getObject(req.app.locals.config, { slug: 'site' }, function(err, response) {<br/>        res.locals.config = response.object.metadata<br/>        res.locals.user = req.session.user<br/>        return res.render('post.handlebars')<br/>      })<br/>    }<br/>  ])<br/>});</span><span id="cd1f" class="lr jd hu li b fv mx lt l lu lv">module.exports = router</span></pre><p id="1fa5" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">登录路径:</strong></p><p id="21c0" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">为了让用户能够访问优质帖子，我们需要收集他们的登录信息，用bcrypt散列他们的密码，并对照与存储在Cosmic中的电子邮件地址相关联的密码进行检查。</p><p id="e312" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">GET请求将呈现登录表单。然后，我们处理表单的POST请求，从Cosmic检索所有用户，并使用两个异步函数迭代所有用户:一个使用bcrypt比较密码散列，下一个将用户的数据保存到会话中(如果找到的话)。</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="4d47" class="lr jd hu li b fv ls lt l lu lv">// routes/login.js</span><span id="9cfb" class="lr jd hu li b fv mx lt l lu lv">var express = require('express');<br/>var router = express.Router();<br/>var cosmic = require('cosmicjs');<br/>var async = require('async');<br/>var _ = require('lodash')<br/>var bcrypt = require('bcrypt')</span><span id="8668" class="lr jd hu li b fv mx lt l lu lv">router.get('/', function(req, res) {<br/>  async.series([<br/>    function(cb) {<br/>      cosmic.getObject(req.app.locals.config, { slug: 'site' }, function(err, response) {<br/>        res.locals.config = response.object.metadata<br/>        res.locals.route_login = true<br/>        return res.render('login.handlebars')<br/>      })<br/>    }<br/>  ])<br/>});</span><span id="3a81" class="lr jd hu li b fv mx lt l lu lv">router.post('/', function(req, res) {<br/>  cosmic.getObjectType(req.app.locals.config, { type_slug: 'users' }, function (err, response) {<br/>    if (err) res.status(500).json({ status: 'error', data: response })<br/>    else {<br/>      async.eachSeries(response.objects.all, function (user, eachCb) {<br/>        if (!_.find(user.metafields, { key: 'email', value: req.body.email.trim().toLowerCase() }))<br/>          return eachCb()<br/>        const stored_password = _.find(user.metafields, { key: 'password' }).value<br/>        bcrypt.compare(req.body.password, stored_password, function (err, correct) {<br/>          if (correct) res.locals.user_found = user<br/>          eachCb()<br/>        })<br/>      }, function () {<br/>        if (res.locals.user_found) {<br/>          req.session.user = {<br/>            first_name: res.locals.user_found.metafield.first_name.value,<br/>            last_name: res.locals.user_found.metafield.last_name.value,<br/>            email: res.locals.user_found.metafield.email.value<br/>          }<br/>          req.session.save()<br/>          return res.redirect('/posts')<br/>        }<br/>        return res.status(404).json({ status: 'error', message: 'User not found' })<br/>      })<br/>    }<br/>  })<br/>})</span><span id="6543" class="lr jd hu li b fv mx lt l lu lv">module.exports = router</span></pre><p id="ff3f" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">计划路线:</strong></p><p id="ed12" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">在用户登录之前，我们需要一个注册表单，这样我们就可以首先拥有用户。如前所述，我们将在注册表单前向他们展示订阅选项。这只是在呈现视图之前传递站点和订阅配置:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="1423" class="lr jd hu li b fv ls lt l lu lv">var express = require('express');<br/>var router = express.Router();<br/>var cosmic = require('cosmicjs');<br/>var async = require('async')</span><span id="8bcb" class="lr jd hu li b fv mx lt l lu lv">router.get('/', function(req, res) {<br/>  async.series([<br/>    function(cb) {<br/>      cosmic.getObject(req.app.locals.config, { slug: 'site' }, function(err, response) {<br/>        res.locals.config = response.object.metadata<br/>        res.locals.route_signup = true<br/>        cb()<br/>      })<br/>    },<br/>    function(cb) {<br/>      cosmic.getObject(req.app.locals.config, { slug: 'subscriptions' }, function(err, response) {<br/>        res.locals.subscriptions = response.object.metadata<br/>        res.render('plans.handlebars')<br/>      })<br/>    }<br/>  ])<br/>});</span><span id="7755" class="lr jd hu li b fv mx lt l lu lv">module.exports = router;</span></pre><p id="4c8a" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">报名路线:</strong></p><p id="7e21" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">正如你可能已经猜到的，注册路线是所有路线中进行得最多的。以下是我们需要实现的内容:</p><ol class=""><li id="9d14" class="lw lx hu kc b kd kz kh la kl ly kp lz kt ma kx my mc md me dt translated">在GET请求中，呈现注册表单并通过<code class="eh lf lg lh li b">res.locals</code>传递我们的可发布Stripe密钥，以便Stripe.js工作。</li><li id="19cd" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">根据Post请求:</li><li id="a506" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">用我们的密钥实例化Stripe服务器端</li><li id="86fc" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">如果用户已经登录，重定向他们。</li><li id="563f" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">运行一系列两个名为的<em class="le">异步函数(这样我们可以在两个函数都完成后使用它们的返回值)来从Cosmic获取我们的订阅数据并散列密码。</em></li><li id="d14a" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">完成第3步后，我们使用Stripe API创建一个新客户，通过注册表单中传递的Stripe令牌关联他们的支付方式。</li><li id="e895" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">然后，我们根据选择的计划向该客户收费，并创建新的套餐(同样通过Stripe ),以便自动处理重复支付。</li><li id="998a" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">我们基于我们的宇宙模式创建一个新的用户对象，将其添加到我们的bucket中，一旦成功，我们为用户创建一个新的会话，并将他们重定向到<code class="eh lf lg lh li b">Posts</code>路由，在那里他们现在可以查看优质内容。</li></ol><p id="3de8" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">全部完成后，它将看起来像这样:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="a710" class="lr jd hu li b fv ls lt l lu lv">// routes/signup.js</span><span id="50de" class="lr jd hu li b fv mx lt l lu lv">var express = require('express');<br/>var router = express.Router();<br/>var cosmic = require('cosmicjs');<br/>var async = require('async');<br/>var bcrypt = require('bcrypt')</span><span id="0bab" class="lr jd hu li b fv mx lt l lu lv">router.get('/', function(req, res) {<br/>  if (req.session.user) res.redirect('/')<br/>  async.series([<br/>    function(cb) {<br/>      cosmic.getObject(req.app.locals.config, { slug: 'site' }, function(err, response) {<br/>        res.locals.config = response.object.metadata<br/>        res.locals.route_signup = true<br/>        cb()<br/>      })<br/>    },<br/>    function(cb) {<br/>      cosmic.getObject(req.app.locals.config, { slug: 'subscriptions' }, function(err, response) {<br/>        res.locals.subscriptions = response.object.metadata<br/>        res.locals.stripeKeyPublishable = req.app.locals.stripeKeyPublishable<br/>        res.locals.planName = req.query.plan<br/>        res.render('signup.handlebars')<br/>      })<br/>    }<br/>  ])<br/>});</span><span id="fd5c" class="lr jd hu li b fv mx lt l lu lv">router.post('/', function(req, res) {<br/>  var stripe = require('stripe')(req.app.locals.stripeKeySecret)<br/>  if (req.session.user) res.redirect('/')</span><span id="1ff3" class="lr jd hu li b fv mx lt l lu lv">  async.series({<br/>    subscriptions: function(callback) {<br/>      cosmic.getObject(req.app.locals.config, { slug: 'subscriptions' }, function(err, response) {<br/>        callback(null, response.object.metadata)<br/>      })<br/>    },<br/>    hash: function (callback) {<br/>      bcrypt.hash(req.body.password, 10, function (err, hash) {<br/>        callback(null, hash)<br/>      })<br/>    }<br/>  }, function (err, results) {</span><span id="938d" class="lr jd hu li b fv mx lt l lu lv">    stripe.customers.create({<br/>      email: req.body.email,<br/>      source: req.body.stripeToken<br/>    }).then(function (customer) {<br/>      return stripe.charges.create({<br/>        amount: results.subscriptions[req.query.plan + "_price"].replace(/[$]/,'') + '00',<br/>        currency: "usd",<br/>        customer: customer.id<br/>      })<br/>    }).then(function (charge) {<br/>      stripe.subscriptions.create({<br/>        customer: charge.customer,<br/>        items: [<br/>          {<br/>            plan: 'subscription-' + req.query.plan<br/>          }<br/>        ]<br/>      })<br/>      var object = {<br/>        type_slug: 'users',<br/>        title: req.body.first_name + ' ' + req.body.last_name,<br/>        metafields: [<br/>          {<br/>            title: 'First name',<br/>            key: 'first_name',<br/>            type: 'text',<br/>            value: req.body.first_name<br/>          },<br/>          {<br/>            title: 'Last name',<br/>            key: 'last_name',<br/>            type: 'text',<br/>            value: req.body.last_name<br/>          },<br/>          {<br/>            title: 'Password',<br/>            key: 'password',<br/>            type: 'text',<br/>            value: results.hash<br/>          },<br/>          {<br/>            title: 'Email',<br/>            key: 'email',<br/>            type: 'text',<br/>            value: req.body.email<br/>          },<br/>          {<br/>            title: 'Stripe Id',<br/>            key: 'stripe_id',<br/>            type: 'text',<br/>            value: charge.customer<br/>          },<br/>          {<br/>            title: 'Subscription Type',<br/>            key: 'subscription_type',<br/>            type: 'text',<br/>            value: req.query.plan<br/>          }<br/>        ]<br/>      }<br/>      if (req.app.locals.config.bucket.write_key) object.write_key = req.app.locals.config.bucket.write_key<br/>      cosmic.addObject(req.app.locals.config, object, function (err, reponse) {<br/>        if (err)<br/>          res.status(500).json({ data: reponse })<br/>        else {<br/>          req.session.user = {<br/>            first_name: req.body.first_name,<br/>            last_name: req.body.last_name,<br/>            email: req.body.email<br/>          }<br/>          req.session.save()<br/>          res.redirect('/posts')<br/>        }<br/>      })<br/>    })<br/>  })<br/>})</span><span id="faee" class="lr jd hu li b fv mx lt l lu lv">module.exports = router</span></pre><p id="817e" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">注销路径:</strong></p><p id="da75" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">为了方便用户，我们需要给用户一个退出的机会。所有这一切只需要给<code class="eh lf lg lh li b">/logout</code>一个POST请求和一个快速的<code class="eh lf lg lh li b">session.destroy()</code>呼叫。</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="092e" class="lr jd hu li b fv ls lt l lu lv">var express = require('express')<br/>var router = express.Router()</span><span id="222d" class="lr jd hu li b fv mx lt l lu lv">/* GET home page. */</span><span id="cf63" class="lr jd hu li b fv mx lt l lu lv">router.get('/', function(req, res) {<br/>  req.session.destroy()<br/>  return res.redirect('/')<br/>});</span><span id="d281" class="lr jd hu li b fv mx lt l lu lv">module.exports = router</span></pre><p id="f2d0" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">将它们连接在一起:</strong></p><p id="c20c" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">我们已经建立了所有的路线，并准备好按照我们需要的方式工作，我们将在我们的应用程序中<code class="eh lf lg lh li b">require</code>它们，并通过<code class="eh lf lg lh li b">app.use()</code>将它们关联的端点指向它们</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="0da0" class="lr jd hu li b fv ls lt l lu lv">// app.js</span><span id="b297" class="lr jd hu li b fv mx lt l lu lv">var routes = require('./routes/index');<br/>var posts = require('./routes/posts');<br/>var post = require('./routes/post')<br/>var login = require('./routes/login')<br/>var logout = require('./routes/logout')<br/>var signup = require('./routes/signup')<br/>var plans = require('./routes/plans')<br/>var premium = require('./routes/premium')<br/>var api = require('./routes/api')</span><span id="895c" class="lr jd hu li b fv mx lt l lu lv">app.use('/', routes);<br/>app.use('/post', post)<br/>app.use('/posts', posts)<br/>app.use('/login', login)<br/>app.use('/logout', logout)<br/>app.use('/signup', signup)<br/>app.use('/plans', plans)<br/>app.use('/premium', premium)<br/>app.use('/api', api)</span></pre><p id="3cf5" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">继续扩展:</strong></p><p id="c802" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">如果到目前为止你已经做了所有的事情，你的博客现在完全按照你的预期运行。为了测试，继续运行<code class="eh lf lg lh li b">npm start</code>，在Cosmic中创建几个帖子并验证它们是否被获取。然后创建一个虚拟帐户，并确保它存储在宇宙和注册的条纹。然后，我们将为Cosmic构建我们的仪表板扩展。</p><h1 id="4195" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">第2部分:构建扩展</h1><p id="f506" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">Stripe为我们提供了令人印象深刻的大量分析，但是我们希望有一个中心位置来快速浏览我们所有用户的列表、他们的订阅计划以及关于我们博客的三个关键指标:迄今为止的收入、活跃订阅和迄今为止的取消。</p><p id="9077" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">Cosmic JS通过利用它的扩展特性让我们能够做到这一点，这让我们可以上传一个以<code class="eh lf lg lh li b">index.html</code>为入口点的SPA，该SPA被加载到我们的Cosmic仪表盘的一个框架中。然后通过URL查询字符串向它提供桶键。</p><p id="c2e3" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">我们将使用React构建扩展，因为我们的扩展只需要一个视图层。</p><h1 id="3964" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">设置</h1><p id="5c41" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">为了保持有序，我们将应用程序存储在<code class="eh lf lg lh li b">CosmicUserBlog</code>目录下。我们的树看起来会像这样:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="3c33" class="lr jd hu li b fv ls lt l lu lv">CosmicUserBlog<br/>|<br/>|--extensions<br/>| |--subscription-management<br/>| | |--client<br/>| | | |--components<br/>| | | |--index.js<br/>| | | |--index.html<br/>| | |--dist</span></pre><p id="da96" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">一旦你有了合适的目录结构，运行<code class="eh lf lg lh li b">yarn init</code>，我们将继续安装。</p><h1 id="9dac" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">装置</h1><p id="bd3c" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">我们需要这些包:</p><ul class=""><li id="7eaf" class="lw lx hu kc b kd kz kh la kl ly kp lz kt ma kx mb mc md me dt translated">异步ˌ非同步(asynchronous)</li><li id="103e" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">axios</li><li id="e0d6" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">巴别塔-预设-2015</li><li id="0018" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">巴别塔-预设-2016</li><li id="b4c0" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">cosmicjs</li><li id="7100" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">html-webpack-plugin——用web pack生成我们的html</li><li id="b262" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">洛达什</li><li id="81fa" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">查询字符串——一种解析桶键的简单方法</li><li id="4b6c" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">小路</li><li id="0c9b" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">反应</li><li id="54f7" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">反应范围</li><li id="d0a7" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">反作用载荷</li><li id="77a9" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">网络包</li><li id="a8be" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">巴别塔核心</li><li id="633b" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">巴别塔装载机</li><li id="b5cf" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx mb mc md me dt translated">巴别塔-预设-反应</li></ul><p id="0233" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">运行<code class="eh lf lg lh li b">yarn add async axios babel-preset-2015 babel-preset-2016 cosmicjs html-webpack-plugin lodash query-string path react react-dom react-loading webpack babel-core babel-loader-babel-preset-react</code>，然后我们就开始潜水。</p><h1 id="95bb" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">配置Webpack和Babel</h1><p id="e267" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">首先，在根文件夹中创建<code class="eh lf lg lh li b">.babelrc</code>,并告诉它如何传输我们的代码:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="5a80" class="lr jd hu li b fv ls lt l lu lv">// .babelrc</span><span id="4fb4" class="lr jd hu li b fv mx lt l lu lv">{<br/>  "presets": [<br/>    "es2016", "es2015", "react"<br/>  ]<br/>}</span></pre><p id="6ec1" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">然后，再次在<code class="eh lf lg lh li b">CosmicUserBlog/extensions/subscription-management</code>下，make <code class="eh lf lg lh li b">webpack.config.js</code>以便我们可以告诉Webpack如何打包我们的模块。</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="1227" class="lr jd hu li b fv ls lt l lu lv">const path = require('path')<br/>const HtmlWebpackPlugin = require('html-webpack-plugin')</span><span id="3036" class="lr jd hu li b fv mx lt l lu lv">module.exports = {<br/>  entry: './client/index.js',<br/>  output: {<br/>    path: path.resolve('dist'),<br/>    filename: 'index_bundle.js'<br/>  },<br/>  module: {<br/>    loaders: [<br/>      { test: /\.js$/, loader: 'babel-loader', exclude: /node_modules/ }<br/>    ]<br/>  },<br/>  plugins: [<br/>    new HtmlWebpackPlugin({<br/>      template: './client/index.html',<br/>      filename: 'index.html',<br/>      inject: 'body'<br/>    })<br/>  ]<br/>}</span></pre><p id="d6ca" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><code class="eh lf lg lh li b">dist</code>将包含我们所有的输出文件(那些是<code class="eh lf lg lh li b">index_bundle.js</code>和<code class="eh lf lg lh li b">index.html</code>)，我们最终将压缩<code class="eh lf lg lh li b">dist</code>作为我们的扩展上传。html-webpack-plugin将从<code class="eh lf lg lh li b">client/index.html</code>获取我们的html模板，并在构建时链接到<code class="eh lf lg lh li b">dist/index.html</code>中我们编译的javascript。</p><h1 id="a672" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">创建一个条目文件</h1><p id="a1cc" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">我们想使用Boostrap，我们需要一个<code class="eh lf lg lh li b">div</code>(我们将标识为<code class="eh lf lg lh li b">root</code>)来装载React应用程序。<code class="eh lf lg lh li b">client/index.html</code>应该是这样的:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="a445" class="lr jd hu li b fv ls lt l lu lv">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>  &lt;head&gt;<br/>    &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /&gt;<br/>  &lt;/head&gt;<br/>  &lt;body&gt;<br/>    &lt;div id="root"&gt;<br/>      &lt;script<br/>        src="https://code.jquery.com/jquery-3.2.1.min.js"<br/>        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="<br/>        crossorigin="anonymous"&gt;&lt;/script&gt;<br/>      &lt;script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"&gt;&lt;/script&gt;<br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><h1 id="7003" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">构建React应用程序</h1><p id="a9ec" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated"><strong class="kc hv"> 1。创建一个入口点</strong></p><p id="68ff" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">我们已经准备好开始动手了。我们将使用<code class="eh lf lg lh li b">client/index.js</code>作为React应用程序的入口点。我们将导入React，将其设置为一个全局变量，在它的props中将我们的宇宙键传递给它，并将App组件(接下来我们将制作)挂载到<code class="eh lf lg lh li b">&lt;div id="root"&gt;</code>。</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="8fbc" class="lr jd hu li b fv ls lt l lu lv">import React from 'react'<br/>import ReactDom from 'react-dom'<br/>import App from './components/App'<br/>import QueryString from 'query-string'</span><span id="37f6" class="lr jd hu li b fv mx lt l lu lv">window.React = React<br/>const url = QueryString.parse(location.search)</span><span id="320c" class="lr jd hu li b fv mx lt l lu lv">const cosmic = { bucket: {<br/>    slug: url.bucket_slug,<br/>    write_key: url.write_key,<br/>    read_key: url.read_key<br/>  }<br/>}</span><span id="b438" class="lr jd hu li b fv mx lt l lu lv">ReactDom.render(<br/>  &lt;App cosmic={cosmic}/&gt;,<br/>  document.getElementById('root')<br/>)</span></pre><p id="cfbe" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv"> 2。构建应用组件</strong></p><p id="d73e" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">为了让我们的应用保持模块化，我们将采用分层组件结构，如下所示:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="3f41" class="lr jd hu li b fv ls lt l lu lv">components<br/>|<br/>|--App.js<br/>|--Header.js<br/>|--SubscriberData<br/>| |<br/>| |--SubscriberContainer.js<br/>| |--Loader.js<br/>| |--StatsContainer.js<br/>| |--StatTicker.js<br/>| |--UserList.js</span></pre><p id="bd00" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><code class="eh lf lg lh li b">Header</code>和<code class="eh lf lg lh li b">SubscriberContainer</code>将是<code class="eh lf lg lh li b">App</code>的直接子节点。<code class="eh lf lg lh li b">Loader</code>、<code class="eh lf lg lh li b">UserList</code>、<code class="eh lf lg lh li b">StatsContainer</code>都是<code class="eh lf lg lh li b">SubcriberContainer</code>的直接子节点。最后，<code class="eh lf lg lh li b">StatsContainer</code>将由<code class="eh lf lg lh li b">StatTicker</code>组成</p><p id="6e62" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">除了保持一个有组织的项目之外，这种结构允许我们最大化我们的无状态功能组件的数量，这些组件不是React类，而且也很快。</p><p id="d90e" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">从层次结构的顶端开始，我们将构建一个应用程序组件，它将我们的宇宙键存储在其状态中，并呈现一个<code class="eh lf lg lh li b">Header</code>和一个<code class="eh lf lg lh li b">SubscriberContainer</code>。</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="6a8f" class="lr jd hu li b fv ls lt l lu lv">// components/App.js</span><span id="504f" class="lr jd hu li b fv mx lt l lu lv">import { Component } from 'react'<br/>import Header from './Header'<br/>import SubscriberContainer from './SubscriberData/SubscriberContainer'</span><span id="a58a" class="lr jd hu li b fv mx lt l lu lv">export default class App extends Component {</span><span id="e199" class="lr jd hu li b fv mx lt l lu lv">  constructor(props) {<br/>    super(props)<br/>    this.state = {<br/>      cosmic: this.props.cosmic<br/>    }<br/>  }</span><span id="5d1a" class="lr jd hu li b fv mx lt l lu lv">  render() {<br/>    return (<br/>      &lt;div&gt;<br/>        &lt;Header<br/>          bucket={this.state.cosmic.bucket.slug} /&gt;<br/>        &lt;SubscriberContainer<br/>          cosmic={this.state.cosmic} /&gt;<br/>      &lt;/div&gt;<br/>    )<br/>  }<br/>}</span></pre><p id="2cf3" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">下一个明显的步骤是构建头部组件。</p><p id="b4a4" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">构建标题:</strong></p><p id="9dd6" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">Header将是我们的第一个无状态功能组件，仅将我们的bucket slug作为道具:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="fb8f" class="lr jd hu li b fv ls lt l lu lv">const Header = ({ bucket }) =&gt;<br/>  &lt;nav className="navbar navbar-default"&gt;<br/>    &lt;div className="container-fluid"&gt;<br/>      &lt;ul className="nav navbar-nav"&gt;<br/>        &lt;li className="navbar-text"&gt;&lt;strong&gt;Managing Subscriptions for: &lt;/strong&gt;&lt;em&gt;{bucket}&lt;/em&gt;&lt;/li&gt;<br/>      &lt;/ul&gt;<br/>    &lt;/div&gt;<br/>  &lt;/nav&gt;</span><span id="b6e8" class="lr jd hu li b fv mx lt l lu lv">export default Header</span></pre><p id="aece" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv">构建订户容器:</strong></p><p id="3057" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><code class="eh lf lg lh li b">SubscriberContainer</code>将处理与我们的用户数据相关的所有逻辑，并呈现<code class="eh lf lg lh li b">StatsContainer</code>和<code class="eh lf lg lh li b">UserList</code>来显示它处理的数据。</p><p id="bd11" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><code class="eh lf lg lh li b">SubscriberContainer</code>将是一个包含以下内容的有状态React类:</p><ol class=""><li id="2dbd" class="lw lx hu kc b kd kz kh la kl ly kp lz kt ma kx my mc md me dt translated">一个构造函数，初始化<code class="eh lf lg lh li b">SubscriberContainer</code>的状态以包含我们的宇宙键(我们作为道具传递的)并反映我们的订户数据。我们将收入、用户和取消统计初始化为<code class="eh lf lg lh li b">'Loading…'</code>，将它们的加载状态初始化为<code class="eh lf lg lh li b">true</code>。</li><li id="e204" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">一个对<code class="eh lf lg lh li b">componentDidMount()</code>的覆盖，让我们的组件在装载到DOM后获取我们需要的数据，然后每分钟刷新一次数据。</li><li id="6ffb" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">一个<code class="eh lf lg lh li b">getRevenue()</code>方法，通过迭代来自Cosmic的活跃用户的订阅类型，并在状态中存储计算的收入，来获取(以公认的黑客方式)我们的收入。</li><li id="72cf" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">一个<code class="eh lf lg lh li b">getUsers()</code>方法从Cosmic中获取我们所有的用户，并将他们存储在state中的一个数组中，以及他们的总数。</li><li id="0510" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">一个<code class="eh lf lg lh li b">getCancellations()</code>方法从我们的<code class="eh lf lg lh li b">Subscriptions</code>配置对象中获取取消订阅的数量。(稍后，我们将使用Stripe的webhook更新该数字。)</li><li id="452c" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">一个<code class="eh lf lg lh li b">render()</code>方法来呈现我们的<code class="eh lf lg lh li b">Loader</code>组件(仅当我们获取数据时)、<code class="eh lf lg lh li b">StatsContainer</code>和<code class="eh lf lg lh li b">UserList</code>。</li></ol><p id="8f56" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">综上所述，我们有了这个:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="10b8" class="lr jd hu li b fv ls lt l lu lv">import { Component } from 'react'<br/>import Cosmic from 'cosmicjs'<br/>import async from 'async'<br/>import _ from 'lodash'<br/>import StatsContainer from './StatsContainer'<br/>import Loader from './Loader'<br/>import UserList from './UserList'</span><span id="5a89" class="lr jd hu li b fv mx lt l lu lv">const formatter = new Intl.NumberFormat('en-US', {<br/>  style: 'currency',<br/>  currency: 'USD',<br/>  minimumFractionDigits: 2<br/>})</span><span id="b3ab" class="lr jd hu li b fv mx lt l lu lv">export default class App extends Component {<br/> <br/>  constructor(props) {<br/>    super(props)<br/>    this.state = {<br/>      cosmic: this.props.cosmic,<br/>      stats: {<br/>        revenue: 'Loading...',<br/>        users: 'Loading...',<br/>        cancellations: 'Loading...'<br/>      },<br/>      users: [],<br/>      fetchingRevenue: true,<br/>      fetchingUsers: true,<br/>    }<br/>  }</span><span id="fa83" class="lr jd hu li b fv mx lt l lu lv">  fetchData() {<br/>    this.getRevenue();this.getUsers();this.getCancellations()<br/>  }</span><span id="d06f" class="lr jd hu li b fv mx lt l lu lv">  componentDidMount() {<br/>    this.fetchData()<br/>    setInterval(() =&gt; {<br/>      this.fetchData()<br/>    }, 60000)<br/>  }</span><span id="f762" class="lr jd hu li b fv mx lt l lu lv">  getRevenue(cosmic) {<br/>    this.setState({ fetchingRevenue: true})<br/>    async.series([<br/>      callback =&gt; {<br/>        Cosmic.getObject(this.state.cosmic, { slug: 'subscriptions' }, (err, response) =&gt; {<br/>          callback(null, response.object)<br/>        })<br/>      },<br/>      callback =&gt; {<br/>        Cosmic.getObjectType(this.state.cosmic, { type_slug: 'users' }, (err, response) =&gt; {<br/>          callback(null, response.objects.all)<br/>        })<br/>      }<br/>    ], (err, results) =&gt; {<br/>      let subscriptions = results[0], users = results[1];<br/>      let currentStats = this.state.stats<br/>      currentStats.revenue = formatter.format(users.map(user =&gt;<br/>        parseInt(subscriptions.metadata[`${user.metadata.subscription_type}_price`].replace('$', ''))<br/>      )<br/>      .reduce((sum, val) =&gt; sum + val))<br/>      this.setState({ stats: currentStats })<br/>      this.setState({ fetchingRevenue: false })<br/>    })<br/>  }</span><span id="7d51" class="lr jd hu li b fv mx lt l lu lv">  getUsers(cosmic) {<br/>    this.setState({ fetchingUsers: true })<br/>    Cosmic.getObjectType(this.state.cosmic, { type_slug: 'users' }, (err, response) =&gt; {<br/>      if (err) {<br/>        currentStats = this.state.stats<br/>        currentStats.users = 'Error'<br/>        this.setState({ stats: currentStats })<br/>      } else {<br/>        let currentStats = this.state.stats<br/>        currentStats.users = isNaN(response.total) ? 0 : response.total<br/>        this.setState({ stats: currentStats })<br/>        this.setState({ users: response.objects.all })<br/>        this.setState({ fetchingUsers: false })<br/>      }<br/>    })<br/>  }</span><span id="1711" class="lr jd hu li b fv mx lt l lu lv">  getCancellations(cosmic) {<br/>    this.setState({ fetchingCancellations: true})<br/>    Cosmic.getObject(this.state.cosmic, { slug: 'subscriptions' }, (err, response) =&gt; {<br/>      if (err) {<br/>        currentStats = this.state.stats<br/>        currentStats.users = 'Error'<br/>        this.setState({ stats: currentStats })<br/>      } else {<br/>        let currentStats = this.state.stats<br/>        currentStats.cancellations = isNaN(response.object.metadata.cancellations) ? 0: response.object.metadata.cancellations<br/>        this.setState({ stats: currentStats })<br/>        this.setState({ fetchingCancellations: false })<br/>      }<br/>    })<br/>  }</span><span id="0860" class="lr jd hu li b fv mx lt l lu lv">  render() {<br/>    return (<br/>      &lt;div className="container"&gt;<br/>        &lt;Loader loadingState={this.state.fetchingUsers || this.state.fetchingRevenue || this.state.fetchingCancellations} /&gt;<br/>        &lt;StatsContainer stats={this.state.stats} /&gt;<br/>        &lt;UserList users={this.state.users}/&gt;<br/>      &lt;/div&gt;<br/>    )<br/>  }<br/>}</span></pre><p id="282c" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">我们现在只剩下四个无状态的功能组件需要构建。这些是:</p><p id="2612" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv"> 1。加载器:</strong></p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="26c0" class="lr jd hu li b fv ls lt l lu lv">import ReactLoading from 'react-loading'</span><span id="8c81" class="lr jd hu li b fv mx lt l lu lv">const Loader = ({ loadingState }) =&gt;<br/>  &lt;div className="row" style={{display: loadingState ? 'block' : 'none' }}&gt;<br/>    &lt;div className="col-xs-12"&gt;<br/>      &lt;div className="pull-right"&gt;<br/>        &lt;ReactLoading height='20px' width='20px' type="spin" color="#444" /&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;</span><span id="674f" class="lr jd hu li b fv mx lt l lu lv">export default Loader</span></pre><p id="f248" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">这利用了便利的<code class="eh lf lg lh li b">react-loading</code>包。</p><p id="f9f2" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv"> 2。StatsContainer: </strong></p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="b68a" class="lr jd hu li b fv ls lt l lu lv">import StatTicker from './StatTicker'</span><span id="b9d2" class="lr jd hu li b fv mx lt l lu lv">const StatsContainer = ({ stats }) =&gt;<br/>  &lt;div className="row"&gt;{Object.keys(stats).map((key, index) =&gt;<br/>      &lt;div key={index} className="col-md-4 text-center"&gt;&lt;StatTicker name={key} value={stats[key]} /&gt;&lt;/div&gt;<br/>    )}<br/>  &lt;/div&gt;<br/></span><span id="4b5b" class="lr jd hu li b fv mx lt l lu lv">export default StatsContainer</span></pre><p id="49db" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv"> 3。施塔特克尔:</strong></p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="20e4" class="lr jd hu li b fv ls lt l lu lv">const StatTicker = ({ name, value }) =&gt;<br/>  &lt;div&gt;&lt;h3 className="lead text-muted"&gt;{name}&lt;/h3&gt;&lt;h1 className="text-primary"&gt;{value}&lt;/h1&gt;&lt;/div&gt;</span><span id="1646" class="lr jd hu li b fv mx lt l lu lv">export default StatTicker</span></pre><p id="0f27" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">最后…</p><p id="a6e5" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><strong class="kc hv"> 4。用户列表:</strong></p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="39f8" class="lr jd hu li b fv ls lt l lu lv">const UserList = ({ users, deleteUser }) =&gt;<br/>  &lt;div style={{marginTop: 50 + 'px'}} className="row"&gt;<br/>    &lt;div className="col-xs-12"&gt;<br/>      &lt;h4 className="pull-left lead"&gt;All Users:&lt;/h4&gt;<br/>      &lt;table className="table table-responsive table-hover"&gt;<br/>        &lt;thead&gt;<br/>          &lt;tr&gt;<br/>            &lt;th&gt;Stripe ID&lt;/th&gt;<br/>            &lt;th&gt;First Name&lt;/th&gt;<br/>            &lt;th&gt;Last Name&lt;/th&gt;<br/>            &lt;th&gt;Email&lt;/th&gt;<br/>          &lt;/tr&gt;<br/>        &lt;/thead&gt;<br/>        &lt;tbody&gt;<br/>          {users.map((user, index) =&gt;<br/>            &lt;tr key={index}&gt;<br/>              &lt;td&gt;{user.metadata.stripe_id}&lt;/td&gt;<br/>              &lt;td&gt;{user.metadata.first_name}&lt;/td&gt;<br/>              &lt;td&gt;{user.metadata.last_name}&lt;/td&gt;<br/>              &lt;td&gt;{user.metadata.email}&lt;/td&gt;<br/>            &lt;/tr&gt;<br/>          )}<br/>        &lt;/tbody&gt;<br/>      &lt;/table&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/></span><span id="2199" class="lr jd hu li b fv mx lt l lu lv">export default UserList</span></pre><h1 id="108f" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">集成条纹网钩</h1><p id="9987" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">为了获得我们取消的订户数，我们将在我们的Cosmic <code class="eh lf lg lh li b">Subscriptions</code>对象中更新一个<code class="eh lf lg lh li b">cancellations</code>元字段。为此，每次我们在Stripe上删除订阅时，都会通过我们的Express应用程序从Stripe收到一个webhook。</p><ol class=""><li id="b035" class="lw lx hu kc b kd kz kh la kl ly kp lz kt ma kx my mc md me dt translated">在Stripe中设置webhooks，并将它们指向您的Express应用程序部署到的域。</li><li id="a4e7" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">在<code class="eh lf lg lh li b">CosmicUserBlog/routes/api.js</code>处创建一条<code class="eh lf lg lh li b">api</code>路线，并在<code class="eh lf lg lh li b">App.js</code>处<code class="eh lf lg lh li b">require</code>它。</li><li id="c173" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">用作用于<code class="eh lf lg lh li b">req.body</code>的<code class="eh lf lg lh li b">switch</code>语句处理POST请求。当Stripe向我们发送订阅取消webhook时，<code class="eh lf lg lh li b">req.body.type</code>将会是<code class="eh lf lg lh li b">customer.subscription.deleted</code>。</li><li id="b595" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">从Cosmic中删除用户对象，从Cosmic中获取订阅对象，浅拷贝对象，递增<code class="eh lf lg lh li b">metadata.cancellations</code>，然后使用Cosmic的REST API将更改推送到对象。</li><li id="12c6" class="lw lx hu kc b kd mf kh mg kl mh kp mi kt mj kx my mc md me dt translated">回复一个<code class="eh lf lg lh li b">200</code>代码，这样Stripe就可以确认收到了webhook。</li></ol><p id="c43d" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">这是成品:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="ab03" class="lr jd hu li b fv ls lt l lu lv">var express = require('express')<br/>var router = express.Router()<br/>var cosmic = require('cosmicjs')<br/>var axios = require('axios')</span><span id="510d" class="lr jd hu li b fv mx lt l lu lv">router.post('/', function(req, res) {<br/>  event = req.body<br/>  switch (event.type) {<br/>    case 'customer.subscription.deleted':<br/>      cosmic.deleteObject(req.app.locals.config, { slug: 'user', write_key: req.app.locals.config.bucket.slug }, function (err, response) {<br/>        cosmic.getObject(req.app.locals.config, { slug: 'subscriptions' }, function (err, response) {<br/>          var currentObject = response.object<br/>          currentObject.metadata.cancellations = currentObject.metadata.cancellations + 1<br/>          currentObject.metafield.cancellations.value = currentObject.metadata.cancellations + 1<br/>          currentObject.write_key = req.app.locals.config.bucket.write_key<br/>          axios({<br/>            method: 'put',<br/>            url: `https://api.cosmicjs.com/v1/${req.app.locals.config.bucket.slug}/edit-object`,<br/>            data: currentObject<br/>          }).then(function (axRes) {<br/>            console.log('Success')<br/>          }).catch(function (axError) {<br/>            console.log('Error')<br/>          })<br/>        })<br/>      })<br/>      return res.json({ received: true})<br/>      break;<br/>    default:<br/>      return res.json({ received: false })<br/>  }<br/>});</span><span id="2b3c" class="lr jd hu li b fv mx lt l lu lv">module.exports = router</span></pre><h1 id="b392" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">部署</h1><p id="35df" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">要告诉Cosmic你的扩展名是什么，你需要将<code class="eh lf lg lh li b">extension.json</code>添加到你的<code class="eh lf lg lh li b">dist</code>文件夹中。我们将这样配置我们的扩展:</p><pre class="lj lk ll lm fq ln li lo lp aw lq dt"><span id="f296" class="lr jd hu li b fv ls lt l lu lv">// dist/extension.json</span><span id="fa5c" class="lr jd hu li b fv mx lt l lu lv">{<br/>  "title": "Subscription Management",<br/>  "font_awesome_class": "fa-gears",<br/>  "image_url": ""<br/>}</span></pre><h1 id="5a7c" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">结论</h1><p id="5ae9" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">使用Cosmic JS、Express、Stripe和React，我们建立了一个可盈利的博客，让我们的读者订阅阅读优质内容，以及一个方便的仪表板来查看我们博客的数据。我们已经为安全支付集成了Stripe，并且我们已经开发了一个应用程序，它可以做我们想做的事情，并有增长空间。</p><p id="a8b8" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">鉴于我们能够如此快速地构建我们的应用程序，以及部署和维护它的简单性，很明显，Cosmic JS在其API优先的内容管理方法中是独一无二的。很明显，CosmisJS是一个赚钱机器。</p><p id="eed6" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><em class="le">本文原载于</em> <a class="ae ky" href="https://cosmicjs.com/blog/start-a-premium-content-business-using-nodejs-react-and-cosmic-js-extensions" rel="noopener ugc nofollow" target="_blank"> <em class="le">宇宙JS博客</em> </a> <em class="le">。</em></p><p id="c4e8" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">Matt Cain构建了智能web应用程序，并介绍了构建这些应用程序所使用的技术。你可以在他的 <a class="ae ky" href="http://mattcain.io/" rel="noopener ugc nofollow" target="_blank"> <em class="le">作品集</em> </a>上了解更多关于他的信息。</p></div></div>    
</body>
</html>