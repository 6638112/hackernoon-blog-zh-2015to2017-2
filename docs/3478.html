<html>
<head>
<title>AWS Lambda — build yourself a URL shortener in 2 hours</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Lambda——在2小时内为自己构建一个网址缩写器</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/aws-lambda-build-yourself-a-url-shortener-in-2-hours-94f9627ed4a6?source=collection_archive---------3-----------------------#2017-04-04">https://medium.com/hackernoon/aws-lambda-build-yourself-a-url-shortener-in-2-hours-94f9627ed4a6?source=collection_archive---------3-----------------------#2017-04-04</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="414f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">本周工作中出现了一个有趣的需求，我们讨论了可能必须运行我们自己的URL缩短器，因为<em class="jp">通用链接</em>机制(在iOS 9及以上版本)<a class="ae jq" href="http://blog.hokolinks.com/how-to-implement-apple-universal-links-on-ios-9/" rel="noopener ugc nofollow" target="_blank">需要一个JSON清单</a></p><blockquote class="jr js jt"><p id="95d9" class="ir is jp it b iu iv iw ix iy iz ja jb ju jd je jf jv jh ji jj jw jl jm jn jo hn dt translated">【https://domain.com/apple-app-site-association T4】</p></blockquote><p id="64e9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">由于操作系统不遵循重定向，该清单必须托管在URL缩写的根域上。</p><p id="a6b0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">由于对<em class="jp">应用程序</em>的限制，当你为你的应用程序配置了<em class="jp">通用链接</em>时，目前<a class="ae jq" href="https://support.appsflyer.com/hc/en-us/articles/207032266-Setting-Deeplinking-in-iOS9-and-above-using-iOS-Universal-Links" rel="noopener ugc nofollow" target="_blank">无法缩短链接</a>。虽然我们可以切换到另一个供应商，这意味着我们的(已经捉襟见肘的)客户端开发人员要做更多的工作，我们真的很喜欢<em class="jp"> AppsFlyer </em>对属性的支持。</p><p id="2d0c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这又把我们带回了这个问题</p><blockquote class="jr js jt"><p id="0f8f" class="ir is jp it b iu iv iw ix iy iz ja jb ju jd je jf jv jh ji jj jw jl jm jn jo hn dt translated">"我们应该建立一个网址缩短器吗？"</p></blockquote><p id="b949" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">紧接着</p><blockquote class="jr js jt"><p id="56fb" class="ir is jp it b iu iv iw ix iy iz ja jb ju jd je jf jv jh ji jj jw jl jm jn jo hn dt translated">“2017年打造一个可扩展的网址缩短器能有多难？”</p></blockquote><p id="d92c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">事实证明，这一点也不难，因为我用了不到两个小时就实现、测试和部署了所有东西！</p><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="fe ff jx"><img src="../Images/4e8b9c3120d37e48113bf3d59971c864.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eBQwpVbKVcRdYdZF."/></div></div></figure><h1 id="bc95" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">FTW</h1><p id="5e99" class="pw-post-body-paragraph ir is hu it b iu lh iw ix iy li ja jb jc lj je jf jg lk ji jj jk ll jm jn jo hn dt translated">对于这个网址缩写，我们需要几样东西:</p><ol class=""><li id="e08d" class="lm ln hu it b iu iv iy iz jc lo jg lp jk lq jo lr ls lt lu dt translated">一个<strong class="it hv"> GET /{shortUrl} </strong>端点，它会将您重定向到原始Url</li><li id="bde9" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo lr ls lt lu dt translated">一个<strong class="it hv"> POST / </strong>端点，它将接受原始URL并返回缩短的URL</li><li id="5ea9" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo lr ls lt lu dt translated">一个index.html页面，在这里人们可以很容易地创建简短的URL</li><li id="e972" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo lr ls lt lu dt translated">一个提供静态JSON响应的<strong class="it hv">GET/apple-app-site-association</strong>端点</li></ol><p id="c558" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所有这些都可以用<em class="jp"> API Gateway + Lambda </em>来完成。</p><p id="f3ca" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">总的来说，这是我最终得到的项目结构:</p><ul class=""><li id="95cc" class="lm ln hu it b iu iv iy iz jc lo jg lp jk lq jo ma ls lt lu dt translated">使用<a class="ae jq" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器</a>框架的<strong class="it hv">模板</strong></li><li id="9a8b" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">上述每个端点都有一个相应的处理函数</li><li id="1e03" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated"><strong class="it hv"><em class="jp">index.html</em></strong>文件在<em class="jp">静态</em>文件夹中</li><li id="31b8" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">测试用例以这样的方式编写，它们既可以用作集成测试<a class="ae jq" href="http://theburningmonk.com/2017/02/yubls-road-to-serverless-architecture-part-2/" rel="noopener ugc nofollow" target="_blank">，也可以用作验收测试</a></li><li id="6d81" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">有一个<strong class="it hv"> <em class="jp"> build.sh </em> </strong>脚本，方便运行…</li><li id="63e4" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">集成测试，如<strong class="it hv"> <em class="jp">。/build . sh int-test { env } { region } { AWS _ profile }</em>T45】</strong></li><li id="4a20" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">验收测试，如<strong class="it hv"> <em class="jp">。/build.sh验收测试{ env } { region } { AWS _ profile }</em>T3】</strong></li><li id="f574" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">部署完毕，如<strong class="it hv">T5。/build.sh部署{ env } { region } { AWS _ profile }</strong></li></ul><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div class="fe ff mb"><img src="../Images/da3f390a65bc8882784e6bd0cf746273.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/0*yHxdWarvqLGtxNWu."/></div></figure><h1 id="4fa0" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">获取/apple-app-site-association端点</h1><p id="161c" class="pw-post-body-paragraph ir is hu it b iu lh iw ix iy li ja jb jc lj je jf jg lk ji jj jk ll jm jn jo hn dt translated">因为这是一个静态JSON blob，所以每次预先计算HTTP响应并返回它是有意义的。</p><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div class="fe ff mc"><img src="../Images/a3030fe744d25e92be92842f1faf0461.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*jY1eFNqvtfX-QQqX."/></div></figure><h1 id="1aca" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">发布/结束</h1><p id="8b30" class="pw-post-body-paragraph ir is hu it b iu lh iw ix iy li ja jb jc lj je jf jg lk ji jj jk ll jm jn jo hn dt translated">对于缩短URL的算法，你可以在StackOverflow上找到一个非常简单优雅的<a class="ae jq" href="http://stackoverflow.com/questions/742013/how-to-code-a-url-shortener/742047#742047" rel="noopener ugc nofollow" target="_blank">解决方案</a>。您所需要的只是一个自动递增的ID，就像您通常从RDBMS获得的ID一样。</p><p id="68b1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然而，我发现<em class="jp"> DynamoDB </em>在这里是一个更合适的DB选择，因为:</p><ul class=""><li id="da50" class="lm ln hu it b iu iv iy iz jc lo jg lp jk lq jo ma ls lt lu dt translated">这是一项托管服务，所以我不需要担心基础设施</li><li id="f5b5" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">OPEX超过资本支出，伙计！</li><li id="bc61" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">我可以灵活地扩展读写吞吐量，以匹配利用率水平并处理任何流量峰值</li></ul><p id="2c1a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是，<em class="jp"> DynamoDB </em>没有算法需要的自动递增ID这样的概念。相反，您可以使用一个<a class="ae jq" href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithItems.html#WorkingWithItems.AtomicCounters" rel="noopener ugc nofollow" target="_blank">原子计数器</a>来模拟一个自动递增的ID(代价是每个请求增加一个额外的写单元)。</p><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div class="fe ff md"><img src="../Images/62b1dec558116a1f5a63a3fa62fbc7b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*1S-ioKCj4C8d9zpG."/></div></figure><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div class="fe ff md"><img src="../Images/57a34c19b1ad153b80026b0e784b076f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*hyO-U2JPENSamJ3H."/></div></figure><h1 id="a505" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">GET /{shortUrl}端点</h1><p id="c6ec" class="pw-post-body-paragraph ir is hu it b iu lh iw ix iy li ja jb jc lj je jf jg lk ji jj jk ll jm jn jo hn dt translated">一旦我们在一个<em class="jp"> DynamoDB </em>表中有了映射，那么<em class="jp">重定向</em>端点就是一件简单的事情，获取原始URL并将其作为<em class="jp">位置</em>头的一部分返回。</p><p id="8f33" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">哦，不要忘记返回适当的HTTP状态代码，在本例中是一个<em class="jp"> 308永久重定向</em>。</p><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div class="fe ff md"><img src="../Images/255bc2605c182d82dcb669c1a295aff2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*jqOfS91Kb-oLAriK."/></div></figure><h1 id="6090" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">获取/索引页面</h1><p id="33a2" class="pw-post-body-paragraph ir is hu it b iu lh iw ix iy li ja jb jc lj je jf jg lk ji jj jk ll jm jn jo hn dt translated">最后，对于索引页面，我们需要返回一些HTML(和一个不同的HTML内容类型)。</p><p id="a044" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我决定将HTML文件放在一个静态文件夹中，这个文件夹在第一次调用函数时被加载和缓存。</p><figure class="jy jz ka kb fq kc fe ff paragraph-image"><div class="fe ff md"><img src="../Images/75d9e1316ec6a9705a6fd280c1920d9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*mmopbf7wsVoE_-Ee."/></div></figure><h1 id="6f7b" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">为生产做准备</h1><p id="f9c7" class="pw-post-body-paragraph ir is hu it b iu lh iw ix iy li ja jb jc lj je jf jg lk ji jj jk ll jm jn jo hn dt translated">幸运的是，我有足够的实践经验<a class="ae jq" href="http://theburningmonk.com/2017/03/slides-for-my-aws-user-group-talk-aws-lambda-from-the-trenches/" rel="noopener ugc nofollow" target="_blank">让Lambda函数为生产做好准备</a>，对于这个URL shortener，我们需要:</p><ul class=""><li id="1abe" class="lm ln hu it b iu iv iy iz jc lo jg lp jk lq jo ma ls lt lu dt translated">为<em class="jp"> DynamoDB </em>表配置自动缩放参数(我们有一个内部系统来管理自动缩放)</li><li id="bd28" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">为生产阶段打开<em class="jp"> API网关</em>中的缓存</li></ul><h1 id="243e" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">未来的改进</h1><p id="b602" class="pw-post-body-paragraph ir is hu it b iu lh iw ix iy li ja jb jc lj je jf jg lk ji jj jk ll jm jn jo hn dt translated">如果你多次输入相同的url，你会得到不同的短URL，一个优化(对于存储和缓存)是返回相同的短URL。</p><p id="bf8b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为此，您可以:</p><ol class=""><li id="b84b" class="lm ln hu it b iu iv iy iz jc lo jg lp jk lq jo lr ls lt lu dt translated">将GSI添加到<em class="jp"> longUrl </em>属性的<em class="jp"> DynamoDB </em>表中，以支持高效的反向查找</li><li id="92ba" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo lr ls lt lu dt translated">在<em class="jp"> shortenUrl </em>函数中，使用GSI执行GET来查找现有的短Url</li></ol><p id="5cdd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我认为在这里添加一个GSI比创建一个新表更好，因为它避免了跨越多个表的“事务”。</p><h1 id="dd3a" class="kj kk hu bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dt translated">有用的链接</h1><ul class=""><li id="6d22" class="lm ln hu it b iu lh iy li jc me jg mf jk mg jo ma ls lt lu dt translated"><a class="ae jq" href="http://blog.hokolinks.com/how-to-implement-apple-universal-links-on-ios-9/" rel="noopener ugc nofollow" target="_blank">分解iOS 9通用链接</a></li><li id="5f0a" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated"><a class="ae jq" href="http://theburningmonk.com/2017/03/slides-for-my-aws-user-group-talk-aws-lambda-from-the-trenches/" rel="noopener ugc nofollow" target="_blank">我的演讲幻灯片，介绍如何利用AWS Lambda为生产做好准备</a></li><li id="1374" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated"><a class="ae jq" href="http://theburningmonk.com/yubls-road-to-serverless-architecture/" rel="noopener ugc nofollow" target="_blank">我的关于将Yubl迁移到无服务器架构的系列文章</a></li><li id="a016" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated"><a class="ae jq" href="http://stackoverflow.com/questions/742013/how-to-code-a-url-shortener/742047#742047" rel="noopener ugc nofollow" target="_blank"> SO:缩短URL的算法</a></li></ul></div><div class="ab cl mh mi hc mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="hn ho hp hq hr"><p id="3111" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">喜欢您正在阅读的内容，但需要更多帮助？我很乐意作为一名独立顾问提供服务，帮助您完成无服务器项目——架构审查、代码审查、构建概念验证，或者提供关于领先实践和工具的建议。</p><p id="e3d4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我在<strong class="it hv">英国伦敦</strong>工作，目前是唯一一个在英国<a class="ae jq" href="https://aws.amazon.com/developer/community/heroes/yan-cui/" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv"> AWS无服务器英雄</strong> </a>。我有近<strong class="it hv"> 10年</strong>的<a class="ae jq" href="https://www.linkedin.com/in/theburningmonk/" rel="noopener ugc nofollow" target="_blank">经验</a>在AWS中大规模运行生产工作负载。我主要在英国开展业务，但我愿意出差一周以上。为了看看我们如何能够一起工作，在这里告诉我更多关于你试图解决的问题。</p><p id="fa31" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我还可以组织一个内部研讨会来帮助您的无服务器架构进入生产准备阶段。您可以在这里找到关于为期两天的研讨会<a class="ae jq" href="https://theburningmonk.com/workshops/" rel="noopener ugc nofollow" target="_blank">的更多信息，该研讨会将带您从AWS Lambda的基础知识一直到日志聚合、分发跟踪和安全最佳实践的通用操作模式。</a></p><p id="2399" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你喜欢按照自己的进度学习，那么你也可以找到所有与我为曼宁制作的<a class="ae jq" href="https://bit.ly/production-ready-serverless" rel="noopener ugc nofollow" target="_blank"><strong class="it hv"/></a>视频课程相同的研讨会内容。我们将讨论的主题包括:</p><ul class=""><li id="27e5" class="lm ln hu it b iu iv iy iz jc lo jg lp jk lq jo ma ls lt lu dt translated">认证<em class="jp"> &amp; </em>授权与API网关<em class="jp"> &amp; </em>认知</li><li id="cb0f" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">本地测试<em class="jp"> &amp; </em>运行功能</li><li id="25ea" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">CI/CD</li><li id="3af2" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">日志聚合</li><li id="649a" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">监控最佳实践</li><li id="8c34" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">X射线分布式跟踪</li><li id="8d1b" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">跟踪相关id</li><li id="880c" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated"><em class="jp">性能&amp;成本</em>优化</li><li id="1377" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">错误处理</li><li id="916b" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">配置管理</li><li id="8f57" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">金丝雀部署</li><li id="5d40" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">VPC</li><li id="908b" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">安全</li><li id="a387" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">Lambda、Kinesis和API网关的最佳实践</li></ul><p id="2e68" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你还可以用代码<strong class="it hv"> ytcui </strong>获得<strong class="it hv">票面价格的6折优惠</strong>。不过，这个数字只有在我们参加曼宁的早期访问计划(MEAP)时才有效。</p></div></div>    
</body>
</html>