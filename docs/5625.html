<html>
<head>
<title>Running karma tests with headless Chrome inside Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Docker中的无头Chrome运行karma测试</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/running-karma-tests-with-headless-chrome-inside-docker-ae4aceb06ed3?source=collection_archive---------2-----------------------#2017-08-07">https://medium.com/hackernoon/running-karma-tests-with-headless-chrome-inside-docker-ae4aceb06ed3?source=collection_archive---------2-----------------------#2017-08-07</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="0882" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在Docker容器中运行构建步骤、处理环境之间的隔离(防止依赖版本之间的冲突)、支持在不同操作系统(macOS、Linux、Windows)上开发和可靠的构建(稳定的构建环境)可能会很有用。</p><p id="26ae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在尝试建立这样的环境时，您会遇到一些障碍。我浏览了它们，并创建了一个示例样板项目，展示了一些设置。(注意我设置了一个使用<a class="ae jp" href="https://yarnpkg.com/lang/en/" rel="noopener ugc nofollow" target="_blank">纱</a>代替npm的项目；使用npm创建一个类似的设置是完全可能的。)</p><p id="4026" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可以在GitHub上查看完整的代码示例:</p><p id="fe71" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">【https://github.com/eirslett/chrome-karma-docker T2】号</p></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h2 id="d16a" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">向Docker图像添加Google Chrome</h2><p id="e59e" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">从node.js官方图片来看，从官方安装Chrome是有可能的。deb套餐。</p><p id="31b6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">还要注意，我添加了<a class="ae jp" href="https://github.com/Yelp/dumb-init" rel="noopener ugc nofollow" target="_blank">dumb-init</a>；它将你从许多痛苦和烦恼中解救出来，比如当你试图使用Ctrl+C来停止你的容器时。</p><pre class="kx ky kz la fq lb lc ld le aw lf dt"><span id="8ebd" class="jx jy hu lc b fv lg lh l li lj"><strong class="lc hv">FROM </strong>node:8.2.1<br/><br/><em class="lk"># OPTIONAL: Install dumb-init (Very handy for easier signal handling of SIGINT/SIGTERM/SIGKILL etc.)<br/></em><strong class="lc hv">RUN </strong>wget https:<strong class="lc hv">//</strong>github.com<strong class="lc hv">/</strong>Yelp<strong class="lc hv">/</strong>dumb-init<strong class="lc hv">/</strong>releases<strong class="lc hv">/</strong>download<strong class="lc hv">/</strong>v1.2.0<strong class="lc hv">/</strong>dumb-init_1.2.0_amd64.deb<br/><strong class="lc hv">RUN </strong>dpkg <strong class="lc hv">-</strong>i dumb-init_<strong class="lc hv">*</strong>.deb<br/><strong class="lc hv">ENTRYPOINT </strong>[<strong class="lc hv">"dumb-init"</strong>]<br/><br/><em class="lk"># Install Google Chrome<br/></em><strong class="lc hv">RUN </strong>wget <strong class="lc hv">-</strong>q <strong class="lc hv">-</strong>O <strong class="lc hv">- </strong>https:<strong class="lc hv">//</strong>dl-ssl.google.com<strong class="lc hv">/</strong>linux<strong class="lc hv">/</strong>linux_signing_key.pub | apt-key add <strong class="lc hv">-<br/>RUN </strong>sh <strong class="lc hv">-</strong>c <strong class="lc hv">'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" &gt;&gt; /etc/apt/sources.list.d/google.list'<br/>RUN </strong>apt-get update <strong class="lc hv">&amp;&amp; </strong>apt-get install <strong class="lc hv">-</strong>y google-chrome-stable</span><span id="4fd7" class="jx jy hu lc b fv ll lh l li lj"><strong class="lc hv">WORKDIR /</strong>opt<strong class="lc hv">/</strong>app</span><span id="c416" class="jx jy hu lc b fv ll lh l li lj"><strong class="lc hv">ADD </strong>package.json yarn.lock <strong class="lc hv">/</strong>opt<strong class="lc hv">/</strong>app<strong class="lc hv">/<br/>RUN </strong>yarn</span></pre></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h2 id="391f" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">检测Docker，并配置Karma</h2><p id="8d3b" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">事实证明，在Docker中运行Chrome存在一些问题。除非你在特权模式下运行容器，否则Chrome的沙箱不会工作。我们使用<a class="ae jp" href="https://github.com/sindresorhus/is-docker" rel="noopener ugc nofollow" target="_blank"> is-docker </a>包来检测进程是否在docker容器中运行。基于此，我们必须调整我们的构建配置:</p><pre class="kx ky kz la fq lb lc ld le aw lf dt"><span id="3567" class="jx jy hu lc b fv lg lh l li lj"><strong class="lc hv">const </strong>isDocker = require(<strong class="lc hv">'is-docker'</strong>)();<br/><br/>module.exports = config =&gt; config.set({<br/>  <strong class="lc hv">customLaunchers</strong>: {<br/>    <strong class="lc hv">ChromeCustom</strong>: {<br/>      <strong class="lc hv">base</strong>: <strong class="lc hv">'ChromeHeadless'</strong>,<br/>      <em class="lk">// We must disable the Chrome sandbox when running Chrome inside Docker (Chrome's sandbox needs<br/>      // more permissions than Docker allows by default)<br/>      </em><strong class="lc hv">flags</strong>: isDocker ? [<strong class="lc hv">'--no-sandbox'</strong>] : []<br/>    }<br/>  }<br/>  // more karma configuration here...<br/>}</span></pre><p id="a0a0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Karma应该与ChromeCustom浏览器一起运行。</p><h2 id="fe59" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">额外部分/非主题:web pack/web pack-dev-Docker内部的服务器</h2><p id="de62" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">如果您想在容器中运行Webpack或webpack-dev-server，您应该使用is-docker检测并调整一些配置:</p><ol class=""><li id="9a22" class="lm ln hu it b iu iv iy iz jc lo jg lp jk lq jo lr ls lt lu dt translated">如果在容器内部运行，将webpack-dev-server的主机设置为“0.0.0.0 ”,这样就可以从外部访问它</li><li id="8857" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo lr ls lt lu dt translated">如果在容器内运行，则将watchOptions设置为{ aggregateTimeout: 300，poll: 1000 }</li></ol></div><div class="ab cl jq jr hc js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hn ho hp hq hr"><h2 id="81b9" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">设置docker撰写</h2><p id="f0cd" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">我们可以使用docker-compose.yml来设置配置参数，而不是使用数量惊人的参数来运行docker run:</p><pre class="kx ky kz la fq lb lc ld le aw lf dt"><span id="6cdd" class="jx jy hu lc b fv lg lh l li lj"><strong class="lc hv">version: '3'<br/><br/>services:<br/>  dev:<br/>    build:<br/>      context: </strong>.<br/>      <strong class="lc hv">dockerfile: </strong>docker/dev/Dockerfile<br/>    <strong class="lc hv">working_dir: </strong>/opt/app<br/>    <strong class="lc hv">container_name: "dev"<br/>    volumes:<br/>      </strong>- <strong class="lc hv">"./:/opt/app"<br/>      </strong>- /opt/app/node_modules</span></pre><p id="ca9f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这将让我们运行“docker-compose run dev XXX”，例如，它将使用“XXX”作为命令来启动docker容器</p><ul class=""><li id="ea67" class="lm ln hu it b iu iv iy iz jc lo jg lp jk lq jo ma ls lt lu dt translated">docker-compose运行开发纱线</li><li id="6138" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">docker-合成运行开发纱线运行测试</li><li id="f5be" class="lm ln hu it b iu lv iy lw jc lx jg ly jk lz jo ma ls lt lu dt translated">docker-合成运行开发纱线运行构建</li></ul><h2 id="49b4" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">为了当地的发展</h2><p id="db43" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">如果可以在不运行Docker的情况下处理您的项目，那可能更好，因为您可以避免容器化的开销。然后，你应该可以直接“yarn run [whatever-command]”。</p><p id="6e14" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果您更喜欢在容器中处理项目，您可以使用“docker-compose run dev yarn run[whatever-command]”在容器中运行。</p><p id="74ae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">提示:将一个助手脚本“container.sh”添加到您的工作目录中:</p><pre class="kx ky kz la fq lb lc ld le aw lf dt"><span id="d616" class="jx jy hu lc b fv lg lh l li lj"><strong class="lc hv">#!/bin/bash<br/></strong>docker-compose run dev $@</span></pre><p id="727b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后你就可以跑了”。/container . sh yarn run[whatever-command]”，稍微短一点。</p><h2 id="d47d" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">在CI上运行</h2><p id="1dd7" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">确保Docker安装在CI实例上。(咄！)</p><p id="04a6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您可能希望为每次CI运行重建容器:</p><pre class="kx ky kz la fq lb lc ld le aw lf dt"><span id="720b" class="jx jy hu lc b fv lg lh l li lj">docker-compose build</span></pre><p id="35d4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">之后，您可以以同样的方式在容器内部运行CI构建脚本；</p><pre class="kx ky kz la fq lb lc ld le aw lf dt"><span id="960c" class="jx jy hu lc b fv lg lh l li lj">docker-compose run dev yarn run build</span></pre><p id="94b6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">仅此而已。祝你的容器化版本好运！</p></div></div>    
</body>
</html>