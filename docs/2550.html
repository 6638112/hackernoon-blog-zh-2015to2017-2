<html>
<head>
<title>Service Objects in Ruby on Rails…and you</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ruby on Rails中的服务对象…还有你</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/service-objects-in-ruby-on-rails-and-you-79ca8a1c946e?source=collection_archive---------2-----------------------#2017-02-03">https://medium.com/hackernoon/service-objects-in-ruby-on-rails-and-you-79ca8a1c946e?source=collection_archive---------2-----------------------#2017-02-03</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/b96ce7f2cd89c85ba6d240fe0a38674a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*piPSVsuuX-HonHEZpFNEMA.jpeg"/></div></div></figure><h1 id="e824" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">我把这些东西放在哪里？</h1><p id="eb97" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">注意:本教程是我的书<a class="ae ky" href="https://BuildASaaSAppinRails.com" rel="noopener ugc nofollow" target="_blank">构建SaaS Ruby on Rails 5 </a>中服务对象章节的摘录。这本书将通过将应用程序部署到生产中来指导你从卑微的开始。如果你发现这种类型的内容有价值，这本书现在正在出售！</p><p id="4845" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">此外，我的新项目<a class="ae ky" href="https://pullmanager.com" rel="noopener ugc nofollow" target="_blank">拉动式管理器</a>的测试版也差不多准备好了。如果你失去了对拉取请求的跟踪，让旧的请求留在身边，或者只是喜欢一个通过多个服务(Github、Gitlab和Bitbucket)聚集这些请求的仪表板，<a class="ae ky" href="https://pullmanager.com" rel="noopener ugc nofollow" target="_blank">看看</a>。</p></div><div class="ab cl le lf hc lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="hn ho hp hq hr"><p id="9e77" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">当你看到你的控制器动作变得太长，拥有太多的业务逻辑时，我们都有过这样的经历。你知道你需要给用户发电子邮件，调整账户，也许提交给Stripe，最后ping一个Slack Webhook。那么，它应该去哪里呢？这段代码需要存在，而且似乎不适合模型。我的朋友，这就是服务对象出现的地方！</p><p id="7400" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">一个服务对象有什么了不起的？我发现在大多数项目中，没有什么比POO(普通旧对象)更容易推理或测试的了，在我们的例子中，POO是PORO(普通旧Ruby对象)。也就是说，服务对象将是一个独立的类，不会从Ruby或Rails继承或扩展任何其他类。</p><p id="cc5a" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">注意:我会继续这篇文章，重构</p><h1 id="db41" class="jc jd hu bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">我们开始吧！</h1><p id="bb76" class="pw-post-body-paragraph ka kb hu kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx hn dt translated">默认情况下，Rails不会创建服务文件夹，所以创建一个是我们的工作。不过，有一点需要注意的是，根据应用程序的规模或业务逻辑的复杂性，您可能需要按照域、类型或其他限定符进一步细分服务。在这篇文章中，你可以在你的应用文件夹<code class="eh ll lm ln lo b">mkdir app/services</code>中创建一个服务文件夹</p><p id="6ee4" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">重启你的rails服务器来获取新的文件夹，因为Rails会自动加载app目录中的目录。现在我们可以为用户注册服务<code class="eh ll lm ln lo b">new_registration_service.rb</code>创建一个文件，并用我们的业务逻辑填充它。</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="9e55" class="lx jd hu lo b fv ly lz l ma mb">class NewRegistrationService<br/>  def initialize(params)<br/>    @user = params[:user]<br/>    @organization = params[:organization]<br/>  end</span><span id="517a" class="lx jd hu lo b fv mc lz l ma mb">def perform<br/>    organization_create<br/>    send_welcome_email<br/>    notify_slack<br/>  end</span><span id="e5e8" class="lx jd hu lo b fv mc lz l ma mb">private</span><span id="05d7" class="lx jd hu lo b fv mc lz l ma mb">def organization_create<br/>    post_organization_setup if @organization.save<br/>end</span><span id="7817" class="lx jd hu lo b fv mc lz l ma mb">def post_organization_setup<br/>    @user.organization_id = @organization.id<br/>    @user.save<br/>    @user.add_role :admin, @organization<br/> end</span><span id="6c40" class="lx jd hu lo b fv mc lz l ma mb">def send_welcome_email<br/>    WelcomeEmailMailer.welcome_email(@user).deliver_later<br/>end</span><span id="326a" class="lx jd hu lo b fv mc lz l ma mb">def notify_slack<br/>    notifier = Slack::Notifier.new "https://hooks.slack.com/services/89ypfhuiwquhfwfwef908wefoij"<br/>    notifier.ping "A New User has appeared! #{@organization.name} -   #{@user.name} || ENV: #{Rails.env}"<br/>end</span><span id="2ffb" class="lx jd hu lo b fv mc lz l ma mb">end</span></pre><p id="8bef" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">好吧！让我们一节一节地检查服务对象！</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="a500" class="lx jd hu lo b fv ly lz l ma mb">class NewRegistrationService<br/>  def initialize(params)<br/>    @user = params[:user]<br/>    @organization = params[:organization]<br/>  end</span></pre><p id="dca9" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">这里我们创建类，然后添加initialize方法，在实例化对象时创建所需的实例变量。在这种情况下，我们将传递先前在新用户注册控制器中创建的对象用户模型记录对象和组织记录对象。</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="3c33" class="lx jd hu lo b fv ly lz l ma mb">def perform<br/>    organization_create<br/>    send_welcome_email<br/>    notify_slack<br/>  end</span></pre><p id="63d1" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">就个人而言，我喜欢将整套业务逻辑的功能包装在一个执行方法中。我也看到一些支持者从控制器手动调用不同的方法。真的是你的喜好问题。</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="8256" class="lx jd hu lo b fv ly lz l ma mb">def organization_create<br/>    post_organization_setup if @organization.save<br/>end</span><span id="2a5c" class="lx jd hu lo b fv mc lz l ma mb">def post_organization_setup<br/>    @user.organization_id = @organization.id<br/>    @user.save<br/>    @user.add_role :admin, @organization<br/> end</span></pre><p id="de71" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">在这里，我们创建组织(之前在实例化该服务对象的控制器中验证过)，然后对用户进行必要的更新，例如添加belongs_to关系所需的organization_id，并为授权系统分配一个角色，该角色的范围是之前创建的组织。</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="c813" class="lx jd hu lo b fv ly lz l ma mb">def send_welcome_email<br/>    WelcomeEmailMailer.welcome_email(@user).deliver_later<br/>end</span></pre><p id="4eaf" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">使用用户对象快速调用Rail的ActionMailer</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="55c2" class="lx jd hu lo b fv ly lz l ma mb">def notify_slack<br/>    notifier = Slack::Notifier.new "https://hooks.slack.com/services/89ypfhuiwquhfwfwef908wefoij"<br/>    notifier.ping "A New User has appeared! #{@organization.name} -   #{@user.name} || ENV: #{Rails.env}"<br/>end</span></pre><p id="e07a" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">…最后通知我用于注册通知的Slack Webhook。</p><figure class="lp lq lr ls fq iv"><div class="bz el l di"><div class="md me l"/></div></figure><p id="f819" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">现在，您可能会对自己说，这很有意义，但是您如何以及在哪里调用这个服务对象呢？以下是从我的设计注册控制器中提取的代码，该控制器处理输入的注册表单及其所有的设计优点:</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="53c9" class="lx jd hu lo b fv ly lz l ma mb">NewRegistrationService.new({user: resource, organization: @org}).perform</span></pre><p id="9313" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">一些读者可能会开始质疑这篇文章中服务对象的某些方面。我发现服务对象没有很强的约定，我已经调整了这个来满足我的需求。前面，当我说您可以单独调用公共方法，而不是使用执行方法时，将允许您包装一些错误处理逻辑。比如这个:</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="8f33" class="lx jd hu lo b fv ly lz l ma mb">class NewRegistrationService<br/>  def initialize(params)<br/>    @user = params[:user]<br/>    @organization = params[:organization]<br/>  end</span><span id="c730" class="lx jd hu lo b fv mc lz l ma mb">def organization_create<br/>  begin<br/>    post_organization_setup if @organization.save<br/>  rescue<br/>    false<br/>  end<br/>end</span><span id="8389" class="lx jd hu lo b fv mc lz l ma mb">....</span></pre><p id="97cf" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">..在控制器中，类似于:</p><pre class="lp lq lr ls fq lt lo lu lv aw lw dt"><span id="dda0" class="lx jd hu lo b fv ly lz l ma mb">if NewRegistrationService.new({user: resource, organization: @org}).organization_create<br/>  **success logic**<br/>else<br/>  ** redirect_to last_path, notice: 'Error saving record'<br/>end</span></pre><p id="8124" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated">不管您的服务对象结构如何，简单地将您的业务逻辑从您的控制器中提取出来并放入服务对象中，将有助于保持您的控制器“精简”并且您的应用程序代码易于理解。</p><p id="211d" class="pw-post-body-paragraph ka kb hu kc b kd kz kf kg kh la kj kk kl lb kn ko kp lc kr ks kt ld kv kw kx hn dt translated"><a class="ae ky" href="https://hackernoon.com/going-further-with-service-objects-in-ruby-on-rails-b8aac13a7271" rel="noopener ugc nofollow" target="_blank">注意:在这篇文章之后，我将发布这个服务的重构版本</a></p><div class="lp lq lr ls fq ab cb"><figure class="mf iv mg mh mi mj mk paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mf iv mg mh mi mj mk paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mf iv mg mh mi mj mk paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="ml mm mn"><p id="f922" class="ka kb mo kc b kd kz kf kg kh la kj kk mp lb kn ko mq lc kr ks mr ld kv kw kx hn dt translated"><a class="ae ky" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ky" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ky" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ky" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ka kb mo kc b kd kz kf kg kh la kj kk mp lb kn ko mq lc kr ks mr ld kv kw kx hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ky" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ky" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lp lq lr ls fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ms"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>