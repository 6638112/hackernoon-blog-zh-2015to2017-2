<html>
<head>
<title>Do not ignore .dockerignore</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不要忽视。dockerignore</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/do-not-ignore-dockerignore-47f5fb67b448?source=collection_archive---------7-----------------------#2016-12-08">https://medium.com/hackernoon/do-not-ignore-dockerignore-47f5fb67b448?source=collection_archive---------7-----------------------#2016-12-08</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><blockquote class="ir is it"><p id="183d" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><strong class="ix hv"> <em class="hu">提示:</em> </strong> <em class="hu">考虑为您正在构建的每个</em><a class="ae jx" href="https://hackernoon.com/tagged/docker" rel="noopener ugc nofollow" target="_blank"><em class="hu">Docker</em></a><em class="hu">映像定义并使用</em> <code class="eh jt ju jv jw b"><em class="hu">.dockerignore</em></code> <em class="hu">文件。它可以帮助您减少Docker图像大小，加速</em> <code class="eh jt ju jv jw b"><em class="hu">docker build</em></code> <em class="hu">和避免意外的秘密曝光。</em></p></blockquote><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="fe ff jy"><img src="../Images/bb91910acb7dba50b1fe6780c19481bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bmTwDuuLAXoiRoz3RGZZhw.jpeg"/></div></div></figure><h2 id="5e96" class="kk kl hu bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">Docker构建上下文</h2><p id="c89d" class="pw-post-body-paragraph iu iv hu ix b iy li ja jb jc lj je jf kv lk ji jj kz ll jm jn ld lm jq jr js hn dt translated"><code class="eh jt ju jv jw b">docker build</code>命令用于构建一个新的Docker映像。有一个参数可以传递给<code class="eh jt ju jv jw b">build</code>命令<strong class="ix hv">构建上下文</strong>。</p><p id="0579" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated"><em class="iw">那么，什么是Docker </em> <strong class="ix hv"> <em class="iw">构建上下文</em> </strong> <em class="iw">？</em></p><p id="abaf" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated">首先，请记住，Docker是一个客户端-服务器应用程序，它由Docker客户端和Docker服务器(也称为<em class="iw">守护进程</em>)组成。Docker客户端命令行工具与Docker服务器对话，并要求它做事情。其中之一就是<strong class="ix hv">构建</strong>:构建一个新的Docker形象。Docker服务器可以运行在与客户端、远程机器或虚拟机相同的机器上，也可以是本地的、远程的或者甚至运行在一些云IaaS上。</p><p id="6024" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated">为什么这很重要，Docker  <strong class="ix hv"> <em class="iw">如何构建上下文</em> </strong> <em class="iw">与这个事实相关？</em></p><p id="496a" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated">为了创建一个新的Docker镜像，Docker服务器需要一个访问文件，你要从这个文件中创建Docker镜像。因此，您需要以某种方式将这些文件发送到Docker服务器。这些文件是Docker <strong class="ix hv">构建上下文</strong>。Docker客户端将所有<strong class="ix hv">构建上下文</strong>文件打包到<code class="eh jt ju jv jw b">tar</code>档案中，并将该档案上传到Docker服务器。默认情况下，客户端将获取当前工作目录中的所有文件(和文件夹)，并将它们用作<strong class="ix hv">构建上下文</strong>。它还可以接受已经创建的<code class="eh jt ju jv jw b">tar</code>档案或<code class="eh jt ju jv jw b">git</code>存储库。在使用<code class="eh jt ju jv jw b">git</code>存储库的情况下，客户端将把它与子模块克隆到一个临时文件夹中，并从其中创建一个<strong class="ix hv">构建上下文</strong>档案。</p><h1 id="f688" class="ln kl hu bd km lo lp lq kq lr ls lt ku lu lv lw ky lx ly lz lc ma mb mc lg md dt translated">对Docker构建的影响</h1><p id="e6cb" class="pw-post-body-paragraph iu iv hu ix b iy li ja jb jc lj je jf kv lk ji jj kz ll jm jn ld lm jq jr js hn dt translated">您看到的运行<code class="eh jt ju jv jw b">docker build</code>命令的第一个输出行是:</p><pre class="jz ka kb kc fq me jw mf mg aw mh dt"><span id="51da" class="kk kl hu jw b fv mi mj l mk ml">Sending build context to Docker daemon 45.3 MB Step 1: FROM ...</span></pre><p id="8d98" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated">这应该能把事情说清楚。实际上，<strong class="ix hv">每次</strong>您运行<code class="eh jt ju jv jw b">docker build</code>命令时，Docker客户端都会创建一个新的<strong class="ix hv">构建上下文</strong>档案，并将其发送到Docker服务器。因此，您总是要支付这笔“税”:创建归档所需的时间、存储和网络流量以及延迟时间。</p><blockquote class="ir is it"><p id="86fc" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><strong class="ix hv"> <em class="hu">提示:</em></strong><em class="hu"/><strong class="ix hv"><em class="hu">经验法则</em> </strong> <em class="hu">不会将文件添加到</em> <strong class="ix hv"> <em class="hu">构建上下文</em> </strong> <em class="hu">中，如果您的Docker映像中不需要它们的话。</em></p></blockquote><h1 id="bc28" class="ln kl hu bd km lo lp lq kq lr ls lt ku lu lv lw ky lx ly lz lc ma mb mc lg md dt translated">的。dockerignore文件</h1><p id="b1bb" class="pw-post-body-paragraph iu iv hu ix b iy li ja jb jc lj je jf kv lk ji jj kz ll jm jn ld lm jq jr js hn dt translated"><code class="eh jt ju jv jw b">.dockerignore</code>文件是一个工具，它可以帮助你定义你真正需要的Docker <strong class="ix hv">构建上下文</strong>。使用这个文件，您可以为文件和文件夹指定<strong class="ix hv">忽略规则</strong>和这些规则的<strong class="ix hv">例外</strong>，这些文件和文件夹不会包含在<strong class="ix hv">构建上下文</strong>中，因此不会打包到档案中并上传到Docker服务器。</p><h1 id="03e3" class="ln kl hu bd km lo lp lq kq lr ls lt ku lu lv lw ky lx ly lz lc ma mb mc lg md dt translated">你为什么要在乎？</h1><p id="a253" class="pw-post-body-paragraph iu iv hu ix b iy li ja jb jc lj je jf kv lk ji jj kz ll jm jn ld lm jq jr js hn dt translated">的确，你为什么要在乎呢？今天的电脑速度很快，网络也相当快(希望如此)，存储也很便宜。所以，这个“税”可能没那么大吧？我会试着说服你，你应该在乎。</p><h2 id="ea67" class="kk kl hu bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">原因#1: Docker图像尺寸</h2><p id="569e" class="pw-post-body-paragraph iu iv hu ix b iy li ja jb jc lj je jf kv lk ji jj kz ll jm jn ld lm jq jr js hn dt translated">最近，<a class="ae jx" href="https://hackernoon.com/tagged/software-development" rel="noopener ugc nofollow" target="_blank">软件开发的世界</a>正在向<em class="iw">连续交付</em>、<em class="iw">弹性基础设施</em>和<em class="iw">微服务架构</em>转移。</p><p id="ed05" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated">这有什么关系？</p><p id="3e66" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated">您的系统由多个组件(或<em class="iw">微服务</em>)组成，每个组件都运行在Linux容器中。可能有数十或数百个服务，甚至更多的服务实例。这些服务实例可以彼此独立地构建和部署，这可以针对<strong class="ix hv">每一次代码提交</strong>来完成。不仅如此，<em class="iw">弹性基础设施</em>意味着可以在系统中添加或删除新的计算节点，并且其微服务可以在节点之间移动，以支持规模或可用性要求。这意味着，您的Docker图像将被频繁地构建和传输。</p><p id="104b" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated">当您实践连续交付和微服务架构时，映像大小和映像构建时间<strong class="ix hv">确实很重要</strong>。</p><h2 id="45c5" class="kk kl hu bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">原因2:意外的机密泄露</h2><p id="60a7" class="pw-post-body-paragraph iu iv hu ix b iy li ja jb jc lj je jf kv lk ji jj kz ll jm jn ld lm jq jr js hn dt translated">不控制您的<strong class="ix hv">构建上下文</strong>，也会导致您的代码、提交历史和秘密(密钥和凭证)的意外暴露。</p><p id="f7c9" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated">如果您使用<code class="eh jt ju jv jw b">ADD .</code>或<code class="eh jt ju jv jw b">COPY .</code>命令将文件复制到您的Docker映像中，您可能会无意中将您的源文件、整个<code class="eh jt ju jv jw b">git</code>历史(一个<code class="eh jt ju jv jw b">.git</code>文件夹)、秘密文件(如<code class="eh jt ju jv jw b">.aws</code>、<code class="eh jt ju jv jw b">.env</code>、私钥)、缓存和其他文件不仅包括到Docker <strong class="ix hv">构建上下文</strong>中，还包括到最终的Docker映像中。</p><p id="7c56" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated">DockerHub上目前有多个Docker图片，这些图片公开了应用程序源代码、密码、密钥和凭证(例如<a class="ae jx" href="http://thehackernews.com/2016/07/vine-source-code.html" rel="noopener ugc nofollow" target="_blank"> Twitter Vine </a>)。</p><h2 id="5495" class="kk kl hu bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh dt translated">原因Docker构建——缓存失效</h2><p id="0e09" class="pw-post-body-paragraph iu iv hu ix b iy li ja jb jc lj je jf kv lk ji jj kz ll jm jn ld lm jq jr js hn dt translated">一种常见的模式是使用如下指令将应用程序的整个代码库注入到映像中:</p><pre class="jz ka kb kc fq me jw mf mg aw mh dt"><span id="081d" class="kk kl hu jw b fv mi mj l mk ml">COPY . /usr/src/app</span></pre><p id="d323" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated">在本例中，我们将整个<strong class="ix hv"/><strong class="ix hv">构建上下文</strong>复制到图像中。理解这一点也很重要，每个Dockerfile命令都会生成一个新层。因此，如果在整个构建上下文中任何包含的文件发生变化，这种变化将使<code class="eh jt ju jv jw b">COPY . /opt/myapp</code>层的构建缓存无效，并且在下一个构建中将生成一个新的图像层。</p><p id="ab16" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated">如果您的工作目录包含频繁更新的文件(日志、测试结果、git历史、临时缓存文件等等)，您将为每次<code class="eh jt ju jv jw b">docker build</code>运行重新生成该层。</p><h1 id="e5b7" class="ln kl hu bd km lo lp lq kq lr ls lt ku lu lv lw ky lx ly lz lc ma mb mc lg md dt translated"><code class="eh jt ju jv jw b">.dockerignore</code>语法</h1><p id="6781" class="pw-post-body-paragraph iu iv hu ix b iy li ja jb jc lj je jf kv lk ji jj kz ll jm jn ld lm jq jr js hn dt translated"><code class="eh jt ju jv jw b">.dockerignore</code>文件类似于<code class="eh jt ju jv jw b">gitignore</code>文件，由<code class="eh jt ju jv jw b">git</code>工具使用。与<code class="eh jt ju jv jw b">.gitignore</code>文件类似，它允许您指定Docker客户端在生成<strong class="ix hv">构建上下文</strong>时应该忽略的文件和文件夹的模式。虽然用于描述<strong class="ix hv">忽略模式</strong>的<code class="eh jt ju jv jw b">.dockerignore</code>文件语法与<code class="eh jt ju jv jw b">.gitignore</code>相似，但并不相同。</p><p id="5056" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated"><code class="eh jt ju jv jw b">.dockerignore</code>模式匹配语法基于Go <code class="eh jt ju jv jw b">filepath.Match()</code>函数，包括一些附加功能。</p><p id="d850" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated">下面是<code class="eh jt ju jv jw b">.dockerignore</code>的完整语法:</p><pre class="jz ka kb kc fq me jw mf mg aw mh dt"><span id="8f0f" class="kk kl hu jw b fv mi mj l mk ml">pattern: { term } term: '*' matches any sequence of non-Separator characters '?' matches any single non-Separator character '[' [ '^' ] { character-range } ']' character class (must be non-empty) c matches character c (c != '*', '?', '\\', '[') '\\' c matches character c character-range: c matches character c (c != '\\', '-', ']') '\\' c matches character c lo '-' hi matches character c for lo &lt;= c &lt;= hi additions: '**' matches any number of directories (including zero) '!' lines starting with ! (exclamation mark) can be used to make exceptions to exclusions '#' lines starting with this character are ignored: use it for comments</span></pre><p id="efa2" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated"><strong class="ix hv">注意:</strong>使用<code class="eh jt ju jv jw b">!</code>字符相当棘手。它与带有<code class="eh jt ju jv jw b">!</code>字符的行之前和之后的模式的组合可用于创建更高级的规则。</p><h1 id="ab9d" class="ln kl hu bd km lo lp lq kq lr ls lt ku lu lv lw ky lx ly lz lc ma mb mc lg md dt translated">例子</h1><pre class="jz ka kb kc fq me jw mf mg aw mh dt"><span id="e722" class="kk kl hu jw b fv mi mj l mk ml"># ignore .git and .cache folders .git .cache</span><span id="eb3c" class="kk kl hu jw b fv mm mj l mk ml"># ignore all *.class files in all folders, including build root **/*.class</span><span id="2b2b" class="kk kl hu jw b fv mm mj l mk ml"># ignore all markdown files (md) beside all README*.md other than README-secret.md *.md !README*.md README-secret.md</span></pre><h1 id="3b3a" class="ln kl hu bd km lo lp lq kq lr ls lt ku lu lv lw ky lx ly lz lc ma mb mc lg md dt translated">然后</h1><p id="9c69" class="pw-post-body-paragraph iu iv hu ix b iy li ja jb jc lj je jf kv lk ji jj kz ll jm jn ld lm jq jr js hn dt translated">希望这篇文章对你有用。我期待您的评论和任何问题。</p></div><div class="ab cl mn mo hc mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="hn ho hp hq hr"><p id="3850" class="pw-post-body-paragraph iu iv hu ix b iy iz ja jb jc jd je jf kv jh ji jj kz jl jm jn ld jp jq jr js hn dt translated"><em class="iw">原载于</em> <a class="ae jx" href="https://codefresh.io/blog/not-ignore-dockerignore/" rel="noopener ugc nofollow" target="_blank"> <em class="iw"> Codefresh.io博客</em> </a></p><div class="jz ka kb kc fq ab cb"><figure class="mu kd mv mw mx my mz paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mu kd mv mw mx my mz paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mu kd mv mw mx my mz paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="ir is it"><p id="f922" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated"><a class="ae jx" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jx" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jx" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jx" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="iu iv iw ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jx" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jx" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jz ka kb kc fq kd fe ff paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="fe ff na"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="jz ka kb kc fq kd"><div class="bz el l di"><div class="nb nc l"/></div></figure></div></div>    
</body>
</html>