<html>
<head>
<title>EmailPresenter.swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">EmailPresenter.swift</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/ios-email-picker-99045d940a3d?source=collection_archive---------10-----------------------#2017-03-27">https://medium.com/hackernoon/ios-email-picker-99045d940a3d?source=collection_archive---------10-----------------------#2017-03-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="bcbd" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">指向您已安装的电子邮件客户端的深层链接</h2></div><p id="d1d5" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们需要在应用程序的多个地方向用户显示帮助选项列表。蒙佐和<a class="ae kf" href="https://hackernoon.com/tagged/slack" rel="noopener ugc nofollow" target="_blank">斯莱克</a>在过去已经很好地处理了这个问题，他们制作了一份已安装电子邮件客户端的行动表。</p><p id="7f57" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在这里，我们将创建一个类似的行动表，它将显示用户安装在手机上的电子邮件客户端，并让他们能够从我们的应用程序打开它们。</p><p id="99d8" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">为此，我们需要做一些事情，我将一步一步地向您介绍我所采取的步骤。</p><p id="56b4" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在这里找到代码<a class="ae kf" href="https://github.com/harryblam/EmailActionSheetPresenter" rel="noopener ugc nofollow" target="_blank">和一个简单的示例项目。</a></p><h1 id="c7e4" class="kg kh hu bd ki kj kk kl km kn ko kp kq ja kr jb ks jd kt je ku jg kv jh kw kx dt translated">创建UI组件</h1><p id="2ab1" class="pw-post-body-paragraph jj jk hu jl b jm ky iv jo jp kz iy jr js la ju jv jw lb jy jz ka lc kc kd ke hn dt translated">在WeVat，我们试图通过使用协议将应用程序“组件化”。感谢Matthijs holle mans<strong class="jl hv"/>和<a class="ae kf" href="https://www.natashatherobot.com/updated-protocol-oriented-mvvm-in-swift-2-0/" rel="noopener ugc nofollow" target="_blank"> <strong class="jl hv">机器人娜塔莎</strong> </a> <strong class="jl hv"> </strong>就这个主题发表的见解深刻的文章。</p><p id="10dc" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这部分功能非常适合“演示者”类型的组件。我将向您展示我们是如何实现这一目标的:</p><h2 id="269d" class="ld kh hu bd ki le lf lg km lh li lj kq js lk ll ks jw lm ln ku ka lo lp kw lq dt translated">创建演示者协议:</h2><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div></figure><p id="4e04" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在这里我们:</p><p id="eb93" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jl hv"> 1)定义我们将用于行动表</strong>的UIAlertController</p><p id="90cb" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">2)定义设置功能，该功能将配置动作表。这将在稍后从viewDidLoad 调用</p><h2 id="69ab" class="ld kh hu bd ki le lf lg km lh li lj kq js lk ll ks jw lm ln ku ka lo lp kw lq dt translated">设置行动表</h2><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div></figure><p id="e017" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在我们协议的扩展中，我们定义了动作表所需的设置。目前，我们将只设置静态元素，即标题和取消按钮。</p><h2 id="6aeb" class="ld kh hu bd ki le lf lg km lh li lj kq js lk ll ks jw lm ln ku ka lo lp kw lq dt translated">符合我们的视图控制器中的协议</h2><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div></figure><p id="8952" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">所以现在我们已经成功地在一个presenter类中设置了动作表，准备从任何一个视图控制器中显示出来！</p><p id="6215" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">运行该应用程序，您应该会看到如下所示的操作表</p><figure class="lr ls lt lu fq lv fe ff paragraph-image"><div class="fe ff ly"><img src="../Images/7d91f3be315a199ebc9e754ac5921a48.png" data-original-src="https://miro.medium.com/v2/resize:fit:746/format:webp/1*30p69ajfxejdFkABi_LaHw.png"/></div><figcaption class="mb mc fg fe ff md me bd b be z ek">Empty Action Sheet</figcaption></figure><h1 id="c64b" class="kg kh hu bd ki kj kk kl km kn ko kp kq ja kr jb ks jd kt je ku jg kv jh kw kx dt translated">获取已安装的电子邮件客户端列表</h1><p id="7774" class="pw-post-body-paragraph jj jk hu jl b jm ky iv jo jp kz iy jr js la ju jv jw lb jy jz ka lc kc kd ke hn dt translated">要在iOS中打开设备上的另一个应用程序，您需要使用<a class="ae kf" href="https://developer.apple.com/library/content/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/Inter-AppCommunication/Inter-AppCommunication.html#//apple_ref/doc/uid/TP40007072-CH6-SW1" rel="noopener ugc nofollow" target="_blank"> iOS URL schemes </a>。为清晰起见，我将再次将其分解为以下步骤:</p><h2 id="8257" class="ld kh hu bd ki le lf lg km lh li lj kq js lk ll ks jw lm ln ku ka lo lp kw lq dt translated"><em class="mf">定位所需应用程序的URL方案</em></h2><p id="9561" class="pw-post-body-paragraph jj jk hu jl b jm ky iv jo jp kz iy jr js la ju jv jw lb jy jz ka lc kc kd ke hn dt translated">也许我的谷歌搜索技术没有达到标准，但这是这个过程中最耗时的部分。在搜索了互联网的深处之后，我偶然发现了这篇<a class="ae kf" href="https://www.reddit.com/r/workflow/comments/3mux7h/ios_url_schemes/" rel="noopener ugc nofollow" target="_blank"> reddit帖子</a>，它列出了iOS应用程序的URL方案列表(谢谢<a class="ae kf" href="https://www.reddit.com/r/workflow/comments/3mux7h/ios_url_schemes/cwdg8nl/" rel="noopener ugc nofollow" target="_blank">/用户/meefmaster </a>！).</p><p id="68d9" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">到目前为止，我们已经决定包括以下电子邮件客户端:邮件、调度、Outlook、Gmail和收件箱。</p><h2 id="7539" class="ld kh hu bd ki le lf lg km lh li lj kq js lk ll ks jw lm ln ku ka lo lp kw lq dt translated">识别用户安装了哪些应用程序</h2><p id="6aac" class="pw-post-body-paragraph jj jk hu jl b jm ky iv jo jp kz iy jr js la ju jv jw lb jy jz ka lc kc kd ke hn dt translated">UIApplication上有一个实例方法，它将测试安装的应用程序是否可以打开URL。这非常符合我们的需求，所以我们可以用下面的代码来实现:</p><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div></figure><h1 id="8b5f" class="kg kh hu bd ki kj kk kl km kn ko kp kq ja kr jb ks jd kt je ku jg kv jh kw kx dt translated">创建打开这些应用的操作</h1><p id="7b54" class="pw-post-body-paragraph jj jk hu jl b jm ky iv jo jp kz iy jr js la ju jv jw lb jy jz ka lc kc kd ke hn dt translated">现在，我们可以知道用户在他们的设备上安装了哪些电子邮件客户端，我们可以继续将它们连接到行动表行动中！</p><p id="5160" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jl hv"> 1)创建UIAlertAction </strong></p><p id="e0d6" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们现在可以创建一个安全的方法来创建UIAlertActions来打开用户已经安装的电子邮件应用程序</p><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div></figure><p id="22e3" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">请注意只针对iOS 10及以上版本用户的警告:<a class="ae kf" href="https://useyourloaf.com/blog/openurl-deprecated-in-ios10/" rel="noopener ugc nofollow" target="_blank">https://useyourloaf.com/blog/openurl-deprecated-in-ios10/</a></p><p id="45fd" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">将我们的行动添加到我们的行动表中(如果存在)</p><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div></figure><p id="2a3f" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在尝试在你的设备上运行这个应用程序(iOS模拟器不支持openURL方案)。嘣！它不起作用。我们需要先确定一件事。您可能会在控制台中看到以下消息:</p><p id="9edf" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jl hv">-canOpenURL:URL失败:“Google Gmail:///”——错误:“本app不允许查询方案Google Gmail:///”</strong></p><p id="e512" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这是因为我们需要明确地告诉我们的应用程序，我们打算访问哪些其他应用程序。</p><p id="e823" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jl hv"> 2)将该方案添加到您的信息列表中</strong></p><p id="f083" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们可以通过Info.plist文件来做到这一点。添加一个名为LSApplicationQueriesSchemes的新键作为数组。然后，您可以在阵列中输入您的应用程序。邮件应用不需要放在这里，大概是因为它是一个苹果应用。您的条目应该如下所示。</p><figure class="lr ls lt lu fq lv fe ff paragraph-image"><div class="fe ff mg"><img src="../Images/f2f360b27dfca769045fa1f413c2442f.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/1*D1EPL7rH4G9eJZcSnRVwGQ.png"/></div><figcaption class="mb mc fg fe ff md me bd b be z ek">Info.plist</figcaption></figure><p id="806b" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果您仍然看到该消息，请确保您的设备上确实安装了该应用程序😉</p><p id="309e" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">快跑，瞧！您应该会看到动作表如下所示:</p><figure class="lr ls lt lu fq lv fe ff paragraph-image"><div class="fe ff mh"><img src="../Images/8b216c7004b425961d31e1519bea5c8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*IUX1RIGgugCsUJkVWyJ-2A.png"/></div></figure><p id="039d" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">点击一个动作，它会打开相应的电子邮件应用程序。</p><h1 id="d611" class="kg kh hu bd ki kj kk kl km kn ko kp kq ja kr jb ks jd kt je ku jg kv jh kw kx dt translated">给它一些背景！</h1><p id="5c4f" class="pw-post-body-paragraph jj jk hu jl b jm ky iv jo jp kz iy jr js la ju jv jw lb jy jz ka lc kc kd ke hn dt translated">点击邮件选项，你会发现它会打开电子邮件客户端。在我们的用例中，这是在用户想要通过电子邮件发送我们的帮助地址时点击的，因此主题和收件人将总是相同的。如果你看过一些iOS URL方案，你可能已经注意到了，你可以通过链接在应用中传递查询参数。</p><p id="fd29" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们希望在构建警报动作时传递这些信息，因此我对此进行了重构，每个电子邮件都有自己的功能。</p><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div></figure><p id="da24" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们需要做的最后一件事是在将主题行传递到URL之前对其进行URL编码。我们可以通过调用字符串上的<code class="eh mi mj mk ml b">subjectString?.addingPercentEncoding(withAllowedCharacters:NSCharacterSet.urlQueryAllowed)</code>来实现这一点。</p><h1 id="d5d8" class="kg kh hu bd ki kj kk kl km kn ko kp kq ja kr jb ks jd kt je ku jg kv jh kw kx dt translated">最后最后一件事…</h1><p id="05f1" class="pw-post-body-paragraph jj jk hu jl b jm ky iv jo jp kz iy jr js la ju jv jw lb jy jz ka lc kc kd ke hn dt translated">总有可能我们的某个用户没有安装上面列出的应用程序，或者只是通过网络浏览器访问他们的电子邮件。在这种情况下，我们可以简单地让他们选择在Safari中打开。</p><p id="efd4" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们可以稍微重构我们的代码，通过将我们的警告动作填充到一个临时数组中，然后仅当该数组为空时才使用Safari填充我们的ActionSheet。</p><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div></figure><p id="d036" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">重构我们的设置函数，如下所示:</p><figure class="lr ls lt lu fq lv"><div class="bz el l di"><div class="lw lx l"/></div></figure><h1 id="a1aa" class="kg kh hu bd ki kj kk kl km kn ko kp kq ja kr jb ks jd kt je ku jg kv jh kw kx dt translated">包裹</h1><p id="0fc3" class="pw-post-body-paragraph jj jk hu jl b jm ky iv jo jp kz iy jr js la ju jv jw lb jy jz ka lc kc kd ke hn dt translated">所以我们差不多完成了。现在，只要您想向用户添加电子邮件选项，就可以重用这个逻辑。只要符合你的新演示者协议！</p><p id="0fa9" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果你想在除了电子邮件之外的不同类型的应用中重用这种呈现逻辑，那么你只需要找到你需要的URL方案，然后重复这个过程。简单！</p><p id="a1db" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">谢谢你读到这里。如果您对这方面有任何想法，或者认为可以改进，请发表评论！</p></div></div>    
</body>
</html>