<html>
<head>
<title>How To Build A Multiplayer Browser Game (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何构建一个多人浏览器游戏(第二部分)</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-build-a-multiplayer-browser-game-part-2-2edd112aabdf?source=collection_archive---------2-----------------------#2017-02-22">https://medium.com/hackernoon/how-to-build-a-multiplayer-browser-game-part-2-2edd112aabdf?source=collection_archive---------2-----------------------#2017-02-22</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/f978c81ab0c46a5231be38b427291d12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FgIuD-s-EC2SrqKUykQNzg.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae jg" href="http://explosivefirerrhea.com" rel="noopener ugc nofollow" target="_blank">Explosive Fire-rrhea</a>, <a class="ae jg" href="http://github.com/karlcoehlo/brickhack3" rel="noopener ugc nofollow" target="_blank">submission</a> for <a class="ae jg" href="http://brickhack.io" rel="noopener ugc nofollow" target="_blank">BrickHack3</a></figcaption></figure><p id="f4ee" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这篇文章是我不久前写的一篇关于构建多人浏览器游戏的文章的后续。在这次技术演讲中，我将快速回顾延迟如何影响你的游戏，以及如何应对。我将简要讨论几个游戏框架，包括我在<a class="ae jg" href="http://brickhack.io" rel="noopener ugc nofollow" target="_blank"> BrickHack3 </a>建立的一个，以及如何将声音融入你的游戏。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="9d78" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">延迟和laaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</h1><p id="d8b0" class="pw-post-body-paragraph jh ji hu jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">首先，什么是延迟？嗯，如果你以前玩过任何在线游戏，你可能经历过这样的现象，当你点击或试图执行一个动作时，游戏中什么也没有发生，直到稍后。通常被称为“滞后”，对于像多人射击游戏这样的实时游戏来说，这是非常令人沮丧的。</p><p id="3e1c" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">延迟的产生仅仅是因为您的计算机和您所连接的服务器之间的物理距离。还记得在<a class="ae jg" rel="noopener" href="/@omgimanerd/how-to-build-a-multiplayer-browser-game-4a793818c29b#.ze2sd72nq">第一部分</a>中我们如何谈论权威服务器确定吗？这就是导致延迟的原因，因为你的输入需要时间发送到服务器，验证，然后再发送回来。</p><p id="b16a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">http://gabrielgambetta.com有很棒的资源和解释，关于为什么会发生这种情况以及如何处理，我会从他的网站上链接很多资源。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div class="fe ff lp"><img src="../Images/14c11a08fe40a4e53db10cc8111556c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/format:webp/1*bO7z2UpcY_g3bREeWA8yGQ.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">A single client-server interaction (image from <a class="ae jg" href="http://www.gabrielgambetta.com/fpm2.html" rel="noopener ugc nofollow" target="_blank">gabrielgambetta.com</a>)</figcaption></figure><p id="cdcf" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">为了对抗滞后，我将引入一个叫做客户预测/外推的想法。这个概念基本上包括在客户端的动作之前播放动画，然后由服务器确认以模拟无缝游戏。客户端基本上是在确认后预测服务器的状态。</p><p id="7d2f" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">特别是对于玩家的移动，如果你有一个确定的世界模型，这就变得很容易实现。如果你的游戏世界是由可预测和计算的物理控制的，那么客户端可以做出有根据的假设，即它的输入是有效的，这样玩家移动动画可以在收到来自服务器的确认之前开始。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div class="fe ff lu"><img src="../Images/0717229a2fb93310635c809901d24f33.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/format:webp/0*8iuR2jlO8bi0Vb9I.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Client prediction (image from <a class="ae jg" href="http://www.gabrielgambetta.com/fpm2.html" rel="noopener ugc nofollow" target="_blank">gabrielgambetta.com</a>)</figcaption></figure><p id="9e61" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">除了这些令人惊叹的图表之外，Gabriel Gambetta的网站上还有很多关于这是如何工作的很酷的可视化图片，以及对其中一些问题的解释。<a class="ae jg" href="http://gabrielgambetta.com/fpm_live.html" rel="noopener ugc nofollow" target="_blank">一定要看看他的现场演示</a>。因为这篇文章主要是抽象地介绍这个想法，所以如果你想在自己的代码中实现它，我强烈建议你也看看他的<a class="ae jg" href="http://www.gabrielgambetta.com/fpm_live.html" rel="noopener ugc nofollow" target="_blank">样本代码</a>。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="267f" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated"><a class="ae jg" href="http://incheon.gg" rel="noopener ugc nofollow" target="_blank">仁川. gg </a></h1><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lv"><img src="../Images/6c668904bd684733f3a0c6c8786b3f2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nYF1smcgTjCqxy3mQbhVhQ.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">The homepage to <a class="ae jg" href="http://incheon.gg" rel="noopener ugc nofollow" target="_blank">incheon.gg</a></figcaption></figure><p id="5eab" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在<a class="ae jg" rel="noopener" href="/@omgimanerd/how-to-build-a-multiplayer-browser-game-4a793818c29b#.ze2sd72nq">如何构建多人游戏(第一部分)</a>的评论中，<a class="lw lx gr" href="https://medium.com/u/f4d2676865d6?source=post_page-----2edd112aabdf--------------------------------" rel="noopener" target="_blank">奥菲尔</a>向我推荐了<a class="ae jg" href="http://incheon.gg" rel="noopener ugc nofollow" target="_blank"> incheon.gg </a>框架，以此来抽象出我在本文第一部分中讨论的大部分问题。这个框架非常酷，允许游戏具有离散和连续的物理特性，同时处理大部分客户端-服务器同步逻辑。我一直在检查它，并使用它们的样本代码，如果您不想自己实现网络代码，我强烈建议您使用这个框架作为起点。这是非常好的记录，易于阅读。</p><p id="a5f5" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">诚然，开始有点困难(主要是因为我必须学习ES6风格的课程)，但由于这是一个密集的主题，有很多很好的讨论点，我将很快发表另一篇文章，介绍我如何探索该框架以及我用它做了什么。(但是我要大声喊出来，奥菲弗把我和这件事联系在一起！)</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="26ae" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">在BrickHack3编写自己的游戏框架</h1><p id="63ee" class="pw-post-body-paragraph jh ji hu jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">如果你不太关心网络延迟，并且想尝试定制和编写包括物理、声音和动画在内的所有东西，你也可以查看我使用的游戏代码<a class="ae jg" href="http://github.com/omgimanerd/game-framework" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div class="fe ff ly"><img src="../Images/3a49f64d07f15f8e7deac35483d106dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*g21qXgSLWXEZWRa1l3tlBA.jpeg"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Karl Coehlo (left), me (center), Dan Giaime (right) at <a class="ae jg" href="http://brickhack.io" rel="noopener ugc nofollow" target="_blank">BrickHack3</a></figcaption></figure><p id="96e8" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这个周末我在罗切斯特理工学院参加了<a class="ae jg" href="https://brickhack3.devpost.com/" rel="noopener ugc nofollow" target="_blank">brick hacking 3</a>，由于我的团队提交了一个<a class="ae jg" href="http://explosivefirerrhea.com" rel="noopener ugc nofollow" target="_blank">多人游戏</a> ( <a class="ae jg" href="http://dvp.st/2lUp5Nb" rel="noopener ugc nofollow" target="_blank">我们获得了最佳游戏奖</a>)，我实际上花了一些时间编写了<a class="ae jg" href="https://github.com/omgimanerd/game-framework" rel="noopener ugc nofollow" target="_blank">我自己的框架</a>来构建这个多人游戏。</p><p id="afb0" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我做了很多多人游戏，这些年来我回收了很多代码。这个框架只是我多年来所学的一个顶点。与<a class="ae jg" href="http://incheon.gg" rel="noopener ugc nofollow" target="_blank"> incheon.gg </a>、<a class="ae jg" href="http://github.com/omgimanerd/game-framework" rel="noopener ugc nofollow" target="_blank">不同，我的框架</a>更适合我喜欢构建的开放世界多人游戏类型，并且没有任何前述的内置网络功能。它更适合那些想通过自己编写每个部分的代码来学习游戏架构的人。</p><p id="f55c" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">虽然它仍然是一项正在进行的工作，<a class="ae jg" href="http://github.com/omgimanerd/game-framework" rel="noopener ugc nofollow" target="_blank">我的框架</a>更接近node.js架构，支持它并允许更多的定制。如果你是游戏开发初学者或node.js初学者，并且你刚从第一部分回来，那么我可能会建议你看看这段代码，并对它进行修改，以了解它的作用。</p><p id="88f6" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这里有一个GitHub库的链接。这个库包含了我们在<a class="ae jg" rel="noopener" href="/@omgimanerd/how-to-build-a-multiplayer-browser-game-4a793818c29b#.ze2sd72nq">第一部分</a>中构建的模型的重构、注释和清理版本。在下一节中，我将详细解释这个框架的每个部分。如果你愿意的话，我建议克隆这个库。</p><pre class="lq lr ls lt fq lz ma mb mc aw md dt"><span id="ec3d" class="me kn hu ma b fv mf mg l mh mi">git clone https://github.com/omgimanerd/game-framework</span></pre><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div class="fe ff mj"><img src="../Images/1f8f12dd75ba42c248364deff4a43905.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/format:webp/1*KA4TRINxecSdDchTOi9V3A.png"/></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Files included in the <a class="ae jg" href="https://github.com/omgimanerd/game-framework" rel="noopener ugc nofollow" target="_blank">game framework</a></figcaption></figure><p id="c5f6" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">先说<a class="ae jg" href="https://github.com/omgimanerd/game-framework/blob/master/package.json" rel="noopener ugc nofollow" target="_blank"> package.json </a>，任何node.js项目的面包黄油。我拥有的主要依赖项有<a class="ae jg" href="http://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> express </a>、<a class="ae jg" href="https://www.npmjs.com/package/hashmap" rel="noopener ugc nofollow" target="_blank"> hashmap </a>、<a class="ae jg" href="https://www.npmjs.com/package/morgan" rel="noopener ugc nofollow" target="_blank"> morgan </a>、<a class="ae jg" href="https://pugjs.org/api/getting-started.html" rel="noopener ugc nofollow" target="_blank"> pug </a>和<a class="ae jg" href="https://www.npmjs.com/package/socket.io" rel="noopener ugc nofollow" target="_blank"> socket.io </a>。这个项目唯一绝对需要的是socket.io和hashmap。morgan只是一个有用的日志工具，express是一个广泛使用的中间件框架，而pug是一个模板引擎，但是如果你愿意，你可以很容易地把它们换成你更喜欢的东西。hashmap包用于将每个客户端的socket ID映射到它们的Player实例，当然需要socket.io来支持实时通信。</p><p id="5fe4" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">“lib”文件夹包含处理和存储游戏及其实体状态的服务器端文件。<a class="ae jg" href="https://github.com/omgimanerd/game-framework/blob/master/lib/Entity2D.js" rel="noopener ugc nofollow" target="_blank"> Entity2D.js </a>和<a class="ae jg" href="https://github.com/omgimanerd/game-framework/blob/master/lib/Entity3D.js" rel="noopener ugc nofollow" target="_blank"> Entity3D.js </a>是<a class="ae jg" href="http://eli.thegreenplace.net/2013/10/22/classical-inheritance-in-javascript-es5" rel="noopener ugc nofollow" target="_blank"> ES5样式类</a>，封装了一个具有基本物理和圆形/球形hitbox的实体。如果你想变得更有野心，你可以在这个类中实现更复杂的物理，重力，hitbox网格等等。</p><pre class="lq lr ls lt fq lz ma mb mc aw md dt"><span id="0215" class="me kn hu ma b fv mf mg l mh mi">Entity2D.prototype.update = function(deltaTime) {<br/>  var currentTime = (new Date()).getTime();<br/>  if (deltaTime) {<br/>    this.deltaTime = deltaTime;<br/>  } else if (this.lastUpdateTime === 0) {<br/>    this.deltaTime = 0;<br/>  } else {<br/>    this.deltaTime = (currentTime - this.lastUpdateTime) / 1000;<br/>  }<br/>  for (var i = 0; i &lt; DIMENSIONS; ++i) {<br/>    this.position[i] += this.velocity[i] * this.deltaTime;<br/>    this.velocity[i] += this.acceleration[i] * this.deltaTime;<br/>    this.acceleration[i] = 0;<br/>  }<br/>  this.lastUpdateTime = currentTime;<br/>};</span></pre><p id="a159" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">请注意我们是如何实现在<a class="ae jg" rel="noopener" href="/@omgimanerd/how-to-build-a-multiplayer-browser-game-4a793818c29b#.ze2sd72nq">第一部分</a>中讨论的帧率独立更新的。位置和速度的更新是使用deltaTime完成的，这样我们就可以获得一致的行为。<a class="ae jg" href="https://github.com/omgimanerd/game-framework/blob/master/lib/Player.js" rel="noopener ugc nofollow" target="_blank"> Player.js </a>只是<a class="ae jg" href="https://github.com/omgimanerd/game-framework/blob/master/lib/Entity2D.js" rel="noopener ugc nofollow" target="_blank"> Entity2D.js </a>的一个扩展，只是在基本物理的基础上处理用户输入，以实现模型演示的目的。</p><p id="8049" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><a class="ae jg" href="https://github.com/omgimanerd/game-framework/blob/master/lib/Game.js" rel="noopener ugc nofollow" target="_blank"> Game.js </a>更有趣一点。</p><pre class="lq lr ls lt fq lz ma mb mc aw md dt"><span id="047c" class="me kn hu ma b fv mf mg l mh mi">function Game() {<br/>  this.clients = new HashMap();<br/>  this.players = new HashMap();<br/>}</span></pre><p id="eca0" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在这个基本的构造函数之上，我们有一些方法来方便玩家的连接和断开。本质上，这个类所做的就是处理服务器状态的更新和广播。</p><pre class="lq lr ls lt fq lz ma mb mc aw md dt"><span id="9bf0" class="me kn hu ma b fv mf mg l mh mi">Game.prototype.update = function() {<br/>  var players = this.getPlayers();<br/>  for (var i = 0; i &lt; players.length; ++i) {<br/>    players[i].update();<br/>  }<br/>};</span><span id="3e39" class="me kn hu ma b fv mk mg l mh mi">Game.prototype.sendState = function() {<br/>  var ids = this.clients.keys();<br/>  for (var i = 0; i &lt; ids.length; ++i) {<br/>    this.clients.get(ids[i]).emit('update', {<br/>      self: this.players.get(ids[i]),<br/>      players: this.players.values().filter(<br/>          (player) =&gt; player.id != ids[i])<br/>    });<br/>  }<br/>};</span></pre><p id="86ff" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><code class="eh ml mm mn ma b">Game.prototype.update()</code>简单的更新游戏中的每一个实体，<code class="eh ml mm mn ma b">Game.prototype.sendState()</code>将游戏状态广播给每一个连接到服务器的客户端。需要注意的唯一有趣的事情(这是我的实现特有的)是，我们过滤掉当前连接的播放器，并分别发送它们。这绝不是做事情的唯一方法，我只是发现这是这个演示中最容易使用的方法。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><p id="6c68" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">转到“public”目录，该文件夹包含所有静态提供的客户端JavaScript文件。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div class="fe ff mo"><img src="../Images/46ff888e7118edd7590c7e040073a90c.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/format:webp/1*dgWijRgglIS2OTPsbVnQUQ.png"/></div></figure><p id="e25e" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">还记得我们在<a class="ae jg" rel="noopener" href="/@omgimanerd/how-to-build-a-multiplayer-browser-game-4a793818c29b#.ze2sd72nq">第一部分</a>中提到的重构是个好主意吗？这只是做这件事的一种方式。构建一组模块，每个模块专门处理功能的特定部分，这通常是一个好主意，也是一个好的软件设计。</p><p id="c4eb" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><a class="ae jg" href="https://github.com/omgimanerd/game-framework/blob/master/public/js/game/Drawing.js" rel="noopener ugc nofollow" target="_blank"> Drawing.js </a>，给定一个HTML5 canvas上下文对象，将处理所有游戏精灵在其上的绘制。客户端<a class="ae jg" href="https://github.com/omgimanerd/game-framework/blob/master/public/js/game/Game.js" rel="noopener ugc nofollow" target="_blank"> Game.js </a>使用<code class="eh ml mm mn ma b">window.requestAnimationFrame()</code>在客户端运行游戏循环，将用户输入发送到游戏服务器，并呈现接收到的游戏状态。</p><pre class="lq lr ls lt fq lz ma mb mc aw md dt"><span id="9f3c" class="me kn hu ma b fv mf mg l mh mi">Game.prototype.animate = function() {<br/>  this.animationFrameId = window.requestAnimationFrame(<br/>      Util.bind(this, this.update));<br/>};</span><span id="31e3" class="me kn hu ma b fv mk mg l mh mi">Game.prototype.update = function() {<br/>  if (this.selfPlayer) {<br/>    // Emits an event for the containing the player's input.<br/>    this.socket.emit('player-action', {<br/>      keyboardState: {<br/>        left: Input.LEFT,<br/>        right: Input.RIGHT,<br/>        up: Input.UP,<br/>        down: Input.DOWN<br/>      }<br/>    });<br/>    // Draws the state of the game onto the canvas.<br/>    this.draw();<br/>  }<br/>  this.animate();<br/>};</span></pre><p id="1e76" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这个片段展示了这个功能是如何工作的。如果你不知道requestAnimationFrame文档的作用，这里有一个<a class="ae jg" href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame" rel="noopener ugc nofollow" target="_blank">链接。如果您想知道，<code class="eh ml mm mn ma b">Util.bind()</code>创建了一个函数，将游戏对象的上下文绑定到<code class="eh ml mm mn ma b">update()</code>函数，这样它就可以被<code class="eh ml mm mn ma b">requestAnimationFrame()</code>调用。这是一种深入JavaScript技术细节的攻击，所以我不会真正讨论这个问题，因为你可以很容易地用匿名函数实现同样的事情。</a></p><p id="5609" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><a class="ae jg" href="https://github.com/omgimanerd/game-framework/blob/master/public/js/game/Input.js" rel="noopener ugc nofollow" target="_blank"> Input.js </a>是我在游戏中经常重复使用的文件(有一些变化)。它绑定必要的事件处理程序来跟踪用户键盘/鼠标输入，并存储它们以便于访问。通过将这种功能抽象出来并保存在一个单独的类中，我不必担心从其他地方获取用户输入。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><p id="d550" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">接下来，“共享”目录只包含一个文件，<a class="ae jg" href="https://github.com/omgimanerd/game-framework/blob/master/shared/Util.js" rel="noopener ugc nofollow" target="_blank"> Util.js </a>。</p><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div class="fe ff mp"><img src="../Images/2fd2043696ea5d4fe9256de6de83352c.png" data-original-src="https://miro.medium.com/v2/resize:fit:944/format:webp/1*dTxP8sdqwXRPXwztcOx42w.png"/></div></figure><p id="5b52" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><a class="ae jg" href="https://github.com/omgimanerd/game-framework/blob/master/shared/Util.js" rel="noopener ugc nofollow" target="_blank"> Util.js </a>是我在项目之间经常回收的另一个文件。它包含各种有用的实用函数，可以在客户端和服务器端使用。“共享”文件夹是静态提供的，因此我可以包含HTML文件中的脚本，并在任何需要的地方从服务器端请求它。如今，这可能用像<a class="ae jg" href="https://webpack.js.org/" rel="noopener ugc nofollow" target="_blank"> webpack </a>这样的模块捆绑器做得更好。</p><p id="b7bd" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我使用“共享”文件夹的另一种方式是存储服务器和客户端都需要访问的游戏常量。例如，我将有一个类似这样的类:</p><pre class="lq lr ls lt fq lz ma mb mc aw md dt"><span id="b953" class="me kn hu ma b fv mf mg l mh mi">function Constants() {}</span><span id="df05" class="me kn hu ma b fv mk mg l mh mi">Constants.PLAYER_HITBOX = 10;</span><span id="3770" class="me kn hu ma b fv mk mg l mh mi">Constants.WORLD_SIZE = 2500;</span><span id="cd3f" class="me kn hu ma b fv mk mg l mh mi">if (typeof(module) === 'object') {<br/>  module.exports = Constants;<br/>} else {<br/>  window.Util = Util;<br/>}</span></pre><p id="d658" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这使得该类可以方便地加载到客户端或服务器端。同样，这也是现在更普遍使用的模块加载器，如<a class="ae jg" href="https://webpack.js.org/" rel="noopener ugc nofollow" target="_blank"> webpack </a>。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><p id="b1fb" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">“views”文件夹相对来说没什么意思，它包含了模型演示的模板。</p><pre class="lq lr ls lt fq lz ma mb mc aw md dt"><span id="f875" class="me kn hu ma b fv mf mg l mh mi">doctype html</span><span id="8ac4" class="me kn hu ma b fv mk mg l mh mi">html<br/>  head<br/>    title Game!<br/>  body<br/>    canvas(id='canvas' width='800px' height='600px')<br/>  script(src='/socket.io/socket.io.js')<br/>  script(src='/public/bower/jquery/dist/jquery.min.js')<br/>  script(src='/shared/Util.js')<br/>  script(src='/public/js/game/Drawing.js')<br/>  script(src='/public/js/game/Game.js')<br/>  script(src='/public/js/game/Input.js')<br/>  script(src='/public/js/game/Sound.js')<br/>  script(src='/public/js/client.js')</span></pre><p id="2a0f" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我使用<a class="ae jg" href="https://pugjs.org/api/getting-started.html" rel="noopener ugc nofollow" target="_blank"> pug模板引擎</a>，但是你可以很容易地插入你选择的任何模板。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><p id="0d0e" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">最后，我们在根目录中有<a class="ae jg" href="https://github.com/omgimanerd/game-framework/blob/master/server.js" rel="noopener ugc nofollow" target="_blank"> server.js </a>。这个文件是一个非常标准的node.js服务器，使用了<a class="ae jg" href="http://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> express中间件框架</a>。不过，有两个重要的片段需要注意。</p><pre class="lq lr ls lt fq lz ma mb mc aw md dt"><span id="efb5" class="me kn hu ma b fv mf mg l mh mi">const FPS = 60;</span><span id="9e34" class="me kn hu ma b fv mk mg l mh mi">io.on('connection', (socket) =&gt; {<br/>  socket.on('player-join', () =&gt; {<br/>    game.addNewPlayer(socket);<br/>  });</span><span id="168e" class="me kn hu ma b fv mk mg l mh mi">  socket.on('player-action', (data) =&gt; {<br/>    game.updatePlayerOnInput(socket.id, data);<br/>  });</span><span id="2e78" class="me kn hu ma b fv mk mg l mh mi">  socket.on('disconnect', () =&gt; {<br/>    game.removePlayer(socket.id);<br/>  })<br/>});</span><span id="b73b" class="me kn hu ma b fv mk mg l mh mi">setInterval(() =&gt; {<br/>  game.update();<br/>  game.sendState();<br/>}, 1000 / FPS);</span></pre><p id="005c" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">套接字事件处理程序在<a class="ae jg" rel="noopener" href="/@omgimanerd/how-to-build-a-multiplayer-browser-game-4a793818c29b#.ze2sd72nq">第一部分</a>中介绍过，这是重构和清理过的实现，我们利用了之前在<a class="ae jg" href="https://github.com/omgimanerd/game-framework/blob/master/lib/Game.js" rel="noopener ugc nofollow" target="_blank">游戏类</a>中定义的方法。<code class="eh ml mm mn ma b">setInterval()</code>游戏循环只是以大约60 FPS的速度反复运行游戏更新和状态广播。</p></div><div class="ab cl kf kg hc kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="hn ho hp hq hr"><h1 id="4bc3" class="km kn hu bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj dt translated">后续步骤</h1><p id="8042" class="pw-post-body-paragraph jh ji hu jj b jk lk jm jn jo ll jq jr js lm ju jv jw ln jy jz ka lo kc kd ke hn dt translated">从这里开始，我强烈建议您采用这个框架并对其进行修改。自己做，自己写代码，打印出来烧了，我不管。尝试升级物理或编写自己的动画引擎。我希望你能从无所事事中学到一些东西，我也希望你能做出一些很酷的东西。</p><p id="4734" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果你真的做了很酷的东西，请与我分享！我对你做的任何东西都非常感兴趣。我目前只有这些了。感谢阅读！如果你喜欢这篇文章，请点击下面的❤按钮:)</p><p id="1682" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在推特上关注我:<a class="ae jg" href="https://twitter.com/omgimanerd" rel="noopener ugc nofollow" target="_blank"> @omgimanerd </a></p><div class="lq lr ls lt fq ab cb"><figure class="mq iv mr ms mt mu mv paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mq iv mr ms mt mu mv paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mq iv mr ms mt mu mv paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mw mx my"><p id="f922" class="jh ji mz jj b jk jl jm jn jo jp jq jr na jt ju jv nb jx jy jz nc kb kc kd ke hn dt translated"><a class="ae jg" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jg" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jg" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jg" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jh ji mz jj b jk jl jm jn jo jp jq jr na jt ju jv nb jx jy jz nc kb kc kd ke hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jg" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jg" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lq lr ls lt fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nd"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>