<html>
<head>
<title>Installing git hooks in a dockerized environment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在dockerized环境中安装git挂钩</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/using-git-hooks-in-a-dockerized-environment-55372c40815f?source=collection_archive---------4-----------------------#2017-05-31">https://medium.com/hackernoon/using-git-hooks-in-a-dockerized-environment-55372c40815f?source=collection_archive---------4-----------------------#2017-05-31</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/4a9a7a2d8e53c58424b01adc790fc8d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*Zz9Ne3ZVXwOVtOVwyWvZlA.jpeg"/></div></figure><p id="9e72" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">Git <a class="ae jw" href="https://hackernoon.com/tagged/hooks" rel="noopener ugc nofollow" target="_blank">钩子</a>可以非常方便地保持提交日志的整洁。当你在一个<a class="ae jw" href="https://hackernoon.com/how-we-happily-dockerized-our-development-environment-part-1-2-b05fd6927a53" rel="noopener ugc nofollow" target="_blank">dockered环境</a>中工作时，这里有一个在你的团队中安装和共享git钩子的方法</p><p id="5a9d" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">TL；DR:<a class="ae jw" href="https://github.com/aherve/docker-githook-demo" rel="noopener ugc nofollow" target="_blank">github上有一个演示项目</a></p><h2 id="eb46" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr dt translated">1.简而言之，Git挂钩</h2><p id="a06a" class="pw-post-body-paragraph iy iz hu ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hn dt translated">Git提供了一种在你做某件事之前运行命令的方法。例如，一个常见的用法是在您尝试提交某件事情之前运行您的linters。如果linter检测到任何错误，那么在您真正提交您的工作之前，会要求您修复它。这通常会清除git日志中的提交，比如<a class="ae jw" href="https://github.com/search?utf8=%E2%9C%93&amp;q=merge%3Atrue+fixed+lint&amp;type=" rel="noopener ugc nofollow" target="_blank">“fixed lint”</a>。</p><p id="3300" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">如果你是这个概念的新手，你至少应该知道:</p><ul class=""><li id="42be" class="ky kz hu ja b jb jc jf jg jj la jn lb jr lc jv ld le lf lg dt translated">git挂钩是git自动找到的脚本，如果它在<code class="eh lh li lj lk b">.git/hooks</code>目录下的话</li><li id="ab23" class="ky kz hu ja b jb ll jf lm jj ln jn lo jr lp jv ld le lf lg dt translated">git挂钩是由您的计算机在本地运行的</li><li id="6bb3" class="ky kz hu ja b jb ll jf lm jj ln jn lo jr lp jv ld le lf lg dt translated">当git挂钩失败时，您的git命令不会运行。</li></ul><p id="b382" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">您可能想看看任何git项目中已经存在的git示例:</p><figure class="lr ls lt lu fq iv fe ff paragraph-image"><div class="fe ff lq"><img src="../Images/1303b587c1de23446689aace578420a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:558/format:webp/1*lYD03NJAaMCLg9vm4E-vCQ.png"/></div><figcaption class="lv lw fg fe ff lx ly bd b be z ek">What you get after any `git init`</figcaption></figure><p id="488c" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">只需将<code class="eh lh li lj lk b">pre-commit.sample</code>复制到<code class="eh lh li lj lk b">pre-commit,</code>中，使其可执行，现在你已经安装了第一个工作的git钩子！</p><h2 id="b430" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr dt translated">2.作为一个团队使用githooks</h2><p id="f6a4" class="pw-post-body-paragraph iy iz hu ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hn dt translated">现在你大概知道了，如果你把一些脚本放在你的<code class="eh lh li lj lk b">.git/hooks</code>目录里，那么你的队友就无法利用了。你基本上是唯一一个知道你的脚本的人，你不能保证你的团队的任何提交通过你刚刚写的githook测试。</p><p id="8388" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">当直接使用npm/yarn时，像<a class="ae jw" href="https://github.com/typicode/husky" rel="noopener ugc nofollow" target="_blank"> husky </a>这样的工具可以帮助您自动安装githooks。但现在是2017年，我们希望与码头工人合作，不是吗？</p><p id="0cba" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">这是我们要做的:</p><ul class=""><li id="d85b" class="ky kz hu ja b jb jc jf jg jj la jn lb jr lc jv ld le lf lg dt translated">在项目的根目录下创建一个<code class="eh lh li lj lk b">hooks</code>目录，放一些脚本在里面，并提交它们。</li><li id="6112" class="ky kz hu ja b jb ll jf lm jj ln jn lo jr lp jv ld le lf lg dt translated">创建一个docker容器，其目的是创建一个官方钩子脚本到你的<em class="kx">本地</em> <code class="eh lh li lj lk b">.git/hooks</code>目录的符号链接</li><li id="7582" class="ky kz hu ja b jb ll jf lm jj ln jn lo jr lp jv ld le lf lg dt translated">在你的主<code class="eh lh li lj lk b">docker-compose.yml.</code>中声明这个容器</li><li id="657f" class="ky kz hu ja b jb ll jf lm jj ln jn lo jr lp jv ld le lf lg dt translated">当任何人运行<code class="eh lh li lj lk b">docker-compose up,</code>时，钩子容器将确保官方钩子正确地安装在你的配置中。</li></ul><p id="1cb9" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">现在我们开始吧。</p><p id="0b59" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">首先，我们创建一个docker容器，由一些<code class="eh lh li lj lk b">Dockerfile.githook:</code>定义</p><figure class="lr ls lt lu fq iv"><div class="bz el l di"><div class="lz ma l"/></div></figure><p id="c300" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">这背后的想法很简单。它基本上创建了一个容器，该容器将:</p><ul class=""><li id="c94c" class="ky kz hu ja b jb jc jf jg jj la jn lb jr lc jv ld le lf lg dt translated"><code class="eh lh li lj lk b">cd /tmp/hooks &amp;&amp; ls | xargs chmod +x</code>:去一些/tmp/hooks(关于这个特定目录的解释会在后面介绍)，找到脚本，并使它们可执行</li><li id="1e36" class="ky kz hu ja b jb ll jf lm jj ln jn lo jr lp jv ld le lf lg dt translated"><code class="eh lh li lj lk b">cd /tmp/.git/hooks &amp;&amp; find ../../hooks -type f -exec ln -sf {} /tmp/.git/hooks/\;</code>现在转到某个<code class="eh lh li lj lk b">/tmp/.git/hooks</code>目录，找到可执行文件，并创建指向该目录的符号链接</li></ul><p id="288b" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">所以这个容器基本上创建了从它自己的<code class="eh lh li lj lk b">/tmp/hooks</code>到它自己的<code class="eh lh li lj lk b">/tmp/.git/hooks.</code>的符号链接。我们需要做的最后一件事就是与容器共享我们自己的<code class="eh lh li lj lk b">.git/hooks</code>和<code class="eh lh li lj lk b">hooks</code>目录。这样，当容器创建它自己的符号链接时，它实际上会在我们的计算机上这样做。这正是我们想要的。</p><p id="f4cc" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">这可以通过使用<code class="eh lh li lj lk b">docker-compose.yml</code>文件中的卷来实现:</p><figure class="lr ls lt lu fq iv"><div class="bz el l di"><div class="lz ma l"/></div></figure><p id="a705" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">这将:</p><ul class=""><li id="b24a" class="ky kz hu ja b jb jc jf jg jj la jn lb jr lc jv ld le lf lg dt translated">在主项目中声明一个<code class="eh lh li lj lk b">githook_installer</code>容器。</li><li id="3648" class="ky kz hu ja b jb ll jf lm jj ln jn lo jr lp jv ld le lf lg dt translated">使用busybox:一个知道基本unix命令微小映像，例如<code class="eh lh li lj lk b">ls, xargs, find, ln...</code></li><li id="4760" class="ky kz hu ja b jb ll jf lm jj ln jn lo jr lp jv ld le lf lg dt translated">将您的本地<code class="eh lh li lj lk b">.git</code>目录挂载到容器的<code class="eh lh li lj lk b">/tmp.git</code>目录中</li><li id="2a77" class="ky kz hu ja b jb ll jf lm jj ln jn lo jr lp jv ld le lf lg dt translated">将您的本地<code class="eh lh li lj lk b">./hooks</code>目录挂载到容器的<code class="eh lh li lj lk b">/tmp/hooks</code>目录中</li><li id="5226" class="ky kz hu ja b jb ll jf lm jj ln jn lo jr lp jv ld le lf lg dt translated">每次运行时引导<code class="eh lh li lj lk b">docker-compose up.</code>注意，这实际上会在每次运行项目时创建符号链接。但是创建一堆已经存在的符号链接绝对不是问题；你甚至不会注意到它。</li></ul><h2 id="1ba7" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jj ki kj kk jn kl km kn jr ko kp kq kr dt translated">3.现在我们来演示一下，好吗？</h2><p id="44b1" class="pw-post-body-paragraph iy iz hu ja b jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr kw jt ju jv hn dt translated">我在github上为那些对结果感兴趣的人制作了一个演示</p><p id="58ad" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">让我们在<code class="eh lh li lj lk b">./hooks</code>目录中创建一个疯狂的预提交脚本:</p><figure class="lr ls lt lu fq iv"><div class="bz el l di"><div class="lz ma l"/></div></figure><p id="ed44" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">现在运行<code class="eh lh li lj lk b">docker-compose up,</code>，就像任何人在使用docker时都会做的那样。</p><p id="779f" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">试着做些什么。您将获得:</p><blockquote class="mb mc md"><p id="3492" class="iy iz kx ja b jb jc jd je jf jg jh ji me jk jl jm mf jo jp jq mg js jt ju jv hn dt translated">预提交钩子开始<br/>好的，我将接受你在分支主机<br/>上的提交<br/>没有什么要提交的，工作目录清空</p></blockquote><p id="378c" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">或者</p><blockquote class="mb mc md"><p id="c991" class="iy iz kx ja b jb jc jd je jf jg jh ji me jk jl jm mf jo jp jq mg js jt ju jv hn dt translated">预提交钩子开始<br/> Meh。也许下次吧</p></blockquote><p id="c0e9" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">并不是说，如果您的提交被拒绝，那么git日志保持不变。</p><p id="b73a" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">也许你现在想写一个更有用的前钩子。如果您在配置中创建了一些<code class="eh lh li lj lk b">linter</code>容器，这肯定是个好主意！</p><div class="lr ls lt lu fq ab cb"><figure class="mh iv mi mj mk ml mm paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mh iv mi mj mk ml mm paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mh iv mi mj mk ml mm paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mb mc md"><p id="f922" class="iy iz kx ja b jb jc jd je jf jg jh ji me jk jl jm mf jo jp jq mg js jt ju jv hn dt translated"><a class="ae jw" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jw" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jw" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jw" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="iy iz kx ja b jb jc jd je jf jg jh ji me jk jl jm mf jo jp jq mg js jt ju jv hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jw" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jw" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lr ls lt lu fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="fe ff mn"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="lr ls lt lu fq iv"><div class="bz el l di"><div class="ms ma l"/></div></figure></div></div>    
</body>
</html>