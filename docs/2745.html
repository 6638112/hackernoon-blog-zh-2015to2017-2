<html>
<head>
<title>How to monitor geth and autorestart it on crashes with monit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何监控geth并在monit崩溃时自动重启它</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-monitor-geth-and-autorestart-it-on-crashes-with-monit-a6668de9b961?source=collection_archive---------4-----------------------#2017-02-16">https://medium.com/hackernoon/how-to-monitor-geth-and-autorestart-it-on-crashes-with-monit-a6668de9b961?source=collection_archive---------4-----------------------#2017-02-16</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/f89f4b9cc4c556ad2d68e48d5fc14425.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CkMx44bqVnqHGtrYHIiKWA.jpeg"/></div></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Monit monitors Geth, autorestarts it on crashes and sends email alerts. Good, good Monit!</figcaption></figure><div class=""/><p id="5024" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">我在一个低成本的数字海洋(DO) Ubuntu droplet上运行geth和<a class="ae ke" href="http://themillionetherhomepage.com/0xF51f08910eC370DB5977Cff3D01dF4DfB06BfBe1" rel="noopener ugc nofollow" target="_blank">TheMillionEtherHomepage.com</a>后端。我使用<strong class="ji ik"> monit </strong>来自动重启geth，并在进程出错时发送电子邮件提醒。</p><p id="2418" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">在这里，我将介绍一个可行的解决方案和一个不可行的漂亮的解决方案(希望有人能最终修复它)。</p><h2 id="1d0f" class="kf kg ij bd kh ki kj kk kl km kn ko kp jr kq kr ks jv kt ku kv jz kw kx ky kz dt translated">安装和设置监视器</h2><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="7916" class="kf kg ij lf b fv lj lk l ll lm">$ sudo apt-get update <br/>$ sudo apt-get install monit</span></pre><p id="dc25" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">备份配置文件，并开始用nano编辑它:</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="1663" class="kf kg ij lf b fv lj lk l ll lm">$ sudo cp /etc/monit/monitrc /etc/monit/monitrc-orig # backup <br/>$ sudo nano /etc/monit/monitrc</span></pre><p id="ba0d" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">允许访问监控状态。取消这些行的注释:</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="9c72" class="kf kg ij lf b fv lj lk l ll lm">set daemon 120 # number of seconds between checkups <br/>set httpd port 2812 and <br/>    use address localhost # only accept connection from localhost<br/>    allow localhost # allow localhost to connect to the server</span></pre><p id="9e03" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">让monit包含*。cfg文件从它的conf.d目录。取消注释(或在最后添加):</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="f08f" class="kf kg ij lf b fv lj lk l ll lm">include /etc/monit/conf.d/*.cfg</span></pre><p id="8db2" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">设置邮件服务器发送提醒。如果您使用的是gmail，请添加以下几行:</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="099a" class="kf kg ij lf b fv lj lk l ll lm"># GMAIL <br/>set mailserver smtp.gmail.com port 587 <br/>    username "username@gmail.com" password "12345678" <br/>    using tlsv1 <br/>    with timeout 30 seconds </span><span id="5188" class="kf kg ij lf b fv ln lk l ll lm">set alert username@gmail.com # monit will send alerts to this address</span></pre><p id="7a75" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">退出nano编辑器:Ctrl+X要保存，键入Y，按enter，当它要求文件名时再次输入(保留相同的文件名)。</p><p id="5227" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">设置权限为monitrc现在有非常敏感的数据。</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="c413" class="kf kg ij lf b fv lj lk l ll lm">$ sudo chmod 600 /etc/monit/monitrc</span></pre><p id="98c4" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">为了更好地理解monit:</p><ul class=""><li id="fa9d" class="lo lp ij ji b jj jk jn jo jr lq jv lr jz ls kd lt lu lv lw dt translated"><a class="ae ke" href="https://www.youtube.com/watch?v=wiRt3mY7Rrw" rel="noopener ugc nofollow" target="_blank">视频—用Monit监控Linux系统和服务</a></li><li id="eaa6" class="lo lp ij ji b jj lx jn ly jr lz jv ma jz mb kd lt lu lv lw dt translated"><a class="ae ke" href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-monit" rel="noopener ugc nofollow" target="_blank">数字海洋:如何安装和配置Monit </a></li></ul><h2 id="e2bd" class="kf kg ij bd kh ki kj kk kl km kn ko kp jr kq kr ks jv kt ku kv jz kw kx ky kz dt translated">设置geth监控—工作解决方案</h2><p id="40c0" class="pw-post-body-paragraph jg jh ij ji b jj mc jl jm jn md jp jq jr me jt ju jv mf jx jy jz mg kb kc kd hn dt translated">使用nano创建并开始编辑geth.cfg文件:</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="281d" class="kf kg ij lf b fv lj lk l ll lm">$ sudo nano /etc/monit/monitrc/geth.cfg</span></pre><p id="0888" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">粘贴此代码:</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="a6b0" class="kf kg ij lf b fv lj lk l ll lm"># GETH <br/>CHECK PROCESS geth MATCHING "[g]eth.*fast" <br/>    start program = "/bin/bash -c 'geth --fast --rpc --rpcport 8545 --rpccorsdomain localhost --cache=16 &gt;/dev/null 2&gt; /home/my-logs-folder/geth.log'" as uid username as gid username <br/>    stop program = "/bin/bash -c 'kill -HUP $(ps aux | grep '[g]eth' | awk '{print $2}')'" as uid username as gid username <br/>    if not exist then alert <br/>    if not exist then restart</span></pre><p id="1160" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">Ctrl+X要保存，请键入Y，按enter键，当它要求输入文件名时，再次按enter键。</p><ul class=""><li id="ae92" class="lo lp ij ji b jj jk jn jo jr lq jv lr jz ls kd lt lu lv lw dt translated">我们在这里使用&gt;/dev/null，因为geth将所有内容输出到stderr(标准错误输出)。我们将所有stderr输出(即所有日志)保存到/home/my-logs-folder/geth.log文件中。</li><li id="2750" class="lo lp ij ji b jj lx jn ly jr lz jv ma jz mb kd lt lu lv lw dt translated">我们使用-HUP信号，因为-SIGINT(通常用Ctrl+C发送)不会到达geth。</li></ul><p id="4c6b" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">重新启动monit:</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="ed6c" class="kf kg ij lf b fv lj lk l ll lm">$ sudo monit reload</span></pre><p id="0f09" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji ik">当geth崩溃时，这个配置将完美地发送一封电子邮件给你，并将完美地自动重启geth </strong></p><p id="9f25" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">酪这里的缺点是它不能通过monit向geth发送“graceful”-SIGINT信号。而不得不改为send -HUP，这想必是不安全的(<a class="ae ke" href="http://ethereum.stackexchange.com/questions/10566/is-it-safe-to-kill-geth-with-sigterm" rel="noopener ugc nofollow" target="_blank">用SIGTERM杀geth安全吗？</a>)。我试了一下，效果不错，但是我更喜欢手动发送-SIGINT:</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="b00b" class="kf kg ij lf b fv lj lk l ll lm">$ sudo monit unmonitor geth # so that monit won't restart geth again <br/>$ PID_OF_GETH=`pidof geth` # get geth's process ID <br/>$ kill -2 $PID_OF_GETH # KILL IT NOW!... but do it gracefully.</span></pre><p id="909f" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这是笨拙的。我试图让它更优雅，但失败了。在stackexchange贴了这个问题— <a class="ae ke" href="http://ethereum.stackexchange.com/questions/11860/how-to-monitor-and-auto-restart-geth-with-monit" rel="noopener ugc nofollow" target="_blank">如何用monit监控并自动重启geth？</a></p><h2 id="965a" class="kf kg ij bd kh ki kj kk kl km kn ko kp jr kq kr ks jv kt ku kv jz kw kx ky kz dt translated">设置监控—正确的方式</h2><p id="0eb5" class="pw-post-body-paragraph jg jh ij ji b jj mc jl jm jn md jp jq jr me jt ju jv mf jx jy jz mg kb kc kd hn dt translated">我知道配置看起来应该与此非常相似。</p><p id="9390" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">geth.cfg</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="aa00" class="kf kg ij lf b fv lj lk l ll lm"># GETH <br/>CHECK PROCESS geth with pidfile "/home/username/monit/geth.pid" <br/>    start program = "/bin/bash -c '/home/username/monit/geth.sh start'" as uid username as gid username <br/>    stop program = "/bin/bash -c '/home/username/monit/geth.sh stop'" as uid username as gid username <br/>    if not exist then alert <br/>    if not exist then restart</span></pre><p id="89bf" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">geth.sh</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="3133" class="kf kg ij lf b fv lj lk l ll lm">#!/bin/bash <br/>PID='/home/username/monit/geth.pid' <br/>LOGS='/home/username/monit/geth.log' <br/>KEYS='\--fast --rpc --rpcport 8545 --rpccorsdomain localhost --ipcpath /home/username/.ethereum/geth.ipc --cache=16' <br/>case $1 in <br/>    start) <br/>        setsid geth "$KEYS" &amp;&gt; "$LOGS" &amp; <br/>        echo $! &gt; "$PID" <br/>    ;; <br/>    stop) <br/>        kill -SIGINT `cat "$PID"` <br/>        rm "$PID" <br/>    ;; <br/>    *) <br/>    echo "usage: geth.sh {start|stop}" <br/>    ;; <br/>esac <br/>exit 0</span></pre><p id="4cdb" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">很漂亮不是吗？如果你知道如何让它工作，请在这里提交你的答案— <a class="ae ke" href="http://ethereum.stackexchange.com/questions/11860/how-to-monitor-and-auto-restart-geth-with-monit" rel="noopener ugc nofollow" target="_blank">如何用monit监控和自动重启geth？</a></p><h2 id="7f72" class="kf kg ij bd kh ki kj kk kl km kn ko kp jr kq kr ks jv kt ku kv jz kw kx ky kz dt translated">获取监控状态</h2><p id="7e9f" class="pw-post-body-paragraph jg jh ij ji b jj mc jl jm jn md jp jq jr me jt ju jv mf jx jy jz mg kb kc kd hn dt translated">重新启动monit后，可以使用以下命令启动geth:</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="fbed" class="kf kg ij lf b fv lj lk l ll lm">$ sudo monit start geth</span></pre><p id="64a7" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">这将运行geth，在崩溃时自动重启它，并在出错时通过电子邮件通知您。</p><p id="0eac" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">您还可以通过以下命令检查monit状态:</p><pre class="la lb lc ld fq le lf lg lh aw li dt"><span id="3215" class="kf kg ij lf b fv lj lk l ll lm">$ sudo monit status</span></pre><p id="33a6" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated">并且有一个这样的屏幕(mlneth这里是我的<a class="ae ke" href="http://themillionetherhomepage.com/0xF51f08910eC370DB5977Cff3D01dF4DfB06BfBe1" rel="noopener ugc nofollow" target="_blank">项目</a>的python后端):</p><figure class="la lb lc ld fq hw fe ff paragraph-image"><div class="fe ff mh"><img src="../Images/bd26a2a6e6dad2add7a92ba5fe8d693a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*z_X5XbI0imrkwy3zAYAwLw.png"/></div><figcaption class="id ie fg fe ff if ig bd b be z ek">Monitoring geth</figcaption></figure><p id="efa7" class="pw-post-body-paragraph jg jh ij ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd hn dt translated"><strong class="ji ik">祝你们监控愉快，没有任何警告！</strong></p><div class="la lb lc ld fq ab cb"><figure class="mi hw mj mk ml mm mn paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mi hw mj mk ml mm mn paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mi hw mj mk ml mm mn paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mo mp mq"><p id="f922" class="jg jh mr ji b jj jk jl jm jn jo jp jq ms js jt ju mt jw jx jy mu ka kb kc kd hn dt translated"><a class="ae ke" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ke" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ke" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ke" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jg jh mr ji b jj jk jl jm jn jo jp jq ms js jt ju mt jw jx jy mu ka kb kc kd hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ke" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ke" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="la lb lc ld fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff mv"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>