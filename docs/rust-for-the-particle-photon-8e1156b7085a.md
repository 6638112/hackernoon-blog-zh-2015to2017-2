# 粒子光子的铁锈

> 原文：<https://medium.com/hackernoon/rust-for-the-particle-photon-8e1156b7085a>

![](img/8ee658e78e393a2d3ee97d5f3565defc.png)

不久前，我还是一名移动开发者。我为 iOS 开发应用程序，不得不经常担心内存消耗、性能，你知道，所有那些让电脑变得很难的无聊事情。

后来我成了一名网页开发人员。我踢我的脚，让虚拟机为我工作。记忆？Psh，多买 ram 小气鬼。[内存](https://hackernoon.com/tagged/memory)泄露？谁会让一个网页打开足够长的时间以至于出现漏洞呢？停止从你的工作笔记本电脑上播放视频，使用 Chromecast，这是一种在家进行的活动，所以没人知道你爱单身汉。

我也有两只狗。他们很棒，但我总觉得他们没有足够酷的东西属于自己。当然，他们有喜欢吃的玩具，但我是一个技术人员，他们是没有技术的狗，这有点尴尬。

所以，很自然地，我开始尝试为勒德分子的绒毛球做一个恶狗项圈。我拿起一些粒子光子(这很棒，强烈推荐)，然后去参加比赛，[用 baby C 和 C++编程](https://hackernoon.com/tagged/programming)，就像大学里的数据结构一样，除了没有宿醉和视频游戏。好吧，还带着宿醉，只是没有电子游戏。好吧，还是玩电子游戏。

用那些旧语言编程并不太糟糕，它们有非常正常的特性，字符串是一种痛苦，但是包含的库在那里提供了一些很好的支持。然后，当我认为一切都很顺利的时候,《天堂单身汉》被关闭了——哦，我的程序也神秘地崩溃了。结果发现这个问题是代码中的内存泄漏，因为，当然，我已经有*年*没有关注手动内存管理了。

我继续努力，试图记住像冠军一样分配和分配，直到我的好朋友威尔建议我试试 Rust。他将其描述为“进行内存管理的正确方法”，现在我可以说我同意了。

这时候我开始尝试移植我的狗项圈代码生锈。

对豪尔赫·阿帕里西奥(Jorge Aparicio)大声喊出来，他在这一切中给了我很大的帮助。这家伙有克里斯·哈里森在玫瑰仪式上的耐心。

我从 Jorge 令人敬畏的 quickstart 自述文件开始，并能够快速启动和运行我的代码。老实说，我对它的简单程度感到惊讶。我还需要使用几个用 C/C++编写的库来实现基本功能。就在那时，我绊了一跤，掉进了兔子洞。

Jorge 给了我一些很好的指导，基本上有几个步骤:

*   获取 C/C++库
*   将`bindgen`和`gcc`板条箱添加到您的项目中。
*   创建一个 build.rs 文件
*   将 build.rs 文件添加到 cargo.toml 文件中的`[package]`下，如下所示:

```
build = "build.rs"
```

*   使用`bindgen`，从您想要导入的库的头文件中生成 rust 绑定。换句话说，向构建文件的 main 函数中添加如下内容:

```
let bindings = bindgen::Builder::default()
  .no_unstable_rust()
  .header("src-cpp/some-library.hpp")
  .generate()
  .expect("Unable to generate bindings");let out_path = PathBuf::from("src");
bindings
  .write_to_file(out_path.join("lib.rs"))
  .expect("Couldn't write bindings!");
```

我的代码恰好位于`src-cpp`。

*   最后，添加将 C/C++代码实际编译成 lib 并将其放入构建目标的步骤:

```
gcc::Config::new()
  .cpp(true) // Switch to C++ library compilation.
  .file("src-cpp/add.cpp")
  .compile("libsome-library.a");
```

如果你幸运的话，就是这样！你包括的库没有任何粒子固件的参考，你一切都很好。你现在可以像一个正常的模块一样使用它，或者需要它作为一个外部机箱，疯狂吧。

如果你没有得到那枚戒指，不要担心，你仍然可以在天堂的单身汉中寻找真爱，只是有点困难，你必须在墨西哥喝得酩酊大醉——我的意思是，加上一堆编译器旗帜。

《光子上的铁锈》很棒，但是，就像《天堂里的单身汉》一样，它缺乏标准(s)…库(明白了。)这很好，直到你意识到几乎所有的事情都依赖于标准库。这意味着在运行编译命令来审计输出的 rust 代码之后，您必须非常小心。

我用 [Adafruit Neopixel 库](https://github.com/adafruit/Adafruit_NeoPixel)尝试了这个过程，这是我的 build.rs 经过一些修补后的样子:

您会注意到这里的一些事情:

1.  有一大堆的旗子。这些都是我添加的标志，这样 gcc 就可以使用正确的库，并基于 Photon 固件构建过程进行编译。我基本上运行了构建过程，并手动复制了 gcc 步骤。
2.  我注释掉了 bindgen 步骤。这是因为我用它们来生成带有基本类型的 rust 绑定(对 rust 来说是新的，这似乎是最安全的事情)，然后我删除了任何引用标准库或看起来无关的东西。例如，产生了许多光子库使用的东西，但没有绑定。

这一切看起来都很好，我相信这是一个很好的开始，但是，唉，就像《单身汉》中的建议一样，我一真正尝试，代码就崩溃了。我仍然不确定是什么问题，也许是 Neopixel 库使用了原始汇编，Rust 不喜欢这样。不管怎样，我最终在 Rus t 中从头开始编写了大部分功能，但也许我在嵌入式 Rust 中找到了新的爱好。我接受这朵玫瑰——我是说铁锈。