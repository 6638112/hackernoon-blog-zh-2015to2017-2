<html>
<head>
<title>Building Blockchain Web API Using Swift and Vapor</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Swift和Vapor构建区块链Web API</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/building-blockchain-web-api-using-swift-and-vapor-2daf599c8449?source=collection_archive---------7-----------------------#2017-12-29">https://medium.com/hackernoon/building-blockchain-web-api-using-swift-and-vapor-2daf599c8449?source=collection_archive---------7-----------------------#2017-12-29</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/cb9a1bc5ed9227c3543bc416d98e71bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jIJXIddMwbPbDU9E01dd4Q.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek"><a class="ae jg" href="http://media2.govtech.com/images/940*464/shutterstock_blockchain.jpg" rel="noopener ugc nofollow" target="_blank">http://media2.govtech.com/images/940*464/shutterstock_blockchain.jpg</a></figcaption></figure><p id="100b" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv">更新</strong>:我很自豪地宣布，我的新课程“<a class="ae jg" href="https://hackernoon.com/tagged/blockchain" rel="noopener ugc nofollow" target="_blank">区块链</a> <a class="ae jg" href="https://hackernoon.com/tagged/programming" rel="noopener ugc nofollow" target="_blank">使用Swift在iOS中编程</a>”现已推出。<a class="ae jg" href="https://www.udemy.com/blockchain-programming-in-ios-using-swift/?couponCode=BLOCKCHAINMEDIUM" rel="noopener ugc nofollow" target="_blank">立即注册</a>，仅需10.99美元。</p><p id="0892" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在我的上一篇<a class="ae jg" href="https://hackernoon.com/blockchain-programming-in-ios-ffaff9b328cc" rel="noopener ugc nofollow" target="_blank">帖子</a>中，我用Swift语言讨论了区块链的基本实现。在这篇文章中，我将使用服务器端Swift框架Vapor将区块链实现到云中。我们将在HTTP协议上构建区块链Web API，使用不同的路径提供必要的功能。这篇文章假设你已经在电脑上安装了<a class="ae jg" href="https://vapor.codes" rel="noopener ugc nofollow" target="_blank"> Vapor </a>框架，并且具备Swift语言的基础知识。</p><h2 id="ee0a" class="kf kg hu bd kh ki kj kk kl km kn ko kp js kq kr ks jw kt ku kv ka kw kx ky kz dt translated">实现模型</h2><p id="6da3" class="pw-post-body-paragraph jh ji hu jj b jk la jm jn jo lb jq jr js lc ju jv jw ld jy jz ka le kc kd ke hn dt translated">第一步是为区块链Web API创建必要的模型。这些模型将包括以下内容。</p><p id="abbe" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv">块</strong>:一个块类代表一个单独的块，它可以包含由事务表示的输入和输出。</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="6025" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">块类的属性解释如下:</p><ul class=""><li id="8009" class="ll lm hu jj b jk jl jo jp js ln jw lo ka lp ke lq lr ls lt dt translated"><strong class="jj hv">索引— </strong>区块在区块链中的位置。索引为0意味着该块是区块链中的第一块。指数为1表示它是区块链中的第二个区块..你的想法是对的！</li><li id="5257" class="ll lm hu jj b jk lu jo lv js lw jw lx ka ly ke lq lr ls lt dt translated"><strong class="jj hv">创建日期</strong> —创建块的日期</li><li id="a10f" class="ll lm hu jj b jk lu jo lv js lw jw lx ka ly ke lq lr ls lt dt translated"><strong class="jj hv"> previousHash </strong> —前一个块的哈希值</li><li id="87a0" class="ll lm hu jj b jk lu jo lv js lw jw lx ka ly ke lq lr ls lt dt translated"><strong class="jj hv">哈希</strong> —块的当前哈希</li><li id="7a30" class="ll lm hu jj b jk lu jo lv js lw jw lx ka ly ke lq lr ls lt dt translated"><strong class="jj hv">消息</strong> —附在每个块上的备忘录。这只是为了我们的目的</li><li id="e756" class="ll lm hu jj b jk lu jo lv js lw jw lx ka ly ke lq lr ls lt dt translated"><strong class="jj hv"> nonce </strong> —自动递增的数字，在挖掘散列时起着重要作用</li><li id="0a13" class="ll lm hu jj b jk lu jo lv js lw jw lx ka ly ke lq lr ls lt dt translated"><strong class="jj hv">事务</strong> —事务的数组。每笔交易都代表一次货物/价值的转移</li><li id="1b29" class="ll lm hu jj b jk lu jo lv js lw jw lx ka ly ke lq lr ls lt dt translated"><strong class="jj hv">关键字</strong> —这是传递给哈希函数的计算属性</li></ul><p id="8a21" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv">交易</strong>:交易由汇款人、收款人和转账金额组成。实现如下所示:</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="d35f" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv">事务</strong>类是不言自明的。它由起始、终止和金额字段组成。为了简单起见，我们将对from和to字段使用虚拟名称，实际上这些字段将由wallet ID组成。</p><p id="42c4" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv">区块链</strong>:区块链是表示区块列表的主类。每个块都指向链中的前一个块。每个块可以包含多个交易，代表贷项或借项。</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="2e51" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">每个模型都遵循可编码协议，这使得它可以很容易地转换成JSON表示的对象。如果您已经阅读了<a class="ae jg" href="https://hackernoon.com/blockchain-programming-in-ios-ffaff9b328cc" rel="noopener ugc nofollow" target="_blank">的上一篇</a>文章，那么上面的实现非常相似。下一步是为我们的Web API配置路由，这是在新的章节中使用Vapor框架实现的。</p><h2 id="daef" class="kf kg hu bd kh ki kj kk kl km kn ko kp js kq kr ks jw kt ku kv ka kw kx ky kz dt translated">使用Vapor实现Web API</h2><p id="7aa2" class="pw-post-body-paragraph jh ji hu jj b jk la jm jn jo lb jq jr js lc ju jv jw ld jy jz ka le kc kd ke hn dt translated">使用Vapor实现Web API有几种不同的方式。我没有在Routes类中添加所有代码，而是添加了一个自定义控制器来处理所有的区块链请求。<strong class="jj hv">区块链控制器</strong>的实现如下所示:</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="2545" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们将从Web API的三个基本端点开始。</p><ul class=""><li id="0f1b" class="ll lm hu jj b jk jl jo jp js ln jw lo ka lp ke lq lr ls lt dt translated"><strong class="jj hv">挖掘</strong>:这个端点将启动挖掘过程。挖矿会让我们满足工作证明，把区块加入区块链。</li><li id="5bae" class="ll lm hu jj b jk lu jo lv js lw jw lx ka ly ke lq lr ls lt dt translated"><strong class="jj hv">事务</strong>:该端点用于添加一个新的事务。交易将包含关于发送者、接收者和金额的信息。</li><li id="b71a" class="ll lm hu jj b jk lu jo lv js lw jw lx ka ly ke lq lr ls lt dt translated"><strong class="jj hv">区块链</strong>:这个端点返回完整的区块链。</li></ul><p id="313a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv">区块链控制器</strong>使用<strong class="jj hv">区块链服务</strong>来执行所需的操作。BlockChainService的实现如下所示:</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="2ee5" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">让我们来看看Web API端点。启动Vapor服务器，并向“<strong class="jj hv"> mine </strong>”端点发送请求。</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lz"><img src="../Images/5c0a89ce9b6b7930b0c54805939ca6c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8o92UA7BukoIxPOHpGbKhg.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Mining a New Block</figcaption></figure><p id="c27d" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">工作证明算法生成一个以“<strong class="jj hv"> 000 </strong>”开始的哈希值。一旦块被挖掘出来，我们就通过将它转换成JSON格式来返回它。这是通过使用Swift 4.0可编码协议来执行的。</p><p id="89fb" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在，我们可以将事务添加到区块链中。这是一个简单的交易，从亚历克斯向玛丽转账10美元。</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lz"><img src="../Images/6ed408e21f49d703547971ad025d8d55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y-LW-R4nfAS7QntHsMnESQ.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">New Transaction</figcaption></figure><p id="a325" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">最后一步是用新添加的块检查我们的区块链。访问端点“<strong class="jj hv">区块链</strong>”查看完整的链。</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lz"><img src="../Images/246edecf796340d6d65fce6cef06f029.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UmUEG9TSvB-gIVtkrVUC8w.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Blockchain</figcaption></figure><p id="7704" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">万岁！我们的区块链Web API现在工作正常。</p><p id="540f" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">不幸的是，区块链的要点是去中心化，目前，我们没有任何机制来添加新的节点。在下一节中，我们将更新我们的区块链实现，以便它可以支持多个节点。</p><h2 id="6097" class="kf kg hu bd kh ki kj kk kl km kn ko kp js kq kr ks jw kt ku kv ka kw kx ky kz dt translated">向区块链添加节点</h2><p id="29bc" class="pw-post-body-paragraph jh ji hu jj b jk la jm jn jo lb jq jr js lc ju jv jw ld jy jz ka le kc kd ke hn dt translated">在允许区块链添加新节点之前，我们必须定义一个节点是什么样子的。节点模型的实现如下所示:</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="0903" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv"> BlockChainNode </strong>类只包含一个代表节点服务器URL的<strong class="jj hv">地址</strong>属性。我们更新了BlockchainController，添加了注册新节点的功能。如下所示:</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="7ba7" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">BlockchainService也会得到更新，以适应新节点的注册。</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="09c0" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">让我们继续进行测试。启动新的Vapor服务器并尝试注册新节点。</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lz"><img src="../Images/9cdb755d39f2250dd2f7b3f5b2e08c86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Y7NWaNIbmW4572wAWF_Mw.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Register a New Node</figcaption></figure><p id="f86a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">一旦注册了节点，您就可以使用节点端点获取它，如下所示:</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff lz"><img src="../Images/bb2ae0acb2aa2abbe18719e3b4b0be3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ocZbDJ8G7GpcfxgtCLLRug.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Fetching All Nodes</figcaption></figure><p id="8c62" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">现在，我们可以注册新节点了，我们应该集中精力解决节点之间的冲突。当一个节点上的区块链比其他节点大时，就会发生冲突。在这种情况下，我们总是采用相邻节点并用较大的区块链更新它们。</p><h2 id="945e" class="kf kg hu bd kh ki kj kk kl km kn ko kp js kq kr ks jw kt ku kv ka kw kx ky kz dt translated">解决节点之间的冲突</h2><p id="69c8" class="pw-post-body-paragraph jh ji hu jj b jk la jm jn jo lb jq jr js lc ju jv jw ld jy jz ka le kc kd ke hn dt translated">为了产生冲突，我们需要运行第二台服务器或在单独的端口上运行服务器。我们将使用后一种方法，在不同的端口上启动Vapor服务器。两个节点启动后，我们将在两个节点上创建事务，这将向区块链添加数据块。最后，我们将调用一个resolve端点来解决节点之间的冲突，并将节点更新到更大的区块链。</p><p id="5044" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">BlockchainController已更新，添加了用于解决冲突的新端点。</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="1eb5" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们使用了Vapor框架的异步响应特性，这将允许我们异步处理响应。BlockchainService也已更新，以支持冲突解决。实现如下所示:</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="lj lk l"/></div></figure><p id="84bb" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated"><strong class="jj hv"> resolve </strong>函数遍历节点列表并获取每个节点的区块链。如果区块链大于当前的区块链，那么它会用较大的那个替换区块链，否则它会返回当前的区块链，也是较大的那个。</p><p id="bff6" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">为了进行测试，让我们在不同的端口上启动两个服务器，并在端口<strong class="jj hv"> 8080 </strong>上添加两个事务，在<strong class="jj hv"> 8090 </strong>上添加三个事务。您可以通过发出以下命令，使用终端启动Vapor服务器。</p><pre class="lf lg lh li fq ma mb mc md aw me dt"><span id="9671" class="kf kg hu mb b fv mf mg l mh mi">vapor run serve -— port=8090</span></pre><p id="1fbc" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我们在端口8080节点上添加了三个事务，如下所示:</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mj"><img src="../Images/31748e18387bf1bb487292ec8c2be4b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NHSHvOQq4UsDSocl3YbrBg.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Blockchain on Port 8080</figcaption></figure><p id="e639" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">之后，我们在端口8090节点上添加了两个事务，如下所示:</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mj"><img src="../Images/097269d7f436314b9f206450e9f2ecd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZgurG4VRpxuzBGRqjr63rg.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Blockchain on Port 8090</figcaption></figure><p id="0597" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">确保使用8090地址注册节点，如下所示:</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mj"><img src="../Images/85d34aa6a30159be1c695f756b538459.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6kPZIo4GhXPzoEAO4f_fCw.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Registering a Node</figcaption></figure><p id="6aec" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">最后，是时候测试我们解决冲突的终点了。通过在您的Postman中访问“<strong class="jj hv"> resolve </strong>”端点来调用它，如下所示:</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff mj"><img src="../Images/7e06159cfedd66e6d08bcf189d0152f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hruML379pKN3TfTedBiRPA.png"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">Resolve End Point Returning Larger Blockchain</figcaption></figure><p id="716b" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如您所见，解析端点返回较大的区块链，并更新其他节点的区块链。这就完成了我们的冲突解决场景。</p><p id="302c" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">[ <a class="ae jg" href="https://github.com/azamsharp/BlockchainWebAPI" rel="noopener ugc nofollow" target="_blank"> Github </a> ]</p><p id="d729" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">这篇文章基于Daniel Van Flymen的一篇精彩文章“通过建造一个来了解区块链”。</p><p id="9474" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">我希望你喜欢这个帖子。我目前正在制作一个Udemy课程，主题是“iOS 中的<strong class="jj hv">区块链编程”。你可以点击<a class="ae jg" href="https://gum.co/sFOao/blockchainfree" rel="noopener ugc nofollow" target="_blank">这里</a>订阅课程发布时的通知。</strong></p><p id="0d51" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果你想支持我的写作和捐赠，请访问我的<a class="ae jg" href="http://www.azamsharp.com/courses" rel="noopener ugc nofollow" target="_blank">课程</a>页面，在Udemy上购买我的精彩课程。</p><p id="9c4a" class="pw-post-body-paragraph jh ji hu jj b jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">谢谢，祝编程愉快！</p><figure class="lf lg lh li fq iv"><div class="bz el l di"><div class="mk lk l"/></div></figure></div></div>    
</body>
</html>