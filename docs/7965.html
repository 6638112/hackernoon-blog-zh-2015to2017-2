<html>
<head>
<title>Migration to a monolithic repository without the code freeze</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">迁移到一个单一的存储库，而不会冻结代码</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/migration-to-a-monolithic-repository-without-the-code-freeze-b8f302066314?source=collection_archive---------12-----------------------#2017-11-14">https://medium.com/hackernoon/migration-to-a-monolithic-repository-without-the-code-freeze-b8f302066314?source=collection_archive---------12-----------------------#2017-11-14</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="cf8e" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">我们最近将10个项目迁移到了一个单独的<a class="ae jj" href="https://voucherify.io/?utm_campaign=tech&amp;utm_medium=Post&amp;utm_source=medium" rel="noopener ugc nofollow" target="_blank"> Voucherify </a> git库。这里有一个简短的备忘录，说明我们为什么引入新方法，以及我们如何在不阻塞功能交付管道的情况下进行转换。</h2></div><figure class="jl jm jn jo fq jp fe ff paragraph-image"><div class="fe ff jk"><img src="../Images/a830691f104621519f304a4197521ec6.png" data-original-src="https://miro.medium.com/v2/resize:fit:624/format:webp/0*1kgMi0vE6tV9pp8d.jpg"/></div><figcaption class="js jt fg fe ff ju jv bd b be z ek"><em class="jw">by Daniel Mróz from The Cyberiad</em></figcaption></figure><h1 id="772c" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ja ki jb kj jd kk je kl jg km jh kn ko dt translated">为什么是monolith</h1><p id="067b" class="pw-post-body-paragraph kp kq hu kr b ks kt iv ku kv kw iy kx ky kz la lb lc ld le lf lg lh li lj lk hn dt translated">2年的凭证式<a class="ae jj" href="https://hackernoon.com/tagged/development" rel="noopener ugc nofollow" target="_blank">开发</a>给了我们足够的时间让我们的代码库成长为一个单独的项目，并成为一些相互关联的服务。自然地，在构建我们的平台的过程中，我们注意到在几个地方使用了越来越多的代码——通常称为“<em class="ll"> commons”。</em>到目前为止，我们只是在需要的地方复制了代码。这显然是最快的方法，我们故意选择它，因为我们的开发团队迭代速度很快。</p><p id="f771" class="pw-post-body-paragraph kp kq hu kr b ks lm iv ku kv ln iy kx ky lo la lb lc lp le lf lg lq li lj lk hn dt translated">但是有时候复制和维护<em class="ll"> commons </em>会变得很麻烦，实际上会降低迭代速度。记住所有使用util的地方的负担太重了。因此，我们集思广益如何解决这个问题，实际上最终有两个解决方案。</p><p id="c144" class="pw-post-body-paragraph kp kq hu kr b ks lm iv ku kv ln iy kx ky lo la lb lc lp le lf lg lq li lj lk hn dt translated">第一个是创建一个模块库。例如，将项目包装到NPM模块中，引入版本化方案，并建立私有模块库。尽管这种方法有一些无可争议的好处，但它并不是100%适合我们的情况。以下是我们会议的要点:</p><ul class=""><li id="d95d" class="lr ls hu kr b ks lm kv ln ky lt lc lu lg lv lk lw lx ly lz dt translated">有这么多回购，有人必须学会如何维护(并这样做)NPM回购。借助整体式回购，不存在依赖性<a class="ae jj" href="https://hackernoon.com/tagged/management" rel="noopener ugc nofollow" target="_blank">管理</a>问题，无需手动升级模块版本</li><li id="55f1" class="lr ls hu kr b ks ma kv mb ky mc lc md lg me lk lw lx ly lz dt translated">monolith让代码审查变得更加容易</li><li id="64d2" class="lr ls hu kr b ks ma kv mb ky mc lc md lg me lk lw lx ly lz dt translated">在源代码树和项目中导航也变得更加容易</li><li id="711f" class="lr ls hu kr b ks ma kv mb ky mc lc md lg me lk lw lx ly lz dt translated">测试和连续交付变得更加容易——您知道在提交X时您有一个一致的状态</li></ul><p id="1d41" class="pw-post-body-paragraph kp kq hu kr b ks lm iv ku kv ln iy kx ky lo la lb lc lp le lf lg lq li lj lk hn dt translated">基本上，决定采用mono路径是为了解决“公共”问题，并将迭代速度保持在相同的水平。此外，我们仍然是一个小而精的团队——事实上，我们只做一个项目。这就是为什么我们的开发人员不太可能浪费时间去理解不相关的代码。恰恰相反，每个人都应该关注每一个变化。出于同样的原因，我们不需要引入任何访问控制措施。</p><p id="0c71" class="pw-post-body-paragraph kp kq hu kr b ks lm iv ku kv ln iy kx ky lo la lb lc lp le lf lg lq li lj lk hn dt translated">因此，我们一致认为这是一个好的举措，然后我们开始考虑如何以一种不阻碍正在进行的开发的方式来执行过渡。</p><h1 id="691d" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ja ki jb kj jd kk je kl jg km jh kn ko dt translated">迁移过程</h1><p id="e79b" class="pw-post-body-paragraph kp kq hu kr b ks kt iv ku kv kw iy kx ky kz la lb lc ld le lf lg lh li lj lk hn dt translated">过渡结果超级顺利。我们保留了提交历史，即使提交散列没有改变。这可以用一个git命令来实现——git子树<a class="ae jj" href="https://git-scm.com/book/en/v1/Git-Tools-Subtree-Merging" rel="noopener ugc nofollow" target="_blank"><em class="ll">。该过程看起来如下:</em></a></p><p id="4323" class="pw-post-body-paragraph kp kq hu kr b ks lm iv ku kv ln iy kx ky lo la lb lc lp le lf lg lq li lj lk hn dt translated"><strong class="kr hv"> 1。</strong>将回购放入单个回购中。</p><pre class="jl jm jn jo fq mf mg mh mi aw mj dt"><span id="ed05" class="mk jy hu mg b fv ml mm l mn mo">git subtree add --prefix=project-a git@github.com:voucherify/project-a.git master</span><span id="3328" class="mk jy hu mg b fv mp mm l mn mo">git subtree add --prefix=project-b git@github.com:voucherify/project-b.git master</span><span id="7af7" class="mk jy hu mg b fv mp mm l mn mo">...</span></pre><p id="6a7b" class="pw-post-body-paragraph kp kq hu kr b ks lm iv ku kv ln iy kx ky lo la lb lc lp le lf lg lq li lj lk hn dt translated"><strong class="kr hv"> 2。</strong>改变部署过程，使其能够正确处理新的“commons ”( docker file、Procfile和shell脚本中的变化，我不会在本文中讨论；如果你感兴趣，请在评论中告诉我)。</p><p id="bf33" class="pw-post-body-paragraph kp kq hu kr b ks lm iv ku kv ln iy kx ky lo la lb lc lp le lf lg lq li lj lk hn dt translated"><strong class="kr hv"> 3。</strong>更新同时推送的变更。</p><pre class="jl jm jn jo fq mf mg mh mi aw mj dt"><span id="06d9" class="mk jy hu mg b fv ml mm l mn mo">git subtree pull --prefix=project-a git@github.com:voucherify/project-a.git master</span><span id="d993" class="mk jy hu mg b fv mp mm l mn mo">git subtree pull --prefix=project-b git@github.com:voucherify/project-b.git master</span></pre><p id="4129" class="pw-post-body-paragraph kp kq hu kr b ks lm iv ku kv ln iy kx ky lo la lb lc lp le lf lg lq li lj lk hn dt translated"><strong class="kr hv"> 4。</strong>正在进行的工作将提交给特定回购协议的开发人员分支机构(此外，为了简单起见，我们将所有等待的拉请求合并到master)。</p><p id="9f0c" class="pw-post-body-paragraph kp kq hu kr b ks lm iv ku kv ln iy kx ky lo la lb lc lp le lf lg lq li lj lk hn dt translated"><strong class="kr hv"> 5。</strong>从多个回购协议中迁移分支，以项目a存储库为例。</p><pre class="jl jm jn jo fq mf mg mh mi aw mj dt"><span id="ca22" class="mk jy hu mg b fv ml mm l mn mo">export BRANCHES=$(cat &lt;&lt;HERE<br/>development-branch-1<br/>development-branch-2<br/>development-branch-3<br/>development-branch-4<br/>HERE<br/>)</span><span id="0f6b" class="mk jy hu mg b fv mp mm l mn mo">for branch in $BRANCHES<br/>do<br/>    echo “============== copying ${branch} ============= “<br/>    git checkout master<br/>    git checkout -b $branch<br/>    git subtree pull --prefix=project-a git@github.com:voucherify/project-a.git $branch<br/>    git push -u origin $branch<br/>    git checkout master<br/>done</span></pre><p id="cdbb" class="pw-post-body-paragraph kp kq hu kr b ks lm iv ku kv ln iy kx ky lo la lb lc lp le lf lg lq li lj lk hn dt translated"><strong class="kr hv"> 6。与此同时，开发人员克隆新的整体存储库，并相应地重新配置ide。</strong></p><p id="2cd5" class="pw-post-body-paragraph kp kq hu kr b ks lm iv ku kv ln iy kx ky lo la lb lc lp le lf lg lq li lj lk hn dt translated"><strong class="kr hv"> 7。</strong>当一个“合并主”给出一个信号，表明他已经迁移了所有的开发人员分支时，开发人员可以用下面的命令检查远程分支:</p><pre class="jl jm jn jo fq mf mg mh mi aw mj dt"><span id="aaf5" class="mk jy hu mg b fv ml mm l mn mo">git checkout -b branch_name origin/branch_name</span></pre><p id="d0fe" class="pw-post-body-paragraph kp kq hu kr b ks lm iv ku kv ln iy kx ky lo la lb lc lp le lf lg lq li lj lk hn dt translated"><strong class="kr hv"> 8。</strong>就这样，Voucherify从现在开始运行在monolithic repository上。</p><h1 id="e874" class="jx jy hu bd jz ka kb kc kd ke kf kg kh ja ki jb kj jd kk je kl jg km jh kn ko dt translated">总结和未来的增强</h1><p id="4db4" class="pw-post-body-paragraph kp kq hu kr b ks kt iv ku kv kw iy kx ky kz la lb lc ld le lf lg lh li lj lk hn dt translated">我们执行迁移已经一个月了。通过让易于维护的实用程序唾手可得，团队提高了生产率。他们也很高兴只有一个IDE实例在运行，而不是5个(尽管浏览搜索结果变得有点困难)。现在，下一个改进是提取更多的“commons ”,这将使构建功能更快:像commons-auth或其他业务相关的东西这样的模块。</p></div><div class="ab cl mq mr hc ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="hn ho hp hq hr"><p id="4303" class="pw-post-body-paragraph kp kq hu kr b ks lm iv ku kv ln iy kx ky lo la lb lc lp le lf lg lq li lj lk hn dt translated"><em class="ll">原载于</em><a class="ae jj" href="https://www.voucherify.io/blog/migration-to-a-monolithic-repository-without-the-code-freeze" rel="noopener ugc nofollow" target="_blank"><em class="ll">www . voucherify . io</em></a><em class="ll">。</em></p><figure class="jl jm jn jo fq jp"><div class="bz el l di"><div class="mx my l"/></div></figure></div></div>    
</body>
</html>