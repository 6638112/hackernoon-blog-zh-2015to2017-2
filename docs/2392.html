<html>
<head>
<title>Stream a million WebSocket/SQL requests from a single browser client in a few seconds …</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在几秒钟内从单个浏览器客户端传输一百万个WebSocket/SQL请求…</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/stream-a-million-websocket-sql-requests-from-a-single-browser-client-in-a-few-seconds-e7a2b068974c?source=collection_archive---------3-----------------------#2017-01-24">https://medium.com/hackernoon/stream-a-million-websocket-sql-requests-from-a-single-browser-client-in-a-few-seconds-e7a2b068974c?source=collection_archive---------3-----------------------#2017-01-24</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="3af2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我喜欢突破现有浏览器堆栈的性能界限。在之前的一篇文章中，我展示了如何利用Web Workers和WebAssembly在浏览器中执行一百万条SQL语句。</p><div class="jp jq fm fo jr js"><a href="https://hackernoon.com/execute-millions-of-sql-statements-in-milliseconds-in-the-browser-with-webassembly-and-web-workers-3e0b25c3f1a6" rel="noopener  ugc nofollow" target="_blank"><div class="jt ab ej"><div class="ju ab jv cl cj jw"><h2 class="bd hv fv z el jx eo ep jy er et ht dt translated">使用WebAssembly和Web Workers在浏览器中以毫秒为单位执行数百万条SQL语句。</h2><div class="jz l"><h3 class="bd b fv z el jx eo ep jy er et ek translated">这是一个相当长的标题，但希望它能引起你的注意！</h3></div><div class="ka l"><p class="bd b gc z el jx eo ep jy er et ek translated">hackernoon.com</p></div></div><div class="kb l"><div class="kc l kd ke kf kb kg kh js"/></div></div></a></div><p id="cfe3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">虽然这很有趣，而且肯定展示了浏览器<a class="ae ki" href="https://hackernoon.com/tagged/javascript" rel="noopener ugc nofollow" target="_blank"> JavaScript </a>引擎的强大威力，但是让浏览器孤立地做事情限制了用例。更有用的是连接到后端，这样我们可以在服务器上处理我们的<a class="ae ki" href="https://hackernoon.com/tagged/sql" rel="noopener ugc nofollow" target="_blank"> SQL </a>。事实上，这是大多数web应用程序的基础。我使用Web Sockets已经有一段时间了，浏览器的简单性和性能给我留下了深刻的印象。</p><p id="6846" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于这个例子，我想看看从一个浏览器客户端可以实现多少WebSocket请求。为了使测试更加真实，我让服务器在每个Web Socket请求上向Sqlite数据库插入一个简单的记录。作为参考，下面是使用备受推崇的TechEmpower基准测试的直接HTTP的结果:</p><div class="jp jq fm fo jr js"><a href="https://www.techempower.com/benchmarks/#section=data-r13&amp;hw=ph&amp;test=update" rel="noopener  ugc nofollow" target="_blank"><div class="jt ab ej"><div class="ju ab jv cl cj jw"><h2 class="bd hv fv z el jx eo ep jy er et ht dt translated">TechEmpower Web框架性能比较</h2><div class="jz l"><h3 class="bd b fv z el jx eo ep jy er et ek translated">使用社区贡献的测试对各种web应用程序框架和平台进行性能比较…</h3></div><div class="ka l"><p class="bd b gc z el jx eo ep jy er et ek translated">www.techempower.com</p></div></div><div class="kb l"><div class="kj l kd ke kf kb kg kh js"/></div></div></a></div><p id="6113" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">此图列出了数据库更新的最佳表现者:</p><figure class="kl km kn ko fq kp fe ff paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="fe ff kk"><img src="../Images/2fe522007aeda62748db9131fa0a834f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FockA1NCwyJdH93zt4g7GA.png"/></div></div></figure><p id="13ee" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我的测试并不是与该基准进行比较，而是提供给读者一个类似用例的参考点，即通过浏览器进行数据库更新。</p><p id="1793" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要运行测试，您需要一个Web套接字服务器和一个数据库引擎。我将使用两个我最喜欢的应用程序，每当我提供新的黑客环境时，我都会立即安装这两个应用程序:</p><p id="5f9d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">来自此处的websocketd:</p><div class="jp jq fm fo jr js"><a href="https://github.com/joewalnes/websocketd" rel="noopener  ugc nofollow" target="_blank"><div class="jt ab ej"><div class="ju ab jv cl cj jw"><h2 class="bd hv fv z el jx eo ep jy er et ht dt translated">Joe wannes/websocketd</h2><div class="jz l"><h3 class="bd b fv z el jx eo ep jy er et ek translated">将任何使用STDIN/STDOUT的程序转换成一个WebSocket服务器。类似于inetd，但用于WebSockets。</h3></div><div class="ka l"><p class="bd b gc z el jx eo ep jy er et ek translated">github.com</p></div></div><div class="kb l"><div class="kv l kd ke kf kb kg kh js"/></div></div></a></div><p id="9eb0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">和Sqlite:</p><div class="jp jq fm fo jr js"><a href="http://sqlite.org/" rel="noopener  ugc nofollow" target="_blank"><div class="jt ab ej"><div class="ju ab jv cl cj jw"><h2 class="bd hv fv z el jx eo ep jy er et ht dt translated">SQLite主页</h2><div class="jz l"><h3 class="bd b fv z el jx eo ep jy er et ek translated">SQLite是一个独立的、高可靠性的、嵌入式的、全功能的、公共域的SQL数据库引擎。SQLite是…</h3></div><div class="ka l"><p class="bd b gc z el jx eo ep jy er et ek translated">sqlite.org</p></div></div><div class="kb l"><div class="kw l kd ke kf kb kg kh js"/></div></div></a></div><p id="aaa3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当您需要快速而强大的工具来进行原型设计或头脑风暴时，我不能推荐这些应用程序。</p><blockquote class="kx ky kz"><p id="b8fd" class="ir is la it b iu iv iw ix iy iz ja jb lb jd je jf lc jh ji jj ld jl jm jn jo hn dt translated">“Websocketd可以把任何使用STDIN/STDOUT的程序变成WebSocket服务器。像inetd，但是是针对WebSockets的。”</p><p id="3be2" class="ir is la it b iu iv iw ix iy iz ja jb lb jd je jf lc jh ji jj ld jl jm jn jo hn dt translated">“SQLite是一个独立的、高可靠性的、嵌入式的、全功能的、公共域的SQL数据库引擎。SQLite是世界上使用最多的数据库引擎。”</p></blockquote><p id="95d5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我最喜欢这些工具以及我另一个最喜欢的黑客工具PhantomJS的一点是，它们都是自包含的可执行文件，可以在任何环境下运行，从基于云的超级计算机到精致的RaspberryPi。没有安装，依赖或打包…只是一个很好的旧命令行可执行文件。</p><p id="558a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要运行测试，创建一个本地目录，并将websocketd和sqlite可执行文件复制到该目录中。根据您的环境，您可能需要对这些文件授予执行权限。对于我的测试，我运行在Windows 10机器上，配置如下:</p><pre class="kl km kn ko fq le lf lg lh aw li dt"><span id="2896" class="lj lk hu lf b fv ll lm l ln lo">Dell XPS<br/>Processor Intel(R) Core(TM) i7–4770 CPU @ 3.40GHz, 3401 Mhz, 4 Core(s), 8 Logical Processor(s)</span><span id="5807" class="lj lk hu lf b fv lp lm l ln lo">24 Gigs of RAM<br/>256 SSD Drive</span></pre><p id="ed28" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我创建了一个名为WebSocketTest的目录，如下所示:</p><figure class="kl km kn ko fq kp fe ff paragraph-image"><div class="fe ff lq"><img src="../Images/b3445b5a670efd7872aa997741d7800b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B1Qmd1ZrdcSyt14-IBNcvw.png"/></div></figure><p id="9d94" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">运行服务器就像执行以下命令行一样简单:</p><pre class="kl km kn ko fq le lf lg lh aw li dt"><span id="c53b" class="lj lk hu lf b fv ll lm l ln lo">websocketd --devconsole --port:8081 sqlite3</span></pre><p id="2813" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您应该得到类似下面这样的消息，让您知道服务器正在运行:</p><figure class="kl km kn ko fq kp fe ff paragraph-image"><div class="fe ff lq"><img src="../Images/cf9bdcfe0b51eff8d4c961fc71e94317.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fTGtZ89tNzNaCpLg9NcmnQ.png"/></div></figure><p id="bf7e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了确保您的环境正在工作，请从您的浏览器导航到<a class="ae ki" href="http://localhost:8081" rel="noopener ugc nofollow" target="_blank"> http://localhost:8081 </a>。我在最新版本的Firefox上做了测试:</p><figure class="kl km kn ko fq kp fe ff paragraph-image"><div class="fe ff lr"><img src="../Images/16a34f1ab411e4d5486050633341488a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*CfGmMVthanihrS8yIs7g_A.png"/></div></figure><p id="60db" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">导航到<a class="ae ki" href="http://localhost:8081" rel="noopener ugc nofollow" target="_blank"> http://localhost:8081 </a>可以让您访问一个交互式REPL，它允许您测试您的环境。在这种情况下，因为我们使用Sqlite命令shell作为我们的“服务器”，所以您可以执行通常使用命令行shell执行的任何命令:</p><figure class="kl km kn ko fq kp fe ff paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="fe ff ls"><img src="../Images/7967358cae9ce8977444f86e82c3a914.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mKJnJUGtwOyYn5whF9PVAw.png"/></div></div></figure><p id="ddb3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">基本上，websocketd所做的是包装您的命令行可执行文件，并将标准输入和标准输出通过管道传输到一个Web套接字连接，您可以从浏览器访问该连接。很明显，这不是你想在生产环境中做的事情，但是这对于原型创意来说是很棒的。您可以在devconsole中尝试更多的示例，例如:</p><pre class="kl km kn ko fq le lf lg lh aw li dt"><span id="cc9b" class="lj lk hu lf b fv ll lm l ln lo">.timer on</span><span id="2e05" class="lj lk hu lf b fv lp lm l ln lo">select sqlite_version() as version;</span><span id="d5c2" class="lj lk hu lf b fv lp lm l ln lo">create table log(entry);</span><span id="2690" class="lj lk hu lf b fv lp lm l ln lo">insert into log VALUES(datetime());</span><span id="2f91" class="lj lk hu lf b fv lp lm l ln lo">select * from log;</span><span id="d818" class="lj lk hu lf b fv lp lm l ln lo">delete from log;<br/></span></pre><p id="891e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">确保你包括结尾；终止您的SQL命令！</strong></p><p id="4781" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了让您了解Sqlite数据库引擎有多快，让我们使用以下命令向日志表中插入一百万条记录:</p><pre class="kl km kn ko fq le lf lg lh aw li dt"><span id="75f3" class="lj lk hu lf b fv ll lm l ln lo">WITH cnt(x) AS (VALUES(1) UNION ALL SELECT x+1 FROM cnt WHERE x&lt;1000000) INSERT INTO log SELECT datetime() FROM cnt;</span></pre><figure class="kl km kn ko fq kp fe ff paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="fe ff lt"><img src="../Images/0b78d0ff3972b8a4b02ee64b5e854c8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Q2GXYj9zu_WpzEt7T6hQA.png"/></div></div></figure><p id="ef55" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以它花了大约</p><h2 id="899d" class="lj lk hu bd lu lv lw lx ly lz ma mb mc jc md me mf jg mg mh mi jk mj mk ml mm dt translated">向日志表中插入一百万行大约需要1秒钟</h2><p id="78f4" class="pw-post-body-paragraph ir is hu it b iu mn iw ix iy mo ja jb jc mp je jf jg mq ji jj jk mr jm jn jo hn dt translated">…真是令人印象深刻！</p><p id="cb5e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在我们继续之前，<strong class="it hv">确保您通过输入以下命令关闭Sqlite计时器</strong></p><pre class="kl km kn ko fq le lf lg lh aw li dt"><span id="9ef3" class="lj lk hu lf b fv ll lm l ln lo">.timer off</span></pre><p id="b5a4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在REPL！这可以防止客户端在我们的大更新时被来自服务器的消息淹没。</p><p id="b360" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当然，这并没有真正测试我们的Web套接字，因为上面的命令是作为单个Web套接字发送到服务器的，在那里执行。为了测试发送一百万个Web套接字请求需要多长时间，我们将使用浏览器控制台直接执行我们的代码。</p><p id="4ebf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">按F12键在浏览器中打开开发人员工具，并从控制台粘贴以下代码:</p><pre class="kl km kn ko fq le lf lg lh aw li dt"><span id="d822" class="lj lk hu lf b fv ll lm l ln lo">console.time("Elapsed");<br/>var numMessages=1000000;<br/>var code = "insert into log VALUES(datetime());";<br/>ws.send("BEGIN;")<br/>Array(numMessages).fill(0).forEach(x =&gt; {ws.send(code)});<br/>ws.send("COMMIT;")<br/>console.timeEnd("Elapsed");</span></pre><p id="1195" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您应该得到如下所示的内容:</p><figure class="kl km kn ko fq kp fe ff paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="fe ff lt"><img src="../Images/dcabd38f10b6ec2070dc566cf195ba43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i9pPSBQ9p4pr6CDD7sG3_Q.png"/></div></div></figure><p id="e914" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如你所见，在我的机器上…花了</p><h2 id="63db" class="lj lk hu bd lu lv lw lx ly lz ma mb mc jc md me mf jg mg mh mi jk mj mk ml mm dt translated">发送100万个请求大约需要4秒钟</h2><p id="19c4" class="pw-post-body-paragraph ir is hu it b iu mn iw ix iy mo ja jb jc mp je jf jg mq ji jj jk mr jm jn jo hn dt translated">到服务器并执行SQL插入！</p><p id="dd31" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">要进行验证，请关闭开发人员工具(再次按F12 ),并在REPL中重新执行以下命令:</p><pre class="kl km kn ko fq le lf lg lh aw li dt"><span id="a87f" class="lj lk hu lf b fv ll lm l ln lo">select count(*) from log;</span></pre><p id="1870" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">您应该看到现在日志表中有1，000，000条记录。</p><p id="9f68" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">显然，根据您的机器配置和浏览器选择，您的结果可能会有所不同。在任何情况下，在一个受控的环境中，您应该能够轻松地每秒处理数十万个Web套接字请求。</p><p id="43f1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">由于这只是使用来自单个客户端的单个Web套接字连接，我怀疑如果我们利用多个客户端，我们每秒可以处理数百万个请求。我的下一个测试将集中在使用Web Workers利用多个Web Sockets所以请继续关注。</p><p id="6c9d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你喜欢这篇文章，也喜欢我其他关于Medium的文章，请推荐！</p><div class="jp jq fm fo jr js"><a href="https://hackernoon.com/@mikeptweet" rel="noopener  ugc nofollow" target="_blank"><div class="jt ab ej"><div class="ju ab jv cl cj jw"><h2 class="bd hv fv z el jx eo ep jy er et ht dt translated">迈克·帕森斯-黑客正午</h2><div class="jz l"><h3 class="bd b fv z el jx eo ep jy er et ek translated">阅读麦克·帕森斯在《黑客正午》中的文章。软件研究极客。每天，迈克·帕森斯和成千上万的其他人…</h3></div><div class="ka l"><p class="bd b gc z el jx eo ep jy er et ek translated">hackernoon.com</p></div></div><div class="kb l"><div class="ms l kd ke kf kb kg kh js"/></div></div></a></div><p id="a973" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">谢了。</p><div class="kl km kn ko fq ab cb"><figure class="mt kp mu mv mw mx my paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mt kp mu mv mw mx my paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mt kp mu mv mw mx my paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="kx ky kz"><p id="f922" class="ir is la it b iu iv iw ix iy iz ja jb lb jd je jf lc jh ji jj ld jl jm jn jo hn dt translated"><a class="ae ki" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ki" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ki" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae ki" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is la it b iu iv iw ix iy iz ja jb lb jd je jf lc jh ji jj ld jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ki" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ki" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kl km kn ko fq kp fe ff paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="fe ff mz"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="kl km kn ko fq kp"><div class="bz el l di"><div class="na nb l"/></div></figure></div></div>    
</body>
</html>