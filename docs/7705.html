<html>
<head>
<title>Setting up an etcd cluster on AWS using CoreOS &amp; Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CoreOS &amp; Terraform在AWS上设置etcd集群</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/setting-up-an-etcd-cluster-on-aws-using-coreos-terraform-bc7ad7e8175b?source=collection_archive---------11-----------------------#2017-11-05">https://medium.com/hackernoon/setting-up-an-etcd-cluster-on-aws-using-coreos-terraform-bc7ad7e8175b?source=collection_archive---------11-----------------------#2017-11-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div class="fe ff ir"><img src="../Images/dd3a98f95c7ede565dc7dc3b797584e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/0*FE7oLYcwOIdmq8Em."/></div></figure><p id="eb25" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">这篇文章是“<a class="ae jw" href="http://www.blog.labouardy.com/manage-aws-vpc-as-infrastructure-as-code-with-terraform/" rel="noopener ugc nofollow" target="_blank"> <strong class="ja hv"> IaC </strong> </a>”系列的一部分，解释如何使用<strong class="ja hv">基础设施作为代码</strong>概念与<strong class="ja hv">地形</strong>。在这一部分，我将向您展示如何使用<strong class="ja hv">CoreOS</strong>&amp;<strong class="ja hv">terra form</strong>在<strong class="ja hv"> AWS </strong>上设置<strong class="ja hv"> etcd </strong>集群，如下图所示:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff jx"><img src="../Images/1a1b2e0c768791b2c1f58b0606407af4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*O_JqIec322G8OvKh."/></div></figure><p id="768c" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">本演示使用的所有模板都可以在我的<a class="ae jw" href="https://github.com/mlabouardy/terraform-aws-labs/tree/master/etcd-cluster" rel="noopener ugc nofollow" target="_blank"> <strong class="ja hv"> Github </strong> </a>上找到。</p><p id="5009" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">因此，让我们从“<strong class="ja hv"> variables.tf </strong>”文件开始，该文件包含AWS区域、集群实例类型等全局变量</p><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="c9e5" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">注:截至本文撰写时，最新稳定的<strong class="ja hv"> CoreOS </strong>版本为<strong class="ja hv"> 1465.6.0 </strong>。</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff ke"><img src="../Images/62ba08d9c8637d15b4e584cdd287576a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*RMayR0s9o3g8OBhf."/></div></figure><p id="5329" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">所以一定要找到一个尽可能接近最新版本的<strong class="ja hv"> AMI </strong>。</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="fe ff kf"><img src="../Images/370feae949ebbb80dab2937323486661.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HiWS_m5q6ZJyc2GN."/></div></div></figure><p id="8400" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">接下来，我们需要为集群定义一个<strong class="ja hv">安全组</strong>。为了简单起见，我将使这个<strong class="ja hv">安全组</strong>对全世界开放。尽管安全性很重要，但本教程是出于教育目的，您不应该在生产中打开所有端口。</p><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="b456" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">最后，我们将定义由<strong class="ja hv"> 3个节点</strong>组成的<strong class="ja hv">集群</strong>:</p><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="41df" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">为了调出一个<strong class="ja hv"> etcd集群</strong>，我使用了一个<strong class="ja hv">云配置</strong>文件，并将其作为参数传递给<strong class="ja hv"> user_data </strong> attribut:</p><figure class="jy jz ka kb fq iv"><div class="bz el l di"><div class="kc kd l"/></div></figure><p id="2fbb" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">注意:确保获取<strong class="ja hv">发现令牌</strong>，并将其放入发现参数:</p><blockquote class="kk kl km"><p id="ea5e" class="iy iz kn ja b jb jc jd je jf jg jh ji ko jk jl jm kp jo jp jq kq js jt ju jv hn dt translated">$ curl<a class="ae jw" href="https://discovery.etcd.io/new?size=3" rel="noopener ugc nofollow" target="_blank">https://discovery.etcd.io/new?size=3</a></p><p id="079b" class="iy iz kn ja b jb jc jd je jf jg jh ji ko jk jl jm kp jo jp jq kq js jt ju jv hn dt translated"><a class="ae jw" href="https://discovery.etcd.io/3e86b59982e49066c5d813af1c2e2579cbf573de" rel="noopener ugc nofollow" target="_blank">https://discovery . etcd . io/3e 86 b 59982 e 49066 C5 d 813 a f1 C2 e 2579 CBF 573 de</a></p></blockquote><p id="ea09" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">一旦定义了所有需要的模板，只需输入以下命令即可调出<strong class="ja hv"> etcd集群</strong>:</p><blockquote class="kk kl km"><p id="d63c" class="iy iz kn ja b jb jc jd je jf jg jh ji ko jk jl jm kp jo jp jq kq js jt ju jv hn dt translated">地形应用</p></blockquote><p id="c6a6" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">注意:不要忘记将<strong class="ja hv"> AWS </strong> <strong class="ja hv">凭证</strong>设置为<strong class="ja hv">环境变量</strong>之前:</p><blockquote class="kk kl km"><p id="4f01" class="iy iz kn ja b jb jc jd je jf jg jh ji ko jk jl jm kp jo jp jq kq js jt ju jv hn dt translated">导出AWS_ACCESS_KEY_ID= "您的访问密钥ID "</p><p id="b12f" class="iy iz kn ja b jb jc jd je jf jg jh ji ko jk jl jm kp jo jp jq kq js jt ju jv hn dt translated">导出AWS_SECRET_ACCESS_KEY= "您的秘密访问密钥"</p></blockquote><p id="8ea1" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">设置一个<strong class="ja hv"> etcd集群</strong>如下所示:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><a href="https://asciinema.org/a/135407"><div class="fe ff kr"><img src="../Images/7a82c3e14aee77de0da79b9daeccdb3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wgYyE3UsQfHyQzms."/></div></a></figure><p id="c410" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">完成后，转到您的<a class="ae jw" href="https://console.aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ja hv"> AWS管理控制台</strong> </a>，然后导航到您的<strong class="ja hv"> EC2仪表盘</strong>:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff ke"><img src="../Images/6de5bdb02605c2a3220701fc7b2d96ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*Xk1R5SIYU183zZ52."/></div></figure><p id="6eef" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">恭喜你！你有你的<strong class="ja hv"> CoreOS集群</strong>。</p><p id="571c" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">要验证c <strong class="ja hv"> luster health </strong>，您可以将浏览器指向您之前生成的发现url:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff ke"><img src="../Images/2983c46a1f61871f725286be6955447c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*99Qi8cci2OgtzGRF."/></div></figure><p id="93af" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">或者使用以下命令将SSH连接到您的一个集群节点:</p><blockquote class="kk kl km"><p id="d2ec" class="iy iz kn ja b jb jc jd je jf jg jh ji ko jk jl jm kp jo jp jq kq js jt ju jv hn dt translated">ssh核心@ <node-ip/></p></blockquote><p id="a1fb" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">然后，使用<strong class="ja hv"> etcd命令行</strong>获取<strong class="ja hv">集群状态</strong>:</p><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff ke"><img src="../Images/aeed1c42d335ff681c142d97541c65dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*Kmhs-nWU9n0HuHFZ."/></div></figure><p id="3cee" class="pw-post-body-paragraph iy iz hu ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hn dt translated">现在我们有一个<strong class="ja hv"> etcd集群</strong>可以使用了。让我们看看我们能做些什么:</p><ul class=""><li id="540a" class="ks kt hu ja b jb jc jf jg jj ku jn kv jr kw jv kx ky kz la dt translated">通过<strong class="ja hv"> etcdctl: </strong></li></ul><blockquote class="kk kl km"><p id="85f8" class="iy iz kn ja b jb jc jd je jf jg jh ji ko jk jl jm kp jo jp jq kq js jt ju jv hn dt translated">etcdctl设置nginx/端口80</p><p id="0ddd" class="iy iz kn ja b jb jc jd je jf jg jh ji ko jk jl jm kp jo jp jq kq js jt ju jv hn dt translated">etcdctl获取nginx/端口80</p><p id="9010" class="iy iz kn ja b jb jc jd je jf jg jh ji ko jk jl jm kp jo jp jq kq js jt ju jv hn dt translated">etcdctl ls nginx</p><p id="bd1e" class="iy iz kn ja b jb jc jd je jf jg jh ji ko jk jl jm kp jo jp jq kq js jt ju jv hn dt translated">etc dctl RM nginx/端口</p></blockquote><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff lb"><img src="../Images/d16c52f1696e6b793102b6f69e01ec53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1016/0*OMKaflH9-eqa-y4Y."/></div></figure><ul class=""><li id="b8b5" class="ks kt hu ja b jb jc jf jg jj ku jn kv jr kw jv kx ky kz la dt translated">通过<strong class="ja hv"> HTTP API: </strong></li></ul><blockquote class="kk kl km"><p id="a74b" class="iy iz kn ja b jb jc jd je jf jg jh ji ko jk jl jm kp jo jp jq kq js jt ju jv hn dt translated">' curl-sS-X PUT-d value = " 80 "<a class="ae jw" href="http://localhost:2379/v2/keys/nginx/port" rel="noopener ugc nofollow" target="_blank">http://localhost:2379/v2/keys/nginx/port</a>| jq ' . '#创建</p><p id="ac00" class="iy iz kn ja b jb jc jd je jf jg jh ji ko jk jl jm kp jo jp jq kq js jt ju jv hn dt translated">' curl-sS<a class="ae jw" href="http://localhost:2379/v2/keys/nginx/port" rel="noopener ugc nofollow" target="_blank">http://localhost:2379/v2/keys/nginx/port</a>| jq ' . '#获得</p><p id="a5b1" class="iy iz kn ja b jb jc jd je jf jg jh ji ko jk jl jm kp jo jp jq kq js jt ju jv hn dt translated">curl-sS-X DELETE<a class="ae jw" href="http://localhost:2379/v2/keys/nginx/port" rel="noopener ugc nofollow" target="_blank">http://localhost:2379/v2/keys/nginx/port</a>| jq ' . '#删除</p></blockquote><figure class="jy jz ka kb fq iv fe ff paragraph-image"><div class="fe ff ke"><img src="../Images/88273cab8d0442fbe2483630e7e86d4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/0*OS22_JU-_zFYHy23."/></div></figure></div></div>    
</body>
</html>