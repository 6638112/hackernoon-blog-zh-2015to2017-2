<html>
<head>
<title>The madness of parsing real world JavaScript regexps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解析真实世界JavaScript正则表达式的疯狂</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/the-madness-of-parsing-real-world-javascript-regexps-d9ee336df983?source=collection_archive---------9-----------------------#2017-01-17">https://medium.com/hackernoon/the-madness-of-parsing-real-world-javascript-regexps-d9ee336df983?source=collection_archive---------9-----------------------#2017-01-17</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="13dc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">JavaScript 的故事是一个偶然的实现细节的故事，对于所有新开发人员来说，这些细节成了不可修复的WTF时刻。所有的流行语言都是这样。参见<a class="ae jp" href="https://www.lysator.liu.se/c/dmr-on-or.html" rel="noopener ugc nofollow" target="_blank">解释</a>为什么C和<a class="ae jp" href="https://www.dartlang.org/guides/language/language-tour#operators" rel="noopener ugc nofollow" target="_blank">几乎</a>所有C-syntax语言在“&amp;”操作符上都有错误的优先级。但我认为JS已经超出了它的公平份额。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff jq"><img src="../Images/b8411965affe9691678f4ae3c4b36d71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hpV-uxXC-EK3_9kotl8CIA.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek"><a class="ae jp" href="https://regexper.com/#%2FWTA%3FF%2F" rel="noopener ugc nofollow" target="_blank">https://regexper.com/#%2FWTA%3FF%2F</a></figcaption></figure><p id="b5e0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一个著名的例子是，当微软的JScript工程师查看了<code class="eh kg kh ki kj b">typeof</code>操作符并确定</p><p id="d1af" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh kg kh ki kj b">(typeof 1) == "number"</code>、<br/>、<code class="eh kg kh ki kj b">(typeof new Object()) == "object"</code>和<br/>、T3】</p><p id="a2b0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">到目前为止，一切顺利，但是<br/> <code class="eh kg kh ki kj b">(typeof null) == "object"</code>怎么样</p><p id="2180" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">是的，没错，没有对象就是对象。所以他们尽职尽责地确保在Internet Explorer的JScript解释器中也是如此。你不能责怪他们——他们别无选择，只能兼容，即使在早期阶段，web开发人员也不会感谢他们偏离“标准”。当我们制造V8时，我们也是这样做的。</p><p id="fe4c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你想花点时间研究一下<em class="kk">为什么</em>null的类型是“对象”，看看<a class="kl km gr" href="https://medium.com/u/7fab51e62203?source=post_page-----d9ee336df983--------------------------------" rel="noopener" target="_blank">阿克塞尔·劳施迈尔</a>的精彩<a class="ae jp" href="http://www.2ality.com/2013/10/typeof-null.html" rel="noopener ugc nofollow" target="_blank">解释</a>。</p><p id="53e5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">JavaScript正则表达式也有一些类似的奇怪之处。我现在已经写了三个JS兼容的regexp引擎，从2008年我、<a class="kl km gr" href="https://medium.com/u/c452b39ab91e?source=post_page-----d9ee336df983--------------------------------" rel="noopener" target="_blank">克里斯蒂安·普莱斯纳</a>和拉塞·赖希斯坦·霍尔斯特·尼尔森坐下来写最快的<a class="ae jp" href="https://benchmarksgame.alioth.debian.org/u64q/performance.php?test=regexdna&amp;sort=fullcpu" rel="noopener ugc nofollow" target="_blank">JS regexp引擎开始。它被称为Irregexp，现在被用于Chrome、Opera、node.js、Firefox和Dart VM。</a></p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div class="fe ff kn"><img src="../Images/a9fd2b1e380476588edec3299c44426b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*oGaYyDJNEZ6UL5nN-43YMg.png"/></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">From <a class="ae jp" href="https://xkcd.com/208/" rel="noopener ugc nofollow" target="_blank">https://xkcd.com/208/</a> — yes, I have the T-shirt too</figcaption></figure><p id="2a78" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正如JS经常出现的情况一样，有官方的ECMAScript规范，然后有<a class="ae jp" href="http://www.ecma-international.org/ecma-262/6.0/#sec-additional-ecmascript-features-for-web-browsers" rel="noopener ugc nofollow" target="_blank">附录B </a>说明你必须做些什么才能兼容。还有附件B中没有的东西，你也必须做到兼容。</p><p id="4b83" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">比如根据主spec，未知的alpha转义是不允许的，所以<code class="eh kg kh ki kj b">/bac\k/</code>应该是错误，但是在<a class="ae jp" href="http://www.ecma-international.org/ecma-262/6.0/#sec-regular-expressions-patterns" rel="noopener ugc nofollow" target="_blank">附件B </a>你发现，它正好和<code class="eh kg kh ki kj b">/back/</code>匹配一样。当我们想改进JS正则表达式时，这就带来了麻烦，比如用<a class="ae jp" href="https://twitter.com/littledan/status/818637415304658944" rel="noopener ugc nofollow" target="_blank">命名捕获和命名反向引用</a>。如果使用<code class="eh kg kh ki kj b">/\k&lt;name&gt;/</code>语法添加对反向引用的支持，那么可能会破坏已经使用该语法表示与<code class="eh kg kh ki kj b">/k&lt;name&gt;/</code>相同含义的网页。</p><p id="1e51" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">类似地，不能在断言上加量词，所以前视后跟星号将是错误的:<code class="eh kg kh ki kj b">/(?=foo)*/</code>。但是在附录B中我们发现，一些断言<em class="kk">是</em>允许的量词。附录B不适用于regexp Unicode模式，这是一种选择，所以<code class="eh kg kh ki kj b">/(?=(foo))?/u</code>是一个语法错误，而如果没有Unicode模式的<code class="eh kg kh ki kj b">/u</code>，它将是一个可选的lookahead，通过捕获的文本告诉您它是否匹配。这可能真的有用！你应该能够通过像这样在非捕获组中包装前瞻来重写，但是在Chromium中这是失败的。我提交了一个<a class="ae jp" href="https://bugs.chromium.org/p/v8/issues/detail?id=5845" rel="noopener ugc nofollow" target="_blank"> bug </a>来修复这个‘有价值的用例’。</p><p id="c895" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你在反斜杠后面加上数字，事情就变得很奇怪了。不看附件B，你能猜出这背后的规则吗？</p><p id="4fba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh kg kh ki kj b">/\1/ // Matches Unicode code point 1 aka Ctrl-A<br/>/()\1/ // Empty capture followed by a backreference to that capture<br/>/()\01/ // Empty capture followed by code point 1<br/>/\11/ // Match a tab character, which is code point 9!<br/>/\18/ // Match code point 1, followed by "8"<br/>/\176/ // Match a tilde, "~"<br/>/\400/ // Match a space followed by a zero</code></p><p id="c93e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你成功地从这些例子中逆向工程出规则了吗？</p><p id="2137" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">规则是将整个数字作为十进制反向引用数字，但是如果它有前导零或者超出范围(没有足够的捕获括号)，我们就放弃这种解释，转换数字基数，并将其重新解释为最多3位八进制转义255 (\377)，后面可能跟有文字数字。(在写这篇博文的时候，我提出了一个Safari bug ，因为这不是Safari的功能。)</p><p id="c67d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">每次我为此实现一个解析器时，我都确信我可以一次就解析它，但是每次，我都错了，不得不用两次通过的算法(第一次只是计算捕获数)。</p><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff ko"><img src="../Images/6bbb13b8368a9a10b95688cb6a171cb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zfy9_2Z4dxtROd9Th3ezFg.png"/></div></div><figcaption class="kc kd fg fe ff ke kf bd b be z ek">Apologies to <a class="ae jp" href="http://abstrusegoose.com/93" rel="noopener ugc nofollow" target="_blank">http://abstrusegoose.com/93</a></figcaption></figure><p id="6823" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">但是我们陷入严重的WTF-land的地方是<code class="eh kg kh ki kj b">\cx</code>语法。这代表control-X，意味着Unicode码位24，因为X是字母表中的第24个字母。到目前为止还很深奥，但是有人可能会发现它很有用。奇怪的是如果你不把a-to-z放在“c”后面会发生什么，比如<code class="eh kg kh ki kj b">/\c:/</code>。根据主要的JS规范，这应该抛出一个语法错误，但它并没有这样做。</p><p id="9d18" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它也可以只与<code class="eh kg kh ki kj b">"c:"</code>匹配，遵循附件B的规则和<code class="eh kg kh ki kj b">/\k/</code>树立的榜样。这也不是它的功能。</p><p id="c5f3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它可以匹配一些由冒号决定的随机控制字符，这在Safari上经常发生。这也不是它的功能。</p><p id="4c3d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh kg kh ki kj b">/\c:/</code>实际上匹配一个字面反斜杠，后跟<code class="eh kg kh ki kj b">"c:"</code>这使得它成为regexp解析器中唯一一个按字面解释单个反斜杠的地方。你会在所有现代浏览器中发现这种行为，并且有测试来确保它保持这种方式。</p><p id="f2ce" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我最新的(爱好)项目是<a class="ae jp" href="https://github.com/ErikCorryGoogle/grut" rel="noopener ugc nofollow" target="_blank"> Grut </a>，这是一个超前的正则表达式到机器代码的编译器，用Dart编写，使用LLVM完成所有繁重的工作。为了保持测试简单，我确保与其他regexp引擎兼容，主要是与Irregexp兼容，所以我重新实现了这些特性，完全兼容。奇怪的反斜杠c行为是其中的一部分。向后兼容性万岁！</p><div class="jr js jt ju fq ab cb"><figure class="kp jv kq kr ks kt ku paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="kp jv kq kr ks kt ku paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="kp jv kq kr ks kt ku paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="kv kw kx"><p id="f922" class="ir is kk it b iu iv iw ix iy iz ja jb ky jd je jf kz jh ji jj la jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is kk it b iu iv iw ix iy iz ja jb ky jd je jf kz jh ji jj la jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jr js jt ju fq jv fe ff paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="fe ff lb"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="jr js jt ju fq jv"><div class="bz el l di"><div class="lc ld l"/></div></figure></div></div>    
</body>
</html>