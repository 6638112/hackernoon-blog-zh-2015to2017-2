<html>
<head>
<title>Running a TensorFlow model on iOS and Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在iOS和Android上运行TensorFlow模型</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/running-a-tensorflow-model-on-ios-and-android-ce89446c8143?source=collection_archive---------5-----------------------#2017-09-06">https://medium.com/hackernoon/running-a-tensorflow-model-on-ios-and-android-ce89446c8143?source=collection_archive---------5-----------------------#2017-09-06</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="ee22" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">缩小模型大小并减少进行推理计算所需的计算资源</h2></div><figure class="jj jk jl jm fq jn"><div class="bz el l di"><div class="jo jp l"/></div></figure><p id="8103" class="pw-post-body-paragraph jq jr hu js b jt ju iv jv jw jx iy jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">如果你对在手机上运行机器学习模型感兴趣，这里有一个快速指南，告诉你如何做到这一点，以及在这个过程中你会面临的一些挑战。</p><p id="8d16" class="pw-post-body-paragraph jq jr hu js b jt ju iv jv jw jx iy jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">谷歌的Inception模型相当庞大(按照移动标准)，它大约是90 MB。该模型如此庞大的一个原因是，它将权重存储为32位浮点型。这在训练阶段是非常必要的，可以对重量进行许多微小的改变。但是在训练完成后，切换到8位定点不会对精度产生巨大影响。</p><p id="24a9" class="pw-post-body-paragraph jq jr hu js b jt ju iv jv jw jx iy jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">这就是量化的用武之地，我们量化我们的模型来缩小它的大小，并减少进行推理计算所需的计算资源。将计算转移到8位将帮助您更快地运行模型，并使用更少的功率。</p><figure class="jj jk jl jm fq jn"><div class="bz el l di"><div class="km jp l"/></div><figcaption class="kn ko fg fe ff kp kq bd b be z ek">The retrained model running on iPhone</figcaption></figure></div><div class="ab cl kr ks hc kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hn ho hp hq hr"><p id="9d92" class="pw-post-body-paragraph jq jr hu js b jt ju iv jv jw jx iy jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">在<a class="ae ky" rel="noopener" href="/@lesterlitchfield/real-time-image-recognition-onboard-ios-475746fbaaaa"> Lester的帖子</a>中，他写了他如何重新训练谷歌的Inception V3模型，以便我们可以根据<a class="ae ky" href="https://www.trademe.co.nz/" rel="noopener ugc nofollow" target="_blank"> Trade Me </a>列表图像对图像进行分类。在这篇文章中，我将讲述我是如何在iOS和Android手机上运行Lester直接训练的模型的。</p></div><div class="ab cl kr ks hc kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hn ho hp hq hr"><p id="b953" class="pw-post-body-paragraph jq jr hu js b jt ju iv jv jw jx iy jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">好了，现在我有了重新训练过的盗梦空间模型，我做的第一件事就是用TensorBoard检查这个模型，感受一下它有多复杂！并找出输入和输出层的名称。我通过运行以下命令做到了这一点</p><pre class="jj jk jl jm fq kz la lb lc aw ld dt"><span id="56b4" class="le lf hu la b fv lg lh l li lj">python tensorflow/python/tools/import_pb_to_tensorboard.py --model_dir <strong class="la hv">tmp/tensorflow_inception_graph.pb</strong> --log_dir <strong class="la hv">tmp/</strong></span><span id="f26e" class="le lf hu la b fv lk lh l li lj">tensorboard --logdir=<strong class="la hv">tmp/</strong></span></pre><p id="9905" class="pw-post-body-paragraph jq jr hu js b jt ju iv jv jw jx iy jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">然后去<a class="ae ky" href="http://mac.local:6006" rel="noopener ugc nofollow" target="_blank"> http://mac.local:6006 </a>你可以查看模型层</p><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="fe ff ll"><img src="../Images/d040a5c5034194f75382fc96bcc6fe84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bz7yfqUkUp_65hGczjzjhQ.png"/></div></div><figcaption class="kn ko fg fe ff kp kq bd b be z ek">output layer</figcaption></figure><figure class="jj jk jl jm fq jn fe ff paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="fe ff ll"><img src="../Images/4b30b70adb9b3b8e9add7eaec3986d9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kz2s_olJbGwBAJILvltdzA.png"/></div></div><figcaption class="kn ko fg fe ff kp kq bd b be z ek">input layer</figcaption></figure></div><div class="ab cl kr ks hc kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hn ho hp hq hr"><p id="73b1" class="pw-post-body-paragraph jq jr hu js b jt ju iv jv jw jx iy jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">之后，剥离模型就像运行下面的命令一样简单</p><pre class="jj jk jl jm fq kz la lb lc aw ld dt"><span id="406e" class="le lf hu la b fv lg lh l li lj">bazel-bin/tensorflow/tools/graph_transforms/transform_graph \<br/> —-inputs=”<strong class="la hv">input_1</strong>" —-in_graph=<strong class="la hv">tmp/tensorflow_inception_graph.pb</strong> \<br/> —-outputs=”<strong class="la hv">output_node0</strong>" —-out_graph=<strong class="la hv">tmp/quantized_graph.pb</strong> \<br/> —-transforms=’add_default_attributes strip_unused_nodes(type=float, shape=”1,<strong class="la hv">299</strong>,<strong class="la hv">299</strong>,<strong class="la hv">3</strong>") remove_nodes(op=Identity, op=CheckNumerics) fold_constants(ignore_errors=true) fold_batch_norms fold_old_batch_norms quantize_weights strip_unused_nodes sort_by_execution_order’</span></pre></div><div class="ab cl kr ks hc kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hn ho hp hq hr"><p id="e1a3" class="pw-post-body-paragraph jq jr hu js b jt ju iv jv jw jx iy jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">现在我们已经有了量化的图形，要在iOS 上运行它，我们可以替换<a class="ae ky" href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/examples/ios/camera/data" rel="noopener ugc nofollow" target="_blank">https://github . com/tensor flow/tensor flow/tree/master/tensor flow/examples/iOS/camera/data</a>中的图形。不要忘记添加标签文本文件。</p><p id="ac09" class="pw-post-body-paragraph jq jr hu js b jt ju iv jv jw jx iy jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">您需要做的最后一个更改是更改<a class="ae ky" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/ios/camera/CameraExampleViewController.mm#L38" rel="noopener ugc nofollow" target="_blank">https://github . com/tensor flow/tensor flow/blob/master/tensor flow/examples/IOs/camera/camera/cameraexampleviewcontroller . mm # L38</a>中的字段，以匹配您的模型期望的输入。</p><p id="9614" class="pw-post-body-paragraph jq jr hu js b jt ju iv jv jw jx iy jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">在我们的案例中是这样的</p><pre class="jj jk jl jm fq kz la lb lc aw ld dt"><span id="3c58" class="le lf hu la b fv lg lh l li lj">const int wanted_input_width = 299;</span><span id="addf" class="le lf hu la b fv lk lh l li lj">const int wanted_input_height = 299;</span><span id="d7f1" class="le lf hu la b fv lk lh l li lj">const int wanted_input_channels = 3;</span><span id="97c4" class="le lf hu la b fv lk lh l li lj">const float input_mean = 0.0f;</span><span id="a260" class="le lf hu la b fv lk lh l li lj">const float input_std = 255.0f;</span><span id="9d7b" class="le lf hu la b fv lk lh l li lj">const std::string input_layer_name = "input_1";</span><span id="707b" class="le lf hu la b fv lk lh l li lj">const std::string output_layer_name = "output_node0";</span></pre><p id="a0ec" class="pw-post-body-paragraph jq jr hu js b jt ju iv jv jw jx iy jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated"><strong class="js hv">在Android上运行</strong>也很相似，在那里添加你的量化图和标签<a class="ae ky" href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/examples/android/assets" rel="noopener ugc nofollow" target="_blank">https://github . com/tensor flow/tensor flow/tree/master/tensor flow/examples/Android/assets</a>。并更新<a class="ae ky" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/android/src/org/tensorflow/demo/ClassifierActivity.java#L61" rel="noopener ugc nofollow" target="_blank">https://github . com/tensor flow/tensor flow/blob/master/tensor flow/examples/Android/src/org/tensor flow/demo/classifier activity . Java # L61</a>中的行，以匹配您的输入所期望的内容。</p></div><div class="ab cl kr ks hc kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hn ho hp hq hr"><p id="0b3a" class="pw-post-body-paragraph jq jr hu js b jt ju iv jv jw jx iy jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">在接下来的一篇文章中，我将介绍如何将上一步的量化图嵌入到现有的iOS和Android应用中。</p></div><div class="ab cl kr ks hc kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hn ho hp hq hr"><p id="4f4f" class="pw-post-body-paragraph jq jr hu js b jt ju iv jv jw jx iy jy jz ka kb kc kd ke kf kg kh ki kj kk kl hn dt translated">你有兴趣进一步了解这款<a class="ae ky" href="https://leanpub.com/ml-mobile" rel="noopener ugc nofollow" target="_blank">https://leanpub.com/ml-mobile</a>吗</p></div></div>    
</body>
</html>