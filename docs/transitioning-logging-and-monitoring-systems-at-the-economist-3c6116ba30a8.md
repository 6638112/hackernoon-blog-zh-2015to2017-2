# 《经济学人》的过渡日志和监控系统

> 原文：<https://medium.com/hackernoon/transitioning-logging-and-monitoring-systems-at-the-economist-3c6116ba30a8>

在《经济学人》,从单一的遗留系统过渡到分布式的基于微服务的架构需要我们作为一个数字团队的工作方式发生根本性的转变。虽然我们全力投入到激动人心且充满挑战的技术转型过程中，但我们的日志记录和监控方法却跟不上。我们很快发现了无法将日志记录实践从单一的集成系统转换到分布式系统的痛点:

*   来自不同应用程序的日志具有不同的模式或者根本没有模式
*   容器化创建了运行在同一服务器上的多个应用程序
*   实例扩展或重新生成时的动态主机 IP
*   不容易通过分布式应用程序和服务跟踪 HTTP 请求

停留在简单地将系统日志发送到一个聚合工具的单一方法中，我们的可见性工具的可用性迅速下降。因此，经济学家数字团队往往无法确定系统故障的原因，从而影响了对业务关键问题的响应和解决时间。总体影响是我们的系统缺乏透明度，并降低了对其大规模运行能力的信心。

**解决方案**

在对眼盯着杂乱的原木之后，是时候改变一下了。一个小的、基层的计划从开发团队开始，与架构师和产品所有者一起工作，以了解每个团队当前的日志记录情况和最大的痛点。这些讨论激发了日志记录标准和格式指南的创建，确保所有应用程序都使用结构化日志记录。主要要求包括:

*   所有日志都是 JSON 格式的结构，带有键值对
*   在查询工具中使用日志级别来控制发送给聚合器和过滤器的内容
*   跟踪 ID 的实现，在系统事件开始时生成，并传递给所有后续调用和子例程
*   具有一致命名的必填字段，如服务、毫秒、主机和消息

根据应用程序类型记录了其他必填字段，例如客户端应用程序的请求方法和状态。在日志库中实现标准的具体建议包括:

*   审查现有的特定语言库
*   用于日志初始化和跟踪 ID 生成的中间件
*   用于生成唯一跟踪 ID 的 SHA1/base 32 编码方法
*   使用上下文向子例程和请求传递跟踪 id

这些标准在团队中传阅，直到达成共识，此时，我们有了一个漂亮的文档。

**实际解决方案**

虽然就一个标准达成一致不是一个无关紧要的里程碑，但是一旦达成，就该开始工作了。由于这项工作涉及数字解决方案的每个团队，而不是特定于任何一个产品或项目，因此协调所有[工程](https://hackernoon.com/tagged/engineering)团队的实施非常重要。一个让开发人员在一个放着咖啡和糖的房间里呆几天的即兴建议很快演变成了一个关于专注于日志和监控的黑客马拉松的提议。

为了加快应用日志标准的过程并确保一致性,《经济学人》主办了一场日志和监控黑客马拉松，参与者来自每个数字团队。目标是实现新的日志记录标准，并使用日志记录格式开发仪表板和警报。黑客马拉松将确保每个团队都有一名参与者，他们可以学习新的标准并与他们的团队分享。

**第一天:火种**

黑客马拉松的第一天优先考虑在我们的平台上实现日志标准。上午开始时，我们概述了新的标准和日志库应该如何设计的建议。然后，每个团队被提示花大约一个小时的时间为他们的系统进行日志设计，检查哪些特定的挑战，如移动和第三方应用程序，需要更多的定制解决方案。当团队分享他们的初始设计时，我们确定了关键的协作领域，如数据加密和安全，并围绕集中还是分散格式化进行了激烈的讨论。随着时间的推移，团队专注于他们的具体实施挑战，包括:

*   什么样的库实现能最好地为开发人员提供无处不在的日志记录和易用性
*   抽象日志格式以供不同的应用程序重用
*   无服务器框架的轻量级解决方案

当太阳落山，咖啡壶倒空的时候，PRs 就发布了，标准化伐木的种子就种下了。

**第二天:木材！**

随着标准化日志的开始，第 2 天制定了监控要求的策略。目标是根据[谷歌 SRE 建议](https://landing.google.com/sre/book/chapters/monitoring-distributed-systems.html)定义理解系统延迟、流量、错误和饱和度的关键方法。基础设施团队的成员加入进来，就如何配置不同类型的监控工具提供反馈和建议。将开发人员和基础设施聚集在一起关注全局是团队讨论新想法和辩论不同警报和仪表板优点的机会。“一个月后，真的会有人看这个仪表板吗？”以及“我会收到太多电子邮件提醒，以至于开始忽略它们吗？”在我们讨论理解整个系统健康的方法时出现。这些问题没有明显的答案。更确切地说，开发人员和 [devops](https://hackernoon.com/tagged/devops) 一起合作构建解决方案，平衡可视化、仪表板和警报，与系统稳定性的最关键元素保持一致。例如，构建了一个电子邮件警报来响应 HTTP 错误响应的突然高峰，同时推荐了一个简单的绿-红指示板来快速查看部署状态。

随着一天的结束，是时候让团队展示他们的进展了。与会者简要介绍了他们的工作和推进工作的计划。点了披萨和啤酒，办公室的其他人被邀请观看并参与提问或提出建议。在最热烈的掌声中，一名获胜者被选中，并穿着《经济学人》的 t 恤加冕为伐木和监测君主。

**关键要点**

工作仍在继续。记录和监控是迭代过程，团队应将记录和监控审查作为常规维护和性能工作一部分。这对于确保记录和分析相关信息至关重要。在黑客马拉松结束时，每个团队都留下了日志记录和监控的策略，以及待办事项列表中的故事，或者定义了推进工作的后续步骤。参与者还安排时间向他们的团队展示他们的工作。因此，虽然工作永远不会结束，但黑客马拉松奠定了基础，并为我们的日志记录和监控的发展建立了一个共同的愿景。更重要的是，它将开发人员聚集在一起，分享想法，互相学习，也许，仅仅是也许，爱上标准化日志记录。