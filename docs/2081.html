<html>
<head>
<title>A Web Service Written in Pure Bash.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用纯Bash编写的Web服务。</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/a-web-service-written-in-pure-bash-2af847902df1?source=collection_archive---------1-----------------------#2017-01-05">https://medium.com/hackernoon/a-web-service-written-in-pure-bash-2af847902df1?source=collection_archive---------1-----------------------#2017-01-05</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="d716" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">现在是啤酒点了吗？</h2></div><p id="c91f" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">在<a class="ae kf" href="http://twitter.com/carrot" rel="noopener ugc nofollow" target="_blank">@胡萝卜</a>我们使用Go和Node构建了许多API，其中一些托管在DigitalOcean上，并利用了Docker容器，但我们也使用了<a class="ae kf" href="https://hackernoon.com/tagged/amazon" rel="noopener ugc nofollow" target="_blank">亚马逊</a>堆栈，如Lambda、S3和Cloudfront with Apex&amp;server less。我们有很多工具可以帮助我们启动项目，比如开发静态网站时的<a class="ae kf" href="https://github.com/static-dev/spike" rel="noopener ugc nofollow" target="_blank"> Spike </a>或者在<a class="ae kf" href="https://hackernoon.com/tagged/github" rel="noopener ugc nofollow" target="_blank"> Github </a>上建立仓库时的<a class="ae kf" href="https://github.com/carrot/ash-github" rel="noopener ugc nofollow" target="_blank"> ash-github </a>。在开发ash-github的时候，我开玩笑说所有的东西都应该用bash编写。我和我的同事越是开玩笑，这个想法就越是在我的脑海中成长，很快这个想法就实现了。</p><h2 id="4c29" class="kg kh hu bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la dt translated">泥土</h2><p id="c8cc" class="pw-post-body-paragraph jj jk hu jl b jm lb iv jo jp lc iy jr js ld ju jv jw le jy jz ka lf kc kd ke hn dt translated">这项服务目前运行在DigitalOcean的Ubuntu 16.10 droplet上。为了暴露我的服务，我需要打开一个与外界的连接，并且最初使用netcat，因为它预装在大多数*nix机器上。这个任务对我来说一点也不熟悉，但是我无法读取传入的请求，也无法处理两个用户同时连接。我研究了inetd，除了手册页之外，它缺少文档。继续我的研究，我发现<a class="ae kf" href="https://github.com/xinetd-org/xinetd" rel="noopener ugc nofollow" target="_blank"> xinetd </a>是inetd的一个更安全的版本。我还找到了更多关于创建服务的文档和用户指南。安装xinetd后，我开始构建我的纯bash服务的原始版本，名为beeroclock。</p><figure class="lh li lj lk fq ll fe ff paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="fe ff lg"><img src="../Images/38d2bb3d90e02c1127531a6dfcf62e37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BjfbUgYTSEfvWHADL0BZbg.png"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek">xinetd man page</figcaption></figure><h2 id="e2ee" class="kg kh hu bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la dt translated">代码消化</h2><p id="70ef" class="pw-post-body-paragraph jj jk hu jl b jm lb iv jo jp lc iy jr js ld ju jv jw le jy jz ka lf kc kd ke hn dt translated">当发出请求时，它被消费，头被解析，直到我们找到一个回车，表明我们已经到达了主体，然后正确地将每一部分分配给一个变量。在这种情况下，我们只关心GET请求和路径名是否正确。该服务响应两个路径和一个查询参数。</p><blockquote class="lw lx ly"><p id="8090" class="jj jk lz jl b jm jn iv jo jp jq iy jr ma jt ju jv mb jx jy jz mc kb kc kd ke hn dt translated">#基于路由的响应<br/>/ock—text/plain<br/>/ock . html—text/html<br/>/ock . JSON—application/JSON</p><p id="7ce5" class="jj jk lz jl b jm jn iv jo jp jq iy jr ma jt ju jv mb jx jy jz mc kb kc kd ke hn dt translated">#基于查询参数的响应<br/> /ock？type=plain — text/plain <br/> /ock？type=html — text/html <br/> /ock？type=json —应用程序/json</p><p id="fa97" class="jj jk lz jl b jm jn iv jo jp jq iy jr ma jt ju jv mb jx jy jz mc kb kc kd ke hn dt translated"># favicon <br/> /favicon —啤酒表情符号<br/> /favicon.ico —啤酒表情符号</p></blockquote><p id="f4df" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">如果您请求上面列出的路线之外的任何路线，您将被重定向到/ock。您还会看到有三种内容类型:文本/普通文本、文本/html和应用程序/json。路由和查询参数消费的逻辑最初很简单，纯粹使用正则表达式，尽管响应时间很慢。我为正则表达式和条件创建了一个性能脚本，并在本地和服务器上进行了测试。if/else条件语句比正则表达式快大约52.7%，这是一个显著的差异！因此，我使用条件进行了重构，但遗憾的是，在请求时间上只有100-200毫秒的差异，没有明显的性能提升。</p><figure class="lh li lj lk fq ll fe ff paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="fe ff md"><img src="../Images/43bb091c41112e802351f6e66202be36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CjRaDtxR90tRpwUZRACZ9g.png"/></div></div><figcaption class="ls lt fg fe ff lu lv bd b be z ek"><a class="ae kf" href="https://gist.github.com/hhsnopek/c89c578cde44f09613859a44b1aca8e2" rel="noopener ugc nofollow" target="_blank">Bash Performance Test — Regex vs If/Else</a></figcaption></figure><p id="1d8b" class="pw-post-body-paragraph jj jk hu jl b jm jn iv jo jp jq iy jr js jt ju jv jw jx jy jz ka kb kc kd ke hn dt translated">响应本身是使用一些函数构造的，其中一些是:beertime和response。beertime函数处理时间计算和要在正文中使用的消息。后者构造并回复适当的响应，同时只使用两个参数:content-type &amp; body。为了计算您的时区，当然是为了正确地消费啤酒，我向一个单独的服务发送了一个请求，该服务包含请求者的IP地址，该地址以您的时区作为响应。然后，我在执行beertime时生成的子shell中设置环境变量TZ。beertime的输出由另一个名为respond的函数使用，该函数设置标头并将整个响应回显到客户机。</p><h2 id="3077" class="kg kh hu bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la dt translated">概括一下…</h2><p id="80a3" class="pw-post-body-paragraph jj jk hu jl b jm lb iv jo jp lc iy jr js ld ju jv jw le jy jz ka lf kc kd ke hn dt translated">Bash可能仍然是一种脚本语言，但是像任何语言一样，我们应该探索并找到方法来弯曲它，直到它崩溃。我真的很喜欢建造beeroclock，并且总是喜欢问我的同事现在几点了。源代码可以在这里找到<a class="ae kf" href="https://github.com/hhsnopek/beeroclock" rel="noopener ugc nofollow" target="_blank"> hhsnopek/beeroclock </a>并且我欢迎贡献来改善这个项目——干杯！</p><figure class="lh li lj lk fq ll fe ff paragraph-image"><div class="fe ff me"><img src="../Images/bf2bd7b474182550b99930f73b0c6bc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:128/format:webp/1*l1ZOLZGu4ccHiYb4UCydYQ.png"/></div></figure><div class="lh li lj lk fq ab cb"><figure class="mf ll mg mh mi mj mk paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mf ll mg mh mi mj mk paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mf ll mg mh mi mj mk paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="lw lx ly"><p id="f922" class="jj jk lz jl b jm jn iv jo jp jq iy jr ma jt ju jv mb jx jy jz mc kb kc kd ke hn dt translated"><a class="ae kf" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae kf" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae kf" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae kf" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jj jk lz jl b jm jn iv jo jp jq iy jr ma jt ju jv mb jx jy jz mc kb kc kd ke hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kf" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kf" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lh li lj lk fq ll fe ff paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="fe ff ml"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="lh li lj lk fq ll"><div class="bz el l di"><div class="mm mn l"/></div></figure></div></div>    
</body>
</html>