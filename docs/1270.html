<html>
<head>
<title>Reverse engineering visual novels 101, part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">逆向工程视觉小说101，第2部分</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/reverse-engineering-visual-novels-101-part-2-9258f547262a?source=collection_archive---------1-----------------------#2016-10-04">https://medium.com/hackernoon/reverse-engineering-visual-novels-101-part-2-9258f547262a?source=collection_archive---------1-----------------------#2016-10-04</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/5c9dd1ae28f2d19bc548b1b182670bf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CCH2EIavTEjZFJcdFHpOmw.png"/></div></div></figure><p id="bc8c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">嘿，距离我的上一篇帖子已经有一段时间了<a class="ae ka" rel="noopener" href="/@mnakamura1337/reverse-engineering-visual-novels-101-d0bc3bf7ab8">，所以我想快速提醒一下这里发生了什么会有所帮助。我们在涉足逆向工程，视觉小说是我们的目标。在本文的第一部分中，我们已经学会了使用神奇的</a><a class="ae ka" href="http://kaitai.io/" rel="noopener ugc nofollow" target="_blank">开泰结构工具</a>来分析容器格式，这使得对计算机略知一二的每个人都可以很容易地尝试适当的“干净的房间”逆向工程，而无需深入了解CPU、寄存器、反汇编等。</p><p id="861c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们的主要目标仍然是<a class="ae ka" href="https://vndb.org/v13353" rel="noopener ugc nofollow" target="_blank"> Koisuru Shimai no Rokujuso </a>，一部不太出名，但仍然制作精良的皮斯软件视觉小说。上次我们发现它使用了一个可能叫做“优香”的引擎。我们已成功从提取游戏文件。ykc容器，我们得到了视觉、声音和音乐，但是最后的挑战还在等待着我们:<em class="kb">剧本</em>。</p><h1 id="8ad5" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">关于小说内部的思考</h1><p id="0979" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">在深入二进制转储之前，让我们花点时间来思考一下大多数视觉小说引擎是如何工作的。视觉小说由文本(对话、叙述)、视觉和声音组成。为了让这一切走到一起，需要某种控制程序。从技术上来说，把它作为机器码塞进。但是在99%的情况下(好吧，我在撒谎——在我亲眼所见的100%的情况下)引擎作者不会这样做。相反，这些控制指令作为一个单独的文件保存在某种特定于领域的脚本语言中。这就是他们普遍所说的<strong class="je hv">【剧本】</strong>。让我们来看看它可能是什么样子:</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="03b3" class="lo kd hu lk b fv lp lq l lr ls">$ tarot = 0<br/>$ memory = 0</span><span id="b4c0" class="lo kd hu lk b fv lt lq l lr ls">scene bg01_1 with dissolve</span><span id="98ff" class="lo kd hu lk b fv lt lq l lr ls">play music "bgm/8.mp3" fadein (2.0)<br/>play ambience "amb/forest.mp3" fadein (3.0)<br/>"Morning."<br/>"Not my favourite time of the day."<br/>"The morning is when you’re not awake enough to do anything…"</span></pre><p id="fad1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是一个使用<a class="ae ka" href="https://www.renpy.org/" rel="noopener ugc nofollow" target="_blank"> Ren'Py </a>的VNs的一小段脚本源代码——这是最著名的免费啤酒&amp;免费语音引擎之一。抛开使用《任的Py》本身是好是坏的问题不谈，让我们只调查一下《视觉小说》剧本的典型特征(这正是我们要寻找的):</p><ul class=""><li id="264e" class="lu lv hu je b jf jg jj jk jn lw jr lx jv ly jz lz ma mb mc dt translated"><strong class="je hv">文本</strong> —它可能是叙述(即不是由角色讲述，而是由讲述者讲述的故事的一部分)或一些对白(属于某个角色)</li><li id="ed9e" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">处理<strong class="je hv">视觉效果</strong>的命令——背景/精灵(` scene bg01_1`) /角色图形/事件图形，有时用一些视觉效果(` with dissolve `)增强它们</li><li id="0602" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">播放<strong class="je hv">音乐或声音效果</strong>的命令(“播放音乐”、“播放氛围”)，有时还会出现一些额外的参数，最常见的是淡入和淡出的持续时间(即缓慢逐渐增加或降低音量)</li><li id="3f2d" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">处理<strong class="je hv">变量</strong>:设置(` $ tarot = 0 `)、获取、检查条件和分支</li><li id="7364" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">一些额外的东西，比如回放由某些字符发音的<strong class="je hv">语音文件</strong>、<strong class="je hv">流量控制</strong>和各种服务功能，比如<strong class="je hv">评论、标签、宏</strong>等</li></ul><p id="40cb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当然，在现实世界中，大多数时候我们无法访问脚本的源代码——那太容易了。自从人们学会创建编译器(而不是解释器)以来，可能已经有半个世纪了，所以现在源代码很可能被编译成可执行字节码，然后由VN引擎使用某种简单(或不那么简单)的虚拟机来执行。有时候你会很幸运——对于一些流行的引擎，你可以得到一个现成的工具集——编译器、反编译器、调试器、脚本验证器等等。—但大多数时候生活并不那么方便。</p><p id="be60" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们回到我们在上一篇文章中开始剖析的视觉小说上来。在打开它的档案后，我们在里面发现了图像、声音、音乐文件和迄今为止最神秘的艺术品——一些带有。yks扩展。据推测，这是小说的脚本所在(记住，引擎可能被称为优香，所以它是YKS =<strong class="je hv">Y</strong>u<strong class="je hv">K</strong>a<strong class="je hv">S</strong>script)。准确地说，不仅仅是一个剧本，而是有好几个:</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="5a70" class="lo kd hu lk b fv lp lq l lr ls">YKS/ScriptStart.yks<br/>YKS/trial/Yoyaku.yks<br/>YKS/trial/trial_00100.yks<br/>YKS/trial/trial_00200.yks<br/>YKS/all/all_00010.yks<br/>…<br/>YKS/all/all_02320.yks</span></pre><p id="05bd" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这使得我们在YKS/all/中总共有103个文件。让我提醒你，我们已经下载了试用版——但是，看起来开发者有点懒，没有适当地抓取完整的游戏内容，我们已经有了试用版的试用脚本和完整的游戏脚本。</p><p id="c3ed" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">从我的经验来看，视觉小说作者倾向于走两种方式之一:要么将每个脚本打包成一个大文件，要么为游戏中的每个场景/事件制作大量文件。看来我们面对的是后者。顺便说一句，请注意还有一个独特的“ScriptStart.yks”，但它可能不会像其他文件那样让我们感兴趣。你看，引擎开发人员经常希望他们的引擎尽可能通用，并选择使用引擎本身来实现UI、保存/加载、CG图库、菜单、选项屏幕等元素。当然也有可能拆开所有这些东西，但是(1)这肯定不是最好的开始，因为它缺少任何文本或其他视觉提示，(2)它对我们的目的来说没那么有趣。因此，我建议先从更合理的脚本开始。</p><h1 id="c205" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">我的马提尼呢，摇过的，没搅拌过的？</h1><p id="953c" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">就像我们之前的文章一样，我们先从基本智力开始。所以，准备好你的阿斯顿马丁，让我们侦察一下周围的环境。</p><p id="0ce0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先，这是一个Windows游戏，所以这是一个非常可行的想法，只要找到一些Windows盒子，运行它，看看会发生什么。这是我们点击主菜单中的“开始新游戏”按钮后得到的结果:</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/01f0e55b78580a3b143d4ba6fa9d3486.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L1to8cjr3XRvGlJ3CHlYsQ.png"/></div></div><figcaption class="mi mj fg fe ff mk ml bd b be z ek">The very first text that one encounters in the visual novel.</figcaption></figure><p id="72d8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">故事的开头迎接了我们。我们在这里得到了一个背景(半分钟的搜索显示它是来自BG/ directory的“bg01_01.png”)，并且我们得到了一些文本。开始搜索文本通常是一个非常好的主意，所以让我们从屏幕上重新键入文本:</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="9688" class="lo kd hu lk b fv lp lq l lr ls">恋する姉妹の六重奏「セクステット」体験版Ver2をダウンロード頂きありがとうございます。</span></pre><p id="7eb2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你打日语有任何问题(我敢打赌，至少你们中的一些人完全不知道从哪里开始)，这里有一个快速入门，告诉你如何通过几个简单的步骤努力做到这一点。</p><h1 id="2269" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">在一无所知的情况下在你的电脑上输入日语</h1><p id="37ef" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">如您所见，日语文本由单个字符组成(通常适合一个正方形)，因此我们一个接一个地处理它们:</p><ul class=""><li id="9ac1" class="lu lv hu je b jf jg jj jk jn lw jr lx jv ly jz lz ma mb mc dt translated">首先使用下面一行检查它是否是标点符号:</li></ul><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="6da4" class="lo kd hu lk b fv lp lq l lr ls">「…」、（）。</span></pre><p id="5382" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你运气好，就复制粘贴它。注意，日语的“逗号”、“句号”和“括号”都是特殊的。</p><ul class=""><li id="dedf" class="lu lv hu je b jf jg jj jk jn lw jr lx jv ly jz lz ma mb mc dt translated">如果这不是标点符号，请在这行中查找字符:</li></ul><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="0b2e" class="lo kd hu lk b fv lp lq l lr ls">あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわを</span></pre><ul class=""><li id="3847" class="lu lv hu je b jf jg jj jk jn lw jr lx jv ly jz lz ma mb mc dt translated">然后这一行:</li></ul><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="ab2a" class="lo kd hu lk b fv lp lq l lr ls">アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワ</span></pre><ul class=""><li id="72b5" class="lu lv hu je b jf jg jj jk jn lw jr lx jv ly jz lz ma mb mc dt">still no luck? for example, you’ve got 恋 — then we’re doomed, it’s kanji; zoom your font up to 300–500% to make the details clearer and got to <a class="ae ka" href="http://jisho.org/#radical" rel="noopener ugc nofollow" target="_blank">jisho.org, “search by radical” section</a>; once there, look closely at the table of the elements that form kanji characters (these are called “radicals”) and look for the parts that look like parts of the kanji; taking 恋 as an example — a quick mediation reveals that bottom part of this character is 心 — pressing down this radical shortens a list of possible kanji to browse dramatically — it’s no longer multiple thousands, but a few dozen; browsing through them, we’re bound to find fifth character in “10” section — that would be the 恋 we’re looking for;</li></ul><p id="8810" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当然，这可能很费时间，但总比什么都没有强。另一种半作弊的方法是去<a class="ae ka" href="http://translate.google.com/" rel="noopener ugc nofollow" target="_blank"> Google Translate </a>，在那里转日文输入，切换到“绘图”模式，试着把看到的东西画出来。在80%的情况下，你会很幸运地马上得到你的汉字。在另外的20%中，像jisho.org那样在字典中查找汉字是一个非常简单的方法。</p><p id="37de" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我想指出的另一点是，我不确定这是“Ver2”还是“Ver2”，请注意，我在这里使用的不是不同的字体，而是所谓的“全角字符”，这是完全不同的字符，在U+FF01附近的Unicode中可以找到..U+FF5E —显然，如果我们在比较二进制表示，我们需要精确。</p><p id="7739" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们复制的文本将在两个方面帮助我们。首先我们可以翻译一下，了解一下是怎么回事。即使你不懂日语，你也可以把它插入谷歌翻译或其他自动翻译软件，得到一个粗略的想法。所以，实际上，这并不是故事的开头。作者感谢我们下载试用版，所以它不是“第一章”，而是某种序言，一些作者的话。第二，我们可以使用这一行，将其编码为ShiftJIS(正如我们在上一篇文章中指出的，这个引擎内部很有可能都使用ShiftJIS ),并为其寻找文件。让我们取其中的一部分进行编码:</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="2e50" class="lo kd hu lk b fv lp lq l lr ls">$ echo ‘ダウンロード頂きありがとうございます’ | iconv -t sjis | hd<br/>00000000 83 5f 83 45 83 93 83 8d 81 5b 83 68 92 b8 82 ab<br/>00000010 82 a0 82 e8 82 aa 82 c6 82 a4 82 b2 82 b4 82 a2<br/>00000020 82 dc 82 b7</span></pre><p id="c658" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是我们需要在所有文件中寻找的十六进制字符串。唉，我们失败了。生活不会那么容易。</p><h1 id="4c92" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">它是如何工作的</h1><p id="a905" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">是时候对日本的PC文化进行一次新的探索了，让我们熟悉一下ShiftJIS编码。他们说日本的汉字和天上的星星一样多。我不知道是不是这样，但很难说至少日语中的字符比英语中的字符多得多。因此，用1个字节来编码它们(有256个可能的值)几乎是不可行的。因此，ShiftJIS至少使用1个字节，最多使用2个字节。从这个表中可以看到<a class="ae ka" href="http://www.kreativekorp.com/charset/encoding.php?name=Shift-JIS" rel="noopener ugc nofollow" target="_blank">，字节值为00..7F等于ASCII(从而使ShiftJIS与ASCII兼容)，字节值为81..9F和E0..EA意味着它是一个2字节组合。注意，再次为了ASCII兼容性，第二个字节</a><a class="ae ka" href="http://www.kreativekorp.com/charset/encoding.php?name=Shift-JIS&amp;char=82" rel="noopener ugc nofollow" target="_blank">不是任意的</a>，而是可以在40和FF之间。</p><h2 id="0299" class="lo kd hu bd ke mm mn mo ki mp mq mr km jn ms mt kq jr mu mv ku jv mw mx ky my dt translated">最短的日语速成班</h2><p id="4650" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">看来我们逃不掉又一次对日语基础知识的钻研了。所以，说白了，日语使用三组符号:</p><ul class=""><li id="a58f" class="lu lv hu je b jf jg jj jk jn lw jr lx jv ly jz lz ma mb mc dt translated"><strong class="je hv">平假名</strong> —看起来有点像ありがとうございます——即简单的圆形草书形状；~50字形，但有少数类似“大i = い，小i = ぃ”的变体；1个音节= 1个字形。</li><li id="b375" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">片假名——看起来像ダウンロード——也就是像正方形一样的直线，对排版非常有用；它与平假名对应相同的声音，但主要用于记下外来词(ダウンロード = da-u-n-lo:-do =下载)。</li><li id="5451" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt"><strong class="je hv">kanji</strong> — look something like 体験版 — i.e. complex drawings with lots of elements, fit into square shape; most of the time it’s kanji that give the most pain for Japanese language learners, and it’s many thousands of them.</li></ul><p id="3c6f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">此外，还有一些其他符号，如标点符号。为了我们的目的(尽管适当的日本学者会因为这样的虚伪而杀了我)，让我们说它们大部分等同于欧洲语言。有:</p><ul class=""><li id="a45d" class="lu lv hu je b jf jg jj jk jn lw jr lx jv ly jz lz ma mb mc dt translated">一个“句号”——句号.</li><li id="932c" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">一个“时期”，</li><li id="1c89" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">省略号— …</li><li id="57f9" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">报价—とと</li><li id="c572" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">全角问号—？</li><li id="3905" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">全角感叹号——！</li><li id="e790" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">和一些其他不常用的符号</li></ul><p id="1f5f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt">But there’s a catch, as you might have seen: there are no spaces in Japanese. The trick is simple: in Japanese text you have “significant” words (which are written with a mix of kanji and hiragana) and participles, which are always written in hiragana. This way, one can detect start of the words by changing of script. Let’s take the name of our game as an example: 恋する姉妹の六重奏</p><ul class=""><li id="30c6" class="lu lv hu je b jf jg jj jk jn lw jr lx jv ly jz lz ma mb mc dt">恋 — kanji</li><li id="b9c0" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">する —平假名</li><li id="4e79" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt">姉妹 — kanji</li><li id="932d" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">の —平假名</li><li id="46ef" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt">六重奏 — kanji</li></ul></div><div class="ab cl mz na hc nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="hn ho hp hq hr"><p id="c097" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">好吧，那我们要怎么处理这些东西？知道这一点对发现混淆的日语很有帮助。首先，让我们做一件非常简单的事情:频率统计。以任何一部日本小说的完整的现成脚本(例如，在<a class="ae ka" href="https://tlwiki.org/" rel="noopener ugc nofollow" target="_blank"> tlwiki </a>有几个可以下载)，我们快速查找我们感兴趣的所有3个脚本的Unicode码点范围，并在其上运行以下脚本(双关语):</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="da1d" class="lo kd hu lk b fv lp lq l lr ls">stats = {}<br/>$stdin.each_char { |c|<br/>  t = case c.ord<br/>      when 0x3041..0x309F then :hiragana<br/>      when 0x30A0..0x30FF then :katakana<br/>      when 0x4E00..0x9FCC then :kanji<br/>      end<br/>  stats[t] ||= 0<br/>  stats[t] += 1<br/>}<br/>p stats</span></pre><p id="4c01" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">瞧，我们得到了这样的东西:</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="a13a" class="lo kd hu lk b fv lp lq l lr ls">{nil=&gt;72384, :kanji=&gt;5731, :hiragana=&gt;15377, :katakana=&gt;2241}</span></pre><p id="4664" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这意味着一个典型的日语文本包含大约25%的汉字、65%的平假名和10%的片假名:</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div class="fe ff ng"><img src="../Images/fa8aae92b5f30df95cd4f4b1a0d4517c.png" data-original-src="https://miro.medium.com/v2/resize:fit:776/format:webp/1*OL9LKIV0qsXBzDkhdcoKiQ.png"/></div><figcaption class="mi mj fg fe ff mk ml bd b be z ek">Knowing distribution of different classes of characters in Japanese aids statistical analysis methods</figcaption></figure><h1 id="103e" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">理论讲够了，给我点实际操作！</h1><p id="9a1b" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">好了，是时候准备好我们的工具，开始工作了。作为对那些已经忘记我们第一篇文章的人的一个快速提醒，我们正在使用一个名为<a class="ae ka" href="http://kaitai.io" rel="noopener ugc nofollow" target="_blank">开泰结构</a>的新工具来逆向工程未知结构的二进制文件。</p><p id="a6ac" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">开泰结构允许一个人在。ksy标记语言，它可以应用于文件(或者，更好的是，文件)以一个漂亮的树形视图快速可视化它们的内部结构。一旦你写完了一个. ksy，你也获得了一个巨大的奖励:你可以编译。ksy转换成任何支持的目标语言的模块。</p><p id="5028" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">顺便说一下，自从上一篇文章以来，Kaitai Struct受到了很多人的喜爱，现在，除了Java、JavaScript、Python和Ruby之外，它还支持C++、C#、Perl和PHP。如果我们看一下<a class="ae ka" href="http://www.tiobe.com/tiobe-index/" rel="noopener ugc nofollow" target="_blank">一些顶级编程语言列表</a>，这意味着前10名都被涵盖了，而且，在前20名中，如果我们不考虑特定领域的东西，只有Delphi、Visual Basic、Swift和Go不见了。也就是说，我从未见过有人像十年前那样使用Delphi，我很难想象有人会使用古代的Visual Basic(*不是*现代的。NET one)进行逆向工程。</p><p id="2839" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在第一篇文章中，我们复习了开泰结构模板的基本语法，所以，如果你还没有阅读它或者只是想温习一下的话，那就是最好的时机了。</p><p id="edaa" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">好了，让我们快速地看一下几个文件的十六进制转储，然后开始创建下面的快速模板:</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="4d43" class="lo kd hu lk b fv lp lq l lr ls">meta:<br/>  id: yks<br/>  application: Yuka Engine<br/>  endian: le<br/>seq:<br/>  - id: magic<br/>    contents: ["YKS001", 1, 0]<br/>  - id: magic2<br/>    contents: [0x30, 0, 0, 0, 0, 0, 0, 0, 0x30, 0, 0, 0]<br/>  - id: unknown1<br/>    type: u4<br/>  - id: unknown2<br/>    type: u4<br/>  - id: unknown3<br/>    type: u4<br/>  - id: unknown4<br/>    type: u4<br/>  - id: unknown5<br/>    type: u4<br/>  - id: unknown6<br/>    type: u4<br/>  - id: unknown7<br/>    type: u4</span></pre><p id="a2eb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">人们可能会马上看到与YKC格式的相似之处。鉴于YKC格式从一开始就有自己长度的报头开始，我可以说“magic2”字段中固定的0x30实际上是第一个报头的大小，所以我直接解析了0x30之前的所有内容。这给了我们7个整数，我们要猜猜是什么。</p><p id="87b9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">所以，对于Yoyaku.yks(文件大小为27741字节):</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="760a" class="lo kd hu lk b fv lp lq l lr ls">  [.] <a class="ae ka" href="http://twitter.com/unknown1" rel="noopener ugc nofollow" target="_blank">@unknown1</a> = 1845<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown2" rel="noopener ugc nofollow" target="_blank">@unknown2</a> = 7428<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown3" rel="noopener ugc nofollow" target="_blank">@unknown3</a> = 795<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown4" rel="noopener ugc nofollow" target="_blank">@unknown4</a> = 20148<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown5" rel="noopener ugc nofollow" target="_blank">@unknown5</a> = 7593<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown6" rel="noopener ugc nofollow" target="_blank">@unknown6</a> = 25<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown7" rel="noopener ugc nofollow" target="_blank">@unknown7</a> = 0</span></pre><p id="d195" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对于trial_00100.yks(文件长度为91267字节):</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="df5d" class="lo kd hu lk b fv lp lq l lr ls">  [.] <a class="ae ka" href="http://twitter.com/unknown1" rel="noopener ugc nofollow" target="_blank">@unknown1</a> = 6433<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown2" rel="noopener ugc nofollow" target="_blank">@unknown2</a> = 25780<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown3" rel="noopener ugc nofollow" target="_blank">@unknown3</a> = 2376<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown4" rel="noopener ugc nofollow" target="_blank">@unknown4</a> = 63796<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown5" rel="noopener ugc nofollow" target="_blank">@unknown5</a> = 27471<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown6" rel="noopener ugc nofollow" target="_blank">@unknown6</a> = 5<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown7" rel="noopener ugc nofollow" target="_blank">@unknown7</a> = 0</span></pre><p id="5293" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">并且，为了便于比较，从“all”中取出一些东西，例如，“all _ 00010 . yks”(12968字节长):</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="5d29" class="lo kd hu lk b fv lp lq l lr ls">  [.] <a class="ae ka" href="http://twitter.com/unknown1" rel="noopener ugc nofollow" target="_blank">@unknown1</a> = 933<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown2" rel="noopener ugc nofollow" target="_blank">@unknown2</a> = 3780<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown3" rel="noopener ugc nofollow" target="_blank">@unknown3</a> = 353<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown4" rel="noopener ugc nofollow" target="_blank">@unknown4</a> = 9428<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown5" rel="noopener ugc nofollow" target="_blank">@unknown5</a> = 3540<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown6" rel="noopener ugc nofollow" target="_blank">@unknown6</a> = 1<br/>  [.] <a class="ae ka" href="http://twitter.com/unknown7" rel="noopener ugc nofollow" target="_blank">@unknown7</a> = 0</span></pre><p id="88ba" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们在这里看到了什么？首先，我敢打赌，我们看到的是给定文件中的偏移量或某些大小的部分，对于91K的文件，这些数字在25之间..63K，而对于12K文件，它们保持在3..9K。仔细观察会发现，可能只有“unknown2”、“unknown4”和“unknown5”是偏移量或大小——它们都可以被4整除，并且足够大。“未知7”似乎总是为零。“unknown6”似乎足够小，所以它可能是某些实体的计数器。它可能是场景/精灵/背景的数量，为我们的虚拟机中的变量保留的内存池的大小，或者类似的东西。</p><p id="1fcb" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在0x30之后，即使用肉眼(我的意思是仅仅用一个十六进制编辑器)，也能看到一个稳定增加的数字范围(好，<em class="kb">几乎</em>稳定增加)。很可能是<em class="kb">而不是</em>字节码:这是你期望看到许多重复模式的字节码。很可能还有一些类型的偏移量——例如，可能是字节码中语句开头的偏移量，或者是其他部分中可变长度字符串的偏移量，或者类似的情况。假设我们已经确定了第一个可能的部分，并且假设我们在头中有7个未知值，那么很自然地尝试一下，并检查是否有任何类似的内容:</p><ul class=""><li id="4100" class="lu lv hu je b jf jg jj jk jn lw jr lx jv ly jz lz ma mb mc dt translated">这部分的大小</li><li id="5828" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">本节结束的绝对偏移量=下一节的开始</li><li id="253c" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">本节中4字节整数的个数</li></ul><p id="baf4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">也就是说，我们在第一次或第二次射击中击中了靶心。“unknown1”证明与我们第一部分中的实体数量相匹配，而“unknown2”似乎是指向下一部分开始的指针。实际上，这意味着以下情况总是正确的:</p><blockquote class="nh ni nj"><p id="7e5c" class="jc jd kb je b jf jg jh ji jj jk jl jm nk jo jp jq nl js jt ju nm jw jx jy jz hn dt translated">未知2 = 0x30 +未知1 * 4</p></blockquote><p id="8a4a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">让我们把它记下来，当我们这样做时，我们将把我们的标题描述移到不同的类型“header”中，我们将使用类似sect1的名称..sectX，我们将了解以下部分:</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="2d50" class="lo kd hu lk b fv lp lq l lr ls">seq:<br/>  - id: header<br/>    type: header<br/>  - id: sect1<br/>    size: header.sect2_ofs - 0x30<br/>    type: sect1<br/>types:<br/>  header:<br/>    seq:<br/>      - id: magic<br/>        contents: ["YKS001", 1, 0]<br/>      - id: magic2<br/>        contents: [0x30, 0, 0, 0, 0, 0, 0, 0, 0x30, 0, 0, 0]<br/>      - id: sect1_qty<br/>        type: u4<br/>      - id: sect2_ofs<br/>        type: u4<br/>      - id: unknown3<br/>        type: u4<br/>      - id: unknown4<br/>        type: u4<br/>      - id: unknown5<br/>        type: u4<br/>      - id: unknown6<br/>        type: u4<br/>      - id: unknown7<br/>        type: u4<br/>  sect1:<br/>    seq:<br/>      - id: entries<br/>        type: u4<br/>        repeat: expr<br/>        repeat-expr: _root.header.sect1_qty</span></pre><p id="cdd7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">“trial_00100”在我们的新中看起来就是这样。ksy:</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="2de4" class="lo kd hu lk b fv lp lq l lr ls">  [-] <a class="ae ka" href="http://twitter.com/header" rel="noopener ugc nofollow" target="_blank">@header</a><br/>    [.] <a class="ae ka" href="http://twitter.com/magic" rel="noopener ugc nofollow" target="_blank">@magic</a> = 59 4b 53 30 30 31 01 00<br/>    [.] <a class="ae ka" href="http://twitter.com/magic2" rel="noopener ugc nofollow" target="_blank">@magic2</a> = 30 00 00 00 00 00 00 00 30 00 00 00<br/>    [.] <a class="ae ka" href="http://twitter.com/sect1_qty" rel="noopener ugc nofollow" target="_blank">@sect1_qty</a> = 6433<br/>    [.] <a class="ae ka" href="http://twitter.com/sect2_ofs" rel="noopener ugc nofollow" target="_blank">@sect2_ofs</a> = 25780<br/>    [.] <a class="ae ka" href="http://twitter.com/unknown3" rel="noopener ugc nofollow" target="_blank">@unknown3</a> = 2376<br/>    [.] <a class="ae ka" href="http://twitter.com/unknown4" rel="noopener ugc nofollow" target="_blank">@unknown4</a> = 63796<br/>    [.] <a class="ae ka" href="http://twitter.com/unknown5" rel="noopener ugc nofollow" target="_blank">@unknown5</a> = 27471<br/>    [.] <a class="ae ka" href="http://twitter.com/unknown6" rel="noopener ugc nofollow" target="_blank">@unknown6</a> = 5<br/>    [.] <a class="ae ka" href="http://twitter.com/unknown7" rel="noopener ugc nofollow" target="_blank">@unknown7</a> = 0<br/>  [-] <a class="ae ka" href="http://twitter.com/sect1" rel="noopener ugc nofollow" target="_blank">@sect1</a><br/>    [-] <a class="ae ka" href="http://twitter.com/entries" rel="noopener ugc nofollow" target="_blank">@entries</a> (6433 = 0x1921 entries)<br/>      [.]    0 = 6<br/>      [.]    1 = 7<br/>      [.]    2 = 3<br/>      [.]    3 = 3<br/>      [.]    4 = 4<br/>      ...<br/>      [.] 6425 = 2371<br/>      [.] 6426 = 2372<br/>      [.] 6427 = 34<br/>      [.] 6428 = 1<br/>      [.] 6429 = 2373<br/>      [.] 6430 = 2374<br/>      [.] 6431 = 1<br/>      [.] 6432 = 2375</span></pre><p id="0190" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在很明显，我们关于“section 1”条目增加偏移量或其他什么的假设并不完全正确。没有<em class="kb">只有</em>递增的数字，有相当多的重复，因此这些实际上<em class="kb">可能是</em>字节码。越来越多的数字似乎遵循这样的模式:从0或1开始，稳步增加1，直到2375。可能有人会注意到，“unknown 3”= 2376，它看起来就像这些值的总数。这可能意味着我们在sect1中提出的“字节码”引用了其他一些有2376个不同值的表(索引可能从0到2375，包括0和2375)。会是什么呢？</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div class="fe ff nn"><img src="../Images/35dfcffc35839b6166198fcdaa1fe2dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*zPqLkfNzN6r7tgCfSBzpjw.png"/></div><figcaption class="mi mj fg fe ff mk ml bd b be z ek">Increasing numbers in 16-byte records neatly lined up</figcaption></figure><p id="88a9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我想很明显，这些是16字节长的记录(这里正好是1行)，在它们内部，有一些看起来非常像稳定增加的索引或偏移量的东西。一个愚蠢的猜测，可能有2376个？让我们检查一下，将“unknown3”重命名为“sect2 _ qty ”,并添加这个小片段来收集16字节记录的“section 2 ”:</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="0cf4" class="lo kd hu lk b fv lp lq l lr ls">  - id: sect2<br/>    size: 16<br/>    repeat: expr<br/>    repeat-expr: header.sect2_qty</span></pre><p id="6061" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">看来我们中大奖了。确切地说:</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff no"><img src="../Images/4825798c492e491db38b5c96185304f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cu9ohQrAf20wjWoAxuVLvQ.png"/></div></div><figcaption class="mi mj fg fe ff mk ml bd b be z ek">End of “sect2”, in assumption that there are exactly “sect2_qty” 16-byte records in it</figcaption></figure><p id="b594" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">即使用肉眼也可以看到，这些严格的16字节记录正好在我们假设的“section 2”的末端结束，这意味着它们正好有“sect2 _ qty”。在他们之外有着完全不同的东西。看起来怎么样？那绝对不是4字节的整数，几乎所有东西看起来都是非零的。看了几分钟后，我想我猜不出这是什么。没有周期模式，什么都没有。唯一值得注意的是大量的0xaa字节。还有大量的0x28，每隔一个字节就会遇到这些——没有两个0x28是连续出现的。让我们检查一下文件的结尾——它在那里看起来是一样的吗，还是我们有了其他东西，即更多的部分？不，同样的模式似乎也发生在那里:</p><figure class="lf lg lh li fq iv fe ff paragraph-image"><div class="fe ff np"><img src="../Images/fa1bd19c010a1564e4c64e353e97702a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/format:webp/1*Mp_GYoBhqdL0szbK5T2psQ.png"/></div><figcaption class="mi mj fg fe ff mk ml bd b be z ek">End of file. Abudance of <strong class="bd nq">0xaa</strong> and <strong class="bd nq">0x28</strong>. End of “sect3”?</figcaption></figure><p id="73a4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">因此，这是一个安全的赌注，我们正在观察这个文件的第三和最后一部分。除此之外没有别的了。让我们跳回到最开始，回忆一下我们在这里会发现什么。表头？检查。字节码？检查。文字？没有。可能它们在这里，但以某种方式编码，使它不那么明显。它们被压缩了吗？大概不会，如果是，就不会有这么多<strong class="je hv"> 0xaa </strong>和<strong class="je hv"> 0x82 </strong>的重复了。实际上，类似于</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="d714" class="lo kd hu lk b fv lp lq l lr ls">28 08 28 1b 28 0e 28 6c 26 6f 28 07 3a 14 28 6b</span></pre><p id="81f9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">看起来非常非常可疑。回顾一下我们对日本ShiftJIS编码的简短了解，并获得一个ShiftJIS中正常日语文本的样本:</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="3ca3" class="lo kd hu lk b fv lp lq l lr ls">82 a0 82 e8 82 aa 82 c6 82 a4 82 b2 82 b4 82 a2</span></pre><p id="43e7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">是只有我，还是一个简单的替换密码，用一些映射表将每个字节替换为其他的单个字节。好了，我们怎么把<strong class="je hv"> 0x82 </strong>编码成<strong class="je hv"> 0x28 </strong>？当然，这可能是任何任意的表，但是大多数时候所有人都很懒，因此选择现成的函数。又不是有很多。实际上，我只能想到三个:</p><ul class=""><li id="6ed2" class="lu lv hu je b jf jg jj jk jn lw jr lx jv ly jz lz ma mb mc dt translated"><strong class="je hv">加法/减法</strong> —可以只对每个字节添加(或减去，从CPU的角度来看，这是相同的操作)一些常数，在溢出的情况下将结果打包</li><li id="46e0" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated"><strong class="je hv">ROL/误差</strong>—<a class="ae ka" href="https://en.wikipedia.org/wiki/Circular_shift" rel="noopener ugc nofollow" target="_blank">循环移位</a>一定的位数；注意，循环左移或右移4位只会交换每个字节中的2个十六进制数字</li><li id="f97c" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated"><strong class="je hv">异或(XOR) </strong> —可以进行XOR运算，将每个字节与某个其他固定字节组合起来；这种方法肯定被过度使用了，但是仍然有效，因此仍然受欢迎</li></ul><p id="b312" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">有很多像<a class="ae ka" href="https://blog.didierstevens.com/programs/xorsearch/" rel="noopener ugc nofollow" target="_blank"> XORSearch </a>这样的重型工具，可以帮助你暴力破解这样简单的算法，但在这种情况下，它甚至更简单，所以我在第二次尝试中找到了一个匹配。大量的<strong class="je hv"> 0xaa </strong>字节允许我们猜测流中有许多零，这些零与<strong class="je hv"> 0xaa </strong>进行XOR运算，得到大量的<strong class="je hv"> 0xaa </strong>，此外，<strong class="je hv"> 0x82 </strong> ^ <strong class="je hv"> 0xaa </strong>神秘地<strong class="je hv">0x 28</strong>(xor运算是如此通用，以至于你可以通过做<strong class="je hv"> 0x82 ^ 0x28 = 0xaa </strong>来推导出它)。</p><p id="25f4" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">坦率地说，<strong class="je hv"> 0xaa </strong>是最常被滥用的XOR模式之一，人们几乎必须立即尝试(类似于密码“123456”、“qwerty”或<a class="ae ka" href="https://github.com/danielmiessler/SecLists/blob/master/Passwords/10k_most_common.txt" rel="noopener ugc nofollow" target="_blank">列表中的前10名，就像这些</a>在暴力破解密码时一样)。<strong class="je hv"> 0xaa </strong>为<strong class="je hv"> 0b10101010 </strong>，即将一个值与<strong class="je hv"> 0xaa </strong>进行异或运算，每隔一个第二位进行切换。是啊，很多人仍然认为这是一个很酷的想法。</p><p id="305a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">幸运的是，Kaitai Struct用一个<strong class="je hv">流程:</strong>子句支持这种情况。补充以下内容就足够了:</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="04a6" class="lo kd hu lk b fv lp lq l lr ls">  - id: sect3<br/>    size-eos: true<br/>    process: xor(0xaa)</span></pre><p id="f9de" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，我们终于观察到了脚本中字符串常量丰富的内部世界:</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="a11f" class="lo kd hu lk b fv lp lq l lr ls">000000: 69 66 00 c8 00 00 00 47 6c 6f 62 61 6c 46 6c 61<br/>000010: 67 00 3d 00 ff ff 00 00 01 00 00 00 3d 00 7b 00<br/>000020: 0d 00 00 00 57 69 6e 64 6f 77 4e 61 6d 65 53 65<br/>000030: 74 00 97 f6 82 b7 82 e9 8e 6f 96 85 82 cc 98 5a<br/>000040: 8f 64 91 74 28 83 66 83 6f 83 62 83 4f 29 81 7c<br/>000050: 46 69 6c 65 20 3a 20 74 72 69 61 6c 68 5f 6d 61<br/>000060: 79 75 2e 79 6b 73 00 7d 00 09 00 00 00 44 72 61<br/>000070: 77 53 74 6f 70 00 47 72 61 70 68 69 63 48 69 64<br/>000080: 65 00 0a 00 00 00 54 72 61 6e 73 69 74 69 6f 6e<br/>000090: 00 02 00 00 00 64 00 00 00 0a 00 00 00 0b 00 00<br/>0000a0: 00 47 72 61 70 68 69 63 4c 6f 61 64 00 00 00 00</span></pre><p id="785f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">或者，在ASCII中:</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="c143" class="lo kd hu lk b fv lp lq l lr ls">000000: if.....GlobalFla<br/>000010: g.=.........=.{.<br/>000020: ....WindowNameSe<br/>000030: t........o.....Z<br/>000040: .d.t(.f.o.b.O).|<br/>000050: File : trialh_ma<br/>000060: yu.yks.}.....Dra<br/>000070: wStop.GraphicHid<br/>000080: e.....Transition<br/>000090: .....d..........<br/>0000a0: .....d..........</span></pre><p id="6cc7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">老实说，我们真的很幸运:有很多ASCII字符串，这让我们的生活更容易。乍一看，有人可能会说只是一堆C风格的以零结尾的字符串混杂在一起，但仔细观察就会发现事实并非如此。当然，字符串是存在的，但是除此之外，我们在它之间也有更多的二进制，比如</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="0578" class="lo kd hu lk b fv lp lq l lr ls">ff ff 00 00 01 00 00 00</span></pre><p id="6e8a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">或者</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="8576" class="lo kd hu lk b fv lp lq l lr ls">02 00 00 00 64 00 00 00 0a 00 00 00 0b 00 00 00</span></pre><p id="d15a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">其中有一个可打印的ASCII符号(` d` = 0x64)，但可能这些是<em class="kb">而不是</em>字符串。最后，我们有日文的原版小说文本，在ShiftJIS中，有所有这些0x82s。</p><h1 id="33f6" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">万岁，我们结束了？</h1><p id="ecce" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">好了，让我们总结一下我们所得到的:</p><ol class=""><li id="229e" class="lu lv hu je b jf jg jj jk jn lw jr lx jv ly jz nr ma mb mc dt translated"><strong class="je hv">section 1</strong>，由4字节整数组成(推测起来，<em class="kb">就是</em>字节码)；这些4字节整数中至少有一些是对sect2中16字节记录的引用</li><li id="faa9" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz nr ma mb mc dt translated"><strong class="je hv">section 2</strong>，由16个字节的记录组成，其中包含一些递增的数字(可能是引用了其他部分的偏移量，可能是<strong class="je hv">section 3</strong>？)</li><li id="c312" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz nr ma mb mc dt translated">section 3，主要由空终止的ShiftJIS编码的字符串和一些更复杂的数据组成(大概是字节码引用的字符串资源和其他常量)</li></ol><p id="10d1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当我们还在享受这个小小的胜利时，我想我们今天就到此为止了。这篇文章变得比最初预期的要长得多(而且肯定比Medium.com的平均文章长得多)。事实上，如果我们正在翻译这部小说，我们今天所取得的成就足以将火炬传递给译者。为此，我们需要做的就是从sect3中取出所有的日文文本，然后交给他们进行翻译。仅仅迭代第3节的内容，忽略所有不可打印的内容，我们会得到这样的结果(当然，如果您不是在ShiftJIS系统上，您需要将其转换为您系统的编码，可能是UTF-8)，结果如下:</p><pre class="lf lg lh li fq lj lk ll lm aw ln dt"><span id="5250" class="lo kd hu lk b fv lp lq l lr ls">恋する姉妹の六重奏(デバッグ)－File : trialh_mayu.yks<br/>まゆ<br/>「きゃっ……！！」<br/>教育的指導を兼ねて、お望み通りメチャクチャにしてやろうじゃないか！！<br/>「あっ……お、おにぃっ……」<br/>自分から誘っておきながら、不安そうな表情を浮かべるまゆ。<br/>そんなまゆを、ソファーに押しつけて……胸を露出させ、股間が丸見えになる体勢を強いる。<br/>「んぁっ……」</span></pre><h1 id="0511" class="kc kd hu bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz dt translated">下一步是什么？</h1><p id="36fa" class="pw-post-body-paragraph jc jd hu je b jf la jh ji jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz hn dt translated">我感谢每一个有耐心跟进这个地方的人。请继续关注下一篇文章，我们将深入研究字节码本身，并试图理解所有发现的部分是如何相互联系的。一定要订阅，如果不想错过的话。</p></div><div class="ab cl mz na hc nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="hn ho hp hq hr"><p id="e3e2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">有用链接的摘要:</p><ul class=""><li id="2d0a" class="lu lv hu je b jf jg jj jk jn lw jr lx jv ly jz lz ma mb mc dt translated">开泰结构—【http://kaitai.io/ T2】</li><li id="a12e" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">http://peassoft.com/(警告，NSFW！)</li><li id="8833" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">人们可以找到一些视觉新颖引擎的规范和工具(在。ksy格式也是)在<a class="ae ka" href="https://github.com/mnakamura1337/" rel="noopener ugc nofollow" target="_blank">我的GitHub项目</a>。</li><li id="befd" class="lu lv hu je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">你也可以用俄语阅读这篇文章<a class="ae ka" href="https://habrahabr.ru/post/309414/" rel="noopener ugc nofollow" target="_blank">。</a></li></ul><p id="ca2f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你想把这篇教程翻译成你的语言来帮助更多的人学习逆向工程——它是CC-BY-SA-licensed的，所以完全欢迎你！</p><p id="cc86" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你喜欢这篇文章，并认为它很有帮助，请点击下面的❤推荐给其他人，或在社交网络中与你的朋友分享。这对我意义重大，激励我写更多:)</p><div class="lf lg lh li fq ab cb"><figure class="ns iv nt nu nv nw nx paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="ns iv nt nu nv nw nx paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="ns iv nt nu nv nw nx paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="nh ni nj"><p id="f922" class="jc jd kb je b jf jg jh ji jj jk jl jm nk jo jp jq nl js jt ju nm jw jx jy jz hn dt translated"><a class="ae ka" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是阿妹家庭的一员。我们现在<a class="ae ka" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ka" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jc jd kb je b jf jg jh ji jj jk jl jm nk jo jp jq nl js jt ju nm jw jx jy jz hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ka" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ka" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lf lg lh li fq iv fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff ny"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure></div></div>    
</body>
</html>