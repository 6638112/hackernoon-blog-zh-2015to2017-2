<html>
<head>
<title>Setting up Nginx Ingress on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes上设置Nginx入口</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/setting-up-nginx-ingress-on-kubernetes-2b733d8d2f45?source=collection_archive---------0-----------------------#2017-09-26">https://medium.com/hackernoon/setting-up-nginx-ingress-on-kubernetes-2b733d8d2f45?source=collection_archive---------0-----------------------#2017-09-26</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/4390dbb1d0dcd1dd0efbdff531832804.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A-kYNXMDiSLXde-ilVNJvg.png"/></div></div></figure><p id="db48" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">嘿，在你的Kubernetes集群上设置入口控制器？在阅读了许多文章和官方文档后，我仍然很难设置入口。但是经过无数次尝试，我设法设置了一个<strong class="je hv"><em class="ka">nginx-ingress-controller</em></strong>来将外部流量转发到我的集群内服务，处理HTTP和HTTPS。这篇文章一步一步地指导你做到这一点。</p><p id="7ae0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">psst…如果你像我一样是Kubernetes的新手，这里有一篇很好的文章解释了入口。</p><div class="kb kc fm fo kd ke"><a rel="noopener follow" target="_blank" href="/@cashisclay/kubernetes-ingress-82aa960f658e"><div class="kf ab ej"><div class="kg ab kh cl cj ki"><h2 class="bd hv fv z el kj eo ep kk er et ht dt translated">Kubernetes入口</h2><div class="kl l"><h3 class="bd b fv z el kj eo ep kk er et ek translated">很多人似乎对Kubernetes中Ingress的工作方式感到困惑，Slack中几乎每天都会出现问题。这是…</h3></div><div class="km l"><p class="bd b gc z el kj eo ep kk er et ek translated">medium.com</p></div></div><div class="kn l"><div class="ko l kp kq kr kn ks ja ke"/></div></div></a></div><h1 id="2aa2" class="kt ku hu bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq dt translated">现场</h1><p id="e995" class="pw-post-body-paragraph jc jd hu je b jf lr jh ji jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz hn dt translated">我们将设置一个简单的“hello-world”api，并在使用<a class="ae lw" href="https://kubernetes.io/docs/getting-started-guides/minikube/" rel="noopener ugc nofollow" target="_blank"> <em class="ka"> Minikube </em> </a>的本地集群上使用<strong class="je hv"><em class="ka">nginx-ingress-controller</em></strong>公开该API。</p><blockquote class="lx"><p id="24f5" class="ly lz hu bd ma mb mc md me mf mg jz ek translated">TL；DR — <a class="ae lw" href="https://github.com/gokulchandra/k8s-ingress-setup" rel="noopener ugc nofollow" target="_blank">这里的</a>是一个样板文件，反映了所解释的内容。</p></blockquote><h1 id="92e8" class="kt ku hu bd kv kw kx ky kz la lb lc ld le mh lg lh li mi lk ll lm mj lo lp lq dt translated">步伐</h1><h2 id="9d4a" class="mk ku hu bd kv ml mm mn kz mo mp mq ld jn mr ms lh jr mt mu ll jv mv mw lp mx dt translated">步骤1:创建要公开的服务</h2><p id="b56a" class="pw-post-body-paragraph jc jd hu je b jf lr jh ji jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz hn dt translated">假设您已经设置了Kubectl和Minikube，让我们部署我们的<code class="eh my mz na nb b">hello-world</code> api，并在我们的集群中将其公开为<a class="ae lw" href="https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport" rel="noopener ugc nofollow" target="_blank"> <em class="ka">节点端口服务</em> </a>。出于演示的目的，我们将使用一个简单的api。源代码可以在<a class="ae lw" href="https://github.com/gokulchandra/hello-world-api" rel="noopener ugc nofollow" target="_blank"> <em class="ka">这里找到</em> </a>。</p><figure class="nc nd ne nf fq iv"><div class="bz el l di"><div class="ng nh l"/></div></figure><p id="b5be" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">配置文件由部署和服务组成。通常我们把它们分成单独的文件。</p><pre class="nc nd ne nf fq ni nb nj nk aw nl dt"><span id="47f1" class="mk ku hu nb b fv nm nn l no np">kubectl create -f hello-world.yaml</span></pre><p id="cd38" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，您应该能够在运行时看到创建的资源</p><pre class="nc nd ne nf fq ni nb nj nk aw nl dt"><span id="c068" class="mk ku hu nb b fv nm nn l no np">kubectl get all | grep hello-world</span></pre><h2 id="3c71" class="mk ku hu bd kv ml mm mn kz mo mp mq ld jn mr ms lh jr mt mu ll jv mv mw lp mx dt translated">步骤2:创建nginx-ingress-controller使用的默认后端</h2><p id="54d7" class="pw-post-body-paragraph jc jd hu je b jf lr jh ji jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz hn dt translated">我们需要为入口控制器提供一个默认的后端。如果Nginx不能成功地路由请求，那么<code class="eh my mz na nb b">default backend</code>是默认的服务。<code class="eh my mz na nb b">default backend</code>需要满足以下两个要求:</p><ul class=""><li id="ccf8" class="nq nr hu je b jf jg jj jk jn ns jr nt jv nu jz nv nw nx ny dt translated">在/</li><li id="7a42" class="nq nr hu je b jf nz jj oa jn ob jr oc jv od jz nv nw nx ny dt translated">在a/health上服务200人z</li></ul><p id="7c0b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">nginx-ingress-controller项目有一个默认后端的例子。</p><figure class="nc nd ne nf fq iv"><div class="bz el l di"><div class="ng nh l"/></div></figure><pre class="nc nd ne nf fq ni nb nj nk aw nl dt"><span id="5d37" class="mk ku hu nb b fv nm nn l no np">kubectl create -f default-backend.yaml</span></pre><h2 id="1fee" class="mk ku hu bd kv ml mm mn kz mo mp mq ld jn mr ms lh jr mt mu ll jv mv mw lp mx dt translated">步骤3:创建秘密来为Nginx指定SSL证书</h2><p id="ae79" class="pw-post-body-paragraph jc jd hu je b jf lr jh ji jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz hn dt translated"><a class="ae lw" href="https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-on-centos-7" rel="noopener ugc nofollow" target="_blank">使用OpenSSL </a>创建自签名证书。生成SSL证书时指定的<strong class="je hv"> <em class="ka">通用名</em> </strong>应该作为入口配置中的<strong class="je hv"> <em class="ka">主机</em> </strong>。我们为给定的密钥、证书和dhparam文件创建秘密。为密钥、证书和dhparam使用相应的文件名。</p><pre class="nc nd ne nf fq ni nb nj nk aw nl dt"><span id="3792" class="mk ku hu nb b fv nm nn l no np">kubectl create secret tls tls-certificate --key &lt;key-file&gt;.key --cert &lt;certificate-file&gt;.crt</span><span id="c9d6" class="mk ku hu nb b fv oe nn l no np">kubectl create secret generic tls-dhparam --from-file=&lt;dhparam-file&gt;.pem</span></pre><h2 id="28e5" class="mk ku hu bd kv ml mm mn kz mo mp mq ld jn mr ms lh jr mt mu ll jv mv mw lp mx dt translated">步骤4:在Minikube上启用入口</h2><p id="7c50" class="pw-post-body-paragraph jc jd hu je b jf lr jh ji jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz hn dt translated">Minikube版本&gt;<a class="ae lw" href="https://github.com/kubernetes/minikube/blob/v0.14.0/CHANGELOG.md" rel="noopener ugc nofollow" target="_blank"> <em class="ka"> v0.14.0 </em> </a>附带Nginx入口设置作为附件。只需运行以下命令即可启用:</p><pre class="nc nd ne nf fq ni nb nj nk aw nl dt"><span id="67c5" class="mk ku hu nb b fv nm nn l no np">minikube addons enable ingress</span></pre><p id="7ff0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">启用附加设备提供以下内容:</p><ul class=""><li id="3854" class="nq nr hu je b jf jg jj jk jn ns jr nt jv nu jz nv nw nx ny dt translated">Nginx负载平衡器的<a class="ae lw" href="https://github.com/kubernetes/minikube/blob/master/deploy/addons/ingress/ingress-configmap.yaml" rel="noopener ugc nofollow" target="_blank"> <em class="ka">配置图</em> </a>。</li><li id="528f" class="nq nr hu je b jf nz jj oa jn ob jr oc jv od jz nv nw nx ny dt translated"><a class="ae lw" href="https://github.com/kubernetes/minikube/blob/master/deploy/addons/ingress/ingress-rc.yaml" rel="noopener ugc nofollow" target="_blank"> nginx- <em class="ka">入口控制器</em> </a>。</li><li id="21b4" class="nq nr hu je b jf nz jj oa jn ob jr oc jv od jz nv nw nx ny dt translated">一个<a class="ae lw" href="https://github.com/kubernetes/minikube/blob/master/deploy/addons/ingress/ingress-svc.yaml" rel="noopener ugc nofollow" target="_blank">服务</a>，它公开了一个默认的Nginx后端pod来处理未映射的请求。</li></ul><h2 id="ca8c" class="mk ku hu bd kv ml mm mn kz mo mp mq ld jn mr ms lh jr mt mu ll jv mv mw lp mx dt translated">步骤5:设置nginx入口控制器</h2><p id="0967" class="pw-post-body-paragraph jc jd hu je b jf lr jh ji jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz hn dt translated">现在我们为控制器创建一个服务。该服务属于类型<a class="ae lw" href="https://kubernetes.io/docs/concepts/services-networking/service/#type-loadbalancer" rel="noopener ugc nofollow" target="_blank"> <em class="ka">负载平衡器</em> </a>，因此它在集群外部公开。</p><figure class="nc nd ne nf fq iv"><div class="bz el l di"><div class="ng nh l"/></div></figure><p id="766e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">配置包括nginx-ingress的部署和服务。从配置中可以观察到以下内容:</p><ul class=""><li id="c631" class="nq nr hu je b jf jg jj jk jn ns jr nt jv nu jz nv nw nx ny dt translated"><strong class="je hv"> <em class="ka">默认SSL证书</em> </strong>和<strong class="je hv"> <em class="ka">默认后端服务</em> </strong>的秘密作为参数传递。</li><li id="69f7" class="nq nr hu je b jf nz jj oa jn ob jr oc jv od jz nv nw nx ny dt translated">镜像<strong class="je hv">nginx-ingress-controller:0 . 9 . 0-beta 5</strong>使用。我已经尝试了更高的测试版本。这似乎是一个更稳定的用例。</li><li id="9732" class="nq nr hu je b jf nz jj oa jn ob jr oc jv od jz nv nw nx ny dt translated"><strong class="je hv"> <em class="ka"> tls-dhparam </em> </strong>秘密被安装在控制器要使用的卷上。</li></ul><p id="f697" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">通过运行以下命令创建控制器:</p><pre class="nc nd ne nf fq ni nb nj nk aw nl dt"><span id="8286" class="mk ku hu nb b fv nm nn l no np">kubectl create -f nginx-controller.yaml</span></pre><p id="7ff8" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">几秒钟后，我们应该能够看到创建的带有公开IP地址的资源。得到迷你库贝的IP地址。</p><pre class="nc nd ne nf fq ni nb nj nk aw nl dt"><span id="1a42" class="mk ku hu nb b fv nm nn l no np">minikube service nginx-ingress --url</span></pre><p id="7680" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对暴露的端点运行一个<em class="ka"> Curl </em>请求应该会给我们一个来自<strong class="je hv">默认后端</strong>的响应，因为我们还没有配置我们的入口来指向我们的hello-world api。</p><pre class="nc nd ne nf fq ni nb nj nk aw nl dt"><span id="2dcd" class="mk ku hu nb b fv nm nn l no np">curl <a class="ae lw" href="http://192.168.99.100:30567" rel="noopener ugc nofollow" target="_blank">http://&lt;nginx-service-IP&gt;:</a>&lt;port&gt;</span><span id="1e1d" class="mk ku hu nb b fv oe nn l no np">default backend - 404%</span></pre><h2 id="3b6f" class="mk ku hu bd kv ml mm mn kz mo mp mq ld jn mr ms lh jr mt mu ll jv mv mw lp mx dt translated">步骤6:配置入口规则</h2><p id="ab26" class="pw-post-body-paragraph jc jd hu je b jf lr jh ji jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz hn dt translated">接下来我们会花大部分时间。我们向入口提供转发规则。</p><figure class="nc nd ne nf fq iv"><div class="bz el l di"><div class="ng nh l"/></div></figure><p id="44dc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们在这里使用注释将配置参数传递给底层入口控制器，在我们的例子中是Nginx。你可以在这里 找到更多关于<a class="ae lw" href="https://github.com/kubernetes/ingress/blob/master/docs/annotations.md" rel="noopener ugc nofollow" target="_blank"> <em class="ka">的注解。</em></a></p><ul class=""><li id="8345" class="nq nr hu je b jf jg jj jk jn ns jr nt jv nu jz nv nw nx ny dt translated"><a class="ae lw" href="https://github.com/nginxinc/kubernetes-ingress/tree/master/examples/ssl-services" rel="noopener ugc nofollow" target="_blank"><strong class="je hv"><em class="ka">【nginx.org/ssl-services】</em></strong></a><strong class="je hv"><em class="ka"/></strong><em class="ka">用于指定使用HTTPS进行负载均衡的服务</em></li><li id="064a" class="nq nr hu je b jf nz jj oa jn ob jr oc jv od jz nv nw nx ny dt translated">我们指定主机、路径及其相应的服务处理程序。</li></ul><pre class="nc nd ne nf fq ni nb nj nk aw nl dt"><span id="0b50" class="mk ku hu nb b fv nm nn l no np">kubectl create -f ingress.yaml</span></pre><p id="b6dc" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们现在已经配置了一个Nginx web服务器，它将<strong class="je hv"><em class="ka"/></strong>的流量路由到我们配置的<strong class="je hv"><em class="ka">hello-world-SVC</em></strong>。<strong class="je hv"> <em class="ka"> </em> </strong>对于未处理的请求，它会退回到<strong class="je hv"> <em class="ka">默认-后端服务</em> </strong>。</p><p id="e410" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">此外，您可能希望更新<code class="eh my mz na nb b">/etc/hosts</code>文件，以将您的主机解析为您的minikube IP。假设你的Minikube IP是<code class="eh my mz na nb b">192.168.99.101</code>，你的条目应该是这样的。</p><pre class="nc nd ne nf fq ni nb nj nk aw nl dt"><span id="388b" class="mk ku hu nb b fv nm nn l no np">192.168.99.101 api.sample.com</span></pre><p id="0b4b" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您应该能够通过https访问公开的端点。</p><pre class="nc nd ne nf fq ni nb nj nk aw nl dt"><span id="6336" class="mk ku hu nb b fv nm nn l no np">GET api.sample.com/:name<br/>POST api.sample.com/:name<br/>PUT api.sample.com/:name</span></pre><p id="e000" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">将注释<code class="eh my mz na nb b">ingress.kubernetes.io/ssl-redirect: “true”</code>添加到<code class="eh my mz na nb b">ingress.yaml</code>配置中，可以使流量通过HTTP和HTTPS。</p><h1 id="e10c" class="kt ku hu bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq dt translated"><strong class="ak">结论</strong></h1><p id="f926" class="pw-post-body-paragraph jc jd hu je b jf lr jh ji jj ls jl jm jn lt jp jq jr lu jt ju jv lv jx jy jz hn dt translated">Ingress允许您配置多个虚拟主机、粘性会话、路径重写以及自定义配置，为Kubernetes提供了一个强大、灵活的路由机制。</p><p id="df57" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">有关nginx入口控制器的更多信息，请访问<a class="ae lw" href="https://github.com/nginxinc/kubernetes-ingress/blob/master/examples/proxy-protocol/README.md" rel="noopener ugc nofollow" target="_blank"><em class="ka">https://github.com/nginxinc/kubernetes-ingress</em></a></p><p id="f03a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">类似的程序可用于部署到GKE的AWS，而不是Minikube。</p><blockquote class="of og oh"><p id="f38a" class="jc jd ka je b jf jg jh ji jj jk jl jm oi jo jp jq oj js jt ju ok jw jx jy jz hn dt translated">尤其是Kubernetes和Ingress在不断发展，我会尽力保持更新。<strong class="je hv">童子军誓言。</strong></p></blockquote><h1 id="c21b" class="kt ku hu bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq dt translated">好的读物</h1><ul class=""><li id="99d8" class="nq nr hu je b jf lr jj ls jn ol jr om jv on jz nv nw nx ny dt translated"><a class="ae lw" rel="noopener" href="/@Oskarr3/setting-up-ingress-on-minikube-6ae825e98f82">https://medium . com/@ oskar R3/setting-up-ingress-on-minikube-6ae 825 e 98 f 82</a></li><li id="3b35" class="nq nr hu je b jf nz jj oa jn ob jr oc jv od jz nv nw nx ny dt translated"><a class="ae lw" href="http://danielfm.me/posts/painless-nginx-ingress.html" rel="noopener ugc nofollow" target="_blank">http://danielfm.me/posts/painless-nginx-ingress.html</a></li><li id="f0a2" class="nq nr hu je b jf nz jj oa jn ob jr oc jv od jz nv nw nx ny dt translated"><a class="ae lw" href="https://daemonza.github.io/2017/02/13/kubernetes-nginx-ingress-controller/" rel="noopener ugc nofollow" target="_blank">https://daemonza . github . io/2017/02/13/kubernetes-nginx-ingress-controller/</a></li></ul><p id="364c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ka">希望你喜欢读这篇文章，就像我喜欢写它一样。</em> <br/> <em class="ka">你是否认为这样会对某人有所帮助？不要犹豫分享。如果你喜欢它，点击下面的</em> <strong class="je hv"> <em class="ka">拍手</em> </strong> <em class="ka">，这样其他人会在这里的媒体上看到它。不要忘了在博客后用</em> <strong class="je hv"> <em class="ka">表达爱意！</em> </strong></p></div><div class="ab cl oo op hc oq" role="separator"><span class="or bw bk os ot ou"/><span class="or bw bk os ot ou"/><span class="or bw bk os ot"/></div><div class="hn ho hp hq hr"><blockquote class="of og oh"><p id="4c68" class="jc jd ka je b jf jg jh ji jj jk jl jm oi jo jp jq oj js jt ju ok jw jx jy jz hn dt translated"><strong class="je hv"><em class="hu">* 2018年11月11日更新* </em> </strong>在示例设置中增加了RBAC。感谢<a class="ov ow gr" href="https://medium.com/u/1c0929523f89?source=post_page-----2b733d8d2f45--------------------------------" rel="noopener" target="_blank">延斯·麦德森</a>的贡献。</p></blockquote></div></div>    
</body>
</html>