<html>
<head>
<title>Yubl’s road to Serverless — Part 5, Building better recommendations with Lambda, BigQuery and GrapheneDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Yubl的无服务器之路——第5部分，用Lambda、BigQuery和GrapheneDB构建更好的推荐</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/yubls-road-to-serverless-part-5-building-better-recommendations-with-lambda-bigquery-and-1d74407f3b3a?source=collection_archive---------13-----------------------#2017-06-28">https://medium.com/hackernoon/yubls-road-to-serverless-part-5-building-better-recommendations-with-lambda-bigquery-and-1d74407f3b3a?source=collection_archive---------13-----------------------#2017-06-28</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="b52b" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">我们使用Lambda、BigQuery和GrapheneDB的组合，在不到两周的时间内重建了Yubl中的推荐功能</h2></div><h1 id="8244" class="jj jk hu bd jl jm jn jo jp jq jr js jt ja ju jb jv jd jw je jx jg jy jh jz ka dt translated">这条路到此为止</h1><p id="c8a4" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">第1部分:<a class="ae kx" rel="noopener" href="/@theburningmonk/yubls-road-to-serverless-part-1-overview-ca348370acde">概述</a></p><p id="211d" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">第2部分:<a class="ae kx" rel="noopener" href="/@theburningmonk/yubls-road-to-serverless-part-2-testing-and-ci-cd-72b2e583fe64">测试和持续交付策略</a></p><p id="5c21" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">第三部:<a class="ae kx" href="https://hackernoon.com/yubls-road-to-serverless-part-3-ops-6c82139bb7ee" rel="noopener ugc nofollow" target="_blank"> ops </a></p><p id="cd1c" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">第4部分:<a class="ae kx" href="https://hackernoon.com/yubls-road-to-serverless-part-4-building-a-scalable-push-notification-system-62b38924ed61" rel="noopener ugc nofollow" target="_blank">构建可伸缩的推送通知系统</a></p><p id="db9e" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">第5部分:<a class="ae kx" href="https://hackernoon.com/yubls-road-to-serverless-part-5-building-better-recommendations-with-lambda-bigquery-and-1d74407f3b3a" rel="noopener ugc nofollow" target="_blank">建立一个更好的推荐系统</a></p><p id="5b1f" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">当我在2016年4月加入Yubl时，它刚刚在2个月前推出，经过了长达两年多的漫长而混乱的开发周期——在产品问世之前，一直有一个全副武装的销售团队！</p><p id="8630" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">一些非常糟糕的决定发生在Yubl..从硅谷来看，这种决策远比我们想象的要普遍。</p><p id="bec4" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">也就是说，在Yubl也发生了许多好事，我很高兴能和我职业生涯中遇到的一些最优秀的人一起工作。这篇文章是关于一个有问题的特性，我们通过AWS Lambda的力量和使用正确的工具很快扭转了这个问题。</p><figure class="le lf lg lh fq li"><div class="bz el l di"><div class="lj lk l"/></div><figcaption class="ll lm fg fe ff ln lo bd b be z ek">fans of <em class="lp">Silicon Valley</em> probably remember that scene from Season 3 when Richard and co walked into their shiny new Pipe Piper office to find “Action” Jack Barker had hired an army of sales people before they even had a product.</figcaption></figure><h1 id="c4af" class="jj jk hu bd jl jm jn jo jp jq jr js jt ja ju jb jv jd jw je jx jg jy jh jz ka dt translated">破损的特征</h1><p id="46af" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">加入这家公司后，我发现这款应用已经有了<strong class="kd hv">寻人</strong>功能，尽管它没有达到我的预期。像Twitter和脸书这样的网站会使用复杂的算法来寻找和你有共同兴趣的人。另一方面，我们的特性将按照帐户创建时间的顺序返回MongoDB中您尚未关注的前30位用户。对于大多数用户来说，这份名单相当于前30名Yubl员工安装了该应用程序…说到操纵游戏！</p><figure class="le lf lg lh fq li fe ff paragraph-image"><div class="fe ff lq"><img src="../Images/e63c752f8f1cf3ec3d42c5b580b792d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*d3mvzKG96Y8ec51SmYcrPQ.png"/></div></figure><p id="9c1f" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">其中一个开发者大胆地尝试改进这个特性，只返回与你共享连接的用户——要么你们都跟随X，要么你们都被X跟随。</p><p id="3a3e" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">然而，实现是每个用户请求一系列昂贵(复杂)的MongoDB查询。最终，这种方法无法随着吞吐量和复杂性而扩展，因为它使用了错误的工具。</p><h1 id="1862" class="jj jk hu bd jl jm jn jo jp jq jr js jt ja ju jb jv jd jw je jx jg jy jh jz ka dt translated">Lambda + GrapheneDB =高效的图形查询</h1><p id="c3b7" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">我之前在Gamesys和Neo4j一起工作，用它来分析和模拟MMORPG 复杂的游戏经济。</p><p id="95dd" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">像Neo4j这样的图表数据库是存储我们的社交图表的最佳位置，它允许我们有效地执行我们需要的图表查询，以便找到您应该关注的用户，例如第二/第三级关系。</p><p id="bf8c" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated"><a class="ae kx" href="https://www.graphenedb.com/" rel="noopener ugc nofollow" target="_blank"> GrapheneDB </a>提供<strong class="kd hv">托管的Neo4j数据库即服务</strong>，内置监控、仪表盘、自动备份和纵向扩展。这是让我们前进并开始快速为我们的用户提供价值的完美选择。</p><p id="aaed" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">在这个时间点上，我们已经将系统中所有的状态变化流入Kinesis。为了将我们所有的社交图导出到GrapheneDB中，并与MongoDB保持同步，我们:</p><ol class=""><li id="87a4" class="lt lu hu kd b ke ky kh kz kk lv ko lw ks lx kw ly lz ma mb dt translated">运行一次性任务，将所有关系数据导出到GrapheneDB中</li><li id="8370" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw ly lz ma mb dt translated">为<code class="eh mh mi mj mk b">Relationship</code> Kinesis流订阅了一个Lambda函数，以处理任何后续关系变化并实时更新社交图(GrapheneDB中)</li></ol><figure class="le lf lg lh fq li fe ff paragraph-image"><div class="fe ff ml"><img src="../Images/000b860b0f36ba51c14380f269ede181.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*QcqVQP6J61cE7CFPnYYokw.png"/></div><figcaption class="ll lm fg fe ff ln lo bd b be z ek">a Lambda function would process relationship changes and update the social graph in real time</figcaption></figure><p id="988a" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">然后，我们通过API Gateway和Lambda公开数据，以便客户端应用程序和其他内部服务可以使用它来轻松找到建议的用户，以便用户跟踪。</p><figure class="le lf lg lh fq li fe ff paragraph-image"><div class="fe ff ml"><img src="../Images/139f97289142df38e49f57d032726893.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*tGS0KtIx9UveE9nc_plpjA.png"/></div></figure><h2 id="708e" class="mm jk hu bd jl mn mo mp jp mq mr ms jt kk mt mu jv ko mv mw jx ks mx my jz mz dt translated">未来计划</h2><p id="bf38" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">考虑到Neo4j要求你的所有图形都存储在一台机器上的限制(而且它对硬件的要求也非常苛刻)，这对我们来说不是一个长期的解决方案。</p><p id="623c" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">根据我的估计，GrapheneDB上最大的实例就足够了，直到我们拥有超过1000万用户。它是根据我们平台上每个用户的平均连接数计算出来的，并使用Twitter的用户统计数据作为我们可能达到1000万用户的指南。</p><p id="17da" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">我们可以通过转移到批处理模型并对每个用户的推荐进行预处理来进一步提高上限，从而减少针对大型图的实时查询的数量。建议可以仅限于活动用户(例如，在过去X天内登录的用户),并且仅在以下情况下:</p><ul class=""><li id="90ad" class="lt lu hu kd b ke ky kh kz kk lv ko lw ks lx kw na lz ma mb dt translated">这些建议是陈旧的，即。超过X天没有被用户操作，因此它们可能不是用户想要的；或者</li><li id="c418" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw na lz ma mb dt translated">当用户的扩展社交图发生了变化，即。追随者/被追随者有新的联系</li></ul><p id="fa6e" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">据我所知，出于可扩展性和成本原因，所有大型社交网络都使用批处理模式。</p><p id="fb30" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">至于长期的解决方案，我们还没有决定任何事情。我简单地看了一下脸书的吉拉夫，但它比我们预想的要复杂得多。还有其他“幻想”的想法，比如这篇<a class="ae kx" href="https://blog.acolyer.org/2017/05/30/mosaic-processing-a-trillion-edge-graph-on-a-single-machine/" rel="noopener ugc nofollow" target="_blank">论文</a>中描述的马赛克系统。如果我们能走到那一步，那将是一个巨大的挑战。</p><h1 id="d042" class="jj jk hu bd jl jm jn jo jp jq jr js jt ja ju jb jv jd jw je jx jg jy jh jz ka dt translated">查找趋势用户</h1><p id="bbad" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">因为我们仍然是一个小型社交网络——安装量刚刚超过80万，仅仅基于用户的社交图进行推荐是不够的，因为大多数用户的社交图都非常小。</p><p id="8a3d" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">为了弥补这一差距，我们决定在您的推荐中也包括平台上的趋势用户。</p><p id="948f" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">谢天谢地，我们所有的活动(比如X关注Y，X喜欢Y的帖子，等等。)被流式传输到Google BigQuery。我们选择BigQuery是因为AWS Athena还没有发布，而RedShift并不适合用于需要快速响应的即席实时查询。此外，我在Gamesys有多年使用BigQuery的经验，所以这在当时是显而易见的。</p></div><div class="ab cl nb nc hc nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="hn ho hp hq hr"><p id="3d1b" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated"><em class="ld"> ps。如果你对Athena和BigQuery的区别很好奇，Lynn Langit今年在无服务器的奥斯汀做了一个全面的比较。</em></p><figure class="le lf lg lh fq li"><div class="bz el l di"><div class="ni lk l"/></div></figure></div><div class="ab cl nb nc hc nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="hn ho hp hq hr"><p id="ce1c" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">为了找到有趋势的用户，我们与产品团队一起创建了一个公式，根据过去24小时内新关注者的数量来计算用户的“趋势”。关注者计数根据用户最近被关注的程度进行指数加权。例如，一个在过去一个小时关注你的人给你1分，但是一个在3个小时前关注你的人只能给你0.1分。</p><p id="51a0" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">我们用CloudWatch Events和Lambda创建了一个cron作业，每3小时对BigQuery执行一次上述查询。为了节省成本，我们的查询将只处理最近24小时内插入的事件。</p><p id="9f31" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">然后将结果保存到DynamoDB表中，每次运行结束时都会覆盖该表。</p><p id="1429" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">我们再次通过API Gateway和Lambda公开了数据。</p><figure class="le lf lg lh fq li fe ff paragraph-image"><div class="fe ff nj"><img src="../Images/93278c7f0064aeb4e39b1ecbf5265514.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*PwVrjvukdFM7s6EzfyATWg.png"/></div></figure><h1 id="63d1" class="jj jk hu bd jl jm jn jo jp jq jr js jt ja ju jb jv jd jw je jx jg jy jh jz ka dt translated">迁移到新的API</h1><p id="fa99" class="pw-post-body-paragraph kb kc hu kd b ke kf iv kg kh ki iy kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">现在，我们有了两个新的API来提供基于用户社交图的实时建议，并找到当前在我们平台上流行的用户。</p><p id="4206" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">然而，客户端应用程序需要更新以利用这些新的API。我们没有等待客户团队跟上，而是更新了遗留API的建议端点，以使用两者的结果，这样我们就可以更早地为用户提供价值。</p><blockquote class="nk nl nm"><p id="87d9" class="kb kc ld kd b ke ky iv kg kh kz iy kj nn la km kn no lb kq kr np lc ku kv kw hn dt translated">"从订货到有人说谢谢的时间是唯一重要的声誉衡量标准."—丹·诺斯</p></blockquote><p id="0e1d" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">这就是我们把所有东西放在一起的样子:</p><figure class="le lf lg lh fq li fe ff paragraph-image"><div class="fe ff nq"><img src="../Images/76ab15ff583cb8c2b3277216dced5700.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*DAn8nirTuoCEkn0rABpfUA.png"/></div></figure><p id="c521" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">这项工作最令人满意的一个方面是，我们能够以多快的速度改变这个特性，并将新系统部署到生产中。一切都在不到两周的时间内完成，这主要是因为我们能够专注于我们的业务需求，并让Lambda、BigQuery和GrapheneDB等服务来处理无差别的工作。</p></div><div class="ab cl nb nc hc nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="hn ho hp hq hr"><p id="c9a6" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">喜欢您正在阅读的内容，但需要更多帮助？我很乐意作为一名<strong class="kd hv">独立顾问</strong>提供服务，帮助您完成无服务器项目——架构审查、代码审查、构建概念验证，或者提供关于领先实践和工具的建议。</p><p id="e3d4" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">我在<strong class="kd hv">伦敦，英国</strong>，目前唯一在英国的<a class="ae kx" href="https://aws.amazon.com/developer/community/heroes/yan-cui/" rel="noopener ugc nofollow" target="_blank"> <strong class="kd hv"> AWS无服务器英雄</strong> </a>。我有近<strong class="kd hv"> 10年</strong>的<a class="ae kx" href="https://www.linkedin.com/in/theburningmonk/" rel="noopener ugc nofollow" target="_blank">经验</a>在AWS中大规模运行生产工作负载。我主要在英国开展业务，但我愿意出差一周以上。要了解我们如何合作，请在这里告诉我更多关于您试图解决的问题的信息。</p><p id="fa31" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">我还可以举办一个内部研讨会，帮助您的无服务器架构进入生产准备阶段。您可以在这里找到关于为期两天的研讨会<a class="ae kx" href="https://theburningmonk.com/workshops/" rel="noopener ugc nofollow" target="_blank">的更多信息，该研讨会将带您从AWS Lambda的基础知识一直到日志聚合、分发跟踪和安全最佳实践的通用操作模式。</a></p><p id="2399" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">如果你喜欢按照自己的进度学习，那么你也可以找到与我为曼宁制作的<a class="ae kx" href="https://bit.ly/production-ready-serverless" rel="noopener ugc nofollow" target="_blank"> <strong class="kd hv">视频课程</strong> </a>相同的研讨会内容。我们将讨论的主题包括:</p><ul class=""><li id="27e5" class="lt lu hu kd b ke ky kh kz kk lv ko lw ks lx kw na lz ma mb dt translated">认证<em class="ld"> &amp; </em>授权与API网关<em class="ld"> &amp; </em>认知</li><li id="cb0f" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw na lz ma mb dt translated">本地测试<em class="ld"> &amp; </em>运行功能</li><li id="25ea" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw na lz ma mb dt translated">CI/CD</li><li id="3af2" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw na lz ma mb dt translated">日志聚合</li><li id="649a" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw na lz ma mb dt translated">监控最佳实践</li><li id="8c34" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw na lz ma mb dt translated">X射线分布式跟踪</li><li id="8d1b" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw na lz ma mb dt translated">跟踪相关id</li><li id="880c" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw na lz ma mb dt translated">性能<em class="ld"> &amp; </em>成本优化</li><li id="1377" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw na lz ma mb dt translated">错误处理</li><li id="916b" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw na lz ma mb dt translated">配置管理</li><li id="8f57" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw na lz ma mb dt translated">金丝雀部署</li><li id="5d40" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw na lz ma mb dt translated">VPC</li><li id="908b" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw na lz ma mb dt translated">安全</li><li id="a387" class="lt lu hu kd b ke mc kh md kk me ko mf ks mg kw na lz ma mb dt translated">Lambda、Kinesis和API网关的最佳实践</li></ul><p id="2e68" class="pw-post-body-paragraph kb kc hu kd b ke ky iv kg kh kz iy kj kk la km kn ko lb kq kr ks lc ku kv kw hn dt translated">代码<strong class="kd hv"> ytcui </strong>也可以获得<strong class="kd hv">票面价格6折优惠</strong>。不过，这个数字只有在我们参加曼宁的早期访问计划(MEAP)时才有效。</p></div></div>    
</body>
</html>