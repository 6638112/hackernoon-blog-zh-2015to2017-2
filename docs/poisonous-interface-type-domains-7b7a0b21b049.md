# 有毒界面类型域

> 原文：<https://medium.com/hackernoon/poisonous-interface-type-domains-7b7a0b21b049>

![](img/c3a29211aabf5c12b071ea5628a5b923.png)

## 在接口契约中使用具有雄心勃勃的域的类型可以鼓励观察到的范围依赖并创建隐式契约。

我想副标题所说的是，实现与 int64s(除了时间值或内存地址)、字符串 id 或其他宽域原语一起工作的 API 的服务和客户端可能充满了错误，这些错误将显式接口契约与隐式契约分开。隐式契约会使服务实现的迭代变得非常困难(这对未来的你是不利的)。

一个说明性的例子将有助于进一步的教训。留下来看看最佳实践和最后的坏消息。下面的片段来自于 Docker API 的 [Swagger 定义:](https://github.com/docker/docker/blob/master/api/swagger.yaml#L2158-L2160)

```
ServiceSpec:
  ...
  properties:
    ...
    Mode:
      properties:
        ...
        Replicas:
          type: "integer"
          format: "int64"
```

暗示可能会有一个扩展到 2⁶⁴附近的任何地方的用例服务的复制品——从这个词的任何定义来看——都是雄心勃勃的。这样的接口定义有两个问题。

首先，任何人使用全值域的概率非常低。事实上，我敢打赌，观察值超过几百是非常罕见的。大于 2 ⁶的值几乎不会发生。这种差异迫使服务提供商要么接受并适当地处理任何地方的 int64，要么实现额外的输入验证并尝试传达那些域约束(顺便说一句，没人阅读文档)。在大多数情况下，会实现基本的边界检查(比如“大于零”检查)，但我很少看到代码验证上限。你认为一个 [Docker](https://hackernoon.com/tagged/docker) Swarm Manager 被要求创建一个服务的 2 个(4，294，967，296)副本会处理得怎么样？它会尝试吗？它的内部依赖项能够处理这么多副本吗？它聪明的容器名生成器如何处理压力？我不确定。

第二个问题在客户端。Docker [API](https://hackernoon.com/tagged/api) 的大多数消费者不会存储或执行关于服务副本数量的边界推动数学。但是，让我们假设你是。假设您想要构建一些自动缩放逻辑，并且需要增加或减少当前的副本数量。消费者*应该*立即注意到潜在输入域荒谬的一面，并在进行任何类型转换或上/下溢敏感操作之前将实际值拟合到某个合理的子域。如果他们将值存储在数据库中，那么他们需要确保目标列的大小适当。事实上，这两个最佳实践经常被忽略。对于无类型语言或模式生成 ORM 的用户来说，这个问题更糟糕。

这个例子并不独特。最常被滥用的原始类型之一是字符串。字符串几乎可以容纳任何东西，通常只受长度的限制。在 90 年代和 21 世纪初的一段时间里，人们都在谈论数字身份证。自动递增主键主导了关系表设计。当服务处理的事务数量开始激增时，人们开始越来越多地考虑如何避免在插入和更新期间锁定这些计数器。他们开始思考如果 ID 空间耗尽会发生什么。出现了稀疏地使用这些 ID 空间并回收在间隙中丢失的 ID 的方案。

在某个时候，人们发现了 GID 和 UUIDs。它们被认为是很酷的工具，甚至可以节省 CRUD 应用程序往返数据库的时间。人们开始定义他们所有的 id 字符串。问题是定义字符串 ID 的接口经常在后端“最初”用数字 ID 实现。你可能会猜到接下来发生了什么。

API 消费者点击了几次该服务，并注意到 ID 总是以数字的形式返回。或者他们可能使用了无类型语言的数据库模式生成器。或者 API 愚蠢地出售有序的数字 id(这也成为隐式契约的一部分),消费者从字符串中解析数字进行比较。不管是什么原因，字符串在服务接口中很难处理。

不过，我明白了。宽字体吸引人有几个原因。雄心和“未来证明”似乎是最常见的。宽类型也迎合了某些“保持简单愚蠢”或“懒惰工程师”的心态。使用较窄的类型需要对您正在构建的产品有深入的了解。确保它经得起未来的考验需要具体的工程工作和对潜在迭代和迁移工作流的洞察。选择更宽的字体可以让你快速前进。有一件重要的事情要记住…

除非你是一名律师，不介意破坏你的 API 的消费者的业务:**随着时间的推移，你的服务所处理的观察到的值的范围成为你的服务的隐含契约的一部分。**

## 最佳实践是什么？

**使用你的接口类型的完整域**。如果你出售一个 int64，你应该使用完整的域名。除非你想让消费者依赖于某个标识字段中的递增数字，否则避免使用“相对”数字。如果你使用一个字符串，你应该出售至少包含每个主要字符类的一部分的值。这意味着数字、字母(大小写混合)以及你能想到的所有符号。

如果这听起来很痛苦，你可以一直**使用较小的型号**。当您谈论服务副本的数量时，是否可以使用 int8 或 int16？这实际上取决于您的用例，但关键是尽可能多地将输入验证转化为领域问题(有点像容器将访问控制问题转化为领域问题)。

## 坏消息是

坏消息是，一旦你在一个发布的 API 中“扩大”了服务类型的有效域，就很难缩小它们。这样做通常需要对整个 API 进行版本控制，这在 SaaS 场景中意味着运行服务的两个版本。如果你可以缩小范围，那么你应该尽快这样做。在你面对一个不能迁移也不能被击垮的消费者之前，就这样做吧。在你为自己赢得 SaaS 监狱服刑之前做它。

[![](img/50ef4044ecd4e250b5d50f368b775d38.png)](http://bit.ly/HackernoonFB)[![](img/979d9a46439d5aebbdcdca574e21dc81.png)](https://goo.gl/k7XYbx)[![](img/2930ba6bd2c12218fdbbf7e02c8746ff.png)](https://goo.gl/4ofytp)

> [黑客中午](http://bit.ly/Hackernoon)是黑客如何开始他们的下午。我们是 [@AMI](http://bit.ly/atAMIatAMI) 家庭的一员。我们现在[接受投稿](http://bit.ly/hackernoonsubmission)并乐意[讨论广告&赞助](mailto:partners@amipublications.com)机会。
> 
> 如果你喜欢这个故事，我们推荐你阅读我们的[最新科技故事](http://bit.ly/hackernoonlatestt)和[趋势科技故事](https://hackernoon.com/trending)。直到下一次，不要把世界的现实想当然！

![](img/be0ca55ba73a573dce11effb2ee80d56.png)