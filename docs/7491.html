<html>
<head>
<title>The Ultimate Guide for Laravel Multi Tenant with Multi Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Laravel多租户多数据库终极指南</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/the-ultimate-guide-for-laravel-multi-tenant-with-multi-database-779ea4592783?source=collection_archive---------0-----------------------#2017-10-30">https://medium.com/hackernoon/the-ultimate-guide-for-laravel-multi-tenant-with-multi-database-779ea4592783?source=collection_archive---------0-----------------------#2017-10-30</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/99bfc3a297597b4cf38c4de4d9a875ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-xROZ8nNaVdkbs0X0P-8tA.png"/></div></div></figure><div class=""/><p id="09f1" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">不久前，我写了一篇名为<a class="ae ka" href="https://hackernoon.com/simple-multi-tenancy-with-laravel-b3f84fc13c39" rel="noopener ugc nofollow" target="_blank">简单多租户与Laravel </a>的文章。我收到了很多很好的反馈。但是那篇文章是关于一个内部管理面板工具，用户可以选择他们想要操作的租户。最近，我开始着手一个新项目，在这个项目中，经过身份验证的用户属于一个特定的租户，应该只允许从他自己的数据库中提取数据。本文是我实现这一目标的方法。</p><h2 id="5990" class="kb kc if bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">1-每个故事都从一个测试开始:PostsTest</h2><p id="fed1" class="pw-post-body-paragraph jc jd if je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">让测试驱动我的代码成了我的一种激情。多租户不应有所不同。首先，我们制定我们希望我们的测试是什么样子，然后我们让代码发生。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="6709" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是一个非常简单和公平的测试。为了让它工作，第一个要求是让<code class="eh lh li lj lk b">TenantTestCase</code>设置租户。但是在我们深入研究之前，让我们快速编写一下我们的<code class="eh lh li lj lk b">create</code>助手。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="8ecc" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ll">这是Jeffrey Way在他令人敬畏的“让我们建立一个论坛”上提出的一个干净而聪明的想法。查看</em><a class="ae ka" href="https://laracasts.com/series/lets-build-a-forum-with-laravel" rel="noopener ugc nofollow" target="_blank"><em class="ll">Laracasts</em></a><em class="ll">。</em></p><h2 id="4bbc" class="kb kc if bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">2-租户测试案例</h2><p id="09df" class="pw-post-body-paragraph jc jd if je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">从测试中我们可以预期，<code class="eh lh li lj lk b">TenantTestCase</code>类将负责创建一个新的<strong class="je ig">公司</strong>，一个新的<strong class="je ig">用户</strong>和<strong class="je ig">认证</strong>该用户。还应该设置特定于数据库的连接。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="de03" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">通过使用<code class="eh lh li lj lk b">RefreshDatabase</code>，应该可以自动迁移<strong class="je ig">主</strong>数据库。对<code class="eh lh li lj lk b">actingAs</code>的调用将建立认证。至于<strong class="je ig">用户工厂</strong>，由于用户属于一家公司，它应该递归地解析这种依赖关系。</p><h2 id="13c3" class="kb kc if bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">3-工厂</h2><p id="9c0e" class="pw-post-body-paragraph jc jd if je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated"><code class="eh lh li lj lk b">UserFactory</code>将负责为我们创建一个新用户。Laravel的默认UserFactory已经足够好了，我们只需要给它添加<code class="eh lh li lj lk b">company_id</code>字段。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="c990" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">一旦需要创建新用户，Laravel将尝试解析CompanyFactory。让我们接下来写那个。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="fec5" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><code class="eh lh li lj lk b">CompanyFactory</code>是一家新公司加入我们测试的时刻，所以我决定利用它来自动设置租户数据库连接，正如<code class="eh lh li lj lk b">PostsTest</code>所预期的那样。</p><p id="b37c" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">最后一个工厂是后工厂。出于组织的目的，我决定将我所有的主要工厂搬到<code class="eh lh li lj lk b">database/factories/main</code>并为我在<code class="eh lh li lj lk b">database/factories/tenant</code>的租户工厂腾出空间。后工厂非常简单。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><h2 id="dd36" class="kb kc if bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">tenant _ connect()和tenant_migrate()助手</h2><p id="66f5" class="pw-post-body-paragraph jc jd if je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">顾名思义，<code class="eh lh li lj lk b">tenant_connect()</code>将与租户数据库建立数据库连接。因为这是测试阶段，所以我们应该确保租户数据库接收它自己的迁移，比如posts表。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="d676" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">该文件可以放在<code class="eh lh li lj lk b">database/helpers.php</code>下。不要忘记将它添加到composer自动加载中。</p><pre class="lb lc ld le fq lm lk ln lo aw lp dt"><span id="78d8" class="kb kc if lk b fv lq lr l ls lt">"autoload": {<br/>    "classmap": [<br/>        "database/seeds",<br/>        "database/factories"<br/>    ],<br/>    "files": [<br/>        "database/helpers.php"<br/>    ],<br/>    "psr-4": {<br/>        "App\\": "app/"<br/>    }<br/>}</span></pre><p id="a388" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这就把我们带到了下一个话题:迁移。</p><h2 id="db73" class="kb kc if bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">4-主要迁移</h2><p id="c9d3" class="pw-post-body-paragraph jc jd if je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">默认的<strong class="je ig">数据库/迁移</strong>文件夹将保存主连接(用户和公司)的数据库结构。我们需要创建<strong class="je ig">公司</strong>迁移并调整<strong class="je ig">用户</strong>以容纳<code class="eh lh li lj lk b">company_id</code>字段。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="e992" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">手动创建名为<code class="eh lh li lj lk b">2014_10_12_000000_create_companies_table.php</code>的公司迁移会将其放在<code class="eh lh li lj lk b">users</code>迁移之前，这将防止任何外键冲突，因为对于要创建的用户表，公司表应该已经存在。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><h2 id="2efa" class="kb kc if bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">5-租户迁移</h2><p id="7fe5" class="pw-post-body-paragraph jc jd if je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">在第(3)项中，我们建立了一个<code class="eh lh li lj lk b">tenant_migrate()</code>方法，它将使用文件夹<code class="eh lh li lj lk b">database/migrations_tenant</code>作为租户数据库结构的源。让我们在那里创建我们的<code class="eh lh li lj lk b">create_posts_table</code>迁移。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="c4d3" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这就完成了所有必要的迁移。接下来，我们需要处理应用程序数据库设置和模型的连接。</p><h2 id="45a2" class="kb kc if bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">6-应用程序数据库设置</h2><p id="2c22" class="pw-post-body-paragraph jc jd if je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">对于数据库连接，让我们重用前一篇文章中应用的相同策略:一个<code class="eh lh li lj lk b">main</code>和一个<code class="eh lh li lj lk b">tenant</code>数据库。特别注意新的<strong class="je ig">默认</strong>连接指向<code class="eh lh li lj lk b">main</code>。另一个有趣的地方是<code class="eh lh li lj lk b">DB_DRIVER</code>变量，它允许我们在测试和实际应用之间切换SQLite和MySQL。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="17e3" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">既然我们正在讨论数据库设置，让我们花点时间来设置<code class="eh lh li lj lk b">phpunit.xml</code>文件。该文件应该包含这些变量</p><pre class="lb lc ld le fq lm lk ln lo aw lp dt"><span id="dedb" class="kb kc if lk b fv lq lr l ls lt">&lt;env name="DB_DRIVER" value="sqlite"/&gt;<br/>&lt;env name="DB_CONNECTION" value="main"/&gt;<br/>&lt;env name="DB_DATABASE" value=":memory:"/&gt;</span></pre><h2 id="b44f" class="kb kc if bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">7-模型</h2><p id="f50d" class="pw-post-body-paragraph jc jd if je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">这些模型还需要在<strong class="je ig">租户</strong>和<strong class="je ig">主</strong>模型之间进行分割。让我们在<code class="eh lh li lj lk b">App/Models</code>名称空间下创建<strong class="je ig">主模型</strong>和<strong class="je ig">租户模型</strong>。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="699b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">主连接上的表，如Companies和Users，应该扩展MainModel，而Posts表是特定于客户的数据库结构的一部分，应该扩展TenantModel。就我个人而言，我分别使用名称空间<code class="eh lh li lj lk b">App\Models\Main</code>和<code class="eh lh li lj lk b">App\Models\Tenant</code>。</p><h2 id="964b" class="kb kc if bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">7-路线</h2><p id="1b3f" class="pw-post-body-paragraph jc jd if je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">既然文章的重点是讨论租用，我们就不要浪费时间讨论路由了。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="6fc4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">就是这样！测试现在应该通过了。</p><h2 id="2b9a" class="kb kc if bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">8-总结</h2><p id="12b9" class="pw-post-body-paragraph jc jd if je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">我们从一个测试开始，这个测试创建一个Post并点击一个端点来查看它是否被返回。但是在测试执行之前，<code class="eh lh li lj lk b">TenantTestCase</code>上的<code class="eh lh li lj lk b">setUp</code>方法被调用。<br/>租户测试用例类将创建一个用户，它属于一个公司。在创建该公司的过程中，将建立一个新的数据库连接，并通过<code class="eh lh li lj lk b">tenant_migrate()</code>助手运行迁移。一旦所有这些都完成了，租户测试用例类将拥有一个被认证的用户。<br/>一旦调用了<code class="eh lh li lj lk b">/posts</code>端点，就创建了一个租户数据库并建立了一个连接。通过使用默认连接指向<code class="eh lh li lj lk b">tenant</code>的<code class="eh lh li lj lk b">Post</code>模型，它将自动从连接的数据库中获取记录。</p><p id="0920" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">所有这一切给我们一个成功的测试实施。但是实际应用呢？</p><h2 id="b5a3" class="kb kc if bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">9-租户中间件</h2><p id="eb8e" class="pw-post-body-paragraph jc jd if je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">测试是绿色的，但是实际应用不行。这是因为测试建立了一个租户连接，而应用程序没有。我们可以通过实现一个租户中间件来解决这个问题。</p><p id="6610" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ll">本文不打算实现任何类型的认证系统。您是否使用会话、Cookies或令牌并不重要。让我们把重点放在相关的部分。</em></p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="4968" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以想象一个中间件，在它与特定用户建立身份验证之前。现在，我们只需抓住用户并连接到其公司。为了让这最后一块拼图正常工作，我们需要:</p><ul class=""><li id="d0d9" class="lu lv if je b jf jg jj jk jn lw jr lx jv ly jz lz ma mb mc dt translated">a)在路由中注册中间件</li><li id="a385" class="lu lv if je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">b)创建用户所属公司关系</li><li id="bb90" class="lu lv if je b jf md jj me jn mf jr mg jv mh jz lz ma mb mc dt translated">c)从公司模型中公开一个<code class="eh lh li lj lk b">connect</code>方法。</li></ul><p id="0d82" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">a)和B)非常简单:</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><p id="a942" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对于C)我们要做两件事:检查连接是否已经建立，如果没有，调用<code class="eh lh li lj lk b">tenant_connect()</code>。</p><figure class="lb lc ld le fq hw"><div class="bz el l di"><div class="lf lg l"/></div></figure><h2 id="33fe" class="kb kc if bd kd ke kf kg kh ki kj kk kl jn km kn ko jr kp kq kr jv ks kt ku kv dt translated">10-结论</h2><p id="fb5d" class="pw-post-body-paragraph jc jd if je b jf kw jh ji jj kx jl jm jn ky jp jq jr kz jt ju jv la jx jy jz hn dt translated">我选择了呈现简单测试代码的策略作为起点，并让它一层一层地工作。它提供了一个完整的解决方案，包括测试、迁移和一个特定于租户的小功能。你可以在<a class="ae ka" href="https://github.com/deleugpn/multi-tenant" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上看到整个项目。我是不是忘了在这篇文章中加入一些必备的特性？请在下面的版块或在<a class="ae ka" href="https://twitter.com/DeleuGyN" rel="noopener ugc nofollow" target="_blank">推特</a>上告诉我吧！</p><p id="4303" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你想知道我是如何在多租户应用上处理<a class="ae ka" href="https://hackernoon.com/abstract-upgrade-command-for-multi-tenant-71089b9a838f" rel="noopener ugc nofollow" target="_blank">数据迁移的，请查看</a><a class="ae ka" href="https://hackernoon.com/abstract-upgrade-command-for-multi-tenant-71089b9a838f" rel="noopener ugc nofollow" target="_blank">这篇文章</a>。</p><p id="dd5f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">关注我在媒体上更多这样的文章。下次见！</p></div></div>    
</body>
</html>