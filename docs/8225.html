<html>
<head>
<title>How to Shutdown Your Servers In Case of Power Failure — UPS, NUT &amp; Co.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在停电时关闭服务器——UPS、NUT &amp; Co</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/how-to-shutdown-your-servers-in-case-of-power-failure-ups-nut-co-34d22a08e92?source=collection_archive---------4-----------------------#2017-11-24">https://medium.com/hackernoon/how-to-shutdown-your-servers-in-case-of-power-failure-ups-nut-co-34d22a08e92?source=collection_archive---------4-----------------------#2017-11-24</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/a16f40a4231187bc77b2278b756c35cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rNdvA98b9VxSHluFzd5a-A.jpeg"/></div></div></figure><div class=""/><p id="49f3" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们学校总是停电。有时它们只持续几秒钟，有时持续几个小时。为了确保我们的IT基础设施不会受到影响，我们为我们的服务器和网络设备安装了UPS。这些有助于弥补短时间停电(长达1小时)或电流波动。对于任何长时间的停电，当UPS达到临界电池电量时，我们会自动关闭我们的服务器。为此，我们使用NUT(网络UPS工具)。</p><p id="57c2" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们的设置由以下组件组成:</p><ul class=""><li id="7f7a" class="ka kb if je b jf jg jj jk jn kc jr kd jv ke jz kf kg kh ki dt translated"><a class="ae kj" href="https://amzn.to/2HOnPde" rel="noopener ugc nofollow" target="_blank"> Raspberry Pi </a>作为UPS服务器或主服务器</li><li id="baf6" class="ka kb if je b jf kk jj kl jn km jr kn jv ko jz kf kg kh ki dt translated"><a class="ae kj" href="https://amzn.to/2MMgQjR" rel="noopener ugc nofollow" target="_blank"> Liebert GXT4 UPS </a></li><li id="310f" class="ka kb if je b jf kk jj kl jn km jr kn jv ko jz kf kg kh ki dt translated">作为客户端或从属服务器</li></ul><h1 id="3736" class="kp kq if bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm dt translated">在树莓皮上设置螺母</h1><p id="26b5" class="pw-post-body-paragraph jc jd if je b jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz hn dt translated">对于树莓派，我们使用标准的<a class="ae kj" href="https://www.raspberrypi.org/downloads/raspbian/" rel="noopener ugc nofollow" target="_blank"> Raspian Stretch Lite图像</a>。注意，从2016年开始，SSH就没有默认启用了。这里的记录了重新激活SSH的不同方式<a class="ae kj" href="https://www.raspberrypi.org/documentation/remote-access/ssh/" rel="noopener ugc nofollow" target="_blank">。重新激活SSH后，您现在可以登录树莓Pi(树莓Pi的IP可以通过<em class="ls"> avahi-browse -ar </em>从同一网络中的计算机上找到，或者您可以连接显示器和键盘)。我们以后会需要这个IP，所以给树莓派一个静态IP是有意义的。</a></p><p id="8fe8" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，我们安装NUT服务器</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="9239" class="mc kq if ly b fv md me l mf mg">sudo apt-get install nut-client nut-server usbutils</span></pre><p id="6c7f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果UPS通过USB连接(如我们的情况)，您可以使用<em class="ls"> lsusb </em>检查它是否被检测到。这是Raspberry Pi的输出结果:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="2321" class="mc kq if ly b fv md me l mf mg">$ lsusb<br/>Bus 001 Device 004: ID 10af: 0000 Liebert Corp. UPS<br/>Bus 001 Device 003: ID 0424: ec00 Standard Microsystems Corp. SMSC9512/9514 Fast Ethernet Adapter<br/>Bus 001 Device 002: ID 0424:9514 Standard Microsystems Corp. <br/>Bus 001 Device 001: ID 1d6b: 0002 Linux Foundation 2.0 root hub</span></pre><p id="3517" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在第一行中，您可以看到我们的Liebert UPS得到了认可。</p><p id="85e0" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在我们必须在文件<em class="ls"> /etc/nut/ups.conf </em>中配置我们的UPS。对于我们的UPS，条目如下所示:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="465c" class="mc kq if ly b fv md me l mf mg">[gxt4]<br/>  driver = usbhid-ups<br/>  port = car<br/>  productid = 0000<br/>  desc = “Emerson Liebert GXT 4”</span></pre><p id="f6d3" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在网络UPS工具网站上，您可以找到所有受支持的UPS的列表，以及哪个驱动程序工作得最好。</p><p id="b178" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，我们要测试设置是否正确，UPS守护程序是否可以与UPS通信。为此，我们从<strong class="je ig"> upsd </strong>开始</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="cb31" class="mc kq if ly b fv md me l mf mg">sudo upsdrvctl start</span></pre><p id="d7b9" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">成功的输出应该如下所示:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="04ab" class="mc kq if ly b fv md me l mf mg">Network UPS Tools — UPS driver controller 2.7.2<br/>Network UPS Tools — Generic HID driver 0.38 (2.7.2)<br/>USB communication driver 0.32<br/>Using subdriver: Belkin HID 0.16</span></pre><p id="cd7a" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">NUT包含一个小程序，用于测试与UPS的通信。称为<strong class="je ig"> upsc </strong>，输出所有可读的UPS参数。</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="ad7c" class="mc kq if ly b fv md me l mf mg">$ upsc gxt4<br/>Init SSL without certificate database<br/>battery.charge: 100<br/>battery.charge. low: 20<br/>battery.charge. warning: 0<br/>battery.type: PbAc<br/>battery.voltage: 0.0<br/>battery.voltage. nominal: 0.0<br/>device.mfr: Emerson Network Power<br/>device.model: Liebert GXT4<br/>device.serial: 1607000060AFC23<br/>device.type: ups<br/>driver.name: usbhid-ups<br/>driver.parameter. pollfreq: 30<br/>driver.parameter. pollinterval: 2<br/>driver.parameter. port: auto<br/>driver.parameter. productid: 0000<br/>driver.version: 2.7.2<br/>driver.version. data: Belkin HID 0.16<br/>driver.version. internal: 0.38<br/>ups.mfr: Emerson Network Power<br/>ups.model: Liebert GXT4<br/>ups.productid: 0000<br/>ups.serial: 1607000060AFC23<br/>ups.status: OL CHRG<br/>ups.vendorid: 10af</span></pre><p id="5338" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在我们的UPS安装成功了。接下来，我们设置了NUT服务器、UPS monitor <strong class="je ig"> upsmon </strong>和另外两个用于主服务器和从服务器的用户。</p><h1 id="4756" class="kp kq if bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm dt translated">配置NUT服务器</h1><p id="27f6" class="pw-post-body-paragraph jc jd if je b jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz hn dt translated">在<em class="ls"> /etc/nut/nut/nut.conf </em>中我们指定树莓派是我们的主人:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="be02" class="mc kq if ly b fv md me l mf mg">MODE=netserver</span></pre><p id="0927" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">UPS守护程序(<strong class="je ig"> upsd </strong>)正在NUT服务器上运行。它负责与UPS的(物理)连接。各个客户端/从机使用<strong class="je ig"> upsmon </strong>来访问UPS的状态。通过这种方式，多个客户端可以始终知道UPS的状态，并且在必要时，当UPS提供“电池电量低”状态时启动关机。</p><p id="f968" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了让我们的NUT服务器可以从网络上访问，必须将下面几行添加到<em class="ls"> /etc/nut/upsd.conf </em>(请调整IP):</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="fc28" class="mc kq if ly b fv md me l mf mg">LISTEN 127.0.0.0.1<br/>LISTEN 192.168.1.2 #IP of the Raspberry Pis</span></pre><p id="5825" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">接下来，我们定义客户端可以用来登录到主服务器的用户(在文件<em class="ls"> /etc/nut/upsd.user </em>中):</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="937e" class="mc kq if ly b fv md me l mf mg">[upsmaster]<br/>  password = secret<br/>  upsmon master</span><span id="6a2f" class="mc kq if ly b fv mh me l mf mg">[upremote]<br/>  password = secret<br/>  upsmon slave</span></pre><p id="8318" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了让<strong class="je ig"> upsmon </strong>监控UPS，我们现在需要在<em class="ls"> /etc/nut/upsmon.conf </em>中添加一个最终条目:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="6f07" class="mc kq if ly b fv md me l mf mg">MONITOR gxt4@localhost 1 upsmaster secret master</span></pre><p id="3e37" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为了知道所有服务是否都正常运行，您可以使用以下命令检查Raspberry Pi上的服务器和本地客户端的状态(因为当没有更多电源时它应该关闭):</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="7110" class="mc kq if ly b fv md me l mf mg">$ sudo systemctl status nut-server<br/>$ sudo systemctl status user-client</span></pre><p id="2e21" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在我们的主机已经设置好了，可以配置客户机或从机了。</p><h1 id="dad3" class="kp kq if bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm dt translated">设置客户端/从属设备(例如服务器、其他计算机)</h1><p id="c9fd" class="pw-post-body-paragraph jc jd if je b jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz hn dt translated">首先，必须在客户机上安装必要的软件包:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="df53" class="mc kq if ly b fv md me l mf mg">sudo apt-get install nut-client</span></pre><p id="f38e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这次我们只需要编辑两个文件。在<em class="ls"> /etc/nut/nut/nut.conf </em>中我们设置了模式:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="7095" class="mc kq if ly b fv md me l mf mg">MODE=netclient</span></pre><p id="6dd4" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后我们需要告诉<strong class="je ig"> upsmon </strong>要监控哪个UPS(在<em class="ls"> /etc/nut/upsmon.conf </em>中):</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="64a4" class="mc kq if ly b fv md me l mf mg">MONITOR gxt4@192.168.1.2 upsremote secret slave</span></pre><p id="0550" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">必须调整IP和密码。还请注意结尾的奴隶！最后，重新启动相应的服务，并检查一切都在运行:</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="bc4c" class="mc kq if ly b fv md me l mf mg">$ sudo systemctl restart user-client<br/>$ sudo systemctl status user-client</span></pre><p id="0975" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">恭喜你！现在一切都应该设置好了，但是如何测试它是否真的工作呢？</p><h1 id="6c2a" class="kp kq if bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm dt translated">测试关机</h1><p id="e5cb" class="pw-post-body-paragraph jc jd if je b jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz hn dt translated">以下命令触发关机信号(就像断电时一样):</p><pre class="lt lu lv lw fq lx ly lz ma aw mb dt"><span id="a037" class="mc kq if ly b fv md me l mf mg">$ sudo upsmon -c fsd</span></pre><h1 id="3a18" class="kp kq if bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm dt translated">结论</h1><p id="ca89" class="pw-post-body-paragraph jc jd if je b jf ln jh ji jj lo jl jm jn lp jp jq jr lq jt ju jv lr jx jy jz hn dt translated">NUT是另一个伟大的开源项目，它允许非常灵活的定制。<a class="ae kj" href="http://rogerprice.org/NUT/ConfigExamples.A5.pdf" rel="noopener ugc nofollow" target="_blank">这个PDF </a>包含了更多(复杂)的应用场景。当我写这篇文章的时候，我们又停电了，我们所有的服务器都关闭了:)</p></div><div class="ab cl mi mj hc mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="hn ho hp hq hr"><p id="b162" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这篇文章最初发表在openschoolsolutions.org的<a class="ae kj" href="https://openschoolsolutions.org/shutdown-servers-case-power-failure%e2%80%8a-%e2%80%8aups-nut-co/" rel="noopener ugc nofollow" target="_blank">上。<em class="ls">在推特上关注</em></a><a class="ae kj" href="https://twitter.com/OpenSchoolZ" rel="noopener ugc nofollow" target="_blank"><em class="ls">@ OpenSchoolZ</em></a><em class="ls">。</em></p></div></div>    
</body>
</html>