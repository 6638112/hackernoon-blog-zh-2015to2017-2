<html>
<head>
<title>Offline First React Native + Meteor Apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">离线先反应原生+流星应用</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/offline-first-react-native-meteor-apps-2bee8e976ec7?source=collection_archive---------6-----------------------#2017-02-08">https://medium.com/hackernoon/offline-first-react-native-meteor-apps-2bee8e976ec7?source=collection_archive---------6-----------------------#2017-02-08</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/09959149ea00c2d8ee440fd8656d6b23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G2o_oYIOqY1KKEUnBWgi3w.jpeg"/></div></div></figure><div class=""/><p id="4955" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在我的<a class="ae ka" href="http://learn.handlebarlabs.com/p/react-native-meteor" rel="noopener ugc nofollow" target="_blank"> <em class="kb">学习React Native + Meteor </em> </a>课程的学生中，以及在react-native-meteor 的<a class="ae ka" href="https://github.com/inProgress-team/react-native-meteor/issues/154" rel="noopener ugc nofollow" target="_blank">问题上，咨询电话中多次出现的一个话题是离线支持。简而言之，我如何才能让我的React Native + Meteor app离线工作？</a></p><p id="2f73" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我以前也想过这个问题，但是从来没有得出一个很好的结论——尤其是对于来自出版物的数据。我以前总是想到的解决方案依赖于用户必须在他们的应用程序中设置Redux。</p><p id="481b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">通过各种对话，我发现许多人<em class="kb">没有</em>在他们的React Native + Meteor应用程序中使用Redux，这很好。Minimongo做了很多和Redux一样的事情，这也是Meteor开发者所习惯的。</p><h2 id="0d73" class="kc kd if bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">问题是</h2><p id="1892" class="pw-post-body-paragraph jc jd if je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">在offline first应用程序的基础上构建有许多问题——将数据保存到客户端以便它可以离线工作，协调离线时采取的操作/方法，以及最大限度地减少任何重复的订阅数据。</p><h2 id="ef49" class="kc kd if bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">目标</h2><p id="723c" class="pw-post-body-paragraph jc jd if je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">在这篇文章中，我将尝试在客户端上保存通过Meteor订阅带来的数据，以便用户下次启动应用程序时数据就在那里了。它的主要目标是让用户一打开应用程序就能获得有用的体验，而不必等待订阅完成或依赖互联网连接。</p><p id="2741" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">数据应保留在设备上，直到收到删除该文档的消息。</p><h2 id="6b05" class="kc kd if bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">战略</h2><p id="b19a" class="pw-post-body-paragraph jc jd if je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">我可以发布一个包并告诉你使用它，但我想这是一个需要一些时间来发展成真正可用的解决方案，涵盖多种用例。因此，在本文中，我们将介绍如何在您自己的应用程序中实现该逻辑，以便您可以使用它、理解它、试验它并提供反馈。</p><p id="6bc5" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">在深入实现之前，我必须表扬一下开发了一个包<code class="eh le lf lg lh b">react-native-meteor-redux</code>的<a class="lc ld gr" href="https://medium.com/u/891791be2659?source=post_page-----2bee8e976ec7--------------------------------" rel="noopener" target="_blank"> Julian_Kingman </a>，我用它作为我将要介绍的大部分内容的起点。如果你已经在你的应用程序中使用Redux，他的解决方案可以很好地工作，但是我想要一个更简单的实现。</p><p id="e2bf" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">为此，我们将监听三个ddp消息— <code class="eh le lf lg lh b">added</code>、<code class="eh le lf lg lh b">changed</code>和<code class="eh le lf lg lh b">removed</code>。我们还将在幕后实现redux，以便我们可以使用优秀的<code class="eh le lf lg lh b">redux-persist</code>库来实际处理将数据保存到磁盘以及自动“再水合”数据的能力。</p><h2 id="b6a2" class="kc kd if bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">履行</h2><p id="71bd" class="pw-post-body-paragraph jc jd if je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">我们正在构建的应用程序将非常简单。流星应用将只是运行<code class="eh le lf lg lh b">meteor create --full MeteorApp</code>的结果。然后，我们将能够使用在那里创建的web界面来修改数据。在react native方面，我在<code class="eh le lf lg lh b">react-native-elements </code>的帮助下创建了一个非常简单的应用程序，它列出了项目，然后允许我们添加新的链接。为了保持本教程的重点,“新”链接将从一个数组链接中随机选择。</p><p id="7c41" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们还将显示应用程序的DDP连接状态，这表明我们是否连接到了Meteor服务器。</p><p id="af0d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">您可以按照以下步骤创建基本应用程序。</p><pre class="li lj lk ll fq lm lh ln lo aw lp dt"><span id="94af" class="kc kd if lh b fv lq lr l ls lt">react-native init RNDemo<br/>npm i --save lodash redux react-native-elements react-native-meteor react-native-vector-icons redux redux-logger redux-persist<br/>react-native link react-native-vector-icons</span></pre><p id="913b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后将这个文件的<a class="ae ka" href="https://gist.github.com/spencercarli/e4f2535ee6314d53952f982993d32e62" rel="noopener ugc nofollow" target="_blank">内容复制粘贴到你的app入口点。现在，您应该能够理解本教程了。在这篇文章的最后有一个完整的Github链接。</a></p><figure class="li lj lk ll fq hw fe ff paragraph-image"><div class="fe ff lu"><img src="../Images/d71473fcd8f1db430680932b34c356a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:764/format:webp/1*kgdPB88HFbA6fz-Rp9bdgw.png"/></div></figure><p id="fe7f" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们要做的第一件事是为这个离线功能设置我们的公共API。我将在<code class="eh le lf lg lh b">react-native-meteor-offline.js</code>中工作并导出一个<code class="eh le lf lg lh b">initializeMeteorOffline</code>函数，该函数将在我调用<code class="eh le lf lg lh b">Meteor.connect</code>后被直接调用。</p><figure class="li lj lk ll fq hw"><div class="bz el l di"><div class="lv lw l"/></div></figure><figure class="li lj lk ll fq hw"><div class="bz el l di"><div class="lv lw l"/></div></figure><p id="fc1b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这就是我们在现有的Meteor应用程序中要做的所有工作。</p><p id="d61c" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，在我们的<code class="eh le lf lg lh b">initializeMeteorOffline</code>函数中，我们想要监听一些与订阅响应相关的DDP消息。<code class="eh le lf lg lh b">react-native-meteor</code>通过在<code class="eh le lf lg lh b">Meteor.ddp</code>公开DDP连接，我们可以监听其上的事件，从而使这变得简单。</p><figure class="li lj lk ll fq hw"><div class="bz el l di"><div class="lv lw l"/></div></figure><p id="de1d" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果你在<code class="eh le lf lg lh b">localhost:3000</code>运行了一个meteor应用程序，此时你可能会在你的控制台上看到大量消息。这是我们将用来通过redux将数据保存到磁盘的信息，以便用户可以有一个可用的离线体验。</p><figure class="li lj lk ll fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff lx"><img src="../Images/89d2c000fe97e9493c8dcea15a9e11ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DwkFDUPS5bgdw2_HOHTbaQ.png"/></div></div></figure><p id="cb92" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">保持这一点的第一步是设置Redux存储。我不会深入Redux的细节，但我们的商店是我们“存储”所有数据的地方——命名很棘手，是吧？我们还将利用一个便利的包，<code class="eh le lf lg lh b">redux-logger</code>，它将帮助我们深入了解Redux正在发生的事情。</p><figure class="li lj lk ll fq hw"><div class="bz el l di"><div class="lv lw l"/></div></figure><p id="11a6" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">配置好存储之后，我们就可以开始对这三个DDP消息中的任何一个进行调度操作。这将允许reducer根据消息的类型做出正确的响应，然后更新磁盘上的数据。</p><figure class="li lj lk ll fq hw"><div class="bz el l di"><div class="lv lw l"/></div></figure><figure class="li lj lk ll fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff ly"><img src="../Images/02446ad47855c05c45d311845a87529e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wuWFEvFyHGvD-r1c5ok3Jg.png"/></div></div></figure><p id="62aa" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，我们需要使用reducer在分派某些动作时实际更新我们的存储。这将是我们的大部分代码，它所做的就是逐步用我们所有的数据建立一个对象，如果有必要的话修改任何部分，最后当服务器要求时删除任何数据。如果你发现任何错误，请让我知道。</p><figure class="li lj lk ll fq hw"><div class="bz el l di"><div class="lv lw l"/></div></figure><p id="6e7b" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后，我们能够通过<code class="eh le lf lg lh b">redux-logger</code>检查我们的redux存储是否被正确更新。</p><figure class="li lj lk ll fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff lz"><img src="../Images/908a0fa1639cd6f47a765c730225a220.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xaotbLRu9DIJk35WpWCayw.png"/></div></div></figure><p id="efbd" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们需要完成的最后一项工作是通过AsyncStorage将我们正在写入Redux的数据持久化到磁盘，然后在应用程序启动时用这些数据填充我们的minimongo-cache。<code class="eh le lf lg lh b">redux-persist</code>让我们很容易做到这一点。</p><p id="b2ed" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先，我们必须告诉<code class="eh le lf lg lh b">redux-persist</code>我们想把什么存储保存到磁盘，并告诉它一个存储引擎(在我们的例子中是AsyncStorage)。我们还将利用一些其他选项来提高性能和互操作性。我们将通过“去抖动”写入磁盘的频率来提高性能，这是一个开销很大的操作，意味着写入磁盘将每隔X毫秒发生一次(默认为1000毫秒)。我们还将尝试通过设置一个惟一的键来在AsyncStorage中保存数据，从而提高互操作性。这样，如果你已经在应用中使用了<code class="eh le lf lg lh b">redux-persist</code>，它们之间的数据将不会被覆盖。</p><p id="eec0" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后，我们希望告诉Redux使用首次初始化时保存在磁盘上的信息自动恢复存储。这将是有益的，因为我们从磁盘读取数据的速度比从网络读取数据的速度更快，并且我们可以确保用户上次使用该应用程序时存在的最后一个数据集仍在设备上。</p><figure class="li lj lk ll fq hw"><div class="bz el l di"><div class="lv lw l"/></div></figure><p id="0556" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您现在查看控制台日志，您应该会看到一个新的调度操作，并且应该是您看到的第一个操作。</p><figure class="li lj lk ll fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff ma"><img src="../Images/ba15f255b19e2f2779aebf13512d6581.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zBe1CdiQokfqGGoBXH5fKw.png"/></div></div></figure><p id="70d3" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这是从磁盘中提取数据，然后从中填充Redux存储，所有这些都是在我们连接到DDP服务器之前完成的。但是我们还没有完成。虽然我们的Redux商店有我们的缓存数据，但实际的流星应用程序没有。为此，我们需要在成功再水合后将数据插入minimongo-cache。</p><figure class="li lj lk ll fq hw"><div class="bz el l di"><div class="lv lw l"/></div></figure><p id="336e" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这将遍历我们在商店中拥有的所有数据，然后将其插入minimongo-cache，这就是我们的Meteor应用程序所使用的。然后你可以像平常一样使用<code class="eh le lf lg lh b">Meteor.collection('links').find()</code>，即使是离线。</p><p id="5437" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae ka" href="https://gist.github.com/spencercarli/f9aff1633f25a6ea9b4d6c3f4685559d" rel="noopener ugc nofollow" target="_blank">Github</a>上有完整的文件。</p><h2 id="8809" class="kc kd if bd ke kf kg kh ki kj kk kl km jn kn ko kp jr kq kr ks jv kt ku kv kw dt translated">测试</h2><p id="bd6d" class="pw-post-body-paragraph jc jd if je b jf kx jh ji jj ky jl jm jn kz jp jq jr la jt ju jv lb jx jy jz hn dt translated">视频有时比文字更容易。我已经录制了一个简短的视频来演示这个代码的功能。</p><figure class="li lj lk ll fq hw"><div class="bz el l di"><div class="mb lw l"/></div></figure><p id="a536" class="pw-post-body-paragraph jc jd if je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><a class="ae ka" href="https://github.com/spencercarli/react-native-meteor-offline-example" rel="noopener ugc nofollow" target="_blank">Github上的示例应用</a></p><blockquote class="mc"><p id="678d" class="md me if bd mf mg mh mi mj mk ml jz ek translated">有兴趣了解更多关于React Native + Meteor的知识吗？<a class="ae ka" href="http://www.handlebarlabs.com/email-list/" rel="noopener ugc nofollow" target="_blank">注册我的电子邮件列表</a>，我可以帮忙！</p></blockquote><div class="mm mn mo mp mq ab cb"><figure class="mr hw ms mt mu mv mw paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mr hw ms mt mu mv mw paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mr hw ms mt mu mv mw paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mx my mz"><p id="f922" class="jc jd kb je b jf jg jh ji jj jk jl jm na jo jp jq nb js jt ju nc jw jx jy jz hn dt translated"><a class="ae ka" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae ka" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae ka" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae ka" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jc jd kb je b jf jg jh ji jj jk jl jm na jo jp jq nb js jt ju nc jw jx jy jz hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae ka" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae ka" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="li lj lk ll fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff nd"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure></div></div>    
</body>
</html>