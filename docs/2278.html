<html>
<head>
<title>Migrating 140,000 commits from Mercurial to Git</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将140，000个提交从Mercurial迁移到Git</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/migrating-140-000-commits-from-mercurial-to-git-5cf46f134261?source=collection_archive---------4-----------------------#2017-01-17">https://medium.com/hackernoon/migrating-140-000-commits-from-mercurial-to-git-5cf46f134261?source=collection_archive---------4-----------------------#2017-01-17</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="8ac4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最近，我自愿负责将我的团队从Mercurial迁移到Git。公司的大部分人已经使用Git几个月了，这个特殊的库——我的团队只使用了其中的一小部分——是Hg (Mercurial)中最大的库。</p><p id="d684" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在过去的6年里，这个存储库被用作各种项目的单一报告。大约有50个Visual Studio解决方案引用了200多个项目，总历史记录接近140，000次提交。“嘟——ch。hg/`告诉我历史超过1GB，还有` du -ch。/* `报告当前内容达到大约800MB。我这次迁移的目标之一是提高存储库的性能，因为从头开始克隆存储库是一整天的事情，我尝试过的Hg GUI工具都在历史的重压下苦苦挣扎。幸运的是，在根级别的180个文件夹中，我的团队只关心1个。</p><p id="a162" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">那么，我怎样才能在不破坏所有历史的情况下移除我们不用的东西呢？</p></div><div class="ab cl jp jq hc jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hn ho hp hq hr"><p id="b211" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，我研究了有哪些工具可以在保存历史的同时将Hg存储库转换成Git。GitHub实际上提供了一个<a class="ae jw" href="https://help.github.com/articles/about-github-importer/" rel="noopener ugc nofollow" target="_blank">存储库导入器</a>，可以在创建新的repo时从Hg导入，还有一个名为<a class="ae jw" href="https://github.com/frej/fast-export" rel="noopener ugc nofollow" target="_blank">的开源项目fast-export </a>，可以在本地做同样的事情。后来在这个过程中，我还发现了宣传类似功能的<a class="ae jw" href="https://www.mercurial-scm.org/wiki/ConvertExtension" rel="noopener ugc nofollow" target="_blank">Mercurial ConvertExtension</a>。</p><p id="f33d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我最初的努力并不令人鼓舞。转换140k的历史条目需要一段时间，所以直到大约一个半小时后，我才从GitHub importer那里得到消息，存储库太大，无法导入，又过了45分钟,“快速导出”失败，并出现一个关于提交日期无效的错误。Drat。使用'- force '再次尝试快速导出，通过了第一个错误，但在转换过程中的另一个无效日期失败。我后来知道这些错误不是由日期引起的，这只是一个症状。</p><p id="7dc0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">鉴于这些错误发生在几个月前的修订版上，而且我无论如何都想减小存储库的大小，我开始寻找一种方法在转换到Git之前删除历史。我发现<a class="ae jw" href="https://www.mercurial-scm.org/wiki/ConvertExtension" rel="noopener ugc nofollow" target="_blank">Mercurial convert extension</a>据称可以进行Hg &gt; Hg转换(以及更多),并提供从特定版本开始、从历史中过滤文件的选项，以及各种强大的选项。但是，它总是失败，并出现一个关于无效压缩类型的模糊错误，大约是历史记录的四分之三(` Abort: invalid compression type 'k '和` compression type '6 '都出现过。没什么帮助)。IRC、StackOverflow和多年的邮件列表都无法帮助我让它工作，在一天没有进展之后，我不得不放弃这个看起来很有前途的工具。</p><p id="8742" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">经历了这些失败后，我和一位过去做过类似转变的同事聊了聊。他给我指了“快速导出”和两个用于大规模修改历史的工具，分别叫做<a class="ae jw" href="https://git-scm.com/docs/git-filter-branch" rel="noopener ugc nofollow" target="_blank"> git-filter-branch </a>和<a class="ae jw" href="https://rtyley.github.io/bfg-repo-cleaner/" rel="noopener ugc nofollow" target="_blank"> BFG回购清理器</a>。他还提到了我看到的同样的无效日期问题，并给我指出了一个解决方案——错误不是日期，而是一个空作者导致了列错位。用那个“authors.txt”文件运行“快速导出”成功了！大约一个小时后，我有了一个等效的Git存储库，并有了备份，这样我就可以随心所欲地修改历史，而不必从头开始重新导出。为了使它与我的同事所做的更改保持同步，只要导出的Git repo没有任何新内容，fast-export就会进行增量导出。</p><p id="cc56" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在我在Git中有了我们的完整历史，我可以开始尝试将其缩减到可管理的大小。</p><p id="8699" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">BFG Repo-Cleaner的一些试运行表明，它非常擅长这项工作，在一两分钟内将` . git '文件夹的大小从导出后的大约1.6GB减少到大约100MB。但它仍然留给我相同数量的提交，这意味着有成千上万的空修订堵塞了历史。“git-filter-branch”支持使用“- prune-empty”来修剪空提交，但是一些实验表明，完全处理历史记录需要2个多小时。</p><p id="e84d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">幸运的是，不仅有人<a class="ae jw" href="https://github.com/rtyley/bfg-repo-cleaner/pull/147" rel="noopener ugc nofollow" target="_blank">开了一个PR </a>给BFG回购清理器添加了“prune-empty-commits ”,而且当它在几个月后还没有合并时，他们<a class="ae jw" href="https://github.com/rtyley/bfg-repo-cleaner/pull/147#issuecomment-224770369" rel="noopener ugc nofollow" target="_blank">发布了一个. jar！</a>有了这个。jar和新的标志，git历史记录已经从大约14万次提交减少到大约3万次，而`. Git `文件夹减少到大约70MB。仍然是一个大的回购，但一个巨大的，巨大的改进。为了彻底起见，我随后运行了“git filter-branch - prune-empty ”,看看是否有更多的提交需要查找。它将历史记录减少到大约27k次提交，花费了大约25分钟——这是一个小改进，需要花费相当长的时间，但对于一次性迁移来说还是值得的。</p><p id="0090" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最终，我不得不编写两个脚本来自动化这个过程。一个脚本在我们需要保留的每个分支上运行，删除不必要的文件并创建一个`. gitignore `,另一个“协调”脚本执行整个repo范围的任务，如重命名和删除分支，在每个分支上运行另一个脚本，从历史记录中删除删除的文件，并对git repo进行垃圾收集。</p><p id="d352" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">概括地说，在迁移之前，我们有:</p><ul class=""><li id="b2c6" class="jy jz hu it b iu iv iy iz jc ka jg kb jk kc jo kd ke kf kg dt translated">6年的历史</li><li id="4464" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">1.2GB英寸。汞</li><li id="4e67" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">800MB的当前文件</li><li id="575f" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">大约50个Visual Studio解决方案</li><li id="9046" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">大约200个Visual Studio项目</li><li id="cff2" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">140，000次提交</li><li id="e813" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">大约180个我的团队不使用的顶级文件夹</li></ul><p id="6c7a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">迁移之后，我们只剩下:</p><ul class=""><li id="fb4a" class="jy jz hu it b iu iv iy iz jc ka jg kb jk kc jo kd ke kf kg dt translated">仍然有6年的历史</li><li id="4682" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">70MB英寸。饭桶</li><li id="439e" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">15MB的当前文件</li><li id="71a2" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">0个解决方案</li><li id="174a" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">0个项目</li><li id="7dab" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">27，000次提交</li><li id="f88a" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">没有我们不用的文件</li></ul><p id="680a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">成功使用的工具:</p><ul class=""><li id="53c8" class="jy jz hu it b iu iv iy iz jc ka jg kb jk kc jo kd ke kf kg dt translated"><a class="ae jw" href="https://github.com/frej/fast-export" rel="noopener ugc nofollow" target="_blank">快速导出</a>，以及<a class="ae jw" href="https://github.com/frej/fast-export/issues/15#issuecomment-65903469" rel="noopener ugc nofollow" target="_blank">自定义authors.txt </a></li><li id="5af9" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated"><a class="ae jw" href="https://rtyley.github.io/bfg-repo-cleaner/" rel="noopener ugc nofollow" target="_blank"> BFG回购清洁器</a>(以及一个未发布的<a class="ae jw" href="https://github.com/rtyley/bfg-repo-cleaner/pull/147#issuecomment-224770369" rel="noopener ugc nofollow" target="_blank">罐子</a></li><li id="e1f9" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated"><a class="ae jw" href="https://git-scm.com/docs/git-filter-branch" rel="noopener ugc nofollow" target="_blank"> git-filter-branch </a></li><li id="783a" class="jy jz hu it b iu kh iy ki jc kj jg kk jk kl jo kd ke kf kg dt translated">一些定制的bash脚本将它们结合在一起。</li></ul><p id="05e8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我的经验教训:</p><p id="4484" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">改变SCM系统和大规模修改历史的过程实际上比我想象的要容易得多。我带着对Hg的负面印象离开；它允许将导致多个工具失败的损坏提交到历史中。操作Git历史的工具比ConvertExtension简单得多。我花了很多时间阅读文档，并在IRC上询问相关问题，但我从未感觉到自己离理解它应该如何配置更近了一步。这给了我另一个证明，不管你认为你的问题有多奇怪和独特，其他人已经做了同样的事情。</p><blockquote class="km kn ko"><p id="1c81" class="ir is jx it b iu iv iw ix iy iz ja jb kp jd je jf kq jh ji jj kr jl jm jn jo hn dt translated"><a class="ae jw" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jw" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jw" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae jw" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="dca4" class="ir is jx it b iu iv iw ix iy iz ja jb kp jd je jf kq jh ji jj kr jl jm jn jo hn dt translated">要了解更多信息，请<a class="ae jw" href="https://goo.gl/4ofytp" rel="noopener ugc nofollow" target="_blank">阅读我们的“关于”页面</a>、<a class="ae jw" href="http://bit.ly/HackernoonFB" rel="noopener ugc nofollow" target="_blank">在脸书上点赞/给我们发消息</a>，或者简单地说，<a class="ae jw" href="https://goo.gl/k7XYbx" rel="noopener ugc nofollow" target="_blank"> tweet/DM @HackerNoon。</a></p><p id="708a" class="ir is jx it b iu iv iw ix iy iz ja jb kp jd je jf kq jh ji jj kr jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jw" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jw" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote></div></div>    
</body>
</html>