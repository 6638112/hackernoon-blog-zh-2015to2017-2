<html>
<head>
<title>A Collision Too-Perfect</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">碰撞太完美了</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/a-collision-too-perfect-279a47fb5d42?source=collection_archive---------5-----------------------#2017-07-14">https://medium.com/hackernoon/a-collision-too-perfect-279a47fb5d42?source=collection_archive---------5-----------------------#2017-07-14</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="8d66" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">厚脸皮的可执行文件，MD5和SHA1哈希是平等的，不同的运行输出(“吃更多的哈希”挑战写)</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff jp"><img src="../Images/6f8959c6757d953a423c80732493441f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CIVl9rK123fe-ysL.jpg"/></div></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">Licensed cc-by Anonymous <a class="ae kf" href="http://openwalls.com/image?id=399" rel="noopener ugc nofollow" target="_blank">http://openwalls.com/image?id=399</a></figcaption></figure><p id="70d8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在<em class="kg"> </em> <a class="ae kf" href="https://shattered.io/" rel="noopener ugc nofollow" target="_blank">第一次实际的SHA1碰撞攻击</a>公开后不久，一个有点简短扼要的<a class="ae kf" href="https://roastingbugs.blogspot.co.il/2017/03/eat-more-hashes.html" rel="noopener ugc nofollow" target="_blank">挑战</a>悬而未决，一个完全意识到我对挑战上瘾的团队成员向我释放了它(谢谢，柳文欢)，可以理解的是，我不得不服从。</p><p id="3240" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">前提很简单——两个PE可执行文件，相同的MD5和SHA1散列相互对抗<strong class="it hv">但是</strong>如承诺的那样——有一点扭曲。一旦运行，它们会有完全不同输出。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff kh"><img src="../Images/220e75774182f29bf88213a3fb4f5e02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*cqj7HAbpOIjzL7Zr.png"/></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">Same hash values, different output. (Screengrab from challenge’s blogpost)</figcaption></figure><h1 id="ad82" class="ki kj hu bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf dt translated">魔法，这是唯一的解释，对吗？</h1><p id="64a9" class="pw-post-body-paragraph ir is hu it b iu lg iw ix iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo hn dt translated">马上——你可以想象我在自己的环境中用内置工具certutil.exe测试了它，以证实这一说法。意识到这是一个可靠的<a class="ae kf" href="https://hackernoon.com/tagged/hash" rel="noopener ugc nofollow" target="_blank">哈希</a>计算，引导我们讨论这里会发生什么。</p><p id="60b8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">显然，两个可执行文件在字节到字节的比较中是相同的，但是运行时使它们不同——这使我们得出一个不可避免的结论，即一些额外的东西，可能是文件元数据(不会影响散列和)。</p><p id="b339" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们看一下它的交付机制—它是一个7z归档。关于7z和其他归档方案，需要注意的重要一点是，它们保留了包含在其中的文件的一些属性。</p><p id="d99c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在给定的存档情况下，保存<a class="ae kf" href="https://hackernoon.com/tagged/security" rel="noopener ugc nofollow" target="_blank">安全</a>信息是不合适的，比如对压缩文件的权限(Windows上的ACE/ACL和任何适用于其他环境的权限方案)。在整个压缩(解压缩)过程中保持的几个重要元数据是<em class="kg">修改/访问日期</em>，当然还有——<em class="kg">文件名</em>。</p><h1 id="1948" class="ki kj hu bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf dt translated">“位碰撞”文件属性(原谅误用)</h1><p id="b279" class="pw-post-body-paragraph ir is hu it b iu lg iw ix iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo hn dt translated">为了解决问题，你希望节省时间，而“玩阴的”是公平的，一般来说，当我们遵循上面的逻辑时，我们从尝试一些可能的解决方案开始。</p><p id="2666" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，我们从更改名称开始—不幸的是，输出没有任何变化，这并没有完全否定不同的流程，但从“布丁的证明”来看—这没有影响任何东西。</p><p id="74af" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来，让我们一起来看看这些日期。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="fe ff ll"><img src="../Images/3e7a3ab99727aa58250e3655f59c259c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S0mua0brNuXrgMlnYXX_EQ.png"/></div></div></figure><p id="5028" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">通过比较，我们可以发现时间上的差异，因此假设更改这些日期以适应另一个日期会导致另一个日期的适当控制流。</p><blockquote class="lm ln lo"><p id="fde3" class="ir is kg it b iu iv iw ix iy iz ja jb lp jd je jf lq jh ji jj lr jl jm jn jo hn dt translated">另一个重要的事实是，文件时间都是可塑的。</p></blockquote><p id="83ae" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，如果你只是尝试许多现成的工具，你可能会在互联网上找到，并试图匹配这些时间，你注定会失败。我尝试了6种不同的解决方案，但没有一种能够完成任务。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff ls"><img src="../Images/e058056361f08dea2238fad3579d4432.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/1*p0Oospcl5QVIuycOQhr0CQ.png"/></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">Matching times try-out using Nirsoft’s File Date Changer</figcaption></figure><p id="4ec6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">幸运的是，我知道问题出在哪里，但是我太懒了，没有从编写自己的工具来完成这个显而易见的选择开始。</p><h1 id="96b8" class="ki kj hu bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf dt translated">你漏了一点</h1><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff kh"><img src="../Images/eff2b43e4ae93e7b7e4d37c86c6ead7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*gZsb0iHfRipYyCvo.jpg"/></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">You can’t miss what you never realized you never had</figcaption></figure><p id="e697" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">事情是这样的<a class="ae kf" href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724284(v=vs.85).aspx" rel="noopener ugc nofollow" target="_blank"> Windows文件时间结构</a>:</p><pre class="jq jr js jt fq lt lu lv lw aw lx dt"><span id="c6f0" class="ly kj hu lu b fv lz ma l mb mc">typedef struct _FILETIME {<br/>  DWORD dwLowDateTime;<br/>  DWORD dwHighDateTime;<br/>} FILETIME, *PFILETIME;</span></pre><p id="07da" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">NTFS上的每个文件都遵循这种精心设计的时间结构，这使得一次滴答正好为100纳秒，它是一个64位值，可以分为两个DWORD(x86-Windows上的32位),高和低，所以粒度数据是存在的，只是在文件经历的大多数进程中不需要它。</p><p id="a7c6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，控制流不仅受一般日期和时间的影响，还需要更加精确，因为它测试的是较低的纳秒定义位。</p><p id="32b4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个问题的最终解决方案是通过设置一个简短的PowerShell脚本来完成的，因为我对那个该死的脚本语言不太熟悉，所以我并不急于从一开始就使用它。</p><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="md me l"/></div></figure><p id="ba8e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，挑战被解决了。我玩得很开心，谢谢Kinine给我这个美丽而有见地的谜语。期待下一个。</p><figure class="jq jr js jt fq ju fe ff paragraph-image"><div class="fe ff mf"><img src="../Images/1d23203007537d775a10f39a2467e4e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*oCfQveBAoQIRaUMfiQW1ZQ.png"/></div><figcaption class="kb kc fg fe ff kd ke bd b be z ek">Both files are going through the same control flow. WIN!</figcaption></figure><figure class="jq jr js jt fq ju"><div class="bz el l di"><div class="mg me l"/></div></figure></div></div>    
</body>
</html>