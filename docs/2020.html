<html>
<head>
<title>Hacking Meteor DDP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">黑客流星DDP</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/hacking-meteor-ddp-9da37790b37b?source=collection_archive---------6-----------------------#2017-01-02">https://medium.com/hackernoon/hacking-meteor-ddp-9da37790b37b?source=collection_archive---------6-----------------------#2017-01-02</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/d154301ee752eda16f0cf0fc940f5464.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iO6nOcogAGL7brbqVol5cQ.jpeg"/></div></div><figcaption class="jc jd fg fe ff je jf bd b be z ek">the meteor by ready2freeze</figcaption></figure><blockquote class="jg jh ji"><p id="bc2c" class="jj jk jl jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated">TD；DR，通过监控<strong class="jm hv">Meteor . connection . _ stream</strong>来跟踪通过您的Meteor应用程序的DPP连接的所有消息。</p></blockquote><p id="71c2" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">在Meteor上创建功能测试可能是一件痛苦的事情。它的反应对UX来说很好，但当我们谈论功能测试时，事情会变得复杂。</p><p id="5fb5" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">在我一直在做的这个项目中，我们使用<a class="ae kl" href="http://nightwatchjs.org/" rel="noopener ugc nofollow" target="_blank">夜巡</a>来编写我们的功能测试。这个<a class="ae kl" href="https://hackernoon.com/tagged/tool" rel="noopener ugc nofollow" target="_blank">工具</a>在<strong class="jm hv"> Selenium </strong>服务器上运行浏览器测试，并允许我们用<strong class="jm hv"> Nodejs </strong>编写测试规范。</p><p id="8e00" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">几周前，我试图弄清楚如何在触发项目网站页面上某个按钮上的<em class="jl"> click </em>命令之前等待Meteor方法的结果。</p><p id="793b" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">等待这个结果并不容易。另外，我们尽量避免使用Nightwatch提供的<a class="ae kl" href="http://nightwatchjs.org/api#pause" rel="noopener ugc nofollow" target="_blank"> <em class="jl">暂停</em>命令</a>。</p><p id="e891" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">当有人推断等待一个计算完成需要多少时间时，会发生很多不好的事情，例如，在提交表单后等待一些CSS类被添加到一个<em class="jl"> div </em>中。</p><p id="c58f" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">因为<em class="jl">暂停</em>不是一个选项，我需要另一种方式来等待这个方法的结果。经过一些调查，我想出了监听<strong class="jm hv"> DDP </strong>消息的主意。</p><h2 id="7c42" class="km kn hu bd ko kp kq kr ks kt ku kv kw ki kx ky kz kj la lb lc kk ld le lf lg dt translated">流星的DDP</h2><blockquote class="lh"><p id="2539" class="li lj hu bd lk ll lm ln lo lp lq kh ek translated">DDP是Meteor的内置发布/订阅和RPC协议</p></blockquote><p id="e689" class="pw-post-body-paragraph jj jk hu jm b jn lr jp jq jr ls jt ju ki lt jx jy kj lu kb kc kk lv kf kg kh hn dt translated">互联网上已经有很多文章可以很好地向您介绍DDP协议。你也可以在Meteor的文档中阅读更多关于DDP的内容，链接<a class="ae kl" href="https://guide.meteor.com/accounts.html#userid-ddp" rel="noopener ugc nofollow" target="_blank">这个链接</a>。</p><p id="9023" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">简而言之，DDP是一个基于JSON的协议，它是由<a class="ae kl" href="https://hackernoon.com/tagged/meteor" rel="noopener ugc nofollow" target="_blank"> Meteor </a>在<strong class="jm hv"> SockJS </strong>之上实现的。它用于在客户端和服务器之间创建全双工通信，在此通信中，它可以更改数据并对其更改做出反应。</p><blockquote class="lh"><p id="18b3" class="li lj hu bd lk ll lm ln lo lp lq kh ek translated">SockJS是一个模拟WebSockets的Javascript库</p></blockquote><p id="93e9" class="pw-post-body-paragraph jj jk hu jm b jn lr jp jq jr ls jt ju ki lt jx jy kj lu kb kc kk lv kf kg kh hn dt translated">当你使用<em class="jl"> Meteor.method，Meteor.call </em>，<em class="jl"> Meteor.publish </em>和<em class="jl"> Meteor.subscribe </em>时，Meteor在底下使用的是DDP。</p><p id="3543" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated"><strong class="jm hv">监听DDP消息</strong></p><p id="bbd0" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">通过在Meteor全局对象上访问名为<strong class="jm hv"> _stream </strong>的变量，可以在客户端找到由Meteor创建的DDP连接:</p><pre class="lw lx ly lz fq ma mb mc md aw me dt"><span id="c7f0" class="km kn hu mb b fv mf mg l mh mi">Meteor.connection._stream</span></pre><p id="72ae" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">有了这个对象，我们可以在客户端发送和监听任何我们想要的消息。下面的<em class="jl">要点</em>展示了一个非常简单的代码示例:</p><figure class="lw lx ly lz fq iv"><div class="bz el l di"><div class="mj mk l"/></div></figure><p id="f24c" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">首先，我们保存对原始发送方法的引用。</p><p id="98ef" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">然后我们用期望的函数覆盖<em class="jl">发送</em>方法。在这个例子中，它只是在通过最初的<em class="jl"> send </em>方法将消息发送到服务器后打印消息。</p><p id="e987" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">最后，我们为<strong class="jm hv">消息</strong>事件注册了一个新的监听器，它也将打印从服务器接收到的所有内容。以前注册的所有侦听器都不会受到影响。</p><p id="e5f8" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">如果您有一个Meteor应用程序，您可以将这个片段复制并粘贴到您的浏览器控制台上，它将开始跟踪通过DDP的所有内容。</p><p id="00c8" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">您可能注意到的第一件事是乒乓消息。Meteor在一段时间间隔后继续发送这些消息，以检查连接是否仍然有效。</p><pre class="lw lx ly lz fq ma mb mc md aw me dt"><span id="6022" class="km kn hu mb b fv mf mg l mh mi">&gt; {"msg":"pong"}<br/>&gt; {"msg":"ping"}</span></pre><p id="c38e" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated"><strong class="jm hv">等待方法响应</strong></p><p id="547c" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">你可能会在流中找到我的消息类型。您可以通过浏览您的应用程序并监视控制台中发生的事情来检查这一点。</p><p id="f478" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">我使用带有类型<strong class="jm hv">方法</strong>的消息从我的测试中移除对<strong class="jm hv">暂停</strong>命令的依赖。测试现在等待，直到<strong class="jm hv">结果</strong>消息到达，在一些时间间隔内在浏览器控制台中搜索它。</p><pre class="lw lx ly lz fq ma mb mc md aw me dt"><span id="21a3" class="km kn hu mb b fv mf mg l mh mi">Meteor.call('foo');</span><span id="0782" class="km kn hu mb b fv ml mg l mh mi">&gt; {"msg":"method", "method":"foo", "params":[], "id":"42"}</span><span id="d34c" class="km kn hu mb b fv ml mg l mh mi">&gt; {"msg":"result", "id":"42", "result":[{"a":1}, {"b":2}]}</span></pre><p id="eeba" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated"><strong class="jm hv">结果</strong>不包括方法名，但是可以在<strong class="jm hv">方法</strong>消息中找到，作为<em class="jl">方法</em>属性的值。它们通过<strong class="jm hv"> id </strong>属性链接在一起。</p><p id="9fa4" class="pw-post-body-paragraph jj jk hu jm b jn jo jp jq jr js jt ju ki jw jx jy kj ka kb kc kk ke kf kg kh hn dt translated">这同样适用于等待<em class="jl">订阅</em>准备就绪。</p><pre class="lw lx ly lz fq ma mb mc md aw me dt"><span id="c2c9" class="km kn hu mb b fv mf mg l mh mi">Meteor.subscribe('bar');</span><span id="9bf7" class="km kn hu mb b fv ml mg l mh mi">&gt; {"msg":"sub", "id":"abc1def3", name:"bar", params:[]}</span><span id="7c91" class="km kn hu mb b fv ml mg l mh mi">&gt; {msg:"ready", subs:["abc1def3"]}</span></pre><h2 id="645d" class="km kn hu bd ko kp kq kr ks kt ku kv kw ki kx ky kz kj la lb lc kk ld le lf lg dt translated">结论</h2><p id="a9f8" class="pw-post-body-paragraph jj jk hu jm b jn mm jp jq jr mn jt ju ki mo jx jy kj mp kb kc kk mq kf kg kh hn dt translated">除了功能测试之外，你还可以用这个Meteor Hack做一些很酷的事情:</p><ul class=""><li id="bca3" class="mr ms hu jm b jn jo jr js ki mt kj mu kk mv kh mw mx my mz dt translated">排除故障</li><li id="da4c" class="mr ms hu jm b jn na jr nb ki nc kj nd kk ne kh mw mx my mz dt translated">查找内存泄漏</li><li id="f25a" class="mr ms hu jm b jn na jr nb ki nc kj nd kk ne kh mw mx my mz dt translated">分析安全问题</li></ul></div><div class="ab cl nf ng hc nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="hn ho hp hq hr"><h2 id="ed2b" class="km kn hu bd ko kp kq kr ks kt ku kv kw ki kx ky kz kj la lb lc kk ld le lf lg dt translated">参考</h2><ul class=""><li id="3e21" class="mr ms hu jm b jn mm jr mn ki nm kj nn kk no kh mw mx my mz dt translated"><a class="ae kl" href="https://meteorhacks.com/introduction-to-ddp/" rel="noopener ugc nofollow" target="_blank">https://meteorhacks.com/introduction-to-ddp/</a></li><li id="52bf" class="mr ms hu jm b jn na jr nb ki nc kj nd kk ne kh mw mx my mz dt translated"><a class="ae kl" href="https://docs.meteor.com/api/connections.html" rel="noopener ugc nofollow" target="_blank">https://docs.meteor.com/api/connections.html</a></li><li id="a374" class="mr ms hu jm b jn na jr nb ki nc kj nd kk ne kh mw mx my mz dt translated"><a class="ae kl" href="https://github.com/sockjs/sockjs-node" rel="noopener ugc nofollow" target="_blank">https://github.com/sockjs/sockjs-node</a></li><li id="1410" class="mr ms hu jm b jn na jr nb ki nc kj nd kk ne kh mw mx my mz dt translated"><a class="ae kl" href="http://docs.seleniumhq.org/" rel="noopener ugc nofollow" target="_blank">http://docs.seleniumhq.org/</a></li></ul><div class="lw lx ly lz fq ab cb"><figure class="np iv nq nr ns nt nu paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="np iv nq nr ns nt nu paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="np iv nq nr ns nt nu paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="jg jh ji"><p id="f922" class="jj jk jl jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated"><a class="ae kl" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae kl" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae kl" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>，并乐意<a class="ae kl" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jj jk jl jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kl" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kl" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="lw lx ly lz fq iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff nv"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="lw lx ly lz fq iv"><div class="bz el l di"><div class="nw mk l"/></div></figure></div></div>    
</body>
</html>