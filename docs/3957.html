<html>
<head>
<title>Reducing nodejs Docker images size by %50 using multi-stage builds and Zeit pkg.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用多阶段构建和Zeit pkg将nodejs Docker图像大小减少50%。</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/reducing-nodejs-docker-images-size-by-50-using-multi-sage-builds-and-zeit-pkg-360ab8b6c6d2?source=collection_archive---------4-----------------------#2017-05-03">https://medium.com/hackernoon/reducing-nodejs-docker-images-size-by-50-using-multi-sage-builds-and-zeit-pkg-360ab8b6c6d2?source=collection_archive---------4-----------------------#2017-05-03</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="4f8e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><em class="jp">更新:你可能想试试我为这篇博文写的互动教程:</em><a class="ae jq" href="http://training.play-with-docker.com/node-zeit-pkg/" rel="noopener ugc nofollow" target="_blank">http://training.play-with-docker.com/node-zeit-pkg/</a></p><p id="ef15" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一周前<a class="ae jq" href="https://hackernoon.com/tagged/zeit" rel="noopener ugc nofollow" target="_blank"> Zeit </a>宣布了一个名为pkg(<a class="ae jq" href="https://github.com/zeit/pkg" rel="noopener ugc nofollow" target="_blank">https://github.com/zeit/pkg)</a>的新项目，该项目允许将<a class="ae jq" href="https://hackernoon.com/tagged/nodejs" rel="noopener ugc nofollow" target="_blank"> nodejs </a>应用程序及其所有依赖项(甚至是节点运行时)捆绑在一个动态链接的二进制文件中，该文件可以很容易地发布到不同的环境中。这非常有用，因为它只处理一个二进制文件，而不是处理不同的依赖项和节点运行时，从而使应用程序的打包、部署和运行变得非常简单。</p><p id="cf9a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你目前在你的项目中使用nodejs + docker，很可能你依赖于任何不同的官方nodejs(<a class="ae jq" href="https://hub.docker.com/_/node/" rel="noopener ugc nofollow" target="_blank">https://hub.docker.com/_/node/</a>)图像。正如您可能已经知道的，这些图像通常不是轻量级的，因为它们需要<code class="eh jr js jt ju b">node</code>运行时，并且还包括其他工具，如<code class="eh jr js jt ju b">npm</code>，这导致从<code class="eh jr js jt ju b">slim</code>替代品开始的200 MB以上的图像。</p><p id="b0c8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">与此同时，docker宣布了一项名为多阶段构建的新功能(https://blog . Docker . com/2017/04/Docker con-2017-day-1-highlights/)，该功能有助于构建通常具有不同<code class="eh jr js jt ju b">build</code>和<code class="eh jr js jt ju b">prod</code>上下文的Docker映像。</p><blockquote class="jv jw jx"><p id="01ae" class="ir is jp it b iu iv iw ix iy iz ja jb jy jd je jf jz jh ji jj ka jl jm jn jo hn dt translated">目前，多阶段构建功能仅在最新的Docker 17.05-rc中可用。在尝试下面的例子之前，确保有一个正确的Docker版本，否则你会得到一些错误。</p></blockquote><p id="44a7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，我将向您展示如何结合这两种特性来构建和发布极小且经过优化的nodejs docker映像。</p><p id="5617" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，我们将创建一个小型nodejs项目，让我们从一个简单的<strong class="it hv"> index.js </strong>和<strong class="it hv"> package.json </strong>开始</p><p id="074f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">index.js:</p><pre class="kb kc kd ke fq kf ju kg kh aw ki dt"><span id="beb5" class="kj kk hu ju b fv kl km l kn ko">console.log('Hello, pkg!');</span></pre><p id="2362" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">package.json:</p><pre class="kb kc kd ke fq kf ju kg kh aw ki dt"><span id="e443" class="kj kk hu ju b fv kl km l kn ko">{<br/>    "name": "pkg-sample",<br/>    "bin": "index.js"<br/>}</span></pre><p id="b167" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我们现在将创建使用pkg和多阶段构建的docker文件:</p><p id="7a16" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Dockerfile:</p><pre class="kb kc kd ke fq kf ju kg kh aw ki dt"><span id="0309" class="kj kk hu ju b fv kl km l kn ko">FROM node:boron</span><span id="e060" class="kj kk hu ju b fv kp km l kn ko">RUN npm install -g pkg pkg-fetch</span><span id="e3bf" class="kj kk hu ju b fv kp km l kn ko">ENV NODE node6<br/>ENV PLATFORM linux<br/>ENV ARCH x64</span><span id="7bb2" class="kj kk hu ju b fv kp km l kn ko">RUN /usr/local/bin/pkg-fetch ${NODE} ${PLATFORM} ${ARCH}</span><span id="a5b1" class="kj kk hu ju b fv kp km l kn ko">COPY . /app</span><span id="4b99" class="kj kk hu ju b fv kp km l kn ko">WORKDIR /app</span><span id="739b" class="kj kk hu ju b fv kp km l kn ko">RUN /usr/local/bin/pkg --targets ${NODE}-${PLATFORM}-${ARCH} index.js</span><span id="654e" class="kj kk hu ju b fv kp km l kn ko">FROM debian:jessie-slim</span><span id="736a" class="kj kk hu ju b fv kp km l kn ko">COPY --from=0  /app/index /</span><span id="0b65" class="kj kk hu ju b fv kp km l kn ko">CMD ["/index"]</span></pre><p id="55b6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">正如你在docker文件中看到的，在这个特殊的例子中，我们的目标是一个<strong class="it hv">节点6、linux和x86_64 </strong>运行时。根据您需要的运行时，您可以组合几个选项，例如，如果您愿意，您可以只使用标准的alpine平台而不是linux。有关更多详细信息，请参考pkg文档。</p><p id="1f53" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">现在，您可以像以前一样使用<code class="eh jr js jt ju b">docker build -t myapp .</code>构建您的应用程序映像。一旦你的映像建立起来，你会注意到它的大小只有几兆，你可以像其他docker容器一样用<code class="eh jr js jt ju b">docker run myapp</code>运行它</p><blockquote class="jv jw jx"><p id="e458" class="ir is jp it b iu iv iw ix iy iz ja jb jy jd je jf jz jh ji jj ka jl jm jn jo hn dt translated"><a class="ae jq" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jq" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jq" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jq" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="dca4" class="ir is jp it b iu iv iw ix iy iz ja jb jy jd je jf jz jh ji jj ka jl jm jn jo hn dt translated">要了解更多信息，<a class="ae jq" href="https://goo.gl/4ofytp" rel="noopener ugc nofollow" target="_blank">请阅读我们的“关于”页面</a>，<a class="ae jq" href="http://bit.ly/HackernoonFB" rel="noopener ugc nofollow" target="_blank">在脸书上点赞/给我们发消息</a>，或者简单地说，<a class="ae jq" href="https://goo.gl/k7XYbx" rel="noopener ugc nofollow" target="_blank"> tweet/DM @HackerNoon。</a></p><p id="708a" class="ir is jp it b iu iv iw ix iy iz ja jb jy jd je jf jz jh ji jj ka jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jq" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jq" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kb kc kd ke fq kq"><div class="bz el l di"><div class="kr ks l"/></div></figure></div></div>    
</body>
</html>