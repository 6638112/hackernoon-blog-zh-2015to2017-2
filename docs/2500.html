<html>
<head>
<title>Percona Migrator Announcement</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Percona迁移程序公告</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/percona-migrator-announcement-6a32d5b7484c?source=collection_archive---------8-----------------------#2017-01-31">https://medium.com/hackernoon/percona-migrator-announcement-6a32d5b7484c?source=collection_archive---------8-----------------------#2017-01-31</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="b0f9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">今天，我们很高兴向大家展示<a class="ae jp" href="https://github.com/redbooth/percona_migrator" rel="noopener ugc nofollow" target="_blank"> Percona Migrator </a>，一个在Rails中运行在线MySQL模式迁移的ActiveRecord <a class="ae jp" href="https://hackernoon.com/tagged/adapter" rel="noopener ugc nofollow" target="_blank">适配器</a>。自从我们在2014年12月实施以来，它经历了几个阶段，但它一直是我们在<a class="ae jp" href="https://redbooth.com/" rel="noopener ugc nofollow" target="_blank"> Redbooth </a>的工具的重要组成部分。</p><h1 id="b03a" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">动机</h1><p id="f52f" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">这要追溯到2013年初，当时我们开始使用<a class="ae jp" href="https://github.com/soundcloud/lhm" rel="noopener ugc nofollow" target="_blank"> Soundcloud的LHM </a>来克服MySQL 5.5的限制，即模式更改会在更改期间锁定表。这给高度并发和大型的表带来了非常糟糕的体验，这在当时已经存在。</p><p id="778f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">不幸的是，一年后，一个带有单记录表的bug加上缺乏对外键约束的支持，使得我们创建了自己的fork，却忘记了维护。</p><p id="1289" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">2014年下半年，LHM对我们的生产数据库来说是不够的，生产数据库的规模和负荷一直在增长。对注释和任务(经历最高并发级别的表)运行迁移会导致死锁，除非我们在周末运行它们。即使在2014年，也没有人会想到会有零停机时间的迁移和部署。</p><p id="34fa" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">同样重要的是，LHM迫使我们放弃Rails迁移DSL，我们认为这是一种使用的乐趣。我们最终得到了不太容易理解的迁移和硬编码的节流值。</p><p id="750d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">所以，我们决定开发一种工具，可以解决这些问题，让我们周末再次放松。</p><h1 id="69d2" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">Percona Migrator</h1><p id="3fe2" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">它最初是作为我们的Rails 3.2应用程序中的一个库开始的，该库解析了LHM的DSL迁移，并返回了Percona的<a class="ae jp" href="https://www.percona.com/doc/percona-toolkit/2.2/pt-online-schema-change.html" rel="noopener ugc nofollow" target="_blank"> pt-online-schema-change </a>命令。为了运行迁移，开发人员必须执行一个rake任务，该任务将返回一个带有参数的<code class="eh kt ku kv kw b">pt-online-schema-change</code>命令，复制并粘贴该命令，然后执行该命令。然后，我们有几个其他的rake任务来标记迁移是向上还是向下。</p><p id="66b5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">虽然这个过程有点乏味，但它让我们能够毫无问题地将模式更改应用到我们的<a class="ae jp" href="https://hackernoon.com/tagged/database" rel="noopener ugc nofollow" target="_blank">数据库</a>中，这让我们的周末又回来了。</p><h1 id="d397" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">在线模式迁移工具</h1><p id="8ad7" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">像大多数在线模式迁移工具一样，比如Github的gh-ost、脸书的OSC或Soundcloud的LHM会改变表而不会通过新表锁定它们。</p><p id="3b8b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用新的模式创建表的副本，并且将行按块复制到表中，而不会对数据库的负载造成太大影响。完成后，此表将替换旧表。</p><p id="fa09" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh kt ku kv kw b">pt-online-schema-change</code>和LHM的主要区别在于他们工作的堆栈级别。LHM是一个Ruby宝石，它让你用自己的DSL编写Rails迁移，<code class="eh kt ku kv kw b">pt-online-schema-change</code>是一个命令行工具，充当数据库客户端，向数据库发送语句。</p><p id="d885" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><code class="eh kt ku kv kw b">pt-online-schema-change</code>通过自动检查服务器负载，将数据以动态调整的块复制到新表中，这一事实使我们免于过多增加数据库服务器负载，虽然迁移时间稍长，但更安全。</p><h1 id="6ec6" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">用于迁移的ActiveRecord适配器</h1><p id="00ca" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">一年后，厌倦了复制粘贴<code class="eh kt ku kv kw b">pt-online-schema-change</code>命令，我们决定最终将它转移到一个ruby gem上，它会自动执行这些命令并为我们更新迁移状态，但仍然是rake任务。</p><p id="3889" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">然后我们决定开源它，开始写文档，发现了一些缺陷，进一步推迟了发布。我们看到了将它实现为ActiveRecord适配器的机会。</p><p id="c583" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">起初这听起来很疯狂，但我们开始为ActiveRecord 3.2开发适配器，我们的应用程序仍在这个Rails版本上运行。</p><p id="37b7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">它取代了您在<code class="eh kt ku kv kw b">config/databases.yml</code>中配置的适配器，并通过Percona的<code class="eh kt ku kv kw b">pt-online-schema-change</code>执行MySQL语句。这提供了Percona Toolkit的最佳功能，而无需改变编写Rails迁移的方式。</p><p id="c388" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你以前是<code class="eh kt ku kv kw b">pt-online-schema-change</code>用户，我们会为你提供保障。您可以通过环境变量向它传递参数。如果你像我们一样来自LHM，你也不必重写你的迁移；Percona迁移器将LHM的DSL翻译成Rails的DSL。</p><h1 id="f237" class="jq jr hu bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dt translated">把❤️放到你的数据库里</h1><p id="2330" class="pw-post-body-paragraph ir is hu it b iu ko iw ix iy kp ja jb jc kq je jf jg kr ji jj jk ks jm jn jo hn dt translated">开始使用它非常简单。将此添加到您的gem文件中:</p><p id="5aeb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://gist.github.com/712aaa37606dd1594a9e2f36c7ac6e33" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/712aaa37606dd1594a9e2f36c7ac6e33</a></p><p id="0443" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">并运行<code class="eh kt ku kv kw b">bundle install</code>。没别的了。</p><p id="3960" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于像这样的简单迁移:</p><p id="3da0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="https://gist.github.com/1f60c16668dbc39fcca2ccd83e4c2361" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/1f60c16668dbc39fcca2ccd83e4c2361</a></p><p id="3ee9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">运行<code class="eh kt ku kv kw b">bundle exec rake db:migrate:up</code>时的输出将变为:</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff kx"><img src="../Images/046dbb6d807c17bc6f87325b141e1314.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*vDeNDd5b25Bg-y_ZD-E5rg.gif"/></div></div></figure><p id="e56f" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因此，您的迁移将受益于<code class="eh kt ku kv kw b">pt-online-schema-change</code>的功能，例如:</p><ul class=""><li id="1518" class="lj lk hu it b iu iv iy iz jc ll jg lm jk ln jo lo lp lq lr dt translated">当服务器负载过高或副本延迟过大时，自动迁移中止</li><li id="1ab3" class="lj lk hu it b iu ls iy lt jc lu jg lv jk lw jo lo lp lq lr dt translated">动态调整块大小，因此数据复制查询不会花费太长时间</li></ul><p id="c237" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">查看<a class="ae jp" href="https://www.percona.com/doc/percona-toolkit/2.1/pt-online-schema-change.html#options" rel="noopener ugc nofollow" target="_blank">文档</a>中的完整列表</p><p id="5ab8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">感谢<a class="ae jp" href="https://github.com/aserafin" rel="noopener ugc nofollow" target="_blank"> Adrian Serafin的</a>贡献，我们最近获得了<a class="ae jp" href="https://github.com/redbooth/percona_migrator/pull/39" rel="noopener ugc nofollow" target="_blank">对Rails 4.2的支持</a>，我们计划很快获得对Rails 4.1的支持！</p><p id="31a9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你喜欢它，但你的应用程序在Rails 5上？不要犹豫，打开一个PR，挖到ActiveRecord！您将在<a class="ae jp" href="https://github.com/redbooth/percona_migrator/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">自述文件</a>中找到更多详细信息。</p><p id="2c50" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">移民快乐！</p><div class="ky kz la lb fq ab cb"><figure class="lx lc ly lz ma mb mc paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="lx lc ly lz ma mb mc paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="lx lc ly lz ma mb mc paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="md me mf"><p id="f922" class="ir is mg it b iu iv iw ix iy iz ja jb mh jd je jf mi jh ji jj mj jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是阿妹家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is mg it b iu iv iw ix iy iz ja jb mh jd je jf mi jh ji jj mj jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff mk"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="ky kz la lb fq lc"><div class="bz el l di"><div class="ml mm l"/></div></figure></div></div>    
</body>
</html>