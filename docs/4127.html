<html>
<head>
<title>Stunts.fm: Building a serverless chatbot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建一个无服务器聊天机器人</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/stunts-fm-building-a-serverless-chatbot-ba9d07c7e16a?source=collection_archive---------7-----------------------#2017-05-14">https://medium.com/hackernoon/stunts-fm-building-a-serverless-chatbot-ba9d07c7e16a?source=collection_archive---------7-----------------------#2017-05-14</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="37f0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我觉得我一直很难找到我喜欢的音乐。我过去常常在iTunes里放满我在Rap Radar和Hypetrak等说唱博客上找到的歌曲，但最近感觉实际内容被编辑帖子淹没了。我最喜欢的音乐发现来源之一曾经是Complex的<em class="jp"> 5点Shuffle </em>，这是一个每天从互联网上发布5首mp3的帖子，但不幸的是，它已经不存在了。为了填补这一空白，我想我应该创建一个<a class="ae jq" href="https://hackernoon.com/tagged/facebook" rel="noopener ugc nofollow" target="_blank">脸书</a>聊天机器人，它从说唱博客中抓取内容并发送每日更新。所以我做了特技。fm:</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff jr"><img src="../Images/7b159c559a5ff4a0a9934569969248bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zs4fecnrfg2r_2RUChxW2w.png"/></div></div><figcaption class="kd ke fg fe ff kf kg bd b be z ek">An update from a few weeks ago</figcaption></figure><p id="730b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在制作这个聊天机器人时，我想做的一件事就是使用亚马逊网络服务的Lambda服务。Lambda允许您部署代码，而无需提供任何服务器。这很吸引我，因为我想最小化这个附带项目的运营开销。</p><p id="ac44" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我希望我的聊天机器人具有的功能是:</p><ul class=""><li id="1584" class="kh ki hu it b iu iv iy iz jc kj jg kk jk kl jo km kn ko kp dt translated">从说唱博客收集内容</li><li id="7c89" class="kh ki hu it b iu kq iy kr jc ks jg kt jk ku jo km kn ko kp dt translated">板载新用户</li><li id="7404" class="kh ki hu it b iu kq iy kr jc ks jg kt jk ku jo km kn ko kp dt translated">允许用户通过机器人请求更新</li><li id="a8a5" class="kh ki hu it b iu kq iy kr jc ks jg kt jk ku jo km kn ko kp dt translated">每天自动发送更新</li><li id="b03b" class="kh ki hu it b iu kq iy kr jc ks jg kt jk ku jo km kn ko kp dt translated">跟踪用户点击的内容</li><li id="6db0" class="kh ki hu it b iu kq iy kr jc ks jg kt jk ku jo km kn ko kp dt translated">分析使用模式</li></ul><p id="3417" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是整个架构的样子:</p><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff kv"><img src="../Images/5803f5e5f46dcce8c2c1ec36466fa7cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RneSMgSh2u7d-1E9HHFSaA.png"/></div></div></figure><p id="36fe" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我将在下面分解我是如何实现我的每一个需求的。</p><h1 id="7db2" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">收集内容</h1><figure class="js jt ju jv fq jw fe ff paragraph-image"><div class="fe ff lu"><img src="../Images/7f3110a76d1cddaa42adf49f7f43a447.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/1*VJBR0cA6L-SURz3xakpO9Q.png"/></div></figure><p id="d054" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我通过编写脚本来收集内容，以检查说唱博客2dopeboyz和鸽子与飞机的RSS提要。每个脚本都被部署为一个独立的Lambda函数。这些脚本会查看过去24小时的每条帖子，并解析出任何Soundcloud或YouTube链接。然后，他们会将这些内容以及标题、描述和预览图像等元数据保存到AWS dynamo db托管的一个表中。Lambda服务每天都会自动触发这些脚本。</p><h1 id="427d" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">新用户入职</h1><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff lv"><img src="../Images/98fb0c198db57b5af310e5ed362547c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ylfPGrCaduguBiRsvzuheQ.png"/></div></div></figure><p id="ac2c" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">使用脸书的Messenger API，新用户的加入相对简单。脸书聊天机器人本质上是一个HTTP端点，称为webhook，它接收来自用户的消息事件，处理它们，然后向Messenger API发送响应。为了设置这个webhook，我编写了一个Python函数来处理消息事件，并将其部署为Lambda函数。我使用AWS的API Gateway设置了一个url，它带有一个由这个Lambda函数支持的/webhook端点。每当用户与我的聊天机器人交互时，这个端点都会收到一条消息。webhook代码做的第一件事是检查我们以前是否见过发送者。如果没有，它知道我们需要装载用户。它会将用户的详细信息保存在DynamoDB的用户表中，这样我们就可以稍后给他们发送消息。</p><h1 id="6e80" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">允许用户请求更新</h1><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff lw"><img src="../Images/97a7b9108fcc6ed74540cb33bd38e548.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*un8aP7B9nBiAlNRzU63JDw.png"/></div></div></figure><p id="ebeb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">webhook端点还负责处理来自用户的所有<a class="ae jq" href="https://hackernoon.com/tagged/future" rel="noopener ugc nofollow" target="_blank">未来</a>消息。用户可以要求聊天机器人做的一件事是给他们发送今天的内容。当webhook代码发现有用户请求时，它会调用另一个Lambda函数来查询DynamoDB中的内容表，然后向Messenger API发送响应。</p><h1 id="fe04" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">每天自动发送更新</h1><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff lx"><img src="../Images/94980e7b99e4611df5095a7093971605.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3OxgwbTmF9QaTAAPL06kyQ.png"/></div></div></figure><p id="2169" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这个机器人每天也会自己发出这个更新。自动触发Lambda函数，该函数在DynamoDB中查询所有订阅用户的用户表。然后，它向AWS的简单通知服务发送每个用户的通知。这些通知触发了webhook用来向每个用户发送更新的同一个“更新发送者”Lambda函数。</p><h1 id="c682" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">跟踪用户点击的内容</h1><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff ly"><img src="../Images/3233c46a40bc0ad5039930757ad25d6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BrhauTXC65h8JucmY7wcsg.png"/></div></div></figure><p id="6660" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了跟踪用户点击的内容，每次“更新发送者”向用户发送消息时，它都会为每个用户/内容组合生成一个唯一的id，并将其保存到DynamoDB中的点击跟踪器表中。然后，它不是向用户发送实际的内容链接，而是发送带有生成的id的API的URL。当用户在他们的Facebook Messenger应用中点击这些URL时，我们的API网关调用Lambda函数，该函数在点击跟踪器表中跟踪这一点击，然后将它们重定向到实际内容。</p><h1 id="434c" class="kw kx hu bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt dt translated">分析使用模式</h1><figure class="js jt ju jv fq jw fe ff paragraph-image"><div class="fe ff lz"><img src="../Images/6f7410b9f619acf82e8b81f35126be1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/1*UdNCaciDo1W4KjvvTePvbw.png"/></div></figure><p id="c68b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">为了分析内容、用户和点击，每个DynamoDB表都被设置为在每次创建或更新一行时写入一个Elasticsearch集群。</p><figure class="js jt ju jv fq jw"><div class="bz el l di"><div class="ma mb l"/></div></figure><div class="js jt ju jv fq ab cb"><figure class="mc jw md me mf mg mh paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="mc jw md me mf mg mh paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="mc jw md me mf mg mh paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="mi mj mk"><p id="f922" class="ir is jp it b iu iv iw ix iy iz ja jb ml jd je jf mm jh ji jj mn jl jm jn jo hn dt translated"><a class="ae jq" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jq" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jq" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jq" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is jp it b iu iv iw ix iy iz ja jb ml jd je jf mm jh ji jj mn jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jq" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jq" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="js jt ju jv fq jw fe ff paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="fe ff mo"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="js jt ju jv fq jw"><div class="bz el l di"><div class="ma mb l"/></div></figure></div></div>    
</body>
</html>