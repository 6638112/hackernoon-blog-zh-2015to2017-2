<html>
<head>
<title>Speed Up Allocating ActiveRecord Objects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">加速分配ActiveRecord对象</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/speed-up-allocating-activerecord-objects-86c7ced839a5?source=collection_archive---------3-----------------------#2016-09-09">https://medium.com/hackernoon/speed-up-allocating-activerecord-objects-86c7ced839a5?source=collection_archive---------3-----------------------#2016-09-09</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="d600" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在工作中的一个项目中，我们需要生成一个大报告，ActiveRecord太慢了，而且对内存的需求太大。在某些极端情况下，生成100，000–200，000行的报告需要一个多小时。内存超过2GB，虚拟机开始交换，在该虚拟机上运行的所有实例变得缓慢。</p><p id="1fd3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">首先，我尝试实现使用limit()和offset()的find_in_batches，但是效果不太好。每个下一批变得更慢，因为DB需要找到前N批，只给我第N批，在下一批它会N+1批，等等。内存更好，速度更差。</p><p id="90c2" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">接下来我开始思考为什么要花这么多时间？大部分时间花在创建<a class="ae jp" href="https://hackernoon.com/tagged/activerecord" rel="noopener ugc nofollow" target="_blank"> ActiveRecord </a>对象和访问属性上。这也是最大的内存消耗。我想到了用更少的分配和更好的性能来制作ActiveRecord对象的轻量级版本。我称之为<a class="ae jp" href="https://github.com/Paxa/light_record" rel="noopener ugc nofollow" target="_blank">光记录</a>。</p><p id="df55" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">LightRecord是ActiveRecord的扩展，可以用尽可能少的分配创建只读对象。它简单地使用来自<a class="ae jp" href="https://hackernoon.com/tagged/database" rel="noopener ugc nofollow" target="_blank">数据库</a>驱动程序(mysql2)的散列，并为字段定义访问器方法。没有类型转换，没有脏属性(ActiveModel::Dirty)，没有复制数据。</p><p id="2f3b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">生成具有36634行和18列的CSV报告的基准。5.0.0.1 OS X 10 . 11 . 6，ruby 3.0.1，rails</p><ul class=""><li id="f9a6" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated">ActiveRecord: 5.2秒，270 MB，265万个分配对象</li><li id="0c90" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">LightRecord: 1.41秒，120 MB，93万个分配对象</li><li id="4c13" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">LightRecord流:1.3秒，108 MB，93万个分配的对象</li></ul><figure class="kf kg kh ki fq kj fe ff paragraph-image"><div class="fe ff ke"><img src="../Images/0505b571eb08b010096911833d0fa45b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*FJhxgyS9qTT1LKan_6RviA.png"/></div></figure><figure class="kf kg kh ki fq kj fe ff paragraph-image"><div class="fe ff km"><img src="../Images/9dd4d276fdbdba4cc7c1d82be49902a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/format:webp/1*y8glmBZ-SRuGLuyO2zaI7Q.png"/></div></figure><figure class="kf kg kh ki fq kj fe ff paragraph-image"><div class="fe ff kn"><img src="../Images/d558f909e39e1a1e45975285d011b651.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*zS06zBJhccYL0Hgti7K7Vg.png"/></div></figure><p id="3849" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如你所见，LightRecord也支持流式传输。使用mysql2客户端的流特性，一条一条地加载记录，并可以迭代它们。图表上的内存是直线增长的，因为它没有在开始时加载所有的数据。</p><p id="611b" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你可以在<a class="ae jp" href="https://github.com/Paxa/light_record" rel="noopener ugc nofollow" target="_blank"> LightRecord github页面</a>上看到代码示例。我们在生产中的一个项目中使用了它，我对它获得的性能很满意</p><div class="kf kg kh ki fq ab cb"><figure class="ko kj kp kq kr ks kt paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="ko kj kp kq kr ks kt paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="ko kj kp kq kr ks kt paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="ku kv kw"><p id="f922" class="ir is kx it b iu iv iw ix iy iz ja jb ky jd je jf kz jh ji jj la jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is kx it b iu iv iw ix iy iz ja jb ky jd je jf kz jh ji jj la jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="kf kg kh ki fq kj fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff lb"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure><figure class="kf kg kh ki fq kj"><div class="bz el l di"><div class="lc ld l"/></div></figure></div></div>    
</body>
</html>