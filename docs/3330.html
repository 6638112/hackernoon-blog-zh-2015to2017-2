<html>
<head>
<title>A Package for Snapshot Testing in PHPUnit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PHPUnit中用于快照测试的包</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/a-package-for-snapshot-testing-in-phpunit-2e4558c07fe3?source=collection_archive---------14-----------------------#2017-03-27">https://medium.com/hackernoon/a-package-for-snapshot-testing-in-phpunit-2e4558c07fe3?source=collection_archive---------14-----------------------#2017-03-27</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><div class=""><h2 id="4b74" class="pw-subtitle-paragraph ir ht hu bd b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ek translated">一种无需编写实际测试用例的测试方法</h2></div><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff jj"><img src="../Images/85a803f78ac810e2e8afe33108662c6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oQ0aXDCC9hwIEHf2vCKodg.jpeg"/></div></div></figure><p id="5189" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">快照测试的要点是断言一组数据与先前版本相比没有变化，这是数据的<em class="kr">快照</em>，以防止回归。经典的<code class="eh ks kt ku kv b">assertEquals</code>和<code class="eh ks kt ku kv b">assertMatchesSnapshot</code>之间的区别在于，在快照测试时，您不需要自己编写预期。当快照断言第一次发生时，它会创建一个包含实际输出的快照文件，并将测试标记为未完成。每次后续运行都会将输出与现有快照文件进行比较，以检查回归情况。</p><p id="d629" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">快照测试是最有用的大型数据集，可以随着时间的推移而改变，比如为XML导出或JSON API端点序列化一个对象。</p><p id="eb83" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">我们的包公开了一个特性，为您的测试添加快照测试功能，可以通过<a class="ae kw" href="https://packagist.org/packages/spatie/phpunit-snapshot-assertions" rel="noopener ugc nofollow" target="_blank"> composer </a>安装，并在<a class="ae kw" href="https://github.com/spatie/phpunit-snapshot-assertions" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上提供。还有一个例子</p></div><div class="ab cl kx ky hc kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hn ho hp hq hr"><p id="58d1" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><em class="kr">我找不到快照测试的任何正式来源。我发现的最古老的库是脸书写的用来快照测试iOS用户界面的库。</em><a class="ae kw" href="https://facebook.github.io/jest/" rel="noopener ugc nofollow" target="_blank"><em class="kr">Jest</em></a><em class="kr">——一个同样由脸书开发的JavaScript测试框架——最近流行的快照测试，因为它为测试用React这样的虚拟dom库构建的用户界面提供了一个优秀的工作流程。</em></p></div><div class="ab cl kx ky hc kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hn ho hp hq hr"><h2 id="d190" class="le lf hu bd lg lh li lj lk ll lm ln lo ke lp lq lr ki ls lt lu km lv lw lx ly dt translated">基本示例</h2><p id="aaed" class="pw-post-body-paragraph jv jw hu jx b jy lz iv ka kb ma iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">让我们为一个简单的字符串“foo”做一个快照断言。</p><pre class="jk jl jm jn fq me kv mf mg aw mh dt"><span id="f82b" class="le lf hu kv b fv mi mj l mk ml">public function test_it_is_foo() {<br/>    $this-&gt;assertMatchesSnapshot('foo');<br/>}</span></pre><p id="1c37" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">断言第一次运行时，没有与字符串进行比较的快照。测试运行程序生成新的快照，并将测试标记为未完成。</p><pre class="jk jl jm jn fq me kv mf mg aw mh dt"><span id="2c80" class="le lf hu kv b fv mi mj l mk ml">&gt; ./vendor/bin/phpunit<br/><br/>There was 1 incomplete test:<br/><br/>1) ExampleTest::test_it_matches_a_string<br/>Snapshot created for ExampleTest__test_it_matches_a_string__1<br/><br/>OK, but incomplete, skipped, or risky tests!<br/>Tests: 1, Assertions: 0, Incomplete: 1.</span></pre><p id="42d9" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">快照id是基于测试和测试用例的名称生成的。基本快照返回实际值的一个<code class="eh ks kt ku kv b">var_export</code>。</p><pre class="jk jl jm jn fq me kv mf mg aw mh dt"><span id="ad27" class="le lf hu kv b fv mi mj l mk ml">&lt;?php return 'foo';</span></pre><p id="87fc" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">让我们重新进行测试。测试运行人员将会看到断言已经有了一个快照，并进行比较。</p><pre class="jk jl jm jn fq me kv mf mg aw mh dt"><span id="dd7a" class="le lf hu kv b fv mi mj l mk ml">&gt; ./vendor/bin/phpunit<br/><br/>OK (1 test, 1 assertion)</span></pre><p id="7926" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果我们将实际值更改为“bar”，测试将会失败，因为快照仍然返回“foo”。</p><pre class="jk jl jm jn fq me kv mf mg aw mh dt"><span id="9a7f" class="le lf hu kv b fv mi mj l mk ml">public function test_it_is_foo() {<br/>    $this-&gt;assertMatchesSnapshot('bar');<br/>}<br/>&gt; ./vendor/bin/phpunit<br/><br/>1) ExampleTest::test_it_matches_a_string<br/>Failed asserting that two strings are equal.<br/>--- Expected<br/>+++ Actual<br/>@@ @@<br/>-'foo'<br/>+'bar'<br/><br/>FAILURES!<br/>Tests: 1, Assertions: 1, Failures: 1.</span></pre><p id="2864" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">当我们期望一个改变的值时，我们需要告诉测试运行者更新现有的快照，而不是让测试失败。这可以通过给<code class="eh ks kt ku kv b">phpunit</code>命令添加一个<code class="eh ks kt ku kv b">-d --update-snapshots</code>标志来实现。</p><pre class="jk jl jm jn fq me kv mf mg aw mh dt"><span id="7302" class="le lf hu kv b fv mi mj l mk ml">&gt; ./vendor/bin/phpunit -d --update-snapshots<br/><br/>1) ExampleTest::test_it_matches_a_string<br/>Snapshot updated for ExampleTest__test_it_matches_a_string__1<br/><br/>OK, but incomplete, skipped, or risky tests!<br/>Tests: 1, Assertions: 1, Incomplete: 1</span></pre><p id="531b" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">因此，我们的快照文件包含“bar”而不是“foo”。</p><pre class="jk jl jm jn fq me kv mf mg aw mh dt"><span id="667f" class="le lf hu kv b fv mi mj l mk ml">&lt;?php return 'bar';</span></pre><h2 id="aed3" class="le lf hu bd lg lh li lj lk ll lm ln lo ke lp lq lr ki ls lt lu km lv lw lx ly dt translated">方法</h2><p id="5705" class="pw-post-body-paragraph jv jw hu jx b jy lz iv ka kb ma iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">断言是使用<code class="eh ks kt ku kv b">assertMatchesSnapshot</code>方法完成的。</p><pre class="jk jl jm jn fq me kv mf mg aw mh dt"><span id="e28e" class="le lf hu kv b fv mi mj l mk ml">public function it_matches_something()<br/>{<br/>    $something = new Something();<br/><br/>    $this-&gt;assertMatchesSnapshot($something);<br/>}</span></pre><p id="d64a" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果您正在处理JSON或XML数据，您最好使用专用的<code class="eh ks kt ku kv b">assertMatchesJsonSnapshot</code>或<code class="eh ks kt ku kv b">assertMatchesXmlSnapshot</code>方法，它将快照保存为<code class="eh ks kt ku kv b">.xml</code>文件的<code class="eh ks kt ku kv b">.json</code>，并在快照不匹配时提供更好的差异。</p><pre class="jk jl jm jn fq me kv mf mg aw mh dt"><span id="9c76" class="le lf hu kv b fv mi mj l mk ml">public function it_matches_something_json()<br/>{<br/>    $something = new Something();<br/><br/>    $this-&gt;assertMatchesJsonSnapshot($something-&gt;toJson());<br/>}</span></pre><h2 id="99f3" class="le lf hu bd lg lh li lj lk ll lm ln lo ke lp lq lr ki ls lt lu km lv lw lx ly dt translated">快照文件</h2><p id="440d" class="pw-post-body-paragraph jv jw hu jx b jy lz iv ka kb ma iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">默认情况下，快照存储在测试类的同一级别的一个<code class="eh ks kt ku kv b">__snapshots__</code>目录中。</p><pre class="jk jl jm jn fq me kv mf mg aw mh dt"><span id="dc58" class="le lf hu kv b fv mi mj l mk ml">__snapshots__/<br/>    ExampleTest__test_it_matches_a_string.php<br/>ExampleTest.php</span></pre><p id="1456" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">可以通过覆盖<code class="eh ks kt ku kv b">getSnapshotId</code>和<code class="eh ks kt ku kv b">getSnapshotDirectory</code>来更改快照id和快照目录的名称。查看自述文件以获得更详细的解释。</p><h2 id="02a1" class="le lf hu bd lg lh li lj lk ll lm ln lo ke lp lq lr ki ls lt lu km lv lw lx ly dt translated">司机</h2><p id="7c19" class="pw-post-body-paragraph jv jw hu jx b jy lz iv ka kb ma iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">驱动程序使包可扩展，如果没有<code class="eh ks kt ku kv b">Driver</code>接口，快照断言将局限于JSON、XML和带有<code class="eh ks kt ku kv b">var_export</code>的通用值。驱动程序处理快照数据的序列化和匹配。例如，如果您的应用程序会大量使用YAML文件，您可以编写一个<code class="eh ks kt ku kv b">YamlDriver</code>来将快照保存为真实的YAML文件，并改进PHPUnit的diff输出。</p><p id="ec17" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">可以通过将自定义驱动程序传递给<code class="eh ks kt ku kv b">assertMatchesSnapshot</code>来应用它们。</p><pre class="jk jl jm jn fq me kv mf mg aw mh dt"><span id="f64d" class="le lf hu kv b fv mi mj l mk ml">public function it_matches_yaml()<br/>{<br/>    $order = new Order();<br/><br/>    $this-&gt;assertMatchesSnapshot(<br/>        $order-&gt;toYaml(),<br/>        new YamlDriver()<br/>    );<br/>}</span></pre><p id="1731" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">如果你对编写自定义驱动程序的详细解释感兴趣，他们在readme中有一个专门的章节。</p><h2 id="0306" class="le lf hu bd lg lh li lj lk ll lm ln lo ke lp lq lr ki ls lt lu km lv lw lx ly dt translated">通往v1.0的道路</h2><p id="346e" class="pw-post-body-paragraph jv jw hu jx b jy lz iv ka kb ma iy kd ke mb kg kh ki mc kk kl km md ko kp kq hn dt translated">我们已经决定标记1.0版，因为我们已经在一些项目中使用这个包没有问题。缺少的功能可以在以后的版本中添加。</p><p id="6d3e" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><strong class="jx hv">清理未使用的快照(</strong><a class="ae kw" href="https://github.com/spatie/phpunit-snapshot-assertions/issues/17" rel="noopener ugc nofollow" target="_blank"><strong class="jx hv"/></a><strong class="jx hv">)</strong></p><p id="42a0" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">目前，没有办法确定哪些快照没有使用，哪些可以删除。旧的快照需要手动删除，一个“清理”任务将是受欢迎的自动化。</p><p id="1c9a" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated"><strong class="jx hv">无黑客更新标志(</strong><a class="ae kw" href="https://github.com/spatie/phpunit-snapshot-assertions/issues/22" rel="noopener ugc nofollow" target="_blank"><strong class="jx hv"><strong class="jx hv"/></strong></a><strong class="jx hv">)</strong></p><p id="3989" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">需要在<code class="eh ks kt ku kv b">-d</code>之后指定<code class="eh ks kt ku kv b">--update-snapshots</code>标志，这意味着设置自定义php.ini值。<a class="ae kw" href="https://hackernoon.com/tagged/phpunit" rel="noopener ugc nofollow" target="_blank"> PHPUnit </a>不支持自定义CLI选项，但它可能会在<a class="ae kw" href="https://hackernoon.com/tagged/future" rel="noopener ugc nofollow" target="_blank">未来的</a>版本中添加(<a class="ae kw" href="https://github.com/sebastianbergmann/phpunit/issues/2271" rel="noopener ugc nofollow" target="_blank">sebastianbergmann/PHPUnit # 2271</a>)</p><p id="8fd0" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">尽管没有一个稳定的版本号，但很可能不会再有任何大的突破性变化了。</p></div><div class="ab cl kx ky hc kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hn ho hp hq hr"><p id="c740" class="pw-post-body-paragraph jv jw hu jx b jy jz iv ka kb kc iy kd ke kf kg kh ki kj kk kl km kn ko kp kq hn dt translated">感谢<a class="ae kw" href="https://twitter.com/alexvanderbist" rel="noopener ugc nofollow" target="_blank"> @AlexVanderbist </a>帮助完成这个包的集成测试！</p></div><div class="ab cl kx ky hc kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hn ho hp hq hr"><ul class=""><li id="b113" class="mm mn hu jx b jy jz kb kc ke mo ki mp km mq kq mr ms mt mu dt translated"><a class="ae kw" href="https://github.com/spatie/phpunit-snapshot-assertions" rel="noopener ugc nofollow" target="_blank">GitHub上的spatie/phpunit-snapshot-断言</a></li><li id="2b8c" class="mm mn hu jx b jy mv kb mw ke mx ki my km mz kq mr ms mt mu dt translated"><a class="ae kw" href="https://packagist.org/packages/spatie/phpunit-snapshot-assertions" rel="noopener ugc nofollow" target="_blank">spatie/phpunit-snapshot-Packagist上的断言</a></li><li id="29dc" class="mm mn hu jx b jy mv kb mw ke mx ki my km mz kq mr ms mt mu dt translated">可以在我们的网站上<a class="ae kw" href="https://spatie.be/en/opensource" rel="noopener ugc nofollow" target="_blank">找到我们开源包的概述</a></li></ul><div class="jk jl jm jn fq ab cb"><figure class="na jo nb nc nd ne nf paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="na jo nb nc nd ne nf paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="na jo nb nc nd ne nf paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="ng nh ni"><p id="f922" class="jv jw kr jx b jy jz iv ka kb kc iy kd nj kf kg kh nk kj kk kl nl kn ko kp kq hn dt translated"><a class="ae kw" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是AMI家庭的一员。我们现在<a class="ae kw" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae kw" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="jv jw kr jx b jy jz iv ka kb kc iy kd nj kf kg kh nk kj kk kl nl kn ko kp kq hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae kw" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae kw" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="jk jl jm jn fq jo fe ff paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="fe ff nm"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></div></figure><figure class="jk jl jm jn fq jo"><div class="bz el l di"><div class="nn no l"/></div></figure></div></div>    
</body>
</html>