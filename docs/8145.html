<html>
<head>
<title>Changing the name of an index in Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Elasticsearch中更改索引的名称</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/changing-the-name-of-an-index-in-elasticsearch-28487b517ad1?source=collection_archive---------10-----------------------#2017-11-21">https://medium.com/hackernoon/changing-the-name-of-an-index-in-elasticsearch-28487b517ad1?source=collection_archive---------10-----------------------#2017-11-21</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><figure class="fi fk is it iu iv fe ff paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="fe ff ir"><img src="../Images/d8845da741713f12ddabdd2ba0d12b16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Nu1_YBJ5AZhhwRR5dNsyA.jpeg"/></div></div></figure><p id="c00d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">嘿，</p><p id="5e45" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">今天我碰巧写了一个脚本来解决一个看起来很多人都面临的特定问题:重命名一个给定的Elasticsearch索引。当然，有文档记录的解决方案，但是我没有很快找到一个脚本来让我到达我想要的地方——现在，名为<code class="eh ka kb kc kd b">a</code>的索引中的所有数据都可以在名为<code class="eh ka kb kc kd b">b</code>的索引中查询，并且设置了所有属性。</p><p id="25cf" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ke">注意。:以下代码针对Elasticsearch 2.4.6。</em></p><p id="3943" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">它来了。</p><h1 id="704a" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">逐步重建索引</h1><p id="7ab0" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">实现我们的目标有四个步骤:</p><ol class=""><li id="2b18" class="li lj hu je b jf jg jj jk jn lk jr ll jv lm jz ln lo lp lq dt translated">创建一个Elasticsearch索引并用一些数据填充它；</li><li id="4f04" class="li lj hu je b jf lr jj ls jn lt jr lu jv lv jz ln lo lp lq dt translated">获取原始索引的配置；</li><li id="7e04" class="li lj hu je b jf lr jj ls jn lt jr lu jv lv jz ln lo lp lq dt translated">使用所需的配置创建新索引；</li><li id="ca49" class="li lj hu je b jf lr jj ls jn lt jr lu jv lv jz ln lo lp lq dt translated">运行<code class="eh ka kb kc kd b">_reindex</code>行动；</li><li id="93e0" class="li lj hu je b jf lr jj ls jn lt jr lu jv lv jz ln lo lp lq dt translated">删除旧索引。</li></ol><h2 id="45ea" class="lw kg hu bd kh lx ly lz kl ma mb mc kp jn md me kt jr mf mg kx jv mh mi lb mj dt translated">0.创建一个Elasticsearch索引并用一些数据填充它</h2><p id="6f2f" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">为了使用默认参数(例如碎片和副本的数量)创建索引，我们可以针对Elasticsearch HTTP端点发出一个<code class="eh ka kb kc kd b">POST</code>，指定所需的索引(在本例中为<code class="eh ka kb kc kd b">acme-production</code>:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="37a9" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">当然，它没有数据索引:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="449a" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在我们用一些数据填充它:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="ebe7" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们可以通过再次查看<code class="eh ka kb kc kd b">/_cat/indices</code>终点来验证这一点:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><h2 id="0156" class="lw kg hu bd kh lx ly lz kl ma mb mc kp jn md me kt jr mf mg kx jv mh mi lb mj dt translated">1.获取原始索引的配置</h2><p id="f4fc" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">因为重命名只不过是“创建、复制和删除”，所以我们需要用旧索引的属性创建一个新索引。为了正确实现这一点，我们必须复制旧的配置:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="db2e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">ps。:这里我使用了轻量级命令行JSON处理器<a class="ae mq" href="https://stedolan.github.io/jq/" rel="noopener ugc nofollow" target="_blank"> jq </a>，以便从调用<code class="eh ka kb kc kd b">/&lt;index&gt;/_settings,_mappings</code>返回的更大对象中获取映射和设置对象。这样我们就可以把它赋给一个变量，然后在以后使用它。</p><h2 id="fa2c" class="lw kg hu bd kh lx ly lz kl ma mb mc kp jn md me kt jr mf mg kx jv mh mi lb mj dt translated">2.使用所需的配置创建新索引</h2><p id="b719" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">使用旧的配置(存储在<code class="eh ka kb kc kd b">index_config</code>变量中),我们能够基于它创建索引:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="88e1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ke"> ps。:即使在</em> <code class="eh ka kb kc kd b"><em class="ke">$index_config</em></code> <em class="ke">对象中有一个</em> <code class="eh ka kb kc kd b"><em class="ke">uuid</em></code> <em class="ke">，也没关系——它会在新的索引中被一个新的</em> <code class="eh ka kb kc kd b"><em class="ke">uuid</em></code> <em class="ke">所取代。</em></p><h2 id="9e38" class="lw kg hu bd kh lx ly lz kl ma mb mc kp jn md me kt jr mf mg kx jv mh mi lb mj dt translated">3.运行<code class="eh ka kb kc kd b">_reindex</code>动作</h2><p id="c239" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">正确配置两个索引后，我们就可以将旧索引中的数据放入新索引中了:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="9f6c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">到目前为止，您应该已经填充了新的索引。现在的问题是删除旧的索引:</p><h2 id="e622" class="lw kg hu bd kh lx ly lz kl ma mb mc kp jn md me kt jr mf mg kx jv mh mi lb mj dt translated">4.删除旧索引</h2><p id="95af" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">如果您不打算使用旧索引，现在是时候放弃它了:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure></div><div class="ab cl mr ms hc mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="hn ho hp hq hr"><h2 id="5701" class="lw kg hu bd kh lx ly lz kl ma mb mc kp jn md me kt jr mf mg kx jv mh mi lb mj dt translated">化名呢？</h2><p id="a5d2" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">我在Reddit上收到了一些非常有趣的反馈，我想在这里分享一下。</p><p id="d72f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">事实证明，有时我们可以通过使用别名来避免<code class="eh ka kb kc kd b">reindex</code> ing(参见<a class="ae mq" href="https://www.elastic.co/guide/en/elasticsearch/reference/2.0/indices-aliases.html" rel="noopener ugc nofollow" target="_blank">弹性搜索指数别名</a>)。</p><p id="ef8e" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">其思想是，当我们需要通过使用另一个名称来引用一个索引所覆盖的内容时，我们可以创建某种指向真正索引的“指针”,并对这个指针(别名)执行所有常规操作。允许这样做的API本质上允许我们<code class="eh ka kb kc kd b">CRUD</code>(创建、移除、更新和删除)别名，使我们完全有可能执行我们想要的:实现索引的“重命名”，即使只是虚拟的。</p><p id="7f83" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">那我们就这么做吧。</p><p id="7a82" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">首先，像前面一样创建一个<code class="eh ka kb kc kd b">acme-production</code>指数，并添加一些数据:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="e275" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后创建一个名为<code class="eh ka kb kc kd b">acme-staging</code>的<code class="eh ka kb kc kd b">alias</code>:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="02b2" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果我们检查指数，我们会发现我们没有任何新的指数，虽然:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="fbef" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">但是我们有化名:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="ac0c" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">这允许我们对<code class="eh ka kb kc kd b">acme-staging</code>执行查询并从<code class="eh ka kb kc kd b">acme-production</code>检索数据:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="cd1f" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">现在，如果我们希望不允许对旧索引的请求呢？好像我们真的改名了，没有重复？然后我们需要使用<a class="ae mq" href="https://www.elastic.co/guide/en/elasticsearch/reference/2.0/indices-open-close.html" rel="noopener ugc nofollow" target="_blank">打开/关闭索引api </a>关闭旧索引:</p><pre class="mk ml mm mn fq my kd mz na aw nb dt"><span id="0032" class="lw kg hu kd b fv nc nd l ne nf">curl -XPOST <a class="ae mq" href="http://localhost:9200/acme-production/_close" rel="noopener ugc nofollow" target="_blank">http://localhost:9200/acme-production/_close</a></span></pre><p id="71ef" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">然后我们可以试着从<code class="eh ka kb kc kd b">acme-production</code>得到:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="5bd0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">酷，我们想要的，哈？现在，如果我们试图从<code class="eh ka kb kc kd b">acme-staging</code>得到:</p><figure class="mk ml mm mn fq iv"><div class="bz el l di"><div class="mo mp l"/></div></figure><p id="9c48" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我们也无法恢复。</p><p id="12e0" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">对我来说，这听起来很合理，因为别名只是指向另一个索引(已关闭)的指针。</p><p id="4edf" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">所以，总而言之，如果你想让一个新的索引指向一个已有的索引(就好像你在重命名)，别名将会拯救你，你将需要执行0数据复制。</p><p id="9d41" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">如果您需要像“重命名”这样的东西，并且不允许访问旧索引，那么<code class="eh ka kb kc kd b">alias</code>不会帮助您(将不得不使用<code class="eh ka kb kc kd b">reindex + delete</code>策略。</p><p id="cbf1" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">我以前从来没有用过别名，知道它们的存在真的很好！有时候它肯定会非常有用。</p><h1 id="a319" class="kf kg hu bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc dt translated">关闭思路和资源</h1><p id="aafa" class="pw-post-body-paragraph jc jd hu je b jf ld jh ji jj le jl jm jn lf jp jq jr lg jt ju jv lh jx jy jz hn dt translated">作为一个从未真正深入研究Elasticsearch如何工作的人，我发现重建索引的整个概念非常简单。官方文档非常好，有了它，我能够很快解决这个问题。恭喜弹力搜索团队！</p><p id="9738" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated">谢谢，</p><p id="ee2d" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ke">完成</em></p></div><div class="ab cl mr ms hc mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="hn ho hp hq hr"><p id="75b6" class="pw-post-body-paragraph jc jd hu je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz hn dt translated"><em class="ke">原载于2017年11月21日</em> <a class="ae mq" href="https://ops.tips/blog/change-name-of-index-elasticsearch/" rel="noopener ugc nofollow" target="_blank"> <em class="ke"> ops.tips </em> </a> <em class="ke">。</em></p></div></div>    
</body>
</html>