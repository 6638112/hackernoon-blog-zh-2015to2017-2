<html>
<head>
<title>Why you should really care about C/C++ static analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么您应该真正关心C/C++静态分析</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/why-you-should-really-care-about-c-c-static-analysis-db13f4463b2d?source=collection_archive---------5-----------------------#2017-07-07">https://medium.com/hackernoon/why-you-should-really-care-about-c-c-static-analysis-db13f4463b2d?source=collection_archive---------5-----------------------#2017-07-07</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="779a" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">许多参考资料讨论了使用静态分析工具的好处，以及它们如何帮助您改进代码库。不知何故，它们向你展示了使用它们后你会得到什么。但是你有没有问过自己，如果你不使用它们，你会失去什么？</p><p id="7038" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们举一个由于两次释放指针而导致内存崩溃的例子，这将导致随机崩溃。发现这种问题可能需要几个小时甚至几天的时间。在C/C++中也存在许多类似的危险问题，特别是内存损坏问题。仅仅一个问题就可能花费几美元或几千美元。</p><p id="2324" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一个问题的影响也取决于程序的性质，事实上，一个机器的嵌入式应用程序中的问题与一个绘画应用程序中的崩溃产生的影响不同。有时候，一个问题可能会花费数百万甚至数十亿美元，就像阿丽亚娜5号的情况一样，一个bug就要花费70亿美元。</p><p id="33c0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">如果使用静态分析工具，你会失去什么？</strong></p><p id="e7b5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">让我们以<a class="ae jp" href="http://cppcheck.sourceforge.net/" rel="noopener ugc nofollow" target="_blank"> cppcheck </a>为例，它主要检测编译器通常检测不到的错误类型。这个工具报告了许多有趣的错误。</p><p id="1a9d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">你需要不到一分钟来下载它，也许20分钟来配置它，分析需要几分钟到几个小时，但在这段时间里你可以自由地做其他任务。在分析之后，您可能有成千上万的潜在问题，在开始时，您可能只关注优先级错误。</p><p id="38a6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最后，对于免费的静态分析工具，你只需要花费30分钟就可以得到一个潜在问题的列表，这可能会花费你数千美元。</p><p id="a5fb" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">对于商业工具你失去的不仅仅是时间，你还要付出。因此，你也失去了钱。让我们假设你用1000美元购买了一个工具，它帮助你找到了一个开发者需要两三天才能找到的问题。</p><p id="c4bc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">一个C/C++开发人员三天的费用可能超过1000美元，这当然取决于公司的位置。但如果你考虑到一个问题的隐性成本，你会惊讶于一个简单的问题会给公司带来多少成本。网上有很多关于简单问题的成本的故事。</p><p id="4728" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这里有一些免费的静态分析工具:</p><p id="53ba" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="http://cppcheck.sourceforge.net/" rel="noopener ugc nofollow" target="_blank"> CppCheck </a>(免费):CppCheck提供了许多检查，下面是一些可用的检查:</p><ul class=""><li id="cef1" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated">越界检查</li><li id="25b4" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">检查异常安全性</li><li id="6f7d" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">内存泄漏检查</li><li id="21f4" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">使用过时功能时发出警告</li><li id="129e" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">检查STL的无效用法</li><li id="fe3c" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">检查未初始化的变量和未使用的函数</li></ul><p id="f9b6" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="http://clang.llvm.org/extra/clang-tidy/" rel="noopener ugc nofollow" target="_blank"> Clang </a>(免费):Clang是一个C/C++编译器，它的诊断非常有趣，您可能会对报告的相关问题感到惊讶，它可能会关注:</p><ul class=""><li id="ebea" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated">不赞成的用法</li><li id="0ff5" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">铸造问题</li><li id="8657" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">初始化问题</li><li id="db34" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">OpenMP问题等等。</li></ul><p id="7141" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="http://clang.llvm.org/extra/clang-tidy/" rel="noopener ugc nofollow" target="_blank"> Clang-tidy </a>(免费):是一个基于Clang的c++“linter”工具。它的目的是提供一个可扩展的框架，用于诊断和修复典型的编程错误，如违反风格、接口误用或可以通过静态分析推断出的错误。<strong class="it hv"> clang-tidy </strong>是模块化的，为写新支票提供了一个方便的界面。这里是铿锵整齐的<a class="ae jp" href="http://clang.llvm.org/extra/clang-tidy/checks/list.html" rel="noopener ugc nofollow" target="_blank">检查表</a>。</p><p id="e016" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">还有许多其他的静态分析工具，其中一些很容易测试，其他的你必须联系他们的公司，要一个试用版。</p><p id="e8c3" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果你能浪费30分钟，使用cppcheck，你一定不会浪费你的时间。</p><h2 id="90fb" class="ke kf hu bd kg kh ki kj kk kl km kn ko jc kp kq kr jg ks kt ku jk kv kw kx ky dt translated">容易出现Bug的情况怎么办？</h2><p id="c4f0" class="pw-post-body-paragraph ir is hu it b iu kz iw ix iy la ja jb jc lb je jf jg lc ji jj jk ld jm jn jo hn dt translated">静态分析不仅是关于直接发现错误，而且是关于发现可能减少代码理解和可维护性的容易出现错误的情况。静态分析可以处理代码的许多其他属性:</p><ul class=""><li id="de3b" class="jq jr hu it b iu iv iy iz jc js jg jt jk ju jo jv jw jx jy dt translated"><strong class="it hv">代码度量</strong>:例如，有太多循环的方法，if，else，switch，case…最终变得不可理解，因此不可维护。通过代码度量圈复杂度来计算这些是评估一个方法何时变得太复杂的好方法。</li><li id="e9ee" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated"><strong class="it hv">依赖关系</strong>:如果你的程序的类纠缠在一起，那么代码中任何变化的影响都会变得不可预测。静态分析有助于评估类和组件何时纠缠在一起。</li><li id="2a66" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated"><strong class="it hv">不变性</strong>:被几个线程同时使用的类型应该是不可变的，否则你将不得不用复杂的锁策略来保护状态读/写访问，这将导致不可维护。静态分析可以确保一些类保持不变。</li><li id="93e0" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated"><strong class="it hv">死代码</strong>:死代码是可以安全删除的代码，因为它在运行时不再被调用。不仅<em class="le">可以</em>删除，而且<em class="le">必须</em>删除，因为这些额外的代码给程序增加了不必要的复杂性。静态分析可以发现程序中的大部分死代码(但不是全部)。</li><li id="665d" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated">API突破性变化:如果你向你的客户展示一个API，很容易在没有注意到的情况下移除一个公共成员，从而破坏你客户的代码。静态分析可以比较一个程序的两种状态，并且可以警告这个缺陷。</li><li id="63ad" class="jq jr hu it b iu jz iy ka jc kb jg kc jk kd jo jv jw jx jy dt translated"><strong class="it hv"> API用法</strong>:有些API是要小心使用的。例如，持有可处置字段的类本身通常必须是可处置的，除非可处置字段的生存期与类实例的生存期不一致，这听起来像是一个设计问题。</li></ul><p id="f965" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有许多有趣的工具可以检测C++代码库中的错误。但是对于容易出现错误的情况的检测呢？</p><p id="3acf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">如果静态分析工具的创建者可以决定哪些情况被认为是bug，那么依赖于开发团队选择的易出错情况就不是这样了。例如，一个团队可能认为超过20行的方法是复杂的，另一个团队可能将最大值定义为30。如果一个工具提供了对一些容易出错的情况的检测，那么它也必须提供定制它的可能性。</p><p id="7566" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">代码作为数据是检测易出错情况的更好方法</strong></p><p id="9f21" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">静态分析是分析源代码的各种属性并报告这些属性的思想，但从哲学上讲，它也是将代码视为数据的思想。这对于作为应用程序开发人员的我们来说非常奇怪，因为我们非常习惯于将源代码看作指令、过程和算法。但它也非常强大。</p><p id="5020" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在对源文件进行源代码分析之后，我们可以提取它的AST并生成一个包含许多关于代码的有趣信息的模型。这样我们就可以使用类似于SQL的代码查询语言来查询它。</p><p id="64c1" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><a class="ae jp" href="http://www.cppdepend.com/" rel="noopener ugc nofollow" target="_blank"> CppDepend </a>提供了强大的代码查询语言CQLinq，像数据库一样查询代码库。开发人员、设计人员和架构师可以定义他们的自定义查询来轻松找到容易出现错误的情况。</p><p id="15b5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">有了CQlinq，我们可以结合来自代码度量、依赖、api使用和其他模型信息的数据来定义非常高级的查询，以匹配一些容易出现错误的情况。</p><p id="0ea8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是一个匹配最复杂方法的CQLinq查询示例:</p><figure class="lg lh li lj fq lk fe ff paragraph-image"><div class="fe ff lf"><img src="../Images/c5869a73bd95a6ae4fc52a0378cfa8f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/0*r1O2tVD__tN3bwED.png"/></div></figure><p id="2701" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv">总结</strong></p><p id="2529" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">最好结合很多C++工具来检测你的C++代码库中的一些问题，一些工具检测bug，一些工具检测容易出现bug的情况。</p></div></div>    
</body>
</html>