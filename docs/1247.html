<html>
<head>
<title>Redux Funk—Simple, Testable Async Effects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">redux Funk—简单、可测试的异步效果</h1>
<blockquote>原文：<a href="https://medium.com/hackernoon/why-i-wrote-a-redux-async-outerware-277d450dba74?source=collection_archive---------2-----------------------#2016-10-01">https://medium.com/hackernoon/why-i-wrote-a-redux-async-outerware-277d450dba74?source=collection_archive---------2-----------------------#2016-10-01</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><div class=""/><p id="5b6d" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Redux应用程序中有大量的<a class="ae jp" href="https://github.com/markerikson/redux-ecosystem-links/blob/master/side-effects.md" rel="noopener ugc nofollow" target="_blank">库</a>用来做异步效果。<a class="ae jp" rel="noopener" href="/javascript-and-opinions/redux-side-effects-and-you-66f2e0842fc3#.rht62eejy">有些人认为这是一件坏事，但我喜欢JavaScript社区中知识分子的好奇心和探索的意愿。</a></p><p id="6da0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">没有一个<a class="ae jp" href="https://hackernoon.com/tagged/redux" rel="noopener ugc nofollow" target="_blank">特效</a>特效<a class="ae jp" href="https://hackernoon.com/tagged/library" rel="noopener ugc nofollow" target="_blank">库</a>能满足我的需求，所以我最终做了一些新的东西。我将分享我从其他效果库中借来的想法，以及它们如何在<a class="ae jp" href="https://github.com/mheiber/redux-funk" rel="noopener ugc nofollow" target="_blank"> redux-funk </a>中使用。</p><blockquote class="jq jr js"><p id="39f6" class="ir is jt it b iu iv iw ix iy iz ja jb ju jd je jf jv jh ji jj jw jl jm jn jo hn dt translated">对于一些背景，有一个<a class="ae jp" href="http://stackoverflow.com/questions/34570758/why-do-we-need-middleware-for-async-flow-in-redux" rel="noopener ugc nofollow" target="_blank">栈溢出帖子</a>解释了为什么你想要一个工具来实现Redux应用中的异步效果。</p></blockquote><h2 id="4eee" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">Redux循环reducers中的声明性效果</h2><p id="584b" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">下面的例子展示了Redux Loop中的一些好主意。这是一个reducer的代码，它在延迟后返回一个指令来增加计数器:</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff kx"><img src="../Images/d3b6dd1cbb7777e8a5b3fa3b1aa57ca0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-GjiU2Unvj4iyFsANB024g.png"/></div></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">Redux Loop Example</figcaption></figure><p id="6e66" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">上面对<strong class="it hv">循环</strong>函数的调用可以解读为“返回状态不变，调用<strong class="it hv"> incrementAsync </strong>带参数[ <strong class="it hv"> action.delay </strong> ]。</p><p id="a0c7" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">将异步内容放入reducers的一个优点是，当试图弄清楚"<em class="jt">当这个动作被分派时，应用程序做了什么？</em>”。一个动作应该被同步处理还是异步处理变成了一个实现细节，而不是决定你的代码在应用的哪个部分。相比之下，在Redux Thunk中，async stuff生活在动作创作者中，而在Redux Saga中，async stuff生活在sagas中。</p><p id="9fb9" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Redux中的一个很大的规则是reducers应该是纯的。起初，Redux循环似乎违反了这条规则，但一切都很好。调用<strong class="it hv">循环</strong>函数实际上不会产生任何副作用。相反，<strong class="it hv">循环</strong>返回表示下一个状态和效果的数据结构。这使得编写测试变得非常容易——您可以使用深度相等检查来查看返回了什么效果:</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff ln"><img src="../Images/4f10894e50a1659760c6c71f79325de9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uL8fExunV1DsxE5robiaLg.png"/></div></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">Test for a reducer that uses Redux Loop</figcaption></figure><p id="f6b0" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">我没有使用Redux循环，因为我需要进行定制的缩减器组合，比如从一个缩减器中委托给另一个缩减器。这与Redux循环很复杂，因为它的效果<a class="ae jp" href="https://github.com/redux-loop/redux-loop/blob/master/modules/combineReducers.js#L26" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv">必须使用<a class="ae jp" href="https://github.com/redux-loop/redux-loop/blob/master/docs/ApiDocs.md" rel="noopener ugc nofollow" target="_blank"> <strong class="it hv"> isLoop </strong>、<strong class="it hv"> getEffect </strong>、<strong class="it hv"> getModel </strong>和<strong class="it hv"> batch </strong> </a>沿状态树</strong> </a>向上传递。</p><blockquote class="jq jr js"><p id="aeb7" class="ir is jt it b iu iv iw ix iy iz ja jb ju jd je jf jv jh ji jj jw jl jm jn jo hn dt translated">问题是在reducer组合中，我们希望子reducer只能访问状态树的一部分，而不是全部。因此，当在<strong class="it hv">状态</strong>上存储效果时(就像在Redux循环中)，效果必须以某种方式到达树的顶部，以便中间件可以看到它。另一种方法是遍历整个树，寻找效果，这可能不是一个好主意。我借用了Redux Side Effect的一个解决方案，在下一节描述。</p></blockquote><p id="b9e4" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">这是异步计数器缩减器的redux-funk版本:</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff lo"><img src="../Images/4cefa0791bbb418e5101950f5086d6c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*REQVwbfg1gMlK_SrR7DLrQ.png"/></div></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">Reducer using Redux Funk for declarative effects. I explain how <strong class="bd lp">call</strong> is implemented in the next section.</figcaption></figure><p id="4c06" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">在上面的代码中，<strong class="it hv"/><strong class="it hv">调用</strong>用于对一个效果进行排队。效果<strong class="it hv">【incrementAsync，[action.delay]] </strong>可以解读为“调用incrementAsync，以action.delay作为第一个参数。”我用<em class="jt"> funks来指代</em>形式的效果<strong class="it hv">【func、【arguments……】】</strong>。redux-funk在状态树的顶部添加了一个<strong class="it hv"> funks </strong>数组来排队异步效果。因此，要测试使用redux-funk的减速器，您只需检查<strong class="it hv"> funks </strong>键:</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff lq"><img src="../Images/2b07c65c20376bc2f71b4a17b6f63f2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tfUhQyG_kiNZ3C0Ta09YcA.png"/></div></div></figure><h2 id="c032" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">使用动作对象减少副作用— <strong class="ak"/></h2><p id="42bc" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">Redux循环代码有时不得不跳过重重关卡，将效果传递到状态树上。<a class="ae jp" href="https://github.com/gregwebs/redux-side-effect" rel="noopener ugc nofollow" target="_blank"> Redux副作用</a>避免了这些困难，并且因为一个技巧而有了一个<a class="ae jp" href="https://github.com/gregwebs/redux-side-effect/blob/master/src/index.js" rel="noopener ugc nofollow" target="_blank">微小的行数</a>——它使用<strong class="it hv">动作</strong>对象来传达效果。</p><p id="0453" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">以下代码显示了如何使用Redux Side Effect在缩减器中添加副作用:</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff lr"><img src="../Images/cdf767daea97ab7b19fb972b90b39b84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b0athrESTMdWEqFkTjXxow.png"/></div></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">Redux Side Effect example</figcaption></figure><p id="51d8" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">Redux副作用中间件只是检查<strong class="it hv">动作</strong>上的效果，并以<strong class="it hv">调度</strong>作为第一个参数调用它们。使用<strong class="it hv">动作</strong>是一种快捷方式:当子reducer只获得整个状态树的分支时，<strong class="it hv">动作</strong>在所有reducer之间共享。</p><p id="2672" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">尽管这个解决方案很优雅，但我最终没有使用Redux副作用，因为:</p><ul class=""><li id="22ae" class="ls lt hu it b iu iv iy iz jc lu jg lv jk lw jo lx ly lz ma dt translated">这些效果是非声明性的。在上面的例子中，测试延迟是否正确的唯一方法是实际设置一个延迟并比较时间戳。</li><li id="18fd" class="ls lt hu it b iu mb iy mc jc md jg me jk mf jo lx ly lz ma dt translated">减速器变得依赖于<strong class="it hv">副作用</strong>方法的存在。</li><li id="6be0" class="ls lt hu it b iu mb iy mc jc md jg me jk mf jo lx ly lz ma dt translated">改变动作对象<a class="ae jp" href="http://redux.js.org/docs/introduction/ThreePrinciples.html#changes-are-made-with-pure-functions" rel="noopener ugc nofollow" target="_blank">会破坏Redux范式</a>，如果可能的话，这是我想避免的。</li></ul><p id="b01e" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">redux-funk还使用在<strong class="it hv">动作</strong>对象上存储动作的技巧来避免传递效果。但是该实现保持了还原剂的纯度。<strong class="it hv"> call(action，funk) </strong>使用<a class="ae jp" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol" rel="noopener ugc nofollow" target="_blank">符号</a>作为键，将funk添加到动作中:</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff mg"><img src="../Images/a35de759806ef4808e82a9724be2f34c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xtOCk_tlhTVV2-kzAq4piQ.png"/></div></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">Implementation of the <strong class="bd lp"><em class="mh">call</em> </strong>function in redux-funk</figcaption></figure><p id="40fc" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">当使用redux-funk时，调用顶层reducer上的<strong class="it hv">congregate reducers</strong>，它从动作中取出效果队列，并将它们放入存储状态。这就把活动还原到了原来的样子，更重要的是，让商店的消费者也能买到这些放克。上面的测试示例使用了<strong class="it hv">合并效果。</strong></p><p id="5cdf" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是<strong class="it hv">合并效果</strong>的实现:</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff mi"><img src="../Images/ca6c35182b28edc6e09b9c72e6adbb48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8R7OE6mm3LxYbiUvGSsNMQ.png"/></div></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">Implementation of <strong class="bd lp">coalesceFunks</strong></figcaption></figure><h2 id="6d14" class="jx jy hu bd jz ka kb kc kd ke kf kg kh jc ki kj kk jg kl km kn jk ko kp kq kr dt translated">来自React-Redux—订阅商店</h2><p id="8c31" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">React-Redux包含使用状态呈现UI的助手，这可能是最重要的副作用。Redux的大多数效果库都是中间件，但是，React-Redux订阅存储并对当前状态做出反应。</p><p id="9730" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">因为redux-funk将效果作为商店状态的一部分，所以您可以只订阅商店，然后用效果进行编程。我做了一个小助手，<strong class="it hv"> runFunks，</strong>来处理效果，方式类似于Redux Loop:</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div class="fe ff mj"><img src="../Images/a651d4b1de784dc9a65fcc732df0691f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/1*xEI7RJdzzNwOvoykAat_3g.png"/></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">Helper for working with declarative effects</figcaption></figure><p id="d461" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated"><strong class="it hv"> runFunks </strong>使reducers中描述的效果能够被实际调用。在反例中，函数返回一个动作的承诺。runFunks 调用函数并保持对<strong class="it hv">增量</strong>动作的承诺。当承诺解决时，<strong class="it hv"> runFunks </strong>分派动作:</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff lo"><img src="../Images/4cefa0791bbb418e5101950f5086d6c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*REQVwbfg1gMlK_SrR7DLrQ.png"/></div></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">Reducer using Redux Funk for declarative effects</figcaption></figure><p id="c649" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">下面是runFunks的实现:</p><figure class="ky kz la lb fq lc fe ff paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="fe ff mk"><img src="../Images/190364123759b8389f9e23b98889feb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lMnnT4-HNSekz7jyHsLdyw.png"/></div></div><figcaption class="lj lk fg fe ff ll lm bd b be z ek">Implementation of <strong class="bd lp">runFunks</strong></figcaption></figure><p id="97f5" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">可以不用<strong class="it hv"> runFunks </strong>使用redux-funk，实现自己的逻辑进行处理。这就是在<strong class="it hv">状态下储存效果的好处之一。例如，你可以使用上面代码的一个变体来给每个效果添加延迟，去抖，使用回调而不是承诺，进行远程过程调用，将依赖注入到恐惧中，等等。</strong></p><h1 id="215e" class="ml jy hu bd jz mm mn mo kd mp mq mr kh ms mt mu kk mv mw mx kn my mz na kq nb dt translated">尝试一下</h1><p id="a30b" class="pw-post-body-paragraph ir is hu it b iu ks iw ix iy kt ja jb jc ku je jf jg kv ji jj jk kw jm jn jo hn dt translated">如果您已经做到了这一步，那么您已经看到了redux-funk的完整源代码！</p><p id="0f00" class="pw-post-body-paragraph ir is hu it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hn dt translated">希望你有机会<a class="ae jp" href="https://www.npmjs.com/package/redux-funk" rel="noopener ugc nofollow" target="_blank">尝试一下</a>和玩玩<a class="ae jp" href="https://github.com/mheiber/redux-funk-examples" rel="noopener ugc nofollow" target="_blank">的例子</a>，它们改编自<a class="ae jp" href="https://github.com/yelouafi/redux-saga#building-examples-from-sources" rel="noopener ugc nofollow" target="_blank"> Redux Saga的例子</a>。</p><div class="ky kz la lb fq ab cb"><figure class="nc lc nd ne nf ng nh paragraph-image"><a href="http://bit.ly/HackernoonFB"><img src="../Images/50ef4044ecd4e250b5d50f368b775d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></a></figure><figure class="nc lc nd ne nf ng nh paragraph-image"><a href="https://goo.gl/k7XYbx"><img src="../Images/979d9a46439d5aebbdcdca574e21dc81.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></a></figure><figure class="nc lc nd ne nf ng nh paragraph-image"><a href="https://goo.gl/4ofytp"><img src="../Images/2930ba6bd2c12218fdbbf7e02c8746ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></a></figure></div><blockquote class="jq jr js"><p id="f922" class="ir is jt it b iu iv iw ix iy iz ja jb ju jd je jf jv jh ji jj jw jl jm jn jo hn dt translated"><a class="ae jp" href="http://bit.ly/Hackernoon" rel="noopener ugc nofollow" target="_blank">黑客中午</a>是黑客如何开始他们的下午。我们是<a class="ae jp" href="http://bit.ly/atAMIatAMI" rel="noopener ugc nofollow" target="_blank"> @AMI </a>家庭的一员。我们现在<a class="ae jp" href="http://bit.ly/hackernoonsubmission" rel="noopener ugc nofollow" target="_blank">接受投稿</a>并乐意<a class="ae jp" href="mailto:partners@amipublications.com" rel="noopener ugc nofollow" target="_blank">讨论广告&amp;赞助</a>机会。</p><p id="708a" class="ir is jt it b iu iv iw ix iy iz ja jb ju jd je jf jv jh ji jj jw jl jm jn jo hn dt translated">如果你喜欢这个故事，我们推荐你阅读我们的<a class="ae jp" href="http://bit.ly/hackernoonlatestt" rel="noopener ugc nofollow" target="_blank">最新科技故事</a>和<a class="ae jp" href="https://hackernoon.com/trending" rel="noopener ugc nofollow" target="_blank">趋势科技故事</a>。直到下一次，不要把世界的现实想当然！</p></blockquote><figure class="ky kz la lb fq lc fe ff paragraph-image"><a href="https://goo.gl/Ahtev1"><div class="fe ff ni"><img src="../Images/be0ca55ba73a573dce11effb2ee80d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></div></a></figure></div></div>    
</body>
</html>